"use strict";var _set=function set(object,property,value,receiver){var desc=Object.getOwnPropertyDescriptor(object,property);if(desc===undefined){var parent=Object.getPrototypeOf(object);if(parent!==null){set(parent,property,value,receiver);}}else if("value"in desc&&desc.writable){desc.value=value;}else{var setter=desc.set;if(setter!==undefined){setter.call(receiver,value);}}return value;};var _get=function get(object,property,receiver){if(object===null)object=Function.prototype;var desc=Object.getOwnPropertyDescriptor(object,property);if(desc===undefined){var parent=Object.getPrototypeOf(object);if(parent===null){return undefined;}else{return get(parent,property,receiver);}}else if("value"in desc){return desc.value;}else{var getter=desc.get;if(getter===undefined){return undefined;}return getter.call(receiver);}};var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor);}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor;};}();function _possibleConstructorReturn(self,call){if(!self){throw new ReferenceError("this hasn't been initialised - super() hasn't been called");}return call&&(typeof call==="object"||typeof call==="function")?call:self;}function _inherits(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass;}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}}window.Laya=function(exports){'use strict';var Config=function Config(){_classCallCheck(this,Config);};Config.animationInterval=50;Config.isAntialias=false;Config.isAlpha=false;Config.premultipliedAlpha=true;Config.isStencil=true;Config.preserveDrawingBuffer=false;Config.webGL2D_MeshAllocMaxMem=true;Config.is2DPixelArtGame=false;Config.useWebGL2=true;Config.useRetinalCanvas=false;window.Config=Config;var ILaya=function(){function ILaya(){_classCallCheck(this,ILaya);}_createClass(ILaya,null,[{key:"regClass",value:function regClass(c){ILaya.__classMap[c.name]=c;}}]);return ILaya;}();ILaya.Laya=null;ILaya.Timer=null;ILaya.WorkerLoader=null;ILaya.Dragging=null;ILaya.GraphicsBounds=null;ILaya.Sprite=null;ILaya.TextRender=null;ILaya.TextAtlas=null;ILaya.timer=null;ILaya.systemTimer=null;ILaya.startTimer=null;ILaya.updateTimer=null;ILaya.lateTimer=null;ILaya.physicsTimer=null;ILaya.stage=null;ILaya.Loader=null;ILaya.loader=null;ILaya.TTFLoader=null;ILaya.SoundManager=null;ILaya.WebAudioSound=null;ILaya.AudioSound=null;ILaya.ShaderCompile=null;ILaya.ClassUtils=null;ILaya.SceneUtils=null;ILaya.Context=null;ILaya.Render=null;ILaya.MouseManager=null;ILaya.Text=null;ILaya.Browser=null;ILaya.WebGL=null;ILaya.Pool=null;ILaya.Utils=null;ILaya.Graphics=null;ILaya.Submit=null;ILaya.Stage=null;ILaya.Resource=null;ILaya.__classMap={};var Pool=function(){function Pool(){_classCallCheck(this,Pool);}_createClass(Pool,null,[{key:"getPoolBySign",value:function getPoolBySign(sign){return Pool._poolDic[sign]||(Pool._poolDic[sign]=[]);}},{key:"clearBySign",value:function clearBySign(sign){if(Pool._poolDic[sign])Pool._poolDic[sign].length=0;}},{key:"recover",value:function recover(sign,item){if(item[Pool.POOLSIGN])return;item[Pool.POOLSIGN]=true;Pool.getPoolBySign(sign).push(item);}},{key:"recoverByClass",value:function recoverByClass(instance){if(instance){var className=instance["__className"]||instance.constructor._$gid;if(className)Pool.recover(className,instance);}}},{key:"_getClassSign",value:function _getClassSign(cla){var className=cla["__className"]||cla["_$gid"];if(!className){cla["_$gid"]=className=Pool._CLSID+"";Pool._CLSID++;}return className;}},{key:"createByClass",value:function createByClass(cls){return Pool.getItemByClass(Pool._getClassSign(cls),cls);}},{key:"getItemByClass",value:function getItemByClass(sign,cls){if(!Pool._poolDic[sign])return new cls();var pool=Pool.getPoolBySign(sign);if(pool.length){var rst=pool.pop();rst[Pool.POOLSIGN]=false;}else{rst=new cls();}return rst;}},{key:"getItemByCreateFun",value:function getItemByCreateFun(sign,createFun){var caller=arguments.length>2&&arguments[2]!==undefined?arguments[2]:null;var pool=Pool.getPoolBySign(sign);var rst=pool.length?pool.pop():createFun.call(caller);rst[Pool.POOLSIGN]=false;return rst;}},{key:"getItem",value:function getItem(sign){var pool=Pool.getPoolBySign(sign);var rst=pool.length?pool.pop():null;if(rst){rst[Pool.POOLSIGN]=false;}return rst;}}]);return Pool;}();Pool._CLSID=0;Pool.POOLSIGN="__InPool";Pool._poolDic={};var AlphaCmd=function(){function AlphaCmd(){_classCallCheck(this,AlphaCmd);}_createClass(AlphaCmd,[{key:"recover",value:function recover(){Pool.recover("AlphaCmd",this);}},{key:"run",value:function run(context,gx,gy){context.alpha(this.alpha);}},{key:"cmdID",get:function get(){return AlphaCmd.ID;}}],[{key:"create",value:function create(alpha){var cmd=Pool.getItemByClass("AlphaCmd",AlphaCmd);cmd.alpha=alpha;return cmd;}}]);return AlphaCmd;}();AlphaCmd.ID="Alpha";var DrawCircleCmd=function(){function DrawCircleCmd(){_classCallCheck(this,DrawCircleCmd);}_createClass(DrawCircleCmd,[{key:"recover",value:function recover(){this.fillColor=null;this.lineColor=null;Pool.recover("DrawCircleCmd",this);}},{key:"run",value:function run(context,gx,gy){context._drawCircle(this.x+gx,this.y+gy,this.radius,this.fillColor,this.lineColor,this.lineWidth,this.vid);}},{key:"cmdID",get:function get(){return DrawCircleCmd.ID;}}],[{key:"create",value:function create(x,y,radius,fillColor,lineColor,lineWidth,vid){var cmd=Pool.getItemByClass("DrawCircleCmd",DrawCircleCmd);cmd.x=x;cmd.y=y;cmd.radius=radius;cmd.fillColor=fillColor;cmd.lineColor=lineColor;cmd.lineWidth=lineWidth;cmd.vid=vid;return cmd;}}]);return DrawCircleCmd;}();DrawCircleCmd.ID="DrawCircle";var DrawCurvesCmd=function(){function DrawCurvesCmd(){_classCallCheck(this,DrawCurvesCmd);}_createClass(DrawCurvesCmd,[{key:"recover",value:function recover(){this.points=null;this.lineColor=null;Pool.recover("DrawCurvesCmd",this);}},{key:"run",value:function run(context,gx,gy){if(this.points)context.drawCurves(this.x+gx,this.y+gy,this.points,this.lineColor,this.lineWidth);}},{key:"cmdID",get:function get(){return DrawCurvesCmd.ID;}}],[{key:"create",value:function create(x,y,points,lineColor,lineWidth){var cmd=Pool.getItemByClass("DrawCurvesCmd",DrawCurvesCmd);cmd.x=x;cmd.y=y;cmd.points=points;cmd.lineColor=lineColor;cmd.lineWidth=lineWidth;return cmd;}}]);return DrawCurvesCmd;}();DrawCurvesCmd.ID="DrawCurves";var DrawImageCmd=function(){function DrawImageCmd(){_classCallCheck(this,DrawImageCmd);}_createClass(DrawImageCmd,[{key:"recover",value:function recover(){this.texture&&this.texture._removeReference();this.texture=null;Pool.recover("DrawImageCmd",this);}},{key:"run",value:function run(context,gx,gy){if(this.texture)context.drawTexture(this.texture,this.x+gx,this.y+gy,this.width,this.height);}},{key:"cmdID",get:function get(){return DrawImageCmd.ID;}}],[{key:"create",value:function create(texture,x,y,width,height){var cmd=Pool.getItemByClass("DrawImageCmd",DrawImageCmd);cmd.texture=texture;texture._addReference();cmd.x=x;cmd.y=y;cmd.width=width;cmd.height=height;return cmd;}}]);return DrawImageCmd;}();DrawImageCmd.ID="DrawImage";var DrawLineCmd=function(){function DrawLineCmd(){_classCallCheck(this,DrawLineCmd);}_createClass(DrawLineCmd,[{key:"recover",value:function recover(){Pool.recover("DrawLineCmd",this);}},{key:"run",value:function run(context,gx,gy){context._drawLine(gx,gy,this.fromX,this.fromY,this.toX,this.toY,this.lineColor,this.lineWidth,this.vid);}},{key:"cmdID",get:function get(){return DrawLineCmd.ID;}}],[{key:"create",value:function create(fromX,fromY,toX,toY,lineColor,lineWidth,vid){var cmd=Pool.getItemByClass("DrawLineCmd",DrawLineCmd);cmd.fromX=fromX;cmd.fromY=fromY;cmd.toX=toX;cmd.toY=toY;cmd.lineColor=lineColor;cmd.lineWidth=lineWidth;cmd.vid=vid;return cmd;}}]);return DrawLineCmd;}();DrawLineCmd.ID="DrawLine";var DrawLinesCmd=function(){function DrawLinesCmd(){_classCallCheck(this,DrawLinesCmd);}_createClass(DrawLinesCmd,[{key:"recover",value:function recover(){this.points=null;this.lineColor=null;Pool.recover("DrawLinesCmd",this);}},{key:"run",value:function run(context,gx,gy){this.points&&context._drawLines(this.x+gx,this.y+gy,this.points,this.lineColor,this.lineWidth,this.vid);}},{key:"cmdID",get:function get(){return DrawLinesCmd.ID;}}],[{key:"create",value:function create(x,y,points,lineColor,lineWidth,vid){var cmd=Pool.getItemByClass("DrawLinesCmd",DrawLinesCmd);cmd.x=x;cmd.y=y;cmd.points=points;cmd.lineColor=lineColor;cmd.lineWidth=lineWidth;cmd.vid=vid;return cmd;}}]);return DrawLinesCmd;}();DrawLinesCmd.ID="DrawLines";var DrawPathCmd=function(){function DrawPathCmd(){_classCallCheck(this,DrawPathCmd);}_createClass(DrawPathCmd,[{key:"recover",value:function recover(){this.paths=null;this.brush=null;this.pen=null;Pool.recover("DrawPathCmd",this);}},{key:"run",value:function run(context,gx,gy){this.paths&&context._drawPath(this.x+gx,this.y+gy,this.paths,this.brush,this.pen);}},{key:"cmdID",get:function get(){return DrawPathCmd.ID;}}],[{key:"create",value:function create(x,y,paths,brush,pen){var cmd=Pool.getItemByClass("DrawPathCmd",DrawPathCmd);cmd.x=x;cmd.y=y;cmd.paths=paths;cmd.brush=brush;cmd.pen=pen;return cmd;}}]);return DrawPathCmd;}();DrawPathCmd.ID="DrawPath";var DrawPieCmd=function(){function DrawPieCmd(){_classCallCheck(this,DrawPieCmd);}_createClass(DrawPieCmd,[{key:"recover",value:function recover(){this.fillColor=null;this.lineColor=null;Pool.recover("DrawPieCmd",this);}},{key:"run",value:function run(context,gx,gy){context._drawPie(this.x+gx,this.y+gy,this.radius,this._startAngle,this._endAngle,this.fillColor,this.lineColor,this.lineWidth,this.vid);}},{key:"cmdID",get:function get(){return DrawPieCmd.ID;}},{key:"startAngle",get:function get(){return this._startAngle*180/Math.PI;},set:function set(value){this._startAngle=value*Math.PI/180;}},{key:"endAngle",get:function get(){return this._endAngle*180/Math.PI;},set:function set(value){this._endAngle=value*Math.PI/180;}}],[{key:"create",value:function create(x,y,radius,startAngle,endAngle,fillColor,lineColor,lineWidth,vid){var cmd=Pool.getItemByClass("DrawPieCmd",DrawPieCmd);cmd.x=x;cmd.y=y;cmd.radius=radius;cmd._startAngle=startAngle;cmd._endAngle=endAngle;cmd.fillColor=fillColor;cmd.lineColor=lineColor;cmd.lineWidth=lineWidth;cmd.vid=vid;return cmd;}}]);return DrawPieCmd;}();DrawPieCmd.ID="DrawPie";var DrawPolyCmd=function(){function DrawPolyCmd(){_classCallCheck(this,DrawPolyCmd);}_createClass(DrawPolyCmd,[{key:"recover",value:function recover(){this.points=null;this.fillColor=null;this.lineColor=null;Pool.recover("DrawPolyCmd",this);}},{key:"run",value:function run(context,gx,gy){this.points&&context._drawPoly(this.x+gx,this.y+gy,this.points,this.fillColor,this.lineColor,this.lineWidth,this.isConvexPolygon,this.vid);}},{key:"cmdID",get:function get(){return DrawPolyCmd.ID;}}],[{key:"create",value:function create(x,y,points,fillColor,lineColor,lineWidth,isConvexPolygon,vid){var cmd=Pool.getItemByClass("DrawPolyCmd",DrawPolyCmd);cmd.x=x;cmd.y=y;cmd.points=points;cmd.fillColor=fillColor;cmd.lineColor=lineColor;cmd.lineWidth=lineWidth;cmd.isConvexPolygon=isConvexPolygon;cmd.vid=vid;return cmd;}}]);return DrawPolyCmd;}();DrawPolyCmd.ID="DrawPoly";var DrawRectCmd=function(){function DrawRectCmd(){_classCallCheck(this,DrawRectCmd);}_createClass(DrawRectCmd,[{key:"recover",value:function recover(){this.fillColor=null;this.lineColor=null;Pool.recover("DrawRectCmd",this);}},{key:"run",value:function run(context,gx,gy){context.drawRect(this.x+gx,this.y+gy,this.width,this.height,this.fillColor,this.lineColor,this.lineWidth);}},{key:"cmdID",get:function get(){return DrawRectCmd.ID;}}],[{key:"create",value:function create(x,y,width,height,fillColor,lineColor,lineWidth){var cmd=Pool.getItemByClass("DrawRectCmd",DrawRectCmd);cmd.x=x;cmd.y=y;cmd.width=width;cmd.height=height;cmd.fillColor=fillColor;cmd.lineColor=lineColor;cmd.lineWidth=lineWidth;return cmd;}}]);return DrawRectCmd;}();DrawRectCmd.ID="DrawRect";var Matrix=function(){function Matrix(){var a=arguments.length>0&&arguments[0]!==undefined?arguments[0]:1;var b=arguments.length>1&&arguments[1]!==undefined?arguments[1]:0;var c=arguments.length>2&&arguments[2]!==undefined?arguments[2]:0;var d=arguments.length>3&&arguments[3]!==undefined?arguments[3]:1;var tx=arguments.length>4&&arguments[4]!==undefined?arguments[4]:0;var ty=arguments.length>5&&arguments[5]!==undefined?arguments[5]:0;var nums=arguments.length>6&&arguments[6]!==undefined?arguments[6]:0;_classCallCheck(this,Matrix);this._bTransform=false;if(Matrix._createFun!=null){return Matrix._createFun(a,b,c,d,tx,ty,nums);}this.a=a;this.b=b;this.c=c;this.d=d;this.tx=tx;this.ty=ty;this._checkTransform();}_createClass(Matrix,[{key:"identity",value:function identity(){this.a=this.d=1;this.b=this.tx=this.ty=this.c=0;this._bTransform=false;return this;}},{key:"_checkTransform",value:function _checkTransform(){return this._bTransform=this.a!==1||this.b!==0||this.c!==0||this.d!==1;}},{key:"setTranslate",value:function setTranslate(x,y){this.tx=x;this.ty=y;return this;}},{key:"translate",value:function translate(x,y){this.tx+=x;this.ty+=y;return this;}},{key:"scale",value:function scale(x,y){this.a*=x;this.d*=y;this.c*=x;this.b*=y;this.tx*=x;this.ty*=y;this._bTransform=true;return this;}},{key:"rotate",value:function rotate(angle){var cos=Math.cos(angle);var sin=Math.sin(angle);var a1=this.a;var c1=this.c;var tx1=this.tx;this.a=a1*cos-this.b*sin;this.b=a1*sin+this.b*cos;this.c=c1*cos-this.d*sin;this.d=c1*sin+this.d*cos;this.tx=tx1*cos-this.ty*sin;this.ty=tx1*sin+this.ty*cos;this._bTransform=true;return this;}},{key:"skew",value:function skew(x,y){var tanX=Math.tan(x);var tanY=Math.tan(y);var a1=this.a;var b1=this.b;this.a+=tanY*this.c;this.b+=tanY*this.d;this.c+=tanX*a1;this.d+=tanX*b1;return this;}},{key:"invertTransformPoint",value:function invertTransformPoint(out){var a1=this.a;var b1=this.b;var c1=this.c;var d1=this.d;var tx1=this.tx;var n=a1*d1-b1*c1;var a2=d1/n;var b2=-b1/n;var c2=-c1/n;var d2=a1/n;var tx2=(c1*this.ty-d1*tx1)/n;var ty2=-(a1*this.ty-b1*tx1)/n;return out.setTo(a2*out.x+c2*out.y+tx2,b2*out.x+d2*out.y+ty2);}},{key:"transformPoint",value:function transformPoint(out){return out.setTo(this.a*out.x+this.c*out.y+this.tx,this.b*out.x+this.d*out.y+this.ty);}},{key:"transformPointN",value:function transformPointN(out){return out.setTo(this.a*out.x+this.c*out.y,this.b*out.x+this.d*out.y);}},{key:"getScaleX",value:function getScaleX(){return this.b===0?this.a:Math.sqrt(this.a*this.a+this.b*this.b);}},{key:"getScaleY",value:function getScaleY(){return this.c===0?this.d:Math.sqrt(this.c*this.c+this.d*this.d);}},{key:"invert",value:function invert(){var a1=this.a;var b1=this.b;var c1=this.c;var d1=this.d;var tx1=this.tx;var n=a1*d1-b1*c1;this.a=d1/n;this.b=-b1/n;this.c=-c1/n;this.d=a1/n;this.tx=(c1*this.ty-d1*tx1)/n;this.ty=-(a1*this.ty-b1*tx1)/n;return this;}},{key:"setTo",value:function setTo(a,b,c,d,tx,ty){this.a=a,this.b=b,this.c=c,this.d=d,this.tx=tx,this.ty=ty;return this;}},{key:"concat",value:function concat(matrix){var a=this.a;var c=this.c;var tx=this.tx;this.a=a*matrix.a+this.b*matrix.c;this.b=a*matrix.b+this.b*matrix.d;this.c=c*matrix.a+this.d*matrix.c;this.d=c*matrix.b+this.d*matrix.d;this.tx=tx*matrix.a+this.ty*matrix.c+matrix.tx;this.ty=tx*matrix.b+this.ty*matrix.d+matrix.ty;return this;}},{key:"scaleEx",value:function scaleEx(x,y){var ba=this.a,bb=this.b,bc=this.c,bd=this.d;if(bb!==0||bc!==0){this.a=x*ba;this.b=x*bb;this.c=y*bc;this.d=y*bd;}else{this.a=x*ba;this.b=0*bd;this.c=0*ba;this.d=y*bd;}this._bTransform=true;}},{key:"rotateEx",value:function rotateEx(angle){var cos=Math.cos(angle);var sin=Math.sin(angle);var ba=this.a,bb=this.b,bc=this.c,bd=this.d;if(bb!==0||bc!==0){this.a=cos*ba+sin*bc;this.b=cos*bb+sin*bd;this.c=-sin*ba+cos*bc;this.d=-sin*bb+cos*bd;}else{this.a=cos*ba;this.b=sin*bd;this.c=-sin*ba;this.d=cos*bd;}this._bTransform=true;}},{key:"clone",value:function clone(){var dec=Matrix.create();dec.a=this.a;dec.b=this.b;dec.c=this.c;dec.d=this.d;dec.tx=this.tx;dec.ty=this.ty;dec._bTransform=this._bTransform;return dec;}},{key:"copyTo",value:function copyTo(dec){dec.a=this.a;dec.b=this.b;dec.c=this.c;dec.d=this.d;dec.tx=this.tx;dec.ty=this.ty;dec._bTransform=this._bTransform;return dec;}},{key:"toString",value:function toString(){return this.a+","+this.b+","+this.c+","+this.d+","+this.tx+","+this.ty;}},{key:"destroy",value:function destroy(){this.recover();}},{key:"recover",value:function recover(){Pool.recover("Matrix",this.identity());}}],[{key:"mul",value:function mul(m1,m2,out){var aa=m1.a,ab=m1.b,ac=m1.c,ad=m1.d,atx=m1.tx,aty=m1.ty;var ba=m2.a,bb=m2.b,bc=m2.c,bd=m2.d,btx=m2.tx,bty=m2.ty;if(bb!==0||bc!==0){out.a=aa*ba+ab*bc;out.b=aa*bb+ab*bd;out.c=ac*ba+ad*bc;out.d=ac*bb+ad*bd;out.tx=ba*atx+bc*aty+btx;out.ty=bb*atx+bd*aty+bty;}else{out.a=aa*ba;out.b=ab*bd;out.c=ac*ba;out.d=ad*bd;out.tx=ba*atx+btx;out.ty=bd*aty+bty;}return out;}},{key:"mul16",value:function mul16(m1,m2,out){var aa=m1.a,ab=m1.b,ac=m1.c,ad=m1.d,atx=m1.tx,aty=m1.ty;var ba=m2.a,bb=m2.b,bc=m2.c,bd=m2.d,btx=m2.tx,bty=m2.ty;if(bb!==0||bc!==0){out[0]=aa*ba+ab*bc;out[1]=aa*bb+ab*bd;out[4]=ac*ba+ad*bc;out[5]=ac*bb+ad*bd;out[12]=ba*atx+bc*aty+btx;out[13]=bb*atx+bd*aty+bty;}else{out[0]=aa*ba;out[1]=ab*bd;out[4]=ac*ba;out[5]=ad*bd;out[12]=ba*atx+btx;out[13]=bd*aty+bty;}return out;}},{key:"create",value:function create(){return Pool.getItemByClass("Matrix",Matrix);}}]);return Matrix;}();Matrix.EMPTY=new Matrix();Matrix.TEMP=new Matrix();Matrix._createFun=null;var Point=function(){function Point(){var x=arguments.length>0&&arguments[0]!==undefined?arguments[0]:0;var y=arguments.length>1&&arguments[1]!==undefined?arguments[1]:0;_classCallCheck(this,Point);this.x=x;this.y=y;}_createClass(Point,[{key:"setTo",value:function setTo(x,y){this.x=x;this.y=y;return this;}},{key:"reset",value:function reset(){this.x=this.y=0;return this;}},{key:"recover",value:function recover(){Pool.recover("Point",this.reset());}},{key:"distance",value:function distance(x,y){return Math.sqrt((this.x-x)*(this.x-x)+(this.y-y)*(this.y-y));}},{key:"toString",value:function toString(){return this.x+","+this.y;}},{key:"normalize",value:function normalize(){var d=Math.sqrt(this.x*this.x+this.y*this.y);if(d>0){var id=1.0/d;this.x*=id;this.y*=id;}}},{key:"copy",value:function copy(point){return this.setTo(point.x,point.y);}}],[{key:"create",value:function create(){return Pool.getItemByClass("Point",Point);}}]);return Point;}();Point.TEMP=new Point();Point.EMPTY=new Point();var Rectangle=function(){function Rectangle(){var x=arguments.length>0&&arguments[0]!==undefined?arguments[0]:0;var y=arguments.length>1&&arguments[1]!==undefined?arguments[1]:0;var width=arguments.length>2&&arguments[2]!==undefined?arguments[2]:0;var height=arguments.length>3&&arguments[3]!==undefined?arguments[3]:0;_classCallCheck(this,Rectangle);this.x=x;this.y=y;this.width=width;this.height=height;}_createClass(Rectangle,[{key:"setTo",value:function setTo(x,y,width,height){this.x=x;this.y=y;this.width=width;this.height=height;return this;}},{key:"reset",value:function reset(){this.x=this.y=this.width=this.height=0;return this;}},{key:"recover",value:function recover(){if(this==Rectangle.TEMP||this==Rectangle.EMPTY){console.log("recover Temp or Empty:",this);return;}Pool.recover("Rectangle",this.reset());}},{key:"copyFrom",value:function copyFrom(source){this.x=source.x;this.y=source.y;this.width=source.width;this.height=source.height;return this;}},{key:"contains",value:function contains(x,y){if(this.width<=0||this.height<=0)return false;if(x>=this.x&&x<this.right){if(y>=this.y&&y<this.bottom){return true;}}return false;}},{key:"intersects",value:function intersects(rect){return!(rect.x>this.x+this.width||rect.x+rect.width<this.x||rect.y>this.y+this.height||rect.y+rect.height<this.y);}},{key:"intersection",value:function intersection(rect){var out=arguments.length>1&&arguments[1]!==undefined?arguments[1]:null;if(!this.intersects(rect))return null;out||(out=new Rectangle());out.x=Math.max(this.x,rect.x);out.y=Math.max(this.y,rect.y);out.width=Math.min(this.right,rect.right)-out.x;out.height=Math.min(this.bottom,rect.bottom)-out.y;return out;}},{key:"union",value:function union(source){var out=arguments.length>1&&arguments[1]!==undefined?arguments[1]:null;out||(out=new Rectangle());this.clone(out);if(source.width<=0||source.height<=0)return out;out.addPoint(source.x,source.y);out.addPoint(source.right,source.bottom);return this;}},{key:"clone",value:function clone(){var out=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;out||(out=new Rectangle());out.x=this.x;out.y=this.y;out.width=this.width;out.height=this.height;return out;}},{key:"toString",value:function toString(){return this.x+","+this.y+","+this.width+","+this.height;}},{key:"equals",value:function equals(rect){if(!rect||rect.x!==this.x||rect.y!==this.y||rect.width!==this.width||rect.height!==this.height)return false;return true;}},{key:"addPoint",value:function addPoint(x,y){this.x>x&&(this.width+=this.x-x,this.x=x);this.y>y&&(this.height+=this.y-y,this.y=y);if(this.width<x-this.x)this.width=x-this.x;if(this.height<y-this.y)this.height=y-this.y;return this;}},{key:"_getBoundPoints",value:function _getBoundPoints(){var rst=Rectangle._temB;rst.length=0;if(this.width==0||this.height==0)return rst;rst.push(this.x,this.y,this.x+this.width,this.y,this.x,this.y+this.height,this.x+this.width,this.y+this.height);return rst;}},{key:"isEmpty",value:function isEmpty(){if(this.width<=0||this.height<=0)return true;return false;}},{key:"right",get:function get(){return this.x+this.width;}},{key:"bottom",get:function get(){return this.y+this.height;}}],[{key:"create",value:function create(){return Pool.getItemByClass("Rectangle",Rectangle);}},{key:"_getBoundPointS",value:function _getBoundPointS(x,y,width,height){var rst=Rectangle._temA;rst.length=0;if(width==0||height==0)return rst;rst.push(x,y,x+width,y,x,y+height,x+width,y+height);return rst;}},{key:"_getWrapRec",value:function _getWrapRec(pointList){var rst=arguments.length>1&&arguments[1]!==undefined?arguments[1]:null;if(!pointList||pointList.length<1)return rst?rst.setTo(0,0,0,0):Rectangle.TEMP.setTo(0,0,0,0);rst=rst?rst:Rectangle.create();var i,len=pointList.length,minX,maxX,minY,maxY,tPoint=Point.TEMP;minX=minY=99999;maxX=maxY=-minX;for(i=0;i<len;i+=2){tPoint.x=pointList[i];tPoint.y=pointList[i+1];minX=minX<tPoint.x?minX:tPoint.x;minY=minY<tPoint.y?minY:tPoint.y;maxX=maxX>tPoint.x?maxX:tPoint.x;maxY=maxY>tPoint.y?maxY:tPoint.y;}return rst.setTo(minX,minY,maxX-minX,maxY-minY);}}]);return Rectangle;}();Rectangle.EMPTY=new Rectangle();Rectangle.TEMP=new Rectangle();Rectangle._temB=[];Rectangle._temA=[];var LayaGL=function LayaGL(){_classCallCheck(this,LayaGL);};LayaGL.ARRAY_BUFFER_TYPE_DATA=0;LayaGL.ARRAY_BUFFER_TYPE_CMD=1;LayaGL.ARRAY_BUFFER_REF_REFERENCE=0;LayaGL.ARRAY_BUFFER_REF_COPY=1;LayaGL.UPLOAD_SHADER_UNIFORM_TYPE_ID=0;LayaGL.UPLOAD_SHADER_UNIFORM_TYPE_DATA=1;var WebGLContext=function(){function WebGLContext(){_classCallCheck(this,WebGLContext);}_createClass(WebGLContext,null,[{key:"__init__",value:function __init__(){var gl=LayaGL.instance;WebGLContext._depthFunc=gl.LESS;WebGLContext._blendEquation=gl.FUNC_ADD;WebGLContext._blendEquationRGB=gl.FUNC_ADD;WebGLContext._blendEquationAlpha=gl.FUNC_ADD;WebGLContext._sFactor=gl.ONE;WebGLContext._dFactor=gl.ZERO;WebGLContext._sFactorAlpha=gl.ONE;WebGLContext._dFactorAlpha=gl.ZERO;WebGLContext._activedTextureID=gl.TEXTURE0;WebGLContext._glTextureIDs=[gl.TEXTURE0,gl.TEXTURE1,gl.TEXTURE2,gl.TEXTURE3,gl.TEXTURE4,gl.TEXTURE5,gl.TEXTURE6,gl.TEXTURE7];}},{key:"useProgram",value:function useProgram(gl,program){if(WebGLContext._useProgram===program)return false;gl.useProgram(program);WebGLContext._useProgram=program;return true;}},{key:"setDepthTest",value:function setDepthTest(gl,value){value!==WebGLContext._depthTest&&(WebGLContext._depthTest=value,value?gl.enable(gl.DEPTH_TEST):gl.disable(gl.DEPTH_TEST));}},{key:"setDepthMask",value:function setDepthMask(gl,value){value!==WebGLContext._depthMask&&(WebGLContext._depthMask=value,gl.depthMask(value));}},{key:"setDepthFunc",value:function setDepthFunc(gl,value){value!==WebGLContext._depthFunc&&(WebGLContext._depthFunc=value,gl.depthFunc(value));}},{key:"setBlend",value:function setBlend(gl,value){value!==WebGLContext._blend&&(WebGLContext._blend=value,value?gl.enable(gl.BLEND):gl.disable(gl.BLEND));}},{key:"setBlendEquation",value:function setBlendEquation(gl,blendEquation){if(blendEquation!==WebGLContext._blendEquation){WebGLContext._blendEquation=blendEquation;WebGLContext._blendEquationRGB=WebGLContext._blendEquationAlpha=null;gl.blendEquation(blendEquation);}}},{key:"setBlendEquationSeparate",value:function setBlendEquationSeparate(gl,blendEquationRGB,blendEquationAlpha){if(blendEquationRGB!==WebGLContext._blendEquationRGB||blendEquationAlpha!==WebGLContext._blendEquationAlpha){WebGLContext._blendEquationRGB=blendEquationRGB;WebGLContext._blendEquationAlpha=blendEquationAlpha;WebGLContext._blendEquation=null;gl.blendEquationSeparate(blendEquationRGB,blendEquationAlpha);}}},{key:"setBlendFunc",value:function setBlendFunc(gl,sFactor,dFactor){if(sFactor!==WebGLContext._sFactor||dFactor!==WebGLContext._dFactor){WebGLContext._sFactor=sFactor;WebGLContext._dFactor=dFactor;WebGLContext._sFactorRGB=null;WebGLContext._dFactorRGB=null;WebGLContext._sFactorAlpha=null;WebGLContext._dFactorAlpha=null;gl.blendFunc(sFactor,dFactor);}}},{key:"setBlendFuncSeperate",value:function setBlendFuncSeperate(gl,srcRGB,dstRGB,srcAlpha,dstAlpha){if(srcRGB!==WebGLContext._sFactorRGB||dstRGB!==WebGLContext._dFactorRGB||srcAlpha!==WebGLContext._sFactorAlpha||dstAlpha!==WebGLContext._dFactorAlpha){WebGLContext._sFactorRGB=srcRGB;WebGLContext._dFactorRGB=dstRGB;WebGLContext._sFactorAlpha=srcAlpha;WebGLContext._dFactorAlpha=dstAlpha;WebGLContext._sFactor=null;WebGLContext._dFactor=null;gl.blendFuncSeparate(srcRGB,dstRGB,srcAlpha,dstAlpha);}}},{key:"setCullFace",value:function setCullFace(gl,value){value!==WebGLContext._cullFace&&(WebGLContext._cullFace=value,value?gl.enable(gl.CULL_FACE):gl.disable(gl.CULL_FACE));}},{key:"setFrontFace",value:function setFrontFace(gl,value){value!==WebGLContext._frontFace&&(WebGLContext._frontFace=value,gl.frontFace(value));}},{key:"activeTexture",value:function activeTexture(gl,textureID){if(WebGLContext._activedTextureID!==textureID){gl.activeTexture(textureID);WebGLContext._activedTextureID=textureID;}}},{key:"bindTexture",value:function bindTexture(gl,target,texture){if(WebGLContext._activeTextures[WebGLContext._activedTextureID-gl.TEXTURE0]!==texture){gl.bindTexture(target,texture);WebGLContext._activeTextures[WebGLContext._activedTextureID-gl.TEXTURE0]=texture;}}},{key:"__init_native",value:function __init_native(){if(!ILaya.Render.supportWebGLPlusRendering)return;var webGLContext=WebGLContext;webGLContext.activeTexture=webGLContext.activeTextureForNative;webGLContext.bindTexture=webGLContext.bindTextureForNative;}},{key:"useProgramForNative",value:function useProgramForNative(gl,program){gl.useProgram(program);return true;}},{key:"setDepthTestForNative",value:function setDepthTestForNative(gl,value){if(value)gl.enable(gl.DEPTH_TEST);else gl.disable(gl.DEPTH_TEST);}},{key:"setDepthMaskForNative",value:function setDepthMaskForNative(gl,value){gl.depthMask(value);}},{key:"setDepthFuncForNative",value:function setDepthFuncForNative(gl,value){gl.depthFunc(value);}},{key:"setBlendForNative",value:function setBlendForNative(gl,value){if(value)gl.enable(gl.BLEND);else gl.disable(gl.BLEND);}},{key:"setBlendFuncForNative",value:function setBlendFuncForNative(gl,sFactor,dFactor){gl.blendFunc(sFactor,dFactor);}},{key:"setCullFaceForNative",value:function setCullFaceForNative(gl,value){if(value)gl.enable(gl.CULL_FACE);else gl.disable(gl.CULL_FACE);}},{key:"setFrontFaceForNative",value:function setFrontFaceForNative(gl,value){gl.frontFace(value);}},{key:"activeTextureForNative",value:function activeTextureForNative(gl,textureID){gl.activeTexture(textureID);}},{key:"bindTextureForNative",value:function bindTextureForNative(gl,target,texture){gl.bindTexture(target,texture);}},{key:"bindVertexArrayForNative",value:function bindVertexArrayForNative(gl,vertexArray){gl.bindVertexArray(vertexArray);}}]);return WebGLContext;}();WebGLContext._activeTextures=new Array(8);WebGLContext._useProgram=null;WebGLContext._depthTest=true;WebGLContext._depthMask=true;WebGLContext._blend=false;WebGLContext._cullFace=false;WebGLContext.mainContext=null;var Handler=function(){function Handler(){var caller=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;var method=arguments.length>1&&arguments[1]!==undefined?arguments[1]:null;var args=arguments.length>2&&arguments[2]!==undefined?arguments[2]:null;var once=arguments.length>3&&arguments[3]!==undefined?arguments[3]:false;_classCallCheck(this,Handler);this.once=false;this._id=0;this.setTo(caller,method,args,once);}_createClass(Handler,[{key:"setTo",value:function setTo(caller,method,args){var once=arguments.length>3&&arguments[3]!==undefined?arguments[3]:false;this._id=Handler._gid++;this.caller=caller;this.method=method;this.args=args;this.once=once;return this;}},{key:"run",value:function run(){if(this.method==null)return null;var id=this._id;var result=this.method.apply(this.caller,this.args);this._id===id&&this.once&&this.recover();return result;}},{key:"runWith",value:function runWith(data){if(this.method==null)return null;var id=this._id;if(data==null)var result=this.method.apply(this.caller,this.args);else if(!this.args&&!data.unshift)result=this.method.call(this.caller,data);else if(this.args)result=this.method.apply(this.caller,this.args.concat(data));else result=this.method.apply(this.caller,data);this._id===id&&this.once&&this.recover();return result;}},{key:"clear",value:function clear(){this.caller=null;this.method=null;this.args=null;return this;}},{key:"recover",value:function recover(){if(this._id>0){this._id=0;Handler._pool.push(this.clear());}}}],[{key:"create",value:function create(caller,method){var args=arguments.length>2&&arguments[2]!==undefined?arguments[2]:null;var once=arguments.length>3&&arguments[3]!==undefined?arguments[3]:true;if(Handler._pool.length)return Handler._pool.pop().setTo(caller,method,args,once);return new Handler(caller,method,args,once);}}]);return Handler;}();Handler._pool=[];Handler._gid=1;var EventDispatcher=function(){function EventDispatcher(){_classCallCheck(this,EventDispatcher);}_createClass(EventDispatcher,[{key:"hasListener",value:function hasListener(type){var listener=this._events&&this._events[type];return!!listener;}},{key:"event",value:function event(type){var data=arguments.length>1&&arguments[1]!==undefined?arguments[1]:null;if(!this._events||!this._events[type])return false;var listeners=this._events[type];if(listeners.run){if(listeners.once)delete this._events[type];data!=null?listeners.runWith(data):listeners.run();}else{for(var i=0,n=listeners.length;i<n;i++){var listener=listeners[i];if(listener){data!=null?listener.runWith(data):listener.run();}if(!listener||listener.once){listeners.splice(i,1);i--;n--;}}if(listeners.length===0&&this._events)delete this._events[type];}return true;}},{key:"on",value:function on(type,caller,listener){var args=arguments.length>3&&arguments[3]!==undefined?arguments[3]:null;return this._createListener(type,caller,listener,args,false);}},{key:"once",value:function once(type,caller,listener){var args=arguments.length>3&&arguments[3]!==undefined?arguments[3]:null;return this._createListener(type,caller,listener,args,true);}},{key:"_createListener",value:function _createListener(type,caller,listener,args,once){var offBefore=arguments.length>5&&arguments[5]!==undefined?arguments[5]:true;offBefore&&this.off(type,caller,listener,once);var handler=EventHandler.create(caller||this,listener,args,once);this._events||(this._events={});var events=this._events;if(!events[type])events[type]=handler;else{if(!events[type].run)events[type].push(handler);else events[type]=[events[type],handler];}return this;}},{key:"off",value:function off(type,caller,listener){var onceOnly=arguments.length>3&&arguments[3]!==undefined?arguments[3]:false;if(!this._events||!this._events[type])return this;if(type=="open_menu"){console.log(type);console.trace();}var listeners=this._events[type];if(listeners!=null){if(listeners.run){if((!caller||listeners.caller===caller)&&(listener==null||listeners.method===listener)&&(!onceOnly||listeners.once)){delete this._events[type];listeners.recover();}}else{var count=0;for(var i=0,n=listeners.length;i<n;i++){var item=listeners[i];if(!item){count++;continue;}if(item&&(!caller||item.caller===caller)&&(listener==null||item.method===listener)&&(!onceOnly||item.once)){count++;listeners[i]=null;item.recover();}}if(count===n)delete this._events[type];}}return this;}},{key:"offAll",value:function offAll(){var type=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;var events=this._events;if(!events)return this;if(type){this._recoverHandlers(events[type]);delete events[type];}else{for(var name in events){this._recoverHandlers(events[name]);}this._events=null;}return this;}},{key:"offAllCaller",value:function offAllCaller(caller){if(caller&&this._events){for(var name in this._events){this.off(name,caller,null);}}return this;}},{key:"_recoverHandlers",value:function _recoverHandlers(arr){if(!arr)return;if(arr.run){arr.recover();}else{for(var i=arr.length-1;i>-1;i--){if(arr[i]){arr[i].recover();arr[i]=null;}}}}},{key:"isMouseEvent",value:function isMouseEvent(type){return EventDispatcher.MOUSE_EVENTS[type]||false;}}]);return EventDispatcher;}();EventDispatcher.MOUSE_EVENTS={"rightmousedown":true,"rightmouseup":true,"rightclick":true,"mousedown":true,"mouseup":true,"mousemove":true,"mouseover":true,"mouseout":true,"click":true,"doubleclick":true};var EventHandler=function(_Handler){_inherits(EventHandler,_Handler);function EventHandler(caller,method,args,once){_classCallCheck(this,EventHandler);return _possibleConstructorReturn(this,(EventHandler.__proto__||Object.getPrototypeOf(EventHandler)).call(this,caller,method,args,once));}_createClass(EventHandler,[{key:"recover",value:function recover(){if(this._id>0){this._id=0;EventHandler._pool.push(this.clear());}}}],[{key:"create",value:function create(caller,method){var args=arguments.length>2&&arguments[2]!==undefined?arguments[2]:null;var once=arguments.length>3&&arguments[3]!==undefined?arguments[3]:true;if(EventHandler._pool.length)return EventHandler._pool.pop().setTo(caller,method,args,once);return new EventHandler(caller,method,args,once);}}]);return EventHandler;}(Handler);EventHandler._pool=[];var URL=function(){function URL(url){_classCallCheck(this,URL);this._url=URL.formatURL(url);this._path=URL.getPath(url);}_createClass(URL,[{key:"url",get:function get(){return this._url;}},{key:"path",get:function get(){return this._path;}}],[{key:"formatURL",value:function formatURL(url){if(!url)return"null path";if(url.indexOf(":")>0)return url;if(URL.customFormat!=null)url=URL.customFormat(url);if(url.indexOf(":")>0)return url;var char1=url.charAt(0);if(char1==="."){return URL._formatRelativePath(URL._basePath+url);}else if(char1==='~'){return URL.rootPath+url.substring(1);}else if(char1==="d"){if(url.indexOf("data:image")===0)return url;}else if(char1==="/"){return url;}return URL._basePath+url;}},{key:"_formatRelativePath",value:function _formatRelativePath(value){var parts=value.split("/");for(var i=0,len=parts.length;i<len;i++){if(parts[i]=='..'){parts.splice(i-1,2);i-=2;}}return parts.join('/');}},{key:"getPath",value:function getPath(url){var ofs=url.lastIndexOf('/');return ofs>0?url.substr(0,ofs+1):"";}},{key:"getFileName",value:function getFileName(url){var ofs=url.lastIndexOf('/');return ofs>0?url.substr(ofs+1):url;}},{key:"getAdptedFilePath",value:function getAdptedFilePath(url){if(!URL.exportSceneToJson||!url)return url;var i,len;len=URL._adpteTypeList.length;var tArr;for(i=0;i<len;i++){tArr=URL._adpteTypeList[i];url=url.replace(tArr[0],tArr[1]);}return url;}},{key:"basePath",set:function set(value){URL._basePath=ILaya.Laya._getUrlPath();URL._basePath=URL.formatURL(value);},get:function get(){return URL._basePath;}}]);return URL;}();URL.version={};URL.exportSceneToJson=false;URL._basePath="";URL.rootPath="";URL.customFormat=function(url){var newUrl=URL.version[url];if(!window.conch&&newUrl)url+="?v="+newUrl;return url;};URL._adpteTypeList=[[".scene3d",".json"],[".scene",".json"],[".taa",".json"],[".prefab",".json"]];var Resource=function(_EventDispatcher){_inherits(Resource,_EventDispatcher);function Resource(){_classCallCheck(this,Resource);var _this3=_possibleConstructorReturn(this,(Resource.__proto__||Object.getPrototypeOf(Resource)).call(this));_this3._id=0;_this3._url=null;_this3._cpuMemory=0;_this3._gpuMemory=0;_this3._destroyed=false;_this3._referenceCount=0;_this3.lock=false;_this3.name=null;_this3._id=++Resource._uniqueIDCounter;_this3._destroyed=false;_this3._referenceCount=0;Resource._idResourcesMap[_this3.id]=_this3;_this3.lock=false;return _this3;}_createClass(Resource,[{key:"_setCPUMemory",value:function _setCPUMemory(value){var offsetValue=value-this._cpuMemory;this._cpuMemory=value;Resource._addCPUMemory(offsetValue);}},{key:"_setGPUMemory",value:function _setGPUMemory(value){var offsetValue=value-this._gpuMemory;this._gpuMemory=value;Resource._addGPUMemory(offsetValue);}},{key:"_setCreateURL",value:function _setCreateURL(url){url=URL.formatURL(url);if(this._url!==url){var resList;if(this._url){resList=Resource._urlResourcesMap[this._url];resList.splice(resList.indexOf(this),1);resList.length===0&&delete Resource._urlResourcesMap[this._url];}if(url){resList=Resource._urlResourcesMap[url];resList||(Resource._urlResourcesMap[url]=resList=[]);resList.push(this);}this._url=url;}}},{key:"_addReference",value:function _addReference(){var count=arguments.length>0&&arguments[0]!==undefined?arguments[0]:1;this._referenceCount+=count;}},{key:"_removeReference",value:function _removeReference(){var count=arguments.length>0&&arguments[0]!==undefined?arguments[0]:1;this._referenceCount-=count;}},{key:"_clearReference",value:function _clearReference(){this._referenceCount=0;}},{key:"_recoverResource",value:function _recoverResource(){}},{key:"_disposeResource",value:function _disposeResource(){}},{key:"_activeResource",value:function _activeResource(){}},{key:"destroy",value:function destroy(){if(this._destroyed)return;this._destroyed=true;this.lock=false;this._disposeResource();delete Resource._idResourcesMap[this.id];var resList;if(this._url){resList=Resource._urlResourcesMap[this._url];if(resList){resList.splice(resList.indexOf(this),1);resList.length===0&&delete Resource._urlResourcesMap[this._url];}var resou=ILaya.Loader.loadedMap[this._url];resou==this&&delete ILaya.Loader.loadedMap[this._url];}}},{key:"id",get:function get(){return this._id;}},{key:"url",get:function get(){return this._url;}},{key:"cpuMemory",get:function get(){return this._cpuMemory;}},{key:"gpuMemory",get:function get(){return this._gpuMemory;}},{key:"destroyed",get:function get(){return this._destroyed;}},{key:"referenceCount",get:function get(){return this._referenceCount;}}],[{key:"_addCPUMemory",value:function _addCPUMemory(size){Resource._cpuMemory+=size;}},{key:"_addGPUMemory",value:function _addGPUMemory(size){Resource._gpuMemory+=size;}},{key:"_addMemory",value:function _addMemory(cpuSize,gpuSize){Resource._cpuMemory+=cpuSize;Resource._gpuMemory+=gpuSize;}},{key:"getResourceByID",value:function getResourceByID(id){return Resource._idResourcesMap[id];}},{key:"getResourceByURL",value:function getResourceByURL(url){var index=arguments.length>1&&arguments[1]!==undefined?arguments[1]:0;return Resource._urlResourcesMap[url][index];}},{key:"destroyUnusedResources",value:function destroyUnusedResources(){for(var k in Resource._idResourcesMap){var res=Resource._idResourcesMap[k];if(!res.lock&&res._referenceCount===0)res.destroy();}}},{key:"cpuMemory",get:function get(){return Resource._cpuMemory;}},{key:"gpuMemory",get:function get(){return Resource._gpuMemory;}}]);return Resource;}(EventDispatcher);Resource._uniqueIDCounter=0;Resource._idResourcesMap={};Resource._urlResourcesMap={};Resource._cpuMemory=0;Resource._gpuMemory=0;var Bitmap=function(_Resource){_inherits(Bitmap,_Resource);_createClass(Bitmap,[{key:"width",get:function get(){return this._width;},set:function set(width){this._width=width;}},{key:"height",get:function get(){return this._height;},set:function set(height){this._height=height;}}]);function Bitmap(){_classCallCheck(this,Bitmap);var _this4=_possibleConstructorReturn(this,(Bitmap.__proto__||Object.getPrototypeOf(Bitmap)).call(this));_this4._width=-1;_this4._height=-1;return _this4;}_createClass(Bitmap,[{key:"_getSource",value:function _getSource(){throw"Bitmap: must override it.";}}]);return Bitmap;}(Resource);(function(TextureFormat){TextureFormat[TextureFormat["R8G8B8"]=0]="R8G8B8";TextureFormat[TextureFormat["R8G8B8A8"]=1]="R8G8B8A8";TextureFormat[TextureFormat["Alpha8"]=2]="Alpha8";TextureFormat[TextureFormat["DXT1"]=3]="DXT1";TextureFormat[TextureFormat["DXT5"]=4]="DXT5";TextureFormat[TextureFormat["ETC1RGB"]=5]="ETC1RGB";TextureFormat[TextureFormat["PVRTCRGB_2BPPV"]=9]="PVRTCRGB_2BPPV";TextureFormat[TextureFormat["PVRTCRGBA_2BPPV"]=10]="PVRTCRGBA_2BPPV";TextureFormat[TextureFormat["PVRTCRGB_4BPPV"]=11]="PVRTCRGB_4BPPV";TextureFormat[TextureFormat["PVRTCRGBA_4BPPV"]=12]="PVRTCRGBA_4BPPV";TextureFormat[TextureFormat["R32G32B32A32"]=15]="R32G32B32A32";})(exports.TextureFormat||(exports.TextureFormat={}));var BaseTexture=function(_Bitmap){_inherits(BaseTexture,_Bitmap);function BaseTexture(format,mipMap){_classCallCheck(this,BaseTexture);var _this5=_possibleConstructorReturn(this,(BaseTexture.__proto__||Object.getPrototypeOf(BaseTexture)).call(this));_this5._wrapModeU=BaseTexture.WARPMODE_REPEAT;_this5._wrapModeV=BaseTexture.WARPMODE_REPEAT;_this5._filterMode=BaseTexture.FILTERMODE_BILINEAR;_this5._readyed=false;_this5._width=-1;_this5._height=-1;_this5._format=format;_this5._mipmap=mipMap;_this5._anisoLevel=1;_this5._glTexture=LayaGL.instance.createTexture();return _this5;}_createClass(BaseTexture,[{key:"_getFormatByteCount",value:function _getFormatByteCount(){switch(this._format){case exports.TextureFormat.R8G8B8:return 3;case exports.TextureFormat.R8G8B8A8:return 4;case exports.TextureFormat.Alpha8:return 1;case exports.TextureFormat.R32G32B32A32:return 4;default:throw"Texture2D: unknown format.";}}},{key:"_isPot",value:function _isPot(size){return(size&size-1)===0;}},{key:"_getGLFormat",value:function _getGLFormat(){var glFormat;var gl=LayaGL.instance;var gpu=LayaGL.layaGPUInstance;switch(this._format){case exports.TextureFormat.R8G8B8:glFormat=gl.RGB;break;case exports.TextureFormat.R8G8B8A8:glFormat=gl.RGBA;break;case exports.TextureFormat.Alpha8:glFormat=gl.ALPHA;break;case exports.TextureFormat.R32G32B32A32:glFormat=gl.RGBA;break;case exports.TextureFormat.DXT1:if(gpu._compressedTextureS3tc)glFormat=gpu._compressedTextureS3tc.COMPRESSED_RGB_S3TC_DXT1_EXT;else throw"BaseTexture: not support DXT1 format.";break;case exports.TextureFormat.DXT5:if(gpu._compressedTextureS3tc)glFormat=gpu._compressedTextureS3tc.COMPRESSED_RGBA_S3TC_DXT5_EXT;else throw"BaseTexture: not support DXT5 format.";break;case exports.TextureFormat.ETC1RGB:if(gpu._compressedTextureEtc1)glFormat=gpu._compressedTextureEtc1.COMPRESSED_RGB_ETC1_WEBGL;else throw"BaseTexture: not support ETC1RGB format.";break;case exports.TextureFormat.PVRTCRGB_2BPPV:if(gpu._compressedTexturePvrtc)glFormat=gpu._compressedTexturePvrtc.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;else throw"BaseTexture: not support PVRTCRGB_2BPPV format.";break;case exports.TextureFormat.PVRTCRGBA_2BPPV:if(gpu._compressedTexturePvrtc)glFormat=gpu._compressedTexturePvrtc.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;else throw"BaseTexture: not support PVRTCRGBA_2BPPV format.";break;case exports.TextureFormat.PVRTCRGB_4BPPV:if(gpu._compressedTexturePvrtc)glFormat=gpu._compressedTexturePvrtc.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;else throw"BaseTexture: not support PVRTCRGB_4BPPV format.";break;case exports.TextureFormat.PVRTCRGBA_4BPPV:if(gpu._compressedTexturePvrtc)glFormat=gpu._compressedTexturePvrtc.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;else throw"BaseTexture: not support PVRTCRGBA_4BPPV format.";break;default:throw"BaseTexture: unknown texture format.";}return glFormat;}},{key:"_setFilterMode",value:function _setFilterMode(value){var gl=LayaGL.instance;WebGLContext.bindTexture(gl,this._glTextureType,this._glTexture);switch(value){case BaseTexture.FILTERMODE_POINT:if(this._mipmap)gl.texParameteri(this._glTextureType,gl.TEXTURE_MIN_FILTER,gl.NEAREST_MIPMAP_NEAREST);else gl.texParameteri(this._glTextureType,gl.TEXTURE_MIN_FILTER,gl.NEAREST);gl.texParameteri(this._glTextureType,gl.TEXTURE_MAG_FILTER,gl.NEAREST);break;case BaseTexture.FILTERMODE_BILINEAR:if(this._mipmap)gl.texParameteri(this._glTextureType,gl.TEXTURE_MIN_FILTER,gl.LINEAR_MIPMAP_NEAREST);else gl.texParameteri(this._glTextureType,gl.TEXTURE_MIN_FILTER,gl.LINEAR);gl.texParameteri(this._glTextureType,gl.TEXTURE_MAG_FILTER,gl.LINEAR);break;case BaseTexture.FILTERMODE_TRILINEAR:if(this._mipmap)gl.texParameteri(this._glTextureType,gl.TEXTURE_MIN_FILTER,gl.LINEAR_MIPMAP_LINEAR);else gl.texParameteri(this._glTextureType,gl.TEXTURE_MIN_FILTER,gl.LINEAR);gl.texParameteri(this._glTextureType,gl.TEXTURE_MAG_FILTER,gl.LINEAR);break;default:throw new Error("BaseTexture:unknown filterMode value.");}}},{key:"_setWarpMode",value:function _setWarpMode(orientation,mode){var gl=LayaGL.instance;WebGLContext.bindTexture(gl,this._glTextureType,this._glTexture);if(this._isPot(this._width)&&this._isPot(this._height)){switch(mode){case BaseTexture.WARPMODE_REPEAT:gl.texParameteri(this._glTextureType,orientation,gl.REPEAT);break;case BaseTexture.WARPMODE_CLAMP:gl.texParameteri(this._glTextureType,orientation,gl.CLAMP_TO_EDGE);break;}}else{gl.texParameteri(this._glTextureType,orientation,gl.CLAMP_TO_EDGE);}}},{key:"_setAnisotropy",value:function _setAnisotropy(value){var anisotropic=LayaGL.layaGPUInstance._extTextureFilterAnisotropic;if(anisotropic){value=Math.max(value,1);var gl=LayaGL.instance;WebGLContext.bindTexture(gl,this._glTextureType,this._glTexture);value=Math.min(gl.getParameter(anisotropic.MAX_TEXTURE_MAX_ANISOTROPY_EXT),value);gl.texParameterf(this._glTextureType,anisotropic.TEXTURE_MAX_ANISOTROPY_EXT,value);}}},{key:"_disposeResource",value:function _disposeResource(){if(this._glTexture){LayaGL.instance.deleteTexture(this._glTexture);this._glTexture=null;this._setGPUMemory(0);}}},{key:"_getSource",value:function _getSource(){if(this._readyed)return this._glTexture;else return null;}},{key:"generateMipmap",value:function generateMipmap(){if(this._isPot(this.width)&&this._isPot(this.height))LayaGL.instance.generateMipmap(this._glTextureType);}},{key:"mipmap",get:function get(){return this._mipmap;}},{key:"format",get:function get(){return this._format;}},{key:"wrapModeU",get:function get(){return this._wrapModeU;},set:function set(value){if(this._wrapModeU!==value){this._wrapModeU=value;this._width!==-1&&this._setWarpMode(LayaGL.instance.TEXTURE_WRAP_S,value);}}},{key:"wrapModeV",get:function get(){return this._wrapModeV;},set:function set(value){if(this._wrapModeV!==value){this._wrapModeV=value;this._height!==-1&&this._setWarpMode(LayaGL.instance.TEXTURE_WRAP_T,value);}}},{key:"filterMode",get:function get(){return this._filterMode;},set:function set(value){if(value!==this._filterMode){this._filterMode=value;this._width!==-1&&this._height!==-1&&this._setFilterMode(value);}}},{key:"anisoLevel",get:function get(){return this._anisoLevel;},set:function set(value){if(value!==this._anisoLevel){this._anisoLevel=Math.max(1,Math.min(16,value));this._width!==-1&&this._height!==-1&&this._setAnisotropy(value);}}},{key:"mipmapCount",get:function get(){return this._mipmapCount;}},{key:"defaulteTexture",get:function get(){throw"BaseTexture:must override it.";}}]);return BaseTexture;}(Bitmap);BaseTexture.WARPMODE_REPEAT=0;BaseTexture.WARPMODE_CLAMP=1;BaseTexture.FILTERMODE_POINT=0;BaseTexture.FILTERMODE_BILINEAR=1;BaseTexture.FILTERMODE_TRILINEAR=2;BaseTexture.FORMAT_R8G8B8=0;BaseTexture.FORMAT_R8G8B8A8=1;BaseTexture.FORMAT_ALPHA8=2;BaseTexture.FORMAT_DXT1=3;BaseTexture.FORMAT_DXT5=4;BaseTexture.FORMAT_ETC1RGB=5;BaseTexture.FORMAT_PVRTCRGB_2BPPV=9;BaseTexture.FORMAT_PVRTCRGBA_2BPPV=10;BaseTexture.FORMAT_PVRTCRGB_4BPPV=11;BaseTexture.FORMAT_PVRTCRGBA_4BPPV=12;BaseTexture.RENDERTEXTURE_FORMAT_RGBA_HALF_FLOAT=14;BaseTexture.FORMAT_R32G32B32A32=15;BaseTexture.FORMAT_DEPTH_16=0;BaseTexture.FORMAT_STENCIL_8=1;BaseTexture.FORMAT_DEPTHSTENCIL_16_8=2;BaseTexture.FORMAT_DEPTHSTENCIL_NONE=3;var Texture2D=function(_BaseTexture){_inherits(Texture2D,_BaseTexture);function Texture2D(){var width=arguments.length>0&&arguments[0]!==undefined?arguments[0]:0;var height=arguments.length>1&&arguments[1]!==undefined?arguments[1]:0;var format=arguments.length>2&&arguments[2]!==undefined?arguments[2]:exports.TextureFormat.R8G8B8A8;var mipmap=arguments.length>3&&arguments[3]!==undefined?arguments[3]:true;var canRead=arguments.length>4&&arguments[4]!==undefined?arguments[4]:false;_classCallCheck(this,Texture2D);var _this6=_possibleConstructorReturn(this,(Texture2D.__proto__||Object.getPrototypeOf(Texture2D)).call(this,format,mipmap));var gl=LayaGL.instance;_this6._glTextureType=gl.TEXTURE_2D;_this6._width=width;_this6._height=height;_this6._canRead=canRead;_this6._setWarpMode(gl.TEXTURE_WRAP_S,_this6._wrapModeU);_this6._setWarpMode(gl.TEXTURE_WRAP_T,_this6._wrapModeV);_this6._setFilterMode(_this6._filterMode);_this6._setAnisotropy(_this6._anisoLevel);var compress=_this6._gpuCompressFormat();if(mipmap){var mipCount=Math.max(Math.ceil(Math.log2(width))+1,Math.ceil(Math.log2(height))+1);if(!compress){for(var i=0;i<mipCount;i++){_this6._setPixels(null,i,Math.max(width>>i,1),Math.max(height>>i,1));}}_this6._mipmapCount=mipCount;_this6._setGPUMemory(width*height*4*(1+1/3));}else{if(!compress)_this6._setPixels(null,0,width,height);_this6._mipmapCount=1;_this6._setGPUMemory(width*height*4);}return _this6;}_createClass(Texture2D,[{key:"_gpuCompressFormat",value:function _gpuCompressFormat(){return this._format==exports.TextureFormat.DXT1||this._format==exports.TextureFormat.DXT5||this._format==exports.TextureFormat.ETC1RGB||this._format==exports.TextureFormat.PVRTCRGB_2BPPV||this._format==exports.TextureFormat.PVRTCRGBA_2BPPV||this._format==exports.TextureFormat.PVRTCRGB_4BPPV||this._format==exports.TextureFormat.PVRTCRGBA_4BPPV;}},{key:"_setPixels",value:function _setPixels(pixels,miplevel,width,height){var gl=LayaGL.instance;var textureType=this._glTextureType;var glFormat=this._getGLFormat();WebGLContext.bindTexture(gl,textureType,this._glTexture);switch(this.format){case exports.TextureFormat.R8G8B8:gl.pixelStorei(gl.UNPACK_ALIGNMENT,1);gl.texImage2D(textureType,miplevel,glFormat,width,height,0,glFormat,gl.UNSIGNED_BYTE,pixels);gl.pixelStorei(gl.UNPACK_ALIGNMENT,4);break;case exports.TextureFormat.R32G32B32A32:if(LayaGL.layaGPUInstance._isWebGL2)gl.texImage2D(textureType,miplevel,gl.RGBA32F,width,height,0,glFormat,gl.FLOAT,pixels);else gl.texImage2D(textureType,miplevel,gl.RGBA,width,height,0,glFormat,gl.FLOAT,pixels);break;default:gl.texImage2D(textureType,miplevel,glFormat,width,height,0,glFormat,gl.UNSIGNED_BYTE,pixels);}}},{key:"_calcualatesCompressedDataSize",value:function _calcualatesCompressedDataSize(format,width,height){switch(format){case exports.TextureFormat.DXT1:case exports.TextureFormat.ETC1RGB:return(width+3>>2)*(height+3>>2)*8;case exports.TextureFormat.DXT5:return(width+3>>2)*(height+3>>2)*16;case exports.TextureFormat.PVRTCRGB_4BPPV:case exports.TextureFormat.PVRTCRGBA_4BPPV:return Math.floor((Math.max(width,8)*Math.max(height,8)*4+7)/8);case exports.TextureFormat.PVRTCRGB_2BPPV:case exports.TextureFormat.PVRTCRGBA_2BPPV:return Math.floor((Math.max(width,16)*Math.max(height,8)*2+7)/8);default:return 0;}}},{key:"_pharseDDS",value:function _pharseDDS(arrayBuffer){var FOURCC_DXT1=827611204;var FOURCC_DXT5=894720068;var DDPF_FOURCC=0x4;var DDSD_MIPMAPCOUNT=0x20000;var DDS_MAGIC=0x20534444;var DDS_HEADER_LENGTH=31;var DDS_HEADER_MAGIC=0;var DDS_HEADER_SIZE=1;var DDS_HEADER_FLAGS=2;var DDS_HEADER_HEIGHT=3;var DDS_HEADER_WIDTH=4;var DDS_HEADER_MIPMAPCOUNT=7;var DDS_HEADER_PF_FLAGS=20;var DDS_HEADER_PF_FOURCC=21;var header=new Int32Array(arrayBuffer,0,DDS_HEADER_LENGTH);if(header[DDS_HEADER_MAGIC]!=DDS_MAGIC)throw"Invalid magic number in DDS header";if(!(header[DDS_HEADER_PF_FLAGS]&DDPF_FOURCC))throw"Unsupported format, must contain a FourCC code";var compressedFormat=header[DDS_HEADER_PF_FOURCC];switch(this._format){case exports.TextureFormat.DXT1:if(compressedFormat!==FOURCC_DXT1)throw"the FourCC code is not same with texture format.";break;case exports.TextureFormat.DXT5:if(compressedFormat!==FOURCC_DXT5)throw"the FourCC code is not same with texture format.";break;default:throw"unknown texture format.";}var mipLevels=1;if(header[DDS_HEADER_FLAGS]&DDSD_MIPMAPCOUNT){mipLevels=Math.max(1,header[DDS_HEADER_MIPMAPCOUNT]);if(!this._mipmap)throw"the mipmap is not same with Texture2D.";}else{if(this._mipmap)throw"the mipmap is not same with Texture2D.";}var width=header[DDS_HEADER_WIDTH];var height=header[DDS_HEADER_HEIGHT];this._width=width;this._height=height;var dataOffset=header[DDS_HEADER_SIZE]+4;this._upLoadCompressedTexImage2D(arrayBuffer,width,height,mipLevels,dataOffset,0);}},{key:"_pharseKTX",value:function _pharseKTX(arrayBuffer){var ETC_HEADER_LENGTH=13;var ETC_HEADER_FORMAT=4;var ETC_HEADER_HEIGHT=7;var ETC_HEADER_WIDTH=6;var ETC_HEADER_MIPMAPCOUNT=11;var ETC_HEADER_METADATA=12;var id=new Uint8Array(arrayBuffer,0,12);if(id[0]!=0xAB||id[1]!=0x4B||id[2]!=0x54||id[3]!=0x58||id[4]!=0x20||id[5]!=0x31||id[6]!=0x31||id[7]!=0xBB||id[8]!=0x0D||id[9]!=0x0A||id[10]!=0x1A||id[11]!=0x0A)throw"Invalid fileIdentifier in KTX header";var header=new Int32Array(id.buffer,id.length,ETC_HEADER_LENGTH);var compressedFormat=header[ETC_HEADER_FORMAT];switch(compressedFormat){case LayaGL.layaGPUInstance._compressedTextureEtc1.COMPRESSED_RGB_ETC1_WEBGL:this._format=exports.TextureFormat.ETC1RGB;break;default:throw"unknown texture format.";}var mipLevels=header[ETC_HEADER_MIPMAPCOUNT];var width=header[ETC_HEADER_WIDTH];var height=header[ETC_HEADER_HEIGHT];this._width=width;this._height=height;var dataOffset=64+header[ETC_HEADER_METADATA];this._upLoadCompressedTexImage2D(arrayBuffer,width,height,mipLevels,dataOffset,4);}},{key:"_pharsePVR",value:function _pharsePVR(arrayBuffer){var PVR_FORMAT_2BPP_RGB=0;var PVR_FORMAT_2BPP_RGBA=1;var PVR_FORMAT_4BPP_RGB=2;var PVR_FORMAT_4BPP_RGBA=3;var PVR_MAGIC=0x03525650;var PVR_HEADER_LENGTH=13;var PVR_HEADER_MAGIC=0;var PVR_HEADER_FORMAT=2;var PVR_HEADER_HEIGHT=6;var PVR_HEADER_WIDTH=7;var PVR_HEADER_MIPMAPCOUNT=11;var PVR_HEADER_METADATA=12;var header=new Int32Array(arrayBuffer,0,PVR_HEADER_LENGTH);if(header[PVR_HEADER_MAGIC]!=PVR_MAGIC)throw"Invalid magic number in PVR header";var compressedFormat=header[PVR_HEADER_FORMAT];switch(compressedFormat){case PVR_FORMAT_2BPP_RGB:this._format=exports.TextureFormat.PVRTCRGB_2BPPV;break;case PVR_FORMAT_4BPP_RGB:this._format=exports.TextureFormat.PVRTCRGB_4BPPV;break;case PVR_FORMAT_2BPP_RGBA:this._format=exports.TextureFormat.PVRTCRGBA_2BPPV;break;case PVR_FORMAT_4BPP_RGBA:this._format=exports.TextureFormat.PVRTCRGBA_4BPPV;break;default:throw"Texture2D:unknown PVR format.";}var mipLevels=header[PVR_HEADER_MIPMAPCOUNT];var width=header[PVR_HEADER_WIDTH];var height=header[PVR_HEADER_HEIGHT];this._width=width;this._height=height;var dataOffset=header[PVR_HEADER_METADATA]+52;this._upLoadCompressedTexImage2D(arrayBuffer,width,height,mipLevels,dataOffset,0);}},{key:"_upLoadCompressedTexImage2D",value:function _upLoadCompressedTexImage2D(data,width,height,miplevelCount,dataOffset,imageSizeOffset){var gl=LayaGL.instance;var textureType=this._glTextureType;WebGLContext.bindTexture(gl,textureType,this._glTexture);var glFormat=this._getGLFormat();var offset=dataOffset;for(var i=0;i<miplevelCount;i++){offset+=imageSizeOffset;var mipDataSize=this._calcualatesCompressedDataSize(this._format,width,height);var mipData=new Uint8Array(data,offset,mipDataSize);gl.compressedTexImage2D(textureType,i,glFormat,width,height,0,mipData);width=Math.max(width>>1,1.0);height=Math.max(height>>1,1.0);offset+=mipDataSize;}var memory=offset;this._setGPUMemory(memory);this._readyed=true;this._activeResource();}},{key:"loadImageSource",value:function loadImageSource(source){var premultiplyAlpha=arguments.length>1&&arguments[1]!==undefined?arguments[1]:false;var gl=LayaGL.instance;var width=source.width;var height=source.height;this._width=width;this._height=height;if(!(this._isPot(width)&&this._isPot(height)))this._mipmap=false;this._setWarpMode(gl.TEXTURE_WRAP_S,this._wrapModeU);this._setWarpMode(gl.TEXTURE_WRAP_T,this._wrapModeV);this._setFilterMode(this._filterMode);WebGLContext.bindTexture(gl,this._glTextureType,this._glTexture);var glFormat=this._getGLFormat();if(ILaya.Render.isConchApp){if(source.setPremultiplyAlpha){source.setPremultiplyAlpha(premultiplyAlpha);}gl.texImage2D(this._glTextureType,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,source);}else{premultiplyAlpha&&gl.pixelStorei(gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,true);gl.texImage2D(this._glTextureType,0,glFormat,glFormat,gl.UNSIGNED_BYTE,source);premultiplyAlpha&&gl.pixelStorei(gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,false);}if(this._mipmap){gl.generateMipmap(this._glTextureType);this._setGPUMemory(width*height*4*(1+1/3));}else{this._setGPUMemory(width*height*4);}if(this._canRead){if(ILaya.Render.isConchApp){this._pixels=new Uint8Array(source._nativeObj.getImageData(0,0,width,height));}else{ILaya.Browser.canvas.size(width,height);ILaya.Browser.canvas.clear();ILaya.Browser.context.drawImage(source,0,0,width,height);this._pixels=new Uint8Array(ILaya.Browser.context.getImageData(0,0,width,height).data.buffer);}}this._readyed=true;this._activeResource();}},{key:"setPixels",value:function setPixels(pixels){var miplevel=arguments.length>1&&arguments[1]!==undefined?arguments[1]:0;if(this._gpuCompressFormat())throw"Texture2D:the format is GPU compression format.";if(!pixels)throw"Texture2D:pixels can't be null.";var width=Math.max(this._width>>miplevel,1);var height=Math.max(this._height>>miplevel,1);var pixelsCount=width*height*this._getFormatByteCount();if(pixels.length<pixelsCount)throw"Texture2D:pixels length should at least "+pixelsCount+".";this._setPixels(pixels,miplevel,width,height);if(this._canRead)this._pixels=pixels;this._readyed=true;this._activeResource();}},{key:"setSubPixels",value:function setSubPixels(x,y,width,height,pixels){var miplevel=arguments.length>5&&arguments[5]!==undefined?arguments[5]:0;if(this._gpuCompressFormat())throw"Texture2D:the format is GPU compression format.";if(!pixels)throw"Texture2D:pixels can't be null.";var gl=LayaGL.instance;var textureType=this._glTextureType;WebGLContext.bindTexture(gl,textureType,this._glTexture);var glFormat=this._getGLFormat();switch(this.format){case exports.TextureFormat.R8G8B8:gl.pixelStorei(gl.UNPACK_ALIGNMENT,1);gl.texSubImage2D(textureType,miplevel,x,y,width,height,glFormat,gl.UNSIGNED_BYTE,pixels);gl.pixelStorei(gl.UNPACK_ALIGNMENT,4);break;case exports.TextureFormat.R32G32B32A32:gl.texSubImage2D(textureType,miplevel,x,y,width,height,glFormat,gl.FLOAT,pixels);break;default:gl.texSubImage2D(textureType,miplevel,x,y,width,height,glFormat,gl.UNSIGNED_BYTE,pixels);}this._readyed=true;this._activeResource();}},{key:"setCompressData",value:function setCompressData(data){switch(this._format){case exports.TextureFormat.DXT1:case exports.TextureFormat.DXT5:this._pharseDDS(data);break;case exports.TextureFormat.ETC1RGB:this._pharseKTX(data);break;case exports.TextureFormat.PVRTCRGB_2BPPV:case exports.TextureFormat.PVRTCRGBA_2BPPV:case exports.TextureFormat.PVRTCRGB_4BPPV:case exports.TextureFormat.PVRTCRGBA_4BPPV:this._pharsePVR(data);break;default:throw"Texture2D:unkonwn format.";}}},{key:"_recoverResource",value:function _recoverResource(){}},{key:"getPixels",value:function getPixels(){if(this._canRead)return this._pixels;else throw new Error("Texture2D: must set texture canRead is true.");}},{key:"defaulteTexture",get:function get(){return Texture2D.grayTexture;}}],[{key:"__init__",value:function __init__(){var pixels=new Uint8Array(3);pixels[0]=128;pixels[1]=128;pixels[2]=128;Texture2D.grayTexture=new Texture2D(1,1,exports.TextureFormat.R8G8B8,false,false);Texture2D.grayTexture.setPixels(pixels);Texture2D.grayTexture.lock=true;pixels[0]=255;pixels[1]=255;pixels[2]=255;Texture2D.whiteTexture=new Texture2D(1,1,exports.TextureFormat.R8G8B8,false,false);Texture2D.whiteTexture.setPixels(pixels);Texture2D.whiteTexture.lock=true;pixels[0]=0;pixels[1]=0;pixels[2]=0;Texture2D.blackTexture=new Texture2D(1,1,exports.TextureFormat.R8G8B8,false,false);Texture2D.blackTexture.setPixels(pixels);Texture2D.blackTexture.lock=true;}},{key:"_parse",value:function _parse(data){var propertyParams=arguments.length>1&&arguments[1]!==undefined?arguments[1]:null;var constructParams=arguments.length>2&&arguments[2]!==undefined?arguments[2]:null;var texture=constructParams?new Texture2D(constructParams[0],constructParams[1],constructParams[2],constructParams[3],constructParams[4]):new Texture2D(0,0);if(propertyParams){texture.wrapModeU=propertyParams.wrapModeU;texture.wrapModeV=propertyParams.wrapModeV;texture.filterMode=propertyParams.filterMode;texture.anisoLevel=propertyParams.anisoLevel;}switch(texture._format){case exports.TextureFormat.R8G8B8:case exports.TextureFormat.R8G8B8A8:texture.loadImageSource(data);break;case exports.TextureFormat.DXT1:case exports.TextureFormat.DXT5:case exports.TextureFormat.ETC1RGB:case exports.TextureFormat.PVRTCRGB_2BPPV:case exports.TextureFormat.PVRTCRGBA_2BPPV:case exports.TextureFormat.PVRTCRGB_4BPPV:case exports.TextureFormat.PVRTCRGBA_4BPPV:texture.setCompressData(data);break;default:throw"Texture2D:unkonwn format.";}return texture;}},{key:"load",value:function load(url,complete){ILaya.loader.create(url,complete,null,ILaya.Loader.TEXTURE2D);}}]);return Texture2D;}(BaseTexture);Texture2D.TEXTURE2D="TEXTURE2D";Texture2D.grayTexture=null;Texture2D.whiteTexture=null;Texture2D.blackTexture=null;var BaseShader=function(_Resource2){_inherits(BaseShader,_Resource2);function BaseShader(){_classCallCheck(this,BaseShader);return _possibleConstructorReturn(this,(BaseShader.__proto__||Object.getPrototypeOf(BaseShader)).call(this));}return BaseShader;}(Resource);var RenderState2D=function(){function RenderState2D(){_classCallCheck(this,RenderState2D);}_createClass(RenderState2D,null,[{key:"mat2MatArray",value:function mat2MatArray(mat,matArray){var m=mat;var m4=matArray;m4[0]=m.a;m4[1]=m.b;m4[2]=RenderState2D.EMPTYMAT4_ARRAY[2];m4[3]=RenderState2D.EMPTYMAT4_ARRAY[3];m4[4]=m.c;m4[5]=m.d;m4[6]=RenderState2D.EMPTYMAT4_ARRAY[6];m4[7]=RenderState2D.EMPTYMAT4_ARRAY[7];m4[8]=RenderState2D.EMPTYMAT4_ARRAY[8];m4[9]=RenderState2D.EMPTYMAT4_ARRAY[9];m4[10]=RenderState2D.EMPTYMAT4_ARRAY[10];m4[11]=RenderState2D.EMPTYMAT4_ARRAY[11];m4[12]=m.tx;m4[13]=m.ty;m4[14]=RenderState2D.EMPTYMAT4_ARRAY[14];m4[15]=RenderState2D.EMPTYMAT4_ARRAY[15];return matArray;}},{key:"restoreTempArray",value:function restoreTempArray(){RenderState2D.TEMPMAT4_ARRAY[0]=1;RenderState2D.TEMPMAT4_ARRAY[1]=0;RenderState2D.TEMPMAT4_ARRAY[4]=0;RenderState2D.TEMPMAT4_ARRAY[5]=1;RenderState2D.TEMPMAT4_ARRAY[12]=0;RenderState2D.TEMPMAT4_ARRAY[13]=0;}},{key:"clear",value:function clear(){RenderState2D.worldScissorTest=false;RenderState2D.worldAlpha=1;}}]);return RenderState2D;}();RenderState2D._MAXSIZE=99999999;RenderState2D.EMPTYMAT4_ARRAY=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];RenderState2D.TEMPMAT4_ARRAY=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];RenderState2D.worldMatrix4=RenderState2D.TEMPMAT4_ARRAY;RenderState2D.worldMatrix=new Matrix();RenderState2D.matWVP=null;RenderState2D.worldAlpha=1.0;RenderState2D.worldScissorTest=false;RenderState2D.width=0;RenderState2D.height=0;(function(RenderTextureFormat){RenderTextureFormat[RenderTextureFormat["R8G8B8"]=0]="R8G8B8";RenderTextureFormat[RenderTextureFormat["R8G8B8A8"]=1]="R8G8B8A8";RenderTextureFormat[RenderTextureFormat["Alpha8"]=2]="Alpha8";RenderTextureFormat[RenderTextureFormat["R16G16B16A16"]=14]="R16G16B16A16";})(exports.RenderTextureFormat||(exports.RenderTextureFormat={}));(function(RenderTextureDepthFormat){RenderTextureDepthFormat[RenderTextureDepthFormat["DEPTH_16"]=0]="DEPTH_16";RenderTextureDepthFormat[RenderTextureDepthFormat["STENCIL_8"]=1]="STENCIL_8";RenderTextureDepthFormat[RenderTextureDepthFormat["DEPTHSTENCIL_16_8"]=2]="DEPTHSTENCIL_16_8";RenderTextureDepthFormat[RenderTextureDepthFormat["DEPTHSTENCIL_NONE"]=3]="DEPTHSTENCIL_NONE";})(exports.RenderTextureDepthFormat||(exports.RenderTextureDepthFormat={}));var RenderTexture2D=function(_BaseTexture2){_inherits(RenderTexture2D,_BaseTexture2);function RenderTexture2D(width,height){var format=arguments.length>2&&arguments[2]!==undefined?arguments[2]:exports.RenderTextureFormat.R8G8B8;var depthStencilFormat=arguments.length>3&&arguments[3]!==undefined?arguments[3]:exports.RenderTextureDepthFormat.DEPTH_16;_classCallCheck(this,RenderTexture2D);var _this8=_possibleConstructorReturn(this,(RenderTexture2D.__proto__||Object.getPrototypeOf(RenderTexture2D)).call(this,format,false));_this8._mgrKey=0;_this8._glTextureType=LayaGL.instance.TEXTURE_2D;_this8._width=width;_this8._height=height;_this8._depthStencilFormat=depthStencilFormat;_this8._create(width,height);_this8.lock=true;return _this8;}_createClass(RenderTexture2D,[{key:"getIsReady",value:function getIsReady(){return true;}},{key:"_create",value:function _create(width,height){var gl=LayaGL.instance;this._frameBuffer=gl.createFramebuffer();WebGLContext.bindTexture(gl,this._glTextureType,this._glTexture);var glFormat=this._getGLFormat();gl.texImage2D(this._glTextureType,0,glFormat,width,height,0,glFormat,gl.UNSIGNED_BYTE,null);this._setGPUMemory(width*height*4);gl.bindFramebuffer(gl.FRAMEBUFFER,this._frameBuffer);gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,this._glTexture,0);if(this._depthStencilFormat!==exports.RenderTextureDepthFormat.DEPTHSTENCIL_NONE){this._depthStencilBuffer=gl.createRenderbuffer();gl.bindRenderbuffer(gl.RENDERBUFFER,this._depthStencilBuffer);switch(this._depthStencilFormat){case exports.RenderTextureDepthFormat.DEPTH_16:gl.renderbufferStorage(gl.RENDERBUFFER,gl.DEPTH_COMPONENT16,width,height);gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.DEPTH_ATTACHMENT,gl.RENDERBUFFER,this._depthStencilBuffer);break;case exports.RenderTextureDepthFormat.STENCIL_8:gl.renderbufferStorage(gl.RENDERBUFFER,gl.STENCIL_INDEX8,width,height);gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.STENCIL_ATTACHMENT,gl.RENDERBUFFER,this._depthStencilBuffer);break;case exports.RenderTextureDepthFormat.DEPTHSTENCIL_16_8:gl.renderbufferStorage(gl.RENDERBUFFER,gl.DEPTH_STENCIL,width,height);gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.DEPTH_STENCIL_ATTACHMENT,gl.RENDERBUFFER,this._depthStencilBuffer);break;default:}}gl.bindFramebuffer(gl.FRAMEBUFFER,null);gl.bindRenderbuffer(gl.RENDERBUFFER,null);this._setWarpMode(gl.TEXTURE_WRAP_S,this._wrapModeU);this._setWarpMode(gl.TEXTURE_WRAP_T,this._wrapModeV);this._setFilterMode(this._filterMode);this._setAnisotropy(this._anisoLevel);this._readyed=true;this._activeResource();}},{key:"generateMipmap",value:function generateMipmap(){if(this._isPot(this.width)&&this._isPot(this.height)){this._mipmap=true;LayaGL.instance.generateMipmap(this._glTextureType);this._setFilterMode(this._filterMode);this._setGPUMemory(this.width*this.height*4*(1+1/3));}else{this._mipmap=false;this._setGPUMemory(this.width*this.height*4);}}},{key:"start",value:function start(){var gl=LayaGL.instance;LayaGL.instance.bindFramebuffer(gl.FRAMEBUFFER,this._frameBuffer);this._lastRT=RenderTexture2D._currentActive;RenderTexture2D._currentActive=this;this._readyed=true;gl.viewport(0,0,this._width,this._height);this._lastWidth=RenderState2D.width;this._lastHeight=RenderState2D.height;RenderState2D.width=this._width;RenderState2D.height=this._height;BaseShader.activeShader=null;}},{key:"end",value:function end(){var gl=LayaGL.instance;gl.bindFramebuffer(gl.FRAMEBUFFER,null);RenderTexture2D._currentActive=null;this._readyed=true;}},{key:"restore",value:function restore(){var gl=LayaGL.instance;if(this._lastRT!=RenderTexture2D._currentActive){LayaGL.instance.bindFramebuffer(gl.FRAMEBUFFER,this._lastRT?this._lastRT._frameBuffer:null);RenderTexture2D._currentActive=this._lastRT;}this._readyed=true;gl.viewport(0,0,this._lastWidth,this._lastHeight);RenderState2D.width=this._lastWidth;RenderState2D.height=this._lastHeight;BaseShader.activeShader=null;}},{key:"clear",value:function clear(){var r=arguments.length>0&&arguments[0]!==undefined?arguments[0]:0.0;var g=arguments.length>1&&arguments[1]!==undefined?arguments[1]:0.0;var b=arguments.length>2&&arguments[2]!==undefined?arguments[2]:0.0;var a=arguments.length>3&&arguments[3]!==undefined?arguments[3]:1.0;var gl=LayaGL.instance;gl.clearColor(r,g,b,a);var clearFlag=gl.COLOR_BUFFER_BIT;switch(this._depthStencilFormat){case gl.DEPTH_COMPONENT16:clearFlag|=gl.DEPTH_BUFFER_BIT;break;case gl.STENCIL_INDEX8:clearFlag|=gl.STENCIL_BUFFER_BIT;break;case gl.DEPTH_STENCIL:clearFlag|=gl.DEPTH_BUFFER_BIT;clearFlag|=gl.STENCIL_BUFFER_BIT;break;}gl.clear(clearFlag);}},{key:"getData",value:function getData(x,y,width,height){if(ILaya.Render.isConchApp&&window.conchConfig.threadMode==2){throw"native 2 thread mode use getDataAsync";}var gl=LayaGL.instance;gl.bindFramebuffer(gl.FRAMEBUFFER,this._frameBuffer);var canRead=gl.checkFramebufferStatus(gl.FRAMEBUFFER)===gl.FRAMEBUFFER_COMPLETE;if(!canRead){gl.bindFramebuffer(gl.FRAMEBUFFER,null);return null;}var pixels=new Uint8Array(this._width*this._height*4);var glFormat=this._getGLFormat();gl.readPixels(x,y,width,height,glFormat,gl.UNSIGNED_BYTE,pixels);gl.bindFramebuffer(gl.FRAMEBUFFER,null);return pixels;}},{key:"getDataAsync",value:function getDataAsync(x,y,width,height,callBack){var gl=LayaGL.instance;gl.bindFramebuffer(gl.FRAMEBUFFER,this._frameBuffer);gl.readPixelsAsync(x,y,width,height,gl.RGBA,gl.UNSIGNED_BYTE,function(data){callBack(new Uint8Array(data));});gl.bindFramebuffer(gl.FRAMEBUFFER,null);}},{key:"recycle",value:function recycle(){}},{key:"_disposeResource",value:function _disposeResource(){if(this._frameBuffer){var gl=LayaGL.instance;gl.deleteTexture(this._glTexture);gl.deleteFramebuffer(this._frameBuffer);gl.deleteRenderbuffer(this._depthStencilBuffer);this._glTexture=null;this._frameBuffer=null;this._depthStencilBuffer=null;this._setGPUMemory(0);}}},{key:"depthStencilFormat",get:function get(){return this._depthStencilFormat;}},{key:"defaulteTexture",get:function get(){return Texture2D.grayTexture;}},{key:"sourceWidth",get:function get(){return this._width;}},{key:"sourceHeight",get:function get(){return this._height;}},{key:"offsetX",get:function get(){return 0;}},{key:"offsetY",get:function get(){return 0;}}],[{key:"pushRT",value:function pushRT(){RenderTexture2D.rtStack.push({rt:RenderTexture2D._currentActive,w:RenderState2D.width,h:RenderState2D.height});}},{key:"popRT",value:function popRT(){var gl=LayaGL.instance;var top=RenderTexture2D.rtStack.pop();if(top){if(RenderTexture2D._currentActive!=top.rt){LayaGL.instance.bindFramebuffer(gl.FRAMEBUFFER,top.rt?top.rt._frameBuffer:null);RenderTexture2D._currentActive=top.rt;}gl.viewport(0,0,top.w,top.h);RenderState2D.width=top.w;RenderState2D.height=top.h;}}},{key:"currentActive",get:function get(){return RenderTexture2D._currentActive;}}]);return RenderTexture2D;}(BaseTexture);RenderTexture2D.rtStack=[];RenderTexture2D.defuv=[0,0,1,0,1,1,0,1];RenderTexture2D.flipyuv=[0,1,1,1,1,0,0,0];var WebGLRTMgr=function(){function WebGLRTMgr(){_classCallCheck(this,WebGLRTMgr);}_createClass(WebGLRTMgr,null,[{key:"getRT",value:function getRT(w,h){w=w|0;h=h|0;if(w>=10000){console.error('getRT error! w too big');}var ret;ret=new RenderTexture2D(w,h,exports.RenderTextureFormat.R8G8B8A8,-1);return ret;}},{key:"releaseRT",value:function releaseRT(rt){rt._disposeResource();return;}}]);return WebGLRTMgr;}();WebGLRTMgr.dict={};var BlendMode=function(){function BlendMode(){_classCallCheck(this,BlendMode);}_createClass(BlendMode,null,[{key:"_init_",value:function _init_(gl){BlendMode.fns=[BlendMode.BlendNormal,BlendMode.BlendAdd,BlendMode.BlendMultiply,BlendMode.BlendScreen,BlendMode.BlendOverlay,BlendMode.BlendLight,BlendMode.BlendMask,BlendMode.BlendDestinationOut];BlendMode.targetFns=[BlendMode.BlendNormalTarget,BlendMode.BlendAddTarget,BlendMode.BlendMultiplyTarget,BlendMode.BlendScreenTarget,BlendMode.BlendOverlayTarget,BlendMode.BlendLightTarget,BlendMode.BlendMask,BlendMode.BlendDestinationOut];}},{key:"BlendNormal",value:function BlendNormal(gl){WebGLContext.setBlendFunc(gl,gl.ONE,gl.ONE_MINUS_SRC_ALPHA);}},{key:"BlendAdd",value:function BlendAdd(gl){WebGLContext.setBlendFunc(gl,gl.ONE,gl.DST_ALPHA);}},{key:"BlendMultiply",value:function BlendMultiply(gl){WebGLContext.setBlendFunc(gl,gl.DST_COLOR,gl.ONE_MINUS_SRC_ALPHA);}},{key:"BlendScreen",value:function BlendScreen(gl){WebGLContext.setBlendFunc(gl,gl.ONE,gl.ONE);}},{key:"BlendOverlay",value:function BlendOverlay(gl){WebGLContext.setBlendFunc(gl,gl.ONE,gl.ONE_MINUS_SRC_COLOR);}},{key:"BlendLight",value:function BlendLight(gl){WebGLContext.setBlendFunc(gl,gl.ONE,gl.ONE);}},{key:"BlendNormalTarget",value:function BlendNormalTarget(gl){WebGLContext.setBlendFunc(gl,gl.ONE,gl.ONE_MINUS_SRC_ALPHA);}},{key:"BlendAddTarget",value:function BlendAddTarget(gl){WebGLContext.setBlendFunc(gl,gl.ONE,gl.DST_ALPHA);}},{key:"BlendMultiplyTarget",value:function BlendMultiplyTarget(gl){WebGLContext.setBlendFunc(gl,gl.DST_COLOR,gl.ONE_MINUS_SRC_ALPHA);}},{key:"BlendScreenTarget",value:function BlendScreenTarget(gl){WebGLContext.setBlendFunc(gl,gl.ONE,gl.ONE);}},{key:"BlendOverlayTarget",value:function BlendOverlayTarget(gl){WebGLContext.setBlendFunc(gl,gl.ONE,gl.ONE_MINUS_SRC_COLOR);}},{key:"BlendLightTarget",value:function BlendLightTarget(gl){WebGLContext.setBlendFunc(gl,gl.ONE,gl.ONE);}},{key:"BlendMask",value:function BlendMask(gl){WebGLContext.setBlendFunc(gl,gl.ZERO,gl.SRC_ALPHA);}},{key:"BlendDestinationOut",value:function BlendDestinationOut(gl){WebGLContext.setBlendFunc(gl,gl.ZERO,gl.ZERO);}}]);return BlendMode;}();BlendMode.activeBlendFunction=null;BlendMode.NAMES=["normal","add","multiply","screen","overlay","light","mask","destination-out"];BlendMode.TOINT={"normal":0,"add":1,"multiply":2,"screen":3,"overlay":4,"light":5,"mask":6,"destination-out":7,"lighter":1};BlendMode.NORMAL="normal";BlendMode.ADD="add";BlendMode.MULTIPLY="multiply";BlendMode.SCREEN="screen";BlendMode.OVERLAY="overlay";BlendMode.LIGHT="light";BlendMode.MASK="mask";BlendMode.DESTINATIONOUT="destination-out";BlendMode.LIGHTER="lighter";BlendMode.fns=[];BlendMode.targetFns=[];var ShaderDefinesBase=function(){function ShaderDefinesBase(name2int,int2name,int2nameMap){_classCallCheck(this,ShaderDefinesBase);this._value=0;this._name2int=name2int;this._int2name=int2name;this._int2nameMap=int2nameMap;}_createClass(ShaderDefinesBase,[{key:"add",value:function add(value){if(typeof value=='string'){this._value|=this._name2int[value];}else{this._value|=value;}return this._value;}},{key:"addInt",value:function addInt(value){this._value|=value;return this._value;}},{key:"remove",value:function remove(value){if(typeof value=='string'){this._value&=~this._name2int[value];}else{this._value&=~value;}return this._value;}},{key:"isDefine",value:function isDefine(def){return(this._value&def)===def;}},{key:"getValue",value:function getValue(){return this._value;}},{key:"setValue",value:function setValue(value){this._value=value;}},{key:"toNameDic",value:function toNameDic(){var r=this._int2nameMap[this._value];return r?r:ShaderDefinesBase._toText(this._value,this._int2name,this._int2nameMap);}}],[{key:"_reg",value:function _reg(name,value,_name2int,_int2name){_name2int[name]=value;_int2name[value]=name;}},{key:"_toText",value:function _toText(value,_int2name,_int2nameMap){var r=_int2nameMap[value];if(r)return r;var o={};var d=1;for(var i=0;i<32;i++){d=1<<i;if(d>value)break;if(value&d){var name=_int2name[d];name&&(o[name]="");}}_int2nameMap[value]=o;return o;}},{key:"_toInt",value:function _toInt(names,_name2int){var words=names.split('.');var num=0;for(var i=0,n=words.length;i<n;i++){var value=_name2int[words[i]];if(!value)throw new Error("Defines to int err:"+names+"/"+words[i]);num|=value;}return num;}}]);return ShaderDefinesBase;}();var ShaderDefines2D=function(_ShaderDefinesBase){_inherits(ShaderDefines2D,_ShaderDefinesBase);function ShaderDefines2D(){_classCallCheck(this,ShaderDefines2D);return _possibleConstructorReturn(this,(ShaderDefines2D.__proto__||Object.getPrototypeOf(ShaderDefines2D)).call(this,ShaderDefines2D.__name2int,ShaderDefines2D.__int2name,ShaderDefines2D.__int2nameMap));}_createClass(ShaderDefines2D,null,[{key:"__init__",value:function __init__(){ShaderDefines2D.reg("TEXTURE2D",ShaderDefines2D.TEXTURE2D);ShaderDefines2D.reg("PRIMITIVE",ShaderDefines2D.PRIMITIVE);ShaderDefines2D.reg("GLOW_FILTER",ShaderDefines2D.FILTERGLOW);ShaderDefines2D.reg("BLUR_FILTER",ShaderDefines2D.FILTERBLUR);ShaderDefines2D.reg("COLOR_FILTER",ShaderDefines2D.FILTERCOLOR);ShaderDefines2D.reg("COLOR_ADD",ShaderDefines2D.COLORADD);ShaderDefines2D.reg("WORLDMAT",ShaderDefines2D.WORLDMAT);ShaderDefines2D.reg("FILLTEXTURE",ShaderDefines2D.FILLTEXTURE);ShaderDefines2D.reg('MVP3D',ShaderDefines2D.MVP3D);}},{key:"reg",value:function reg(name,value){this._reg(name,value,ShaderDefines2D.__name2int,ShaderDefines2D.__int2name);}},{key:"toText",value:function toText(value,int2name,int2nameMap){return this._toText(value,int2name,int2nameMap);}},{key:"toInt",value:function toInt(names){return this._toInt(names,ShaderDefines2D.__name2int);}}]);return ShaderDefines2D;}(ShaderDefinesBase);ShaderDefines2D.TEXTURE2D=0x01;ShaderDefines2D.PRIMITIVE=0x04;ShaderDefines2D.FILTERGLOW=0x08;ShaderDefines2D.FILTERBLUR=0x10;ShaderDefines2D.FILTERCOLOR=0x20;ShaderDefines2D.COLORADD=0x40;ShaderDefines2D.WORLDMAT=0x80;ShaderDefines2D.FILLTEXTURE=0x100;ShaderDefines2D.SKINMESH=0x200;ShaderDefines2D.MVP3D=0x800;ShaderDefines2D.NOOPTMASK=ShaderDefines2D.FILTERGLOW|ShaderDefines2D.FILTERBLUR|ShaderDefines2D.FILTERCOLOR|ShaderDefines2D.FILLTEXTURE;ShaderDefines2D.__name2int={};ShaderDefines2D.__int2name=[];ShaderDefines2D.__int2nameMap=[];var Stat=function(){function Stat(){_classCallCheck(this,Stat);}_createClass(Stat,null,[{key:"show",value:function show(){var x=arguments.length>0&&arguments[0]!==undefined?arguments[0]:0;var y=arguments.length>1&&arguments[1]!==undefined?arguments[1]:0;Stat._StatRender.show(x,y);}},{key:"enable",value:function enable(){Stat._StatRender.enable();}},{key:"hide",value:function hide(){Stat._StatRender.hide();}},{key:"clear",value:function clear(){Stat.trianglesFaces=Stat.renderBatches=Stat.savedRenderBatches=Stat.shaderCall=Stat.spriteRenderUseCacheCount=Stat.frustumCulling=Stat.octreeNodeCulling=Stat.canvasNormal=Stat.canvasBitmap=Stat.canvasReCache=0;}},{key:"onclick",set:function set(fn){Stat._StatRender.set_onclick(fn);}}]);return Stat;}();Stat.FPS=0;Stat.loopCount=0;Stat.shaderCall=0;Stat.renderBatches=0;Stat.savedRenderBatches=0;Stat.trianglesFaces=0;Stat.spriteCount=0;Stat.spriteRenderUseCacheCount=0;Stat.frustumCulling=0;Stat.octreeNodeCulling=0;Stat.canvasNormal=0;Stat.canvasBitmap=0;Stat.canvasReCache=0;Stat.renderSlow=false;Stat._fpsData=[];Stat._timer=0;Stat._count=0;Stat._StatRender=null;var StringKey=function(){function StringKey(){_classCallCheck(this,StringKey);this._strsToID={};this._idToStrs=[];this._length=0;}_createClass(StringKey,[{key:"add",value:function add(str){var index=this._strsToID[str];if(index!=null)return index;this._idToStrs[this._length]=str;return this._strsToID[str]=this._length++;}},{key:"getID",value:function getID(str){var index=this._strsToID[str];return index==null?-1:index;}},{key:"getName",value:function getName(id){var str=this._idToStrs[id];return str==null?undefined:str;}}]);return StringKey;}();var Shader=function(_BaseShader){_inherits(Shader,_BaseShader);function Shader(vs,ps){var saveName=arguments.length>2&&arguments[2]!==undefined?arguments[2]:null;var nameMap=arguments.length>3&&arguments[3]!==undefined?arguments[3]:null;var bindAttrib=arguments.length>4&&arguments[4]!==undefined?arguments[4]:null;_classCallCheck(this,Shader);var _this10=_possibleConstructorReturn(this,(Shader.__proto__||Object.getPrototypeOf(Shader)).call(this));_this10._attribInfo=null;_this10.customCompile=false;_this10._curActTexIndex=0;_this10.tag={};_this10._program=null;_this10._params=null;_this10._paramsMap={};if(!vs||!ps)throw"Shader Error";_this10._attribInfo=bindAttrib;_this10._id=++Shader._count;_this10._vs=vs;_this10._ps=ps;_this10._nameMap=nameMap?nameMap:{};saveName!=null&&(Shader.sharders[saveName]=_this10);_this10.recreateResource();_this10.lock=true;return _this10;}_createClass(Shader,[{key:"recreateResource",value:function recreateResource(){this._compile();this._setGPUMemory(0);}},{key:"_disposeResource",value:function _disposeResource(){WebGLContext.mainContext.deleteShader(this._vshader);WebGLContext.mainContext.deleteShader(this._pshader);WebGLContext.mainContext.deleteProgram(this._program);this._vshader=this._pshader=this._program=null;this._params=null;this._paramsMap={};this._setGPUMemory(0);this._curActTexIndex=0;}},{key:"_compile",value:function _compile(){if(!this._vs||!this._ps||this._params)return;this._reCompile=true;this._params=[];var result;if(this.customCompile)result=ILaya.ShaderCompile.preGetParams(this._vs,this._ps);var gl=WebGLContext.mainContext;this._program=gl.createProgram();this._vshader=Shader._createShader(gl,this._vs,gl.VERTEX_SHADER);this._pshader=Shader._createShader(gl,this._ps,gl.FRAGMENT_SHADER);gl.attachShader(this._program,this._vshader);gl.attachShader(this._program,this._pshader);var one,i,n,location;var attribDescNum=this._attribInfo?this._attribInfo.length:0;for(i=0;i<attribDescNum;i+=2){gl.bindAttribLocation(this._program,this._attribInfo[i+1],this._attribInfo[i]);}gl.linkProgram(this._program);if(!this.customCompile&&!gl.getProgramParameter(this._program,gl.LINK_STATUS)){throw gl.getProgramInfoLog(this._program);}var nUniformNum=this.customCompile?result.uniforms.length:gl.getProgramParameter(this._program,gl.ACTIVE_UNIFORMS);for(i=0;i<nUniformNum;i++){var uniform=this.customCompile?result.uniforms[i]:gl.getActiveUniform(this._program,i);location=gl.getUniformLocation(this._program,uniform.name);one={vartype:"uniform",glfun:null,ivartype:1,location:location,name:uniform.name,type:uniform.type,isArray:false,isSame:false,preValue:null,indexOfParams:0};if(one.name.indexOf('[0]')>0){one.name=one.name.substr(0,one.name.length-3);one.isArray=true;one.location=gl.getUniformLocation(this._program,one.name);}this._params.push(one);}for(i=0,n=this._params.length;i<n;i++){one=this._params[i];one.indexOfParams=i;one.index=1;one.value=[one.location,null];one.codename=one.name;one.name=this._nameMap[one.codename]?this._nameMap[one.codename]:one.codename;this._paramsMap[one.name]=one;one._this=this;one.uploadedValue=[];switch(one.type){case gl.INT:one.fun=one.isArray?this._uniform1iv:this._uniform1i;break;case gl.FLOAT:one.fun=one.isArray?this._uniform1fv:this._uniform1f;break;case gl.FLOAT_VEC2:one.fun=one.isArray?this._uniform_vec2v:this._uniform_vec2;break;case gl.FLOAT_VEC3:one.fun=one.isArray?this._uniform_vec3v:this._uniform_vec3;break;case gl.FLOAT_VEC4:one.fun=one.isArray?this._uniform_vec4v:this._uniform_vec4;break;case gl.SAMPLER_2D:one.fun=this._uniform_sampler2D;break;case gl.SAMPLER_CUBE:one.fun=this._uniform_samplerCube;break;case gl.FLOAT_MAT4:one.glfun=gl.uniformMatrix4fv;one.fun=this._uniformMatrix4fv;break;case gl.BOOL:one.fun=this._uniform1i;break;case gl.FLOAT_MAT2:case gl.FLOAT_MAT3:throw new Error("compile shader err!");default:throw new Error("compile shader err!");}}}},{key:"getUniform",value:function getUniform(name){return this._paramsMap[name];}},{key:"_uniform1f",value:function _uniform1f(one,value){var uploadedValue=one.uploadedValue;if(uploadedValue[0]!==value){WebGLContext.mainContext.uniform1f(one.location,uploadedValue[0]=value);return 1;}return 0;}},{key:"_uniform1fv",value:function _uniform1fv(one,value){if(value.length<4){var uploadedValue=one.uploadedValue;if(uploadedValue[0]!==value[0]||uploadedValue[1]!==value[1]||uploadedValue[2]!==value[2]||uploadedValue[3]!==value[3]){WebGLContext.mainContext.uniform1fv(one.location,value);uploadedValue[0]=value[0];uploadedValue[1]=value[1];uploadedValue[2]=value[2];uploadedValue[3]=value[3];return 1;}return 0;}else{WebGLContext.mainContext.uniform1fv(one.location,value);return 1;}}},{key:"_uniform_vec2",value:function _uniform_vec2(one,value){var uploadedValue=one.uploadedValue;if(uploadedValue[0]!==value[0]||uploadedValue[1]!==value[1]){WebGLContext.mainContext.uniform2f(one.location,uploadedValue[0]=value[0],uploadedValue[1]=value[1]);return 1;}return 0;}},{key:"_uniform_vec2v",value:function _uniform_vec2v(one,value){if(value.length<2){var uploadedValue=one.uploadedValue;if(uploadedValue[0]!==value[0]||uploadedValue[1]!==value[1]||uploadedValue[2]!==value[2]||uploadedValue[3]!==value[3]){WebGLContext.mainContext.uniform2fv(one.location,value);uploadedValue[0]=value[0];uploadedValue[1]=value[1];uploadedValue[2]=value[2];uploadedValue[3]=value[3];return 1;}return 0;}else{WebGLContext.mainContext.uniform2fv(one.location,value);return 1;}}},{key:"_uniform_vec3",value:function _uniform_vec3(one,value){var uploadedValue=one.uploadedValue;if(uploadedValue[0]!==value[0]||uploadedValue[1]!==value[1]||uploadedValue[2]!==value[2]){WebGLContext.mainContext.uniform3f(one.location,uploadedValue[0]=value[0],uploadedValue[1]=value[1],uploadedValue[2]=value[2]);return 1;}return 0;}},{key:"_uniform_vec3v",value:function _uniform_vec3v(one,value){WebGLContext.mainContext.uniform3fv(one.location,value);return 1;}},{key:"_uniform_vec4",value:function _uniform_vec4(one,value){var uploadedValue=one.uploadedValue;if(uploadedValue[0]!==value[0]||uploadedValue[1]!==value[1]||uploadedValue[2]!==value[2]||uploadedValue[3]!==value[3]){WebGLContext.mainContext.uniform4f(one.location,uploadedValue[0]=value[0],uploadedValue[1]=value[1],uploadedValue[2]=value[2],uploadedValue[3]=value[3]);return 1;}return 0;}},{key:"_uniform_vec4v",value:function _uniform_vec4v(one,value){WebGLContext.mainContext.uniform4fv(one.location,value);return 1;}},{key:"_uniformMatrix2fv",value:function _uniformMatrix2fv(one,value){WebGLContext.mainContext.uniformMatrix2fv(one.location,false,value);return 1;}},{key:"_uniformMatrix3fv",value:function _uniformMatrix3fv(one,value){WebGLContext.mainContext.uniformMatrix3fv(one.location,false,value);return 1;}},{key:"_uniformMatrix4fv",value:function _uniformMatrix4fv(one,value){WebGLContext.mainContext.uniformMatrix4fv(one.location,false,value);return 1;}},{key:"_uniform1i",value:function _uniform1i(one,value){var uploadedValue=one.uploadedValue;if(uploadedValue[0]!==value){WebGLContext.mainContext.uniform1i(one.location,uploadedValue[0]=value);return 1;}return 0;}},{key:"_uniform1iv",value:function _uniform1iv(one,value){WebGLContext.mainContext.uniform1iv(one.location,value);return 1;}},{key:"_uniform_ivec2",value:function _uniform_ivec2(one,value){var uploadedValue=one.uploadedValue;if(uploadedValue[0]!==value[0]||uploadedValue[1]!==value[1]){WebGLContext.mainContext.uniform2i(one.location,uploadedValue[0]=value[0],uploadedValue[1]=value[1]);return 1;}return 0;}},{key:"_uniform_ivec2v",value:function _uniform_ivec2v(one,value){WebGLContext.mainContext.uniform2iv(one.location,value);return 1;}},{key:"_uniform_vec3i",value:function _uniform_vec3i(one,value){var uploadedValue=one.uploadedValue;if(uploadedValue[0]!==value[0]||uploadedValue[1]!==value[1]||uploadedValue[2]!==value[2]){WebGLContext.mainContext.uniform3i(one.location,uploadedValue[0]=value[0],uploadedValue[1]=value[1],uploadedValue[2]=value[2]);return 1;}return 0;}},{key:"_uniform_vec3vi",value:function _uniform_vec3vi(one,value){WebGLContext.mainContext.uniform3iv(one.location,value);return 1;}},{key:"_uniform_vec4i",value:function _uniform_vec4i(one,value){var uploadedValue=one.uploadedValue;if(uploadedValue[0]!==value[0]||uploadedValue[1]!==value[1]||uploadedValue[2]!==value[2]||uploadedValue[3]!==value[3]){WebGLContext.mainContext.uniform4i(one.location,uploadedValue[0]=value[0],uploadedValue[1]=value[1],uploadedValue[2]=value[2],uploadedValue[3]=value[3]);return 1;}return 0;}},{key:"_uniform_vec4vi",value:function _uniform_vec4vi(one,value){WebGLContext.mainContext.uniform4iv(one.location,value);return 1;}},{key:"_uniform_sampler2D",value:function _uniform_sampler2D(one,value){var gl=WebGLContext.mainContext;var uploadedValue=one.uploadedValue;if(uploadedValue[0]==null){uploadedValue[0]=this._curActTexIndex;gl.uniform1i(one.location,this._curActTexIndex);WebGLContext.activeTexture(gl,gl.TEXTURE0+this._curActTexIndex);WebGLContext.bindTexture(gl,gl.TEXTURE_2D,value);this._curActTexIndex++;return 1;}else{WebGLContext.activeTexture(gl,gl.TEXTURE0+uploadedValue[0]);WebGLContext.bindTexture(gl,gl.TEXTURE_2D,value);return 0;}}},{key:"_uniform_samplerCube",value:function _uniform_samplerCube(one,value){var gl=WebGLContext.mainContext;var uploadedValue=one.uploadedValue;if(uploadedValue[0]==null){uploadedValue[0]=this._curActTexIndex;gl.uniform1i(one.location,this._curActTexIndex);WebGLContext.activeTexture(gl,gl.TEXTURE0+this._curActTexIndex);WebGLContext.bindTexture(gl,gl.TEXTURE_CUBE_MAP,value);this._curActTexIndex++;return 1;}else{WebGLContext.activeTexture(gl,gl.TEXTURE0+uploadedValue[0]);WebGLContext.bindTexture(gl,gl.TEXTURE_CUBE_MAP,value);return 0;}}},{key:"_noSetValue",value:function _noSetValue(one){console.log("no....:"+one.name);}},{key:"uploadOne",value:function uploadOne(name,value){WebGLContext.useProgram(WebGLContext.mainContext,this._program);var one=this._paramsMap[name];one.fun.call(this,one,value);}},{key:"uploadTexture2D",value:function uploadTexture2D(value){var CTX=WebGLContext;if(CTX._activeTextures[0]!==value){CTX.bindTexture(WebGLContext.mainContext,LayaGL.instance.TEXTURE_2D,value);CTX._activeTextures[0]=value;}}},{key:"upload",value:function upload(shaderValue){var params=arguments.length>1&&arguments[1]!==undefined?arguments[1]:null;BaseShader.activeShader=BaseShader.bindShader=this;var gl=WebGLContext.mainContext;WebGLContext.useProgram(gl,this._program);if(this._reCompile){params=this._params;this._reCompile=false;}else{params=params||this._params;}var one,value,n=params.length,shaderCall=0;for(var i=0;i<n;i++){one=params[i];if((value=shaderValue[one.name])!==null)shaderCall+=one.fun.call(this,one,value);}Stat.shaderCall+=shaderCall;}},{key:"uploadArray",value:function uploadArray(shaderValue,length,_bufferUsage){BaseShader.activeShader=this;BaseShader.bindShader=this;WebGLContext.useProgram(WebGLContext.mainContext,this._program);var params=this._params,value;var one,shaderCall=0;for(var i=length-2;i>=0;i-=2){one=this._paramsMap[shaderValue[i]];if(!one)continue;value=shaderValue[i+1];if(value!=null){_bufferUsage&&_bufferUsage[one.name]&&_bufferUsage[one.name].bind();shaderCall+=one.fun.call(this,one,value);}}Stat.shaderCall+=shaderCall;}},{key:"getParams",value:function getParams(){return this._params;}},{key:"setAttributesLocation",value:function setAttributesLocation(attribDesc){this._attribInfo=attribDesc;}}],[{key:"getShader",value:function getShader(name){return Shader.sharders[name];}},{key:"create",value:function create(vs,ps){var saveName=arguments.length>2&&arguments[2]!==undefined?arguments[2]:null;var nameMap=arguments.length>3&&arguments[3]!==undefined?arguments[3]:null;var bindAttrib=arguments.length>4&&arguments[4]!==undefined?arguments[4]:null;return new Shader(vs,ps,saveName,nameMap,bindAttrib);}},{key:"withCompile",value:function withCompile(nameID,define,shaderName,createShader){if(shaderName&&Shader.sharders[shaderName])return Shader.sharders[shaderName];var pre=Shader._preCompileShader[Shader.SHADERNAME2ID*nameID];if(!pre)throw new Error("withCompile shader err!"+nameID);return pre.createShader(define,shaderName,createShader,null);}},{key:"withCompile2D",value:function withCompile2D(nameID,mainID,define,shaderName,createShader){var bindAttrib=arguments.length>5&&arguments[5]!==undefined?arguments[5]:null;if(shaderName&&Shader.sharders[shaderName])return Shader.sharders[shaderName];var pre=Shader._preCompileShader[Shader.SHADERNAME2ID*nameID+mainID];if(!pre)throw new Error("withCompile shader err!"+nameID+" "+mainID);return pre.createShader(define,shaderName,createShader,bindAttrib);}},{key:"addInclude",value:function addInclude(fileName,txt){ILaya.ShaderCompile.addInclude(fileName,txt);}},{key:"preCompile",value:function preCompile(nameID,vs,ps,nameMap){var id=Shader.SHADERNAME2ID*nameID;Shader._preCompileShader[id]=new ILaya.ShaderCompile(vs,ps,nameMap);}},{key:"preCompile2D",value:function preCompile2D(nameID,mainID,vs,ps,nameMap){var id=Shader.SHADERNAME2ID*nameID+mainID;Shader._preCompileShader[id]=new ILaya.ShaderCompile(vs,ps,nameMap);}},{key:"_createShader",value:function _createShader(gl,str,type){var shader=gl.createShader(type);gl.shaderSource(shader,str);gl.compileShader(shader);if(gl.getShaderParameter(shader,gl.COMPILE_STATUS)){return shader;}else{console.log(gl.getShaderInfoLog(shader));return null;}}}]);return Shader;}(BaseShader);Shader._count=0;Shader._preCompileShader={};Shader.SHADERNAME2ID=0.0002;Shader.nameKey=new StringKey();Shader.sharders=new Array(0x20);var Shader2X=function(_Shader){_inherits(Shader2X,_Shader);function Shader2X(vs,ps){var saveName=arguments.length>2&&arguments[2]!==undefined?arguments[2]:null;var nameMap=arguments.length>3&&arguments[3]!==undefined?arguments[3]:null;var bindAttrib=arguments.length>4&&arguments[4]!==undefined?arguments[4]:null;_classCallCheck(this,Shader2X);var _this11=_possibleConstructorReturn(this,(Shader2X.__proto__||Object.getPrototypeOf(Shader2X)).call(this,vs,ps,saveName,nameMap,bindAttrib));_this11._params2dQuick2=null;_this11._shaderValueWidth=0;_this11._shaderValueHeight=0;return _this11;}_createClass(Shader2X,[{key:"_disposeResource",value:function _disposeResource(){_get(Shader2X.prototype.__proto__||Object.getPrototypeOf(Shader2X.prototype),"_disposeResource",this).call(this);this._params2dQuick2=null;}},{key:"upload2dQuick2",value:function upload2dQuick2(shaderValue){this.upload(shaderValue,this._params2dQuick2||this._make2dQuick2());}},{key:"_make2dQuick2",value:function _make2dQuick2(){if(!this._params2dQuick2){this._params2dQuick2=[];var params=this._params,one;for(var i=0,n=params.length;i<n;i++){one=params[i];if(one.name!=="size")this._params2dQuick2.push(one);}}return this._params2dQuick2;}}],[{key:"create",value:function create(vs,ps){var saveName=arguments.length>2&&arguments[2]!==undefined?arguments[2]:null;var nameMap=arguments.length>3&&arguments[3]!==undefined?arguments[3]:null;var bindAttrib=arguments.length>4&&arguments[4]!==undefined?arguments[4]:null;return new Shader2X(vs,ps,saveName,nameMap,bindAttrib);}}]);return Shader2X;}(Shader);var Value2D=function(){function Value2D(mainID,subID){_classCallCheck(this,Value2D);this.defines=new ShaderDefines2D();this.size=[0,0];this.alpha=1.0;this.ALPHA=1.0;this.subID=0;this.ref=1;this._cacheID=0;this.clipMatDir=[ILaya.Context._MAXSIZE,0,0,ILaya.Context._MAXSIZE];this.clipMatPos=[0,0];this.clipOff=[0,0];this.mainID=mainID;this.subID=subID;this.textureHost=null;this.texture=null;this.color=null;this.colorAdd=null;this.u_mmat2=null;this._cacheID=mainID|subID;this._inClassCache=Value2D._cache[this._cacheID];if(mainID>0&&!this._inClassCache){this._inClassCache=Value2D._cache[this._cacheID]=[];this._inClassCache._length=0;}this.clear();}_createClass(Value2D,[{key:"setValue",value:function setValue(value){}},{key:"_ShaderWithCompile",value:function _ShaderWithCompile(){var ret=Shader.withCompile2D(0,this.mainID,this.defines.toNameDic(),this.mainID|this.defines._value,Shader2X.create,this._attribLocation);return ret;}},{key:"upload",value:function upload(){var renderstate2d=RenderState2D;RenderState2D.worldMatrix4===RenderState2D.TEMPMAT4_ARRAY||this.defines.addInt(ShaderDefines2D.WORLDMAT);this.mmat=renderstate2d.worldMatrix4;if(RenderState2D.matWVP){this.defines.addInt(ShaderDefines2D.MVP3D);this.u_MvpMatrix=RenderState2D.matWVP.elements;}var sd=Shader.sharders[this.mainID|this.defines._value]||this._ShaderWithCompile();if(sd._shaderValueWidth!==renderstate2d.width||sd._shaderValueHeight!==renderstate2d.height){this.size[0]=renderstate2d.width;this.size[1]=renderstate2d.height;sd._shaderValueWidth=renderstate2d.width;sd._shaderValueHeight=renderstate2d.height;sd.upload(this,null);}else{sd.upload(this,sd._params2dQuick2||sd._make2dQuick2());}}},{key:"setFilters",value:function setFilters(value){this.filters=value;if(!value)return;var n=value.length,f;for(var i=0;i<n;i++){f=value[i];if(f){this.defines.add(f.type);f.action.setValue(this);}}}},{key:"clear",value:function clear(){this.defines._value=this.subID;this.clipOff[0]=0;}},{key:"release",value:function release(){if(--this.ref<1){this._inClassCache&&(this._inClassCache[this._inClassCache._length++]=this);this.clear();this.filters=null;this.ref=1;this.clipOff[0]=0;}}}],[{key:"_initone",value:function _initone(type,classT){Value2D._typeClass[type]=classT;Value2D._cache[type]=[];Value2D._cache[type]._length=0;}},{key:"__init__",value:function __init__(){}},{key:"create",value:function create(mainType,subType){var types=Value2D._cache[mainType|subType];if(types._length)return types[--types._length];else return new Value2D._typeClass[mainType|subType](subType);}}]);return Value2D;}();Value2D._cache=[];Value2D._typeClass=[];Value2D.TEMPMAT4_ARRAY=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];var SubmitKey=function(){function SubmitKey(){_classCallCheck(this,SubmitKey);this.clear();}_createClass(SubmitKey,[{key:"clear",value:function clear(){this.submitType=-1;this.blendShader=this.other=0;}},{key:"copyFrom",value:function copyFrom(src){this.other=src.other;this.blendShader=src.blendShader;this.submitType=src.submitType;}},{key:"copyFrom2",value:function copyFrom2(src,submitType,other){this.other=other;this.submitType=submitType;}},{key:"equal3_2",value:function equal3_2(next,submitType,other){return this.submitType===submitType&&this.other===other&&this.blendShader===next.blendShader;}},{key:"equal4_2",value:function equal4_2(next,submitType,other){return this.submitType===submitType&&this.other===other&&this.blendShader===next.blendShader;}},{key:"equal_3",value:function equal_3(next){return this.submitType===next.submitType&&this.blendShader===next.blendShader;}},{key:"equal",value:function equal(next){return this.other===next.other&&this.submitType===next.submitType&&this.blendShader===next.blendShader;}}]);return SubmitKey;}();var SubmitCMD=function(){function SubmitCMD(){_classCallCheck(this,SubmitCMD);this._ref=1;this._key=new SubmitKey();}_createClass(SubmitCMD,[{key:"renderSubmit",value:function renderSubmit(){this.fun.apply(this._this,this.args);return 1;}},{key:"getRenderType",value:function getRenderType(){return 0;}},{key:"releaseRender",value:function releaseRender(){if(--this._ref<1){var pool=SubmitCMD.POOL;pool[pool._length++]=this;}}}],[{key:"create",value:function create(args,fun,thisobj){var o=SubmitCMD.POOL._length?SubmitCMD.POOL[--SubmitCMD.POOL._length]:new SubmitCMD();o.fun=fun;o.args=args;o._this=thisobj;o._ref=1;o._key.clear();return o;}}]);return SubmitCMD;}();SubmitCMD.POOL=[];{SubmitCMD.POOL._length=0;}var Filter=function(){function Filter(){_classCallCheck(this,Filter);}_createClass(Filter,[{key:"type",get:function get(){return-1;}}]);return Filter;}();Filter.BLUR=0x10;Filter.COLOR=0x20;Filter.GLOW=0x08;Filter._filter=function(sprite,context,x,y){var webglctx=context;var next=this._next;if(next){var filters=sprite.filters,len=filters.length;if(len==1&&filters[0].type==Filter.COLOR){context.save();context.setColorFilter(filters[0]);next._fun.call(next,sprite,context,x,y);context.restore();return;}var svCP=Value2D.create(ShaderDefines2D.TEXTURE2D,0);var b;var p=Point.TEMP;var tMatrix=webglctx._curMat;var mat=Matrix.create();tMatrix.copyTo(mat);var tPadding=0;var tHalfPadding=0;var tIsHaveGlowFilter=false;var source=null;var out=sprite._cacheStyle.filterCache||null;if(!out||sprite.getRepaint()!=0){tIsHaveGlowFilter=sprite._isHaveGlowFilter();if(tIsHaveGlowFilter){tPadding=50;tHalfPadding=25;}b=new Rectangle();b.copyFrom(sprite.getSelfBounds());b.x+=sprite.x;b.y+=sprite.y;b.x-=sprite.pivotX+4;b.y-=sprite.pivotY+4;var tSX=b.x;var tSY=b.y;b.width+=tPadding+8;b.height+=tPadding+8;p.x=b.x*mat.a+b.y*mat.c;p.y=b.y*mat.d+b.x*mat.b;b.x=p.x;b.y=p.y;p.x=b.width*mat.a+b.height*mat.c;p.y=b.height*mat.d+b.width*mat.b;b.width=p.x;b.height=p.y;if(b.width<=0||b.height<=0){return;}out&&WebGLRTMgr.releaseRT(out);source=WebGLRTMgr.getRT(b.width,b.height);var outRT=out=WebGLRTMgr.getRT(b.width,b.height);sprite._getCacheStyle().filterCache=out;webglctx.pushRT();webglctx.useRT(source);var tX=sprite.x-tSX+tHalfPadding;var tY=sprite.y-tSY+tHalfPadding;next._fun.call(next,sprite,context,tX,tY);webglctx.useRT(outRT);for(var i=0;i<len;i++){if(i!=0){webglctx.useRT(source);webglctx.drawTarget(outRT,0,0,b.width,b.height,Matrix.TEMP.identity(),svCP,null,BlendMode.TOINT.overlay);webglctx.useRT(outRT);}var fil=filters[i];switch(fil.type){case Filter.BLUR:fil._glRender&&fil._glRender.render(source,context,b.width,b.height,fil);break;case Filter.GLOW:fil._glRender&&fil._glRender.render(source,context,b.width,b.height,fil);break;case Filter.COLOR:webglctx.setColorFilter(fil);webglctx.drawTarget(source,0,0,b.width,b.height,Matrix.EMPTY.identity(),Value2D.create(ShaderDefines2D.TEXTURE2D,0));webglctx.setColorFilter(null);break;}}webglctx.popRT();}else{tIsHaveGlowFilter=sprite._cacheStyle.hasGlowFilter||false;if(tIsHaveGlowFilter){tPadding=50;tHalfPadding=25;}b=sprite.getBounds();if(b.width<=0||b.height<=0){return;}b.width+=tPadding;b.height+=tPadding;p.x=b.x*mat.a+b.y*mat.c;p.y=b.y*mat.d+b.x*mat.b;b.x=p.x;b.y=p.y;p.x=b.width*mat.a+b.height*mat.c;p.y=b.height*mat.d+b.width*mat.b;b.width=p.x;b.height=p.y;}x=x-tHalfPadding-sprite.x;y=y-tHalfPadding-sprite.y;p.setTo(x,y);mat.transformPoint(p);x=p.x+b.x;y=p.y+b.y;webglctx._drawRenderTexture(out,x,y,b.width,b.height,Matrix.TEMP.identity(),1.0,RenderTexture2D.defuv);if(source){var submit=SubmitCMD.create([source],function(s){s.destroy();},this);source=null;context.addRenderObject(submit);}mat.destroy();}};var Utils=function(){function Utils(){_classCallCheck(this,Utils);}_createClass(Utils,null,[{key:"toRadian",value:function toRadian(angle){return angle*Utils._pi2;}},{key:"toAngle",value:function toAngle(radian){return radian*Utils._pi;}},{key:"toHexColor",value:function toHexColor(color){if(color<0||isNaN(color))return null;var str=color.toString(16);while(str.length<6){str="0"+str;}return"#"+str;}},{key:"getGID",value:function getGID(){return Utils._gid++;}},{key:"concatArray",value:function concatArray(source,array){if(!array)return source;if(!source)return array;var i,len=array.length;for(i=0;i<len;i++){source.push(array[i]);}return source;}},{key:"clearArray",value:function clearArray(array){if(!array)return array;array.length=0;return array;}},{key:"copyArray",value:function copyArray(source,array){source||(source=[]);if(!array)return source;source.length=array.length;var i,len=array.length;for(i=0;i<len;i++){source[i]=array[i];}return source;}},{key:"getGlobalRecByPoints",value:function getGlobalRecByPoints(sprite,x0,y0,x1,y1){var newLTPoint;newLTPoint=Point.create().setTo(x0,y0);newLTPoint=sprite.localToGlobal(newLTPoint);var newRBPoint;newRBPoint=Point.create().setTo(x1,y1);newRBPoint=sprite.localToGlobal(newRBPoint);var rst=Rectangle._getWrapRec([newLTPoint.x,newLTPoint.y,newRBPoint.x,newRBPoint.y]);newLTPoint.recover();newRBPoint.recover();return rst;}},{key:"getGlobalPosAndScale",value:function getGlobalPosAndScale(sprite){return Utils.getGlobalRecByPoints(sprite,0,0,1,1);}},{key:"bind",value:function bind(fun,scope){var rst=fun;rst=fun.bind(scope);return rst;}},{key:"updateOrder",value:function updateOrder(array){if(!array||array.length<2)return false;var i=1,j,len=array.length,key,c;while(i<len){j=i;c=array[j];key=array[j]._zOrder;while(--j>-1){if(array[j]._zOrder>key)array[j+1]=array[j];else break;}array[j+1]=c;i++;}return true;}},{key:"transPointList",value:function transPointList(points,x,y){var i,len=points.length;for(i=0;i<len;i+=2){points[i]+=x;points[i+1]+=y;}}},{key:"parseInt",value:function(_parseInt){function parseInt(_x70){return _parseInt.apply(this,arguments);}parseInt.toString=function(){return _parseInt.toString();};return parseInt;}(function(str){var radix=arguments.length>1&&arguments[1]!==undefined?arguments[1]:0;var result=parseInt(str,radix);if(isNaN(result))return 0;return result;})},{key:"getFileExtension",value:function getFileExtension(path){Utils._extReg.lastIndex=path.lastIndexOf(".");var result=Utils._extReg.exec(path);if(result&&result.length>1){return result[1].toLowerCase();}return null;}},{key:"getTransformRelativeToWindow",value:function getTransformRelativeToWindow(coordinateSpace,x,y){var stage=Utils.gStage;var globalTransform=Utils.getGlobalPosAndScale(coordinateSpace);var canvasMatrix=stage._canvasTransform.clone();var canvasLeft=canvasMatrix.tx;var canvasTop=canvasMatrix.ty;canvasMatrix.rotate(-Math.PI/180*stage.canvasDegree);canvasMatrix.scale(stage.clientScaleX,stage.clientScaleY);var perpendicular=stage.canvasDegree%180!=0;var tx,ty;if(perpendicular){tx=y+globalTransform.y;ty=x+globalTransform.x;tx*=canvasMatrix.d;ty*=canvasMatrix.a;if(stage.canvasDegree==90){tx=canvasLeft-tx;ty+=canvasTop;}else{tx+=canvasLeft;ty=canvasTop-ty;}}else{tx=x+globalTransform.x;ty=y+globalTransform.y;tx*=canvasMatrix.a;ty*=canvasMatrix.d;tx+=canvasLeft;ty+=canvasTop;}ty+=stage['_safariOffsetY'];var domScaleX,domScaleY;if(perpendicular){domScaleX=canvasMatrix.d*globalTransform.height;domScaleY=canvasMatrix.a*globalTransform.width;}else{domScaleX=canvasMatrix.a*globalTransform.width;domScaleY=canvasMatrix.d*globalTransform.height;}return{x:tx,y:ty,scaleX:domScaleX,scaleY:domScaleY};}},{key:"fitDOMElementInArea",value:function fitDOMElementInArea(dom,coordinateSpace,x,y,width,height){if(!dom._fitLayaAirInitialized){dom._fitLayaAirInitialized=true;dom.style.transformOrigin=dom.style.webKittransformOrigin="left top";dom.style.position="absolute";}var transform=Utils.getTransformRelativeToWindow(coordinateSpace,x,y);dom.style.transform=dom.style.webkitTransform="scale("+transform.scaleX+","+transform.scaleY+") rotate("+Utils.gStage.canvasDegree+"deg)";dom.style.width=width+'px';dom.style.height=height+'px';dom.style.left=transform.x+'px';dom.style.top=transform.y+'px';}},{key:"isOkTextureList",value:function isOkTextureList(textureList){if(!textureList)return false;var i,len=textureList.length;var tTexture;for(i=0;i<len;i++){tTexture=textureList[i];if(!tTexture||!tTexture._getSource())return false;}return true;}},{key:"isOKCmdList",value:function isOKCmdList(cmds){if(!cmds)return false;var i,len=cmds.length;var cmd;for(i=0;i<len;i++){cmd=cmds[i];}return true;}},{key:"getQueryString",value:function getQueryString(name){if(ILaya.Browser.onMiniGame)return null;if(!window.location||!window.location.search)return null;var reg=new RegExp("(^|&)"+name+"=([^&]*)(&|$)");var r=window.location.search.substr(1).match(reg);if(r!=null)return unescape(r[2]);return null;}}]);return Utils;}();Utils.gStage=null;Utils._gid=1;Utils._pi=180/Math.PI;Utils._pi2=Math.PI/180;Utils._extReg=/\.(\w+)\??/g;Utils.parseXMLFromString=function(value){var rst;value=value.replace(/>\s+</g,'><');rst=new DOMParser().parseFromString(value,'text/xml');if(rst.firstChild.textContent.indexOf("This page contains the following errors")>-1){throw new Error(rst.firstChild.firstChild.textContent);}return rst;};var ColorUtils=function(){function ColorUtils(value){_classCallCheck(this,ColorUtils);this.arrColor=[];if(value==null){this.strColor="#00000000";this.numColor=0;this.arrColor=[0,0,0,0];return;}var i,len;var color;if(typeof value=='string'){if(value.indexOf("rgba(")>=0||value.indexOf("rgb(")>=0){var tStr=value;var beginI,endI;beginI=tStr.indexOf("(");endI=tStr.indexOf(")");tStr=tStr.substring(beginI+1,endI);this.arrColor=tStr.split(",");len=this.arrColor.length;for(i=0;i<len;i++){this.arrColor[i]=parseFloat(this.arrColor[i]);if(i<3){this.arrColor[i]=Math.round(this.arrColor[i]);}}if(this.arrColor.length==4){color=((this.arrColor[0]*256+this.arrColor[1])*256+this.arrColor[2])*256+Math.round(this.arrColor[3]*255);}else{color=(this.arrColor[0]*256+this.arrColor[1])*256+this.arrColor[2];}this.strColor=value;}else{this.strColor=value;value.charAt(0)==='#'&&(value=value.substr(1));len=value.length;if(len===3||len===4){var temp="";for(i=0;i<len;i++){temp+=value[i]+value[i];}value=temp;}color=parseInt(value,16);}}else{color=value;this.strColor=Utils.toHexColor(color);}if(this.strColor.indexOf("rgba")>=0||this.strColor.length===9){this.arrColor=[((0xFF000000&color)>>>24)/255,((0xFF0000&color)>>16)/255,((0xFF00&color)>>8)/255,(0xFF&color)/255];this.numColor=(0xff000000&color)>>>24|(color&0xff0000)>>8|(color&0x00ff00)<<8|(color&0xff)<<24;}else{this.arrColor=[((0xFF0000&color)>>16)/255,((0xFF00&color)>>8)/255,(0xFF&color)/255,1];this.numColor=0xff000000|(color&0xff0000)>>16|color&0x00ff00|(color&0xff)<<16;}this.arrColor.__id=++ColorUtils._COLODID;}_createClass(ColorUtils,null,[{key:"_initDefault",value:function _initDefault(){ColorUtils._DEFAULT={};for(var i in ColorUtils._COLOR_MAP){ColorUtils._SAVE[i]=ColorUtils._DEFAULT[i]=new ColorUtils(ColorUtils._COLOR_MAP[i]);}return ColorUtils._DEFAULT;}},{key:"_initSaveMap",value:function _initSaveMap(){ColorUtils._SAVE_SIZE=0;ColorUtils._SAVE={};for(var i in ColorUtils._DEFAULT){ColorUtils._SAVE[i]=ColorUtils._DEFAULT[i];}}},{key:"create",value:function create(value){var key=value+"";var color=ColorUtils._SAVE[key];if(color!=null)return color;if(ColorUtils._SAVE_SIZE<1000)ColorUtils._initSaveMap();return ColorUtils._SAVE[key]=new ColorUtils(value);}}]);return ColorUtils;}();ColorUtils._SAVE={};ColorUtils._SAVE_SIZE=0;ColorUtils._COLOR_MAP={"purple":"#800080","orange":"#ffa500","white":'#FFFFFF',"red":'#FF0000',"green":'#00FF00',"blue":'#0000FF',"black":'#000000',"yellow":'#FFFF00','gray':'#808080'};ColorUtils._DEFAULT=ColorUtils._initDefault();ColorUtils._COLODID=1;var ColorFilter=function(_Filter){_inherits(ColorFilter,_Filter);function ColorFilter(){var mat=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;_classCallCheck(this,ColorFilter);var _this12=_possibleConstructorReturn(this,(ColorFilter.__proto__||Object.getPrototypeOf(ColorFilter)).call(this));if(!mat)mat=_this12._copyMatrix(ColorFilter.IDENTITY_MATRIX);_this12._mat=new Float32Array(16);_this12._alpha=new Float32Array(4);_this12.setByMatrix(mat);return _this12;}_createClass(ColorFilter,[{key:"gray",value:function gray(){return this.setByMatrix(ColorFilter.GRAY_MATRIX);}},{key:"color",value:function color(){var red=arguments.length>0&&arguments[0]!==undefined?arguments[0]:0;var green=arguments.length>1&&arguments[1]!==undefined?arguments[1]:0;var blue=arguments.length>2&&arguments[2]!==undefined?arguments[2]:0;var alpha=arguments.length>3&&arguments[3]!==undefined?arguments[3]:1;return this.setByMatrix([1,0,0,0,red,0,1,0,0,green,0,0,1,0,blue,0,0,0,1,alpha]);}},{key:"setColor",value:function setColor(color){var arr=ColorUtils.create(color).arrColor;var mt=[0,0,0,0,256*arr[0],0,0,0,0,256*arr[1],0,0,0,0,256*arr[2],0,0,0,1,0];return this.setByMatrix(mt);}},{key:"setByMatrix",value:function setByMatrix(matrix){if(this._matrix!=matrix)this._copyMatrix(matrix);var j=0;var z=0;for(var i=0;i<20;i++){if(i%5!=4){this._mat[j++]=matrix[i];}else{this._alpha[z++]=matrix[i];}}return this;}},{key:"adjustColor",value:function adjustColor(brightness,contrast,saturation,hue){this.adjustHue(hue);this.adjustContrast(contrast);this.adjustBrightness(brightness);this.adjustSaturation(saturation);return this;}},{key:"adjustBrightness",value:function adjustBrightness(brightness){brightness=this._clampValue(brightness,100);if(brightness==0||isNaN(brightness))return this;return this._multiplyMatrix([1,0,0,0,brightness,0,1,0,0,brightness,0,0,1,0,brightness,0,0,0,1,0,0,0,0,0,1]);}},{key:"adjustContrast",value:function adjustContrast(contrast){contrast=this._clampValue(contrast,100);if(contrast==0||isNaN(contrast))return this;var x;if(contrast<0){x=127+contrast/100*127;}else{x=contrast%1;if(x==0){x=ColorFilter.DELTA_INDEX[contrast];}else{x=ColorFilter.DELTA_INDEX[contrast<<0]*(1-x)+ColorFilter.DELTA_INDEX[(contrast<<0)+1]*x;}x=x*127+127;}var x1=x/127;var x2=(127-x)*0.5;return this._multiplyMatrix([x1,0,0,0,x2,0,x1,0,0,x2,0,0,x1,0,x2,0,0,0,1,0,0,0,0,0,1]);}},{key:"adjustSaturation",value:function adjustSaturation(saturation){saturation=this._clampValue(saturation,100);if(saturation==0||isNaN(saturation))return this;var x=1+(saturation>0?3*saturation/100:saturation/100);var dx=1-x;var r=0.3086*dx;var g=0.6094*dx;var b=0.0820*dx;return this._multiplyMatrix([r+x,g,b,0,0,r,g+x,b,0,0,r,g,b+x,0,0,0,0,0,1,0,0,0,0,0,1]);}},{key:"adjustHue",value:function adjustHue(hue){hue=this._clampValue(hue,180)/180*Math.PI;if(hue==0||isNaN(hue))return this;var cos=Math.cos(hue);var sin=Math.sin(hue);var r=0.213;var g=0.715;var b=0.072;return this._multiplyMatrix([r+cos*(1-r)+sin*-r,g+cos*-g+sin*-g,b+cos*-b+sin*(1-b),0,0,r+cos*-r+sin*0.143,g+cos*(1-g)+sin*0.140,b+cos*-b+sin*-0.283,0,0,r+cos*-r+sin*-(1-r),g+cos*-g+sin*g,b+cos*(1-b)+sin*b,0,0,0,0,0,1,0,0,0,0,0,1]);}},{key:"reset",value:function reset(){return this.setByMatrix(this._copyMatrix(ColorFilter.IDENTITY_MATRIX));}},{key:"_multiplyMatrix",value:function _multiplyMatrix(matrix){var col=[];this._matrix=this._fixMatrix(this._matrix);for(var i=0;i<5;i++){for(var j=0;j<5;j++){col[j]=this._matrix[j+i*5];}for(j=0;j<5;j++){var val=0;for(var k=0;k<5;k++){val+=matrix[j+k*5]*col[k];}this._matrix[j+i*5]=val;}}return this.setByMatrix(this._matrix);}},{key:"_clampValue",value:function _clampValue(val,limit){return Math.min(limit,Math.max(-limit,val));}},{key:"_fixMatrix",value:function _fixMatrix(){var matrix=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;if(matrix==null)return ColorFilter.IDENTITY_MATRIX;if(matrix.length<ColorFilter.LENGTH)matrix=matrix.slice(0,matrix.length).concat(ColorFilter.IDENTITY_MATRIX.slice(matrix.length,ColorFilter.LENGTH));else if(matrix.length>ColorFilter.LENGTH)matrix=matrix.slice(0,ColorFilter.LENGTH);return matrix;}},{key:"_copyMatrix",value:function _copyMatrix(matrix){var len=ColorFilter.LENGTH;if(!this._matrix)this._matrix=[];for(var i=0;i<len;i++){this._matrix[i]=matrix[i];}return this._matrix;}},{key:"type",get:function get(){return Filter.COLOR;}}]);return ColorFilter;}(Filter);ColorFilter.DELTA_INDEX=[0,0.01,0.02,0.04,0.05,0.06,0.07,0.08,0.1,0.11,0.12,0.14,0.15,0.16,0.17,0.18,0.20,0.21,0.22,0.24,0.25,0.27,0.28,0.30,0.32,0.34,0.36,0.38,0.40,0.42,0.44,0.46,0.48,0.5,0.53,0.56,0.59,0.62,0.65,0.68,0.71,0.74,0.77,0.80,0.83,0.86,0.89,0.92,0.95,0.98,1.0,1.06,1.12,1.18,1.24,1.30,1.36,1.42,1.48,1.54,1.60,1.66,1.72,1.78,1.84,1.90,1.96,2.0,2.12,2.25,2.37,2.50,2.62,2.75,2.87,3.0,3.2,3.4,3.6,3.8,4.0,4.3,4.7,4.9,5.0,5.5,6.0,6.5,6.8,7.0,7.3,7.5,7.8,8.0,8.4,8.7,9.0,9.4,9.6,9.8,10.0];ColorFilter.GRAY_MATRIX=[0.3086,0.6094,0.082,0,0,0.3086,0.6094,0.082,0,0,0.3086,0.6094,0.082,0,0,0,0,0,1,0];ColorFilter.IDENTITY_MATRIX=[1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1];ColorFilter.LENGTH=25;var DrawTextureCmd=function(){function DrawTextureCmd(){_classCallCheck(this,DrawTextureCmd);this.colorFlt=null;this.uv=null;}_createClass(DrawTextureCmd,[{key:"recover",value:function recover(){this.texture&&this.texture._removeReference();this.texture=null;this.matrix=null;Pool.recover("DrawTextureCmd",this);}},{key:"run",value:function run(context,gx,gy){this.texture&&context.drawTextureWithTransform(this.texture,this.x,this.y,this.width,this.height,this.matrix,gx,gy,this.alpha,this.blendMode,this.colorFlt,this.uv);}},{key:"cmdID",get:function get(){return DrawTextureCmd.ID;}}],[{key:"create",value:function create(texture,x,y,width,height,matrix,alpha,color,blendMode,uv){var cmd=Pool.getItemByClass("DrawTextureCmd",DrawTextureCmd);cmd.texture=texture;texture._addReference();cmd.x=x;cmd.y=y;cmd.width=width;cmd.height=height;cmd.matrix=matrix;cmd.alpha=alpha;cmd.color=color;cmd.blendMode=blendMode;cmd.uv=uv==undefined?null:uv;if(color){cmd.colorFlt=new ColorFilter();cmd.colorFlt.setColor(color);}return cmd;}}]);return DrawTextureCmd;}();DrawTextureCmd.ID="DrawTexture";var FillTextureCmd=function(){function FillTextureCmd(){_classCallCheck(this,FillTextureCmd);}_createClass(FillTextureCmd,[{key:"recover",value:function recover(){this.texture=null;this.offset=null;this.other=null;Pool.recover("FillTextureCmd",this);}},{key:"run",value:function run(context,gx,gy){context.fillTexture(this.texture,this.x+gx,this.y+gy,this.width,this.height,this.type,this.offset,this.other);}},{key:"cmdID",get:function get(){return FillTextureCmd.ID;}}],[{key:"create",value:function create(texture,x,y,width,height,type,offset,other){var cmd=Pool.getItemByClass("FillTextureCmd",FillTextureCmd);cmd.texture=texture;cmd.x=x;cmd.y=y;cmd.width=width;cmd.height=height;cmd.type=type;cmd.offset=offset;cmd.other=other;return cmd;}}]);return FillTextureCmd;}();FillTextureCmd.ID="FillTexture";var RestoreCmd=function(){function RestoreCmd(){_classCallCheck(this,RestoreCmd);}_createClass(RestoreCmd,[{key:"recover",value:function recover(){Pool.recover("RestoreCmd",this);}},{key:"run",value:function run(context,gx,gy){context.restore();}},{key:"cmdID",get:function get(){return RestoreCmd.ID;}}],[{key:"create",value:function create(){var cmd=Pool.getItemByClass("RestoreCmd",RestoreCmd);return cmd;}}]);return RestoreCmd;}();RestoreCmd.ID="Restore";var RotateCmd=function(){function RotateCmd(){_classCallCheck(this,RotateCmd);}_createClass(RotateCmd,[{key:"recover",value:function recover(){Pool.recover("RotateCmd",this);}},{key:"run",value:function run(context,gx,gy){context._rotate(this.angle,this.pivotX+gx,this.pivotY+gy);}},{key:"cmdID",get:function get(){return RotateCmd.ID;}}],[{key:"create",value:function create(angle,pivotX,pivotY){var cmd=Pool.getItemByClass("RotateCmd",RotateCmd);cmd.angle=angle;cmd.pivotX=pivotX;cmd.pivotY=pivotY;return cmd;}}]);return RotateCmd;}();RotateCmd.ID="Rotate";var ScaleCmd=function(){function ScaleCmd(){_classCallCheck(this,ScaleCmd);}_createClass(ScaleCmd,[{key:"recover",value:function recover(){Pool.recover("ScaleCmd",this);}},{key:"run",value:function run(context,gx,gy){context._scale(this.scaleX,this.scaleY,this.pivotX+gx,this.pivotY+gy);}},{key:"cmdID",get:function get(){return ScaleCmd.ID;}}],[{key:"create",value:function create(scaleX,scaleY,pivotX,pivotY){var cmd=Pool.getItemByClass("ScaleCmd",ScaleCmd);cmd.scaleX=scaleX;cmd.scaleY=scaleY;cmd.pivotX=pivotX;cmd.pivotY=pivotY;return cmd;}}]);return ScaleCmd;}();ScaleCmd.ID="Scale";var TransformCmd=function(){function TransformCmd(){_classCallCheck(this,TransformCmd);}_createClass(TransformCmd,[{key:"recover",value:function recover(){this.matrix=null;Pool.recover("TransformCmd",this);}},{key:"run",value:function run(context,gx,gy){context._transform(this.matrix,this.pivotX+gx,this.pivotY+gy);}},{key:"cmdID",get:function get(){return TransformCmd.ID;}}],[{key:"create",value:function create(matrix,pivotX,pivotY){var cmd=Pool.getItemByClass("TransformCmd",TransformCmd);cmd.matrix=matrix;cmd.pivotX=pivotX;cmd.pivotY=pivotY;return cmd;}}]);return TransformCmd;}();TransformCmd.ID="Transform";var TranslateCmd=function(){function TranslateCmd(){_classCallCheck(this,TranslateCmd);}_createClass(TranslateCmd,[{key:"recover",value:function recover(){Pool.recover("TranslateCmd",this);}},{key:"run",value:function run(context,gx,gy){context.translate(this.tx,this.ty);}},{key:"cmdID",get:function get(){return TranslateCmd.ID;}}],[{key:"create",value:function create(tx,ty){var cmd=Pool.getItemByClass("TranslateCmd",TranslateCmd);cmd.tx=tx;cmd.ty=ty;return cmd;}}]);return TranslateCmd;}();TranslateCmd.ID="Translate";var Bezier=function(){function Bezier(){_classCallCheck(this,Bezier);this._controlPoints=[new Point(),new Point(),new Point()];this._calFun=this.getPoint2;}_createClass(Bezier,[{key:"_switchPoint",value:function _switchPoint(x,y){var tPoint=this._controlPoints.shift();tPoint.setTo(x,y);this._controlPoints.push(tPoint);}},{key:"getPoint2",value:function getPoint2(t,rst){var p1=this._controlPoints[0];var p2=this._controlPoints[1];var p3=this._controlPoints[2];var lineX=Math.pow(1-t,2)*p1.x+2*t*(1-t)*p2.x+Math.pow(t,2)*p3.x;var lineY=Math.pow(1-t,2)*p1.y+2*t*(1-t)*p2.y+Math.pow(t,2)*p3.y;rst.push(lineX,lineY);}},{key:"getPoint3",value:function getPoint3(t,rst){var p1=this._controlPoints[0];var p2=this._controlPoints[1];var p3=this._controlPoints[2];var p4=this._controlPoints[3];var lineX=Math.pow(1-t,3)*p1.x+3*p2.x*t*(1-t)*(1-t)+3*p3.x*t*t*(1-t)+p4.x*Math.pow(t,3);var lineY=Math.pow(1-t,3)*p1.y+3*p2.y*t*(1-t)*(1-t)+3*p3.y*t*t*(1-t)+p4.y*Math.pow(t,3);rst.push(lineX,lineY);}},{key:"insertPoints",value:function insertPoints(count,rst){var i;count=count>0?count:5;var dLen;dLen=1/count;for(i=0;i<=1;i+=dLen){this._calFun(i,rst);}}},{key:"getBezierPoints",value:function getBezierPoints(pList){var inSertCount=arguments.length>1&&arguments[1]!==undefined?arguments[1]:5;var count=arguments.length>2&&arguments[2]!==undefined?arguments[2]:2;var i,len;len=pList.length;if(len<(count+1)*2)return[];var rst=[];switch(count){case 2:this._calFun=this.getPoint2;break;case 3:this._calFun=this.getPoint3;break;default:return[];}while(this._controlPoints.length<=count){this._controlPoints.push(Point.create());}for(i=0;i<count*2;i+=2){this._switchPoint(pList[i],pList[i+1]);}for(i=count*2;i<len;i+=2){this._switchPoint(pList[i],pList[i+1]);if(i/2%count==0)this.insertPoints(inSertCount,rst);}return rst;}}]);return Bezier;}();Bezier.I=new Bezier();var GrahamScan=function(){function GrahamScan(){_classCallCheck(this,GrahamScan);}_createClass(GrahamScan,null,[{key:"multiply",value:function multiply(p1,p2,p0){return(p1.x-p0.x)*(p2.y-p0.y)-(p2.x-p0.x)*(p1.y-p0.y);}},{key:"dis",value:function dis(p1,p2){return(p1.x-p2.x)*(p1.x-p2.x)+(p1.y-p2.y)*(p1.y-p2.y);}},{key:"_getPoints",value:function _getPoints(count){var tempUse=arguments.length>1&&arguments[1]!==undefined?arguments[1]:false;var rst=arguments.length>2&&arguments[2]!==undefined?arguments[2]:null;if(!GrahamScan._mPointList)GrahamScan._mPointList=[];while(GrahamScan._mPointList.length<count){GrahamScan._mPointList.push(new Point());}if(!rst)rst=[];rst.length=0;if(tempUse){GrahamScan.getFrom(rst,GrahamScan._mPointList,count);}else{GrahamScan.getFromR(rst,GrahamScan._mPointList,count);}return rst;}},{key:"getFrom",value:function getFrom(rst,src,count){var i;for(i=0;i<count;i++){rst.push(src[i]);}return rst;}},{key:"getFromR",value:function getFromR(rst,src,count){var i;for(i=0;i<count;i++){rst.push(src.pop());}return rst;}},{key:"pListToPointList",value:function pListToPointList(pList){var tempUse=arguments.length>1&&arguments[1]!==undefined?arguments[1]:false;var i,len=pList.length/2,rst=GrahamScan._getPoints(len,tempUse,GrahamScan._tempPointList);for(i=0;i<len;i++){rst[i].setTo(pList[i+i],pList[i+i+1]);}return rst;}},{key:"pointListToPlist",value:function pointListToPlist(pointList){var i,len=pointList.length,rst=GrahamScan._temPList,tPoint;rst.length=0;for(i=0;i<len;i++){tPoint=pointList[i];rst.push(tPoint.x,tPoint.y);}return rst;}},{key:"scanPList",value:function scanPList(pList){return Utils.copyArray(pList,GrahamScan.pointListToPlist(GrahamScan.scan(GrahamScan.pListToPointList(pList,true))));}},{key:"scan",value:function scan(PointSet){var i,j,k=0,tmp,n=PointSet.length,ch;var _tmpDic={};var key;ch=GrahamScan._temArr;ch.length=0;n=PointSet.length;for(i=n-1;i>=0;i--){tmp=PointSet[i];key=tmp.x+"_"+tmp.y;if(!(key in _tmpDic)){_tmpDic[key]=true;ch.push(tmp);}}n=ch.length;Utils.copyArray(PointSet,ch);for(i=1;i<n;i++){if(PointSet[i].y<PointSet[k].y||PointSet[i].y==PointSet[k].y&&PointSet[i].x<PointSet[k].x)k=i;}tmp=PointSet[0];PointSet[0]=PointSet[k];PointSet[k]=tmp;for(i=1;i<n-1;i++){k=i;for(j=i+1;j<n;j++){if(GrahamScan.multiply(PointSet[j],PointSet[k],PointSet[0])>0||GrahamScan.multiply(PointSet[j],PointSet[k],PointSet[0])==0&&GrahamScan.dis(PointSet[0],PointSet[j])<GrahamScan.dis(PointSet[0],PointSet[k]))k=j;}tmp=PointSet[i];PointSet[i]=PointSet[k];PointSet[k]=tmp;}ch=GrahamScan._temArr;ch.length=0;if(PointSet.length<3){return Utils.copyArray(ch,PointSet);}ch.push(PointSet[0],PointSet[1],PointSet[2]);for(i=3;i<n;i++){while(ch.length>=2&&GrahamScan.multiply(PointSet[i],ch[ch.length-1],ch[ch.length-2])>=0){ch.pop();}PointSet[i]&&ch.push(PointSet[i]);}return ch;}}]);return GrahamScan;}();GrahamScan._tempPointList=[];GrahamScan._temPList=[];GrahamScan._temArr=[];var DrawStyle=function(){function DrawStyle(value){_classCallCheck(this,DrawStyle);this.setValue(value);}_createClass(DrawStyle,[{key:"setValue",value:function setValue(value){if(value){this._color=value instanceof ColorUtils?value:ColorUtils.create(value);}else this._color=ColorUtils.create("#000000");}},{key:"reset",value:function reset(){this._color=ColorUtils.create("#000000");}},{key:"toInt",value:function toInt(){return this._color.numColor;}},{key:"equal",value:function equal(value){if(typeof value=='string')return this._color.strColor===value;if(value instanceof ColorUtils)return this._color.numColor===value.numColor;return false;}},{key:"toColorStr",value:function toColorStr(){return this._color.strColor;}}],[{key:"create",value:function create(value){if(value){var color=value instanceof ColorUtils?value:ColorUtils.create(value);return color._drawStyle||(color._drawStyle=new DrawStyle(value));}return DrawStyle.DEFAULT;}}]);return DrawStyle;}();DrawStyle.DEFAULT=new DrawStyle("#000000");var Path=function(){function Path(){_classCallCheck(this,Path);this._lastOriX=0;this._lastOriY=0;this.paths=[];this._curPath=null;}_createClass(Path,[{key:"beginPath",value:function beginPath(convex){this.paths.length=1;this._curPath=this.paths[0]=new renderPath();this._curPath.convex=convex;}},{key:"closePath",value:function closePath(){this._curPath.loop=true;}},{key:"newPath",value:function newPath(){this._curPath=new renderPath();this.paths.push(this._curPath);}},{key:"addPoint",value:function addPoint(pointX,pointY){this._curPath.path.push(pointX,pointY);}},{key:"push",value:function push(points,convex){if(!this._curPath){this._curPath=new renderPath();this.paths.push(this._curPath);}else if(this._curPath.path.length>0){this._curPath=new renderPath();this.paths.push(this._curPath);}var rp=this._curPath;rp.path=points.slice();rp.convex=convex;}},{key:"reset",value:function reset(){this.paths.length=0;}}]);return Path;}();var renderPath=function renderPath(){_classCallCheck(this,renderPath);this.path=[];this.loop=false;this.convex=false;};var SubmitBase=function(){function SubmitBase(){var renderType=arguments.length>0&&arguments[0]!==undefined?arguments[0]:SubmitBase.TYPE_2D;_classCallCheck(this,SubmitBase);this.clipInfoID=-1;this._mesh=null;this._blendFn=null;this._id=0;this._renderType=0;this._parent=null;this._key=new SubmitKey();this._startIdx=0;this._numEle=0;this._ref=1;this.shaderValue=null;this._renderType=renderType;this._id=++SubmitBase.ID;}_createClass(SubmitBase,[{key:"getID",value:function getID(){return this._id;}},{key:"getRenderType",value:function getRenderType(){return this._renderType;}},{key:"toString",value:function toString(){return"ibindex:"+this._startIdx+" num:"+this._numEle+" key="+this._key;}},{key:"renderSubmit",value:function renderSubmit(){return 1;}},{key:"releaseRender",value:function releaseRender(){}}],[{key:"__init__",value:function __init__(){var s=SubmitBase.RENDERBASE=new SubmitBase(-1);s.shaderValue=new Value2D(0,0);s.shaderValue.ALPHA=1;s._ref=0xFFFFFFFF;}}]);return SubmitBase;}();SubmitBase.TYPE_2D=10000;SubmitBase.TYPE_CANVAS=10003;SubmitBase.TYPE_CMDSETRT=10004;SubmitBase.TYPE_CUSTOM=10005;SubmitBase.TYPE_BLURRT=10006;SubmitBase.TYPE_CMDDESTORYPRERT=10007;SubmitBase.TYPE_DISABLESTENCIL=10008;SubmitBase.TYPE_OTHERIBVB=10009;SubmitBase.TYPE_PRIMITIVE=10010;SubmitBase.TYPE_RT=10011;SubmitBase.TYPE_BLUR_RT=10012;SubmitBase.TYPE_TARGET=10013;SubmitBase.TYPE_CHANGE_VALUE=10014;SubmitBase.TYPE_SHAPE=10015;SubmitBase.TYPE_TEXTURE=10016;SubmitBase.TYPE_FILLTEXTURE=10017;SubmitBase.KEY_ONCE=-1;SubmitBase.KEY_FILLRECT=1;SubmitBase.KEY_DRAWTEXTURE=2;SubmitBase.KEY_VG=3;SubmitBase.KEY_TRIANGLES=4;SubmitBase.ID=1;SubmitBase.preRender=null;var SaveBase=function(){function SaveBase(){_classCallCheck(this,SaveBase);}_createClass(SaveBase,[{key:"isSaveMark",value:function isSaveMark(){return false;}},{key:"restore",value:function restore(context){this._dataObj[this._valueName]=this._value;SaveBase.POOL[SaveBase.POOL._length++]=this;this._newSubmit&&(context._curSubmit=SubmitBase.RENDERBASE);}}],[{key:"_createArray",value:function _createArray(){var value=[];value._length=0;return value;}},{key:"_init",value:function _init(){var namemap=SaveBase._namemap={};namemap[SaveBase.TYPE_ALPHA]="ALPHA";namemap[SaveBase.TYPE_FILESTYLE]="fillStyle";namemap[SaveBase.TYPE_FONT]="font";namemap[SaveBase.TYPE_LINEWIDTH]="lineWidth";namemap[SaveBase.TYPE_STROKESTYLE]="strokeStyle";namemap[SaveBase.TYPE_ENABLEMERGE]="_mergeID";namemap[SaveBase.TYPE_MARK]=namemap[SaveBase.TYPE_TRANSFORM]=namemap[SaveBase.TYPE_TRANSLATE]=[];namemap[SaveBase.TYPE_TEXTBASELINE]="textBaseline";namemap[SaveBase.TYPE_TEXTALIGN]="textAlign";namemap[SaveBase.TYPE_GLOBALCOMPOSITEOPERATION]="_nBlendType";namemap[SaveBase.TYPE_SHADER]="shader";namemap[SaveBase.TYPE_FILTERS]="filters";namemap[SaveBase.TYPE_COLORFILTER]='_colorFiler';return namemap;}},{key:"save",value:function save(context,type,dataObj,newSubmit){if((context._saveMark._saveuse&type)!==type){context._saveMark._saveuse|=type;var cache=SaveBase.POOL;var o=cache._length>0?cache[--cache._length]:new SaveBase();o._value=dataObj[o._valueName=SaveBase._namemap[type]];o._dataObj=dataObj;o._newSubmit=newSubmit;var _save=context._save;_save[_save._length++]=o;}}}]);return SaveBase;}();SaveBase.TYPE_ALPHA=0x1;SaveBase.TYPE_FILESTYLE=0x2;SaveBase.TYPE_FONT=0x8;SaveBase.TYPE_LINEWIDTH=0x100;SaveBase.TYPE_STROKESTYLE=0x200;SaveBase.TYPE_MARK=0x400;SaveBase.TYPE_TRANSFORM=0x800;SaveBase.TYPE_TRANSLATE=0x1000;SaveBase.TYPE_ENABLEMERGE=0x2000;SaveBase.TYPE_TEXTBASELINE=0x4000;SaveBase.TYPE_TEXTALIGN=0x8000;SaveBase.TYPE_GLOBALCOMPOSITEOPERATION=0x10000;SaveBase.TYPE_CLIPRECT=0x20000;SaveBase.TYPE_CLIPRECT_STENCIL=0x40000;SaveBase.TYPE_IBVB=0x80000;SaveBase.TYPE_SHADER=0x100000;SaveBase.TYPE_FILTERS=0x200000;SaveBase.TYPE_FILTERS_TYPE=0x400000;SaveBase.TYPE_COLORFILTER=0x800000;SaveBase.POOL=SaveBase._createArray();SaveBase._namemap=SaveBase._init();var SaveClipRect=function(){function SaveClipRect(){_classCallCheck(this,SaveClipRect);this._globalClipMatrix=new Matrix();this._clipInfoID=-1;this._clipRect=new Rectangle();this.incache=false;}_createClass(SaveClipRect,[{key:"isSaveMark",value:function isSaveMark(){return false;}},{key:"restore",value:function restore(context){this._globalClipMatrix.copyTo(context._globalClipMatrix);this._clipRect.clone(context._clipRect);context._clipInfoID=this._clipInfoID;SaveClipRect.POOL[SaveClipRect.POOL._length++]=this;context._clipInCache=this.incache;}}],[{key:"save",value:function save(context){if((context._saveMark._saveuse&SaveBase.TYPE_CLIPRECT)==SaveBase.TYPE_CLIPRECT)return;context._saveMark._saveuse|=SaveBase.TYPE_CLIPRECT;var cache=SaveClipRect.POOL;var o=cache._length>0?cache[--cache._length]:new SaveClipRect();context._globalClipMatrix.copyTo(o._globalClipMatrix);context._clipRect.clone(o._clipRect);o._clipInfoID=context._clipInfoID;o.incache=context._clipInCache;var _save=context._save;_save[_save._length++]=o;}}]);return SaveClipRect;}();SaveClipRect.POOL=SaveBase._createArray();var SaveMark=function(){function SaveMark(){_classCallCheck(this,SaveMark);this._saveuse=0;}_createClass(SaveMark,[{key:"isSaveMark",value:function isSaveMark(){return true;}},{key:"restore",value:function restore(context){context._saveMark=this._preSaveMark;SaveMark.POOL[SaveMark.POOL._length++]=this;}}],[{key:"Create",value:function Create(context){var no=SaveMark.POOL;var o=no._length>0?no[--no._length]:new SaveMark();o._saveuse=0;o._preSaveMark=context._saveMark;context._saveMark=o;return o;}}]);return SaveMark;}();SaveMark.POOL=SaveBase._createArray();var SaveTransform=function(){function SaveTransform(){_classCallCheck(this,SaveTransform);this._matrix=new Matrix();}_createClass(SaveTransform,[{key:"isSaveMark",value:function isSaveMark(){return false;}},{key:"restore",value:function restore(context){context._curMat=this._savematrix;SaveTransform.POOL[SaveTransform.POOL._length++]=this;}}],[{key:"save",value:function save(context){var _saveMark=context._saveMark;if((_saveMark._saveuse&SaveBase.TYPE_TRANSFORM)===SaveBase.TYPE_TRANSFORM)return;_saveMark._saveuse|=SaveBase.TYPE_TRANSFORM;var no=SaveTransform.POOL;var o=no._length>0?no[--no._length]:new SaveTransform();o._savematrix=context._curMat;context._curMat=context._curMat.copyTo(o._matrix);var _save=context._save;_save[_save._length++]=o;}}]);return SaveTransform;}();SaveTransform.POOL=SaveBase._createArray();var SaveTranslate=function(){function SaveTranslate(){_classCallCheck(this,SaveTranslate);this._mat=new Matrix();}_createClass(SaveTranslate,[{key:"isSaveMark",value:function isSaveMark(){return false;}},{key:"restore",value:function restore(context){this._mat.copyTo(context._curMat);SaveTranslate.POOL[SaveTranslate.POOL._length++]=this;}}],[{key:"save",value:function save(context){var no=SaveTranslate.POOL;var o=no._length>0?no[--no._length]:new SaveTranslate();context._curMat.copyTo(o._mat);var _save=context._save;_save[_save._length++]=o;}}]);return SaveTranslate;}();SaveTranslate.POOL=SaveBase._createArray();var BufferStateBase=function(){function BufferStateBase(){_classCallCheck(this,BufferStateBase);this._nativeVertexArrayObject=LayaGL.layaGPUInstance.createVertexArray();}_createClass(BufferStateBase,[{key:"bind",value:function bind(){if(BufferStateBase._curBindedBufferState!==this){LayaGL.layaGPUInstance.bindVertexArray(this._nativeVertexArrayObject);BufferStateBase._curBindedBufferState=this;}}},{key:"unBind",value:function unBind(){if(BufferStateBase._curBindedBufferState===this){LayaGL.layaGPUInstance.bindVertexArray(null);BufferStateBase._curBindedBufferState=null;}else{throw"BufferState: must call bind() function first.";}}},{key:"destroy",value:function destroy(){LayaGL.layaGPUInstance.deleteVertexArray(this._nativeVertexArrayObject);}},{key:"bindForNative",value:function bindForNative(){LayaGL.instance.bindVertexArray(this._nativeVertexArrayObject);BufferStateBase._curBindedBufferState=this;}},{key:"unBindForNative",value:function unBindForNative(){LayaGL.instance.bindVertexArray(null);BufferStateBase._curBindedBufferState=null;}}]);return BufferStateBase;}();var BufferState2D=function(_BufferStateBase){_inherits(BufferState2D,_BufferStateBase);function BufferState2D(){_classCallCheck(this,BufferState2D);return _possibleConstructorReturn(this,(BufferState2D.__proto__||Object.getPrototypeOf(BufferState2D)).call(this));}return BufferState2D;}(BufferStateBase);var Buffer=function(){function Buffer(){_classCallCheck(this,Buffer);this._byteLength=0;this._glBuffer=LayaGL.instance.createBuffer();}_createClass(Buffer,[{key:"_bindForVAO",value:function _bindForVAO(){}},{key:"bind",value:function bind(){return false;}},{key:"destroy",value:function destroy(){if(this._glBuffer){LayaGL.instance.deleteBuffer(this._glBuffer);this._glBuffer=null;}}},{key:"bufferUsage",get:function get(){return this._bufferUsage;}}]);return Buffer;}();var RenderInfo=function RenderInfo(){_classCallCheck(this,RenderInfo);};RenderInfo.loopStTm=0;RenderInfo.loopCount=0;var Buffer2D=function(_Buffer){_inherits(Buffer2D,_Buffer);function Buffer2D(){_classCallCheck(this,Buffer2D);var _this14=_possibleConstructorReturn(this,(Buffer2D.__proto__||Object.getPrototypeOf(Buffer2D)).call(this));_this14._maxsize=0;_this14._upload=true;_this14._uploadSize=0;_this14._bufferSize=0;_this14._u8Array=null;return _this14;}_createClass(Buffer2D,[{key:"setByteLength",value:function setByteLength(value){if(this._byteLength!==value){value<=this._bufferSize||this._resizeBuffer(value*2+256,true);this._byteLength=value;}}},{key:"needSize",value:function needSize(sz){var old=this._byteLength;if(sz){var needsz=this._byteLength+sz;needsz<=this._bufferSize||this._resizeBuffer(needsz<<1,true);this._byteLength=needsz;}return old;}},{key:"_bufferData",value:function _bufferData(){this._maxsize=Math.max(this._maxsize,this._byteLength);if(RenderInfo.loopCount%30==0){if(this._buffer.byteLength>this._maxsize+64){this._buffer=this._buffer.slice(0,this._maxsize+64);this._bufferSize=this._buffer.byteLength;this._checkArrayUse();}this._maxsize=this._byteLength;}if(this._uploadSize<this._buffer.byteLength){this._uploadSize=this._buffer.byteLength;LayaGL.instance.bufferData(this._bufferType,this._uploadSize,this._bufferUsage);}LayaGL.instance.bufferSubData(this._bufferType,0,new Uint8Array(this._buffer,0,this._byteLength));}},{key:"_bufferSubData",value:function _bufferSubData(){var offset=arguments.length>0&&arguments[0]!==undefined?arguments[0]:0;var dataStart=arguments.length>1&&arguments[1]!==undefined?arguments[1]:0;var dataLength=arguments.length>2&&arguments[2]!==undefined?arguments[2]:0;this._maxsize=Math.max(this._maxsize,this._byteLength);if(RenderInfo.loopCount%30==0){if(this._buffer.byteLength>this._maxsize+64){this._buffer=this._buffer.slice(0,this._maxsize+64);this._bufferSize=this._buffer.byteLength;this._checkArrayUse();}this._maxsize=this._byteLength;}if(this._uploadSize<this._buffer.byteLength){this._uploadSize=this._buffer.byteLength;LayaGL.instance.bufferData(this._bufferType,this._uploadSize,this._bufferUsage);}if(dataStart||dataLength){var subBuffer=this._buffer.slice(dataStart,dataLength);LayaGL.instance.bufferSubData(this._bufferType,offset,subBuffer);}else{LayaGL.instance.bufferSubData(this._bufferType,offset,this._buffer);}}},{key:"_checkArrayUse",value:function _checkArrayUse(){}},{key:"_bind_uploadForVAO",value:function _bind_uploadForVAO(){if(!this._upload)return false;this._upload=false;this._bindForVAO();this._bufferData();return true;}},{key:"_bind_upload",value:function _bind_upload(){if(!this._upload)return false;this._upload=false;this.bind();this._bufferData();return true;}},{key:"_bind_subUpload",value:function _bind_subUpload(){var offset=arguments.length>0&&arguments[0]!==undefined?arguments[0]:0;var dataStart=arguments.length>1&&arguments[1]!==undefined?arguments[1]:0;var dataLength=arguments.length>2&&arguments[2]!==undefined?arguments[2]:0;if(!this._upload)return false;this._upload=false;this.bind();this._bufferSubData(offset,dataStart,dataLength);return true;}},{key:"_resizeBuffer",value:function _resizeBuffer(nsz,copy){var buff=this._buffer;if(nsz<=buff.byteLength)return this;var u8buf=this._u8Array;if(copy&&buff&&buff.byteLength>0){var newbuffer=new ArrayBuffer(nsz);var oldU8Arr=u8buf&&u8buf.buffer==buff?u8buf:new Uint8Array(buff);u8buf=this._u8Array=new Uint8Array(newbuffer);u8buf.set(oldU8Arr,0);buff=this._buffer=newbuffer;}else{buff=this._buffer=new ArrayBuffer(nsz);this._u8Array=null;}this._checkArrayUse();this._upload=true;this._bufferSize=buff.byteLength;return this;}},{key:"append",value:function append(data){this._upload=true;var byteLen,n;byteLen=data.byteLength;if(data instanceof Uint8Array){this._resizeBuffer(this._byteLength+byteLen,true);n=new Uint8Array(this._buffer,this._byteLength);}else if(data instanceof Uint16Array){this._resizeBuffer(this._byteLength+byteLen,true);n=new Uint16Array(this._buffer,this._byteLength);}else if(data instanceof Float32Array){this._resizeBuffer(this._byteLength+byteLen,true);n=new Float32Array(this._buffer,this._byteLength);}n.set(data,0);this._byteLength+=byteLen;this._checkArrayUse();}},{key:"appendU16Array",value:function appendU16Array(data,len){this._resizeBuffer(this._byteLength+len*2,true);var u=new Uint16Array(this._buffer,this._byteLength,len);if(len==6){u[0]=data[0];u[1]=data[1];u[2]=data[2];u[3]=data[3];u[4]=data[4];u[5]=data[5];}else if(len>=100){u.set(new Uint16Array(data.buffer,0,len));}else{for(var i=0;i<len;i++){u[i]=data[i];}}this._byteLength+=len*2;this._checkArrayUse();}},{key:"appendEx",value:function appendEx(data,type){this._upload=true;var byteLen,n;byteLen=data.byteLength;this._resizeBuffer(this._byteLength+byteLen,true);n=new type(this._buffer,this._byteLength);n.set(data,0);this._byteLength+=byteLen;this._checkArrayUse();}},{key:"appendEx2",value:function appendEx2(data,type,dataLen){var perDataLen=arguments.length>3&&arguments[3]!==undefined?arguments[3]:1;this._upload=true;var byteLen,n;byteLen=dataLen*perDataLen;this._resizeBuffer(this._byteLength+byteLen,true);n=new type(this._buffer,this._byteLength);var i;for(i=0;i<dataLen;i++){n[i]=data[i];}this._byteLength+=byteLen;this._checkArrayUse();}},{key:"getBuffer",value:function getBuffer(){return this._buffer;}},{key:"setNeedUpload",value:function setNeedUpload(){this._upload=true;}},{key:"getNeedUpload",value:function getNeedUpload(){return this._upload;}},{key:"upload",value:function upload(){var gl=LayaGL.instance;var scuess=this._bind_upload();gl.bindBuffer(this._bufferType,null);if(this._bufferType==gl.ARRAY_BUFFER)Buffer._bindedVertexBuffer=null;if(this._bufferType==gl.ELEMENT_ARRAY_BUFFER)Buffer._bindedIndexBuffer=null;BaseShader.activeShader=null;return scuess;}},{key:"subUpload",value:function subUpload(){var offset=arguments.length>0&&arguments[0]!==undefined?arguments[0]:0;var dataStart=arguments.length>1&&arguments[1]!==undefined?arguments[1]:0;var dataLength=arguments.length>2&&arguments[2]!==undefined?arguments[2]:0;var gl=LayaGL.instance;var scuess=this._bind_subUpload();gl.bindBuffer(this._bufferType,null);if(this._bufferType==gl.ARRAY_BUFFER)Buffer._bindedVertexBuffer=null;if(this._bufferType==gl.ELEMENT_ARRAY_BUFFER)Buffer._bindedIndexBuffer=null;BaseShader.activeShader=null;return scuess;}},{key:"_disposeResource",value:function _disposeResource(){this._upload=true;this._uploadSize=0;}},{key:"clear",value:function clear(){this._byteLength=0;this._upload=true;}},{key:"bufferLength",get:function get(){return this._buffer.byteLength;}},{key:"byteLength",set:function set(value){this.setByteLength(value);}}],[{key:"__int__",value:function __int__(gl){}}]);return Buffer2D;}(Buffer);Buffer2D.FLOAT32=4;Buffer2D.SHORT=2;var IndexBuffer2D=function(_Buffer2D){_inherits(IndexBuffer2D,_Buffer2D);function IndexBuffer2D(){var bufferUsage=arguments.length>0&&arguments[0]!==undefined?arguments[0]:0x88e4;_classCallCheck(this,IndexBuffer2D);var _this15=_possibleConstructorReturn(this,(IndexBuffer2D.__proto__||Object.getPrototypeOf(IndexBuffer2D)).call(this));_this15._bufferUsage=bufferUsage;_this15._bufferType=LayaGL.instance.ELEMENT_ARRAY_BUFFER;_this15._buffer=new ArrayBuffer(8);return _this15;}_createClass(IndexBuffer2D,[{key:"_checkArrayUse",value:function _checkArrayUse(){this._uint16Array&&(this._uint16Array=new Uint16Array(this._buffer));}},{key:"getUint16Array",value:function getUint16Array(){return this._uint16Array||(this._uint16Array=new Uint16Array(this._buffer));}},{key:"_bindForVAO",value:function _bindForVAO(){var gl=LayaGL.instance;gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,this._glBuffer);}},{key:"bind",value:function bind(){if(Buffer._bindedIndexBuffer!==this._glBuffer){var gl=LayaGL.instance;gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,this._glBuffer);Buffer._bindedIndexBuffer=this._glBuffer;return true;}return false;}},{key:"destory",value:function destory(){this._uint16Array=null;this._buffer=null;}},{key:"disposeResource",value:function disposeResource(){this._disposeResource();}}]);return IndexBuffer2D;}(Buffer2D);IndexBuffer2D.create=function(){var bufferUsage=arguments.length>0&&arguments[0]!==undefined?arguments[0]:0x88e4;return new IndexBuffer2D(bufferUsage);};var VertexBuffer2D=function(_Buffer2D2){_inherits(VertexBuffer2D,_Buffer2D2);function VertexBuffer2D(vertexStride,bufferUsage){_classCallCheck(this,VertexBuffer2D);var _this16=_possibleConstructorReturn(this,(VertexBuffer2D.__proto__||Object.getPrototypeOf(VertexBuffer2D)).call(this));_this16._vertexStride=vertexStride;_this16._bufferUsage=bufferUsage;_this16._bufferType=LayaGL.instance.ARRAY_BUFFER;_this16._buffer=new ArrayBuffer(8);_this16._floatArray32=new Float32Array(_this16._buffer);_this16._uint32Array=new Uint32Array(_this16._buffer);return _this16;}_createClass(VertexBuffer2D,[{key:"getFloat32Array",value:function getFloat32Array(){return this._floatArray32;}},{key:"appendArray",value:function appendArray(data){var oldoff=this._byteLength>>2;this.setByteLength(this._byteLength+data.length*4);var vbdata=this.getFloat32Array();vbdata.set(data,oldoff);this._upload=true;}},{key:"_checkArrayUse",value:function _checkArrayUse(){this._floatArray32&&(this._floatArray32=new Float32Array(this._buffer));this._uint32Array&&(this._uint32Array=new Uint32Array(this._buffer));}},{key:"deleteBuffer",value:function deleteBuffer(){_get(VertexBuffer2D.prototype.__proto__||Object.getPrototypeOf(VertexBuffer2D.prototype),"_disposeResource",this).call(this);}},{key:"_bindForVAO",value:function _bindForVAO(){var gl=LayaGL.instance;gl.bindBuffer(gl.ARRAY_BUFFER,this._glBuffer);}},{key:"bind",value:function bind(){if(Buffer._bindedVertexBuffer!==this._glBuffer){var gl=LayaGL.instance;gl.bindBuffer(gl.ARRAY_BUFFER,this._glBuffer);Buffer._bindedVertexBuffer=this._glBuffer;return true;}return false;}},{key:"destroy",value:function destroy(){_get(VertexBuffer2D.prototype.__proto__||Object.getPrototypeOf(VertexBuffer2D.prototype),"destroy",this).call(this);this._byteLength=0;this._upload=true;this._buffer=null;this._floatArray32=null;}},{key:"vertexStride",get:function get(){return this._vertexStride;}}]);return VertexBuffer2D;}(Buffer2D);VertexBuffer2D.create=function(vertexStride){var bufferUsage=arguments.length>1&&arguments[1]!==undefined?arguments[1]:0x88e8;return new VertexBuffer2D(vertexStride,bufferUsage);};var Mesh2D=function(){function Mesh2D(stride,vballoc,iballoc){_classCallCheck(this,Mesh2D);this._stride=0;this.vertNum=0;this.indexNum=0;this._applied=false;this._quadNum=0;this.canReuse=false;this._stride=stride;this._vb=new VertexBuffer2D(stride,LayaGL.instance.DYNAMIC_DRAW);if(vballoc){this._vb._resizeBuffer(vballoc,false);}else{Config.webGL2D_MeshAllocMaxMem&&this._vb._resizeBuffer(64*1024*stride,false);}this._ib=new IndexBuffer2D();if(iballoc){this._ib._resizeBuffer(iballoc,false);}}_createClass(Mesh2D,[{key:"cloneWithNewVB",value:function cloneWithNewVB(){var mesh=new Mesh2D(this._stride,0,0);mesh._ib=this._ib;mesh._quadNum=this._quadNum;mesh._attribInfo=this._attribInfo;return mesh;}},{key:"cloneWithNewVBIB",value:function cloneWithNewVBIB(){var mesh=new Mesh2D(this._stride,0,0);mesh._attribInfo=this._attribInfo;return mesh;}},{key:"getVBW",value:function getVBW(){this._vb.setNeedUpload();return this._vb;}},{key:"getVBR",value:function getVBR(){return this._vb;}},{key:"getIBR",value:function getIBR(){return this._ib;}},{key:"getIBW",value:function getIBW(){this._ib.setNeedUpload();return this._ib;}},{key:"createQuadIB",value:function createQuadIB(QuadNum){this._quadNum=QuadNum;this._ib._resizeBuffer(QuadNum*6*2,false);this._ib.byteLength=this._ib.bufferLength;var bd=this._ib.getUint16Array();var idx=0;var curvert=0;for(var i=0;i<QuadNum;i++){bd[idx++]=curvert;bd[idx++]=curvert+2;bd[idx++]=curvert+1;bd[idx++]=curvert;bd[idx++]=curvert+3;bd[idx++]=curvert+2;curvert+=4;}this._ib.setNeedUpload();}},{key:"setAttributes",value:function setAttributes(attribs){this._attribInfo=attribs;if(this._attribInfo.length%3!=0){throw'Mesh2D setAttributes error!';}}},{key:"configVAO",value:function configVAO(gl){if(this._applied)return;this._applied=true;if(!this._vao){this._vao=new BufferState2D();}this._vao.bind();this._vb._bindForVAO();this._ib.setNeedUpload();this._ib._bind_uploadForVAO();var attribNum=this._attribInfo.length/3;var idx=0;for(var i=0;i<attribNum;i++){var _size=this._attribInfo[idx+1];var _type=this._attribInfo[idx];var _off=this._attribInfo[idx+2];gl.enableVertexAttribArray(i);gl.vertexAttribPointer(i,_size,_type,false,this._stride,_off);idx+=3;}this._vao.unBind();}},{key:"useMesh",value:function useMesh(gl){this._applied||this.configVAO(gl);this._vao.bind();this._vb.bind();this._ib._bind_upload()||this._ib.bind();this._vb._bind_upload()||this._vb.bind();}},{key:"getEleNum",value:function getEleNum(){return this._ib.getBuffer().byteLength/2;}},{key:"releaseMesh",value:function releaseMesh(){}},{key:"destroy",value:function destroy(){}},{key:"clearVB",value:function clearVB(){this._vb.clear();}}]);return Mesh2D;}();Mesh2D._gvaoid=0;var MeshQuadTexture=function(_Mesh2D){_inherits(MeshQuadTexture,_Mesh2D);function MeshQuadTexture(){_classCallCheck(this,MeshQuadTexture);var _this17=_possibleConstructorReturn(this,(MeshQuadTexture.__proto__||Object.getPrototypeOf(MeshQuadTexture)).call(this,MeshQuadTexture.const_stride,4,4));_this17.canReuse=true;_this17.setAttributes(MeshQuadTexture._fixattriInfo);if(!MeshQuadTexture._fixib){_this17.createQuadIB(MeshQuadTexture._maxIB);MeshQuadTexture._fixib=_this17._ib;}else{_this17._ib=MeshQuadTexture._fixib;_this17._quadNum=MeshQuadTexture._maxIB;}return _this17;}_createClass(MeshQuadTexture,[{key:"releaseMesh",value:function releaseMesh(){this._vb.setByteLength(0);this.vertNum=0;this.indexNum=0;MeshQuadTexture._POOL.push(this);}},{key:"destroy",value:function destroy(){this._vb.destroy();this._vb.deleteBuffer();}},{key:"addQuad",value:function addQuad(pos,uv,color,useTex){var vb=this._vb;var vpos=vb._byteLength>>2;vb.setByteLength(vpos+MeshQuadTexture.const_stride<<2);var vbdata=vb._floatArray32||vb.getFloat32Array();var vbu32Arr=vb._uint32Array;var cpos=vpos;var useTexVal=useTex?0xff:0;vbdata[cpos++]=pos[0];vbdata[cpos++]=pos[1];vbdata[cpos++]=uv[0];vbdata[cpos++]=uv[1];vbu32Arr[cpos++]=color;vbu32Arr[cpos++]=useTexVal;vbdata[cpos++]=pos[2];vbdata[cpos++]=pos[3];vbdata[cpos++]=uv[2];vbdata[cpos++]=uv[3];vbu32Arr[cpos++]=color;vbu32Arr[cpos++]=useTexVal;vbdata[cpos++]=pos[4];vbdata[cpos++]=pos[5];vbdata[cpos++]=uv[4];vbdata[cpos++]=uv[5];vbu32Arr[cpos++]=color;vbu32Arr[cpos++]=useTexVal;vbdata[cpos++]=pos[6];vbdata[cpos++]=pos[7];vbdata[cpos++]=uv[6];vbdata[cpos++]=uv[7];vbu32Arr[cpos++]=color;vbu32Arr[cpos++]=useTexVal;vb._upload=true;}}],[{key:"__int__",value:function __int__(){MeshQuadTexture._fixattriInfo=[5126,4,0,5121,4,16,5121,4,20];}},{key:"getAMesh",value:function getAMesh(mainctx){var ret=null;if(MeshQuadTexture._POOL.length){ret=MeshQuadTexture._POOL.pop();}else ret=new MeshQuadTexture();mainctx&&ret._vb._resizeBuffer(64*1024*MeshQuadTexture.const_stride,false);return ret;}}]);return MeshQuadTexture;}(Mesh2D);MeshQuadTexture.const_stride=24;MeshQuadTexture._maxIB=16*1024;MeshQuadTexture._POOL=[];var MeshTexture=function(_Mesh2D2){_inherits(MeshTexture,_Mesh2D2);function MeshTexture(){_classCallCheck(this,MeshTexture);var _this18=_possibleConstructorReturn(this,(MeshTexture.__proto__||Object.getPrototypeOf(MeshTexture)).call(this,MeshTexture.const_stride,4,4));_this18.canReuse=true;_this18.setAttributes(MeshTexture._fixattriInfo);return _this18;}_createClass(MeshTexture,[{key:"addData",value:function addData(vertices,uvs,idx,matrix,rgba){var vb=this._vb;var ib=this._ib;var vertsz=vertices.length>>1;var startpos=vb.needSize(vertsz*MeshTexture.const_stride);var f32pos=startpos>>2;var vbdata=vb._floatArray32||vb.getFloat32Array();var vbu32Arr=vb._uint32Array;var ci=0;var m00=matrix.a;var m01=matrix.b;var m10=matrix.c;var m11=matrix.d;var tx=matrix.tx;var ty=matrix.ty;var i=0;for(i=0;i<vertsz;i++){var x=vertices[ci],y=vertices[ci+1];vbdata[f32pos]=x*m00+y*m10+tx;vbdata[f32pos+1]=x*m01+y*m11+ty;vbdata[f32pos+2]=uvs[ci];vbdata[f32pos+3]=uvs[ci+1];vbu32Arr[f32pos+4]=rgba;vbu32Arr[f32pos+5]=0xff;f32pos+=6;ci+=2;}vb.setNeedUpload();var vertN=this.vertNum;var sz=idx.length;var stib=ib.needSize(idx.byteLength);var cidx=ib.getUint16Array();var stibid=stib>>1;if(vertN>0){var end=stibid+sz;var si=0;for(i=stibid;i<end;i++,si++){cidx[i]=idx[si]+vertN;}}else{cidx.set(idx,stibid);}ib.setNeedUpload();this.vertNum+=vertsz;this.indexNum+=idx.length;}},{key:"releaseMesh",value:function releaseMesh(){this._vb.setByteLength(0);this._ib.setByteLength(0);this.vertNum=0;this.indexNum=0;MeshTexture._POOL.push(this);}},{key:"destroy",value:function destroy(){this._ib.destroy();this._vb.destroy();this._ib.disposeResource();this._vb.deleteBuffer();}}],[{key:"__init__",value:function __init__(){MeshTexture._fixattriInfo=[5126,4,0,5121,4,16,5121,4,20];}},{key:"getAMesh",value:function getAMesh(mainctx){var ret;if(MeshTexture._POOL.length){ret=MeshTexture._POOL.pop();}else ret=new MeshTexture();mainctx&&ret._vb._resizeBuffer(64*1024*MeshTexture.const_stride,false);return ret;}}]);return MeshTexture;}(Mesh2D);MeshTexture.const_stride=24;MeshTexture._POOL=[];var MeshVG=function(_Mesh2D3){_inherits(MeshVG,_Mesh2D3);function MeshVG(){_classCallCheck(this,MeshVG);var _this19=_possibleConstructorReturn(this,(MeshVG.__proto__||Object.getPrototypeOf(MeshVG)).call(this,MeshVG.const_stride,4,4));_this19.canReuse=true;_this19.setAttributes(MeshVG._fixattriInfo);return _this19;}_createClass(MeshVG,[{key:"addVertAndIBToMesh",value:function addVertAndIBToMesh(ctx,points,rgba,ib){var startpos=this._vb.needSize(points.length/2*MeshVG.const_stride);var f32pos=startpos>>2;var vbdata=this._vb._floatArray32||this._vb.getFloat32Array();var vbu32Arr=this._vb._uint32Array;var ci=0;var sz=points.length/2;for(var i=0;i<sz;i++){vbdata[f32pos++]=points[ci];vbdata[f32pos++]=points[ci+1];ci+=2;vbu32Arr[f32pos++]=rgba;}this._vb.setNeedUpload();this._ib.append(new Uint16Array(ib));this._ib.setNeedUpload();this.vertNum+=sz;this.indexNum+=ib.length;}},{key:"releaseMesh",value:function releaseMesh(){this._vb.setByteLength(0);this._ib.setByteLength(0);this.vertNum=0;this.indexNum=0;MeshVG._POOL.push(this);}},{key:"destroy",value:function destroy(){this._ib.destroy();this._vb.destroy();this._ib.disposeResource();this._vb.deleteBuffer();}}],[{key:"__init__",value:function __init__(){MeshVG._fixattriInfo=[5126,2,0,5121,4,8];}},{key:"getAMesh",value:function getAMesh(mainctx){var ret;if(MeshVG._POOL.length){ret=MeshVG._POOL.pop();}else ret=new MeshVG();mainctx&&ret._vb._resizeBuffer(64*1024*MeshVG.const_stride,false);return ret;}}]);return MeshVG;}(Mesh2D);MeshVG.const_stride=12;MeshVG._POOL=[];var WebGLCacheAsNormalCanvas=function(){function WebGLCacheAsNormalCanvas(ctx,sp){_classCallCheck(this,WebGLCacheAsNormalCanvas);this.submitStartPos=0;this.submitEndPos=0;this.context=null;this.touches=[];this.submits=[];this.sprite=null;this.meshlist=[];this.cachedClipInfo=new Matrix();this.oldTx=0;this.oldTy=0;this.invMat=new Matrix();this.context=ctx;this.sprite=sp;ctx._globalClipMatrix.copyTo(this.cachedClipInfo);}_createClass(WebGLCacheAsNormalCanvas,[{key:"startRec",value:function startRec(){if(this.context._charSubmitCache._enable){this.context._charSubmitCache.enable(false,this.context);this.context._charSubmitCache.enable(true,this.context);}this.context._incache=true;this.touches.length=0;this.context.touches=this.touches;this.context._globalClipMatrix.copyTo(this.cachedClipInfo);this.submits.length=0;this.submitStartPos=this.context._submits._length;for(var i=0,sz=this.meshlist.length;i<sz;i++){var curm=this.meshlist[i];curm.canReuse?curm.releaseMesh():curm.destroy();}this.meshlist.length=0;this._mesh=MeshQuadTexture.getAMesh(false);this._pathMesh=MeshVG.getAMesh(false);this._triangleMesh=MeshTexture.getAMesh(false);this.meshlist.push(this._mesh);this.meshlist.push(this._pathMesh);this.meshlist.push(this._triangleMesh);this.context._curSubmit=SubmitBase.RENDERBASE;this._oldMesh=this.context._mesh;this._oldPathMesh=this.context._pathMesh;this._oldTriMesh=this.context._triangleMesh;this._oldMeshList=this.context.meshlist;this.context._mesh=this._mesh;this.context._pathMesh=this._pathMesh;this.context._triangleMesh=this._triangleMesh;this.context.meshlist=this.meshlist;this.oldTx=this.context._curMat.tx;this.oldTy=this.context._curMat.ty;this.context._curMat.tx=0;this.context._curMat.ty=0;this.context._curMat.copyTo(this.invMat);this.invMat.invert();}},{key:"endRec",value:function endRec(){if(this.context._charSubmitCache._enable){this.context._charSubmitCache.enable(false,this.context);this.context._charSubmitCache.enable(true,this.context);}var parsubmits=this.context._submits;this.submitEndPos=parsubmits._length;var num=this.submitEndPos-this.submitStartPos;for(var i=0;i<num;i++){this.submits.push(parsubmits[this.submitStartPos+i]);}parsubmits._length-=num;this.context._mesh=this._oldMesh;this.context._pathMesh=this._oldPathMesh;this.context._triangleMesh=this._oldTriMesh;this.context.meshlist=this._oldMeshList;this.context._curSubmit=SubmitBase.RENDERBASE;this.context._curMat.tx=this.oldTx;this.context._curMat.ty=this.oldTy;this.context.touches=null;this.context._incache=false;}},{key:"isCacheValid",value:function isCacheValid(){var curclip=this.context._globalClipMatrix;if(curclip.a!=this.cachedClipInfo.a||curclip.b!=this.cachedClipInfo.b||curclip.c!=this.cachedClipInfo.c||curclip.d!=this.cachedClipInfo.d||curclip.tx!=this.cachedClipInfo.tx||curclip.ty!=this.cachedClipInfo.ty)return false;return true;}},{key:"flushsubmit",value:function flushsubmit(){var curSubmit=SubmitBase.RENDERBASE;this.submits.forEach(function(subm){if(subm==SubmitBase.RENDERBASE)return;SubmitBase.preRender=curSubmit;curSubmit=subm;subm.renderSubmit();});}},{key:"releaseMem",value:function releaseMem(){}}]);return WebGLCacheAsNormalCanvas;}();WebGLCacheAsNormalCanvas.matI=new Matrix();var texture_vs="/*\r\n\ttexturefillrect\r\n*/\r\nattribute vec4 posuv;\r\nattribute vec4 attribColor;\r\nattribute vec4 attribFlags;\r\n//attribute vec4 clipDir;\r\n//attribute vec2 clipRect;\r\nuniform vec4 clipMatDir;\r\nuniform vec2 clipMatPos;\t\t// \r\nvarying vec2 cliped;\r\nuniform vec2 size;\r\nuniform vec2 clipOff;\t\t\t// clipcacheas normal. [0]\r\n#ifdef WORLDMAT\r\n\tuniform mat4 mmat;\r\n#endif\r\n#ifdef MVP3D\r\n\tuniform mat4 u_MvpMatrix;\r\n#endif\r\nvarying vec4 v_texcoordAlpha;\r\nvarying vec4 v_color;\r\nvarying float v_useTex;\r\n\r\nvoid main() {\r\n\r\n\tvec4 pos = vec4(posuv.xy,0.,1.);\r\n#ifdef WORLDMAT\r\n\tpos=mmat*pos;\r\n#endif\r\n\tvec4 pos1  =vec4((pos.x/size.x-0.5)*2.0,(0.5-pos.y/size.y)*2.0,0.,1.0);\r\n#ifdef MVP3D\r\n\tgl_Position=u_MvpMatrix*pos1;\r\n#else\r\n\tgl_Position=pos1;\r\n#endif\r\n\tv_texcoordAlpha.xy = posuv.zw;\r\n\t//v_texcoordAlpha.z = attribColor.a/255.0;\r\n\tv_color = attribColor/255.0;\r\n\tv_color.xyz*=v_color.w;//\r\n\t\r\n\tv_useTex = attribFlags.r/255.0;\r\n\tfloat clipw = length(clipMatDir.xy);\r\n\tfloat cliph = length(clipMatDir.zw);\r\n\t\r\n\tvec2 clpos = clipMatPos.xy;\r\n\t#ifdef WORLDMAT\r\n\t\t// mmatclipMatPos, cacheas normal  clipMatPos\r\n\t\tif(clipOff[0]>0.0){\r\n\t\t\tclpos.x+=mmat[3].x;\t//tx\t\r\n\t\t\tclpos.y+=mmat[3].y;\t//ty\r\n\t\t}\r\n\t#endif\r\n\tvec2 clippos = pos.xy - clpos;\t//posclip\r\n\tif(clipw>20000. && cliph>20000.)\r\n\t\tcliped = vec2(0.5,0.5);\r\n\telse {\r\n\t\t//01/clipw/clipw clipposnormalizeclipclipw\r\n\t\tcliped=vec2( dot(clippos,clipMatDir.xy)/clipw/clipw, dot(clippos,clipMatDir.zw)/cliph/cliph);\r\n\t}\r\n\r\n}";var texture_ps="/*\r\n\ttexturefillrect\r\n*/\r\n#ifdef GL_FRAGMENT_PRECISION_HIGH\r\nprecision highp float;\r\n#else\r\nprecision mediump float;\r\n#endif\r\n\r\nvarying vec4 v_texcoordAlpha;\r\nvarying vec4 v_color;\r\nvarying float v_useTex;\r\nuniform sampler2D texture;\r\nvarying vec2 cliped;\r\n\r\n#ifdef BLUR_FILTER\r\nuniform vec4 strength_sig2_2sig2_gauss1;\r\nuniform vec2 blurInfo;\r\n\r\n#define PI 3.141593\r\n\r\nfloat getGaussian(float x, float y){\r\n    return strength_sig2_2sig2_gauss1.w*exp(-(x*x+y*y)/strength_sig2_2sig2_gauss1.z);\r\n}\r\n\r\nvec4 blur(){\r\n    const float blurw = 9.0;\r\n    vec4 vec4Color = vec4(0.0,0.0,0.0,0.0);\r\n    vec2 halfsz=vec2(blurw,blurw)/2.0/blurInfo;    \r\n    vec2 startpos=v_texcoordAlpha.xy-halfsz;\r\n    vec2 ctexcoord = startpos;\r\n    vec2 step = 1.0/blurInfo;  //      \r\n    \r\n    for(float y = 0.0;y<=blurw; ++y){\r\n        ctexcoord.x=startpos.x;\r\n        for(float x = 0.0;x<=blurw; ++x){\r\n            //TODO vs\r\n            vec4Color += texture2D(texture, ctexcoord)*getGaussian(x-blurw/2.0,y-blurw/2.0);\r\n            ctexcoord.x+=step.x;\r\n        }\r\n        ctexcoord.y+=step.y;\r\n    }\r\n    return vec4Color;\r\n}\r\n#endif\r\n\r\n#ifdef COLOR_FILTER\r\nuniform vec4 colorAlpha;\r\nuniform mat4 colorMat;\r\n#endif\r\n\r\n#ifdef GLOW_FILTER\r\nuniform vec4 u_color;\r\nuniform vec4 u_blurInfo1;\r\nuniform vec4 u_blurInfo2;\r\n#endif\r\n\r\n#ifdef COLOR_ADD\r\nuniform vec4 colorAdd;\r\n#endif\r\n\r\n#ifdef FILLTEXTURE\t\r\nuniform vec4 u_TexRange;//startu,startv,urange, vrange\r\n#endif\r\nvoid main() {\r\n\tif(cliped.x<0.) discard;\r\n\tif(cliped.x>1.) discard;\r\n\tif(cliped.y<0.) discard;\r\n\tif(cliped.y>1.) discard;\r\n\t\r\n#ifdef FILLTEXTURE\t\r\n   vec4 color= texture2D(texture, fract(v_texcoordAlpha.xy)*u_TexRange.zw + u_TexRange.xy);\r\n#else\r\n   vec4 color= texture2D(texture, v_texcoordAlpha.xy);\r\n#endif\r\n\r\n   if(v_useTex<=0.)color = vec4(1.,1.,1.,1.);\r\n   color.a*=v_color.w;\r\n   //color.rgb*=v_color.w;\r\n   color.rgb*=v_color.rgb;\r\n   gl_FragColor=color;\r\n   \r\n   #ifdef COLOR_ADD\r\n\tgl_FragColor = vec4(colorAdd.rgb,colorAdd.a*gl_FragColor.a);\r\n\tgl_FragColor.xyz *= colorAdd.a;\r\n   #endif\r\n   \r\n   #ifdef BLUR_FILTER\r\n\tgl_FragColor =   blur();\r\n\tgl_FragColor.w*=v_color.w;   \r\n   #endif\r\n   \r\n   #ifdef COLOR_FILTER\r\n\tmat4 alphaMat =colorMat;\r\n\r\n\talphaMat[0][3] *= gl_FragColor.a;\r\n\talphaMat[1][3] *= gl_FragColor.a;\r\n\talphaMat[2][3] *= gl_FragColor.a;\r\n\r\n\tgl_FragColor = gl_FragColor * alphaMat;\r\n\tgl_FragColor += colorAlpha/255.0*gl_FragColor.a;\r\n   #endif\r\n   \r\n   #ifdef GLOW_FILTER\r\n\tconst float c_IterationTime = 10.0;\r\n\tfloat floatIterationTotalTime = c_IterationTime * c_IterationTime;\r\n\tvec4 vec4Color = vec4(0.0,0.0,0.0,0.0);\r\n\tvec2 vec2FilterDir = vec2(-(u_blurInfo1.z)/u_blurInfo2.x,-(u_blurInfo1.w)/u_blurInfo2.y);\r\n\tvec2 vec2FilterOff = vec2(u_blurInfo1.x/u_blurInfo2.x/c_IterationTime * 2.0,u_blurInfo1.y/u_blurInfo2.y/c_IterationTime * 2.0);\r\n\tfloat maxNum = u_blurInfo1.x * u_blurInfo1.y;\r\n\tvec2 vec2Off = vec2(0.0,0.0);\r\n\tfloat floatOff = c_IterationTime/2.0;\r\n\tfor(float i = 0.0;i<=c_IterationTime; ++i){\r\n\t\tfor(float j = 0.0;j<=c_IterationTime; ++j){\r\n\t\t\tvec2Off = vec2(vec2FilterOff.x * (i - floatOff),vec2FilterOff.y * (j - floatOff));\r\n\t\t\tvec4Color += texture2D(texture, v_texcoordAlpha.xy + vec2FilterDir + vec2Off)/floatIterationTotalTime;\r\n\t\t}\r\n\t}\r\n\tgl_FragColor = vec4(u_color.rgb,vec4Color.a * u_blurInfo2.z);\r\n\tgl_FragColor.rgb *= gl_FragColor.a;   \r\n   #endif\r\n   \r\n}";var prime_vs="attribute vec4 position;\r\nattribute vec4 attribColor;\r\n//attribute vec4 clipDir;\r\n//attribute vec2 clipRect;\r\nuniform vec4 clipMatDir;\r\nuniform vec2 clipMatPos;\r\n#ifdef WORLDMAT\r\n\tuniform mat4 mmat;\r\n#endif\r\nuniform mat4 u_mmat2;\r\n//uniform vec2 u_pos;\r\nuniform vec2 size;\r\nvarying vec4 color;\r\n//vec4 dirxy=vec4(0.9,0.1, -0.1,0.9);\r\n//vec4 clip=vec4(100.,30.,300.,600.);\r\nvarying vec2 cliped;\r\nvoid main(){\r\n\t\r\n#ifdef WORLDMAT\r\n\tvec4 pos=mmat*vec4(position.xy,0.,1.);\r\n\tgl_Position =vec4((pos.x/size.x-0.5)*2.0,(0.5-pos.y/size.y)*2.0,pos.z,1.0);\r\n#else\r\n\tgl_Position =vec4((position.x/size.x-0.5)*2.0,(0.5-position.y/size.y)*2.0,position.z,1.0);\r\n#endif\t\r\n\tfloat clipw = length(clipMatDir.xy);\r\n\tfloat cliph = length(clipMatDir.zw);\r\n\tvec2 clippos = position.xy - clipMatPos.xy;\t//posclip\r\n\tif(clipw>20000. && cliph>20000.)\r\n\t\tcliped = vec2(0.5,0.5);\r\n\telse {\r\n\t\t//clipdirclipposnormalize\r\n\t\tcliped=vec2( dot(clippos,clipMatDir.xy)/clipw/clipw, dot(clippos,clipMatDir.zw)/cliph/cliph);\r\n\t}\r\n  //pos2d.x = dot(clippos,dirx);\r\n  color=attribColor/255.;\r\n}";var prime_ps="precision mediump float;\r\n//precision mediump float;\r\nvarying vec4 color;\r\n//uniform float alpha;\r\nvarying vec2 cliped;\r\nvoid main(){\r\n\t//vec4 a=vec4(color.r, color.g, color.b, 1);\r\n\t//a.a*=alpha;\r\n    gl_FragColor= color;// vec4(color.r, color.g, color.b, alpha);\r\n\tgl_FragColor.rgb*=color.a;\r\n\tif(cliped.x<0.) discard;\r\n\tif(cliped.x>1.) discard;\r\n\tif(cliped.y<0.) discard;\r\n\tif(cliped.y>1.) discard;\r\n}";var skin_vs="attribute vec2 position;\r\nattribute vec2 texcoord;\r\nattribute vec4 color;\r\nuniform vec2 size;\r\nuniform float offsetX;\r\nuniform float offsetY;\r\nuniform mat4 mmat;\r\nuniform mat4 u_mmat2;\r\nvarying vec2 v_texcoord;\r\nvarying vec4 v_color;\r\nvoid main() {\r\n  vec4 pos=mmat*u_mmat2*vec4(offsetX+position.x,offsetY+position.y,0,1 );\r\n  gl_Position = vec4((pos.x/size.x-0.5)*2.0,(0.5-pos.y/size.y)*2.0,pos.z,1.0);\r\n  v_color = color;\r\n  v_color.rgb *= v_color.a;\r\n  v_texcoord = texcoord;  \r\n}";var skin_ps="precision mediump float;\r\nvarying vec2 v_texcoord;\r\nvarying vec4 v_color;\r\nuniform sampler2D texture;\r\nuniform float alpha;\r\nvoid main() {\r\n\tvec4 t_color = texture2D(texture, v_texcoord);\r\n\tgl_FragColor = t_color.rgba * v_color;\r\n\tgl_FragColor *= alpha;\r\n}";var Shader2D=function(){function Shader2D(){_classCallCheck(this,Shader2D);this.ALPHA=1;this.defines=new ShaderDefines2D();this.shaderType=0;this.fillStyle=DrawStyle.DEFAULT;this.strokeStyle=DrawStyle.DEFAULT;}_createClass(Shader2D,[{key:"destroy",value:function destroy(){this.defines=null;this.filters=null;}}],[{key:"__init__",value:function __init__(){Shader.preCompile2D(0,ShaderDefines2D.TEXTURE2D,texture_vs,texture_ps,null);Shader.preCompile2D(0,ShaderDefines2D.PRIMITIVE,prime_vs,prime_ps,null);Shader.preCompile2D(0,ShaderDefines2D.SKINMESH,skin_vs,skin_ps,null);}}]);return Shader2D;}();var SkinMeshBuffer=function(){function SkinMeshBuffer(){_classCallCheck(this,SkinMeshBuffer);var gl=LayaGL.instance;this.ib=IndexBuffer2D.create(gl.DYNAMIC_DRAW);this.vb=VertexBuffer2D.create(8);}_createClass(SkinMeshBuffer,[{key:"addSkinMesh",value:function addSkinMesh(skinMesh){skinMesh.getData2(this.vb,this.ib,this.vb._byteLength/32);}},{key:"reset",value:function reset(){this.vb.clear();this.ib.clear();}}],[{key:"getInstance",value:function getInstance(){return SkinMeshBuffer.instance=SkinMeshBuffer.instance||new SkinMeshBuffer();}}]);return SkinMeshBuffer;}();var BasePoly=function(){function BasePoly(){_classCallCheck(this,BasePoly);}_createClass(BasePoly,null,[{key:"createLine2",value:function createLine2(p,indices,lineWidth,indexBase,outVertex,loop){if(p.length<4)return null;var points=BasePoly.tempData.length>p.length+2?BasePoly.tempData:new Array(p.length+2);points[0]=p[0];points[1]=p[1];var newlen=2;var i=0;var length=p.length;for(i=2;i<length;i+=2){if(Math.abs(p[i]-p[i-2])+Math.abs(p[i+1]-p[i-1])>0.01){points[newlen++]=p[i];points[newlen++]=p[i+1];}}if(loop&&Math.abs(p[0]-points[newlen-2])+Math.abs(p[1]-points[newlen-1])>0.01){points[newlen++]=p[0];points[newlen++]=p[1];}var result=outVertex;length=newlen/2;var w=lineWidth/2;var px,py,p1x,p1y,p2x,p2y,p3x,p3y;var perpx,perpy,perp2x,perp2y;var a1,b1,c1,a2,b2,c2;var denom,dist;p1x=points[0];p1y=points[1];p2x=points[2];p2y=points[3];perpx=-(p1y-p2y);perpy=p1x-p2x;dist=Math.sqrt(perpx*perpx+perpy*perpy);perpx=perpx/dist*w;perpy=perpy/dist*w;result.push(p1x-perpx,p1y-perpy,p1x+perpx,p1y+perpy);for(i=1;i<length-1;i++){p1x=points[(i-1)*2];p1y=points[(i-1)*2+1];p2x=points[i*2];p2y=points[i*2+1];p3x=points[(i+1)*2];p3y=points[(i+1)*2+1];perpx=-(p1y-p2y);perpy=p1x-p2x;dist=Math.sqrt(perpx*perpx+perpy*perpy);perpx=perpx/dist*w;perpy=perpy/dist*w;perp2x=-(p2y-p3y);perp2y=p2x-p3x;dist=Math.sqrt(perp2x*perp2x+perp2y*perp2y);perp2x=perp2x/dist*w;perp2y=perp2y/dist*w;a1=-perpy+p1y-(-perpy+p2y);b1=-perpx+p2x-(-perpx+p1x);c1=(-perpx+p1x)*(-perpy+p2y)-(-perpx+p2x)*(-perpy+p1y);a2=-perp2y+p3y-(-perp2y+p2y);b2=-perp2x+p2x-(-perp2x+p3x);c2=(-perp2x+p3x)*(-perp2y+p2y)-(-perp2x+p2x)*(-perp2y+p3y);denom=a1*b2-a2*b1;if(Math.abs(denom)<0.1){denom+=10.1;result.push(p2x-perpx,p2y-perpy,p2x+perpx,p2y+perpy);continue;}px=(b1*c2-b2*c1)/denom;py=(a2*c1-a1*c2)/denom;result.push(px,py,p2x-(px-p2x),p2y-(py-p2y));}p1x=points[newlen-4];p1y=points[newlen-3];p2x=points[newlen-2];p2y=points[newlen-1];perpx=-(p1y-p2y);perpy=p1x-p2x;dist=Math.sqrt(perpx*perpx+perpy*perpy);perpx=perpx/dist*w;perpy=perpy/dist*w;result.push(p2x-perpx,p2y-perpy,p2x+perpx,p2y+perpy);for(i=1;i<length;i++){indices.push(indexBase+(i-1)*2,indexBase+(i-1)*2+1,indexBase+i*2+1,indexBase+i*2+1,indexBase+i*2,indexBase+(i-1)*2);}return result;}},{key:"createLineTriangle",value:function createLineTriangle(path,color,width,loop,outvb,vbstride,outib){var points=path.slice();var ptlen=points.length;var p1x=points[0],p1y=points[1];var p2x=points[2],p2y=points[2];var len=0;var rp=0;var dx=0,dy=0;var pointnum=ptlen/2;if(pointnum<=1)return;if(pointnum==2){return;}var tmpData=new Array(pointnum*4);var realPtNum=0;var ci=0;for(var i=0;i<pointnum-1;i++){p1x=points[ci++],p1y=points[ci++];p2x=points[ci++],p2y=points[ci++];dx=p2x-p1x,dy=p2y-p1y;if(dx!=0&&dy!=0){len=Math.sqrt(dx*dx+dy*dy);if(len>1e-3){rp=realPtNum*4;tmpData[rp]=p1x;tmpData[rp+1]=p1y;tmpData[rp+2]=dx/len;tmpData[rp+3]=dy/len;realPtNum++;}}}if(loop){p1x=points[ptlen-2],p1y=points[ptlen-1];p2x=points[0],p2y=points[1];dx=p2x-p1x,dy=p2y-p1y;if(dx!=0&&dy!=0){len=Math.sqrt(dx*dx+dy*dy);if(len>1e-3){rp=realPtNum*4;tmpData[rp]=p1x;tmpData[rp+1]=p1y;tmpData[rp+2]=dx/len;tmpData[rp+3]=dy/len;realPtNum++;}}}else{rp=realPtNum*4;tmpData[rp]=p1x;tmpData[rp+1]=p1y;tmpData[rp+2]=dx/len;tmpData[rp+3]=dy/len;realPtNum++;}ci=0;for(i=0;i<pointnum;i++){p1x=points[ci],p1y=points[ci+1];p2x=points[ci+2],p2y=points[ci+3];}}}]);return BasePoly;}();BasePoly.tempData=new Array(256);var EarcutNode=function EarcutNode(i,x,y){_classCallCheck(this,EarcutNode);this.i=i;this.x=x;this.y=y;this.prev=null;this.next=null;this.z=null;this.prevZ=null;this.nextZ=null;this.steiner=false;};var Earcut=function(){function Earcut(){_classCallCheck(this,Earcut);}_createClass(Earcut,null,[{key:"earcut",value:function earcut(data,holeIndices,dim){dim=dim||2;var hasHoles=holeIndices&&holeIndices.length,outerLen=hasHoles?holeIndices[0]*dim:data.length,outerNode=Earcut.linkedList(data,0,outerLen,dim,true),triangles=[];if(!outerNode)return triangles;var minX,minY,maxX,maxY,x,y,invSize;if(hasHoles)outerNode=Earcut.eliminateHoles(data,holeIndices,outerNode,dim);if(data.length>80*dim){minX=maxX=data[0];minY=maxY=data[1];for(var i=dim;i<outerLen;i+=dim){x=data[i];y=data[i+1];if(x<minX)minX=x;if(y<minY)minY=y;if(x>maxX)maxX=x;if(y>maxY)maxY=y;}invSize=Math.max(maxX-minX,maxY-minY);invSize=invSize!==0?1/invSize:0;}Earcut.earcutLinked(outerNode,triangles,dim,minX,minY,invSize);return triangles;}},{key:"linkedList",value:function linkedList(data,start,end,dim,clockwise){var i,last;if(clockwise===Earcut.signedArea(data,start,end,dim)>0){for(i=start;i<end;i+=dim){last=Earcut.insertNode(i,data[i],data[i+1],last);}}else{for(i=end-dim;i>=start;i-=dim){last=Earcut.insertNode(i,data[i],data[i+1],last);}}if(last&&Earcut.equals(last,last.next)){Earcut.removeNode(last);last=last.next;}return last;}},{key:"filterPoints",value:function filterPoints(start,end){if(!start)return start;if(!end)end=start;var p=start,again;do{again=false;if(!p.steiner&&(Earcut.equals(p,p.next)||Earcut.area(p.prev,p,p.next)===0)){Earcut.removeNode(p);p=end=p.prev;if(p===p.next)break;again=true;}else{p=p.next;}}while(again||p!==end);return end;}},{key:"earcutLinked",value:function earcutLinked(ear,triangles,dim,minX,minY,invSize){var pass=arguments.length>6&&arguments[6]!==undefined?arguments[6]:null;if(!ear)return;if(!pass&&invSize)Earcut.indexCurve(ear,minX,minY,invSize);var stop=ear,prev,next;while(ear.prev!==ear.next){prev=ear.prev;next=ear.next;if(invSize?Earcut.isEarHashed(ear,minX,minY,invSize):Earcut.isEar(ear)){triangles.push(prev.i/dim);triangles.push(ear.i/dim);triangles.push(next.i/dim);Earcut.removeNode(ear);ear=next.next;stop=next.next;continue;}ear=next;if(ear===stop){if(!pass){Earcut.earcutLinked(Earcut.filterPoints(ear,null),triangles,dim,minX,minY,invSize,1);}else if(pass===1){ear=Earcut.cureLocalIntersections(ear,triangles,dim);Earcut.earcutLinked(ear,triangles,dim,minX,minY,invSize,2);}else if(pass===2){Earcut.splitEarcut(ear,triangles,dim,minX,minY,invSize);}break;}}}},{key:"isEar",value:function isEar(ear){var a=ear.prev,b=ear,c=ear.next;if(Earcut.area(a,b,c)>=0)return false;var p=ear.next.next;while(p!==ear.prev){if(Earcut.pointInTriangle(a.x,a.y,b.x,b.y,c.x,c.y,p.x,p.y)&&Earcut.area(p.prev,p,p.next)>=0)return false;p=p.next;}return true;}},{key:"isEarHashed",value:function isEarHashed(ear,minX,minY,invSize){var a=ear.prev,b=ear,c=ear.next;if(Earcut.area(a,b,c)>=0)return false;var minTX=a.x<b.x?a.x<c.x?a.x:c.x:b.x<c.x?b.x:c.x,minTY=a.y<b.y?a.y<c.y?a.y:c.y:b.y<c.y?b.y:c.y,maxTX=a.x>b.x?a.x>c.x?a.x:c.x:b.x>c.x?b.x:c.x,maxTY=a.y>b.y?a.y>c.y?a.y:c.y:b.y>c.y?b.y:c.y;var minZ=Earcut.zOrder(minTX,minTY,minX,minY,invSize),maxZ=Earcut.zOrder(maxTX,maxTY,minX,minY,invSize);var p=ear.nextZ;while(p&&p.z<=maxZ){if(p!==ear.prev&&p!==ear.next&&Earcut.pointInTriangle(a.x,a.y,b.x,b.y,c.x,c.y,p.x,p.y)&&Earcut.area(p.prev,p,p.next)>=0)return false;p=p.nextZ;}p=ear.prevZ;while(p&&p.z>=minZ){if(p!==ear.prev&&p!==ear.next&&Earcut.pointInTriangle(a.x,a.y,b.x,b.y,c.x,c.y,p.x,p.y)&&Earcut.area(p.prev,p,p.next)>=0)return false;p=p.prevZ;}return true;}},{key:"cureLocalIntersections",value:function cureLocalIntersections(start,triangles,dim){var p=start;do{var a=p.prev,b=p.next.next;if(!Earcut.equals(a,b)&&Earcut.intersects(a,p,p.next,b)&&Earcut.locallyInside(a,b)&&Earcut.locallyInside(b,a)){triangles.push(a.i/dim);triangles.push(p.i/dim);triangles.push(b.i/dim);Earcut.removeNode(p);Earcut.removeNode(p.next);p=start=b;}p=p.next;}while(p!==start);return p;}},{key:"splitEarcut",value:function splitEarcut(start,triangles,dim,minX,minY,invSize){var a=start;do{var b=a.next.next;while(b!==a.prev){if(a.i!==b.i&&Earcut.isValidDiagonal(a,b)){var c=Earcut.splitPolygon(a,b);a=Earcut.filterPoints(a,a.next);c=Earcut.filterPoints(c,c.next);Earcut.earcutLinked(a,triangles,dim,minX,minY,invSize);Earcut.earcutLinked(c,triangles,dim,minX,minY,invSize);return;}b=b.next;}a=a.next;}while(a!==start);}},{key:"eliminateHoles",value:function eliminateHoles(data,holeIndices,outerNode,dim){var queue=[],i,len,start,end,list;for(i=0,len=holeIndices.length;i<len;i++){start=holeIndices[i]*dim;end=i<len-1?holeIndices[i+1]*dim:data.length;list=Earcut.linkedList(data,start,end,dim,false);if(list===list.next)list.steiner=true;queue.push(Earcut.getLeftmost(list));}queue.sort(Earcut.compareX);for(i=0;i<queue.length;i++){Earcut.eliminateHole(queue[i],outerNode);outerNode=Earcut.filterPoints(outerNode,outerNode.next);}return outerNode;}},{key:"compareX",value:function compareX(a,b){return a.x-b.x;}},{key:"eliminateHole",value:function eliminateHole(hole,outerNode){outerNode=Earcut.findHoleBridge(hole,outerNode);if(outerNode){var b=Earcut.splitPolygon(outerNode,hole);Earcut.filterPoints(b,b.next);}}},{key:"findHoleBridge",value:function findHoleBridge(hole,outerNode){var p=outerNode,hx=hole.x,hy=hole.y,qx=-Infinity,m;do{if(hy<=p.y&&hy>=p.next.y&&p.next.y!==p.y){var x=p.x+(hy-p.y)*(p.next.x-p.x)/(p.next.y-p.y);if(x<=hx&&x>qx){qx=x;if(x===hx){if(hy===p.y)return p;if(hy===p.next.y)return p.next;}m=p.x<p.next.x?p:p.next;}}p=p.next;}while(p!==outerNode);if(!m)return null;if(hx===qx)return m.prev;var stop=m,mx=m.x,my=m.y,tanMin=Infinity,tan;p=m.next;while(p!==stop){if(hx>=p.x&&p.x>=mx&&hx!==p.x&&Earcut.pointInTriangle(hy<my?hx:qx,hy,mx,my,hy<my?qx:hx,hy,p.x,p.y)){tan=Math.abs(hy-p.y)/(hx-p.x);if((tan<tanMin||tan===tanMin&&p.x>m.x)&&Earcut.locallyInside(p,hole)){m=p;tanMin=tan;}}p=p.next;}return m;}},{key:"indexCurve",value:function indexCurve(start,minX,minY,invSize){var p=start;do{if(p.z===null)p.z=Earcut.zOrder(p.x,p.y,minX,minY,invSize);p.prevZ=p.prev;p.nextZ=p.next;p=p.next;}while(p!==start);p.prevZ.nextZ=null;p.prevZ=null;Earcut.sortLinked(p);}},{key:"sortLinked",value:function sortLinked(list){var i,p,q,e,tail,numMerges,pSize,qSize,inSize=1;do{p=list;list=null;tail=null;numMerges=0;while(p){numMerges++;q=p;pSize=0;for(i=0;i<inSize;i++){pSize++;q=q.nextZ;if(!q)break;}qSize=inSize;while(pSize>0||qSize>0&&q){if(pSize!==0&&(qSize===0||!q||p.z<=q.z)){e=p;p=p.nextZ;pSize--;}else{e=q;q=q.nextZ;qSize--;}if(tail)tail.nextZ=e;else list=e;e.prevZ=tail;tail=e;}p=q;}tail.nextZ=null;inSize*=2;}while(numMerges>1);return list;}},{key:"zOrder",value:function zOrder(x,y,minX,minY,invSize){x=32767*(x-minX)*invSize;y=32767*(y-minY)*invSize;x=(x|x<<8)&0x00FF00FF;x=(x|x<<4)&0x0F0F0F0F;x=(x|x<<2)&0x33333333;x=(x|x<<1)&0x55555555;y=(y|y<<8)&0x00FF00FF;y=(y|y<<4)&0x0F0F0F0F;y=(y|y<<2)&0x33333333;y=(y|y<<1)&0x55555555;return x|y<<1;}},{key:"getLeftmost",value:function getLeftmost(start){var p=start,leftmost=start;do{if(p.x<leftmost.x)leftmost=p;p=p.next;}while(p!==start);return leftmost;}},{key:"pointInTriangle",value:function pointInTriangle(ax,ay,bx,by,cx,cy,px,py){return(cx-px)*(ay-py)-(ax-px)*(cy-py)>=0&&(ax-px)*(by-py)-(bx-px)*(ay-py)>=0&&(bx-px)*(cy-py)-(cx-px)*(by-py)>=0;}},{key:"isValidDiagonal",value:function isValidDiagonal(a,b){return a.next.i!==b.i&&a.prev.i!==b.i&&!Earcut.intersectsPolygon(a,b)&&Earcut.locallyInside(a,b)&&Earcut.locallyInside(b,a)&&Earcut.middleInside(a,b);}},{key:"area",value:function area(p,q,r){return(q.y-p.y)*(r.x-q.x)-(q.x-p.x)*(r.y-q.y);}},{key:"equals",value:function equals(p1,p2){return p1.x===p2.x&&p1.y===p2.y;}},{key:"intersects",value:function intersects(p1,q1,p2,q2){if(Earcut.equals(p1,q1)&&Earcut.equals(p2,q2)||Earcut.equals(p1,q2)&&Earcut.equals(p2,q1))return true;return Earcut.area(p1,q1,p2)>0!==Earcut.area(p1,q1,q2)>0&&Earcut.area(p2,q2,p1)>0!==Earcut.area(p2,q2,q1)>0;}},{key:"intersectsPolygon",value:function intersectsPolygon(a,b){var p=a;do{if(p.i!==a.i&&p.next.i!==a.i&&p.i!==b.i&&p.next.i!==b.i&&Earcut.intersects(p,p.next,a,b))return true;p=p.next;}while(p!==a);return false;}},{key:"locallyInside",value:function locallyInside(a,b){return Earcut.area(a.prev,a,a.next)<0?Earcut.area(a,b,a.next)>=0&&Earcut.area(a,a.prev,b)>=0:Earcut.area(a,b,a.prev)<0||Earcut.area(a,a.next,b)<0;}},{key:"middleInside",value:function middleInside(a,b){var p=a,inside=false,px=(a.x+b.x)/2,py=(a.y+b.y)/2;do{if(p.y>py!==p.next.y>py&&p.next.y!==p.y&&px<(p.next.x-p.x)*(py-p.y)/(p.next.y-p.y)+p.x)inside=!inside;p=p.next;}while(p!==a);return inside;}},{key:"splitPolygon",value:function splitPolygon(a,b){var a2=new EarcutNode(a.i,a.x,a.y),b2=new EarcutNode(b.i,b.x,b.y),an=a.next,bp=b.prev;a.next=b;b.prev=a;a2.next=an;an.prev=a2;b2.next=a2;a2.prev=b2;bp.next=b2;b2.prev=bp;return b2;}},{key:"insertNode",value:function insertNode(i,x,y,last){var p=new EarcutNode(i,x,y);if(!last){p.prev=p;p.next=p;}else{p.next=last.next;p.prev=last;last.next.prev=p;last.next=p;}return p;}},{key:"removeNode",value:function removeNode(p){p.next.prev=p.prev;p.prev.next=p.next;if(p.prevZ)p.prevZ.nextZ=p.nextZ;if(p.nextZ)p.nextZ.prevZ=p.prevZ;}},{key:"signedArea",value:function signedArea(data,start,end,dim){var sum=0;for(var i=start,j=end-dim;i<end;i+=dim){sum+=(data[j]-data[i])*(data[i+1]+data[j+1]);j=i;}return sum;}}]);return Earcut;}();var CONST3D2D=function CONST3D2D(){_classCallCheck(this,CONST3D2D);};CONST3D2D.BYTES_PE=4;CONST3D2D.BYTES_PIDX=2;CONST3D2D.defaultMatrix4=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];CONST3D2D.defaultMinusYMatrix4=[1,0,0,0,0,-1,0,0,0,0,1,0,0,0,0,1];CONST3D2D.uniformMatrix3=[1,0,0,0,0,1,0,0,0,0,1,0];CONST3D2D._TMPARRAY=[];CONST3D2D._OFFSETX=0;CONST3D2D._OFFSETY=0;var Submit=function(_SubmitBase){_inherits(Submit,_SubmitBase);function Submit(){var renderType=arguments.length>0&&arguments[0]!==undefined?arguments[0]:SubmitBase.TYPE_2D;_classCallCheck(this,Submit);return _possibleConstructorReturn(this,(Submit.__proto__||Object.getPrototypeOf(Submit)).call(this,renderType));}_createClass(Submit,[{key:"renderSubmit",value:function renderSubmit(){if(this._numEle===0||!this._mesh||this._numEle==0)return 1;var _tex=this.shaderValue.textureHost;if(_tex){var source=_tex._getSource();if(!source)return 1;this.shaderValue.texture=source;}var gl=WebGLContext.mainContext;this._mesh.useMesh(gl);this.shaderValue.upload();if(BlendMode.activeBlendFunction!==this._blendFn){WebGLContext.setBlend(gl,true);this._blendFn(gl);BlendMode.activeBlendFunction=this._blendFn;}gl.drawElements(gl.TRIANGLES,this._numEle,gl.UNSIGNED_SHORT,this._startIdx);Stat.renderBatches++;Stat.trianglesFaces+=this._numEle/3;return 1;}},{key:"releaseRender",value:function releaseRender(){if(SubmitBase.RENDERBASE==this)return;if(--this._ref<1){Submit.POOL[Submit._poolSize++]=this;this.shaderValue.release();this.shaderValue=null;this._mesh=null;this._parent&&(this._parent.releaseRender(),this._parent=null);}}}],[{key:"create",value:function create(context,mesh,sv){var o=Submit._poolSize?Submit.POOL[--Submit._poolSize]:new Submit();o._ref=1;o._mesh=mesh;o._key.clear();o._startIdx=mesh.indexNum*CONST3D2D.BYTES_PIDX;o._numEle=0;var blendType=context._nBlendType;o._blendFn=context._targets?BlendMode.targetFns[blendType]:BlendMode.fns[blendType];o.shaderValue=sv;o.shaderValue.setValue(context._shader2D);var filters=context._shader2D.filters;filters&&o.shaderValue.setFilters(filters);return o;}},{key:"createShape",value:function createShape(ctx,mesh,numEle,sv){var o=Submit._poolSize?Submit.POOL[--Submit._poolSize]:new Submit();o._mesh=mesh;o._numEle=numEle;o._startIdx=mesh.indexNum*2;o._ref=1;o.shaderValue=sv;o.shaderValue.setValue(ctx._shader2D);var blendType=ctx._nBlendType;o._key.blendShader=blendType;o._blendFn=ctx._targets?BlendMode.targetFns[blendType]:BlendMode.fns[blendType];return o;}}]);return Submit;}(SubmitBase);Submit._poolSize=0;Submit.POOL=[];var SubmitCanvas=function(_SubmitBase2){_inherits(SubmitCanvas,_SubmitBase2);function SubmitCanvas(){_classCallCheck(this,SubmitCanvas);var _this21=_possibleConstructorReturn(this,(SubmitCanvas.__proto__||Object.getPrototypeOf(SubmitCanvas)).call(this,SubmitBase.TYPE_2D));_this21._matrix=new Matrix();_this21._matrix4=CONST3D2D.defaultMatrix4.concat();_this21.shaderValue=new Value2D(0,0);return _this21;}_createClass(SubmitCanvas,[{key:"renderSubmit",value:function renderSubmit(){var preAlpha=RenderState2D.worldAlpha;var preMatrix4=RenderState2D.worldMatrix4;var preMatrix=RenderState2D.worldMatrix;var preFilters=RenderState2D.worldFilters;var preWorldShaderDefines=RenderState2D.worldShaderDefines;var v=this.shaderValue;var m=this._matrix;var m4=this._matrix4;var mout=Matrix.TEMP;Matrix.mul(m,preMatrix,mout);m4[0]=mout.a;m4[1]=mout.b;m4[4]=mout.c;m4[5]=mout.d;m4[12]=mout.tx;m4[13]=mout.ty;RenderState2D.worldMatrix=mout.clone();RenderState2D.worldMatrix4=m4;RenderState2D.worldAlpha=RenderState2D.worldAlpha*v.alpha;if(v.filters&&v.filters.length){RenderState2D.worldFilters=v.filters;RenderState2D.worldShaderDefines=v.defines;}this.canv['flushsubmit']();RenderState2D.worldAlpha=preAlpha;RenderState2D.worldMatrix4=preMatrix4;RenderState2D.worldMatrix.destroy();RenderState2D.worldMatrix=preMatrix;RenderState2D.worldFilters=preFilters;RenderState2D.worldShaderDefines=preWorldShaderDefines;return 1;}},{key:"releaseRender",value:function releaseRender(){if(--this._ref<1){var cache=SubmitCanvas.POOL;this._mesh=null;cache[cache._length++]=this;}}},{key:"getRenderType",value:function getRenderType(){return SubmitBase.TYPE_CANVAS;}}],[{key:"create",value:function create(canvas,alpha,filters){var o=!SubmitCanvas.POOL._length?new SubmitCanvas():SubmitCanvas.POOL[--SubmitCanvas.POOL._length];o.canv=canvas;o._ref=1;o._numEle=0;var v=o.shaderValue;v.alpha=alpha;v.defines.setValue(0);filters&&filters.length&&v.setFilters(filters);return o;}}]);return SubmitCanvas;}(SubmitBase);SubmitCanvas.POOL=[];{SubmitCanvas.POOL._length=0;}var SubmitTarget=function(){function SubmitTarget(){_classCallCheck(this,SubmitTarget);this.blendType=0;this._ref=1;this._key=new SubmitKey();}_createClass(SubmitTarget,[{key:"renderSubmit",value:function renderSubmit(){var gl=WebGLContext.mainContext;this._mesh.useMesh(gl);var target=this.srcRT;if(target){this.shaderValue.texture=target._getSource();this.shaderValue.upload();this.blend();Stat.renderBatches++;Stat.trianglesFaces+=this._numEle/3;gl.drawElements(gl.TRIANGLES,this._numEle,gl.UNSIGNED_SHORT,this._startIdx);}return 1;}},{key:"blend",value:function blend(){if(BlendMode.activeBlendFunction!==BlendMode.fns[this.blendType]){var gl=WebGLContext.mainContext;gl.enable(gl.BLEND);BlendMode.fns[this.blendType](gl);BlendMode.activeBlendFunction=BlendMode.fns[this.blendType];}}},{key:"getRenderType",value:function getRenderType(){return 0;}},{key:"releaseRender",value:function releaseRender(){if(--this._ref<1){var pool=SubmitTarget.POOL;pool[pool._length++]=this;}}}],[{key:"create",value:function create(context,mesh,sv,rt){var o=SubmitTarget.POOL._length?SubmitTarget.POOL[--SubmitTarget.POOL._length]:new SubmitTarget();o._mesh=mesh;o.srcRT=rt;o._startIdx=mesh.indexNum*CONST3D2D.BYTES_PIDX;o._ref=1;o._key.clear();o._numEle=0;o.blendType=context._nBlendType;o._key.blendShader=o.blendType;o.shaderValue=sv;o.shaderValue.setValue(context._shader2D);if(context._colorFiler){var ft=context._colorFiler;sv.defines.add(ft.type);sv.colorMat=ft._mat;sv.colorAlpha=ft._alpha;}return o;}}]);return SubmitTarget;}();SubmitTarget.POOL=[];{SubmitTarget.POOL._length=0;}var SubmitTexture=function(_SubmitBase3){_inherits(SubmitTexture,_SubmitBase3);function SubmitTexture(){var renderType=arguments.length>0&&arguments[0]!==undefined?arguments[0]:SubmitBase.TYPE_2D;_classCallCheck(this,SubmitTexture);return _possibleConstructorReturn(this,(SubmitTexture.__proto__||Object.getPrototypeOf(SubmitTexture)).call(this,renderType));}_createClass(SubmitTexture,[{key:"releaseRender",value:function releaseRender(){if(--this._ref<1){SubmitTexture.POOL[SubmitTexture._poolSize++]=this;this.shaderValue.release();this._mesh=null;this._parent&&(this._parent.releaseRender(),this._parent=null);}}},{key:"renderSubmit",value:function renderSubmit(){if(this._numEle===0)return 1;var tex=this.shaderValue.textureHost;if(tex){var source=tex?tex._getSource():null;if(!source)return 1;}var gl=WebGLContext.mainContext;this._mesh.useMesh(gl);var lastSubmit=SubmitBase.preRender;var prekey=SubmitBase.preRender._key;if(this._key.blendShader===0&&this._key.submitType===prekey.submitType&&this._key.blendShader===prekey.blendShader&&BaseShader.activeShader&&SubmitBase.preRender.clipInfoID==this.clipInfoID&&lastSubmit.shaderValue.defines._value===this.shaderValue.defines._value&&(this.shaderValue.defines._value&ShaderDefines2D.NOOPTMASK)==0){BaseShader.activeShader.uploadTexture2D(source);}else{if(BlendMode.activeBlendFunction!==this._blendFn){WebGLContext.setBlend(gl,true);this._blendFn(gl);BlendMode.activeBlendFunction=this._blendFn;}this.shaderValue.texture=source;this.shaderValue.upload();}gl.drawElements(gl.TRIANGLES,this._numEle,gl.UNSIGNED_SHORT,this._startIdx);Stat.renderBatches++;Stat.trianglesFaces+=this._numEle/3;return 1;}}],[{key:"create",value:function create(context,mesh,sv){var o=SubmitTexture._poolSize?SubmitTexture.POOL[--SubmitTexture._poolSize]:new SubmitTexture(SubmitBase.TYPE_TEXTURE);o._mesh=mesh;o._key.clear();o._key.submitType=SubmitBase.KEY_DRAWTEXTURE;o._ref=1;o._startIdx=mesh.indexNum*CONST3D2D.BYTES_PIDX;o._numEle=0;var blendType=context._nBlendType;o._key.blendShader=blendType;o._blendFn=context._targets?BlendMode.targetFns[blendType]:BlendMode.fns[blendType];o.shaderValue=sv;if(context._colorFiler){var ft=context._colorFiler;sv.defines.add(ft.type);sv.colorMat=ft._mat;sv.colorAlpha=ft._alpha;}return o;}}]);return SubmitTexture;}(SubmitBase);SubmitTexture._poolSize=0;SubmitTexture.POOL=[];var CharSubmitCache=function(){function CharSubmitCache(){_classCallCheck(this,CharSubmitCache);this._data=[];this._ndata=0;this._clipid=-1;this._clipMatrix=new Matrix();this._enable=false;}_createClass(CharSubmitCache,[{key:"clear",value:function clear(){this._tex=null;this._imgId=-1;this._ndata=0;this._enable=false;this._colorFiler=null;}},{key:"destroy",value:function destroy(){this.clear();this._data.length=0;this._data=null;}},{key:"add",value:function add(ctx,tex,imgid,pos,uv,color){if(this._ndata>0&&(this._tex!=tex||this._imgId!=imgid||this._clipid>=0&&this._clipid!=ctx._clipInfoID)){this.submit(ctx);}this._clipid=ctx._clipInfoID;ctx._globalClipMatrix.copyTo(this._clipMatrix);this._tex=tex;this._imgId=imgid;this._colorFiler=ctx._colorFiler;this._data[this._ndata]=pos;this._data[this._ndata+1]=uv;this._data[this._ndata+2]=color;this._ndata+=3;}},{key:"getPos",value:function getPos(){if(CharSubmitCache.__nPosPool==0)return new Array(8);return CharSubmitCache.__posPool[--CharSubmitCache.__nPosPool];}},{key:"enable",value:function enable(value,ctx){if(value===this._enable)return;this._enable=value;this._enable||this.submit(ctx);}},{key:"submit",value:function submit(ctx){var n=this._ndata;if(!n)return;var _mesh=ctx._mesh;var colorFiler=ctx._colorFiler;ctx._colorFiler=this._colorFiler;var submit=SubmitTexture.create(ctx,_mesh,Value2D.create(ShaderDefines2D.TEXTURE2D,0));ctx._submits[ctx._submits._length++]=ctx._curSubmit=submit;submit.shaderValue.textureHost=this._tex;submit._key.other=this._imgId;ctx._colorFiler=colorFiler;ctx._copyClipInfo(submit,this._clipMatrix);submit.clipInfoID=this._clipid;for(var i=0;i<n;i+=3){_mesh.addQuad(this._data[i],this._data[i+1],this._data[i+2],true);CharSubmitCache.__posPool[CharSubmitCache.__nPosPool++]=this._data[i];}n/=3;submit._numEle+=n*6;_mesh.indexNum+=n*6;_mesh.vertNum+=n*4;ctx._drawCount+=n;this._ndata=0;if(RenderInfo.loopCount%100==0)this._data.length=0;}}]);return CharSubmitCache;}();CharSubmitCache.__posPool=[];CharSubmitCache.__nPosPool=0;var AtlasGrid=function(){function AtlasGrid(){var width=arguments.length>0&&arguments[0]!==undefined?arguments[0]:0;var height=arguments.length>1&&arguments[1]!==undefined?arguments[1]:0;var id=arguments.length>2&&arguments[2]!==undefined?arguments[2]:0;_classCallCheck(this,AtlasGrid);this.atlasID=0;this._width=0;this._height=0;this._texCount=0;this._rowInfo=null;this._cells=null;this._used=0;this._cells=null;this._rowInfo=null;this.atlasID=id;this._init(width,height);}_createClass(AtlasGrid,[{key:"addRect",value:function addRect(type,width,height,pt){if(!this._get(width,height,pt))return false;this._fill(pt.x,pt.y,width,height,type);this._texCount++;return true;}},{key:"_release",value:function _release(){this._cells=null;this._rowInfo=null;}},{key:"_init",value:function _init(width,height){this._width=width;this._height=height;this._release();if(this._width==0)return false;this._cells=new Uint8Array(this._width*this._height*3);this._rowInfo=new Uint8Array(this._height);this._used=0;this._clear();return true;}},{key:"_get",value:function _get(width,height,pt){if(width>this._width||height>this._height){return false;}var rx=-1;var ry=-1;var nWidth=this._width;var nHeight=this._height;var pCellBox=this._cells;for(var y=0;y<nHeight;y++){if(this._rowInfo[y]<width)continue;for(var x=0;x<nWidth;){var tm=(y*nWidth+x)*3;if(pCellBox[tm]!=0||pCellBox[tm+1]<width||pCellBox[tm+2]<height){x+=pCellBox[tm+1];continue;}rx=x;ry=y;for(var xx=0;xx<width;xx++){if(pCellBox[3*xx+tm+2]<height){rx=-1;break;}}if(rx<0){x+=pCellBox[tm+1];continue;}pt.x=rx;pt.y=ry;return true;}}return false;}},{key:"_fill",value:function _fill(x,y,w,h,type){var nWidth=this._width;var nHeghit=this._height;this._check(x+w<=nWidth&&y+h<=nHeghit);for(var yy=y;yy<h+y;++yy){this._check(this._rowInfo[yy]>=w);this._rowInfo[yy]-=w;for(var xx=0;xx<w;xx++){var tm=(x+yy*nWidth+xx)*3;this._check(this._cells[tm]==0);this._cells[tm]=type;this._cells[tm+1]=w;this._cells[tm+2]=h;}}if(x>0){for(yy=0;yy<h;++yy){var s=0;for(xx=x-1;xx>=0;--xx,++s){if(this._cells[((y+yy)*nWidth+xx)*3]!=0)break;}for(xx=s;xx>0;--xx){this._cells[((y+yy)*nWidth+x-xx)*3+1]=xx;this._check(xx>0);}}}if(y>0){for(xx=x;xx<x+w;++xx){s=0;for(yy=y-1;yy>=0;--yy,s++){if(this._cells[(xx+yy*nWidth)*3]!=0)break;}for(yy=s;yy>0;--yy){this._cells[(xx+(y-yy)*nWidth)*3+2]=yy;this._check(yy>0);}}}this._used+=w*h/(this._width*this._height);}},{key:"_check",value:function _check(ret){if(ret==false){console.log("xtexMerger ");}}},{key:"_clear",value:function _clear(){this._texCount=0;for(var y=0;y<this._height;y++){this._rowInfo[y]=this._width;}for(var i=0;i<this._height;i++){for(var j=0;j<this._width;j++){var tm=(i*this._width+j)*3;this._cells[tm]=0;this._cells[tm+1]=this._width-j;this._cells[tm+2]=this._width-i;}}}}]);return AtlasGrid;}();var TextTexture=function(_Resource3){_inherits(TextTexture,_Resource3);function TextTexture(textureW,textureH){_classCallCheck(this,TextTexture);var _this23=_possibleConstructorReturn(this,(TextTexture.__proto__||Object.getPrototypeOf(TextTexture)).call(this));_this23._texW=0;_this23._texH=0;_this23.__destroyed=false;_this23._discardTm=0;_this23.genID=0;_this23.bitmap={id:0,_glTexture:null};_this23.curUsedCovRate=0;_this23.curUsedCovRateAtlas=0;_this23.lastTouchTm=0;_this23.ri=null;_this23._texW=textureW||TextTexture.gTextRender.atlasWidth;_this23._texH=textureH||TextTexture.gTextRender.atlasWidth;_this23.bitmap.id=_this23.id;_this23.lock=true;return _this23;}_createClass(TextTexture,[{key:"recreateResource",value:function recreateResource(){if(this._source)return;var gl=LayaGL.instance;var glTex=this._source=gl.createTexture();this.bitmap._glTexture=glTex;WebGLContext.bindTexture(gl,gl.TEXTURE_2D,glTex);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,this._texW,this._texH,0,gl.RGBA,gl.UNSIGNED_BYTE,null);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);if(TextTexture.gTextRender.debugUV){this.fillWhite();}}},{key:"addChar",value:function addChar(data,x,y){var uv=arguments.length>3&&arguments[3]!==undefined?arguments[3]:null;if(TextTexture.gTextRender.isWan1Wan){return this.addCharCanvas(data,x,y,uv);}!this._source&&this.recreateResource();var gl=LayaGL.instance;WebGLContext.bindTexture(gl,gl.TEXTURE_2D,this._source);!ILaya.Render.isConchApp&&gl.pixelStorei(gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,true);var dt=data.data;if(data.data instanceof Uint8ClampedArray)dt=new Uint8Array(dt.buffer);gl.texSubImage2D(gl.TEXTURE_2D,0,x,y,data.width,data.height,gl.RGBA,gl.UNSIGNED_BYTE,dt);!ILaya.Render.isConchApp&&gl.pixelStorei(gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,false);var u0;var v0;var u1;var v1;u0=x/this._texW;v0=y/this._texH;u1=(x+data.width)/this._texW;v1=(y+data.height)/this._texH;uv=uv||new Array(8);uv[0]=u0,uv[1]=v0;uv[2]=u1,uv[3]=v0;uv[4]=u1,uv[5]=v1;uv[6]=u0,uv[7]=v1;return uv;}},{key:"addCharCanvas",value:function addCharCanvas(canv,x,y){var uv=arguments.length>3&&arguments[3]!==undefined?arguments[3]:null;!this._source&&this.recreateResource();var gl=LayaGL.instance;WebGLContext.bindTexture(gl,gl.TEXTURE_2D,this._source);!ILaya.Render.isConchApp&&gl.pixelStorei(gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,true);gl.texSubImage2D(gl.TEXTURE_2D,0,x,y,gl.RGBA,gl.UNSIGNED_BYTE,canv);!ILaya.Render.isConchApp&&gl.pixelStorei(gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,false);var u0;var v0;var u1;var v1;if(ILaya.Render.isConchApp){u0=x/this._texW;v0=y/this._texH;u1=(x+canv.width)/this._texW;v1=(y+canv.height)/this._texH;}else{u0=(x+1)/this._texW;v0=(y+1)/this._texH;u1=(x+canv.width-1)/this._texW;v1=(y+canv.height-1)/this._texH;}uv=uv||new Array(8);uv[0]=u0,uv[1]=v0;uv[2]=u1,uv[3]=v0;uv[4]=u1,uv[5]=v1;uv[6]=u0,uv[7]=v1;return uv;}},{key:"fillWhite",value:function fillWhite(){!this._source&&this.recreateResource();var gl=LayaGL.instance;var dt=new Uint8Array(this._texW*this._texH*4);dt.fill(0xff);gl.texSubImage2D(gl.TEXTURE_2D,0,0,0,this._texW,this._texH,gl.RGBA,gl.UNSIGNED_BYTE,dt);}},{key:"discard",value:function discard(){ILaya.stage.setGlobalRepaint();this.destroy();return;if(this._texW!=TextTexture.gTextRender.atlasWidth||this._texH!=TextTexture.gTextRender.atlasWidth){this.destroy();return;}this.genID++;if(TextTexture.poolLen>=TextTexture.pool.length){TextTexture.pool=TextTexture.pool.concat(new Array(10));}this._discardTm=RenderInfo.loopStTm;TextTexture.pool[TextTexture.poolLen++]=this;}},{key:"destroy",value:function destroy(){this.__destroyed=true;var gl=LayaGL.instance;this._source&&gl.deleteTexture(this._source);this._source=null;}},{key:"touchRect",value:function touchRect(ri,curloop){if(this.lastTouchTm!=curloop){this.curUsedCovRate=0;this.curUsedCovRateAtlas=0;this.lastTouchTm=curloop;}var texw2=TextTexture.gTextRender.atlasWidth*TextTexture.gTextRender.atlasWidth;var gridw2=ILaya.TextAtlas.atlasGridW*ILaya.TextAtlas.atlasGridW;this.curUsedCovRate+=ri.bmpWidth*ri.bmpHeight/texw2;this.curUsedCovRateAtlas+=Math.ceil(ri.bmpWidth/ILaya.TextAtlas.atlasGridW)*Math.ceil(ri.bmpHeight/ILaya.TextAtlas.atlasGridW)/(texw2/gridw2);}},{key:"_getSource",value:function _getSource(){return this._source;}},{key:"drawOnScreen",value:function drawOnScreen(x,y){}},{key:"texture",get:function get(){return this;}}],[{key:"getTextTexture",value:function getTextTexture(w,h){return new TextTexture(w,h);if(w!=TextTexture.gTextRender.atlasWidth||w!=TextTexture.gTextRender.atlasWidth)return new TextTexture(w,h);if(TextTexture.poolLen>0){var ret=TextTexture.pool[--TextTexture.poolLen];if(TextTexture.poolLen>0)TextTexture.clean();return ret;}return new TextTexture(w,h);}},{key:"clean",value:function clean(){var curtm=RenderInfo.loopStTm;if(TextTexture.cleanTm===0)TextTexture.cleanTm=curtm;if(curtm-TextTexture.cleanTm>=TextTexture.gTextRender.checkCleanTextureDt){for(var i=0;i<TextTexture.poolLen;i++){var p=TextTexture.pool[i];if(curtm-p._discardTm>=TextTexture.gTextRender.destroyUnusedTextureDt){p.destroy();TextTexture.pool[i]=TextTexture.pool[TextTexture.poolLen-1];TextTexture.poolLen--;i--;}}TextTexture.cleanTm=curtm;}}}]);return TextTexture;}(Resource);TextTexture.gTextRender=null;TextTexture.pool=new Array(10);TextTexture.poolLen=0;TextTexture.cleanTm=0;var TextAtlas=function(){function TextAtlas(){_classCallCheck(this,TextAtlas);this.texWidth=1024;this.texHeight=1024;this.texture=null;this.charMaps={};this.texHeight=this.texWidth=ILaya.TextRender.atlasWidth;this.texture=TextTexture.getTextTexture(this.texWidth,this.texHeight);if(this.texWidth/TextAtlas.atlasGridW>256){TextAtlas.atlasGridW=Math.ceil(this.texWidth/256);}this.atlasgrid=new AtlasGrid(this.texWidth/TextAtlas.atlasGridW,this.texHeight/TextAtlas.atlasGridW,this.texture.id);}_createClass(TextAtlas,[{key:"setProtecteDist",value:function setProtecteDist(d){}},{key:"getAEmpty",value:function getAEmpty(w,h,pt){var find=this.atlasgrid.addRect(1,Math.ceil(w/TextAtlas.atlasGridW),Math.ceil(h/TextAtlas.atlasGridW),pt);if(find){pt.x*=TextAtlas.atlasGridW;pt.y*=TextAtlas.atlasGridW;}return find;}},{key:"destroy",value:function destroy(){for(var k in this.charMaps){var ri=this.charMaps[k];ri.deleted=true;}this.texture.discard();}},{key:"printDebugInfo",value:function printDebugInfo(){}},{key:"usedRate",get:function get(){return this.atlasgrid._used;}}]);return TextAtlas;}();TextAtlas.atlasGridW=16;var Event=function(){function Event(){_classCallCheck(this,Event);}_createClass(Event,[{key:"setTo",value:function setTo(type,currentTarget,target){this.type=type;this.currentTarget=currentTarget;this.target=target;return this;}},{key:"stopPropagation",value:function stopPropagation(){this._stoped=true;}},{key:"touches",get:function get(){if(!this.nativeEvent)return null;var arr=this.nativeEvent.touches;if(arr){var stage=ILaya.stage;for(var i=0,n=arr.length;i<n;i++){var e=arr[i];var point=Point.TEMP;point.setTo(e.clientX,e.clientY);stage._canvasTransform.invertTransformPoint(point);stage.transform.invertTransformPoint(point);e.stageX=point.x;e.stageY=point.y;}}return arr;}},{key:"altKey",get:function get(){return this.nativeEvent.altKey;}},{key:"ctrlKey",get:function get(){return this.nativeEvent.ctrlKey;}},{key:"shiftKey",get:function get(){return this.nativeEvent.shiftKey;}},{key:"charCode",get:function get(){return this.nativeEvent.charCode;}},{key:"keyLocation",get:function get(){return this.nativeEvent.location||this.nativeEvent.keyLocation;}},{key:"stageX",get:function get(){return ILaya.stage.mouseX;}},{key:"stageY",get:function get(){return ILaya.stage.mouseY;}}]);return Event;}();Event.EMPTY=new Event();Event.MOUSE_DOWN="mousedown";Event.MOUSE_UP="mouseup";Event.CLICK="click";Event.RIGHT_MOUSE_DOWN="rightmousedown";Event.RIGHT_MOUSE_UP="rightmouseup";Event.RIGHT_CLICK="rightclick";Event.MOUSE_MOVE="mousemove";Event.MOUSE_OVER="mouseover";Event.MOUSE_OUT="mouseout";Event.MOUSE_WHEEL="mousewheel";Event.ROLL_OVER="mouseover";Event.ROLL_OUT="mouseout";Event.DOUBLE_CLICK="doubleclick";Event.CHANGE="change";Event.CHANGED="changed";Event.RESIZE="resize";Event.ADDED="added";Event.REMOVED="removed";Event.DISPLAY="display";Event.UNDISPLAY="undisplay";Event.ERROR="error";Event.COMPLETE="complete";Event.LOADED="loaded";Event.READY="ready";Event.PROGRESS="progress";Event.INPUT="input";Event.RENDER="render";Event.OPEN="open";Event.MESSAGE="message";Event.CLOSE="close";Event.KEY_DOWN="keydown";Event.KEY_PRESS="keypress";Event.KEY_UP="keyup";Event.FRAME="enterframe";Event.DRAG_START="dragstart";Event.DRAG_MOVE="dragmove";Event.DRAG_END="dragend";Event.ENTER="enter";Event.SELECT="select";Event.BLUR="blur";Event.FOCUS="focus";Event.VISIBILITY_CHANGE="visibilitychange";Event.FOCUS_CHANGE="focuschange";Event.PLAYED="played";Event.PAUSED="paused";Event.STOPPED="stopped";Event.START="start";Event.END="end";Event.COMPONENT_ADDED="componentadded";Event.COMPONENT_REMOVED="componentremoved";Event.RELEASED="released";Event.LINK="link";Event.LABEL="label";Event.FULL_SCREEN_CHANGE="fullscreenchange";Event.DEVICE_LOST="devicelost";Event.TRANSFORM_CHANGED="transformchanged";Event.ANIMATION_CHANGED="animationchanged";Event.TRAIL_FILTER_CHANGE="trailfilterchange";Event.TRIGGER_ENTER="triggerenter";Event.TRIGGER_STAY="triggerstay";Event.TRIGGER_EXIT="triggerexit";var Texture=function(_EventDispatcher2){_inherits(Texture,_EventDispatcher2);function Texture(){var bitmap=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;var uv=arguments.length>1&&arguments[1]!==undefined?arguments[1]:null;var sourceWidth=arguments.length>2&&arguments[2]!==undefined?arguments[2]:0;var sourceHeight=arguments.length>3&&arguments[3]!==undefined?arguments[3]:0;_classCallCheck(this,Texture);var _this24=_possibleConstructorReturn(this,(Texture.__proto__||Object.getPrototypeOf(Texture)).call(this));_this24.uvrect=[0,0,1,1];_this24._destroyed=false;_this24._referenceCount=0;_this24.$_GID=0;_this24.offsetX=0;_this24.offsetY=0;_this24._w=0;_this24._h=0;_this24.sourceWidth=0;_this24.sourceHeight=0;_this24.url=null;_this24.scaleRate=1;_this24.setTo(bitmap,uv,sourceWidth,sourceHeight);return _this24;}_createClass(Texture,[{key:"_addReference",value:function _addReference(){this._bitmap&&this._bitmap._addReference();this._referenceCount++;}},{key:"_removeReference",value:function _removeReference(){this._bitmap&&this._bitmap._removeReference();this._referenceCount--;}},{key:"_getSource",value:function _getSource(){var cb=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;if(this._destroyed||!this._bitmap)return null;this.recoverBitmap(cb);return this._bitmap.destroyed?null:this.bitmap._getSource();}},{key:"_onLoaded",value:function _onLoaded(complete,context){if(!context);else if(context==this);else if(context instanceof Texture){var tex=context;Texture._create(context,0,0,tex.width,tex.height,0,0,tex.sourceWidth,tex.sourceHeight,this);}else{this.bitmap=context;this.sourceWidth=this._w=context.width;this.sourceHeight=this._h=context.height;}complete&&complete.run();this.event(Event.READY,this);}},{key:"getIsReady",value:function getIsReady(){return this._destroyed?false:this._bitmap?true:false;}},{key:"setTo",value:function setTo(){var bitmap=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;var uv=arguments.length>1&&arguments[1]!==undefined?arguments[1]:null;var sourceWidth=arguments.length>2&&arguments[2]!==undefined?arguments[2]:0;var sourceHeight=arguments.length>3&&arguments[3]!==undefined?arguments[3]:0;this.bitmap=bitmap;this.sourceWidth=sourceWidth;this.sourceHeight=sourceHeight;if(bitmap){this._w=bitmap.width;this._h=bitmap.height;this.sourceWidth=this.sourceWidth||bitmap.width;this.sourceHeight=this.sourceHeight||bitmap.height;}this.uv=uv||Texture.DEF_UV;}},{key:"load",value:function load(url){var complete=arguments.length>1&&arguments[1]!==undefined?arguments[1]:null;if(!this._destroyed)ILaya.loader.load(url,Handler.create(this,this._onLoaded,[complete]),null,"htmlimage",1,true);}},{key:"getTexturePixels",value:function getTexturePixels(x,y,width,height){var st,dst,i;var tex2d=this.bitmap;var texw=tex2d.width;var texh=tex2d.height;if(x+width>texw)width-=x+width-texw;if(y+height>texh)height-=y+height-texh;if(width<=0||height<=0)return null;var wstride=width*4;var pix=null;try{pix=tex2d.getPixels();}catch(e){}if(pix){if(x==0&&y==0&&width==texw&&height==texh)return pix;var ret=new Uint8Array(width*height*4);wstride=texw*4;st=x*4;dst=(y+height-1)*wstride+x*4;for(i=height-1;i>=0;i--){ret.set(dt.slice(dst,dst+width*4),st);st+=wstride;dst-=wstride;}return ret;}var ctx=new ILaya.Context();ctx.size(width,height);ctx.asBitmap=true;var uv=null;if(x!=0||y!=0||width!=texw||height!=texh){uv=this._uv.slice();var stu=uv[0];var stv=uv[1];var uvw=uv[2]-stu;var uvh=uv[7]-stv;var uk=uvw/texw;var vk=uvh/texh;uv=[stu+x*uk,stv+y*vk,stu+(x+width)*uk,stv+y*vk,stu+(x+width)*uk,stv+(y+height)*vk,stu+x*uk,stv+(y+height)*vk];}ctx._drawTextureM(this,0,0,width,height,null,1.0,uv);ctx._targets.start();ctx.flush();ctx._targets.end();ctx._targets.restore();var dt=ctx._targets.getData(0,0,width,height);ctx.destroy();ret=new Uint8Array(width*height*4);st=0;dst=(height-1)*wstride;for(i=height-1;i>=0;i--){ret.set(dt.slice(dst,dst+wstride),st);st+=wstride;dst-=wstride;}return ret;}},{key:"getPixels",value:function getPixels(x,y,width,height){if(window.conch){return this._nativeObj.getImageData(x,y,width,height);}else{return this.getTexturePixels(x,y,width,height);}}},{key:"recoverBitmap",value:function recoverBitmap(){var onok=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;var url=this._bitmap.url;if(!this._destroyed&&(!this._bitmap||this._bitmap.destroyed)&&url){ILaya.loader.load(url,Handler.create(this,function(bit){this.bitmap=bit;onok&&onok();}),null,"htmlimage",1,true);}}},{key:"disposeBitmap",value:function disposeBitmap(){if(!this._destroyed&&this._bitmap){this._bitmap.destroy();}}},{key:"destroy",value:function destroy(){var force=arguments.length>0&&arguments[0]!==undefined?arguments[0]:false;if(!this._destroyed){this._destroyed=true;var bit=this._bitmap;if(bit){bit._removeReference(this._referenceCount);if(bit.referenceCount===0||force)bit.destroy();bit=null;}if(this.url&&this===ILaya.loader.getRes(this.url))ILaya.Loader.clearRes(this.url);}}},{key:"uv",get:function get(){return this._uv;},set:function set(value){this.uvrect[0]=Math.min(value[0],value[2],value[4],value[6]);this.uvrect[1]=Math.min(value[1],value[3],value[5],value[7]);this.uvrect[2]=Math.max(value[0],value[2],value[4],value[6])-this.uvrect[0];this.uvrect[3]=Math.max(value[1],value[3],value[5],value[7])-this.uvrect[1];this._uv=value;}},{key:"width",get:function get(){if(this._w)return this._w;if(!this.bitmap)return 0;return this.uv&&this.uv!==Texture.DEF_UV?(this.uv[2]-this.uv[0])*this.bitmap.width:this.bitmap.width;},set:function set(value){this._w=value;this.sourceWidth||(this.sourceWidth=value);}},{key:"height",get:function get(){if(this._h)return this._h;if(!this.bitmap)return 0;return this.uv&&this.uv!==Texture.DEF_UV?(this.uv[5]-this.uv[1])*this.bitmap.height:this.bitmap.height;},set:function set(value){this._h=value;this.sourceHeight||(this.sourceHeight=value);}},{key:"bitmap",get:function get(){return this._bitmap;},set:function set(value){this._bitmap&&this._bitmap._removeReference(this._referenceCount);this._bitmap=value;value&&value._addReference(this._referenceCount);}},{key:"destroyed",get:function get(){return this._destroyed;}}],[{key:"moveUV",value:function moveUV(offsetX,offsetY,uv){for(var i=0;i<8;i+=2){uv[i]+=offsetX;uv[i+1]+=offsetY;}return uv;}},{key:"create",value:function create(source,x,y,width,height){var offsetX=arguments.length>5&&arguments[5]!==undefined?arguments[5]:0;var offsetY=arguments.length>6&&arguments[6]!==undefined?arguments[6]:0;var sourceWidth=arguments.length>7&&arguments[7]!==undefined?arguments[7]:0;var sourceHeight=arguments.length>8&&arguments[8]!==undefined?arguments[8]:0;return Texture._create(source,x,y,width,height,offsetX,offsetY,sourceWidth,sourceHeight);}},{key:"_create",value:function _create(source,x,y,width,height){var offsetX=arguments.length>5&&arguments[5]!==undefined?arguments[5]:0;var offsetY=arguments.length>6&&arguments[6]!==undefined?arguments[6]:0;var sourceWidth=arguments.length>7&&arguments[7]!==undefined?arguments[7]:0;var sourceHeight=arguments.length>8&&arguments[8]!==undefined?arguments[8]:0;var outTexture=arguments.length>9&&arguments[9]!==undefined?arguments[9]:null;var btex=source instanceof Texture;var uv=btex?source.uv:Texture.DEF_UV;var bitmap=btex?source.bitmap:source;if(bitmap.width&&x+width>bitmap.width)width=bitmap.width-x;if(bitmap.height&&y+height>bitmap.height)height=bitmap.height-y;var tex;if(outTexture){tex=outTexture;tex.setTo(bitmap,null,sourceWidth||width,sourceHeight||height);}else{tex=new Texture(bitmap,null,sourceWidth||width,sourceHeight||height);}tex.width=width;tex.height=height;tex.offsetX=offsetX;tex.offsetY=offsetY;var dwidth=1/bitmap.width;var dheight=1/bitmap.height;x*=dwidth;y*=dheight;width*=dwidth;height*=dheight;var u1=tex.uv[0],v1=tex.uv[1],u2=tex.uv[4],v2=tex.uv[5];var inAltasUVWidth=u2-u1,inAltasUVHeight=v2-v1;var oriUV=Texture.moveUV(uv[0],uv[1],[x,y,x+width,y,x+width,y+height,x,y+height]);tex.uv=new Float32Array([u1+oriUV[0]*inAltasUVWidth,v1+oriUV[1]*inAltasUVHeight,u2-(1-oriUV[2])*inAltasUVWidth,v1+oriUV[3]*inAltasUVHeight,u2-(1-oriUV[4])*inAltasUVWidth,v2-(1-oriUV[5])*inAltasUVHeight,u1+oriUV[6]*inAltasUVWidth,v2-(1-oriUV[7])*inAltasUVHeight]);var bitmapScale=bitmap.scaleRate;if(bitmapScale&&bitmapScale!=1){tex.sourceWidth/=bitmapScale;tex.sourceHeight/=bitmapScale;tex.width/=bitmapScale;tex.height/=bitmapScale;tex.scaleRate=bitmapScale;}else{tex.scaleRate=1;}return tex;}},{key:"createFromTexture",value:function createFromTexture(texture,x,y,width,height){var texScaleRate=texture.scaleRate;if(texScaleRate!=1){x*=texScaleRate;y*=texScaleRate;width*=texScaleRate;height*=texScaleRate;}var rect=Rectangle.TEMP.setTo(x-texture.offsetX,y-texture.offsetY,width,height);var result=rect.intersection(Texture._rect1.setTo(0,0,texture.width,texture.height),Texture._rect2);if(result)var tex=Texture.create(texture,result.x,result.y,result.width,result.height,result.x-rect.x,result.y-rect.y,width,height);else return null;return tex;}}]);return Texture;}(EventDispatcher);Texture.DEF_UV=new Float32Array([0,0,1.0,0,1.0,1.0,0,1.0]);Texture.NO_UV=new Float32Array([0,0,0,0,0,0,0,0]);Texture.INV_UV=new Float32Array([0,1,1.0,1,1.0,0.0,0,0.0]);Texture._rect1=new Rectangle();Texture._rect2=new Rectangle();var FontInfo=function(){function FontInfo(font){_classCallCheck(this,FontInfo);this._font="14px Arial";this._family="Arial";this._size=14;this._italic=false;this._bold=false;this._id=FontInfo._gfontID++;this.setFont(font||this._font);}_createClass(FontInfo,[{key:"setFont",value:function setFont(value){this._font=value;var _words=value.split(' ');var l=_words.length;if(l<2){if(l==1){if(_words[0].indexOf('px')>0){this._size=parseInt(_words[0]);}}return;}var szpos=-1;for(var i=0;i<l;i++){if(_words[i].indexOf('px')>0||_words[i].indexOf('pt')>0){szpos=i;this._size=parseInt(_words[i]);if(this._size<=0){console.error('font parse error:'+value);this._size=14;}break;}}var fpos=szpos+1;var familys=_words[fpos];fpos++;for(;fpos<l;fpos++){familys+=' '+_words[fpos];}this._family=familys.split(',')[0];this._italic=_words.indexOf('italic')>=0;this._bold=_words.indexOf('bold')>=0;}}],[{key:"Parse",value:function Parse(font){if(font===FontInfo._lastFont){return FontInfo._lastFontInfo;}var r=FontInfo._cache[font];if(!r){r=FontInfo._cache[font]=new FontInfo(font);}FontInfo._lastFont=font;FontInfo._lastFontInfo=r;return r;}}]);return FontInfo;}();FontInfo.EMPTY=new FontInfo(null);FontInfo._cache={};FontInfo._gfontID=0;FontInfo._lastFont='';var WordText=function(){function WordText(){_classCallCheck(this,WordText);this.save=[];this.toUpperCase=null;this.width=-1;this.pageChars=[];this.startID=0;this.startIDStroke=0;this.lastGCCnt=0;this.splitRender=false;}_createClass(WordText,[{key:"setText",value:function setText(txt){this.changed=true;this._text=txt;this.width=-1;this.cleanCache();}},{key:"toString",value:function toString(){return this._text;}},{key:"charCodeAt",value:function charCodeAt(i){return this._text?this._text.charCodeAt(i):NaN;}},{key:"charAt",value:function charAt(i){return this._text?this._text.charAt(i):null;}},{key:"cleanCache",value:function cleanCache(){this.pageChars.forEach(function(p){var tex=p.tex;var words=p.words;if(p.words.length==1&&tex&&tex.ri){tex.destroy();}});this.pageChars=[];this.startID=0;}},{key:"length",get:function get(){return this._text?this._text.length:0;}}]);return WordText;}();var CharRenderInfo=function(){function CharRenderInfo(){_classCallCheck(this,CharRenderInfo);this.char='';this.deleted=false;this.uv=new Array(8);this.pos=0;this.orix=0;this.oriy=0;this.touchTick=0;this.isSpace=false;}_createClass(CharRenderInfo,[{key:"touch",value:function touch(){var curLoop=RenderInfo.loopCount;if(this.touchTick!=curLoop){this.tex.touchRect(this,curLoop);}this.touchTick=curLoop;}}]);return CharRenderInfo;}();var ICharRender=function(){function ICharRender(){_classCallCheck(this,ICharRender);this.fontsz=16;}_createClass(ICharRender,[{key:"getWidth",value:function getWidth(font,str){return 0;}},{key:"scale",value:function scale(sx,sy){}},{key:"getCharBmp",value:function getCharBmp(char,font,lineWidth,colStr,strokeColStr,size,margin_left,margin_top,margin_right,margin_bottom){var rect=arguments.length>10&&arguments[10]!==undefined?arguments[10]:null;return null;}},{key:"canvasWidth",get:function get(){return 0;},set:function set(w){}}]);return ICharRender;}();var Browser=function(){function Browser(){_classCallCheck(this,Browser);}_createClass(Browser,null,[{key:"__init__",value:function __init__(){var Laya=window.Laya||ILaya.Laya;if(Browser._window)return Browser._window;var win=Browser._window=window;var doc=Browser._document=win.document;var u=Browser.userAgent=win.navigator.userAgent;var maxTouchPoints=win.navigator.maxTouchPoints||0;var platform=win.navigator.platform;if(u.indexOf('AlipayMiniGame')>-1&&"my"in Browser.window){window.aliPayMiniGame(Laya,Laya);if(!Laya["ALIMiniAdapter"]){console.error("");}else{Laya["ALIMiniAdapter"].enable();}}if(u.indexOf('OPPO')==-1&&u.indexOf("MiniGame")>-1&&"wx"in Browser.window){if("qq"in Browser.window){window.qqMiniGame(Laya,Laya);if(!Laya["QQMiniAdapter"]){console.error("QQhttps://ldc2.layabox.com/doc/?nav=zh-ts-5-0-0");}else{Laya["QQMiniAdapter"].enable();}}else{window.wxMiniGame(Laya,Laya);if(!Laya["MiniAdpter"]){console.error(",https://ldc2.layabox.com/doc/?nav=zh-ts-5-0-0");}else{Laya["MiniAdpter"].enable();}}}if(u.indexOf("MiniGame")>-1&&"qq"in Browser.window){window.qqMiniGame(Laya,Laya);if(!Laya["QQMiniAdapter"]){console.error(",");}else{Laya["QQMiniAdapter"].enable();}}if(u.indexOf("SwanGame")>-1){window.bdMiniGame(Laya,Laya);if(!Laya["BMiniAdapter"]){console.error(",https://ldc2.layabox.com/doc/?nav=zh-ts-5-0-0");}else{Laya["BMiniAdapter"].enable();}}if(u.indexOf('QuickGame')>-1){window.miMiniGame(Laya,Laya);if(!Laya["KGMiniAdapter"]){console.error(",https://ldc2.layabox.com/doc/?nav=zh-ts-5-0-0");}else{Laya["KGMiniAdapter"].enable();}}if(u.indexOf('OPPO')>-1&&u.indexOf('MiniGame')>-1){window.qgMiniGame(Laya,Laya);if(!Laya["QGMiniAdapter"]){console.error("OPPO");}else{Laya["QGMiniAdapter"].enable();}}if(u.indexOf('VVGame')>-1){window.vvMiniGame(Laya,Laya);if(!Laya["VVMiniAdapter"]){console.error("VIVO");}else{Laya["VVMiniAdapter"].enable();}}win.trace=console.log;win.requestAnimationFrame=win.requestAnimationFrame||win.webkitRequestAnimationFrame||win.mozRequestAnimationFrame||win.oRequestAnimationFrame||win.msRequestAnimationFrame||function(fun){return win.setTimeout(fun,1000/60);};var bodyStyle=doc.body.style;bodyStyle.margin=0;bodyStyle.overflow='hidden';bodyStyle['-webkit-user-select']='none';bodyStyle['-webkit-tap-highlight-color']='rgba(200,200,200,0)';var metas=doc.getElementsByTagName('meta');var i=0,flag=false,content='width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no';while(i<metas.length){var meta=metas[i];if(meta.name=='viewport'){meta.content=content;flag=true;break;}i++;}if(!flag){meta=doc.createElement('meta');meta.name='viewport',meta.content=content;doc.getElementsByTagName('head')[0].appendChild(meta);}Browser.onMobile=window.isConchApp?true:u.indexOf("Mobile")>-1;Browser.onIOS=!!u.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/);Browser.onIPhone=u.indexOf("iPhone")>-1;Browser.onMac=u.indexOf("Mac OS X")>-1;Browser.onIPad=u.indexOf("iPad")>-1||platform==='MacIntel'&&maxTouchPoints>1;Browser.onAndroid=u.indexOf('Android')>-1||u.indexOf('Adr')>-1;Browser.onWP=u.indexOf("Windows Phone")>-1;Browser.onQQBrowser=u.indexOf("QQBrowser")>-1;Browser.onMQQBrowser=u.indexOf("MQQBrowser")>-1||u.indexOf("Mobile")>-1&&u.indexOf("QQ")>-1;Browser.onIE=!!win.ActiveXObject||"ActiveXObject"in win;Browser.onWeiXin=u.indexOf('MicroMessenger')>-1;Browser.onSafari=u.indexOf("Safari")>-1;Browser.onPC=!Browser.onMobile;Browser.onMiniGame=u.indexOf('MiniGame')>-1;Browser.onBDMiniGame=u.indexOf('SwanGame')>-1;Browser.onLayaRuntime=!!Browser.window.conch;if(u.indexOf('OPPO')>-1&&u.indexOf('MiniGame')>-1){Browser.onQGMiniGame=true;Browser.onMiniGame=false;}else if("qq"in Browser.window&&u.indexOf('MiniGame')>-1){Browser.onQQMiniGame=true;Browser.onMiniGame=false;}Browser.onVVMiniGame=u.indexOf('VVGame')>-1;Browser.onKGMiniGame=u.indexOf('QuickGame')>-1;if(u.indexOf('AlipayMiniGame')>-1){Browser.onAlipayMiniGame=true;Browser.onMiniGame=false;}return win;}},{key:"createElement",value:function createElement(type){Browser.__init__();return Browser._document.createElement(type);}},{key:"getElementById",value:function getElementById(type){Browser.__init__();return Browser._document.getElementById(type);}},{key:"removeElement",value:function removeElement(ele){if(ele&&ele.parentNode)ele.parentNode.removeChild(ele);}},{key:"now",value:function now(){return Date.now();}},{key:"clientWidth",get:function get(){Browser.__init__();return Browser._window.innerWidth||Browser._document.body.clientWidth;}},{key:"clientHeight",get:function get(){Browser.__init__();return Browser._window.innerHeight||Browser._document.body.clientHeight||Browser._document.documentElement.clientHeight;}},{key:"width",get:function get(){Browser.__init__();return(ILaya.stage&&ILaya.stage.canvasRotation?Browser.clientHeight:Browser.clientWidth)*Browser.pixelRatio;}},{key:"height",get:function get(){Browser.__init__();return(ILaya.stage&&ILaya.stage.canvasRotation?Browser.clientWidth:Browser.clientHeight)*Browser.pixelRatio;}},{key:"pixelRatio",get:function get(){if(Browser._pixelRatio<0){Browser.__init__();if(Browser.userAgent.indexOf("Mozilla/6.0(Linux; Android 6.0; HUAWEI NXT-AL10 Build/HUAWEINXT-AL10)")>-1)Browser._pixelRatio=2;else{Browser._pixelRatio=Browser._window.devicePixelRatio||1;if(Browser._pixelRatio<1)Browser._pixelRatio=1;}}return Browser._pixelRatio;}},{key:"container",get:function get(){if(!Browser._container){Browser.__init__();Browser._container=Browser.createElement("div");Browser._container.id="layaContainer";Browser._document.body.appendChild(Browser._container);}return Browser._container;},set:function set(value){Browser._container=value;}},{key:"window",get:function get(){return Browser._window||Browser.__init__();}},{key:"document",get:function get(){Browser.__init__();return Browser._document;}}]);return Browser;}();Browser._pixelRatio=-1;Browser.mainCanvas=null;Browser.hanzi=new RegExp("^[\u4E00-\u9FA5]$");Browser.fontMap=[];Browser.measureText=function(txt,font){var isChinese=Browser.hanzi.test(txt);if(isChinese&&Browser.fontMap[font]){return Browser.fontMap[font];}var ctx=Browser.context;ctx.font=font;var r=ctx.measureText(txt);if(isChinese)Browser.fontMap[font]=r;return r;};var CharRender_Canvas=function(_ICharRender){_inherits(CharRender_Canvas,_ICharRender);function CharRender_Canvas(maxw,maxh){var scalefont=arguments.length>2&&arguments[2]!==undefined?arguments[2]:true;var useImageData=arguments.length>3&&arguments[3]!==undefined?arguments[3]:true;var showdbg=arguments.length>4&&arguments[4]!==undefined?arguments[4]:false;_classCallCheck(this,CharRender_Canvas);var _this25=_possibleConstructorReturn(this,(CharRender_Canvas.__proto__||Object.getPrototypeOf(CharRender_Canvas)).call(this));_this25.ctx=null;_this25.lastScaleX=1.0;_this25.lastScaleY=1.0;_this25.maxTexW=0;_this25.maxTexH=0;_this25.scaleFontSize=true;_this25.showDbgInfo=false;_this25.supportImageData=true;_this25.maxTexW=maxw;_this25.maxTexH=maxh;_this25.scaleFontSize=scalefont;_this25.supportImageData=useImageData;_this25.showDbgInfo=showdbg;if(!CharRender_Canvas.canvas){CharRender_Canvas.canvas=Browser.createElement('canvas');CharRender_Canvas.canvas.width=1024;CharRender_Canvas.canvas.height=512;CharRender_Canvas.canvas.style.left="-10000px";CharRender_Canvas.canvas.style.position="absolute";document.body.appendChild(CharRender_Canvas.canvas);_this25.ctx=CharRender_Canvas.canvas.getContext('2d');}return _this25;}_createClass(CharRender_Canvas,[{key:"getWidth",value:function getWidth(font,str){if(!this.ctx)return 0;if(this.ctx._lastFont!=font){this.ctx.font=font;this.ctx._lastFont=font;}return this.ctx.measureText(str).width;}},{key:"scale",value:function scale(sx,sy){if(!this.supportImageData){this.lastScaleX=sx;this.lastScaleY=sy;return;}if(this.lastScaleX!=sx||this.lastScaleY!=sy){this.ctx.setTransform(sx,0,0,sy,0,0);this.lastScaleX=sx;this.lastScaleY=sy;}}},{key:"getCharBmp",value:function getCharBmp(char,font,lineWidth,colStr,strokeColStr,cri,margin_left,margin_top,margin_right,margin_bottom){var rect=arguments.length>10&&arguments[10]!==undefined?arguments[10]:null;if(!this.supportImageData)return this.getCharCanvas(char,font,lineWidth,colStr,strokeColStr,cri,margin_left,margin_top,margin_right,margin_bottom);var ctx=this.ctx;var sz=this.fontsz;if(ctx.font!=font){ctx.font=font;ctx._lastFont=font;}cri.width=ctx.measureText(char).width;var w=cri.width*this.lastScaleX;var h=cri.height*this.lastScaleY;w+=(margin_left+margin_right)*this.lastScaleX;h+=(margin_top+margin_bottom)*this.lastScaleY;w=Math.ceil(w);h=Math.ceil(h);w=Math.min(w,CharRender_Canvas.canvas.width);h=Math.min(h,CharRender_Canvas.canvas.height);var clearW=w+lineWidth*2+1;var clearH=h+lineWidth*2+1;if(rect){clearW=Math.max(clearW,rect[0]+rect[2]+1);clearH=Math.max(clearH,rect[1]+rect[3]+1);}ctx.clearRect(0,0,clearW/this.lastScaleX+1,clearH/this.lastScaleY+1);ctx.save();ctx.textBaseline="middle";if(lineWidth>0){ctx.strokeStyle=strokeColStr;ctx.lineWidth=lineWidth;ctx.strokeText(char,margin_left,margin_top+sz/2);}if(colStr){ctx.fillStyle=colStr;ctx.fillText(char,margin_left,margin_top+sz/2);}if(this.showDbgInfo){ctx.strokeStyle='#ff0000';ctx.strokeRect(1,1,w-2,h-2);ctx.strokeStyle='#00ff00';ctx.strokeRect(margin_left,margin_top,cri.width,cri.height);}if(rect){if(rect[2]==-1)rect[2]=Math.ceil((cri.width+lineWidth*2)*this.lastScaleX);}var imgdt=rect?ctx.getImageData(rect[0],rect[1],rect[2],rect[3]+1):ctx.getImageData(0,0,w,h+1);ctx.restore();cri.bmpWidth=imgdt.width;cri.bmpHeight=imgdt.height;return imgdt;}},{key:"getCharCanvas",value:function getCharCanvas(char,font,lineWidth,colStr,strokeColStr,cri,margin_left,margin_top,margin_right,margin_bottom){var ctx=this.ctx;if(ctx.font!=font){ctx.font=font;ctx._lastFont=font;}cri.width=ctx.measureText(char).width;var w=cri.width*this.lastScaleX;var h=cri.height*this.lastScaleY;w+=(margin_left+margin_right)*this.lastScaleX;h+=(margin_top+margin_bottom)*this.lastScaleY+1;w=Math.min(w,this.maxTexW);h=Math.min(h,this.maxTexH);CharRender_Canvas.canvas.width=Math.min(w+1,this.maxTexW);CharRender_Canvas.canvas.height=Math.min(h+1,this.maxTexH);ctx.font=font;ctx.clearRect(0,0,w+1+lineWidth,h+1+lineWidth);ctx.setTransform(1,0,0,1,0,0);ctx.save();if(this.scaleFontSize){ctx.scale(this.lastScaleX,this.lastScaleY);}ctx.translate(margin_left,margin_top);ctx.textAlign="left";var sz=this.fontsz;ctx.textBaseline="middle";if(lineWidth>0){ctx.strokeStyle=strokeColStr;ctx.fillStyle=colStr;ctx.lineWidth=lineWidth;if(ctx.fillAndStrokeText){ctx.fillAndStrokeText(char,0,sz/2);}else{ctx.strokeText(char,0,sz/2);ctx.fillText(char,0,sz/2);}}else if(colStr){ctx.fillStyle=colStr;ctx.fillText(char,0,sz/2);}if(this.showDbgInfo){ctx.strokeStyle='#ff0000';ctx.strokeRect(0,0,w,h);ctx.strokeStyle='#00ff00';ctx.strokeRect(0,0,cri.width,cri.height);}ctx.restore();cri.bmpWidth=CharRender_Canvas.canvas.width;cri.bmpHeight=CharRender_Canvas.canvas.height;return CharRender_Canvas.canvas;}},{key:"canvasWidth",get:function get(){return CharRender_Canvas.canvas.width;},set:function set(w){if(CharRender_Canvas.canvas.width==w)return;CharRender_Canvas.canvas.width=w;if(w>2048){console.warn("2048");}this.ctx.setTransform(1,0,0,1,0,0);this.ctx.scale(this.lastScaleX,this.lastScaleY);}}]);return CharRender_Canvas;}(ICharRender);CharRender_Canvas.canvas=null;var CharRender_Native=function(_ICharRender2){_inherits(CharRender_Native,_ICharRender2);function CharRender_Native(){_classCallCheck(this,CharRender_Native);var _this26=_possibleConstructorReturn(this,(CharRender_Native.__proto__||Object.getPrototypeOf(CharRender_Native)).call(this));_this26.lastFont='';_this26.lastScaleX=1.0;_this26.lastScaleY=1.0;return _this26;}_createClass(CharRender_Native,[{key:"getWidth",value:function getWidth(font,str){if(!window.conchTextCanvas)return 0;window.conchTextCanvas.font=font;this.lastFont=font;return window.conchTextCanvas.measureText(str).width;}},{key:"scale",value:function scale(sx,sy){this.lastScaleX=sx;this.lastScaleY=sy;}},{key:"getCharBmp",value:function getCharBmp(char,font,lineWidth,colStr,strokeColStr,size,margin_left,margin_top,margin_right,margin_bottom){var rect=arguments.length>10&&arguments[10]!==undefined?arguments[10]:null;if(!window.conchTextCanvas)return null;window.conchTextCanvas.font=font;this.lastFont=font;var w=size.width=window.conchTextCanvas.measureText(char).width;var h=size.height;w+=margin_left+margin_right;h+=margin_top+margin_bottom;window.conchTextCanvas.scale&&window.conchTextCanvas.scale(this.lastScaleX,this.lastScaleY);var c1=ColorUtils.create(strokeColStr);var nStrokeColor=c1.numColor;var c2=ColorUtils.create(colStr);var nTextColor=c2.numColor;var textInfo=window.conchTextCanvas.getTextBitmapData(char,nTextColor,lineWidth>2?2:lineWidth,nStrokeColor);size.bmpWidth=textInfo.width;size.bmpHeight=textInfo.height;return textInfo;}}]);return CharRender_Native;}(ICharRender);var TextRender=function(){function TextRender(){_classCallCheck(this,TextRender);this.fontSizeInfo={};this.mapFont={};this.fontID=0;this.mapColor=[];this.colorID=0;this.fontScaleX=1.0;this.fontScaleY=1.0;this._curStrPos=0;this.textAtlases=[];this.isoTextures=[];this.lastFont=null;this.fontSizeW=0;this.fontSizeH=0;this.fontSizeOffX=0;this.fontSizeOffY=0;this.renderPerChar=true;this.tmpAtlasPos=new Point();this.textureMem=0;ILaya.TextAtlas=TextAtlas;var bugIOS=false;var miniadp=ILaya.Laya['MiniAdpter'];if(miniadp&&miniadp.systemInfo&&miniadp.systemInfo.system){bugIOS=miniadp.systemInfo.system.toLowerCase()==='ios 10.1.1';}if(ILaya.Browser.onMiniGame&&!bugIOS)TextRender.isWan1Wan=true;this.charRender=ILaya.Render.isConchApp?new CharRender_Native():new CharRender_Canvas(TextRender.atlasWidth,TextRender.atlasWidth,TextRender.scaleFontWithCtx,!TextRender.isWan1Wan,false);TextRender.textRenderInst=this;ILaya.Laya['textRender']=this;TextRender.atlasWidth2=TextRender.atlasWidth*TextRender.atlasWidth;}_createClass(TextRender,[{key:"setFont",value:function setFont(font){if(this.lastFont==font)return;this.lastFont=font;var fontsz=this.getFontSizeInfo(font._family);var offx=fontsz>>24;var offy=fontsz>>16&0xff;var fw=fontsz>>8&0xff;var fh=fontsz&0xff;var k=font._size/TextRender.standardFontSize;this.fontSizeOffX=Math.ceil(offx*k);this.fontSizeOffY=Math.ceil(offy*k);this.fontSizeW=Math.ceil(fw*k);this.fontSizeH=Math.ceil(fh*k);if(font._font.indexOf('italic')>=0){this.fontStr=font._font.replace('italic','');}else{this.fontStr=font._font;}}},{key:"getNextChar",value:function getNextChar(str){var len=str.length;var start=this._curStrPos;if(start>=len)return null;var i=start;var state=0;for(;i<len;i++){var c=str.charCodeAt(i);if(c>>>11==0x1b){if(state==1)break;state=1;i++;}else if(c===0xfe0e||c===0xfe0f);else if(c==0x200d){state=2;}else{if(state==0)state=1;else if(state==1)break;}}this._curStrPos=i;return str.substring(start,i);}},{key:"filltext",value:function filltext(ctx,data,x,y,fontStr,color,strokeColor,lineWidth,textAlign){var underLine=arguments.length>9&&arguments[9]!==undefined?arguments[9]:0;if(data.length<=0)return;var font=FontInfo.Parse(fontStr);var nTextAlign=0;switch(textAlign){case'center':nTextAlign=ILaya.Context.ENUM_TEXTALIGN_CENTER;break;case'right':nTextAlign=ILaya.Context.ENUM_TEXTALIGN_RIGHT;break;}this._fast_filltext(ctx,data,null,x,y,font,color,strokeColor,lineWidth,nTextAlign,underLine);}},{key:"fillWords",value:function fillWords(ctx,data,x,y,fontStr,color,strokeColor,lineWidth){if(!data)return;if(data.length<=0)return;var font=typeof fontStr==='string'?FontInfo.Parse(fontStr):fontStr;this._fast_filltext(ctx,null,data,x,y,font,color,strokeColor,lineWidth,0,0);}},{key:"_fast_filltext",value:function _fast_filltext(ctx,data,htmlchars,x,y,font,color,strokeColor,lineWidth,textAlign){var underLine=arguments.length>10&&arguments[10]!==undefined?arguments[10]:0;if(data&&data.length<1)return;if(htmlchars&&htmlchars.length<1)return;if(lineWidth<0)lineWidth=0;this.setFont(font);this.fontScaleX=this.fontScaleY=1.0;if(TextRender.scaleFontWithCtx){var sx=1;var sy=1;if(!ILaya.Render.isConchApp||window.conchTextCanvas.scale){sx=ctx.getMatScaleX();sy=ctx.getMatScaleY();}if(sx<1e-4||sy<1e-1)return;if(sx>1)this.fontScaleX=sx;if(sy>1)this.fontScaleY=sy;}font._italic&&(ctx._italicDeg=13);var wt=data;var isWT=!htmlchars&&data instanceof WordText;var str=data;var isHtmlChar=!!htmlchars;var sameTexData=isWT?wt.pageChars:[];var strWidth=0;if(isWT){str=wt._text;strWidth=wt.width;if(strWidth<0){strWidth=wt.width=this.charRender.getWidth(this.fontStr,str);}}else{strWidth=str?this.charRender.getWidth(this.fontStr,str):0;}switch(textAlign){case ILaya.Context.ENUM_TEXTALIGN_CENTER:x-=strWidth/2;break;case ILaya.Context.ENUM_TEXTALIGN_RIGHT:x-=strWidth;break;}if(wt&&sameTexData){if(this.hasFreedText(sameTexData)){sameTexData=wt.pageChars=[];}}var ri=null;var splitTex=this.renderPerChar=!isWT||TextRender.forceSplitRender||isHtmlChar||isWT&&wt.splitRender;if(!sameTexData||sameTexData.length<1){if(splitTex){var stx=0;var sty=0;this._curStrPos=0;var curstr;while(true){if(htmlchars){var chc=htmlchars[this._curStrPos++];if(chc){curstr=chc.char;stx=chc.x;sty=chc.y;}else{curstr=null;}}else{curstr=this.getNextChar(str);}if(!curstr)break;ri=this.getCharRenderInfo(curstr,font,color,strokeColor,lineWidth,false);if(!ri){break;}if(ri.isSpace);else{var add=sameTexData[ri.tex.id];if(!add){var o1={texgen:ri.tex.genID,tex:ri.tex,words:[]};sameTexData[ri.tex.id]=o1;add=o1.words;}else{add=add.words;}add.push({ri:ri,x:stx,y:sty,w:ri.bmpWidth/this.fontScaleX,h:ri.bmpHeight/this.fontScaleY});stx+=ri.width;}}}else{var isotex=TextRender.noAtlas||strWidth*this.fontScaleX>TextRender.atlasWidth;ri=this.getCharRenderInfo(str,font,color,strokeColor,lineWidth,isotex);sameTexData[0]={texgen:ri.tex.genID,tex:ri.tex,words:[{ri:ri,x:0,y:0,w:ri.bmpWidth/this.fontScaleX,h:ri.bmpHeight/this.fontScaleY}]};}}this._drawResortedWords(ctx,x,y,sameTexData);ctx._italicDeg=0;}},{key:"_drawResortedWords",value:function _drawResortedWords(ctx,startx,starty,samePagesData){var isLastRender=ctx._charSubmitCache?ctx._charSubmitCache._enable:false;var mat=ctx._curMat;var slen=samePagesData.length;for(var id in samePagesData){var dt=samePagesData[id];if(!dt)continue;var pri=dt.words;var pisz=pri.length;if(pisz<=0)continue;var tex=samePagesData[id].tex;for(var j=0;j<pisz;j++){var riSaved=pri[j];var ri=riSaved.ri;if(ri.isSpace)continue;ri.touch();ctx.drawTexAlign=true;if(ILaya.Render.isConchApp){ctx._drawTextureM(tex.texture,startx+riSaved.x-ri.orix,starty+riSaved.y-ri.oriy,riSaved.w,riSaved.h,null,1.0,ri.uv);}else{var t=tex;ctx._inner_drawTexture(t.texture,t.id,startx+riSaved.x-ri.orix,starty+riSaved.y-ri.oriy,riSaved.w,riSaved.h,mat,ri.uv,1.0,isLastRender);}if(ctx.touches){ctx.touches.push(ri);}}}}},{key:"hasFreedText",value:function hasFreedText(txts){var sz=txts.length;for(var i=0;i<sz;i++){var pri=txts[i];if(!pri)continue;var tex=pri.tex;if(tex.__destroyed||tex.genID!=pri.texgen){return true;}}return false;}},{key:"getCharRenderInfo",value:function getCharRenderInfo(str,font,color,strokeColor,lineWidth){var isoTexture=arguments.length>5&&arguments[5]!==undefined?arguments[5]:false;var fid=this.mapFont[font._family];if(fid==undefined){this.mapFont[font._family]=fid=this.fontID++;}var key=str+'_'+fid+'_'+font._size+'_'+color;if(lineWidth>0)key+='_'+strokeColor+lineWidth;if(font._bold)key+='P';if(this.fontScaleX!=1||this.fontScaleY!=1){key+=(this.fontScaleX*20|0)+'_'+(this.fontScaleY*20|0);}var i=0;var sz=this.textAtlases.length;var ri;var atlas;if(!isoTexture){for(i=0;i<sz;i++){atlas=this.textAtlases[i];ri=atlas.charMaps[key];if(ri){ri.touch();return ri;}}}ri=new CharRenderInfo();this.charRender.scale(this.fontScaleX,this.fontScaleY);ri.char=str;ri.height=font._size;var margin=ILaya.Render.isConchApp?0:font._size/3|0;var imgdt=null;if(!lineWidth){lineWidth=0;}var w1=Math.ceil((this.charRender.getWidth(this.fontStr,str)+2*lineWidth)*this.fontScaleX);if(w1>this.charRender.canvasWidth){this.charRender.canvasWidth=Math.min(2048,w1+margin*2);}if(isoTexture){this.charRender.fontsz=font._size;imgdt=this.charRender.getCharBmp(str,this.fontStr,lineWidth,color,strokeColor,ri,margin,margin,margin,margin,null);if(imgdt){var tex=TextTexture.getTextTexture(imgdt.width,imgdt.height);tex.addChar(imgdt,0,0,ri.uv);ri.tex=tex;ri.orix=margin;ri.oriy=margin;tex.ri=ri;this.isoTextures.push(tex);}}else{var len=str.length;var lineExt=lineWidth*1;var fw=Math.ceil((this.fontSizeW+lineExt*2)*this.fontScaleX);var fh=Math.ceil((this.fontSizeH+lineExt*2)*this.fontScaleY);TextRender.imgdtRect[0]=(margin-this.fontSizeOffX-lineExt)*this.fontScaleX|0;TextRender.imgdtRect[1]=(margin-this.fontSizeOffY-lineExt)*this.fontScaleY|0;if(this.renderPerChar||len==1){TextRender.imgdtRect[2]=Math.max(w1,fw);TextRender.imgdtRect[3]=Math.max(w1,fh);}else{TextRender.imgdtRect[2]=-1;TextRender.imgdtRect[3]=fh;}this.charRender.fontsz=font._size;imgdt=this.charRender.getCharBmp(str,this.fontStr,lineWidth,color,strokeColor,ri,margin,margin,margin,margin,TextRender.imgdtRect);if(imgdt){atlas=this.addBmpData(imgdt,ri);if(TextRender.isWan1Wan){ri.orix=margin;ri.oriy=margin;}else{ri.orix=this.fontSizeOffX+lineExt;ri.oriy=this.fontSizeOffY+lineExt;}atlas.charMaps[key]=ri;}}return ri;}},{key:"addBmpData",value:function addBmpData(data,ri){var w=data.width;var h=data.height;var sz=this.textAtlases.length;var atlas;var find=false;for(var i=0;i<sz;i++){atlas=this.textAtlases[i];find=atlas.getAEmpty(w,h,this.tmpAtlasPos);if(find){break;}}if(!find){atlas=new TextAtlas();this.textAtlases.push(atlas);find=atlas.getAEmpty(w,h,this.tmpAtlasPos);if(!find){throw'err1';}this.cleanAtlases();}if(find){atlas.texture.addChar(data,this.tmpAtlasPos.x,this.tmpAtlasPos.y,ri.uv);ri.tex=atlas.texture;}return atlas;}},{key:"GC",value:function GC(){var i=0;var sz=this.textAtlases.length;var dt=0;var destroyDt=TextRender.destroyAtlasDt;var totalUsedRate=0;var totalUsedRateAtlas=0;var curloop=RenderInfo.loopCount;var maxWasteRateID=-1;var maxWasteRate=0;var tex=null;var curatlas=null;for(;i<sz;i++){curatlas=this.textAtlases[i];tex=curatlas.texture;if(tex){totalUsedRate+=tex.curUsedCovRate;totalUsedRateAtlas+=tex.curUsedCovRateAtlas;var waste=curatlas.usedRate-tex.curUsedCovRateAtlas;if(maxWasteRate<waste){maxWasteRate=waste;maxWasteRateID=i;}}dt=curloop-curatlas.texture.lastTouchTm;if(dt>destroyDt){TextRender.showLog&&console.log('TextRender GC delete atlas '+tex?curatlas.texture.id:'unk');curatlas.destroy();this.textAtlases[i]=this.textAtlases[sz-1];sz--;i--;maxWasteRateID=-1;}}this.textAtlases.length=sz;sz=this.isoTextures.length;for(i=0;i<sz;i++){tex=this.isoTextures[i];dt=curloop-tex.lastTouchTm;if(dt>TextRender.destroyUnusedTextureDt){tex.ri.deleted=true;tex.ri.tex=null;tex.destroy();this.isoTextures[i]=this.isoTextures[sz-1];sz--;i--;}}this.isoTextures.length=sz;var needGC=this.textAtlases.length>1&&this.textAtlases.length-totalUsedRateAtlas>=2;if(TextRender.atlasWidth*TextRender.atlasWidth*4*this.textAtlases.length>TextRender.cleanMem||needGC||TextRender.simClean){TextRender.simClean=false;TextRender.showLog&&console.log(':',totalUsedRateAtlas,':',this.textAtlases.length,':'+maxWasteRateID);if(maxWasteRateID>=0){curatlas=this.textAtlases[maxWasteRateID];curatlas.destroy();this.textAtlases[maxWasteRateID]=this.textAtlases[this.textAtlases.length-1];this.textAtlases.length=this.textAtlases.length-1;}}TextTexture.clean();}},{key:"cleanAtlases",value:function cleanAtlases(){}},{key:"getCharBmp",value:function getCharBmp(c){}},{key:"checkBmpLine",value:function checkBmpLine(data,l,sx,ex){if(this.bmpData32.buffer!=data.data.buffer){this.bmpData32=new Uint32Array(data.data.buffer);}var stpos=data.width*l+sx;for(var x=sx;x<ex;x++){if(this.bmpData32[stpos++]!=0)return true;}return false;}},{key:"updateBbx",value:function updateBbx(data,curbbx){var onlyH=arguments.length>2&&arguments[2]!==undefined?arguments[2]:false;var w=data.width;var h=data.height;var x=0;var sy=curbbx[1];var ey=0;var y=sy;if(this.checkBmpLine(data,sy,0,w)){while(true){y=(sy+ey)/2|0;if(y+1>=sy){curbbx[1]=y;break;}if(this.checkBmpLine(data,y,0,w)){sy=y;}else{ey=y;}}}if(curbbx[3]>h)curbbx[3]=h;else{y=sy=curbbx[3];ey=h;if(this.checkBmpLine(data,sy,0,w)){while(true){y=(sy+ey)/2|0;if(y-1<=sy){curbbx[3]=y;break;}if(this.checkBmpLine(data,y,0,w)){sy=y;}else{ey=y;}}}}if(onlyH)return;var minx=curbbx[0];var stpos=w*curbbx[1];for(y=curbbx[1];y<curbbx[3];y++){for(x=0;x<minx;x++){if(this.bmpData32[stpos+x]!=0){minx=x;break;}}stpos+=w;}curbbx[0]=minx;var maxx=curbbx[2];stpos=w*curbbx[1];for(y=curbbx[1];y<curbbx[3];y++){for(x=maxx;x<w;x++){if(this.bmpData32[stpos+x]!=0){maxx=x;break;}}stpos+=w;}curbbx[2]=maxx;}},{key:"getFontSizeInfo",value:function getFontSizeInfo(font){var finfo=this.fontSizeInfo[font];if(finfo!=undefined)return finfo;var fontstr='bold '+TextRender.standardFontSize+'px '+font;if(TextRender.isWan1Wan){this.fontSizeW=this.charRender.getWidth(fontstr,'')*1.5;this.fontSizeH=TextRender.standardFontSize*1.5;var szinfo=this.fontSizeW<<8|this.fontSizeH;this.fontSizeInfo[font]=szinfo;return szinfo;}TextRender.pixelBBX[0]=TextRender.standardFontSize/2;TextRender.pixelBBX[1]=TextRender.standardFontSize/2;TextRender.pixelBBX[2]=TextRender.standardFontSize;TextRender.pixelBBX[3]=TextRender.standardFontSize;var orix=16;var oriy=16;var marginr=16;var marginb=16;this.charRender.scale(1,1);TextRender.tmpRI.height=TextRender.standardFontSize;this.charRender.fontsz=TextRender.standardFontSize;var bmpdt=this.charRender.getCharBmp('g',fontstr,0,'red',null,TextRender.tmpRI,orix,oriy,marginr,marginb);if(ILaya.Render.isConchApp){bmpdt.data=new Uint8ClampedArray(bmpdt.data);}this.bmpData32=new Uint32Array(bmpdt.data.buffer);this.updateBbx(bmpdt,TextRender.pixelBBX,false);bmpdt=this.charRender.getCharBmp('',fontstr,0,'red',null,TextRender.tmpRI,oriy,oriy,marginr,marginb);if(ILaya.Render.isConchApp){bmpdt.data=new Uint8ClampedArray(bmpdt.data);}this.bmpData32=new Uint32Array(bmpdt.data.buffer);if(TextRender.pixelBBX[2]<orix+TextRender.tmpRI.width)TextRender.pixelBBX[2]=orix+TextRender.tmpRI.width;this.updateBbx(bmpdt,TextRender.pixelBBX,false);if(ILaya.Render.isConchApp){orix=0;oriy=0;}var xoff=Math.max(orix-TextRender.pixelBBX[0],0);var yoff=Math.max(oriy-TextRender.pixelBBX[1],0);var bbxw=TextRender.pixelBBX[2]-TextRender.pixelBBX[0];var bbxh=TextRender.pixelBBX[3]-TextRender.pixelBBX[1];var sizeinfo=xoff<<24|yoff<<16|bbxw<<8|bbxh;this.fontSizeInfo[font]=sizeinfo;return sizeinfo;}},{key:"printDbgInfo",value:function printDbgInfo(){console.log(':'+this.textAtlases.length+',:'+TextRender.atlasWidth+'x'+TextRender.atlasWidth,' canvas:',TextRender.isWan1Wan);console.log(':'+TextRender.atlasWidth*TextRender.atlasWidth*4/1024/1024*this.textAtlases.length+'M');console.log(':');for(var f in this.mapFont){var fontsz=this.getFontSizeInfo(f);var offx=fontsz>>24;var offy=fontsz>>16&0xff;var fw=fontsz>>8&0xff;var fh=fontsz&0xff;console.log('    '+f,' off:',offx,offy,' size:',fw,fh);}var num=0;console.log(':');var totalUsedRate=0;var totalUsedRateAtlas=0;this.textAtlases.forEach(function(a){var id=a.texture.id;var dt=RenderInfo.loopCount-a.texture.lastTouchTm;var dtstr=dt>0?''+dt+'':'';totalUsedRate+=a.texture.curUsedCovRate;totalUsedRateAtlas+=a.texture.curUsedCovRateAtlas;console.log('--(id:'+id+',:'+(a.texture.curUsedCovRate*1000|0)+'',':',(a.texture.curUsedCovRateAtlas*100|0)+'%',':',a.usedRate*100|0,'%, :'+dtstr+')--:');for(var k in a.charMaps){var ri=a.charMaps[k];console.log('     off:',ri.orix,ri.oriy,' bmp:',ri.bmpWidth,ri.bmpHeight,':',ri.deleted,'touchdt:',RenderInfo.loopCount-ri.touchTick,':',ri.uv[0]*TextRender.atlasWidth|0,ri.uv[1]*TextRender.atlasWidth|0,':',ri.char,'key:',k);num++;}});console.log('('+this.isoTextures.length+'):');this.isoTextures.forEach(function(tex){console.log('    size:',tex._texW,tex._texH,'touch:',RenderInfo.loopCount-tex.lastTouchTm,'char:',tex.ri.char);});console.log(':',num,':',totalUsedRate,':',totalUsedRateAtlas);}},{key:"showAtlas",value:function showAtlas(n,bgcolor,x,y,w,h){if(!this.textAtlases[n]){console.log('');return null;}var sp=new ILaya.Sprite();var texttex=this.textAtlases[n].texture;var texture={width:TextRender.atlasWidth,height:TextRender.atlasWidth,sourceWidth:TextRender.atlasWidth,sourceHeight:TextRender.atlasWidth,offsetX:0,offsetY:0,getIsReady:function getIsReady(){return true;},_addReference:function _addReference(){},_removeReference:function _removeReference(){},_getSource:function _getSource(){return texttex._getSource();},bitmap:{id:texttex.id},_uv:Texture.DEF_UV};sp.size=function(w,h){this.width=w;this.height=h;sp.graphics.clear();sp.graphics.drawRect(0,0,sp.width,sp.height,bgcolor);sp.graphics.drawTexture(texture,0,0,sp.width,sp.height);return this;};sp.graphics.drawRect(0,0,w,h,bgcolor);sp.graphics.drawTexture(texture,0,0,w,h);sp.pos(x,y);ILaya.stage.addChild(sp);return sp;}},{key:"filltext_native",value:function filltext_native(ctx,data,htmlchars,x,y,fontStr,color,strokeColor,lineWidth,textAlign){var underLine=arguments.length>10&&arguments[10]!==undefined?arguments[10]:0;if(data&&data.length<=0)return;if(htmlchars&&htmlchars.length<1)return;var font=FontInfo.Parse(fontStr);var nTextAlign=0;switch(textAlign){case'center':nTextAlign=ILaya.Context.ENUM_TEXTALIGN_CENTER;break;case'right':nTextAlign=ILaya.Context.ENUM_TEXTALIGN_RIGHT;break;}return this._fast_filltext(ctx,data,htmlchars,x,y,font,color,strokeColor,lineWidth,nTextAlign,underLine);}}]);return TextRender;}();TextRender.useOldCharBook=false;TextRender.atlasWidth=1024;TextRender.noAtlas=false;TextRender.forceSplitRender=false;TextRender.forceWholeRender=false;TextRender.scaleFontWithCtx=true;TextRender.standardFontSize=32;TextRender.destroyAtlasDt=10;TextRender.checkCleanTextureDt=2000;TextRender.destroyUnusedTextureDt=3000;TextRender.cleanMem=100*1024*1024;TextRender.isWan1Wan=false;TextRender.showLog=false;TextRender.debugUV=false;TextRender.tmpRI=new CharRenderInfo();TextRender.pixelBBX=[0,0,0,0];TextRender.imgdtRect=[0,0,0,0];TextRender.simClean=false;TextTexture.gTextRender=TextRender;var Context=function(){function Context(){_classCallCheck(this,Context);this._tmpMatrix=new Matrix();this._drawTexToDrawTri_Vert=new Float32Array(8);this._drawTexToDrawTri_Index=new Uint16Array([0,1,2,0,2,3]);this._tempUV=new Float32Array(8);this._drawTriUseAbsMatrix=false;this._id=++Context._COUNT;this._other=null;this._renderNextSubmitIndex=0;this._path=null;this._drawCount=1;this._width=Context._MAXSIZE;this._height=Context._MAXSIZE;this._renderCount=0;this._submits=null;this._curSubmit=null;this._submitKey=new SubmitKey();this._mesh=null;this._pathMesh=null;this._triangleMesh=null;this.meshlist=[];this._transedPoints=new Array(8);this._temp4Points=new Array(8);this._clipRect=Context.MAXCLIPRECT;this._globalClipMatrix=new Matrix(Context._MAXSIZE,0,0,Context._MAXSIZE,0,0);this._clipInCache=false;this._clipInfoID=0;this._clipID_Gen=0;this._lastMatScaleX=1.0;this._lastMatScaleY=1.0;this._lastMat_a=1.0;this._lastMat_b=0.0;this._lastMat_c=0.0;this._lastMat_d=1.0;this._nBlendType=0;this._save=null;this._targets=null;this._charSubmitCache=null;this._saveMark=null;this._shader2D=new Shader2D();this.sprite=null;this._italicDeg=0;this._lastTex=null;this._fillColor=0;this._flushCnt=0;this.defTexture=null;this._colorFiler=null;this.drawTexAlign=false;this._incache=false;this.isMain=false;Context._contextcount++;Context._textRender=Context._textRender||new TextRender();if(!this.defTexture){var defTex2d=new Texture2D(2,2);defTex2d.setPixels(new Uint8Array(16));defTex2d.lock=true;this.defTexture=new Texture(defTex2d);}this._lastTex=this.defTexture;this.clear();}_createClass(Context,[{key:"drawImage",value:function drawImage(){}},{key:"getImageData",value:function getImageData(){}},{key:"measureText",value:function measureText(text){return null;}},{key:"setTransform",value:function setTransform(){}},{key:"$transform",value:function $transform(a,b,c,d,tx,ty){}},{key:"clearRect",value:function clearRect(x,y,width,height){}},{key:"_drawRect",value:function _drawRect(x,y,width,height,style){Stat.renderBatches++;style&&(this.fillStyle=style);this.fillRect(x,y,width,height,null);}},{key:"drawTexture2",value:function drawTexture2(x,y,pivotX,pivotY,m,args2){}},{key:"transformByMatrix",value:function transformByMatrix(matrix,tx,ty){this.transform(matrix.a,matrix.b,matrix.c,matrix.d,matrix.tx+tx,matrix.ty+ty);}},{key:"saveTransform",value:function saveTransform(matrix){this.save();}},{key:"restoreTransform",value:function restoreTransform(matrix){this.restore();}},{key:"drawRect",value:function drawRect(x,y,width,height,fillColor,lineColor,lineWidth){var ctx=this;if(fillColor!=null){ctx.fillStyle=fillColor;ctx.fillRect(x,y,width,height);}if(lineColor!=null){ctx.strokeStyle=lineColor;ctx.lineWidth=lineWidth;ctx.strokeRect(x,y,width,height);}}},{key:"alpha",value:function alpha(value){this.globalAlpha*=value;}},{key:"_transform",value:function _transform(mat,pivotX,pivotY){this.translate(pivotX,pivotY);this.transform(mat.a,mat.b,mat.c,mat.d,mat.tx,mat.ty);this.translate(-pivotX,-pivotY);}},{key:"_rotate",value:function _rotate(angle,pivotX,pivotY){this.translate(pivotX,pivotY);this.rotate(angle);this.translate(-pivotX,-pivotY);}},{key:"_scale",value:function _scale(scaleX,scaleY,pivotX,pivotY){this.translate(pivotX,pivotY);this.scale(scaleX,scaleY);this.translate(-pivotX,-pivotY);}},{key:"_drawLine",value:function _drawLine(x,y,fromX,fromY,toX,toY,lineColor,lineWidth,vid){this.beginPath();this.strokeStyle=lineColor;this.lineWidth=lineWidth;this.moveTo(x+fromX,y+fromY);this.lineTo(x+toX,y+toY);this.stroke();}},{key:"_drawLines",value:function _drawLines(x,y,points,lineColor,lineWidth,vid){this.beginPath();this.strokeStyle=lineColor;this.lineWidth=lineWidth;this.addPath(points.slice(),false,false,x,y);this.stroke();}},{key:"drawCurves",value:function drawCurves(x,y,points,lineColor,lineWidth){this.beginPath();this.strokeStyle=lineColor;this.lineWidth=lineWidth;this.moveTo(x+points[0],y+points[1]);var i=2,n=points.length;while(i<n){this.quadraticCurveTo(x+points[i++],y+points[i++],x+points[i++],y+points[i++]);}this.stroke();}},{key:"_fillAndStroke",value:function _fillAndStroke(fillColor,strokeColor,lineWidth){var isConvexPolygon=arguments.length>3&&arguments[3]!==undefined?arguments[3]:false;if(fillColor!=null){this.fillStyle=fillColor;this.fill();}if(strokeColor!=null&&lineWidth>0){this.strokeStyle=strokeColor;this.lineWidth=lineWidth;this.stroke();}}},{key:"_drawCircle",value:function _drawCircle(x,y,radius,fillColor,lineColor,lineWidth,vid){Stat.renderBatches++;this.beginPath(true);this.arc(x,y,radius,0,Context.PI2);this.closePath();this._fillAndStroke(fillColor,lineColor,lineWidth);}},{key:"_drawPie",value:function _drawPie(x,y,radius,startAngle,endAngle,fillColor,lineColor,lineWidth,vid){this.beginPath();this.moveTo(x,y);this.arc(x,y,radius,startAngle,endAngle);this.closePath();this._fillAndStroke(fillColor,lineColor,lineWidth);}},{key:"_drawPoly",value:function _drawPoly(x,y,points,fillColor,lineColor,lineWidth,isConvexPolygon,vid){this.beginPath();this.addPath(points.slice(),true,isConvexPolygon,x,y);this.closePath();this._fillAndStroke(fillColor,lineColor,lineWidth,isConvexPolygon);}},{key:"_drawPath",value:function _drawPath(x,y,paths,brush,pen){this.beginPath();for(var i=0,n=paths.length;i<n;i++){var path=paths[i];switch(path[0]){case"moveTo":this.moveTo(x+path[1],y+path[2]);break;case"lineTo":this.lineTo(x+path[1],y+path[2]);break;case"arcTo":this.arcTo(x+path[1],y+path[2],x+path[3],y+path[4],path[5]);break;case"closePath":this.closePath();break;}}if(brush!=null){this.fillStyle=brush.fillStyle;this.fill();}if(pen!=null){this.strokeStyle=pen.strokeStyle;this.lineWidth=pen.lineWidth||1;this.lineJoin=pen.lineJoin;this.lineCap=pen.lineCap;this.miterLimit=pen.miterLimit;this.stroke();}}},{key:"clearBG",value:function clearBG(r,g,b,a){var gl=WebGLContext.mainContext;gl.clearColor(r,g,b,a);gl.clear(gl.COLOR_BUFFER_BIT);}},{key:"_getSubmits",value:function _getSubmits(){return this._submits;}},{key:"_releaseMem",value:function _releaseMem(){var keepRT=arguments.length>0&&arguments[0]!==undefined?arguments[0]:false;if(!this._submits)return;this._curMat&&this._curMat.destroy();this._curMat=null;this._shader2D.destroy();this._shader2D=null;this._charSubmitCache.clear();for(var i=0,n=this._submits._length;i<n;i++){this._submits[i].releaseRender();}this._submits.length=0;this._submits._length=0;this._submits=null;this._curSubmit=null;this._path=null;this._save=null;var sz;for(i=0,sz=this.meshlist.length;i<sz;i++){var curm=this.meshlist[i];curm.destroy();}this.meshlist.length=0;this.sprite=null;if(!keepRT){this._targets&&this._targets.destroy();this._targets=null;}}},{key:"destroy",value:function destroy(){var keepRT=arguments.length>0&&arguments[0]!==undefined?arguments[0]:false;--Context._contextcount;this.sprite=null;this._releaseMem(keepRT);this._charSubmitCache.destroy();this._mesh.destroy();if(!keepRT){this._targets&&this._targets.destroy();this._targets=null;}}},{key:"clear",value:function clear(){if(!this._submits){this._other=ContextParams.DEFAULT;this._curMat=Matrix.create();this._charSubmitCache=new CharSubmitCache();this._mesh=MeshQuadTexture.getAMesh(this.isMain);this.meshlist.push(this._mesh);this._pathMesh=MeshVG.getAMesh(this.isMain);this.meshlist.push(this._pathMesh);this._triangleMesh=MeshTexture.getAMesh(this.isMain);this.meshlist.push(this._triangleMesh);this._submits=[];this._save=[SaveMark.Create(this)];this._save.length=10;this._shader2D=new Shader2D();}this._submitKey.clear();this._mesh.clearVB();this._drawCount=1;this._other=ContextParams.DEFAULT;this._other.lineWidth=this._shader2D.ALPHA=1.0;this._nBlendType=0;this._clipRect=Context.MAXCLIPRECT;this._curSubmit=SubmitBase.RENDERBASE;SubmitBase.RENDERBASE._ref=0xFFFFFF;SubmitBase.RENDERBASE._numEle=0;this._shader2D.fillStyle=this._shader2D.strokeStyle=DrawStyle.DEFAULT;for(var i=0,n=this._submits._length;i<n;i++){this._submits[i].releaseRender();}this._submits._length=0;this._curMat.identity();this._other.clear();this._saveMark=this._save[0];this._save._length=1;}},{key:"size",value:function size(w,h){if(this._width!=w||this._height!=h){this._width=w;this._height=h;if(this._targets){this._targets.destroy();this._targets=new RenderTexture2D(w,h,exports.RenderTextureFormat.R8G8B8A8,-1);}if(this.isMain){WebGLContext.mainContext.viewport(0,0,w,h);RenderState2D.width=w;RenderState2D.height=h;}}if(w===0&&h===0)this._releaseMem();}},{key:"getMatScaleX",value:function getMatScaleX(){if(this._lastMat_a==this._curMat.a&&this._lastMat_b==this._curMat.b)return this._lastMatScaleX;this._lastMatScaleX=this._curMat.getScaleX();this._lastMat_a=this._curMat.a;this._lastMat_b=this._curMat.b;return this._lastMatScaleX;}},{key:"getMatScaleY",value:function getMatScaleY(){if(this._lastMat_c==this._curMat.c&&this._lastMat_d==this._curMat.d)return this._lastMatScaleY;this._lastMatScaleY=this._curMat.getScaleY();this._lastMat_c=this._curMat.c;this._lastMat_d=this._curMat.d;return this._lastMatScaleY;}},{key:"setFillColor",value:function setFillColor(color){this._fillColor=color;}},{key:"getFillColor",value:function getFillColor(){return this._fillColor;}},{key:"translate",value:function translate(x,y){if(x!==0||y!==0){SaveTranslate.save(this);if(this._curMat._bTransform){SaveTransform.save(this);this._curMat.tx+=x*this._curMat.a+y*this._curMat.c;this._curMat.ty+=x*this._curMat.b+y*this._curMat.d;}else{this._curMat.tx=x;this._curMat.ty=y;}}}},{key:"save",value:function save(){this._save[this._save._length++]=SaveMark.Create(this);}},{key:"restore",value:function restore(){var sz=this._save._length;var lastBlend=this._nBlendType;if(sz<1)return;for(var i=sz-1;i>=0;i--){var o=this._save[i];o.restore(this);if(o.isSaveMark()){this._save._length=i;return;}}if(lastBlend!=this._nBlendType){this._curSubmit=SubmitBase.RENDERBASE;}}},{key:"fillText",value:function fillText(txt,x,y,fontStr,color,align){var lineWidth=arguments.length>6&&arguments[6]!==undefined?arguments[6]:0;var borderColor=arguments.length>7&&arguments[7]!==undefined?arguments[7]:"";Context._textRender.filltext(this,txt,x,y,fontStr,color,borderColor,lineWidth,align);}},{key:"drawText",value:function drawText(text,x,y,font,color,textAlign){Context._textRender.filltext(this,text,x,y,font,color,null,0,textAlign);}},{key:"fillWords",value:function fillWords(words,x,y,fontStr,color){Context._textRender.fillWords(this,words,x,y,fontStr,color,null,0);}},{key:"strokeWord",value:function strokeWord(text,x,y,font,color,lineWidth,textAlign){Context._textRender.filltext(this,text,x,y,font,null,color,lineWidth,textAlign);}},{key:"fillBorderText",value:function fillBorderText(txt,x,y,font,color,borderColor,lineWidth,textAlign){Context._textRender.filltext(this,txt,x,y,font,color,borderColor,lineWidth,textAlign);}},{key:"fillBorderWords",value:function fillBorderWords(words,x,y,font,color,borderColor,lineWidth){Context._textRender.fillWords(this,words,x,y,font,color,borderColor,lineWidth);}},{key:"_fast_filltext",value:function _fast_filltext(data,x,y,fontObj,color,strokeColor,lineWidth,textAlign){var underLine=arguments.length>8&&arguments[8]!==undefined?arguments[8]:0;Context._textRender._fast_filltext(this,data,null,x,y,fontObj,color,strokeColor,lineWidth,textAlign,underLine);}},{key:"_fillRect",value:function _fillRect(x,y,width,height,rgba){var submit=this._curSubmit;var sameKey=submit&&submit._key.submitType===SubmitBase.KEY_DRAWTEXTURE&&submit._key.blendShader===this._nBlendType;if(this._mesh.vertNum+4>Context._MAXVERTNUM){this._mesh=MeshQuadTexture.getAMesh(this.isMain);this.meshlist.push(this._mesh);sameKey=false;}sameKey&&(sameKey=sameKey&&this.isSameClipInfo(submit));this.transformQuad(x,y,width,height,0,this._curMat,this._transedPoints);if(!this.clipedOff(this._transedPoints)){this._mesh.addQuad(this._transedPoints,Texture.NO_UV,rgba,false);if(!sameKey){submit=this._curSubmit=SubmitTexture.create(this,this._mesh,Value2D.create(ShaderDefines2D.TEXTURE2D,0));this._submits[this._submits._length++]=submit;this._copyClipInfo(submit,this._globalClipMatrix);submit.shaderValue.textureHost=this._lastTex;submit._key.other=this._lastTex&&this._lastTex.bitmap?this._lastTex.bitmap.id:-1;submit._renderType=SubmitBase.TYPE_TEXTURE;}this._curSubmit._numEle+=6;this._mesh.indexNum+=6;this._mesh.vertNum+=4;}}},{key:"fillRect",value:function fillRect(x,y,width,height,fillStyle){var drawstyle=fillStyle?DrawStyle.create(fillStyle):this._shader2D.fillStyle;var rgba=this.mixRGBandAlpha(drawstyle.toInt());this._fillRect(x,y,width,height,rgba);}},{key:"fillTexture",value:function fillTexture(texture,x,y,width,height,type,offset,other){if(!texture._getSource()){this.sprite&&ILaya.systemTimer.callLater(this,this._repaintSprite);return;}this._fillTexture(texture,texture.width,texture.height,texture.uvrect,x,y,width,height,type,offset.x,offset.y);}},{key:"_fillTexture",value:function _fillTexture(texture,texw,texh,texuvRect,x,y,width,height,type,offsetx,offsety){var submit=this._curSubmit;if(this._mesh.vertNum+4>Context._MAXVERTNUM){this._mesh=MeshQuadTexture.getAMesh(this.isMain);this.meshlist.push(this._mesh);}var repeatx=true;var repeaty=true;switch(type){case"repeat":break;case"repeat-x":repeaty=false;break;case"repeat-y":repeatx=false;break;case"no-repeat":repeatx=repeaty=false;break;default:break;}var uv=this._temp4Points;var stu=0;var stv=0;var stx=0,sty=0,edx=0,edy=0;if(offsetx<0){stx=x;stu=-offsetx%texw/texw;}else{stx=x+offsetx;}if(offsety<0){sty=y;stv=-offsety%texh/texh;}else{sty=y+offsety;}edx=x+width;edy=y+height;!repeatx&&(edx=Math.min(edx,x+offsetx+texw));!repeaty&&(edy=Math.min(edy,y+offsety+texh));if(edx<x||edy<y)return;if(stx>edx||sty>edy)return;var edu=(edx-x-offsetx)/texw;var edv=(edy-y-offsety)/texh;this.transformQuad(stx,sty,edx-stx,edy-sty,0,this._curMat,this._transedPoints);uv[0]=stu;uv[1]=stv;uv[2]=edu;uv[3]=stv;uv[4]=edu;uv[5]=edv;uv[6]=stu;uv[7]=edv;if(!this.clipedOff(this._transedPoints)){var rgba=this._mixRGBandAlpha(0xffffffff,this._shader2D.ALPHA);this._mesh.addQuad(this._transedPoints,uv,rgba,true);var sv=Value2D.create(ShaderDefines2D.TEXTURE2D,0);sv.defines.add(ShaderDefines2D.FILLTEXTURE);sv.u_TexRange=texuvRect.concat();submit=this._curSubmit=SubmitTexture.create(this,this._mesh,sv);this._submits[this._submits._length++]=submit;this._copyClipInfo(submit,this._globalClipMatrix);submit.shaderValue.textureHost=texture;submit._renderType=SubmitBase.TYPE_TEXTURE;this._curSubmit._numEle+=6;this._mesh.indexNum+=6;this._mesh.vertNum+=4;}this.breakNextMerge();}},{key:"setColorFilter",value:function setColorFilter(filter){SaveBase.save(this,SaveBase.TYPE_COLORFILTER,this,true);this._colorFiler=filter;this._curSubmit=SubmitBase.RENDERBASE;}},{key:"drawTexture",value:function drawTexture(tex,x,y,width,height){this._drawTextureM(tex,x,y,width,height,null,1,null);}},{key:"drawTextures",value:function drawTextures(tex,pos,tx,ty){if(!tex._getSource()){this.sprite&&ILaya.systemTimer.callLater(this,this._repaintSprite);return;}var n=pos.length/2;var ipos=0;var bmpid=tex.bitmap.id;for(var i=0;i<n;i++){this._inner_drawTexture(tex,bmpid,pos[ipos++]+tx,pos[ipos++]+ty,0,0,null,null,1.0,false);}}},{key:"_drawTextureAddSubmit",value:function _drawTextureAddSubmit(imgid,tex){var submit=null;submit=SubmitTexture.create(this,this._mesh,Value2D.create(ShaderDefines2D.TEXTURE2D,0));this._submits[this._submits._length++]=submit;submit.shaderValue.textureHost=tex;submit._key.other=imgid;submit._renderType=SubmitBase.TYPE_TEXTURE;this._curSubmit=submit;}},{key:"_drawTextureM",value:function _drawTextureM(tex,x,y,width,height,m,alpha,uv){var cs=this.sprite;if(!tex._getSource(function(){if(cs){cs.repaint();}})){return false;}return this._inner_drawTexture(tex,tex.bitmap.id,x,y,width,height,m,uv,alpha,false);}},{key:"_drawRenderTexture",value:function _drawRenderTexture(tex,x,y,width,height,m,alpha,uv){return this._inner_drawTexture(tex,-1,x,y,width,height,m,uv,1.0,false);}},{key:"submitDebugger",value:function submitDebugger(){this._submits[this._submits._length++]=SubmitCMD.create([],function(){debugger;},this);}},{key:"_copyClipInfo",value:function _copyClipInfo(submit,clipInfo){var cm=submit.shaderValue.clipMatDir;cm[0]=clipInfo.a;cm[1]=clipInfo.b;cm[2]=clipInfo.c;cm[3]=clipInfo.d;var cmp=submit.shaderValue.clipMatPos;cmp[0]=clipInfo.tx;cmp[1]=clipInfo.ty;submit.clipInfoID=this._clipInfoID;if(this._clipInCache){submit.shaderValue.clipOff[0]=1;}}},{key:"isSameClipInfo",value:function isSameClipInfo(submit){return submit.clipInfoID===this._clipInfoID;}},{key:"_useNewTex2DSubmit",value:function _useNewTex2DSubmit(tex,minVertNum){if(this._mesh.vertNum+minVertNum>Context._MAXVERTNUM){this._mesh=MeshQuadTexture.getAMesh(this.isMain);this.meshlist.push(this._mesh);}var submit=SubmitTexture.create(this,this._mesh,Value2D.create(ShaderDefines2D.TEXTURE2D,0));this._submits[this._submits._length++]=this._curSubmit=submit;submit.shaderValue.textureHost=tex;this._copyClipInfo(submit,this._globalClipMatrix);}},{key:"_drawTexRect",value:function _drawTexRect(x,y,w,h,uv){this.transformQuad(x,y,w,h,this._italicDeg,this._curMat,this._transedPoints);var ops=this._transedPoints;ops[0]=ops[0]+0.5|0;ops[1]=ops[1]+0.5|0;ops[2]=ops[2]+0.5|0;ops[3]=ops[3]+0.5|0;ops[4]=ops[4]+0.5|0;ops[5]=ops[5]+0.5|0;ops[6]=ops[6]+0.5|0;ops[7]=ops[7]+0.5|0;if(!this.clipedOff(this._transedPoints)){this._mesh.addQuad(this._transedPoints,uv,this._fillColor,true);this._curSubmit._numEle+=6;this._mesh.indexNum+=6;this._mesh.vertNum+=4;}}},{key:"drawCallOptimize",value:function drawCallOptimize(enable){this._charSubmitCache.enable(enable,this);return enable;}},{key:"_inner_drawTexture",value:function _inner_drawTexture(tex,imgid,x,y,width,height,m,uv,alpha,lastRender){var preKey=this._curSubmit._key;uv=uv||tex._uv;if(preKey.submitType===SubmitBase.KEY_TRIANGLES&&preKey.other===imgid){var tv=this._drawTexToDrawTri_Vert;tv[0]=x;tv[1]=y;tv[2]=x+width,tv[3]=y,tv[4]=x+width,tv[5]=y+height,tv[6]=x,tv[7]=y+height;this._drawTriUseAbsMatrix=true;var tuv=this._tempUV;tuv[0]=uv[0];tuv[1]=uv[1];tuv[2]=uv[2];tuv[3]=uv[3];tuv[4]=uv[4];tuv[5]=uv[5];tuv[6]=uv[6];tuv[7]=uv[7];this.drawTriangles(tex,0,0,tv,tuv,this._drawTexToDrawTri_Index,m,alpha,null,null);this._drawTriUseAbsMatrix=false;return true;}var mesh=this._mesh;var submit=this._curSubmit;var ops=lastRender?this._charSubmitCache.getPos():this._transedPoints;this.transformQuad(x,y,width||tex.width,height||tex.height,this._italicDeg,m||this._curMat,ops);if(this.drawTexAlign){var round=Math.round;ops[0]=round(ops[0]);ops[1]=round(ops[1]);ops[2]=round(ops[2]);ops[3]=round(ops[3]);ops[4]=round(ops[4]);ops[5]=round(ops[5]);ops[6]=round(ops[6]);ops[7]=round(ops[7]);this.drawTexAlign=false;}var rgba=this._mixRGBandAlpha(0xffffffff,this._shader2D.ALPHA*alpha);if(lastRender){this._charSubmitCache.add(this,tex,imgid,ops,uv,rgba);return true;}this._drawCount++;var sameKey=imgid>=0&&preKey.submitType===SubmitBase.KEY_DRAWTEXTURE&&preKey.other===imgid;sameKey&&(sameKey=sameKey&&this.isSameClipInfo(submit));this._lastTex=tex;if(mesh.vertNum+4>Context._MAXVERTNUM){mesh=this._mesh=MeshQuadTexture.getAMesh(this.isMain);this.meshlist.push(mesh);sameKey=false;}{mesh.addQuad(ops,uv,rgba,true);if(!sameKey){this._submits[this._submits._length++]=this._curSubmit=submit=SubmitTexture.create(this,mesh,Value2D.create(ShaderDefines2D.TEXTURE2D,0));submit.shaderValue.textureHost=tex;submit._key.other=imgid;this._copyClipInfo(submit,this._globalClipMatrix);}submit._numEle+=6;mesh.indexNum+=6;mesh.vertNum+=4;return true;}return false;}},{key:"transform4Points",value:function transform4Points(a,m,out){var tx=m.tx;var ty=m.ty;var ma=m.a;var mb=m.b;var mc=m.c;var md=m.d;var a0=a[0];var a1=a[1];var a2=a[2];var a3=a[3];var a4=a[4];var a5=a[5];var a6=a[6];var a7=a[7];if(m._bTransform){out[0]=a0*ma+a1*mc+tx;out[1]=a0*mb+a1*md+ty;out[2]=a2*ma+a3*mc+tx;out[3]=a2*mb+a3*md+ty;out[4]=a4*ma+a5*mc+tx;out[5]=a4*mb+a5*md+ty;out[6]=a6*ma+a7*mc+tx;out[7]=a6*mb+a7*md+ty;}else{out[0]=a0+tx;out[1]=a1+ty;out[2]=a2+tx;out[3]=a3+ty;out[4]=a4+tx;out[5]=a5+ty;out[6]=a6+tx;out[7]=a7+ty;}}},{key:"clipedOff",value:function clipedOff(pt){if(this._clipRect.width<=0||this._clipRect.height<=0)return true;return false;}},{key:"transformQuad",value:function transformQuad(x,y,w,h,italicDeg,m,out){var xoff=0;if(italicDeg!=0){xoff=Math.tan(italicDeg*Math.PI/180)*h;}var maxx=x+w;var maxy=y+h;var tx=m.tx;var ty=m.ty;var ma=m.a;var mb=m.b;var mc=m.c;var md=m.d;var a0=x+xoff;var a1=y;var a2=maxx+xoff;var a3=y;var a4=maxx;var a5=maxy;var a6=x;var a7=maxy;if(m._bTransform){out[0]=a0*ma+a1*mc+tx;out[1]=a0*mb+a1*md+ty;out[2]=a2*ma+a3*mc+tx;out[3]=a2*mb+a3*md+ty;out[4]=a4*ma+a5*mc+tx;out[5]=a4*mb+a5*md+ty;out[6]=a6*ma+a7*mc+tx;out[7]=a6*mb+a7*md+ty;}else{out[0]=a0+tx;out[1]=a1+ty;out[2]=a2+tx;out[3]=a3+ty;out[4]=a4+tx;out[5]=a5+ty;out[6]=a6+tx;out[7]=a7+ty;}}},{key:"pushRT",value:function pushRT(){this.addRenderObject(SubmitCMD.create(null,RenderTexture2D.pushRT,this));}},{key:"popRT",value:function popRT(){this.addRenderObject(SubmitCMD.create(null,RenderTexture2D.popRT,this));this.breakNextMerge();}},{key:"useRT",value:function useRT(rt){function _use(rt){if(!rt){throw'error useRT';}else{rt.start();rt.clear(0,0,0,0);}}this.addRenderObject(SubmitCMD.create([rt],_use,this));this.breakNextMerge();}},{key:"RTRestore",value:function RTRestore(rt){function _restore(rt){rt.restore();}this.addRenderObject(SubmitCMD.create([rt],_restore,this));this.breakNextMerge();}},{key:"breakNextMerge",value:function breakNextMerge(){this._curSubmit=SubmitBase.RENDERBASE;}},{key:"_repaintSprite",value:function _repaintSprite(){this.sprite&&this.sprite.repaint();}},{key:"drawTextureWithTransform",value:function drawTextureWithTransform(tex,x,y,width,height,transform,tx,ty,alpha,blendMode){var colorfilter=arguments.length>10&&arguments[10]!==undefined?arguments[10]:null;var uv=arguments[11];var oldcomp;var curMat=this._curMat;if(blendMode){oldcomp=this.globalCompositeOperation;this.globalCompositeOperation=blendMode;}var oldColorFilter=this._colorFiler;if(colorfilter){this.setColorFilter(colorfilter);}if(!transform){this._drawTextureM(tex,x+tx,y+ty,width,height,curMat,alpha,uv);if(blendMode){this.globalCompositeOperation=oldcomp;}if(colorfilter){this.setColorFilter(oldColorFilter);}return;}var tmpMat=this._tmpMatrix;tmpMat.a=transform.a;tmpMat.b=transform.b;tmpMat.c=transform.c;tmpMat.d=transform.d;tmpMat.tx=transform.tx+tx;tmpMat.ty=transform.ty+ty;tmpMat._bTransform=transform._bTransform;if(transform&&curMat._bTransform){Matrix.mul(tmpMat,curMat,tmpMat);transform=tmpMat;transform._bTransform=true;}else{tmpMat.tx+=curMat.tx;tmpMat.ty+=curMat.ty;transform=tmpMat;}this._drawTextureM(tex,x,y,width,height,transform,alpha,uv);if(blendMode){this.globalCompositeOperation=oldcomp;}if(colorfilter){this.setColorFilter(oldColorFilter);}}},{key:"_flushToTarget",value:function _flushToTarget(context,target){RenderState2D.worldScissorTest=false;var gl=LayaGL.instance;gl.disable(gl.SCISSOR_TEST);var preAlpha=RenderState2D.worldAlpha;var preMatrix4=RenderState2D.worldMatrix4;var preMatrix=RenderState2D.worldMatrix;RenderState2D.worldMatrix=Matrix.EMPTY;RenderState2D.restoreTempArray();RenderState2D.worldMatrix4=RenderState2D.TEMPMAT4_ARRAY;RenderState2D.worldAlpha=1;BaseShader.activeShader=null;target.start();if(context._submits._length>0)target.clear(0,0,0,0);context._curSubmit=SubmitBase.RENDERBASE;context.flush();context.clear();target.restore();context._curSubmit=SubmitBase.RENDERBASE;BaseShader.activeShader=null;RenderState2D.worldAlpha=preAlpha;RenderState2D.worldMatrix4=preMatrix4;RenderState2D.worldMatrix=preMatrix;}},{key:"drawCanvas",value:function drawCanvas(canvas,x,y,width,height){if(!canvas)return;var src=canvas.context;var submit;if(src._targets){if(src._submits._length>0){submit=SubmitCMD.create([src,src._targets],this._flushToTarget,this);this._submits[this._submits._length++]=submit;}this._drawRenderTexture(src._targets,x,y,width,height,null,1.0,RenderTexture2D.flipyuv);this._curSubmit=SubmitBase.RENDERBASE;}else{var canv=canvas;if(canv.touches){canv.touches.forEach(function(v){v.touch();});}submit=SubmitCanvas.create(canvas,this._shader2D.ALPHA,this._shader2D.filters);this._submits[this._submits._length++]=submit;submit._key.clear();var mat=submit._matrix;this._curMat.copyTo(mat);var tx=mat.tx,ty=mat.ty;mat.tx=mat.ty=0;mat.transformPoint(Point.TEMP.setTo(x,y));mat.translate(Point.TEMP.x+tx,Point.TEMP.y+ty);Matrix.mul(canv.invMat,mat,mat);this._curSubmit=SubmitBase.RENDERBASE;}}},{key:"drawTarget",value:function drawTarget(rt,x,y,width,height,m,shaderValue){var uv=arguments.length>7&&arguments[7]!==undefined?arguments[7]:null;var blend=arguments.length>8&&arguments[8]!==undefined?arguments[8]:-1;this._drawCount++;if(this._mesh.vertNum+4>Context._MAXVERTNUM){this._mesh=MeshQuadTexture.getAMesh(this.isMain);this.meshlist.push(this._mesh);}this.transformQuad(x,y,width,height,0,m||this._curMat,this._transedPoints);if(!this.clipedOff(this._transedPoints)){this._mesh.addQuad(this._transedPoints,uv||Texture.DEF_UV,0xffffffff,true);var submit=this._curSubmit=SubmitTarget.create(this,this._mesh,shaderValue,rt);submit.blendType=blend==-1?this._nBlendType:blend;this._copyClipInfo(submit,this._globalClipMatrix);submit._numEle=6;this._mesh.indexNum+=6;this._mesh.vertNum+=4;this._submits[this._submits._length++]=submit;this._curSubmit=SubmitBase.RENDERBASE;return true;}this._curSubmit=SubmitBase.RENDERBASE;return false;}},{key:"drawTriangles",value:function drawTriangles(tex,x,y,vertices,uvs,indices,matrix,alpha,color,blendMode){var colorNum=arguments.length>10&&arguments[10]!==undefined?arguments[10]:0xffffffff;var oldcomp=null;if(blendMode){oldcomp=this.globalCompositeOperation;this.globalCompositeOperation=blendMode;}if(!tex._getSource()){if(this.sprite){ILaya.systemTimer.callLater(this,this._repaintSprite);}return;}this._drawCount++;var tmpMat=this._tmpMatrix;var triMesh=this._triangleMesh;var oldColorFilter=null;var needRestorFilter=false;if(color){oldColorFilter=this._colorFiler;this._colorFiler=color;this._curSubmit=SubmitBase.RENDERBASE;needRestorFilter=oldColorFilter!=color;}var webGLImg=tex.bitmap;var preKey=this._curSubmit._key;var sameKey=preKey.submitType===SubmitBase.KEY_TRIANGLES&&preKey.other===webGLImg.id&&preKey.blendShader==this._nBlendType;if(triMesh.vertNum+vertices.length/2>Context._MAXVERTNUM){triMesh=this._triangleMesh=MeshTexture.getAMesh(this.isMain);this.meshlist.push(triMesh);sameKey=false;}if(!sameKey){var submit=this._curSubmit=SubmitTexture.create(this,triMesh,Value2D.create(ShaderDefines2D.TEXTURE2D,0));submit.shaderValue.textureHost=tex;submit._renderType=SubmitBase.TYPE_TEXTURE;submit._key.submitType=SubmitBase.KEY_TRIANGLES;submit._key.other=webGLImg.id;this._copyClipInfo(submit,this._globalClipMatrix);this._submits[this._submits._length++]=submit;}var rgba=this._mixRGBandAlpha(colorNum,this._shader2D.ALPHA*alpha);if(!this._drawTriUseAbsMatrix){if(!matrix){tmpMat.a=1;tmpMat.b=0;tmpMat.c=0;tmpMat.d=1;tmpMat.tx=x;tmpMat.ty=y;}else{tmpMat.a=matrix.a;tmpMat.b=matrix.b;tmpMat.c=matrix.c;tmpMat.d=matrix.d;tmpMat.tx=matrix.tx+x;tmpMat.ty=matrix.ty+y;}Matrix.mul(tmpMat,this._curMat,tmpMat);triMesh.addData(vertices,uvs,indices,tmpMat||this._curMat,rgba);}else{triMesh.addData(vertices,uvs,indices,matrix,rgba);}this._curSubmit._numEle+=indices.length;if(needRestorFilter){this._colorFiler=oldColorFilter;this._curSubmit=SubmitBase.RENDERBASE;}if(blendMode){this.globalCompositeOperation=oldcomp;}}},{key:"transform",value:function transform(a,b,c,d,tx,ty){SaveTransform.save(this);Matrix.mul(Matrix.TEMP.setTo(a,b,c,d,tx,ty),this._curMat,this._curMat);this._curMat._checkTransform();}},{key:"_transformByMatrix",value:function _transformByMatrix(matrix,tx,ty){matrix.setTranslate(tx,ty);Matrix.mul(matrix,this._curMat,this._curMat);matrix.setTranslate(0,0);this._curMat._bTransform=true;}},{key:"setTransformByMatrix",value:function setTransformByMatrix(value){value.copyTo(this._curMat);}},{key:"rotate",value:function rotate(angle){SaveTransform.save(this);this._curMat.rotateEx(angle);}},{key:"scale",value:function scale(scaleX,scaleY){SaveTransform.save(this);this._curMat.scaleEx(scaleX,scaleY);}},{key:"clipRect",value:function clipRect(x,y,width,height){SaveClipRect.save(this);if(this._clipRect==Context.MAXCLIPRECT){this._clipRect=new Rectangle(x,y,width,height);}else{this._clipRect.width=width;this._clipRect.height=height;this._clipRect.x=x;this._clipRect.y=y;}this._clipID_Gen++;this._clipID_Gen%=10000;this._clipInfoID=this._clipID_Gen;var cm=this._globalClipMatrix;var minx=cm.tx;var miny=cm.ty;var maxx=minx+cm.a;var maxy=miny+cm.d;if(this._clipRect.width>=Context._MAXSIZE){cm.a=cm.d=Context._MAXSIZE;cm.b=cm.c=cm.tx=cm.ty=0;}else{if(this._curMat._bTransform){cm.tx=this._clipRect.x*this._curMat.a+this._clipRect.y*this._curMat.c+this._curMat.tx;cm.ty=this._clipRect.x*this._curMat.b+this._clipRect.y*this._curMat.d+this._curMat.ty;cm.a=this._clipRect.width*this._curMat.a;cm.b=this._clipRect.width*this._curMat.b;cm.c=this._clipRect.height*this._curMat.c;cm.d=this._clipRect.height*this._curMat.d;}else{cm.tx=this._clipRect.x+this._curMat.tx;cm.ty=this._clipRect.y+this._curMat.ty;cm.a=this._clipRect.width;cm.b=cm.c=0;cm.d=this._clipRect.height;}if(this._incache){this._clipInCache=true;}}if(cm.a>0&&cm.d>0){var cmaxx=cm.tx+cm.a;var cmaxy=cm.ty+cm.d;if(cmaxx<=minx||cmaxy<=miny||cm.tx>=maxx||cm.ty>=maxy){cm.a=-0.1;cm.d=-0.1;}else{if(cm.tx<minx){cm.a-=minx-cm.tx;cm.tx=minx;}if(cmaxx>maxx){cm.a-=cmaxx-maxx;}if(cm.ty<miny){cm.d-=miny-cm.ty;cm.ty=miny;}if(cmaxy>maxy){cm.d-=cmaxy-maxy;}if(cm.a<=0)cm.a=-0.1;if(cm.d<=0)cm.d=-0.1;}}}},{key:"drawMesh",value:function drawMesh(x,y,ib,vb,numElement,mat,shader,shaderValues){var startIndex=arguments.length>8&&arguments[8]!==undefined?arguments[8]:0;}},{key:"addRenderObject",value:function addRenderObject(o){this._submits[this._submits._length++]=o;}},{key:"submitElement",value:function submitElement(start,end){var mainCtx=this.isMain;var renderList=this._submits;var ret=renderList._length;end<0&&(end=renderList._length);var submit=SubmitBase.RENDERBASE;while(start<end){this._renderNextSubmitIndex=start+1;if(renderList[start]===SubmitBase.RENDERBASE){start++;continue;}SubmitBase.preRender=submit;submit=renderList[start];start+=submit.renderSubmit();}return ret;}},{key:"flush",value:function flush(){this._clipID_Gen=0;var ret=this.submitElement(0,this._submits._length);this._path&&this._path.reset();SkinMeshBuffer.instance&&SkinMeshBuffer.getInstance().reset();this._curSubmit=SubmitBase.RENDERBASE;for(var i=0,sz=this.meshlist.length;i<sz;i++){var curm=this.meshlist[i];curm.canReuse?curm.releaseMesh():curm.destroy();}this.meshlist.length=0;this._mesh=MeshQuadTexture.getAMesh(this.isMain);this._pathMesh=MeshVG.getAMesh(this.isMain);this._triangleMesh=MeshTexture.getAMesh(this.isMain);this.meshlist.push(this._mesh,this._pathMesh,this._triangleMesh);this._flushCnt++;if(this._flushCnt%60==0&&this.isMain){if(TextRender.textRenderInst){TextRender.textRenderInst.GC();}}return ret;}},{key:"beginPath",value:function beginPath(){var convex=arguments.length>0&&arguments[0]!==undefined?arguments[0]:false;var tPath=this._getPath();tPath.beginPath(convex);}},{key:"closePath",value:function closePath(){this._path.closePath();}},{key:"addPath",value:function addPath(points,close,convex,dx,dy){var ci=0;for(var i=0,sz=points.length/2;i<sz;i++){var x1=points[ci]+dx,y1=points[ci+1]+dy;points[ci]=x1;points[ci+1]=y1;ci+=2;}this._getPath().push(points,convex);}},{key:"fill",value:function fill(){var m=this._curMat;var tPath=this._getPath();var submit=this._curSubmit;var sameKey=submit._key.submitType===SubmitBase.KEY_VG&&submit._key.blendShader===this._nBlendType;sameKey&&(sameKey=sameKey&&this.isSameClipInfo(submit));if(!sameKey){this._curSubmit=this.addVGSubmit(this._pathMesh);}var rgba=this.mixRGBandAlpha(this.fillStyle.toInt());var curEleNum=0;var idx;for(var i=0,sz=tPath.paths.length;i<sz;i++){var p=tPath.paths[i];var vertNum=p.path.length/2;if(vertNum<3||vertNum==3&&!p.convex)continue;var cpath=p.path.concat();var pi=0;var xp,yp;var _x,_y;if(m._bTransform){for(pi=0;pi<vertNum;pi++){xp=pi<<1;yp=xp+1;_x=cpath[xp];_y=cpath[yp];cpath[xp]=m.a*_x+m.c*_y+m.tx;cpath[yp]=m.b*_x+m.d*_y+m.ty;}}else{for(pi=0;pi<vertNum;pi++){xp=pi<<1;yp=xp+1;_x=cpath[xp];_y=cpath[yp];cpath[xp]=_x+m.tx;cpath[yp]=_y+m.ty;}}if(this._pathMesh.vertNum+vertNum>Context._MAXVERTNUM){this._curSubmit._numEle+=curEleNum;curEleNum=0;this._pathMesh=MeshVG.getAMesh(this.isMain);this._curSubmit=this.addVGSubmit(this._pathMesh);}var curvert=this._pathMesh.vertNum;if(p.convex){var faceNum=vertNum-2;idx=new Array(faceNum*3);var idxpos=0;for(var fi=0;fi<faceNum;fi++){idx[idxpos++]=curvert;idx[idxpos++]=fi+1+curvert;idx[idxpos++]=fi+2+curvert;}}else{idx=Earcut.earcut(cpath,null,2);if(curvert>0){for(var ii=0;ii<idx.length;ii++){idx[ii]+=curvert;}}}this._pathMesh.addVertAndIBToMesh(this,cpath,rgba,idx);curEleNum+=idx.length;}this._curSubmit._numEle+=curEleNum;}},{key:"addVGSubmit",value:function addVGSubmit(mesh){var submit=Submit.createShape(this,mesh,0,Value2D.create(ShaderDefines2D.PRIMITIVE,0));submit._key.submitType=SubmitBase.KEY_VG;this._submits[this._submits._length++]=submit;this._copyClipInfo(submit,this._globalClipMatrix);return submit;}},{key:"stroke",value:function stroke(){if(this.lineWidth>0){var rgba=this.mixRGBandAlpha(this.strokeStyle._color.numColor);var tPath=this._getPath();var submit=this._curSubmit;var sameKey=submit._key.submitType===SubmitBase.KEY_VG&&submit._key.blendShader===this._nBlendType;sameKey&&(sameKey=sameKey&&this.isSameClipInfo(submit));if(!sameKey){this._curSubmit=this.addVGSubmit(this._pathMesh);}var curEleNum=0;for(var i=0,sz=tPath.paths.length;i<sz;i++){var p=tPath.paths[i];if(p.path.length<=0)continue;var idx=[];var vertex=[];var maxVertexNum=p.path.length*2;if(maxVertexNum<2)continue;if(this._pathMesh.vertNum+maxVertexNum>Context._MAXVERTNUM){this._curSubmit._numEle+=curEleNum;curEleNum=0;this._pathMesh=MeshVG.getAMesh(this.isMain);this.meshlist.push(this._pathMesh);this._curSubmit=this.addVGSubmit(this._pathMesh);}BasePoly.createLine2(p.path,idx,this.lineWidth,this._pathMesh.vertNum,vertex,p.loop);var ptnum=vertex.length/2;var m=this._curMat;var pi=0;var xp,yp;var _x,_y;if(m._bTransform){for(pi=0;pi<ptnum;pi++){xp=pi<<1;yp=xp+1;_x=vertex[xp];_y=vertex[yp];vertex[xp]=m.a*_x+m.c*_y+m.tx;vertex[yp]=m.b*_x+m.d*_y+m.ty;}}else{for(pi=0;pi<ptnum;pi++){xp=pi<<1;yp=xp+1;_x=vertex[xp];_y=vertex[yp];vertex[xp]=_x+m.tx;vertex[yp]=_y+m.ty;}}this._pathMesh.addVertAndIBToMesh(this,vertex,rgba,idx);curEleNum+=idx.length;}this._curSubmit._numEle+=curEleNum;}}},{key:"moveTo",value:function moveTo(x,y){var tPath=this._getPath();tPath.newPath();tPath._lastOriX=x;tPath._lastOriY=y;tPath.addPoint(x,y);}},{key:"lineTo",value:function lineTo(x,y){var tPath=this._getPath();if(Math.abs(x-tPath._lastOriX)<1e-3&&Math.abs(y-tPath._lastOriY)<1e-3)return;tPath._lastOriX=x;tPath._lastOriY=y;tPath.addPoint(x,y);}},{key:"arcTo",value:function arcTo(x1,y1,x2,y2,r){var i=0;var x=0,y=0;var dx=this._path._lastOriX-x1;var dy=this._path._lastOriY-y1;var len1=Math.sqrt(dx*dx+dy*dy);if(len1<=0.000001){return;}var ndx=dx/len1;var ndy=dy/len1;var dx2=x2-x1;var dy2=y2-y1;var len22=dx2*dx2+dy2*dy2;var len2=Math.sqrt(len22);if(len2<=0.000001){return;}var ndx2=dx2/len2;var ndy2=dy2/len2;var odx=ndx+ndx2;var ody=ndy+ndy2;var olen=Math.sqrt(odx*odx+ody*ody);if(olen<=0.000001){return;}var nOdx=odx/olen;var nOdy=ody/olen;var alpha=Math.acos(nOdx*ndx+nOdy*ndy);var halfAng=Math.PI/2-alpha;len1=r/Math.tan(halfAng);var ptx1=len1*ndx+x1;var pty1=len1*ndy+y1;var orilen=Math.sqrt(len1*len1+r*r);var orix=x1+nOdx*orilen;var oriy=y1+nOdy*orilen;var dir=ndx*ndy2-ndy*ndx2;var fChgAng=0;var sinx=0.0;var cosx=0.0;if(dir>=0){fChgAng=halfAng*2;var fda=fChgAng/Context.SEGNUM;sinx=Math.sin(fda);cosx=Math.cos(fda);}else{fChgAng=-halfAng*2;fda=fChgAng/Context.SEGNUM;sinx=Math.sin(fda);cosx=Math.cos(fda);}var lastx=this._path._lastOriX,lasty=this._path._lastOriY;var _x1=ptx1,_y1=pty1;if(Math.abs(_x1-this._path._lastOriX)>0.1||Math.abs(_y1-this._path._lastOriY)>0.1){x=_x1;y=_y1;lastx=_x1;lasty=_y1;this._path._lastOriX=x;this._path._lastOriY=y;this._path.addPoint(x,y);}var cvx=ptx1-orix;var cvy=pty1-oriy;for(i=0;i<Context.SEGNUM;i++){var cx=cvx*cosx+cvy*sinx;var cy=-cvx*sinx+cvy*cosx;x=cx+orix;y=cy+oriy;if(Math.abs(lastx-x)>0.1||Math.abs(lasty-y)>0.1){this._path._lastOriX=x;this._path._lastOriY=y;this._path.addPoint(x,y);lastx=x;lasty=y;}cvx=cx;cvy=cy;}}},{key:"arc",value:function arc(cx,cy,r,startAngle,endAngle){var counterclockwise=arguments.length>5&&arguments[5]!==undefined?arguments[5]:false;var b=arguments.length>6&&arguments[6]!==undefined?arguments[6]:true;var a=0,da=0;var dx=0,dy=0,x=0,y=0;var i,ndivs;da=endAngle-startAngle;if(!counterclockwise){if(Math.abs(da)>=Math.PI*2){da=Math.PI*2;}else{while(da<0.0){da+=Math.PI*2;}}}else{if(Math.abs(da)>=Math.PI*2){da=-Math.PI*2;}else{while(da>0.0){da-=Math.PI*2;}}}var sx=this.getMatScaleX();var sy=this.getMatScaleY();var sr=r*(sx>sy?sx:sy);var cl=2*Math.PI*sr;ndivs=Math.max(cl/10,10)|0;var tPath=this._getPath();for(i=0;i<=ndivs;i++){a=startAngle+da*(i/ndivs);dx=Math.cos(a);dy=Math.sin(a);x=cx+dx*r;y=cy+dy*r;if(x!=this._path._lastOriX||y!=this._path._lastOriY){tPath.addPoint(x,y);}}dx=Math.cos(endAngle);dy=Math.sin(endAngle);x=cx+dx*r;y=cy+dy*r;if(x!=this._path._lastOriX||y!=this._path._lastOriY){tPath.addPoint(x,y);}}},{key:"quadraticCurveTo",value:function quadraticCurveTo(cpx,cpy,x,y){var tBezier=Bezier.I;var tArray=tBezier.getBezierPoints([this._path._lastOriX,this._path._lastOriY,cpx,cpy,x,y],30,2);for(var i=0,n=tArray.length/2;i<n;i++){this.lineTo(tArray[i*2],tArray[i*2+1]);}this.lineTo(x,y);}},{key:"mixRGBandAlpha",value:function mixRGBandAlpha(color){return this._mixRGBandAlpha(color,this._shader2D.ALPHA);}},{key:"_mixRGBandAlpha",value:function _mixRGBandAlpha(color,alpha){if(alpha>=1){return color;}var a=(color&0xff000000)>>>24;if(a!=0){a*=alpha;}else{a=alpha*255;}return color&0x00ffffff|a<<24;}},{key:"strokeRect",value:function strokeRect(x,y,width,height,parameterLineWidth){if(this.lineWidth>0){var rgba=this.mixRGBandAlpha(this.strokeStyle._color.numColor);var hw=this.lineWidth/2;this._fillRect(x-hw,y-hw,width+this.lineWidth,this.lineWidth,rgba);this._fillRect(x-hw,y-hw+height,width+this.lineWidth,this.lineWidth,rgba);this._fillRect(x-hw,y+hw,this.lineWidth,height-this.lineWidth,rgba);this._fillRect(x-hw+width,y+hw,this.lineWidth,height-this.lineWidth,rgba);}}},{key:"clip",value:function clip(){}},{key:"drawParticle",value:function drawParticle(x,y,pt){pt.x=x;pt.y=y;this._submits[this._submits._length++]=pt;}},{key:"_getPath",value:function _getPath(){return this._path||(this._path=new Path());}},{key:"_fillTexture_h",value:function _fillTexture_h(tex,imgid,uv,oriw,orih,x,y,w){if(oriw<=0)console.error('_fillTexture_h error: oriw must>0');var stx=x;var num=Math.floor(w/oriw);var left=w%oriw;for(var i=0;i<num;i++){this._inner_drawTexture(tex,imgid,stx,y,oriw,orih,this._curMat,uv,1,false);stx+=oriw;}if(left>0){var du=uv[2]-uv[0];var uvr=uv[0]+du*(left/oriw);var tuv=Context.tmpuv1;tuv[0]=uv[0];tuv[1]=uv[1];tuv[2]=uvr;tuv[3]=uv[3];tuv[4]=uvr;tuv[5]=uv[5];tuv[6]=uv[6];tuv[7]=uv[7];this._inner_drawTexture(tex,imgid,stx,y,left,orih,this._curMat,tuv,1,false);}}},{key:"_fillTexture_v",value:function _fillTexture_v(tex,imgid,uv,oriw,orih,x,y,h){if(orih<=0)console.error('_fillTexture_v error: orih must>0');var sty=y;var num=Math.floor(h/orih);var left=h%orih;for(var i=0;i<num;i++){this._inner_drawTexture(tex,imgid,x,sty,oriw,orih,this._curMat,uv,1,false);sty+=orih;}if(left>0){var dv=uv[7]-uv[1];var uvb=uv[1]+dv*(left/orih);var tuv=Context.tmpuv1;tuv[0]=uv[0];tuv[1]=uv[1];tuv[2]=uv[2];tuv[3]=uv[3];tuv[4]=uv[4];tuv[5]=uvb;tuv[6]=uv[6];tuv[7]=uvb;this._inner_drawTexture(tex,imgid,x,sty,oriw,left,this._curMat,tuv,1,false);}}},{key:"drawTextureWithSizeGrid",value:function drawTextureWithSizeGrid(tex,tx,ty,width,height,sizeGrid,gx,gy){if(!tex._getSource())return;tx+=gx;ty+=gy;var uv=tex.uv,w=tex.bitmap.width,h=tex.bitmap.height;var top=sizeGrid[0];var left=sizeGrid[3];var d_top=top/h;var d_left=left/w;var right=sizeGrid[1];var bottom=sizeGrid[2];var d_right=right/w;var d_bottom=bottom/h;var repeat=sizeGrid[4];var needClip=false;if(width==w){left=right=0;}if(height==h){top=bottom=0;}if(left+right>width){var clipWidth=width;needClip=true;width=left+right;this.save();this.clipRect(0+tx,0+ty,clipWidth,height);}var imgid=tex.bitmap.id;var mat=this._curMat;var tuv=this._tempUV;var uvl=uv[0];var uvt=uv[1];var uvr=uv[4];var uvb=uv[5];var uvl_=uvl;var uvt_=uvt;var uvr_=uvr;var uvb_=uvb;if(left&&top){uvr_=uvl+d_left;uvb_=uvt+d_top;tuv[0]=uvl,tuv[1]=uvt,tuv[2]=uvr_,tuv[3]=uvt,tuv[4]=uvr_,tuv[5]=uvb_,tuv[6]=uvl,tuv[7]=uvb_;this._inner_drawTexture(tex,imgid,tx,ty,left,top,mat,tuv,1,false);}if(right&&top){uvl_=uvr-d_right;uvt_=uvt;uvr_=uvr;uvb_=uvt+d_top;tuv[0]=uvl_,tuv[1]=uvt_,tuv[2]=uvr_,tuv[3]=uvt_,tuv[4]=uvr_,tuv[5]=uvb_,tuv[6]=uvl_,tuv[7]=uvb_;this._inner_drawTexture(tex,imgid,width-right+tx,0+ty,right,top,mat,tuv,1,false);}if(left&&bottom){uvl_=uvl;uvt_=uvb-d_bottom;uvr_=uvl+d_left;uvb_=uvb;tuv[0]=uvl_,tuv[1]=uvt_,tuv[2]=uvr_,tuv[3]=uvt_,tuv[4]=uvr_,tuv[5]=uvb_,tuv[6]=uvl_,tuv[7]=uvb_;this._inner_drawTexture(tex,imgid,0+tx,height-bottom+ty,left,bottom,mat,tuv,1,false);}if(right&&bottom){uvl_=uvr-d_right;uvt_=uvb-d_bottom;uvr_=uvr;uvb_=uvb;tuv[0]=uvl_,tuv[1]=uvt_,tuv[2]=uvr_,tuv[3]=uvt_,tuv[4]=uvr_,tuv[5]=uvb_,tuv[6]=uvl_,tuv[7]=uvb_;this._inner_drawTexture(tex,imgid,width-right+tx,height-bottom+ty,right,bottom,mat,tuv,1,false);}if(top){uvl_=uvl+d_left;uvt_=uvt;uvr_=uvr-d_right;uvb_=uvt+d_top;tuv[0]=uvl_,tuv[1]=uvt_,tuv[2]=uvr_,tuv[3]=uvt_,tuv[4]=uvr_,tuv[5]=uvb_,tuv[6]=uvl_,tuv[7]=uvb_;if(repeat){this._fillTexture_h(tex,imgid,tuv,tex.width-left-right,top,left+tx,ty,width-left-right);}else{this._inner_drawTexture(tex,imgid,left+tx,ty,width-left-right,top,mat,tuv,1,false);}}if(bottom){uvl_=uvl+d_left;uvt_=uvb-d_bottom;uvr_=uvr-d_right;uvb_=uvb;tuv[0]=uvl_,tuv[1]=uvt_,tuv[2]=uvr_,tuv[3]=uvt_,tuv[4]=uvr_,tuv[5]=uvb_,tuv[6]=uvl_,tuv[7]=uvb_;if(repeat){this._fillTexture_h(tex,imgid,tuv,tex.width-left-right,bottom,left+tx,height-bottom+ty,width-left-right);}else{this._inner_drawTexture(tex,imgid,left+tx,height-bottom+ty,width-left-right,bottom,mat,tuv,1,false);}}if(left){uvl_=uvl;uvt_=uvt+d_top;uvr_=uvl+d_left;uvb_=uvb-d_bottom;tuv[0]=uvl_,tuv[1]=uvt_,tuv[2]=uvr_,tuv[3]=uvt_,tuv[4]=uvr_,tuv[5]=uvb_,tuv[6]=uvl_,tuv[7]=uvb_;if(repeat){this._fillTexture_v(tex,imgid,tuv,left,tex.height-top-bottom,tx,top+ty,height-top-bottom);}else{this._inner_drawTexture(tex,imgid,tx,top+ty,left,height-top-bottom,mat,tuv,1,false);}}if(right){uvl_=uvr-d_right;uvt_=uvt+d_top;uvr_=uvr;uvb_=uvb-d_bottom;tuv[0]=uvl_,tuv[1]=uvt_,tuv[2]=uvr_,tuv[3]=uvt_,tuv[4]=uvr_,tuv[5]=uvb_,tuv[6]=uvl_,tuv[7]=uvb_;if(repeat){this._fillTexture_v(tex,imgid,tuv,right,tex.height-top-bottom,width-right+tx,top+ty,height-top-bottom);}else{this._inner_drawTexture(tex,imgid,width-right+tx,top+ty,right,height-top-bottom,mat,tuv,1,false);}}uvl_=uvl+d_left;uvt_=uvt+d_top;uvr_=uvr-d_right;uvb_=uvb-d_bottom;tuv[0]=uvl_,tuv[1]=uvt_,tuv[2]=uvr_,tuv[3]=uvt_,tuv[4]=uvr_,tuv[5]=uvb_,tuv[6]=uvl_,tuv[7]=uvb_;if(repeat){var tuvr=Context.tmpUVRect;tuvr[0]=uvl_;tuvr[1]=uvt_;tuvr[2]=uvr_-uvl_;tuvr[3]=uvb_-uvt_;this._fillTexture(tex,tex.width-left-right,tex.height-top-bottom,tuvr,left+tx,top+ty,width-left-right,height-top-bottom,'repeat',0,0);}else{this._inner_drawTexture(tex,imgid,left+tx,top+ty,width-left-right,height-top-bottom,mat,tuv,1,false);}if(needClip)this.restore();}},{key:"lineJoin",get:function get(){return'';},set:function set(value){}},{key:"lineCap",get:function get(){return'';},set:function set(value){}},{key:"miterLimit",get:function get(){return'';},set:function set(value){}},{key:"asBitmap",set:function set(value){if(value){var rt=this._targets;if(!this._width||!this._height)throw Error("asBitmap no size!");if(!rt||rt.width!=this._width||rt.height!=this._height){this._targets=new RenderTexture2D(this._width,this._height,exports.RenderTextureFormat.R8G8B8A8,-1);}}else{this._targets&&this._targets.destroy();this._targets=null;}}},{key:"fillStyle",set:function set(value){if(!this._shader2D.fillStyle.equal(value)){SaveBase.save(this,SaveBase.TYPE_FILESTYLE,this._shader2D,false);this._shader2D.fillStyle=DrawStyle.create(value);this._submitKey.other=-this._shader2D.fillStyle.toInt();}},get:function get(){return this._shader2D.fillStyle;}},{key:"globalAlpha",set:function set(value){value=Math.floor(value*1000)/1000;if(value!=this._shader2D.ALPHA){SaveBase.save(this,SaveBase.TYPE_ALPHA,this._shader2D,false);this._shader2D.ALPHA=value;}},get:function get(){return this._shader2D.ALPHA;}},{key:"textAlign",set:function set(value){this._other.textAlign===value||(this._other=this._other.make(),SaveBase.save(this,SaveBase.TYPE_TEXTALIGN,this._other,false),this._other.textAlign=value);},get:function get(){return this._other.textAlign;}},{key:"textBaseline",set:function set(value){this._other.textBaseline===value||(this._other=this._other.make(),SaveBase.save(this,SaveBase.TYPE_TEXTBASELINE,this._other,false),this._other.textBaseline=value);},get:function get(){return this._other.textBaseline;}},{key:"globalCompositeOperation",set:function set(value){var n=BlendMode.TOINT[value];n==null||this._nBlendType===n||(SaveBase.save(this,SaveBase.TYPE_GLOBALCOMPOSITEOPERATION,this,true),this._curSubmit=SubmitBase.RENDERBASE,this._nBlendType=n);},get:function get(){return BlendMode.NAMES[this._nBlendType];}},{key:"strokeStyle",set:function set(value){this._shader2D.strokeStyle.equal(value)||(SaveBase.save(this,SaveBase.TYPE_STROKESTYLE,this._shader2D,false),this._shader2D.strokeStyle=DrawStyle.create(value),this._submitKey.other=-this._shader2D.strokeStyle.toInt());},get:function get(){return this._shader2D.strokeStyle;}},{key:"lineWidth",set:function set(value){this._other.lineWidth===value||(this._other=this._other.make(),SaveBase.save(this,SaveBase.TYPE_LINEWIDTH,this._other,false),this._other.lineWidth=value);},get:function get(){return this._other.lineWidth;}},{key:"font",set:function set(str){this._other=this._other.make();SaveBase.save(this,SaveBase.TYPE_FONT,this._other,false);}},{key:"canvas",get:function get(){return this._canvas;}}],[{key:"__init__",value:function __init__(){Context.MAXCLIPRECT=new Rectangle(0,0,Context._MAXSIZE,Context._MAXSIZE);ContextParams.DEFAULT=new ContextParams();}},{key:"set2DRenderConfig",value:function set2DRenderConfig(){var gl=LayaGL.instance;WebGLContext.setBlend(gl,true);WebGLContext.setBlendEquation(gl,gl.FUNC_ADD);BlendMode.activeBlendFunction=null;WebGLContext.setBlendFunc(gl,gl.ONE,gl.ONE_MINUS_SRC_ALPHA);WebGLContext.setDepthTest(gl,false);WebGLContext.setCullFace(gl,false);WebGLContext.setDepthMask(gl,true);WebGLContext.setFrontFace(gl,gl.CCW);gl.viewport(0,0,RenderState2D.width,RenderState2D.height);}}]);return Context;}();Context.ENUM_TEXTALIGN_DEFAULT=0;Context.ENUM_TEXTALIGN_CENTER=1;Context.ENUM_TEXTALIGN_RIGHT=2;Context._SUBMITVBSIZE=32000;Context._MAXSIZE=99999999;Context._MAXVERTNUM=65535;Context.MAXCLIPRECT=null;Context._COUNT=0;Context.SEGNUM=32;Context._contextcount=0;Context.PI2=2*Math.PI;Context._textRender=null;Context.tmpuv1=[0,0,0,0,0,0,0,0];Context.tmpUV=[0,0,0,0,0,0,0,0];Context.tmpUVRect=[0,0,0,0];var ContextParams=function(){function ContextParams(){_classCallCheck(this,ContextParams);this.lineWidth=1;}_createClass(ContextParams,[{key:"clear",value:function clear(){this.lineWidth=1;this.textAlign=this.textBaseline=null;}},{key:"make",value:function make(){return this===ContextParams.DEFAULT?new ContextParams():this;}}]);return ContextParams;}();var WebGL=function(){function WebGL(){_classCallCheck(this,WebGL);}_createClass(WebGL,null,[{key:"_uint8ArraySlice",value:function _uint8ArraySlice(){var _this=this;var sz=_this.length;var dec=new Uint8Array(_this.length);for(var i=0;i<sz;i++){dec[i]=_this[i];}return dec;}},{key:"_float32ArraySlice",value:function _float32ArraySlice(){var _this=this;var sz=_this.length;var dec=new Float32Array(_this.length);for(var i=0;i<sz;i++){dec[i]=_this[i];}return dec;}},{key:"_uint16ArraySlice",value:function _uint16ArraySlice(){var _this=this;var sz;var dec;var i;if(arguments.length===0){sz=_this.length;dec=new Uint16Array(sz);for(i=0;i<sz;i++){dec[i]=_this[i];}}else if(arguments.length===2){var start=arguments.length<=0?undefined:arguments[0];var end=arguments.length<=1?undefined:arguments[1];if(end>start){sz=end-start;dec=new Uint16Array(sz);for(i=start;i<end;i++){dec[i-start]=_this[i];}}else{dec=new Uint16Array(0);}}return dec;}},{key:"_nativeRender_enable",value:function _nativeRender_enable(){}},{key:"enable",value:function enable(){return true;}},{key:"inner_enable",value:function inner_enable(){Float32Array.prototype.slice||(Float32Array.prototype.slice=WebGL._float32ArraySlice);Uint16Array.prototype.slice||(Uint16Array.prototype.slice=WebGL._uint16ArraySlice);Uint8Array.prototype.slice||(Uint8Array.prototype.slice=WebGL._uint8ArraySlice);return true;}},{key:"onStageResize",value:function onStageResize(width,height){if(WebGLContext.mainContext==null)return;WebGLContext.mainContext.viewport(0,0,width,height);RenderState2D.width=width;RenderState2D.height=height;}}]);return WebGL;}();WebGL._isWebGL2=false;WebGL.isNativeRender_enable=false;var VertexArrayObject=function VertexArrayObject(){_classCallCheck(this,VertexArrayObject);};(function(){var glErrorShadow={};function error(msg){if(window.console&&window.console.error){window.console.error(msg);}}function log(msg){if(window.console&&window.console.log){window.console.log(msg);}}function synthesizeGLError(err,opt_msg){glErrorShadow[err]=true;if(opt_msg!==undefined){error(opt_msg);}}function wrapGLError(gl){var f=gl.getError;gl.getError=function(){var err;do{err=f.apply(gl);if(err!=gl.NO_ERROR){glErrorShadow[err]=true;}}while(err!=gl.NO_ERROR);for(var err1 in glErrorShadow){if(glErrorShadow[err1]){delete glErrorShadow[err1];return parseInt(err1);}}return gl.NO_ERROR;};}var WebGLVertexArrayObjectOES=function WebGLVertexArrayObjectOES(ext){var gl=ext.gl;this.ext=ext;this.isAlive=true;this.hasBeenBound=false;this.elementArrayBuffer=null;this.attribs=new Array(ext.maxVertexAttribs);for(var n=0;n<this.attribs.length;n++){var attrib=new WebGLVertexArrayObjectOES.VertexAttrib(gl);this.attribs[n]=attrib;}this.maxAttrib=0;};WebGLVertexArrayObjectOES.VertexAttrib=function VertexAttrib(gl){this.enabled=false;this.buffer=null;this.size=4;this.type=gl.FLOAT;this.normalized=false;this.stride=16;this.offset=0;this.cached="";this.recache();};WebGLVertexArrayObjectOES.VertexAttrib.prototype.recache=function recache(){this.cached=[this.size,this.type,this.normalized,this.stride,this.offset].join(":");};var OESVertexArrayObject=function OESVertexArrayObject(gl){var self=this;this.gl=gl;wrapGLError(gl);var original=this.original={getParameter:gl.getParameter,enableVertexAttribArray:gl.enableVertexAttribArray,disableVertexAttribArray:gl.disableVertexAttribArray,bindBuffer:gl.bindBuffer,getVertexAttrib:gl.getVertexAttrib,vertexAttribPointer:gl.vertexAttribPointer};gl.getParameter=function getParameter(pname){if(pname==self.VERTEX_ARRAY_BINDING_OES){if(self.currentVertexArrayObject==self.defaultVertexArrayObject){return null;}else{return self.currentVertexArrayObject;}}return original.getParameter.apply(this,arguments);};gl.enableVertexAttribArray=function enableVertexAttribArray(index){var vao=self.currentVertexArrayObject;vao.maxAttrib=Math.max(vao.maxAttrib,index);var attrib=vao.attribs[index];attrib.enabled=true;return original.enableVertexAttribArray.apply(this,arguments);};gl.disableVertexAttribArray=function disableVertexAttribArray(index){var vao=self.currentVertexArrayObject;vao.maxAttrib=Math.max(vao.maxAttrib,index);var attrib=vao.attribs[index];attrib.enabled=false;return original.disableVertexAttribArray.apply(this,arguments);};gl.bindBuffer=function bindBuffer(target,buffer){switch(target){case gl.ARRAY_BUFFER:self.currentArrayBuffer=buffer;break;case gl.ELEMENT_ARRAY_BUFFER:self.currentVertexArrayObject.elementArrayBuffer=buffer;break;}return original.bindBuffer.apply(this,arguments);};gl.getVertexAttrib=function getVertexAttrib(index,pname){var vao=self.currentVertexArrayObject;var attrib=vao.attribs[index];switch(pname){case gl.VERTEX_ATTRIB_ARRAY_BUFFER_BINDING:return attrib.buffer;case gl.VERTEX_ATTRIB_ARRAY_ENABLED:return attrib.enabled;case gl.VERTEX_ATTRIB_ARRAY_SIZE:return attrib.size;case gl.VERTEX_ATTRIB_ARRAY_STRIDE:return attrib.stride;case gl.VERTEX_ATTRIB_ARRAY_TYPE:return attrib.type;case gl.VERTEX_ATTRIB_ARRAY_NORMALIZED:return attrib.normalized;default:return original.getVertexAttrib.apply(this,arguments);}};gl.vertexAttribPointer=function vertexAttribPointer(indx,size,type,normalized,stride,offset){var vao=self.currentVertexArrayObject;vao.maxAttrib=Math.max(vao.maxAttrib,indx);var attrib=vao.attribs[indx];attrib.buffer=self.currentArrayBuffer;attrib.size=size;attrib.type=type;attrib.normalized=normalized;attrib.stride=stride;attrib.offset=offset;attrib.recache();return original.vertexAttribPointer.apply(this,arguments);};if(gl.instrumentExtension){gl.instrumentExtension(this,"OES_vertex_array_object");}gl.canvas.addEventListener('webglcontextrestored',function(){log("OESVertexArrayObject emulation library context restored");self.reset_();},true);this.reset_();};OESVertexArrayObject.prototype.VERTEX_ARRAY_BINDING_OES=0x85B5;OESVertexArrayObject.prototype.reset_=function reset_(){var contextWasLost=this.vertexArrayObjects!==undefined;if(contextWasLost){for(var ii=0;ii<this.vertexArrayObjects.length;++ii){this.vertexArrayObjects.isAlive=false;}}var gl=this.gl;this.maxVertexAttribs=gl.getParameter(gl.MAX_VERTEX_ATTRIBS);this.defaultVertexArrayObject=new WebGLVertexArrayObjectOES(this);this.currentVertexArrayObject=null;this.currentArrayBuffer=null;this.vertexArrayObjects=[this.defaultVertexArrayObject];this.bindVertexArrayOES(null);};OESVertexArrayObject.prototype.createVertexArrayOES=function createVertexArrayOES(){var arrayObject=new WebGLVertexArrayObjectOES(this);this.vertexArrayObjects.push(arrayObject);return arrayObject;};OESVertexArrayObject.prototype.deleteVertexArrayOES=function deleteVertexArrayOES(arrayObject){arrayObject.isAlive=false;this.vertexArrayObjects.splice(this.vertexArrayObjects.indexOf(arrayObject),1);if(this.currentVertexArrayObject==arrayObject){this.bindVertexArrayOES(null);}};OESVertexArrayObject.prototype.isVertexArrayOES=function isVertexArrayOES(arrayObject){if(arrayObject&&arrayObject instanceof WebGLVertexArrayObjectOES){if(arrayObject.hasBeenBound&&arrayObject.ext==this){return true;}}return false;};OESVertexArrayObject.prototype.bindVertexArrayOES=function bindVertexArrayOES(arrayObject){var gl=this.gl;if(arrayObject&&!arrayObject.isAlive){synthesizeGLError(gl.INVALID_OPERATION,"bindVertexArrayOES: attempt to bind deleted arrayObject");return;}var original=this.original;var oldVAO=this.currentVertexArrayObject;this.currentVertexArrayObject=arrayObject||this.defaultVertexArrayObject;this.currentVertexArrayObject.hasBeenBound=true;var newVAO=this.currentVertexArrayObject;if(oldVAO==newVAO){return;}if(!oldVAO||newVAO.elementArrayBuffer!=oldVAO.elementArrayBuffer){original.bindBuffer.call(gl,gl.ELEMENT_ARRAY_BUFFER,newVAO.elementArrayBuffer);}var currentBinding=this.currentArrayBuffer;var maxAttrib=Math.max(oldVAO?oldVAO.maxAttrib:0,newVAO.maxAttrib);for(var n=0;n<=maxAttrib;n++){var attrib=newVAO.attribs[n];var oldAttrib=oldVAO?oldVAO.attribs[n]:null;if(!oldVAO||attrib.enabled!=oldAttrib.enabled){if(attrib.enabled){original.enableVertexAttribArray.call(gl,n);}else{original.disableVertexAttribArray.call(gl,n);}}if(attrib.enabled){var bufferChanged=false;if(!oldVAO||attrib.buffer!=oldAttrib.buffer){if(currentBinding!=attrib.buffer){original.bindBuffer.call(gl,gl.ARRAY_BUFFER,attrib.buffer);currentBinding=attrib.buffer;}bufferChanged=true;}if(bufferChanged||attrib.cached!=oldAttrib.cached){original.vertexAttribPointer.call(gl,n,attrib.size,attrib.type,attrib.normalized,attrib.stride,attrib.offset);}}}if(this.currentArrayBuffer!=currentBinding){original.bindBuffer.call(gl,gl.ARRAY_BUFFER,this.currentArrayBuffer);}};window._setupVertexArrayObject=function(gl){var original_getSupportedExtensions=gl.getSupportedExtensions;gl.getSupportedExtensions=function getSupportedExtensions(){var list=original_getSupportedExtensions.call(this)||[];if(list.indexOf("OES_vertex_array_object")<0){list.push("OES_vertex_array_object");}return list;};var original_getExtension=gl.getExtension;gl.getExtension=function getExtension(name){var ext=original_getExtension.call(this,name);if(ext){return ext;}if(name!=="OES_vertex_array_object"){return null;}if(!this.__OESVertexArrayObject){console.log("Setup OES_vertex_array_object polyfill");this.__OESVertexArrayObject=new OESVertexArrayObject(this);}return this.__OESVertexArrayObject;};};window._forceSetupVertexArrayObject=function(gl){var original_getSupportedExtensions=gl.getSupportedExtensions;gl.getSupportedExtensions=function getSupportedExtensions(){var list=original_getSupportedExtensions.call(this)||[];if(list.indexOf("OES_vertex_array_object")<0){list.push("OES_vertex_array_object");}return list;};var original_getExtension=gl.getExtension;gl.getExtension=function getExtension(name){if(name==="OES_vertex_array_object"){if(!this.__OESVertexArrayObject){console.log("Setup OES_vertex_array_object polyfill");this.__OESVertexArrayObject=new OESVertexArrayObject(this);}return this.__OESVertexArrayObject;}else{var ext=original_getExtension.call(this,name);if(ext){return ext;}else{return null;}}};};})();var LayaGPU=function(){function LayaGPU(gl,isWebGL2){_classCallCheck(this,LayaGPU);this._gl=null;this._vaoExt=null;this._angleInstancedArrays=null;this._isWebGL2=false;this._oesTextureHalfFloat=null;this._oes_element_index_uint=null;this._oesTextureHalfFloatLinear=null;this._oesTextureFloat=null;this._extTextureFilterAnisotropic=null;this._compressedTextureS3tc=null;this._compressedTexturePvrtc=null;this._compressedTextureEtc1=null;this._gl=gl;this._isWebGL2=isWebGL2;if(!isWebGL2){var forceVAO=LayaGPU._forceSupportVAOPlatform();if(!ILaya.Render.isConchApp){if(window._setupVertexArrayObject){if(forceVAO)window._forceSetupVertexArrayObject(gl);else window._setupVertexArrayObject(gl);}}this._vaoExt=this._getExtension("OES_vertex_array_object");if(!forceVAO)this._angleInstancedArrays=this._getExtension("ANGLE_instanced_arrays");this._oesTextureHalfFloat=this._getExtension("OES_texture_half_float");this._oesTextureHalfFloatLinear=this._getExtension("OES_texture_half_float_linear");this._oesTextureFloat=this._getExtension("OES_texture_float");this._oes_element_index_uint=this._getExtension("OES_element_index_uint");}else{this._getExtension("EXT_color_buffer_float");}this._extTextureFilterAnisotropic=this._getExtension("EXT_texture_filter_anisotropic");this._compressedTextureS3tc=this._getExtension("WEBGL_compressed_texture_s3tc");this._compressedTexturePvrtc=this._getExtension("WEBGL_compressed_texture_pvrtc");this._compressedTextureEtc1=this._getExtension("WEBGL_compressed_texture_etc1");}_createClass(LayaGPU,[{key:"_getExtension",value:function _getExtension(name){var prefixes=LayaGPU._extentionVendorPrefixes;for(var k in prefixes){var ext=this._gl.getExtension(prefixes[k]+name);if(ext)return ext;}return null;}},{key:"createVertexArray",value:function createVertexArray(){if(this._isWebGL2)return this._gl.createVertexArray();else return this._vaoExt.createVertexArrayOES();}},{key:"bindVertexArray",value:function bindVertexArray(vertexArray){if(this._isWebGL2)this._gl.bindVertexArray(vertexArray);else this._vaoExt.bindVertexArrayOES(vertexArray);}},{key:"deleteVertexArray",value:function deleteVertexArray(vertexArray){if(this._isWebGL2)this._gl.deleteVertexArray(vertexArray);else this._vaoExt.deleteVertexArrayOES(vertexArray);}},{key:"isVertexArray",value:function isVertexArray(vertexArray){if(this._isWebGL2)this._gl.isVertexArray(vertexArray);else this._vaoExt.isVertexArrayOES(vertexArray);}},{key:"drawElementsInstanced",value:function drawElementsInstanced(mode,count,type,offset,instanceCount){if(this._isWebGL2)this._gl.drawElementsInstanced(mode,count,type,offset,instanceCount);else this._angleInstancedArrays.drawElementsInstancedANGLE(mode,count,type,offset,instanceCount);}},{key:"drawArraysInstanced",value:function drawArraysInstanced(mode,first,count,instanceCount){if(this._isWebGL2)this._gl.drawArraysInstanced(mode,first,count,instanceCount);else this._angleInstancedArrays.drawArraysInstancedANGLE(mode,first,count,instanceCount);}},{key:"vertexAttribDivisor",value:function vertexAttribDivisor(index,divisor){if(this._isWebGL2)this._gl.vertexAttribDivisor(index,divisor);else this._angleInstancedArrays.vertexAttribDivisorANGLE(index,divisor);}},{key:"supportInstance",value:function supportInstance(){if(this._isWebGL2||this._angleInstancedArrays)return true;else return false;}},{key:"supportElementIndexUint32",value:function supportElementIndexUint32(){return this._isWebGL2||this._oes_element_index_uint?true:false;}}],[{key:"_forceSupportVAOPlatform",value:function _forceSupportVAOPlatform(){var Browser=ILaya.Browser;return Browser.onBDMiniGame||Browser.onQGMiniGame;}}]);return LayaGPU;}();LayaGPU._extentionVendorPrefixes=["","WEBKIT_","MOZ_"];var Render=function(){function Render(width,height,mainCanv){_classCallCheck(this,Render);this._timeId=0;Render._mainCanvas=mainCanv;var source=Render._mainCanvas.source;source.id="layaCanvas";source.width=width;source.height=height;if(Render.isConchApp){document.body.appendChild(source);}this.initRender(Render._mainCanvas,width,height);window.requestAnimationFrame(loop);function loop(stamp){ILaya.stage._loop();window.requestAnimationFrame(loop);}ILaya.stage.on("visibilitychange",this,this._onVisibilitychange);}_createClass(Render,[{key:"_onVisibilitychange",value:function _onVisibilitychange(){if(!ILaya.stage.isVisibility){this._timeId=window.setInterval(this._enterFrame,1000);}else if(this._timeId!=0){window.clearInterval(this._timeId);}}},{key:"initRender",value:function initRender(canvas,w,h){function getWebGLContext(canvas){var gl;var names=["webgl2","webgl","experimental-webgl","webkit-3d","moz-webgl"];if(!Config.useWebGL2||Browser.onBDMiniGame){names.shift();}for(var i=0;i<names.length;i++){try{gl=canvas.getContext(names[i],{stencil:Config.isStencil,alpha:Config.isAlpha,antialias:Config.isAntialias,premultipliedAlpha:Config.premultipliedAlpha,preserveDrawingBuffer:Config.preserveDrawingBuffer});}catch(e){}if(gl){names[i]==='webgl2'&&(WebGL._isWebGL2=true);return gl;}}return null;}var gl=LayaGL.instance=WebGLContext.mainContext=getWebGLContext(Render._mainCanvas.source);if(!gl)return false;LayaGL.instance=gl;LayaGL.layaGPUInstance=new LayaGPU(gl,WebGL._isWebGL2);canvas.size(w,h);Context.__init__();SubmitBase.__init__();var ctx=new Context();ctx.isMain=true;Render._context=ctx;canvas._setContext(ctx);ShaderDefines2D.__init__();Value2D.__init__();Shader2D.__init__();Buffer2D.__int__(gl);BlendMode._init_(gl);return true;}},{key:"_enterFrame",value:function _enterFrame(){var e=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;ILaya.stage._loop();}}],[{key:"context",get:function get(){return Render._context;}},{key:"canvas",get:function get(){return Render._mainCanvas.source;}}]);return Render;}();Render.supportWebGLPlusCulling=false;Render.supportWebGLPlusAnimation=false;Render.supportWebGLPlusRendering=false;Render.isConchApp=false;{Render.isConchApp=window.conch!=null;if(Render.isConchApp){Render.supportWebGLPlusCulling=false;Render.supportWebGLPlusAnimation=false;Render.supportWebGLPlusRendering=false;}else if(window.qq!=null&&window.qq.webglPlus!=null){Render.supportWebGLPlusCulling=false;Render.supportWebGLPlusAnimation=false;Render.supportWebGLPlusRendering=false;}}var DrawTrianglesCmd=function(){function DrawTrianglesCmd(){_classCallCheck(this,DrawTrianglesCmd);}_createClass(DrawTrianglesCmd,[{key:"recover",value:function recover(){this.texture=null;this.vertices=null;this.uvs=null;this.indices=null;this.matrix=null;Pool.recover("DrawTrianglesCmd",this);}},{key:"run",value:function run(context,gx,gy){context.drawTriangles(this.texture,this.x+gx,this.y+gy,this.vertices,this.uvs,this.indices,this.matrix,this.alpha,this.color,this.blendMode,this.colorNum);}},{key:"cmdID",get:function get(){return DrawTrianglesCmd.ID;}}],[{key:"create",value:function create(texture,x,y,vertices,uvs,indices,matrix,alpha,color,blendMode,colorNum){var cmd=Pool.getItemByClass("DrawTrianglesCmd",DrawTrianglesCmd);cmd.texture=texture;cmd.x=x;cmd.y=y;cmd.vertices=vertices;cmd.uvs=uvs;cmd.indices=indices;cmd.matrix=matrix;cmd.alpha=alpha;if(color){cmd.color=new ColorFilter();var c=ColorUtils.create(color).arrColor;cmd.color.color(c[0]*255,c[1]*255,c[2]*255,c[3]*255);}cmd.blendMode=blendMode;cmd.colorNum=colorNum;return cmd;}}]);return DrawTrianglesCmd;}();DrawTrianglesCmd.ID="DrawTriangles";var Draw9GridTexture=function(){function Draw9GridTexture(){_classCallCheck(this,Draw9GridTexture);}_createClass(Draw9GridTexture,[{key:"recover",value:function recover(){this.texture._removeReference();Pool.recover("Draw9GridTexture",this);}},{key:"run",value:function run(context,gx,gy){context.drawTextureWithSizeGrid(this.texture,this.x,this.y,this.width,this.height,this.sizeGrid,gx,gy);}},{key:"cmdID",get:function get(){return Draw9GridTexture.ID;}}],[{key:"create",value:function create(texture,x,y,width,height,sizeGrid){var cmd=Pool.getItemByClass("Draw9GridTexture",Draw9GridTexture);cmd.texture=texture;texture._addReference();cmd.x=x;cmd.y=y;cmd.width=width;cmd.height=height;cmd.sizeGrid=sizeGrid;return cmd;}}]);return Draw9GridTexture;}();Draw9GridTexture.ID="Draw9GridTexture";var GraphicsBounds=function(){function GraphicsBounds(){_classCallCheck(this,GraphicsBounds);this._cacheBoundsType=false;}_createClass(GraphicsBounds,[{key:"destroy",value:function destroy(){this._graphics=null;this._cacheBoundsType=false;if(this._temp)this._temp.length=0;if(this._rstBoundPoints)this._rstBoundPoints.length=0;if(this._bounds)this._bounds.recover();this._bounds=null;Pool.recover("GraphicsBounds",this);}},{key:"reset",value:function reset(){this._temp&&(this._temp.length=0);}},{key:"getBounds",value:function getBounds(){var realSize=arguments.length>0&&arguments[0]!==undefined?arguments[0]:false;if(!this._bounds||!this._temp||this._temp.length<1||realSize!=this._cacheBoundsType){this._bounds=Rectangle._getWrapRec(this.getBoundPoints(realSize),this._bounds);}this._cacheBoundsType=realSize;return this._bounds;}},{key:"getBoundPoints",value:function getBoundPoints(){var realSize=arguments.length>0&&arguments[0]!==undefined?arguments[0]:false;if(!this._temp||this._temp.length<1||realSize!=this._cacheBoundsType)this._temp=this._getCmdPoints(realSize);this._cacheBoundsType=realSize;return this._rstBoundPoints=Utils.copyArray(this._rstBoundPoints,this._temp);}},{key:"_getCmdPoints",value:function _getCmdPoints(){var realSize=arguments.length>0&&arguments[0]!==undefined?arguments[0]:false;var cmds=this._graphics.cmds;var rst;rst=this._temp||(this._temp=[]);rst.length=0;if(!cmds&&this._graphics._one!=null){GraphicsBounds._tempCmds.length=0;GraphicsBounds._tempCmds.push(this._graphics._one);cmds=GraphicsBounds._tempCmds;}if(!cmds)return rst;var matrixs=GraphicsBounds._tempMatrixArrays;matrixs.length=0;var tMatrix=GraphicsBounds._initMatrix;tMatrix.identity();var tempMatrix=GraphicsBounds._tempMatrix;var cmd;var tex;for(var i=0,n=cmds.length;i<n;i++){cmd=cmds[i];switch(cmd.cmdID){case AlphaCmd.ID:matrixs.push(tMatrix);tMatrix=tMatrix.clone();break;case RestoreCmd.ID:tMatrix=matrixs.pop();break;case ScaleCmd.ID:tempMatrix.identity();tempMatrix.translate(-cmd.pivotX,-cmd.pivotY);tempMatrix.scale(cmd.scaleX,cmd.scaleY);tempMatrix.translate(cmd.pivotX,cmd.pivotY);this._switchMatrix(tMatrix,tempMatrix);break;case RotateCmd.ID:tempMatrix.identity();tempMatrix.translate(-cmd.pivotX,-cmd.pivotY);tempMatrix.rotate(cmd.angle);tempMatrix.translate(cmd.pivotX,cmd.pivotY);this._switchMatrix(tMatrix,tempMatrix);break;case TranslateCmd.ID:tempMatrix.identity();tempMatrix.translate(cmd.tx,cmd.ty);this._switchMatrix(tMatrix,tempMatrix);break;case TransformCmd.ID:tempMatrix.identity();tempMatrix.translate(-cmd.pivotX,-cmd.pivotY);tempMatrix.concat(cmd.matrix);tempMatrix.translate(cmd.pivotX,cmd.pivotY);this._switchMatrix(tMatrix,tempMatrix);break;case DrawImageCmd.ID:case FillTextureCmd.ID:GraphicsBounds._addPointArrToRst(rst,Rectangle._getBoundPointS(cmd.x,cmd.y,cmd.width,cmd.height),tMatrix);break;case DrawTextureCmd.ID:tMatrix.copyTo(tempMatrix);if(cmd.matrix)tempMatrix.concat(cmd.matrix);GraphicsBounds._addPointArrToRst(rst,Rectangle._getBoundPointS(cmd.x,cmd.y,cmd.width,cmd.height),tempMatrix);break;case DrawImageCmd.ID:tex=cmd.texture;if(realSize){if(cmd.width&&cmd.height){GraphicsBounds._addPointArrToRst(rst,Rectangle._getBoundPointS(cmd.x,cmd.y,cmd.width,cmd.height),tMatrix);}else{GraphicsBounds._addPointArrToRst(rst,Rectangle._getBoundPointS(cmd.x,cmd.y,tex.width,tex.height),tMatrix);}}else{var wRate=(cmd.width||tex.sourceWidth)/tex.width;var hRate=(cmd.height||tex.sourceHeight)/tex.height;var oWidth=wRate*tex.sourceWidth;var oHeight=hRate*tex.sourceHeight;var offX=tex.offsetX>0?tex.offsetX:0;var offY=tex.offsetY>0?tex.offsetY:0;offX*=wRate;offY*=hRate;GraphicsBounds._addPointArrToRst(rst,Rectangle._getBoundPointS(cmd.x-offX,cmd.y-offY,oWidth,oHeight),tMatrix);}break;case FillTextureCmd.ID:if(cmd.width&&cmd.height){GraphicsBounds._addPointArrToRst(rst,Rectangle._getBoundPointS(cmd.x,cmd.y,cmd.width,cmd.height),tMatrix);}else{tex=cmd.texture;GraphicsBounds._addPointArrToRst(rst,Rectangle._getBoundPointS(cmd.x,cmd.y,tex.width,tex.height),tMatrix);}break;case DrawTextureCmd.ID:var drawMatrix;if(cmd.matrix){tMatrix.copyTo(tempMatrix);tempMatrix.concat(cmd.matrix);drawMatrix=tempMatrix;}else{drawMatrix=tMatrix;}if(realSize){if(cmd.width&&cmd.height){GraphicsBounds._addPointArrToRst(rst,Rectangle._getBoundPointS(cmd.x,cmd.y,cmd.width,cmd.height),drawMatrix);}else{tex=cmd.texture;GraphicsBounds._addPointArrToRst(rst,Rectangle._getBoundPointS(cmd.x,cmd.y,tex.width,tex.height),drawMatrix);}}else{tex=cmd.texture;wRate=(cmd.width||tex.sourceWidth)/tex.width;hRate=(cmd.height||tex.sourceHeight)/tex.height;oWidth=wRate*tex.sourceWidth;oHeight=hRate*tex.sourceHeight;offX=tex.offsetX>0?tex.offsetX:0;offY=tex.offsetY>0?tex.offsetY:0;offX*=wRate;offY*=hRate;GraphicsBounds._addPointArrToRst(rst,Rectangle._getBoundPointS(cmd.x-offX,cmd.y-offY,oWidth,oHeight),drawMatrix);}break;case DrawRectCmd.ID:GraphicsBounds._addPointArrToRst(rst,Rectangle._getBoundPointS(cmd.x,cmd.y,cmd.width,cmd.height),tMatrix);break;case DrawCircleCmd.ID:GraphicsBounds._addPointArrToRst(rst,Rectangle._getBoundPointS(cmd.x-cmd.radius,cmd.y-cmd.radius,cmd.radius+cmd.radius,cmd.radius+cmd.radius),tMatrix);break;case DrawLineCmd.ID:GraphicsBounds._tempPoints.length=0;var lineWidth;lineWidth=cmd.lineWidth*0.5;if(cmd.fromX==cmd.toX){GraphicsBounds._tempPoints.push(cmd.fromX+lineWidth,cmd.fromY,cmd.toX+lineWidth,cmd.toY,cmd.fromX-lineWidth,cmd.fromY,cmd.toX-lineWidth,cmd.toY);}else if(cmd.fromY==cmd.toY){GraphicsBounds._tempPoints.push(cmd.fromX,cmd.fromY+lineWidth,cmd.toX,cmd.toY+lineWidth,cmd.fromX,cmd.fromY-lineWidth,cmd.toX,cmd.toY-lineWidth);}else{GraphicsBounds._tempPoints.push(cmd.fromX,cmd.fromY,cmd.toX,cmd.toY);}GraphicsBounds._addPointArrToRst(rst,GraphicsBounds._tempPoints,tMatrix);break;case DrawCurvesCmd.ID:GraphicsBounds._addPointArrToRst(rst,Bezier.I.getBezierPoints(cmd.points),tMatrix,cmd.x,cmd.y);break;case DrawLinesCmd.ID:case DrawPolyCmd.ID:GraphicsBounds._addPointArrToRst(rst,cmd.points,tMatrix,cmd.x,cmd.y);break;case DrawPathCmd.ID:GraphicsBounds._addPointArrToRst(rst,this._getPathPoints(cmd.paths),tMatrix,cmd.x,cmd.y);break;case DrawPieCmd.ID:GraphicsBounds._addPointArrToRst(rst,this._getPiePoints(cmd.x,cmd.y,cmd.radius,cmd.startAngle,cmd.endAngle),tMatrix);break;case DrawTrianglesCmd.ID:GraphicsBounds._addPointArrToRst(rst,this._getTriAngBBXPoints(cmd.vertices),tMatrix);break;case Draw9GridTexture.ID:GraphicsBounds._addPointArrToRst(rst,this._getDraw9GridBBXPoints(cmd),tMatrix);break;}}if(rst.length>200){rst=Utils.copyArray(rst,Rectangle._getWrapRec(rst)._getBoundPoints());}else if(rst.length>8)rst=GrahamScan.scanPList(rst);return rst;}},{key:"_switchMatrix",value:function _switchMatrix(tMatix,tempMatrix){tempMatrix.concat(tMatix);tempMatrix.copyTo(tMatix);}},{key:"_getPiePoints",value:function _getPiePoints(x,y,radius,startAngle,endAngle){var rst=GraphicsBounds._tempPoints;GraphicsBounds._tempPoints.length=0;var k=Math.PI/180;var d1=endAngle-startAngle;if(d1>=360||d1<=-360){rst.push(x-radius,y-radius);rst.push(x+radius,y-radius);rst.push(x+radius,y+radius);rst.push(x-radius,y+radius);return rst;}rst.push(x,y);var delta=d1%360;if(delta<0)delta+=360;var end1=startAngle+delta;var st=startAngle*k;var ed=end1*k;rst.push(x+radius*Math.cos(st),y+radius*Math.sin(st));rst.push(x+radius*Math.cos(ed),y+radius*Math.sin(ed));var s1=Math.ceil(startAngle/90)*90;var s2=Math.floor(end1/90)*90;for(var cs=s1;cs<=s2;cs+=90){var csr=cs*k;rst.push(x+radius*Math.cos(csr),y+radius*Math.sin(csr));}return rst;}},{key:"_getTriAngBBXPoints",value:function _getTriAngBBXPoints(vert){var vnum=vert.length;if(vnum<2)return[];var minx=vert[0];var miny=vert[1];var maxx=minx;var maxy=miny;for(var i=2;i<vnum;){var cx=vert[i++];var cy=vert[i++];if(minx>cx)minx=cx;if(miny>cy)miny=cy;if(maxx<cx)maxx=cx;if(maxy<cy)maxy=cy;}return[minx,miny,maxx,miny,maxx,maxy,minx,maxy];}},{key:"_getDraw9GridBBXPoints",value:function _getDraw9GridBBXPoints(cmd){var minx=0;var miny=0;var maxx=cmd.width;var maxy=cmd.height;return[minx,miny,maxx,miny,maxx,maxy,minx,maxy];}},{key:"_getPathPoints",value:function _getPathPoints(paths){var i,len;var rst=GraphicsBounds._tempPoints;rst.length=0;len=paths.length;var tCMD;for(i=0;i<len;i++){tCMD=paths[i];if(tCMD.length>1){rst.push(tCMD[1],tCMD[2]);if(tCMD.length>3){rst.push(tCMD[3],tCMD[4]);}}}return rst;}}],[{key:"create",value:function create(){return Pool.getItemByClass("GraphicsBounds",GraphicsBounds);}},{key:"_addPointArrToRst",value:function _addPointArrToRst(rst,points,matrix){var dx=arguments.length>3&&arguments[3]!==undefined?arguments[3]:0;var dy=arguments.length>4&&arguments[4]!==undefined?arguments[4]:0;var i,len;len=points.length;for(i=0;i<len;i+=2){GraphicsBounds._addPointToRst(rst,points[i]+dx,points[i+1]+dy,matrix);}}},{key:"_addPointToRst",value:function _addPointToRst(rst,x,y,matrix){var _tempPoint=Point.TEMP;_tempPoint.setTo(x?x:0,y?y:0);matrix.transformPoint(_tempPoint);rst.push(_tempPoint.x,_tempPoint.y);}}]);return GraphicsBounds;}();GraphicsBounds._tempMatrix=new Matrix();GraphicsBounds._initMatrix=new Matrix();GraphicsBounds._tempPoints=[];GraphicsBounds._tempMatrixArrays=[];GraphicsBounds._tempCmds=[];var SpriteConst=function SpriteConst(){_classCallCheck(this,SpriteConst);};SpriteConst.ALPHA=0x01;SpriteConst.TRANSFORM=0x02;SpriteConst.BLEND=0x04;SpriteConst.CANVAS=0x08;SpriteConst.FILTERS=0x10;SpriteConst.MASK=0x20;SpriteConst.CLIP=0x40;SpriteConst.STYLE=0x80;SpriteConst.TEXTURE=0x100;SpriteConst.GRAPHICS=0x200;SpriteConst.LAYAGL3D=0x400;SpriteConst.CUSTOM=0x800;SpriteConst.ONECHILD=0x1000;SpriteConst.CHILDS=0x2000;SpriteConst.REPAINT_NONE=0;SpriteConst.REPAINT_NODE=0x01;SpriteConst.REPAINT_CACHE=0x02;SpriteConst.REPAINT_ALL=0x03;var ClipRectCmd=function(){function ClipRectCmd(){_classCallCheck(this,ClipRectCmd);}_createClass(ClipRectCmd,[{key:"recover",value:function recover(){Pool.recover("ClipRectCmd",this);}},{key:"run",value:function run(context,gx,gy){context.clipRect(this.x+gx,this.y+gy,this.width,this.height);}},{key:"cmdID",get:function get(){return ClipRectCmd.ID;}}],[{key:"create",value:function create(x,y,width,height){var cmd=Pool.getItemByClass("ClipRectCmd",ClipRectCmd);cmd.x=x;cmd.y=y;cmd.width=width;cmd.height=height;return cmd;}}]);return ClipRectCmd;}();ClipRectCmd.ID="ClipRect";var DrawTexturesCmd=function(){function DrawTexturesCmd(){_classCallCheck(this,DrawTexturesCmd);}_createClass(DrawTexturesCmd,[{key:"recover",value:function recover(){this.texture._removeReference();this.texture=null;this.pos=null;Pool.recover("DrawTexturesCmd",this);}},{key:"run",value:function run(context,gx,gy){context.drawTextures(this.texture,this.pos,gx,gy);}},{key:"cmdID",get:function get(){return DrawTexturesCmd.ID;}}],[{key:"create",value:function create(texture,pos){var cmd=Pool.getItemByClass("DrawTexturesCmd",DrawTexturesCmd);cmd.texture=texture;texture._addReference();cmd.pos=pos;return cmd;}}]);return DrawTexturesCmd;}();DrawTexturesCmd.ID="DrawTextures";var FillTextCmd=function(){function FillTextCmd(){_classCallCheck(this,FillTextCmd);this._textIsWorldText=false;this._fontColor=0xffffffff;this._strokeColor=0;this._fontObj=FillTextCmd._defFontObj;this._nTexAlign=0;}_createClass(FillTextCmd,[{key:"recover",value:function recover(){Pool.recover("FillTextCmd",this);}},{key:"run",value:function run(context,gx,gy){if(ILaya.stage.isGlobalRepaint()){this._textIsWorldText&&this._text.cleanCache();}if(this._words){Context._textRender.fillWords(context,this._words,this.x+gx,this.y+gy,this._fontObj,this._color,this._borderColor,this._lineWidth);}else{if(this._textIsWorldText){context._fast_filltext(this._text,this.x+gx,this.y+gy,this._fontObj,this._color,this._borderColor,this._lineWidth,this._nTexAlign,0);}else{Context._textRender.filltext(context,this._text,this.x+gx,this.y+gy,this.font,this.color,this._borderColor,this._lineWidth,this._textAlign);}}}},{key:"cmdID",get:function get(){return FillTextCmd.ID;}},{key:"text",get:function get(){return this._text;},set:function set(value){this._text=value;this._textIsWorldText=value instanceof WordText;this._textIsWorldText&&this._text.cleanCache();}},{key:"font",get:function get(){return this._font;},set:function set(value){this._font=value;this._fontObj=FontInfo.Parse(value);this._textIsWorldText&&this._text.cleanCache();}},{key:"color",get:function get(){return this._color;},set:function set(value){this._color=value;this._fontColor=ColorUtils.create(value).numColor;this._textIsWorldText&&this._text.cleanCache();}},{key:"textAlign",get:function get(){return this._textAlign;},set:function set(value){this._textAlign=value;switch(value){case'center':this._nTexAlign=ILaya.Context.ENUM_TEXTALIGN_CENTER;break;case'right':this._nTexAlign=ILaya.Context.ENUM_TEXTALIGN_RIGHT;break;default:this._nTexAlign=ILaya.Context.ENUM_TEXTALIGN_DEFAULT;}this._textIsWorldText&&this._text.cleanCache();}}],[{key:"create",value:function create(text,words,x,y,font,color,textAlign,lineWidth,borderColor){var cmd=Pool.getItemByClass("FillTextCmd",FillTextCmd);cmd.text=text;cmd._textIsWorldText=text instanceof WordText;cmd._words=words;cmd.x=x;cmd.y=y;cmd.font=font;cmd.color=color;cmd.textAlign=textAlign;cmd._lineWidth=lineWidth;cmd._borderColor=borderColor;return cmd;}}]);return FillTextCmd;}();FillTextCmd.ID="FillText";FillTextCmd._defFontObj=new FontInfo(null);var SaveCmd=function(){function SaveCmd(){_classCallCheck(this,SaveCmd);}_createClass(SaveCmd,[{key:"recover",value:function recover(){Pool.recover("SaveCmd",this);}},{key:"run",value:function run(context,gx,gy){context.save();}},{key:"cmdID",get:function get(){return SaveCmd.ID;}}],[{key:"create",value:function create(){var cmd=Pool.getItemByClass("SaveCmd",SaveCmd);return cmd;}}]);return SaveCmd;}();SaveCmd.ID="Save";var CacheManger=function(){function CacheManger(){_classCallCheck(this,CacheManger);}_createClass(CacheManger,null,[{key:"regCacheByFunction",value:function regCacheByFunction(disposeFunction,getCacheListFunction){CacheManger.unRegCacheByFunction(disposeFunction,getCacheListFunction);var cache;cache={tryDispose:disposeFunction,getCacheList:getCacheListFunction};CacheManger._cacheList.push(cache);}},{key:"unRegCacheByFunction",value:function unRegCacheByFunction(disposeFunction,getCacheListFunction){var i,len;len=CacheManger._cacheList.length;for(i=0;i<len;i++){if(CacheManger._cacheList[i].tryDispose==disposeFunction&&CacheManger._cacheList[i].getCacheList==getCacheListFunction){CacheManger._cacheList.splice(i,1);return;}}}},{key:"forceDispose",value:function forceDispose(){var i,len=CacheManger._cacheList.length;for(i=0;i<len;i++){CacheManger._cacheList[i].tryDispose(true);}}},{key:"beginCheck",value:function beginCheck(){var waitTime=arguments.length>0&&arguments[0]!==undefined?arguments[0]:15000;ILaya.systemTimer.loop(waitTime,null,CacheManger._checkLoop);}},{key:"stopCheck",value:function stopCheck(){ILaya.systemTimer.clear(null,CacheManger._checkLoop);}},{key:"_checkLoop",value:function _checkLoop(){var cacheList=CacheManger._cacheList;if(cacheList.length<1)return;var tTime=ILaya.Browser.now();var count;var len;len=count=cacheList.length;while(count>0){CacheManger._index++;CacheManger._index=CacheManger._index%len;cacheList[CacheManger._index].tryDispose(false);if(ILaya.Browser.now()-tTime>CacheManger.loopTimeLimit)break;count--;}}}]);return CacheManger;}();CacheManger.loopTimeLimit=2;CacheManger._cacheList=[];CacheManger._index=0;var VectorGraphManager=function(){function VectorGraphManager(){_classCallCheck(this,VectorGraphManager);this.useDic={};this.shapeDic={};this.shapeLineDic={};this._id=0;this._checkKey=false;this._freeIdArray=[];CacheManger.regCacheByFunction(this.startDispose.bind(this),this.getCacheList.bind(this));}_createClass(VectorGraphManager,[{key:"getId",value:function getId(){return this._id++;}},{key:"addShape",value:function addShape(id,shape){this.shapeDic[id]=shape;if(!this.useDic[id]){this.useDic[id]=true;}}},{key:"addLine",value:function addLine(id,Line){this.shapeLineDic[id]=Line;if(!this.shapeLineDic[id]){this.shapeLineDic[id]=true;}}},{key:"getShape",value:function getShape(id){if(this._checkKey){if(this.useDic[id]!=null){this.useDic[id]=true;}}}},{key:"deleteShape",value:function deleteShape(id){if(this.shapeDic[id]){this.shapeDic[id]=null;delete this.shapeDic[id];}if(this.shapeLineDic[id]){this.shapeLineDic[id]=null;delete this.shapeLineDic[id];}if(this.useDic[id]!=null){delete this.useDic[id];}}},{key:"getCacheList",value:function getCacheList(){var str;var list=[];for(str in this.shapeDic){list.push(this.shapeDic[str]);}for(str in this.shapeLineDic){list.push(this.shapeLineDic[str]);}return list;}},{key:"startDispose",value:function startDispose(key){var str;for(str in this.useDic){this.useDic[str]=false;}this._checkKey=true;}},{key:"endDispose",value:function endDispose(){if(this._checkKey){var str;for(str in this.useDic){if(!this.useDic[str]){this.deleteShape(str);}}this._checkKey=false;}}}],[{key:"getInstance",value:function getInstance(){return VectorGraphManager.instance=VectorGraphManager.instance||new VectorGraphManager();}}]);return VectorGraphManager;}();var Graphics=function(){function Graphics(){_classCallCheck(this,Graphics);this._sp=null;this._one=null;this._render=this._renderEmpty;this._cmds=null;this._vectorgraphArray=null;this._graphicBounds=null;this.autoDestroy=false;this._createData();}_createClass(Graphics,[{key:"_createData",value:function _createData(){}},{key:"_clearData",value:function _clearData(){}},{key:"_destroyData",value:function _destroyData(){}},{key:"destroy",value:function destroy(){this.clear(true);if(this._graphicBounds)this._graphicBounds.destroy();this._graphicBounds=null;this._vectorgraphArray=null;if(this._sp){this._sp._renderType=0;this._sp._setRenderType(0);this._sp=null;}this._destroyData();}},{key:"clear",value:function clear(){var recoverCmds=arguments.length>0&&arguments[0]!==undefined?arguments[0]:true;if(recoverCmds){var tCmd=this._one;if(this._cmds){var i,len=this._cmds.length;for(i=0;i<len;i++){tCmd=this._cmds[i];tCmd.recover();}this._cmds.length=0;}else if(tCmd){tCmd.recover();}}else{this._cmds=null;}this._one=null;this._render=this._renderEmpty;this._clearData();if(this._sp){this._sp._renderType&=~SpriteConst.GRAPHICS;this._sp._setRenderType(this._sp._renderType);}this._repaint();if(this._vectorgraphArray){for(i=0,len=this._vectorgraphArray.length;i<len;i++){VectorGraphManager.getInstance().deleteShape(this._vectorgraphArray[i]);}this._vectorgraphArray.length=0;}}},{key:"_clearBoundsCache",value:function _clearBoundsCache(){if(this._graphicBounds)this._graphicBounds.reset();}},{key:"_initGraphicBounds",value:function _initGraphicBounds(){if(!this._graphicBounds){this._graphicBounds=GraphicsBounds.create();this._graphicBounds._graphics=this;}}},{key:"_repaint",value:function _repaint(){this._clearBoundsCache();this._sp&&this._sp.repaint();}},{key:"_isOnlyOne",value:function _isOnlyOne(){return!this._cmds||this._cmds.length===0;}},{key:"getBounds",value:function getBounds(){var realSize=arguments.length>0&&arguments[0]!==undefined?arguments[0]:false;this._initGraphicBounds();return this._graphicBounds.getBounds(realSize);}},{key:"getBoundPoints",value:function getBoundPoints(){var realSize=arguments.length>0&&arguments[0]!==undefined?arguments[0]:false;this._initGraphicBounds();return this._graphicBounds.getBoundPoints(realSize);}},{key:"drawImage",value:function drawImage(texture){var x=arguments.length>1&&arguments[1]!==undefined?arguments[1]:0;var y=arguments.length>2&&arguments[2]!==undefined?arguments[2]:0;var width=arguments.length>3&&arguments[3]!==undefined?arguments[3]:0;var height=arguments.length>4&&arguments[4]!==undefined?arguments[4]:0;if(!texture)return null;if(!width)width=texture.sourceWidth;if(!height)height=texture.sourceHeight;if(texture.getIsReady()){var wRate=width/texture.sourceWidth;var hRate=height/texture.sourceHeight;width=texture.width*wRate;height=texture.height*hRate;if(width<=0||height<=0)return null;x+=texture.offsetX*wRate;y+=texture.offsetY*hRate;}if(this._sp){this._sp._renderType|=SpriteConst.GRAPHICS;this._sp._setRenderType(this._sp._renderType);}var args=DrawImageCmd.create.call(this,texture,x,y,width,height);if(this._one==null){this._one=args;this._render=this._renderOneImg;}else{this._saveToCmd(null,args);}this._repaint();return args;}},{key:"drawTexture",value:function drawTexture(texture){var x=arguments.length>1&&arguments[1]!==undefined?arguments[1]:0;var y=arguments.length>2&&arguments[2]!==undefined?arguments[2]:0;var width=arguments.length>3&&arguments[3]!==undefined?arguments[3]:0;var height=arguments.length>4&&arguments[4]!==undefined?arguments[4]:0;var matrix=arguments.length>5&&arguments[5]!==undefined?arguments[5]:null;var alpha=arguments.length>6&&arguments[6]!==undefined?arguments[6]:1;var color=arguments.length>7&&arguments[7]!==undefined?arguments[7]:null;var blendMode=arguments.length>8&&arguments[8]!==undefined?arguments[8]:null;var uv=arguments[9];if(!texture||alpha<0.01)return null;if(!texture.getIsReady())return null;if(!width)width=texture.sourceWidth;if(!height)height=texture.sourceHeight;if(texture.getIsReady()){var wRate=width/texture.sourceWidth;var hRate=height/texture.sourceHeight;width=texture.width*wRate;height=texture.height*hRate;if(width<=0||height<=0)return null;x+=texture.offsetX*wRate;y+=texture.offsetY*hRate;}if(this._sp){this._sp._renderType|=SpriteConst.GRAPHICS;this._sp._setRenderType(this._sp._renderType);}var args=DrawTextureCmd.create.call(this,texture,x,y,width,height,matrix,alpha,color,blendMode,uv);this._repaint();return this._saveToCmd(null,args);}},{key:"drawTextures",value:function drawTextures(texture,pos){if(!texture)return null;return this._saveToCmd(Render._context.drawTextures,DrawTexturesCmd.create.call(this,texture,pos));}},{key:"drawTriangles",value:function drawTriangles(texture,x,y,vertices,uvs,indices){var matrix=arguments.length>6&&arguments[6]!==undefined?arguments[6]:null;var alpha=arguments.length>7&&arguments[7]!==undefined?arguments[7]:1;var color=arguments.length>8&&arguments[8]!==undefined?arguments[8]:null;var blendMode=arguments.length>9&&arguments[9]!==undefined?arguments[9]:null;var colorNum=arguments.length>10&&arguments[10]!==undefined?arguments[10]:undefined;return this._saveToCmd(Render._context.drawTriangles,DrawTrianglesCmd.create.call(this,texture,x,y,vertices,uvs,indices,matrix,alpha,color,blendMode,colorNum));}},{key:"fillTexture",value:function fillTexture(texture,x,y){var width=arguments.length>3&&arguments[3]!==undefined?arguments[3]:0;var height=arguments.length>4&&arguments[4]!==undefined?arguments[4]:0;var type=arguments.length>5&&arguments[5]!==undefined?arguments[5]:"repeat";var offset=arguments.length>6&&arguments[6]!==undefined?arguments[6]:null;if(texture&&texture.getIsReady())return this._saveToCmd(Render._context._fillTexture,FillTextureCmd.create.call(this,texture,x,y,width,height,type,offset||Point.EMPTY,{}));else return null;}},{key:"_saveToCmd",value:function _saveToCmd(fun,args){if(this._sp){this._sp._renderType|=SpriteConst.GRAPHICS;this._sp._setRenderType(this._sp._renderType);}if(this._one==null){this._one=args;this._render=this._renderOne;}else{this._render=this._renderAll;(this._cmds||(this._cmds=[])).length===0&&this._cmds.push(this._one);this._cmds.push(args);}this._repaint();return args;}},{key:"clipRect",value:function clipRect(x,y,width,height){return this._saveToCmd(Render._context.clipRect,ClipRectCmd.create.call(this,x,y,width,height));}},{key:"fillText",value:function fillText(text,x,y,font,color,textAlign){return this._saveToCmd(Render._context.fillText,FillTextCmd.create.call(this,text,null,x,y,font||ILaya.Text.defaultFontStr(),color,textAlign,0,""));}},{key:"fillBorderText",value:function fillBorderText(text,x,y,font,fillColor,textAlign,lineWidth,borderColor){return this._saveToCmd(Render._context.fillText,FillTextCmd.create.call(this,text,null,x,y,font||ILaya.Text.defaultFontStr(),fillColor,borderColor,lineWidth,textAlign));}},{key:"fillWords",value:function fillWords(words,x,y,font,color){return this._saveToCmd(Render._context.fillText,FillTextCmd.create.call(this,null,words,x,y,font||ILaya.Text.defaultFontStr(),color));}},{key:"fillBorderWords",value:function fillBorderWords(words,x,y,font,fillColor,borderColor,lineWidth){return this._saveToCmd(Render._context.fillText,FillTextCmd.create.call(this,null,words,x,y,font||ILaya.Text.defaultFontStr(),fillColor,"",lineWidth,borderColor));}},{key:"strokeText",value:function strokeText(text,x,y,font,color,lineWidth,textAlign){return this._saveToCmd(Render._context.fillText,FillTextCmd.create.call(this,text,null,x,y,font||ILaya.Text.defaultFontStr(),null,textAlign,lineWidth,color));}},{key:"alpha",value:function alpha(_alpha){return this._saveToCmd(Render._context.alpha,AlphaCmd.create.call(this,_alpha));}},{key:"transform",value:function transform(matrix){var pivotX=arguments.length>1&&arguments[1]!==undefined?arguments[1]:0;var pivotY=arguments.length>2&&arguments[2]!==undefined?arguments[2]:0;return this._saveToCmd(Render._context._transform,TransformCmd.create.call(this,matrix,pivotX,pivotY));}},{key:"rotate",value:function rotate(angle){var pivotX=arguments.length>1&&arguments[1]!==undefined?arguments[1]:0;var pivotY=arguments.length>2&&arguments[2]!==undefined?arguments[2]:0;return this._saveToCmd(Render._context._rotate,RotateCmd.create.call(this,angle,pivotX,pivotY));}},{key:"scale",value:function scale(scaleX,scaleY){var pivotX=arguments.length>2&&arguments[2]!==undefined?arguments[2]:0;var pivotY=arguments.length>3&&arguments[3]!==undefined?arguments[3]:0;return this._saveToCmd(Render._context._scale,ScaleCmd.create.call(this,scaleX,scaleY,pivotX,pivotY));}},{key:"translate",value:function translate(tx,ty){return this._saveToCmd(Render._context.translate,TranslateCmd.create.call(this,tx,ty));}},{key:"save",value:function save(){return this._saveToCmd(Render._context._save,SaveCmd.create.call(this));}},{key:"restore",value:function restore(){return this._saveToCmd(Render._context.restore,RestoreCmd.create.call(this));}},{key:"replaceText",value:function replaceText(text){this._repaint();var cmds=this._cmds;if(!cmds){if(this._one&&this._isTextCmd(this._one)){this._one.text=text;return true;}}else{for(var i=cmds.length-1;i>-1;i--){if(this._isTextCmd(cmds[i])){cmds[i].text=text;return true;}}}return false;}},{key:"_isTextCmd",value:function _isTextCmd(cmd){var cmdID=cmd.cmdID;return cmdID==FillTextCmd.ID;}},{key:"replaceTextColor",value:function replaceTextColor(color){this._repaint();var cmds=this._cmds;if(!cmds){if(this._one&&this._isTextCmd(this._one)){this._setTextCmdColor(this._one,color);}}else{for(var i=cmds.length-1;i>-1;i--){if(this._isTextCmd(cmds[i])){this._setTextCmdColor(cmds[i],color);}}}}},{key:"_setTextCmdColor",value:function _setTextCmdColor(cmdO,color){var cmdID=cmdO.cmdID;switch(cmdID){case FillTextCmd.ID:cmdO.color=color;break;}}},{key:"loadImage",value:function loadImage(url){var x=arguments.length>1&&arguments[1]!==undefined?arguments[1]:0;var y=arguments.length>2&&arguments[2]!==undefined?arguments[2]:0;var width=arguments.length>3&&arguments[3]!==undefined?arguments[3]:0;var height=arguments.length>4&&arguments[4]!==undefined?arguments[4]:0;var complete=arguments.length>5&&arguments[5]!==undefined?arguments[5]:null;var tex=ILaya.Loader.getRes(url);if(!tex){tex=new Texture();tex.load(url);ILaya.Loader.cacheTexture(url,tex);tex.once(Event.READY,this,this.drawImage,[tex,x,y,width,height]);}else{if(!tex.getIsReady()){tex.once(Event.READY,this,this.drawImage,[tex,x,y,width,height]);}else this.drawImage(tex,x,y,width,height);}if(complete!=null){tex.getIsReady()?complete.call(this._sp):tex.on(Event.READY,this._sp,complete);}}},{key:"_renderEmpty",value:function _renderEmpty(sprite,context,x,y){}},{key:"_renderAll",value:function _renderAll(sprite,context,x,y){var cmds=this._cmds;for(var i=0,n=cmds.length;i<n;i++){cmds[i].run(context,x,y);}}},{key:"_renderOne",value:function _renderOne(sprite,context,x,y){context.sprite=sprite;this._one.run(context,x,y);}},{key:"_renderOneImg",value:function _renderOneImg(sprite,context,x,y){context.sprite=sprite;this._one.run(context,x,y);}},{key:"drawLine",value:function drawLine(fromX,fromY,toX,toY,lineColor){var lineWidth=arguments.length>5&&arguments[5]!==undefined?arguments[5]:1;var offset=lineWidth<1||lineWidth%2===0?0:0.5;return this._saveToCmd(Render._context._drawLine,DrawLineCmd.create.call(this,fromX+offset,fromY+offset,toX+offset,toY+offset,lineColor,lineWidth,0));}},{key:"drawLines",value:function drawLines(x,y,points,lineColor){var lineWidth=arguments.length>4&&arguments[4]!==undefined?arguments[4]:1;if(!points||points.length<4)return null;var offset=lineWidth<1||lineWidth%2===0?0:0.5;return this._saveToCmd(Render._context._drawLines,DrawLinesCmd.create.call(this,x+offset,y+offset,points,lineColor,lineWidth,0));}},{key:"drawCurves",value:function drawCurves(x,y,points,lineColor){var lineWidth=arguments.length>4&&arguments[4]!==undefined?arguments[4]:1;return this._saveToCmd(Render._context.drawCurves,DrawCurvesCmd.create.call(this,x,y,points,lineColor,lineWidth));}},{key:"drawRect",value:function drawRect(x,y,width,height,fillColor){var lineColor=arguments.length>5&&arguments[5]!==undefined?arguments[5]:null;var lineWidth=arguments.length>6&&arguments[6]!==undefined?arguments[6]:1;var offset=lineWidth>=1&&lineColor?lineWidth/2:0;var lineOffset=lineColor?lineWidth:0;return this._saveToCmd(Render._context.drawRect,DrawRectCmd.create.call(this,x+offset,y+offset,width-lineOffset,height-lineOffset,fillColor,lineColor,lineWidth));}},{key:"drawCircle",value:function drawCircle(x,y,radius,fillColor){var lineColor=arguments.length>4&&arguments[4]!==undefined?arguments[4]:null;var lineWidth=arguments.length>5&&arguments[5]!==undefined?arguments[5]:1;var offset=lineWidth>=1&&lineColor?lineWidth/2:0;return this._saveToCmd(Render._context._drawCircle,DrawCircleCmd.create.call(this,x,y,radius-offset,fillColor,lineColor,lineWidth,0));}},{key:"drawPie",value:function drawPie(x,y,radius,startAngle,endAngle,fillColor){var lineColor=arguments.length>6&&arguments[6]!==undefined?arguments[6]:null;var lineWidth=arguments.length>7&&arguments[7]!==undefined?arguments[7]:1;var offset=lineWidth>=1&&lineColor?lineWidth/2:0;var lineOffset=lineColor?lineWidth:0;return this._saveToCmd(Render._context._drawPie,DrawPieCmd.create.call(this,x+offset,y+offset,radius-lineOffset,Utils.toRadian(startAngle),Utils.toRadian(endAngle),fillColor,lineColor,lineWidth,0));}},{key:"drawPoly",value:function drawPoly(x,y,points,fillColor){var lineColor=arguments.length>4&&arguments[4]!==undefined?arguments[4]:null;var lineWidth=arguments.length>5&&arguments[5]!==undefined?arguments[5]:1;var tIsConvexPolygon=false;if(points.length>6){tIsConvexPolygon=false;}else{tIsConvexPolygon=true;}var offset=lineWidth>=1&&lineColor?lineWidth%2===0?0:0.5:0;return this._saveToCmd(Render._context._drawPoly,DrawPolyCmd.create.call(this,x+offset,y+offset,points,fillColor,lineColor,lineWidth,tIsConvexPolygon,0));}},{key:"drawPath",value:function drawPath(x,y,paths){var brush=arguments.length>3&&arguments[3]!==undefined?arguments[3]:null;var pen=arguments.length>4&&arguments[4]!==undefined?arguments[4]:null;return this._saveToCmd(Render._context._drawPath,DrawPathCmd.create.call(this,x,y,paths,brush,pen));}},{key:"draw9Grid",value:function draw9Grid(texture){var x=arguments.length>1&&arguments[1]!==undefined?arguments[1]:0;var y=arguments.length>2&&arguments[2]!==undefined?arguments[2]:0;var width=arguments.length>3&&arguments[3]!==undefined?arguments[3]:0;var height=arguments.length>4&&arguments[4]!==undefined?arguments[4]:0;var sizeGrid=arguments.length>5&&arguments[5]!==undefined?arguments[5]:null;this._saveToCmd(null,Draw9GridTexture.create(texture,x,y,width,height,sizeGrid));}},{key:"cmds",get:function get(){return this._cmds;},set:function set(value){if(this._sp){this._sp._renderType|=SpriteConst.GRAPHICS;this._sp._setRenderType(this._sp._renderType);}this._cmds=value;this._render=this._renderAll;this._repaint();}}]);return Graphics;}();var Const=function Const(){_classCallCheck(this,Const);};Const.NOT_ACTIVE=0x01;Const.ACTIVE_INHIERARCHY=0x02;Const.AWAKED=0x04;Const.NOT_READY=0x08;Const.DISPLAY=0x10;Const.HAS_ZORDER=0x20;Const.HAS_MOUSE=0x40;Const.DISPLAYED_INSTAGE=0x80;Const.DRAWCALL_OPTIMIZE=0x100;var LayaGLQuickRunner=function(){function LayaGLQuickRunner(){_classCallCheck(this,LayaGLQuickRunner);}_createClass(LayaGLQuickRunner,null,[{key:"__init__",value:function __init__(){LayaGLQuickRunner.map[SpriteConst.ALPHA|SpriteConst.TRANSFORM|SpriteConst.GRAPHICS]=LayaGLQuickRunner.alpha_transform_drawLayaGL;LayaGLQuickRunner.map[SpriteConst.ALPHA|SpriteConst.GRAPHICS]=LayaGLQuickRunner.alpha_drawLayaGL;LayaGLQuickRunner.map[SpriteConst.TRANSFORM|SpriteConst.GRAPHICS]=LayaGLQuickRunner.transform_drawLayaGL;LayaGLQuickRunner.map[SpriteConst.TRANSFORM|SpriteConst.CHILDS]=LayaGLQuickRunner.transform_drawNodes;LayaGLQuickRunner.map[SpriteConst.ALPHA|SpriteConst.TRANSFORM|SpriteConst.TEXTURE]=LayaGLQuickRunner.alpha_transform_drawTexture;LayaGLQuickRunner.map[SpriteConst.ALPHA|SpriteConst.TEXTURE]=LayaGLQuickRunner.alpha_drawTexture;LayaGLQuickRunner.map[SpriteConst.TRANSFORM|SpriteConst.TEXTURE]=LayaGLQuickRunner.transform_drawTexture;LayaGLQuickRunner.map[SpriteConst.GRAPHICS|SpriteConst.CHILDS]=LayaGLQuickRunner.drawLayaGL_drawNodes;}},{key:"transform_drawTexture",value:function transform_drawTexture(sprite,context,x,y){var style=sprite._style;var tex=sprite.texture;context.saveTransform(LayaGLQuickRunner.curMat);context.transformByMatrix(sprite.transform,x,y);context.drawTexture(tex,-sprite.pivotX,-sprite.pivotY,sprite._width||tex.width,sprite._height||tex.height);context.restoreTransform(LayaGLQuickRunner.curMat);}},{key:"alpha_drawTexture",value:function alpha_drawTexture(sprite,context,x,y){var style=sprite._style;var alpha;var tex=sprite.texture;if((alpha=style.alpha)>0.01||sprite._needRepaint()){var temp=context.globalAlpha;context.globalAlpha*=alpha;context.drawTexture(tex,x-style.pivotX+tex.offsetX,y-style.pivotY+tex.offsetY,sprite._width||tex.width,sprite._height||tex.height);context.globalAlpha=temp;}}},{key:"alpha_transform_drawTexture",value:function alpha_transform_drawTexture(sprite,context,x,y){var style=sprite._style;var alpha;var tex=sprite.texture;if((alpha=style.alpha)>0.01||sprite._needRepaint()){var temp=context.globalAlpha;context.globalAlpha*=alpha;context.saveTransform(LayaGLQuickRunner.curMat);context.transformByMatrix(sprite.transform,x,y);context.drawTexture(tex,-style.pivotX+tex.offsetX,-style.pivotY+tex.offsetY,sprite._width||tex.width,sprite._height||tex.height);context.restoreTransform(LayaGLQuickRunner.curMat);context.globalAlpha=temp;}}},{key:"alpha_transform_drawLayaGL",value:function alpha_transform_drawLayaGL(sprite,context,x,y){var style=sprite._style;var alpha;if((alpha=style.alpha)>0.01||sprite._needRepaint()){var temp=context.globalAlpha;context.globalAlpha*=alpha;context.saveTransform(LayaGLQuickRunner.curMat);context.transformByMatrix(sprite.transform,x,y);sprite._graphics&&sprite._graphics._render(sprite,context,-style.pivotX,-style.pivotY);context.restoreTransform(LayaGLQuickRunner.curMat);context.globalAlpha=temp;}}},{key:"alpha_drawLayaGL",value:function alpha_drawLayaGL(sprite,context,x,y){var style=sprite._style;var alpha;if((alpha=style.alpha)>0.01||sprite._needRepaint()){var temp=context.globalAlpha;context.globalAlpha*=alpha;sprite._graphics&&sprite._graphics._render(sprite,context,x-style.pivotX,y-style.pivotY);context.globalAlpha=temp;}}},{key:"transform_drawLayaGL",value:function transform_drawLayaGL(sprite,context,x,y){var style=sprite._style;context.saveTransform(LayaGLQuickRunner.curMat);context.transformByMatrix(sprite.transform,x,y);sprite._graphics&&sprite._graphics._render(sprite,context,-style.pivotX,-style.pivotY);context.restoreTransform(LayaGLQuickRunner.curMat);}},{key:"transform_drawNodes",value:function transform_drawNodes(sprite,context,x,y){var textLastRender=sprite._getBit(Const.DRAWCALL_OPTIMIZE)&&context.drawCallOptimize(true);var style=sprite._style;context.saveTransform(LayaGLQuickRunner.curMat);context.transformByMatrix(sprite.transform,x,y);x=-style.pivotX;y=-style.pivotY;var childs=sprite._children,n=childs.length,ele;if(style.viewport){var rect=style.viewport;var left=rect.x;var top=rect.y;var right=rect.right;var bottom=rect.bottom;var _x,_y;for(i=0;i<n;++i){if((ele=childs[i])._visible&&(_x=ele._x)<right&&_x+ele.width>left&&(_y=ele._y)<bottom&&_y+ele.height>top){ele.render(context,x,y);}}}else{for(var i=0;i<n;++i){(ele=childs[i])._visible&&ele.render(context,x,y);}}context.restoreTransform(LayaGLQuickRunner.curMat);textLastRender&&context.drawCallOptimize(false);}},{key:"drawLayaGL_drawNodes",value:function drawLayaGL_drawNodes(sprite,context,x,y){var textLastRender=sprite._getBit(Const.DRAWCALL_OPTIMIZE)&&context.drawCallOptimize(true);var style=sprite._style;x=x-style.pivotX;y=y-style.pivotY;sprite._graphics&&sprite._graphics._render(sprite,context,x,y);var childs=sprite._children,n=childs.length,ele;if(style.viewport){var rect=style.viewport;var left=rect.x;var top=rect.y;var right=rect.right;var bottom=rect.bottom;var _x,_y;for(i=0;i<n;++i){if((ele=childs[i])._visible&&(_x=ele._x)<right&&_x+ele.width>left&&(_y=ele._y)<bottom&&_y+ele.height>top){ele.render(context,x,y);}}}else{for(var i=0;i<n;++i){(ele=childs[i])._visible&&ele.render(context,x,y);}}textLastRender&&context.drawCallOptimize(false);}}]);return LayaGLQuickRunner;}();LayaGLQuickRunner.map={};LayaGLQuickRunner.curMat=new Matrix();var RenderSprite=function(){function RenderSprite(type,next){_classCallCheck(this,RenderSprite);if(LayaGLQuickRunner.map[type]){this._fun=LayaGLQuickRunner.map[type];this._next=RenderSprite.NORENDER;return;}this._next=next||RenderSprite.NORENDER;switch(type){case 0:this._fun=this._no;return;case SpriteConst.ALPHA:this._fun=this._alpha;return;case SpriteConst.TRANSFORM:this._fun=this._transform;return;case SpriteConst.BLEND:this._fun=this._blend;return;case SpriteConst.CANVAS:this._fun=this._canvas;return;case SpriteConst.MASK:this._fun=this._mask;return;case SpriteConst.CLIP:this._fun=this._clip;return;case SpriteConst.STYLE:this._fun=this._style;return;case SpriteConst.GRAPHICS:this._fun=this._graphics;return;case SpriteConst.CHILDS:this._fun=this._children;return;case SpriteConst.CUSTOM:this._fun=this._custom;return;case SpriteConst.TEXTURE:this._fun=this._texture;return;case SpriteConst.FILTERS:this._fun=Filter._filter;return;case RenderSprite.INIT:this._fun=RenderSprite._initRenderFun;return;}this.onCreate(type);}_createClass(RenderSprite,[{key:"onCreate",value:function onCreate(type){}},{key:"_style",value:function _style(sprite,context,x,y){var style=sprite._style;if(style.render!=null)style.render(sprite,context,x,y);var next=this._next;next._fun.call(next,sprite,context,x,y);}},{key:"_no",value:function _no(sprite,context,x,y){}},{key:"_custom",value:function _custom(sprite,context,x,y){sprite.customRender(context,x,y);this._next._fun.call(this._next,sprite,context,x-sprite.pivotX,y-sprite.pivotY);}},{key:"_clip",value:function _clip(sprite,context,x,y){var next=this._next;if(next==RenderSprite.NORENDER)return;var r=sprite._style.scrollRect;context.save();context.clipRect(x,y,r.width,r.height);next._fun.call(next,sprite,context,x-r.x,y-r.y);context.restore();}},{key:"_texture",value:function _texture(sprite,context,x,y){var tex=sprite.texture;if(tex._getSource())context.drawTexture(tex,x-sprite.pivotX+tex.offsetX,y-sprite.pivotY+tex.offsetY,sprite._width||tex.width,sprite._height||tex.height);var next=this._next;if(next!=RenderSprite.NORENDER)next._fun.call(next,sprite,context,x,y);}},{key:"_graphics",value:function _graphics(sprite,context,x,y){var style=sprite._style;var g=sprite._graphics;g&&g._render(sprite,context,x-style.pivotX,y-style.pivotY);var next=this._next;if(next!=RenderSprite.NORENDER)next._fun.call(next,sprite,context,x,y);}},{key:"_image",value:function _image(sprite,context,x,y){var style=sprite._style;context.drawTexture2(x,y,style.pivotX,style.pivotY,sprite.transform,sprite._graphics._one);}},{key:"_image2",value:function _image2(sprite,context,x,y){var style=sprite._style;context.drawTexture2(x,y,style.pivotX,style.pivotY,sprite.transform,sprite._graphics._one);}},{key:"_alpha",value:function _alpha(sprite,context,x,y){var style=sprite._style;var alpha;if((alpha=style.alpha)>0.01||sprite._needRepaint()){var temp=context.globalAlpha;context.globalAlpha*=alpha;var next=this._next;next._fun.call(next,sprite,context,x,y);context.globalAlpha=temp;}}},{key:"_transform",value:function _transform(sprite,context,x,y){var transform=sprite.transform,_next=this._next;var style=sprite._style;if(transform&&_next!=RenderSprite.NORENDER){context.save();context.transform(transform.a,transform.b,transform.c,transform.d,transform.tx+x,transform.ty+y);_next._fun.call(_next,sprite,context,0,0);context.restore();}else{if(_next!=RenderSprite.NORENDER)_next._fun.call(_next,sprite,context,x,y);}}},{key:"_children",value:function _children(sprite,context,x,y){var style=sprite._style;var childs=sprite._children,n=childs.length,ele;x=x-sprite.pivotX;y=y-sprite.pivotY;var textLastRender=sprite._getBit(Const.DRAWCALL_OPTIMIZE)&&context.drawCallOptimize(true);if(style.viewport){var rect=style.viewport;var left=rect.x;var top=rect.y;var right=rect.right;var bottom=rect.bottom;var _x,_y;for(i=0;i<n;++i){if((ele=childs[i])._visible&&(_x=ele._x)<right&&_x+ele.width>left&&(_y=ele._y)<bottom&&_y+ele.height>top){ele.render(context,x,y);}}}else{for(var i=0;i<n;++i){(ele=childs[i])._visible&&ele.render(context,x,y);}}textLastRender&&context.drawCallOptimize(false);}},{key:"_canvas",value:function _canvas(sprite,context,x,y){var _cacheStyle=sprite._cacheStyle;var _next=this._next;if(!_cacheStyle.enableCanvasRender){_next._fun.call(_next,sprite,context,x,y);return;}_cacheStyle.cacheAs==='bitmap'?Stat.canvasBitmap++:Stat.canvasNormal++;var cacheNeedRebuild=false;var textNeedRestore=false;if(_cacheStyle.canvas){var canv=_cacheStyle.canvas;var ctx=canv.context;var charRIs=canv.touches;if(charRIs){for(var ci=0;ci<charRIs.length;ci++){if(charRIs[ci].deleted){textNeedRestore=true;break;}}}cacheNeedRebuild=canv.isCacheValid&&!canv.isCacheValid();}if(sprite._needRepaint()||!_cacheStyle.canvas||textNeedRestore||cacheNeedRebuild||ILaya.stage.isGlobalRepaint()){if(_cacheStyle.cacheAs==='normal'){if(context._targets){_next._fun.call(_next,sprite,context,x,y);return;}else{this._canvas_webgl_normal_repaint(sprite,context);}}else{this._canvas_repaint(sprite,context,x,y);}}var tRec=_cacheStyle.cacheRect;context.drawCanvas(_cacheStyle.canvas,x+tRec.x,y+tRec.y,tRec.width,tRec.height);}},{key:"_canvas_repaint",value:function _canvas_repaint(sprite,context,x,y){var _cacheStyle=sprite._cacheStyle;var _next=this._next;var tx;var canvas=_cacheStyle.canvas;var left;var top;var tRec;var tCacheType=_cacheStyle.cacheAs;var w,h;var scaleX,scaleY;var scaleInfo;scaleInfo=_cacheStyle._calculateCacheRect(sprite,tCacheType,x,y);scaleX=scaleInfo.x;scaleY=scaleInfo.y;tRec=_cacheStyle.cacheRect;w=tRec.width*scaleX;h=tRec.height*scaleY;left=tRec.x;top=tRec.y;if(tCacheType==='bitmap'&&(w>2048||h>2048)){console.warn("cache bitmap size larger than 2048,cache ignored");_cacheStyle.releaseContext();_next._fun.call(_next,sprite,context,x,y);return;}if(!canvas){_cacheStyle.createContext();canvas=_cacheStyle.canvas;}tx=canvas.context;tx.sprite=sprite;(canvas.width!=w||canvas.height!=h)&&canvas.size(w,h);if(tCacheType==='bitmap')tx.asBitmap=true;else if(tCacheType==='normal')tx.asBitmap=false;tx.clear();if(scaleX!=1||scaleY!=1){var ctx=tx;ctx.save();ctx.scale(scaleX,scaleY);_next._fun.call(_next,sprite,tx,-left,-top);ctx.restore();sprite._applyFilters();}else{ctx=tx;_next._fun.call(_next,sprite,tx,-left,-top);sprite._applyFilters();}if(_cacheStyle.staticCache)_cacheStyle.reCache=false;Stat.canvasReCache++;}},{key:"_canvas_webgl_normal_repaint",value:function _canvas_webgl_normal_repaint(sprite,context){var _cacheStyle=sprite._cacheStyle;var _next=this._next;var canvas=_cacheStyle.canvas;var tCacheType=_cacheStyle.cacheAs;_cacheStyle._calculateCacheRect(sprite,tCacheType,0,0);if(!canvas){canvas=_cacheStyle.canvas=new WebGLCacheAsNormalCanvas(context,sprite);}var tx=canvas.context;canvas['startRec']();_next._fun.call(_next,sprite,tx,sprite.pivotX,sprite.pivotY);sprite._applyFilters();Stat.canvasReCache++;canvas['endRec']();}},{key:"_blend",value:function _blend(sprite,context,x,y){var style=sprite._style;var next=this._next;if(style.blendMode){context.save();context.globalCompositeOperation=style.blendMode;next._fun.call(next,sprite,context,x,y);context.restore();}else{next._fun.call(next,sprite,context,x,y);}}},{key:"_mask",value:function _mask(sprite,context,x,y){var next=this._next;var mask=sprite.mask;var ctx=context;if(mask){ctx.save();var preBlendMode=ctx.globalCompositeOperation;var tRect=new Rectangle();tRect.copyFrom(mask.getBounds());tRect.width=Math.round(tRect.width);tRect.height=Math.round(tRect.height);tRect.x=Math.round(tRect.x);tRect.y=Math.round(tRect.y);if(tRect.width>0&&tRect.height>0){var w=tRect.width;var h=tRect.height;var tmpRT=WebGLRTMgr.getRT(w,h);ctx.breakNextMerge();ctx.pushRT();ctx.addRenderObject(SubmitCMD.create([ctx,tmpRT,w,h],RenderSprite.tmpTarget,this));mask.render(ctx,-tRect.x,-tRect.y);ctx.breakNextMerge();ctx.popRT();ctx.save();ctx.clipRect(x+tRect.x-sprite.getStyle().pivotX,y+tRect.y-sprite.getStyle().pivotY,w,h);next._fun.call(next,sprite,ctx,x,y);ctx.restore();preBlendMode=ctx.globalCompositeOperation;ctx.addRenderObject(SubmitCMD.create(["mask"],RenderSprite.setBlendMode,this));var shaderValue=Value2D.create(ShaderDefines2D.TEXTURE2D,0);var uv=Texture.INV_UV;ctx.drawTarget(tmpRT,x+tRect.x-sprite.getStyle().pivotX,y+tRect.y-sprite.getStyle().pivotY,w,h,Matrix.TEMP.identity(),shaderValue,uv,6);ctx.addRenderObject(SubmitCMD.create([tmpRT],RenderSprite.recycleTarget,this));ctx.addRenderObject(SubmitCMD.create([preBlendMode],RenderSprite.setBlendMode,this));}ctx.restore();}else{next._fun.call(next,sprite,context,x,y);}}}],[{key:"__init__",value:function __init__(){LayaGLQuickRunner.__init__();var i,len;var initRender;initRender=new RenderSprite(RenderSprite.INIT,null);len=RenderSprite.renders.length=SpriteConst.CHILDS*2;for(i=0;i<len;i++){RenderSprite.renders[i]=initRender;}RenderSprite.renders[0]=new RenderSprite(0,null);}},{key:"_initRenderFun",value:function _initRenderFun(sprite,context,x,y){var type=sprite._renderType;var r=RenderSprite.renders[type]=RenderSprite._getTypeRender(type);r._fun(sprite,context,x,y);}},{key:"_getTypeRender",value:function _getTypeRender(type){if(LayaGLQuickRunner.map[type])return new RenderSprite(type,null);var rst=null;var tType=SpriteConst.CHILDS;while(tType>0){if(tType&type)rst=new RenderSprite(tType,rst);tType=tType>>1;}return rst;}},{key:"tmpTarget",value:function tmpTarget(ctx,rt,w,h){rt.start();rt.clear(0,0,0,0);}},{key:"recycleTarget",value:function recycleTarget(rt){WebGLRTMgr.releaseRT(rt);}},{key:"setBlendMode",value:function setBlendMode(blendMode){var gl=WebGLContext.mainContext;BlendMode.targetFns[BlendMode.TOINT[blendMode]](gl);}}]);return RenderSprite;}();RenderSprite.INIT=0x11111;RenderSprite.renders=[];RenderSprite.NORENDER=new RenderSprite(0,null);RenderSprite.tempUV=new Array(8);var HTMLCanvas=function(_Bitmap2){_inherits(HTMLCanvas,_Bitmap2);_createClass(HTMLCanvas,[{key:"_getSource",value:function _getSource(){return this._source;}},{key:"source",get:function get(){return this._source;}}]);function HTMLCanvas(){var createCanvas=arguments.length>0&&arguments[0]!==undefined?arguments[0]:false;_classCallCheck(this,HTMLCanvas);var _this27=_possibleConstructorReturn(this,(HTMLCanvas.__proto__||Object.getPrototypeOf(HTMLCanvas)).call(this));if(createCanvas)_this27._source=Browser.createElement("canvas");else{_this27._source=_this27;}_this27.lock=true;return _this27;}_createClass(HTMLCanvas,[{key:"clear",value:function clear(){this._ctx&&this._ctx.clear&&this._ctx.clear();if(this._texture){this._texture.destroy();this._texture=null;}}},{key:"destroy",value:function destroy(){_get(HTMLCanvas.prototype.__proto__||Object.getPrototypeOf(HTMLCanvas.prototype),"destroy",this).call(this);this._setCPUMemory(0);this._ctx&&this._ctx.destroy&&this._ctx.destroy();this._ctx=null;}},{key:"release",value:function release(){}},{key:"_setContext",value:function _setContext(context){this._ctx=context;}},{key:"getContext",value:function getContext(contextID){var other=arguments.length>1&&arguments[1]!==undefined?arguments[1]:null;return this.context;}},{key:"getMemSize",value:function getMemSize(){return 0;}},{key:"size",value:function size(w,h){if(this._width!=w||this._height!=h||this._source&&(this._source.width!=w||this._source.height!=h)){this._width=w;this._height=h;this._setCPUMemory(w*h*4);this._ctx&&this._ctx.size&&this._ctx.size(w,h);if(this._source){this._source.height=h;this._source.width=w;}if(this._texture){this._texture.destroy();this._texture=null;}}}},{key:"getTexture",value:function getTexture(){if(!this._texture){var bitmap=new Texture2D();bitmap.loadImageSource(this.source);this._texture=new Texture(bitmap);}return this._texture;}},{key:"toBase64",value:function toBase64(type,encoderOptions){if(this._source){if(ILaya.Render.isConchApp){var win=window;if(win.conchConfig.threadMode==2){throw"native 2 thread mode use toBase64Async";}var width=this._ctx._targets.sourceWidth;var height=this._ctx._targets.sourceHeight;var data=this._ctx._targets.getData(0,0,width,height);return win.conchToBase64FlipY?win.conchToBase64FlipY(type,encoderOptions,data.buffer,width,height):win.conchToBase64(type,encoderOptions,data.buffer,width,height);}else{return this._source.toDataURL(type,encoderOptions);}}return null;}},{key:"toBase64Async",value:function toBase64Async(type,encoderOptions,callBack){var width=this._ctx._targets.sourceWidth;var height=this._ctx._targets.sourceHeight;this._ctx._targets.getDataAsync(0,0,width,height,function(data){var win=window;var base64=win.conchToBase64FlipY?win.conchToBase64FlipY(type,encoderOptions,data.buffer,width,height):win.conchToBase64(type,encoderOptions,data.buffer,width,height);callBack(base64);});}},{key:"context",get:function get(){if(this._ctx)return this._ctx;if(this._source==this){this._ctx=new ILaya.Context();}else{this._ctx=this._source.getContext(ILaya.Render.isConchApp?'layagl':'2d');}this._ctx._canvas=this;return this._ctx;}}]);return HTMLCanvas;}(Bitmap);var HitArea=function(){function HitArea(){_classCallCheck(this,HitArea);}_createClass(HitArea,[{key:"contains",value:function contains(x,y){if(!HitArea._isHitGraphic(x,y,this.hit))return false;return!HitArea._isHitGraphic(x,y,this.unHit);}},{key:"hit",get:function get(){if(!this._hit)this._hit=new ILaya.Graphics();return this._hit;},set:function set(value){this._hit=value;}},{key:"unHit",get:function get(){if(!this._unHit)this._unHit=new ILaya.Graphics();return this._unHit;},set:function set(value){this._unHit=value;}}],[{key:"_isHitGraphic",value:function _isHitGraphic(x,y,graphic){if(!graphic)return false;var cmds=graphic.cmds;if(!cmds&&graphic._one){cmds=HitArea._cmds;cmds.length=1;cmds[0]=graphic._one;}if(!cmds)return false;var i,len;len=cmds.length;var cmd;for(i=0;i<len;i++){cmd=cmds[i];if(!cmd)continue;switch(cmd.cmdID){case"Translate":x-=cmd.tx;y-=cmd.ty;}if(HitArea._isHitCmd(x,y,cmd))return true;}return false;}},{key:"_isHitCmd",value:function _isHitCmd(x,y,cmd){if(!cmd)return false;var rst=false;switch(cmd.cmdID){case"DrawRect":HitArea._rect.setTo(cmd.x,cmd.y,cmd.width,cmd.height);rst=HitArea._rect.contains(x,y);break;case"DrawCircle":var d;x-=cmd.x;y-=cmd.y;d=x*x+y*y;rst=d<cmd.radius*cmd.radius;break;case"DrawPoly":x-=cmd.x;y-=cmd.y;rst=HitArea._ptInPolygon(x,y,cmd.points);break;}return rst;}},{key:"_ptInPolygon",value:function _ptInPolygon(x,y,areaPoints){var p=HitArea._ptPoint;p.setTo(x,y);var nCross=0;var p1x,p1y,p2x,p2y;var len;len=areaPoints.length;for(var i=0;i<len;i+=2){p1x=areaPoints[i];p1y=areaPoints[i+1];p2x=areaPoints[(i+2)%len];p2y=areaPoints[(i+3)%len];if(p1y==p2y)continue;if(p.y<Math.min(p1y,p2y))continue;if(p.y>=Math.max(p1y,p2y))continue;var tx=(p.y-p1y)*(p2x-p1x)/(p2y-p1y)+p1x;if(tx>p.x)nCross++;}return nCross%2==1;}}]);return HitArea;}();HitArea._cmds=[];HitArea._rect=new Rectangle();HitArea._ptPoint=new Point();var ClassUtils=function(){function ClassUtils(){_classCallCheck(this,ClassUtils);}_createClass(ClassUtils,null,[{key:"regClass",value:function regClass(className,classDef){ClassUtils._classMap[className]=classDef;}},{key:"regShortClassName",value:function regShortClassName(classes){for(var i=0;i<classes.length;i++){var classDef=classes[i];var className=classDef.name;ClassUtils._classMap[className]=classDef;}}},{key:"getRegClass",value:function getRegClass(className){return ClassUtils._classMap[className];}},{key:"getClass",value:function getClass(className){var classObject=ClassUtils._classMap[className]||ClassUtils._classMap['Laya.'+className]||className;var glaya=ILaya.Laya;if(typeof classObject=='string')return ILaya.__classMap[classObject]||glaya[className];return classObject;}},{key:"getInstance",value:function getInstance(className){var compClass=ClassUtils.getClass(className);if(compClass)return new compClass();else console.warn("[error] Undefined class:",className);return null;}},{key:"createByJson",value:function createByJson(json){var node=arguments.length>1&&arguments[1]!==undefined?arguments[1]:null;var root=arguments.length>2&&arguments[2]!==undefined?arguments[2]:null;var customHandler=arguments.length>3&&arguments[3]!==undefined?arguments[3]:null;var instanceHandler=arguments.length>4&&arguments[4]!==undefined?arguments[4]:null;if(typeof json=='string')json=JSON.parse(json);var props=json.props;if(!node){node=instanceHandler?instanceHandler.runWith(json):ClassUtils.getInstance(props.runtime||json.type);if(!node)return null;}var child=json.child;if(child){for(var i=0,n=child.length;i<n;i++){var data=child[i];if((data.props.name==="render"||data.props.renderType==="render")&&node["_$set_itemRender"])node.itemRender=data;else{if(data.type=="Graphic"){ClassUtils._addGraphicsToSprite(data,node);}else if(ClassUtils._isDrawType(data.type)){ClassUtils._addGraphicToSprite(data,node,true);}else{var tChild=ClassUtils.createByJson(data,null,root,customHandler,instanceHandler);if(data.type==="Script"){if("owner"in tChild){tChild["owner"]=node;}else if("target"in tChild){tChild["target"]=node;}}else if(data.props.renderType=="mask"){node.mask=tChild;}else{node.addChild(tChild);}}}}}if(props){for(var prop in props){var value=props[prop];if(prop==="var"&&root){root[value]=node;}else if(value instanceof Array&&node[prop]instanceof Function){node[prop].apply(node,value);}else{node[prop]=value;}}}if(customHandler&&json.customProps){customHandler.runWith([node,json]);}if(node["created"])node.created();return node;}},{key:"_addGraphicsToSprite",value:function _addGraphicsToSprite(graphicO,sprite){var graphics=graphicO.child;if(!graphics||graphics.length<1)return;var g=ClassUtils._getGraphicsFromSprite(graphicO,sprite);var ox=0;var oy=0;if(graphicO.props){ox=ClassUtils._getObjVar(graphicO.props,"x",0);oy=ClassUtils._getObjVar(graphicO.props,"y",0);}if(ox!=0&&oy!=0){g.translate(ox,oy);}var i,len;len=graphics.length;for(i=0;i<len;i++){ClassUtils._addGraphicToGraphics(graphics[i],g);}if(ox!=0&&oy!=0){g.translate(-ox,-oy);}}},{key:"_addGraphicToSprite",value:function _addGraphicToSprite(graphicO,sprite){var isChild=arguments.length>2&&arguments[2]!==undefined?arguments[2]:false;var g=isChild?ClassUtils._getGraphicsFromSprite(graphicO,sprite):sprite.graphics;ClassUtils._addGraphicToGraphics(graphicO,g);}},{key:"_getGraphicsFromSprite",value:function _getGraphicsFromSprite(dataO,sprite){if(!dataO||!dataO.props)return sprite.graphics;var propsName=dataO.props.renderType;if(propsName==="hit"||propsName==="unHit"){var hitArea=sprite._style.hitArea||(sprite.hitArea=new HitArea());if(!hitArea[propsName]){hitArea[propsName]=new Graphics();}var g=hitArea[propsName];}if(!g)g=sprite.graphics;return g;}},{key:"_getTransformData",value:function _getTransformData(propsO){var m;if("pivotX"in propsO||"pivotY"in propsO){m=m||new Matrix();m.translate(-ClassUtils._getObjVar(propsO,"pivotX",0),-ClassUtils._getObjVar(propsO,"pivotY",0));}var sx=ClassUtils._getObjVar(propsO,"scaleX",1),sy=ClassUtils._getObjVar(propsO,"scaleY",1);var rotate=ClassUtils._getObjVar(propsO,"rotation",0);var skewX=ClassUtils._getObjVar(propsO,"skewX",0);var skewY=ClassUtils._getObjVar(propsO,"skewY",0);if(sx!=1||sy!=1||rotate!=0){m=m||new Matrix();m.scale(sx,sy);m.rotate(rotate*0.0174532922222222);}return m;}},{key:"_addGraphicToGraphics",value:function _addGraphicToGraphics(graphicO,graphic){var propsO;propsO=graphicO.props;if(!propsO)return;var drawConfig;drawConfig=ClassUtils.DrawTypeDic[graphicO.type];if(!drawConfig)return;var g=graphic;var params=ClassUtils._getParams(propsO,drawConfig[1],drawConfig[2],drawConfig[3]);var m=ClassUtils._tM;if(m||ClassUtils._alpha!=1){g.save();if(m)g.transform(m);if(ClassUtils._alpha!=1)g.alpha(ClassUtils._alpha);}g[drawConfig[0]].apply(g,params);if(m||ClassUtils._alpha!=1){g.restore();}}},{key:"_adptLineData",value:function _adptLineData(params){params[2]=parseFloat(params[0])+parseFloat(params[2]);params[3]=parseFloat(params[1])+parseFloat(params[3]);return params;}},{key:"_adptTextureData",value:function _adptTextureData(params){params[0]=ILaya.Loader.getRes(params[0]);return params;}},{key:"_adptLinesData",value:function _adptLinesData(params){params[2]=ClassUtils._getPointListByStr(params[2]);return params;}},{key:"_isDrawType",value:function _isDrawType(type){if(type==="Image")return false;return type in ClassUtils.DrawTypeDic;}},{key:"_getParams",value:function _getParams(obj,params){var xPos=arguments.length>2&&arguments[2]!==undefined?arguments[2]:0;var adptFun=arguments.length>3&&arguments[3]!==undefined?arguments[3]:null;var rst=ClassUtils._temParam;rst.length=params.length;var i,len;len=params.length;for(i=0;i<len;i++){rst[i]=ClassUtils._getObjVar(obj,params[i][0],params[i][1]);}ClassUtils._alpha=ClassUtils._getObjVar(obj,"alpha",1);var m;m=ClassUtils._getTransformData(obj);if(m){if(!xPos)xPos=0;m.translate(rst[xPos],rst[xPos+1]);rst[xPos]=rst[xPos+1]=0;ClassUtils._tM=m;}else{ClassUtils._tM=null;}if(adptFun&&ClassUtils[adptFun]){rst=ClassUtils[adptFun](rst);}return rst;}},{key:"_getPointListByStr",value:function _getPointListByStr(str){var pointArr=str.split(",");var i,len;len=pointArr.length;for(i=0;i<len;i++){pointArr[i]=parseFloat(pointArr[i]);}return pointArr;}},{key:"_getObjVar",value:function _getObjVar(obj,key,noValue){if(key in obj){return obj[key];}return noValue;}}]);return ClassUtils;}();ClassUtils.DrawTypeDic={"Rect":["drawRect",[["x",0],["y",0],["width",0],["height",0],["fillColor",null],["lineColor",null],["lineWidth",1]]],"Circle":["drawCircle",[["x",0],["y",0],["radius",0],["fillColor",null],["lineColor",null],["lineWidth",1]]],"Pie":["drawPie",[["x",0],["y",0],["radius",0],["startAngle",0],["endAngle",0],["fillColor",null],["lineColor",null],["lineWidth",1]]],"Image":["drawTexture",[["x",0],["y",0],["width",0],["height",0]]],"Texture":["drawTexture",[["skin",null],["x",0],["y",0],["width",0],["height",0]],1,"_adptTextureData"],"FillTexture":["fillTexture",[["skin",null],["x",0],["y",0],["width",0],["height",0],["repeat",null]],1,"_adptTextureData"],"FillText":["fillText",[["text",""],["x",0],["y",0],["font",null],["color",null],["textAlign",null]],1],"Line":["drawLine",[["x",0],["y",0],["toX",0],["toY",0],["lineColor",null],["lineWidth",0]],0,"_adptLineData"],"Lines":["drawLines",[["x",0],["y",0],["points",""],["lineColor",null],["lineWidth",0]],0,"_adptLinesData"],"Curves":["drawCurves",[["x",0],["y",0],["points",""],["lineColor",null],["lineWidth",0]],0,"_adptLinesData"],"Poly":["drawPoly",[["x",0],["y",0],["points",""],["fillColor",null],["lineColor",null],["lineWidth",1]],0,"_adptLinesData"]};ClassUtils._temParam=[];ClassUtils._classMap={};var BoundsStyle=function(){function BoundsStyle(){_classCallCheck(this,BoundsStyle);}_createClass(BoundsStyle,[{key:"reset",value:function reset(){if(this.bounds)this.bounds.recover();if(this.userBounds)this.userBounds.recover();this.bounds=null;this.userBounds=null;this.temBM=null;return this;}},{key:"recover",value:function recover(){Pool.recover("BoundsStyle",this.reset());}}],[{key:"create",value:function create(){return Pool.getItemByClass("BoundsStyle",BoundsStyle);}}]);return BoundsStyle;}();var CacheStyle=function(){function CacheStyle(){_classCallCheck(this,CacheStyle);this.reset();}_createClass(CacheStyle,[{key:"needBitmapCache",value:function needBitmapCache(){return this.cacheForFilters||!!this.mask;}},{key:"needEnableCanvasRender",value:function needEnableCanvasRender(){return this.userSetCache!="none"||this.cacheForFilters||!!this.mask;}},{key:"releaseContext",value:function releaseContext(){if(this.canvas&&this.canvas.size){Pool.recover("CacheCanvas",this.canvas);this.canvas.size(0,0);try{this.canvas.width=0;this.canvas.height=0;}catch(e){}}this.canvas=null;}},{key:"createContext",value:function createContext(){if(!this.canvas){this.canvas=Pool.getItem("CacheCanvas")||new HTMLCanvas(false);var tx=this.canvas.context;if(!tx){tx=this.canvas.getContext('2d');}}}},{key:"releaseFilterCache",value:function releaseFilterCache(){var fc=this.filterCache;if(fc){fc.destroy();fc.recycle();this.filterCache=null;}}},{key:"recover",value:function recover(){if(this===CacheStyle.EMPTY)return;Pool.recover("SpriteCache",this.reset());}},{key:"reset",value:function reset(){this.releaseContext();this.releaseFilterCache();this.cacheAs="none";this.enableCanvasRender=false;this.userSetCache="none";this.cacheForFilters=false;this.staticCache=false;this.reCache=true;this.mask=null;this.maskParent=null;this.filterCache=null;this.filters=null;this.hasGlowFilter=false;if(this.cacheRect)this.cacheRect.recover();this.cacheRect=null;return this;}},{key:"_calculateCacheRect",value:function _calculateCacheRect(sprite,tCacheType,x,y){var _cacheStyle=sprite._cacheStyle;if(!_cacheStyle.cacheRect)_cacheStyle.cacheRect=Rectangle.create();var tRec;if(tCacheType==="bitmap"){tRec=sprite.getSelfBounds();tRec.width=tRec.width+CacheStyle.CANVAS_EXTEND_EDGE*2;tRec.height=tRec.height+CacheStyle.CANVAS_EXTEND_EDGE*2;tRec.x=tRec.x-sprite.pivotX;tRec.y=tRec.y-sprite.pivotY;tRec.x=tRec.x-CacheStyle.CANVAS_EXTEND_EDGE;tRec.y=tRec.y-CacheStyle.CANVAS_EXTEND_EDGE;tRec.x=Math.floor(tRec.x+x)-x;tRec.y=Math.floor(tRec.y+y)-y;tRec.width=Math.floor(tRec.width);tRec.height=Math.floor(tRec.height);_cacheStyle.cacheRect.copyFrom(tRec);}else{_cacheStyle.cacheRect.setTo(-sprite._style.pivotX,-sprite._style.pivotY,1,1);}tRec=_cacheStyle.cacheRect;if(sprite._style.scrollRect){var scrollRect=sprite._style.scrollRect;tRec.x-=scrollRect.x;tRec.y-=scrollRect.y;}CacheStyle._scaleInfo.setTo(1,1);return CacheStyle._scaleInfo;}}],[{key:"create",value:function create(){return Pool.getItemByClass("SpriteCache",CacheStyle);}}]);return CacheStyle;}();CacheStyle.EMPTY=new CacheStyle();CacheStyle._scaleInfo=new Point();CacheStyle.CANVAS_EXTEND_EDGE=16;var SpriteStyle=function(){function SpriteStyle(){_classCallCheck(this,SpriteStyle);this.reset();}_createClass(SpriteStyle,[{key:"reset",value:function reset(){this.scaleX=this.scaleY=1;this.skewX=this.skewY=0;this.pivotX=this.pivotY=this.rotation=0;this.alpha=1;if(this.scrollRect)this.scrollRect.recover();this.scrollRect=null;if(this.viewport)this.viewport.recover();this.viewport=null;this.hitArea=null;this.dragging=null;this.blendMode=null;return this;}},{key:"recover",value:function recover(){if(this===SpriteStyle.EMPTY)return;Pool.recover("SpriteStyle",this.reset());}}],[{key:"create",value:function create(){return Pool.getItemByClass("SpriteStyle",SpriteStyle);}}]);return SpriteStyle;}();SpriteStyle.EMPTY=new SpriteStyle();var Node=function(_EventDispatcher3){_inherits(Node,_EventDispatcher3);function Node(){_classCallCheck(this,Node);var _this28=_possibleConstructorReturn(this,(Node.__proto__||Object.getPrototypeOf(Node)).call(this));_this28._bits=0;_this28._children=Node.ARRAY_EMPTY;_this28._extUIChild=Node.ARRAY_EMPTY;_this28._parent=null;_this28.name="";_this28.destroyed=false;_this28.createGLBuffer();return _this28;}_createClass(Node,[{key:"createGLBuffer",value:function createGLBuffer(){}},{key:"_setBit",value:function _setBit(type,value){if(type===Const.DISPLAY){var preValue=this._getBit(type);if(preValue!=value)this._updateDisplayedInstage();}if(value)this._bits|=type;else this._bits&=~type;}},{key:"_getBit",value:function _getBit(type){return(this._bits&type)!=0;}},{key:"_setUpNoticeChain",value:function _setUpNoticeChain(){if(this._getBit(Const.DISPLAY))this._setBitUp(Const.DISPLAY);}},{key:"_setBitUp",value:function _setBitUp(type){var ele=this;ele._setBit(type,true);ele=ele._parent;while(ele){if(ele._getBit(type))return;ele._setBit(type,true);ele=ele._parent;}}},{key:"on",value:function on(type,caller,listener){var args=arguments.length>3&&arguments[3]!==undefined?arguments[3]:null;if(type===Event.DISPLAY||type===Event.UNDISPLAY){if(!this._getBit(Const.DISPLAY))this._setBitUp(Const.DISPLAY);}return this._createListener(type,caller,listener,args,false);}},{key:"once",value:function once(type,caller,listener){var args=arguments.length>3&&arguments[3]!==undefined?arguments[3]:null;if(type===Event.DISPLAY||type===Event.UNDISPLAY){if(!this._getBit(Const.DISPLAY))this._setBitUp(Const.DISPLAY);}return this._createListener(type,caller,listener,args,true);}},{key:"destroy",value:function destroy(){var destroyChild=arguments.length>0&&arguments[0]!==undefined?arguments[0]:true;this.destroyed=true;this._destroyAllComponent();this._parent&&this._parent.removeChild(this);if(this._children){if(destroyChild)this.destroyChildren();else this.removeChildren();}this.onDestroy();this._children=null;this.offAll();}},{key:"onDestroy",value:function onDestroy(){}},{key:"destroyChildren",value:function destroyChildren(){if(this._children){for(var i=0,n=this._children.length;i<n;i++){this._children[0].destroy(true);}}}},{key:"addChild",value:function addChild(node){if(!node||this.destroyed||node===this)return node;if(node._zOrder)this._setBit(Const.HAS_ZORDER,true);if(node._parent===this){var index=this.getChildIndex(node);if(index!==this._children.length-1){this._children.splice(index,1);this._children.push(node);this._childChanged();}}else{node._parent&&node._parent.removeChild(node);this._children===Node.ARRAY_EMPTY&&(this._children=[]);this._children.push(node);node._setParent(this);this._childChanged();}return node;}},{key:"addInputChild",value:function addInputChild(node){if(this._extUIChild==Node.ARRAY_EMPTY){this._extUIChild=[node];}else{if(this._extUIChild.indexOf(node)>=0){return null;}this._extUIChild.push(node);}return null;}},{key:"removeInputChild",value:function removeInputChild(node){var idx=this._extUIChild.indexOf(node);if(idx>=0){this._extUIChild.splice(idx,1);}}},{key:"addChildren",value:function addChildren(){var i=0,n=arguments.length;while(i<n){var _ref;this.addChild((_ref=i++,arguments.length<=_ref?undefined:arguments[_ref]));}}},{key:"addChildAt",value:function addChildAt(node,index){if(!node||this.destroyed||node===this)return node;if(node._zOrder)this._setBit(Const.HAS_ZORDER,true);if(index>=0&&index<=this._children.length){if(node._parent===this){var oldIndex=this.getChildIndex(node);this._children.splice(oldIndex,1);this._children.splice(index,0,node);this._childChanged();}else{node._parent&&node._parent.removeChild(node);this._children===Node.ARRAY_EMPTY&&(this._children=[]);this._children.splice(index,0,node);node._setParent(this);}return node;}else{throw new Error("appendChildAt:The index is out of bounds");}}},{key:"getChildIndex",value:function getChildIndex(node){return this._children.indexOf(node);}},{key:"getChildByName",value:function getChildByName(name){var nodes=this._children;if(nodes){for(var i=0,n=nodes.length;i<n;i++){var node=nodes[i];if(node.name===name)return node;}}return null;}},{key:"getChildAt",value:function getChildAt(index){return this._children[index]||null;}},{key:"setChildIndex",value:function setChildIndex(node,index){var childs=this._children;if(index<0||index>=childs.length){throw new Error("setChildIndex:The index is out of bounds.");}var oldIndex=this.getChildIndex(node);if(oldIndex<0)throw new Error("setChildIndex:node is must child of this object.");childs.splice(oldIndex,1);childs.splice(index,0,node);this._childChanged();return node;}},{key:"_childChanged",value:function _childChanged(){var child=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;}},{key:"removeChild",value:function removeChild(node){//console.log("removeChild ",node)
if(!this._children)return node;var index=this._children.indexOf(node);return this.removeChildAt(index);}},{key:"removeSelf",value:function removeSelf(){this._parent&&this._parent.removeChild(this);return this;}},{key:"removeChildByName",value:function removeChildByName(name){var node=this.getChildByName(name);node&&this.removeChild(node);return node;}},{key:"removeChildAt",value:function removeChildAt(index){var node=this.getChildAt(index);if(node){this._children.splice(index,1);node._setParent(null);}return node;}},{key:"removeChildren",value:function removeChildren(){var beginIndex=arguments.length>0&&arguments[0]!==undefined?arguments[0]:0;var endIndex=arguments.length>1&&arguments[1]!==undefined?arguments[1]:0x7fffffff;if(this._children&&this._children.length>0){var childs=this._children;if(beginIndex===0&&endIndex>=childs.length-1){var arr=childs;this._children=Node.ARRAY_EMPTY;}else{arr=childs.splice(beginIndex,endIndex-beginIndex);}for(var i=0,n=arr.length;i<n;i++){arr[i]._setParent(null);}}return this;}},{key:"replaceChild",value:function replaceChild(newNode,oldNode){var index=this._children.indexOf(oldNode);if(index>-1){this._children.splice(index,1,newNode);oldNode._setParent(null);newNode._setParent(this);return newNode;}return null;}},{key:"_setParent",value:function _setParent(value){if(this._parent!==value){if(value){this._parent=value;this._onAdded();this.event(Event.ADDED);if(this._getBit(Const.DISPLAY)){this._setUpNoticeChain();value.displayedInStage&&this._displayChild(this,true);}value._childChanged(this);}else{this._onRemoved();this.event(Event.REMOVED);this._parent._childChanged();if(this._getBit(Const.DISPLAY))this._displayChild(this,false);this._parent=value;}}}},{key:"_updateDisplayedInstage",value:function _updateDisplayedInstage(){var ele;ele=this;var stage=ILaya.stage;var displayedInStage=false;while(ele){if(ele._getBit(Const.DISPLAY)){displayedInStage=ele._getBit(Const.DISPLAYED_INSTAGE);break;}if(ele===stage||ele._getBit(Const.DISPLAYED_INSTAGE)){displayedInStage=true;break;}ele=ele._parent;}this._setBit(Const.DISPLAYED_INSTAGE,displayedInStage);}},{key:"_setDisplay",value:function _setDisplay(value){if(this._getBit(Const.DISPLAYED_INSTAGE)!==value){this._setBit(Const.DISPLAYED_INSTAGE,value);if(value)this.event(Event.DISPLAY);else this.event(Event.UNDISPLAY);}}},{key:"_displayChild",value:function _displayChild(node,display){var childs=node._children;if(childs){for(var i=0,n=childs.length;i<n;i++){var child=childs[i];if(!child){console.log(i,this,childs,child);}if(!child._getBit(Const.DISPLAY))continue;if(child._children.length>0){this._displayChild(child,display);}else{child._setDisplay(display);}}}node._setDisplay(display);}},{key:"contains",value:function contains(node){if(node===this)return true;while(node){if(node._parent===this)return true;node=node._parent;}return false;}},{key:"timerLoop",value:function timerLoop(delay,caller,method){var args=arguments.length>3&&arguments[3]!==undefined?arguments[3]:null;var coverBefore=arguments.length>4&&arguments[4]!==undefined?arguments[4]:true;var jumpFrame=arguments.length>5&&arguments[5]!==undefined?arguments[5]:false;var timer=this.scene?this.scene.timer:ILaya.timer;timer.loop(delay,caller,method,args,coverBefore,jumpFrame);}},{key:"timerOnce",value:function timerOnce(delay,caller,method){var args=arguments.length>3&&arguments[3]!==undefined?arguments[3]:null;var coverBefore=arguments.length>4&&arguments[4]!==undefined?arguments[4]:true;var timer=this.scene?this.scene.timer:ILaya.timer;timer._create(false,false,delay,caller,method,args,coverBefore);}},{key:"frameLoop",value:function frameLoop(delay,caller,method){var args=arguments.length>3&&arguments[3]!==undefined?arguments[3]:null;var coverBefore=arguments.length>4&&arguments[4]!==undefined?arguments[4]:true;var timer=this.scene?this.scene.timer:ILaya.timer;timer._create(true,true,delay,caller,method,args,coverBefore);}},{key:"frameOnce",value:function frameOnce(delay,caller,method){var args=arguments.length>3&&arguments[3]!==undefined?arguments[3]:null;var coverBefore=arguments.length>4&&arguments[4]!==undefined?arguments[4]:true;var timer=this.scene?this.scene.timer:ILaya.timer;timer._create(true,false,delay,caller,method,args,coverBefore);}},{key:"clearTimer",value:function clearTimer(caller,method){var timer=this.scene?this.scene.timer:ILaya.timer;timer.clear(caller,method);}},{key:"callLater",value:function callLater(method){var args=arguments.length>1&&arguments[1]!==undefined?arguments[1]:null;var timer=this.scene?this.scene.timer:ILaya.timer;timer.callLater(this,method,args);}},{key:"runCallLater",value:function runCallLater(method){var timer=this.scene?this.scene.timer:ILaya.timer;timer.runCallLater(this,method);}},{key:"_onActive",value:function _onActive(){Stat.spriteCount++;}},{key:"_onInActive",value:function _onInActive(){Stat.spriteCount--;}},{key:"_onActiveInScene",value:function _onActiveInScene(){}},{key:"_onInActiveInScene",value:function _onInActiveInScene(){}},{key:"_parse",value:function _parse(data,spriteMap){}},{key:"_setBelongScene",value:function _setBelongScene(scene){if(!this._scene){this._scene=scene;this._onActiveInScene();for(var i=0,n=this._children.length;i<n;i++){this._children[i]._setBelongScene(scene);}}}},{key:"_setUnBelongScene",value:function _setUnBelongScene(){if(this._scene!==this){this._onInActiveInScene();this._scene=null;for(var i=0,n=this._children.length;i<n;i++){this._children[i]._setUnBelongScene();}}}},{key:"onAwake",value:function onAwake(){}},{key:"onEnable",value:function onEnable(){}},{key:"_processActive",value:function _processActive(){this._activeChangeScripts||(this._activeChangeScripts=[]);this._activeHierarchy(this._activeChangeScripts);this._activeScripts();}},{key:"_activeHierarchy",value:function _activeHierarchy(activeChangeScripts){this._setBit(Const.ACTIVE_INHIERARCHY,true);if(this._components){for(var i=0,n=this._components.length;i<n;i++){var comp=this._components[i];comp._setActive(true);comp._isScript()&&comp._enabled&&activeChangeScripts.push(comp);}}this._onActive();for(i=0,n=this._children.length;i<n;i++){var child=this._children[i];!child._getBit(Const.NOT_ACTIVE)&&child._activeHierarchy(activeChangeScripts);}if(!this._getBit(Const.AWAKED)){this._setBit(Const.AWAKED,true);this.onAwake();}this.onEnable();}},{key:"_activeScripts",value:function _activeScripts(){for(var i=0,n=this._activeChangeScripts.length;i<n;i++){this._activeChangeScripts[i].onEnable();}this._activeChangeScripts.length=0;}},{key:"_processInActive",value:function _processInActive(){this._activeChangeScripts||(this._activeChangeScripts=[]);this._inActiveHierarchy(this._activeChangeScripts);this._inActiveScripts();}},{key:"_inActiveHierarchy",value:function _inActiveHierarchy(activeChangeScripts){this._onInActive();if(this._components){for(var i=0,n=this._components.length;i<n;i++){var comp=this._components[i];comp._setActive(false);comp._isScript()&&comp._enabled&&activeChangeScripts.push(comp);}}this._setBit(Const.ACTIVE_INHIERARCHY,false);for(i=0,n=this._children.length;i<n;i++){var child=this._children[i];child&&!child._getBit(Const.NOT_ACTIVE)&&child._inActiveHierarchy(activeChangeScripts);}this.onDisable();}},{key:"_inActiveScripts",value:function _inActiveScripts(){for(var i=0,n=this._activeChangeScripts.length;i<n;i++){this._activeChangeScripts[i].onDisable();}this._activeChangeScripts.length=0;}},{key:"onDisable",value:function onDisable(){}},{key:"_onAdded",value:function _onAdded(){if(this._activeChangeScripts&&this._activeChangeScripts.length!==0){throw"Node: can't set the main inActive node active in hierarchy,if the operate is in main inActive node or it's children script's onDisable Event.";}else{var parentScene=this._parent.scene;parentScene&&this._setBelongScene(parentScene);this._parent.activeInHierarchy&&this.active&&this._processActive();}}},{key:"_onRemoved",value:function _onRemoved(){if(this._activeChangeScripts&&this._activeChangeScripts.length!==0){throw"Node: can't set the main active node inActive in hierarchy,if the operate is in main active node or it's children script's onEnable Event.";}else{this._parent.activeInHierarchy&&this.active&&this._processInActive();this._parent.scene&&this._setUnBelongScene();}}},{key:"_addComponentInstance",value:function _addComponentInstance(comp){this._components=this._components||[];this._components.push(comp);comp.owner=this;comp._onAdded();if(this.activeInHierarchy)comp._setActive(true);}},{key:"_destroyComponent",value:function _destroyComponent(comp){if(this._components){for(var i=0,n=this._components.length;i<n;i++){var item=this._components[i];if(item===comp){item._destroy();this._components.splice(i,1);break;}}}}},{key:"_destroyAllComponent",value:function _destroyAllComponent(){if(this._components){for(var i=0,n=this._components.length;i<n;i++){var item=this._components[i];item._destroy();}this._components.length=0;}}},{key:"_cloneTo",value:function _cloneTo(destObject,srcRoot,dstRoot){var destNode=destObject;if(this._components){for(var i=0,n=this._components.length;i<n;i++){var destComponent=destNode.addComponent(this._components[i].constructor);this._components[i]._cloneTo(destComponent);}}}},{key:"addComponentIntance",value:function addComponentIntance(component){if(component.owner)throw"Node:the component has belong to other node.";if(component.isSingleton&&this.getComponent(component.constructor))throw"Node:the component is singleton,can't add the second one.";this._addComponentInstance(component);return component;}},{key:"addComponent",value:function addComponent(componentType){var comp=Pool.createByClass(componentType);comp._destroyed=false;if(comp.isSingleton&&this.getComponent(componentType))throw""+componentType+""+""+componentType+"";this._addComponentInstance(comp);return comp;}},{key:"getComponent",value:function getComponent(componentType){if(this._components){for(var i=0,n=this._components.length;i<n;i++){var comp=this._components[i];if(comp instanceof componentType)return comp;}}return null;}},{key:"getComponents",value:function getComponents(componentType){var arr;if(this._components){for(var i=0,n=this._components.length;i<n;i++){var comp=this._components[i];if(comp instanceof componentType){arr=arr||[];arr.push(comp);}}}return arr;}},{key:"numChildren",get:function get(){return this._children.length;}},{key:"parent",get:function get(){return this._parent;}},{key:"displayedInStage",get:function get(){if(this._getBit(Const.DISPLAY))return this._getBit(Const.DISPLAYED_INSTAGE);this._setBitUp(Const.DISPLAY);return this._getBit(Const.DISPLAYED_INSTAGE);}},{key:"scene",get:function get(){return this._scene;}},{key:"active",get:function get(){return!this._getBit(Const.NOT_READY)&&!this._getBit(Const.NOT_ACTIVE);},set:function set(value){value=!!value;if(!this._getBit(Const.NOT_ACTIVE)!==value){if(this._activeChangeScripts&&this._activeChangeScripts.length!==0){if(value)throw"Node: can't set the main inActive node active in hierarchy,if the operate is in main inActive node or it's children script's onDisable Event.";else throw"Node: can't set the main active node inActive in hierarchy,if the operate is in main active node or it's children script's onEnable Event.";}else{this._setBit(Const.NOT_ACTIVE,!value);if(this._parent){if(this._parent.activeInHierarchy){if(value)this._processActive();else this._processInActive();}}}}}},{key:"activeInHierarchy",get:function get(){return this._getBit(Const.ACTIVE_INHIERARCHY);}},{key:"timer",get:function get(){return this.scene?this.scene.timer:ILaya.timer;}}]);return Node;}(EventDispatcher);Node.ARRAY_EMPTY=[];ClassUtils.regClass("laya.display.Node",Node);ClassUtils.regClass("Laya.Node",Node);var Sprite=function(_Node){_inherits(Sprite,_Node);function Sprite(){_classCallCheck(this,Sprite);var _this29=_possibleConstructorReturn(this,(Sprite.__proto__||Object.getPrototypeOf(Sprite)).call(this));_this29._x=0;_this29._y=0;_this29._width=0;_this29._height=0;_this29._visible=true;_this29._mouseState=0;_this29._zOrder=0;_this29._renderType=0;_this29._transform=null;_this29._tfChanged=false;_this29._repaint=SpriteConst.REPAINT_NONE;_this29._texture=null;_this29._style=SpriteStyle.EMPTY;_this29._cacheStyle=CacheStyle.EMPTY;_this29._boundStyle=null;_this29._graphics=null;_this29.mouseThrough=false;_this29.autoSize=false;_this29.hitTestPrior=false;return _this29;}_createClass(Sprite,[{key:"destroy",value:function destroy(){var destroyChild=arguments.length>0&&arguments[0]!==undefined?arguments[0]:true;_get(Sprite.prototype.__proto__||Object.getPrototypeOf(Sprite.prototype),"destroy",this).call(this,destroyChild);this._style&&this._style.recover();this._cacheStyle&&this._cacheStyle.recover();this._boundStyle&&this._boundStyle.recover();this._style=null;this._cacheStyle=null;this._boundStyle=null;this._transform=null;if(this._graphics&&this._graphics.autoDestroy){this._graphics.destroy();}this._graphics=null;this.texture=null;}},{key:"updateZOrder",value:function updateZOrder(){Utils.updateOrder(this._children)&&this.repaint();}},{key:"_getBoundsStyle",value:function _getBoundsStyle(){if(!this._boundStyle)this._boundStyle=BoundsStyle.create();return this._boundStyle;}},{key:"_setCustomRender",value:function _setCustomRender(){}},{key:"_setCacheAs",value:function _setCacheAs(value){}},{key:"_checkCanvasEnable",value:function _checkCanvasEnable(){var tEnable=this._cacheStyle.needEnableCanvasRender();this._getCacheStyle().enableCanvasRender=tEnable;if(tEnable){if(this._cacheStyle.needBitmapCache()){this._cacheStyle.cacheAs="bitmap";}else{this._cacheStyle.cacheAs=this._cacheStyle.userSetCache;}this._cacheStyle.reCache=true;this._renderType|=SpriteConst.CANVAS;}else{this._cacheStyle.cacheAs="none";this._cacheStyle.releaseContext();this._renderType&=~SpriteConst.CANVAS;}this._setCacheAs(this._cacheStyle.cacheAs);this._setRenderType(this._renderType);}},{key:"reCache",value:function reCache(){this._cacheStyle.reCache=true;this._repaint|=SpriteConst.REPAINT_CACHE;}},{key:"getRepaint",value:function getRepaint(){return this._repaint;}},{key:"_setX",value:function _setX(value){this._x=value;}},{key:"_setY",value:function _setY(value){this._y=value;}},{key:"_setWidth",value:function _setWidth(texture,value){}},{key:"_setHeight",value:function _setHeight(texture,value){}},{key:"set_width",value:function set_width(value){if(this._width!==value){this._width=value;this._setWidth(this.texture,value);this._setTranformChange();}}},{key:"get_width",value:function get_width(){if(!this.autoSize)return this._width||(this.texture?this.texture.width:0);if(this.texture)return this.texture.width;if(!this._graphics&&this._children.length===0)return 0;return this.getSelfBounds().width;}},{key:"set_height",value:function set_height(value){if(this._height!==value){this._height=value;this._setHeight(this.texture,value);this._setTranformChange();}}},{key:"get_height",value:function get_height(){if(!this.autoSize)return this._height||(this.texture?this.texture.height:0);if(this.texture)return this.texture.height;if(!this._graphics&&this._children.length===0)return 0;return this.getSelfBounds().height;}},{key:"setSelfBounds",value:function setSelfBounds(bound){this._getBoundsStyle().userBounds=bound;}},{key:"getBounds",value:function getBounds(){return this._getBoundsStyle().bounds=Rectangle._getWrapRec(this._boundPointsToParent());}},{key:"getSelfBounds",value:function getSelfBounds(){if(this._boundStyle&&this._boundStyle.userBounds)return this._boundStyle.userBounds;if(!this._graphics&&this._children.length===0&&!this._texture)return Rectangle.TEMP.setTo(0,0,this.width,this.height);return this._getBoundsStyle().bounds=Rectangle._getWrapRec(this._getBoundPointsM(false));}},{key:"_boundPointsToParent",value:function _boundPointsToParent(){var ifRotate=arguments.length>0&&arguments[0]!==undefined?arguments[0]:false;var pX=0,pY=0;if(this._style){pX=this.pivotX;pY=this.pivotY;ifRotate=ifRotate||this._style.rotation!==0;if(this._style.scrollRect){pX+=this._style.scrollRect.x;pY+=this._style.scrollRect.y;}}var pList=this._getBoundPointsM(ifRotate);if(!pList||pList.length<1)return pList;if(pList.length!=8){pList=ifRotate?GrahamScan.scanPList(pList):Rectangle._getWrapRec(pList,Rectangle.TEMP)._getBoundPoints();}if(!this.transform){Utils.transPointList(pList,this._x-pX,this._y-pY);return pList;}var tPoint=Point.TEMP;var i,len=pList.length;for(i=0;i<len;i+=2){tPoint.x=pList[i];tPoint.y=pList[i+1];this.toParentPoint(tPoint);pList[i]=tPoint.x;pList[i+1]=tPoint.y;}return pList;}},{key:"getGraphicBounds",value:function getGraphicBounds(){var realSize=arguments.length>0&&arguments[0]!==undefined?arguments[0]:false;if(!this._graphics)return Rectangle.TEMP.setTo(0,0,0,0);return this._graphics.getBounds(realSize);}},{key:"_getBoundPointsM",value:function _getBoundPointsM(){var ifRotate=arguments.length>0&&arguments[0]!==undefined?arguments[0]:false;if(this._boundStyle&&this._boundStyle.userBounds)return this._boundStyle.userBounds._getBoundPoints();if(!this._boundStyle)this._getBoundsStyle();if(!this._boundStyle.temBM)this._boundStyle.temBM=[];if(this._style.scrollRect){var rst=Utils.clearArray(this._boundStyle.temBM);var rec=Rectangle.TEMP;rec.copyFrom(this._style.scrollRect);Utils.concatArray(rst,rec._getBoundPoints());return rst;}var pList;if(this._graphics){pList=this._graphics.getBoundPoints();}else{pList=Utils.clearArray(this._boundStyle.temBM);if(this._texture){rec=Rectangle.TEMP;rec.setTo(0,0,this.width||this._texture.width,this.height||this._texture.height);Utils.concatArray(pList,rec._getBoundPoints());}}var child;var cList;var __childs;__childs=this._children;for(var i=0,n=__childs.length;i<n;i++){child=__childs[i];if(child instanceof Sprite&&child._visible===true){cList=child._boundPointsToParent(ifRotate);if(cList)pList=pList?Utils.concatArray(pList,cList):cList;}}return pList;}},{key:"_getCacheStyle",value:function _getCacheStyle(){this._cacheStyle===CacheStyle.EMPTY&&(this._cacheStyle=CacheStyle.create());return this._cacheStyle;}},{key:"getStyle",value:function getStyle(){this._style===SpriteStyle.EMPTY&&(this._style=SpriteStyle.create());return this._style;}},{key:"setStyle",value:function setStyle(value){this._style=value;}},{key:"_setScaleX",value:function _setScaleX(value){this._style.scaleX=value;}},{key:"_setScaleY",value:function _setScaleY(value){this._style.scaleY=value;}},{key:"set_scaleX",value:function set_scaleX(value){var style=this.getStyle();if(style.scaleX!==value){this._setScaleX(value);this._setTranformChange();}}},{key:"get_scaleX",value:function get_scaleX(){return this._style.scaleX;}},{key:"set_scaleY",value:function set_scaleY(value){var style=this.getStyle();if(style.scaleY!==value){this._setScaleY(value);this._setTranformChange();}}},{key:"get_scaleY",value:function get_scaleY(){return this._style.scaleY;}},{key:"_setRotation",value:function _setRotation(value){this._style.rotation=value;}},{key:"_setSkewX",value:function _setSkewX(value){this._style.skewX=value;}},{key:"_setSkewY",value:function _setSkewY(value){this._style.skewY=value;}},{key:"_createTransform",value:function _createTransform(){return Matrix.create();}},{key:"_adjustTransform",value:function _adjustTransform(){this._tfChanged=false;var style=this._style;var sx=style.scaleX,sy=style.scaleY;var sskx=style.skewX;var ssky=style.skewY;var rot=style.rotation;var m=this._transform||(this._transform=this._createTransform());if(rot||sx!==1||sy!==1||sskx!==0||ssky!==0){m._bTransform=true;var skx=(rot-sskx)*0.0174532922222222;var sky=(rot+ssky)*0.0174532922222222;var cx=Math.cos(sky);var ssx=Math.sin(sky);var cy=Math.sin(skx);var ssy=Math.cos(skx);m.a=sx*cx;m.b=sx*ssx;m.c=-sy*cy;m.d=sy*ssy;m.tx=m.ty=0;}else{m.identity();this._renderType&=~SpriteConst.TRANSFORM;this._setRenderType(this._renderType);}return m;}},{key:"_setTransform",value:function _setTransform(value){}},{key:"get_transform",value:function get_transform(){return this._tfChanged?this._adjustTransform():this._transform;}},{key:"set_transform",value:function set_transform(value){this._tfChanged=false;var m=this._transform||(this._transform=this._createTransform());value.copyTo(m);this._setTransform(m);if(value){this._x=m.tx;this._y=m.ty;m.tx=m.ty=0;}if(value)this._renderType|=SpriteConst.TRANSFORM;else{this._renderType&=~SpriteConst.TRANSFORM;}this._setRenderType(this._renderType);this.parentRepaint();}},{key:"_setPivotX",value:function _setPivotX(value){var style=this.getStyle();style.pivotX=value;}},{key:"_getPivotX",value:function _getPivotX(){return this._style.pivotX;}},{key:"_setPivotY",value:function _setPivotY(value){var style=this.getStyle();style.pivotY=value;}},{key:"_getPivotY",value:function _getPivotY(){return this._style.pivotY;}},{key:"_setAlpha",value:function _setAlpha(value){if(this._style.alpha!==value){var style=this.getStyle();style.alpha=value;if(value!==1)this._renderType|=SpriteConst.ALPHA;else this._renderType&=~SpriteConst.ALPHA;this._setRenderType(this._renderType);this.parentRepaint();}}},{key:"_getAlpha",value:function _getAlpha(){return this._style.alpha;}},{key:"get_visible",value:function get_visible(){return this._visible;}},{key:"set_visible",value:function set_visible(value){if(this._visible!==value){this._visible=value;this.parentRepaint(SpriteConst.REPAINT_ALL);}}},{key:"_setBlendMode",value:function _setBlendMode(value){}},{key:"_setGraphics",value:function _setGraphics(value){}},{key:"_setGraphicsCallBack",value:function _setGraphicsCallBack(){}},{key:"_setScrollRect",value:function _setScrollRect(value){}},{key:"pos",value:function pos(x,y){var speedMode=arguments.length>2&&arguments[2]!==undefined?arguments[2]:false;if(this._x!==x||this._y!==y){if(this.destroyed)return this;if(speedMode){this._setX(x);this._setY(y);this.parentRepaint(SpriteConst.REPAINT_CACHE);var p=this._cacheStyle.maskParent;if(p){p.repaint(SpriteConst.REPAINT_CACHE);}}else{this.x=x;this.y=y;}}return this;}},{key:"pivot",value:function pivot(x,y){this.pivotX=x;this.pivotY=y;return this;}},{key:"size",value:function size(width,height){this.width=width;this.height=height;return this;}},{key:"scale",value:function scale(scaleX,scaleY){var speedMode=arguments.length>2&&arguments[2]!==undefined?arguments[2]:false;var style=this.getStyle();if(style.scaleX!=scaleX||style.scaleY!=scaleY){if(this.destroyed)return this;if(speedMode){this._setScaleX(scaleX);this._setScaleY(scaleY);this._setTranformChange();}else{this.scaleX=scaleX;this.scaleY=scaleY;}}return this;}},{key:"skew",value:function skew(skewX,skewY){this.skewX=skewX;this.skewY=skewY;return this;}},{key:"render",value:function render(ctx,x,y){RenderSprite.renders[this._renderType]._fun(this,ctx,x+this._x,y+this._y);this._repaint=0;}},{key:"drawToCanvas",value:function drawToCanvas(canvasWidth,canvasHeight,offsetX,offsetY){return Sprite.drawToCanvas(this,this._renderType,canvasWidth,canvasHeight,offsetX,offsetY);}},{key:"drawToTexture",value:function drawToTexture(canvasWidth,canvasHeight,offsetX,offsetY){var rt=arguments.length>4&&arguments[4]!==undefined?arguments[4]:null;return Sprite.drawToTexture(this,this._renderType,canvasWidth,canvasHeight,offsetX,offsetY,rt);}},{key:"drawToTexture3D",value:function drawToTexture3D(offx,offy,tex){throw'not implement';}},{key:"customRender",value:function customRender(context,x,y){this._repaint=SpriteConst.REPAINT_ALL;}},{key:"_applyFilters",value:function _applyFilters(){}},{key:"_setColorFilter",value:function _setColorFilter(value){}},{key:"_isHaveGlowFilter",value:function _isHaveGlowFilter(){var i,len;if(this.filters){for(i=0;i<this.filters.length;i++){if(this.filters[i].type==Filter.GLOW){return true;}}}for(i=0,len=this._children.length;i<len;i++){if(this._children[i]._isHaveGlowFilter()){return true;}}return false;}},{key:"localToGlobal",value:function localToGlobal(point){var createNewPoint=arguments.length>1&&arguments[1]!==undefined?arguments[1]:false;var globalNode=arguments.length>2&&arguments[2]!==undefined?arguments[2]:null;if(createNewPoint===true){point=new Point(point.x,point.y);}var ele=this;globalNode=globalNode||ILaya.stage;while(ele&&!ele.destroyed){if(ele==globalNode)break;point=ele.toParentPoint(point);ele=ele.parent;}return point;}},{key:"globalToLocal",value:function globalToLocal(point){var createNewPoint=arguments.length>1&&arguments[1]!==undefined?arguments[1]:false;var globalNode=arguments.length>2&&arguments[2]!==undefined?arguments[2]:null;if(createNewPoint){point=new Point(point.x,point.y);}var ele=this;var list=[];globalNode=globalNode||ILaya.stage;while(ele&&!ele.destroyed){if(ele==globalNode)break;list.push(ele);ele=ele.parent;}var i=list.length-1;while(i>=0){ele=list[i];point=ele.fromParentPoint(point);i--;}return point;}},{key:"toParentPoint",value:function toParentPoint(point){if(!point)return point;point.x-=this.pivotX;point.y-=this.pivotY;if(this.transform){this._transform.transformPoint(point);}point.x+=this._x;point.y+=this._y;var scroll=this._style.scrollRect;if(scroll){point.x-=scroll.x;point.y-=scroll.y;}return point;}},{key:"fromParentPoint",value:function fromParentPoint(point){if(!point)return point;point.x-=this._x;point.y-=this._y;var scroll=this._style.scrollRect;if(scroll){point.x+=scroll.x;point.y+=scroll.y;}if(this.transform){this._transform.invertTransformPoint(point);}point.x+=this.pivotX;point.y+=this.pivotY;return point;}},{key:"fromStagePoint",value:function fromStagePoint(point){return point;}},{key:"on",value:function on(type,caller,listener){var args=arguments.length>3&&arguments[3]!==undefined?arguments[3]:null;if(this._mouseState!==1&&this.isMouseEvent(type)){this.mouseEnabled=true;this._setBit(Const.HAS_MOUSE,true);if(this._parent){this._onDisplay();}return this._createListener(type,caller,listener,args,false);}return _get(Sprite.prototype.__proto__||Object.getPrototypeOf(Sprite.prototype),"on",this).call(this,type,caller,listener,args);}},{key:"once",value:function once(type,caller,listener){var args=arguments.length>3&&arguments[3]!==undefined?arguments[3]:null;if(this._mouseState!==1&&this.isMouseEvent(type)){this.mouseEnabled=true;this._setBit(Const.HAS_MOUSE,true);if(this._parent){this._onDisplay();}return this._createListener(type,caller,listener,args,true);}return _get(Sprite.prototype.__proto__||Object.getPrototypeOf(Sprite.prototype),"once",this).call(this,type,caller,listener,args);}},{key:"_onDisplay",value:function _onDisplay(v){if(this._mouseState!==1){var ele=this;ele=ele.parent;while(ele&&ele._mouseState!==1){if(ele._getBit(Const.HAS_MOUSE))break;ele.mouseEnabled=true;ele._setBit(Const.HAS_MOUSE,true);ele=ele.parent;}}}},{key:"_setParent",value:function _setParent(value){_get(Sprite.prototype.__proto__||Object.getPrototypeOf(Sprite.prototype),"_setParent",this).call(this,value);if(value&&this._getBit(Const.HAS_MOUSE)){this._onDisplay();}}},{key:"loadImage",value:function loadImage(url){var complete=arguments.length>1&&arguments[1]!==undefined?arguments[1]:null;if(!url){this.texture=null;loaded.call(this);}else{var tex=ILaya.Loader.textureMap[URL.formatURL(url)];if(!tex){tex=new Texture();tex.load(url);ILaya.Loader.cacheTexture(url,tex);}this.texture=tex;if(!tex.getIsReady())tex.once(Event.READY,this,loaded);else loaded.call(this);}function loaded(){this.repaint(SpriteConst.REPAINT_ALL);complete&&complete.run();}return this;}},{key:"repaint",value:function repaint(){var type=arguments.length>0&&arguments[0]!==undefined?arguments[0]:SpriteConst.REPAINT_CACHE;if(!(this._repaint&type)){this._repaint|=type;this.parentRepaint(type);}if(this._cacheStyle&&this._cacheStyle.maskParent){this._cacheStyle.maskParent.repaint(type);}}},{key:"_needRepaint",value:function _needRepaint(){return this._repaint&SpriteConst.REPAINT_CACHE&&this._cacheStyle.enableCanvasRender&&this._cacheStyle.reCache;}},{key:"_childChanged",value:function _childChanged(){var child=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;if(this._children.length)this._renderType|=SpriteConst.CHILDS;else this._renderType&=~SpriteConst.CHILDS;this._setRenderType(this._renderType);if(child&&this._getBit(Const.HAS_ZORDER))ILaya.systemTimer.callLater(this,this.updateZOrder);this.repaint(SpriteConst.REPAINT_ALL);}},{key:"parentRepaint",value:function parentRepaint(){var type=arguments.length>0&&arguments[0]!==undefined?arguments[0]:SpriteConst.REPAINT_CACHE;var p=this._parent;if(p&&!(p._repaint&type)){p._repaint|=type;p.parentRepaint(type);}}},{key:"_setMask",value:function _setMask(value){}},{key:"startDrag",value:function startDrag(){var area=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;var hasInertia=arguments.length>1&&arguments[1]!==undefined?arguments[1]:false;var elasticDistance=arguments.length>2&&arguments[2]!==undefined?arguments[2]:0;var elasticBackTime=arguments.length>3&&arguments[3]!==undefined?arguments[3]:300;var data=arguments.length>4&&arguments[4]!==undefined?arguments[4]:null;var disableMouseEvent=arguments.length>5&&arguments[5]!==undefined?arguments[5]:false;var ratio=arguments.length>6&&arguments[6]!==undefined?arguments[6]:0.92;this._style.dragging||(this.getStyle().dragging=new ILaya.Dragging());this._style.dragging.start(this,area,hasInertia,elasticDistance,elasticBackTime,data,disableMouseEvent,ratio);}},{key:"stopDrag",value:function stopDrag(){this._style.dragging&&this._style.dragging.stop();}},{key:"_setDisplay",value:function _setDisplay(value){if(!value){if(this._cacheStyle){this._cacheStyle.releaseContext();this._cacheStyle.releaseFilterCache();if(this._cacheStyle.hasGlowFilter){this._cacheStyle.hasGlowFilter=false;}}}_get(Sprite.prototype.__proto__||Object.getPrototypeOf(Sprite.prototype),"_setDisplay",this).call(this,value);}},{key:"hitTestPoint",value:function hitTestPoint(x,y){var point=this.globalToLocal(Point.TEMP.setTo(x,y));x=point.x;y=point.y;var rect=this._style.hitArea?this._style.hitArea:this._width>0&&this._height>0?Rectangle.TEMP.setTo(0,0,this._width,this._height):this.getSelfBounds();return rect.contains(x,y);}},{key:"getMousePoint",value:function getMousePoint(){return this.globalToLocal(Point.TEMP.setTo(ILaya.stage.mouseX,ILaya.stage.mouseY));}},{key:"_setTexture",value:function _setTexture(value){}},{key:"_setRenderType",value:function _setRenderType(type){}},{key:"_setTranformChange",value:function _setTranformChange(){this._tfChanged=true;this._renderType|=SpriteConst.TRANSFORM;this.parentRepaint(SpriteConst.REPAINT_CACHE);}},{key:"_setBgStyleColor",value:function _setBgStyleColor(x,y,width,height,fillColor){}},{key:"_setBorderStyleColor",value:function _setBorderStyleColor(x,y,width,height,fillColor,borderWidth){}},{key:"captureMouseEvent",value:function captureMouseEvent(exclusive){ILaya.MouseManager.instance.setCapture(this,exclusive);}},{key:"releaseMouseEvent",value:function releaseMouseEvent(){ILaya.MouseManager.instance.releaseCapture();}},{key:"customRenderEnable",set:function set(b){if(b){this._renderType|=SpriteConst.CUSTOM;this._setRenderType(this._renderType);this._setCustomRender();}}},{key:"cacheAs",get:function get(){return this._cacheStyle.cacheAs;},set:function set(value){if(value===this._cacheStyle.userSetCache)return;if(this.mask&&value==='normal')return;this._setCacheAs(value);this._getCacheStyle().userSetCache=value;this._checkCanvasEnable();this.repaint();}},{key:"staticCache",get:function get(){return this._cacheStyle.staticCache;},set:function set(value){this._getCacheStyle().staticCache=value;if(!value)this.reCache();}},{key:"x",get:function get(){return this._x;},set:function set(value){if(this.destroyed)return;if(this._x!==value){this._setX(value);this.parentRepaint(SpriteConst.REPAINT_CACHE);var p=this._cacheStyle.maskParent;if(p){p.repaint(SpriteConst.REPAINT_CACHE);}}}},{key:"y",get:function get(){return this._y;},set:function set(value){if(this.destroyed)return;if(this._y!==value){this._setY(value);this.parentRepaint(SpriteConst.REPAINT_CACHE);var p=this._cacheStyle.maskParent;if(p){p.repaint(SpriteConst.REPAINT_CACHE);}}}},{key:"width",get:function get(){return this.get_width();},set:function set(value){this.set_width(value);}},{key:"height",get:function get(){return this.get_height();},set:function set(value){this.set_height(value);}},{key:"displayWidth",get:function get(){return this.width*this.scaleX;}},{key:"displayHeight",get:function get(){return this.height*this.scaleY;}},{key:"scaleX",get:function get(){return this._style.scaleX;},set:function set(value){this.set_scaleX(value);}},{key:"scaleY",get:function get(){return this._style.scaleY;},set:function set(value){this.set_scaleY(value);}},{key:"rotation",get:function get(){return this._style.rotation;},set:function set(value){var style=this.getStyle();if(style.rotation!==value){this._setRotation(value);this._setTranformChange();}}},{key:"skewX",get:function get(){return this._style.skewX;},set:function set(value){var style=this.getStyle();if(style.skewX!==value){this._setSkewX(value);this._setTranformChange();}}},{key:"skewY",get:function get(){return this._style.skewY;},set:function set(value){var style=this.getStyle();if(style.skewY!==value){this._setSkewY(value);this._setTranformChange();}}},{key:"transform",get:function get(){return this._tfChanged?this._adjustTransform():this._transform;},set:function set(value){this.set_transform(value);}},{key:"pivotX",get:function get(){return this._getPivotX();},set:function set(value){this._setPivotX(value);this.repaint();}},{key:"pivotY",get:function get(){return this._getPivotY();},set:function set(value){this._setPivotY(value);this.repaint();}},{key:"alpha",get:function get(){return this._getAlpha();},set:function set(value){value=value<0?0:value>1?1:value;this._setAlpha(value);}},{key:"visible",get:function get(){return this.get_visible();},set:function set(value){this.set_visible(value);}},{key:"blendMode",get:function get(){return this._style.blendMode;},set:function set(value){this._setBlendMode(value);this.getStyle().blendMode=value;if(value&&value!="source-over")this._renderType|=SpriteConst.BLEND;else this._renderType&=~SpriteConst.BLEND;this._setRenderType(this._renderType);this.parentRepaint();}},{key:"graphics",get:function get(){if(!this._graphics){this.graphics=new Graphics();this._graphics.autoDestroy=true;}return this._graphics;},set:function set(value){if(this._graphics)this._graphics._sp=null;this._graphics=value;if(value){this._setGraphics(value);this._renderType|=SpriteConst.GRAPHICS;value._sp=this;}else{this._renderType&=~SpriteConst.GRAPHICS;}this._setRenderType(this._renderType);this.repaint();}},{key:"scrollRect",get:function get(){return this._style.scrollRect;},set:function set(value){this.getStyle().scrollRect=value;this._setScrollRect(value);this.repaint();if(value){this._renderType|=SpriteConst.CLIP;}else{this._renderType&=~SpriteConst.CLIP;}this._setRenderType(this._renderType);}},{key:"filters",get:function get(){return this._cacheStyle.filters;},set:function set(value){value&&value.length===0&&(value=null);if(this._cacheStyle.filters==value)return;this._getCacheStyle().filters=value?value.slice():null;if(value&&value.length){this._setColorFilter(value[0]);this._renderType|=SpriteConst.FILTERS;}else{this._setColorFilter(null);this._renderType&=~SpriteConst.FILTERS;}this._setRenderType(this._renderType);if(value&&value.length>0){if(!this._getBit(Const.DISPLAY))this._setBitUp(Const.DISPLAY);if(!(value.length==1&&value[0]instanceof ColorFilter)){this._getCacheStyle().cacheForFilters=true;this._checkCanvasEnable();}}else{if(this._cacheStyle.cacheForFilters){this._cacheStyle.cacheForFilters=false;this._checkCanvasEnable();}}this._getCacheStyle().hasGlowFilter=this._isHaveGlowFilter();this.repaint();}},{key:"stage",get:function get(){return ILaya.stage;}},{key:"hitArea",get:function get(){return this._style.hitArea;},set:function set(value){this.getStyle().hitArea=value;}},{key:"mask",get:function get(){return this._cacheStyle.mask;},set:function set(value){if(value&&this.mask&&this.mask._cacheStyle.maskParent)return;this._getCacheStyle().mask=value;this._setMask(value);this._checkCanvasEnable();if(value){value._getCacheStyle().maskParent=this;}else{if(this.mask){this.mask._getCacheStyle().maskParent=null;}}this._renderType|=SpriteConst.MASK;this._setRenderType(this._renderType);this.parentRepaint(SpriteConst.REPAINT_ALL);}},{key:"mouseEnabled",get:function get(){return this._mouseState>1;},set:function set(value){this._mouseState=value?2:1;}},{key:"globalScaleX",get:function get(){var scale=1;var ele=this;while(ele){if(ele===ILaya.stage)break;scale*=ele.scaleX;ele=ele.parent;}return scale;}},{key:"globalRotation",get:function get(){var angle=0;var ele=this;while(ele){if(ele===ILaya.stage)break;angle+=ele.rotation;ele=ele.parent;}return angle;}},{key:"globalScaleY",get:function get(){var scale=1;var ele=this;while(ele){if(ele===ILaya.stage)break;scale*=ele.scaleY;ele=ele.parent;}return scale;}},{key:"mouseX",get:function get(){return this.getMousePoint().x;}},{key:"mouseY",get:function get(){return this.getMousePoint().y;}},{key:"zOrder",get:function get(){return this._zOrder;},set:function set(value){if(this._zOrder!=value){this._zOrder=value;if(this._parent){value&&this._parent._setBit(Const.HAS_ZORDER,true);ILaya.systemTimer.callLater(this._parent,this.updateZOrder);}}}},{key:"texture",get:function get(){return this._texture;},set:function set(value){if(typeof value=='string'){this.loadImage(value);}else if(this._texture!=value){this._texture&&this._texture._removeReference();this._texture=value;value&&value._addReference();this._setTexture(value);this._setWidth(this._texture,this.width);this._setHeight(this._texture,this.height);if(value)this._renderType|=SpriteConst.TEXTURE;else this._renderType&=~SpriteConst.TEXTURE;this._setRenderType(this._renderType);this.repaint();}}},{key:"viewport",get:function get(){return this._style.viewport;},set:function set(value){if(typeof value=='string'){var recArr;recArr=value.split(",");if(recArr.length>3){value=new Rectangle(parseFloat(recArr[0]),parseFloat(recArr[1]),parseFloat(recArr[2]),parseFloat(recArr[3]));}}this.getStyle().viewport=value;}},{key:"drawCallOptimize",set:function set(value){this._setBit(Const.DRAWCALL_OPTIMIZE,value);},get:function get(){return this._getBit(Const.DRAWCALL_OPTIMIZE);}}],[{key:"drawToCanvas",value:function drawToCanvas(sprite,_renderType,canvasWidth,canvasHeight,offsetX,offsetY){offsetX-=sprite.x;offsetY-=sprite.y;offsetX|=0;offsetY|=0;canvasWidth|=0;canvasHeight|=0;var ctx=new Context();ctx.size(canvasWidth,canvasHeight);ctx.asBitmap=true;ctx._targets.start();ctx._targets.clear(0,0,0,0);RenderSprite.renders[_renderType]._fun(sprite,ctx,offsetX,offsetY);ctx.flush();ctx._targets.end();ctx._targets.restore();var dt=ctx._targets.getData(0,0,canvasWidth,canvasHeight);ctx.destroy();var imgdata=new ImageData(canvasWidth,canvasHeight);var lineLen=canvasWidth*4;var dst=imgdata.data;var y=canvasHeight-1;var off=y*lineLen;var srcoff=0;for(;y>=0;y--){dst.set(dt.subarray(srcoff,srcoff+lineLen),off);off-=lineLen;srcoff+=lineLen;}var canv=new HTMLCanvas(true);canv.size(canvasWidth,canvasHeight);var ctx2d=canv.getContext('2d');ctx2d.putImageData(imgdata,0,0);return canv;}},{key:"drawToTexture",value:function drawToTexture(sprite,_renderType,canvasWidth,canvasHeight,offsetX,offsetY){var rt=arguments.length>6&&arguments[6]!==undefined?arguments[6]:null;if(!Sprite.drawtocanvCtx){Sprite.drawtocanvCtx=new Context();}offsetX-=sprite.x;offsetY-=sprite.y;offsetX|=0;offsetY|=0;canvasWidth|=0;canvasHeight|=0;var ctx=rt?Sprite.drawtocanvCtx:new Context();ctx.clear();ctx.size(canvasWidth,canvasHeight);if(rt){ctx._targets=rt;}else{ctx.asBitmap=true;}ctx._targets.start();ctx._targets.clear(0,0,0,0);RenderSprite.renders[_renderType]._fun(sprite,ctx,offsetX,offsetY);ctx.flush();ctx._targets.end();ctx._targets.restore();if(!rt){var rtex=new Texture(ctx._targets,Texture.INV_UV);ctx.destroy(true);return rtex;}return rt;}},{key:"fromImage",value:function fromImage(url){return new Sprite().loadImage(url);}}]);return Sprite;}(Node);ClassUtils.regClass("laya.display.Sprite",Sprite);ClassUtils.regClass("Laya.Sprite",Sprite);var TextStyle=function(_SpriteStyle){_inherits(TextStyle,_SpriteStyle);function TextStyle(){_classCallCheck(this,TextStyle);var _this30=_possibleConstructorReturn(this,(TextStyle.__proto__||Object.getPrototypeOf(TextStyle)).apply(this,arguments));_this30.italic=false;return _this30;}_createClass(TextStyle,[{key:"reset",value:function reset(){_get(TextStyle.prototype.__proto__||Object.getPrototypeOf(TextStyle.prototype),"reset",this).call(this);this.italic=false;this.align="left";this.wordWrap=false;this.leading=0;this.padding=[0,0,0,0];this.bgColor=null;this.borderColor=null;this.asPassword=false;this.stroke=0;this.strokeColor="#000000";this.bold=false;this.underline=false;this.underlineColor=null;this.currBitmapFont=null;return this;}},{key:"recover",value:function recover(){if(this===TextStyle.EMPTY)return;Pool.recover("TextStyle",this.reset());}},{key:"render",value:function render(sprite,context,x,y){(this.bgColor||this.borderColor)&&context.drawRect(x,y,sprite.width,sprite.height,this.bgColor,this.borderColor,1);}}],[{key:"create",value:function create(){return Pool.getItemByClass("TextStyle",TextStyle);}}]);return TextStyle;}(SpriteStyle);TextStyle.EMPTY=new TextStyle();var Text=function(_Sprite){_inherits(Text,_Sprite);function Text(){_classCallCheck(this,Text);var _this31=_possibleConstructorReturn(this,(Text.__proto__||Object.getPrototypeOf(Text)).call(this));_this31._textWidth=0;_this31._textHeight=0;_this31._lines=[];_this31._lineWidths=[];_this31._startX=0;_this31._startY=0;_this31._charSize={};_this31._valign="top";_this31._fontSize=Text.defaultFontSize;_this31._font=Text.defaultFont;_this31._color="#000000";_this31._singleCharRender=false;_this31.overflow=Text.VISIBLE;_this31._style=TextStyle.EMPTY;return _this31;}_createClass(Text,[{key:"getStyle",value:function getStyle(){this._style===TextStyle.EMPTY&&(this._style=TextStyle.create());return this._style;}},{key:"_getTextStyle",value:function _getTextStyle(){if(this._style===TextStyle.EMPTY){this._style=TextStyle.create();}return this._style;}},{key:"destroy",value:function destroy(){var destroyChild=arguments.length>0&&arguments[0]!==undefined?arguments[0]:true;_get(Text.prototype.__proto__||Object.getPrototypeOf(Text.prototype),"destroy",this).call(this,destroyChild);this._clipPoint=null;this._lines=null;this._lineWidths=null;this._words&&this._words.forEach(function(w){w.cleanCache();});this._words=null;this._charSize=null;}},{key:"_getBoundPointsM",value:function _getBoundPointsM(){var ifRotate=arguments.length>0&&arguments[0]!==undefined?arguments[0]:false;var rec=Rectangle.TEMP;rec.setTo(0,0,this.width,this.height);return rec._getBoundPoints();}},{key:"getGraphicBounds",value:function getGraphicBounds(){var realSize=arguments.length>0&&arguments[0]!==undefined?arguments[0]:false;var rec=Rectangle.TEMP;rec.setTo(0,0,this.width,this.height);return rec;}},{key:"_getCSSStyle",value:function _getCSSStyle(){return this._style;}},{key:"get_text",value:function get_text(){return this._text||"";}},{key:"set_text",value:function set_text(value){if(this._text!==value){this.lang(value+"");this.isChanged=true;this.event(Event.CHANGE);if(this.borderColor){this._setBorderStyleColor(0,0,this.width,this.height,this.borderColor,1);}}}},{key:"lang",value:function lang(text){var arg1=arguments.length>1&&arguments[1]!==undefined?arguments[1]:null;var arg2=arguments.length>2&&arguments[2]!==undefined?arguments[2]:null;var arg3=arguments.length>3&&arguments[3]!==undefined?arguments[3]:null;var arg4=arguments.length>4&&arguments[4]!==undefined?arguments[4]:null;var arg5=arguments.length>5&&arguments[5]!==undefined?arguments[5]:null;var arg6=arguments.length>6&&arguments[6]!==undefined?arguments[6]:null;var arg7=arguments.length>7&&arguments[7]!==undefined?arguments[7]:null;var arg8=arguments.length>8&&arguments[8]!==undefined?arguments[8]:null;var arg9=arguments.length>9&&arguments[9]!==undefined?arguments[9]:null;var arg10=arguments.length>10&&arguments[10]!==undefined?arguments[10]:null;text=Text.langPacks&&Text.langPacks[text]?Text.langPacks[text]:text;if(arguments.length<2){this._text=text;}else{for(var i=0,n=arguments.length;i<n;i++){text=text.replace("{"+i+"}",arguments[i+1]);}this._text=text;}}},{key:"get_color",value:function get_color(){return this._color;}},{key:"set_color",value:function set_color(value){if(this._color!=value){this._color=value;if(!this._isChanged&&this._graphics){this._graphics.replaceTextColor(this.color);}else{this.isChanged=true;}}}},{key:"set_bgColor",value:function set_bgColor(value){this._getTextStyle().bgColor=value;this._renderType|=SpriteConst.STYLE;this._setBgStyleColor(0,0,this.width,this.height,value);this._setRenderType(this._renderType);this.isChanged=true;}},{key:"get_bgColor",value:function get_bgColor(){return this._style.bgColor;}},{key:"_getContextFont",value:function _getContextFont(){return(this.italic?"italic ":"")+(this.bold?"bold ":"")+this.fontSize+"px "+(ILaya.Browser.onIPhone?Text.fontFamilyMap[this.font]||this.font:this.font);}},{key:"_isPassWordMode",value:function _isPassWordMode(){var style=this._style;var password=style.asPassword;if("prompt"in this&&this['prompt']==this._text)password=false;return password;}},{key:"_getPassWordTxt",value:function _getPassWordTxt(txt){var len=txt.length;var word;word="";for(var j=len;j>0;j--){word+="";}return word;}},{key:"_renderText",value:function _renderText(){var padding=this.padding;var visibleLineCount=this._lines.length;if(this.overflow!=Text.VISIBLE){visibleLineCount=Math.min(visibleLineCount,Math.floor((this.height-padding[0]-padding[2])/(this.leading+this._charSize.height))+1);}var beginLine=this.scrollY/(this._charSize.height+this.leading)|0;var graphics=this.graphics;graphics.clear(true);var ctxFont=this._getContextFont();ILaya.Browser.context.font=ctxFont;var startX=padding[3];var textAlgin="left";var lines=this._lines;var lineHeight=this.leading+this._charSize.height;var tCurrBitmapFont=this._style.currBitmapFont;if(tCurrBitmapFont){lineHeight=this.leading+tCurrBitmapFont.getMaxHeight();}var startY=padding[0];if(!tCurrBitmapFont&&this._width>0&&this._textWidth<=this._width){if(this.align=="right"){textAlgin="right";startX=this._width-padding[1];}else if(this.align=="center"){textAlgin="center";startX=this._width*0.5+padding[3]-padding[1];}}if(this._height>0){var tempVAlign=this._textHeight>this._height?"top":this.valign;if(tempVAlign==="middle")startY=(this._height-visibleLineCount*lineHeight)*0.5+padding[0]-padding[2];else if(tempVAlign==="bottom")startY=this._height-visibleLineCount*lineHeight-padding[2];}var style=this._style;if(tCurrBitmapFont&&tCurrBitmapFont.autoScaleSize){var bitmapScale=tCurrBitmapFont.fontSize/this.fontSize;}if(this._clipPoint){graphics.save();if(tCurrBitmapFont&&tCurrBitmapFont.autoScaleSize){var tClipWidth;var tClipHeight;this._width?tClipWidth=this._width-padding[3]-padding[1]:tClipWidth=this._textWidth;this._height?tClipHeight=this._height-padding[0]-padding[2]:tClipHeight=this._textHeight;tClipWidth*=bitmapScale;tClipHeight*=bitmapScale;graphics.clipRect(padding[3],padding[0],tClipWidth,tClipHeight);}else{graphics.clipRect(padding[3],padding[0],this._width?this._width-padding[3]-padding[1]:this._textWidth,this._height?this._height-padding[0]-padding[2]:this._textHeight);}this.repaint();}var password=style.asPassword;if("prompt"in this&&this['prompt']==this._text)password=false;var x=0,y=0;var end=Math.min(this._lines.length,visibleLineCount+beginLine)||1;for(var i=beginLine;i<end;i++){var word=lines[i];var _word;if(password){var len=word.length;word="";for(var j=len;j>0;j--){word+="";}}if(word==null)word="";x=startX-(this._clipPoint?this._clipPoint.x:0);y=startY+lineHeight*i-(this._clipPoint?this._clipPoint.y:0);this.underline&&this._drawUnderline(textAlgin,x,y,i);if(tCurrBitmapFont){var tWidth=this.width;if(tCurrBitmapFont.autoScaleSize){tWidth=this.width*bitmapScale;}tCurrBitmapFont._drawText(word,this,x,y,this.align,tWidth);}else{this._words||(this._words=[]);if(this._words.length>i-beginLine){_word=this._words[i-beginLine];}else{_word=new WordText();this._words.push(_word);}_word.setText(word);_word.splitRender=this._singleCharRender;style.stroke?graphics.fillBorderText(_word,x,y,ctxFont,this.color,style.strokeColor,style.stroke,textAlgin):graphics.fillText(_word,x,y,ctxFont,this.color,textAlgin);}}if(tCurrBitmapFont&&tCurrBitmapFont.autoScaleSize){var tScale=1/bitmapScale;this.scale(tScale,tScale);}if(this._clipPoint)graphics.restore();this._startX=startX;this._startY=startY;}},{key:"_drawUnderline",value:function _drawUnderline(align,x,y,lineIndex){var lineWidth=this._lineWidths[lineIndex];switch(align){case'center':x-=lineWidth/2;break;case'right':x-=lineWidth;break;case'left':default:break;}y+=this._charSize.height;this._graphics.drawLine(x,y,x+lineWidth,y,this.underlineColor||this.color,1);}},{key:"typeset",value:function typeset(){this._isChanged=false;if(!this._text){this._clipPoint=null;this._textWidth=this._textHeight=0;this.graphics.clear(true);return;}if(ILaya.Render.isConchApp){window.conchTextCanvas.font=this._getContextFont();}else{ILaya.Browser.context.font=this._getContextFont();}this._lines.length=0;this._lineWidths.length=0;if(this._isPassWordMode()){this._parseLines(this._getPassWordTxt(this._text));}else this._parseLines(this._text);this._evalTextSize();if(this._checkEnabledViewportOrNot())this._clipPoint||(this._clipPoint=new Point(0,0));else this._clipPoint=null;this._renderText();}},{key:"_evalTextSize",value:function _evalTextSize(){var nw,nh;nw=Math.max.apply(this,this._lineWidths);if(this._style.currBitmapFont)nh=this._lines.length*(this._style.currBitmapFont.getMaxHeight()+this.leading)+this.padding[0]+this.padding[2];else nh=this._lines.length*(this._charSize.height+this.leading)+this.padding[0]+this.padding[2];if(nw!=this._textWidth||nh!=this._textHeight){this._textWidth=nw;this._textHeight=nh;}}},{key:"_checkEnabledViewportOrNot",value:function _checkEnabledViewportOrNot(){return this.overflow==Text.SCROLL&&(this._width>0&&this._textWidth>this._width||this._height>0&&this._textHeight>this._height);}},{key:"changeText",value:function changeText(text){if(this._text!==text){this.lang(text+"");if(this._graphics&&this._graphics.replaceText(this._text));else{this.typeset();}}}},{key:"_parseLines",value:function _parseLines(text){var needWordWrapOrTruncate=this.wordWrap||this.overflow==Text.HIDDEN;if(needWordWrapOrTruncate){var wordWrapWidth=this._getWordWrapWidth();}var bitmapFont=this._style.currBitmapFont;if(bitmapFont){this._charSize.width=bitmapFont.getMaxWidth();this._charSize.height=bitmapFont.getMaxHeight();}else{var measureResult=null;if(ILaya.Render.isConchApp){measureResult=window.conchTextCanvas.measureText(Text._testWord);}else{measureResult=ILaya.Browser.context.measureText(Text._testWord);}if(!measureResult)measureResult={width:100};this._charSize.width=measureResult.width;this._charSize.height=measureResult.height||this.fontSize;}var lines=text.replace(/\r\n/g,"\n").split("\n");for(var i=0,n=lines.length;i<n;i++){var line=lines[i];if(needWordWrapOrTruncate)this._parseLine(line,wordWrapWidth);else{this._lineWidths.push(this._getTextWidth(line));this._lines.push(line);}}}},{key:"_parseLine",value:function _parseLine(line,wordWrapWidth){var lines=this._lines;var maybeIndex=0;var charsWidth=0;var wordWidth=0;var startIndex=0;charsWidth=this._getTextWidth(line);if(charsWidth<=wordWrapWidth){lines.push(line);this._lineWidths.push(charsWidth);return;}charsWidth=this._charSize.width;maybeIndex=Math.floor(wordWrapWidth/charsWidth);maybeIndex==0&&(maybeIndex=1);charsWidth=this._getTextWidth(line.substring(0,maybeIndex));wordWidth=charsWidth;for(var j=maybeIndex,m=line.length;j<m;j++){charsWidth=this._getTextWidth(line.charAt(j));wordWidth+=charsWidth;if(wordWidth>wordWrapWidth){if(this.wordWrap){var newLine=line.substring(startIndex,j);if(newLine.charCodeAt(newLine.length-1)<255){var execResult=/(?:\w|-)+$/.exec(newLine);if(execResult){j=execResult.index+startIndex;if(execResult.index==0)j+=newLine.length;else newLine=line.substring(startIndex,j);}}lines.push(newLine);this._lineWidths.push(wordWidth-charsWidth);startIndex=j;if(j+maybeIndex<m){j+=maybeIndex;charsWidth=this._getTextWidth(line.substring(startIndex,j));wordWidth=charsWidth;j--;}else{lines.push(line.substring(startIndex,m));this._lineWidths.push(this._getTextWidth(lines[lines.length-1]));startIndex=-1;break;}}else if(this.overflow==Text.HIDDEN){lines.push(line.substring(0,j));this._lineWidths.push(this._getTextWidth(lines[lines.length-1]));return;}}}if(this.wordWrap&&startIndex!=-1){lines.push(line.substring(startIndex,m));this._lineWidths.push(this._getTextWidth(lines[lines.length-1]));}}},{key:"_getTextWidth",value:function _getTextWidth(text){var bitmapFont=this._style.currBitmapFont;if(bitmapFont)return bitmapFont.getTextWidth(text);else{if(ILaya.Render.isConchApp){return window.conchTextCanvas.measureText(text).width;}else{var ret=ILaya.Browser.context.measureText(text)||{width:100};return ret.width;}}}},{key:"_getWordWrapWidth",value:function _getWordWrapWidth(){var p=this.padding;var w;var bitmapFont=this._style.currBitmapFont;if(bitmapFont&&bitmapFont.autoScaleSize)w=this._width*(bitmapFont.fontSize/this.fontSize);else w=this._width;if(w<=0){w=this.wordWrap?100:ILaya.Browser.width;}w<=0&&(w=100);return w-p[3]-p[1];}},{key:"getCharPoint",value:function getCharPoint(charIndex){var out=arguments.length>1&&arguments[1]!==undefined?arguments[1]:null;this._isChanged&&ILaya.systemTimer.runCallLater(this,this.typeset);var len=0,lines=this._lines,startIndex=0;for(var i=0,n=lines.length;i<n;i++){len+=lines[i].length;if(charIndex<len){var line=i;break;}startIndex=len;}var ctxFont=(this.italic?"italic ":"")+(this.bold?"bold ":"")+this.fontSize+"px "+this.font;ILaya.Browser.context.font=ctxFont;var width=this._getTextWidth(this._text.substring(startIndex,charIndex));var point=out||new Point();return point.setTo(this._startX+width-(this._clipPoint?this._clipPoint.x:0),this._startY+line*(this._charSize.height+this.leading)-(this._clipPoint?this._clipPoint.y:0));}},{key:"width",get:function get(){if(this._width)return this._width;return this.textWidth+this.padding[1]+this.padding[3];},set:function set(value){if(value!=this._width){_get(Text.prototype.__proto__||Object.getPrototypeOf(Text.prototype),"set_width",this).call(this,value);this.isChanged=true;if(this.borderColor){this._setBorderStyleColor(0,0,this.width,this.height,this.borderColor,1);}}}},{key:"height",get:function get(){if(this._height)return this._height;return this.textHeight;},set:function set(value){if(value!=this._height){_get(Text.prototype.__proto__||Object.getPrototypeOf(Text.prototype),"set_height",this).call(this,value);this.isChanged=true;if(this.borderColor){this._setBorderStyleColor(0,0,this.width,this.height,this.borderColor,1);}}}},{key:"textWidth",get:function get(){this._isChanged&&ILaya.systemTimer.runCallLater(this,this.typeset);return this._textWidth;}},{key:"textHeight",get:function get(){this._isChanged&&ILaya.systemTimer.runCallLater(this,this.typeset);return this._textHeight;}},{key:"text",get:function get(){return this._text||"";},set:function set(value){this.set_text(value);}},{key:"font",get:function get(){return this._font;},set:function set(value){if(this._style.currBitmapFont){this._getTextStyle().currBitmapFont=null;this.scale(1,1);}if(Text._bitmapFonts&&Text._bitmapFonts[value]){this._getTextStyle().currBitmapFont=Text._bitmapFonts[value];}this._font=value;this.isChanged=true;}},{key:"fontSize",get:function get(){return this._fontSize;},set:function set(value){if(this._fontSize!=value){this._fontSize=value;this.isChanged=true;}}},{key:"bold",get:function get(){return this._style.bold;},set:function set(value){this._getTextStyle().bold=value;this.isChanged=true;}},{key:"color",get:function get(){return this._color;},set:function set(value){this.set_color(value);}},{key:"italic",get:function get(){return this._style.italic;},set:function set(value){this._getTextStyle().italic=value;this.isChanged=true;}},{key:"align",get:function get(){return this._style.align;},set:function set(value){this._getTextStyle().align=value;this.isChanged=true;}},{key:"valign",get:function get(){return this._valign;},set:function set(value){this._valign=value;this.isChanged=true;}},{key:"wordWrap",get:function get(){return this._style.wordWrap;},set:function set(value){this._getTextStyle().wordWrap=value;this.isChanged=true;}},{key:"leading",get:function get(){return this._style.leading;},set:function set(value){this._getTextStyle().leading=value;this.isChanged=true;}},{key:"padding",get:function get(){return this._style.padding;},set:function set(value){if(typeof value=='string'){var arr;arr=value.split(",");var i,len;len=arr.length;while(arr.length<4){arr.push(0);}for(i=0;i<len;i++){arr[i]=parseFloat(arr[i])||0;}value=arr;}this._getTextStyle().padding=value;this.isChanged=true;}},{key:"bgColor",get:function get(){return this._style.bgColor;},set:function set(value){this.set_bgColor(value);}},{key:"borderColor",get:function get(){return this._style.borderColor;},set:function set(value){this._getTextStyle().borderColor=value;this._renderType|=SpriteConst.STYLE;this._setBorderStyleColor(0,0,this.width,this.height,value,1);this._setRenderType(this._renderType);this.isChanged=true;}},{key:"stroke",get:function get(){return this._style.stroke;},set:function set(value){this._getTextStyle().stroke=value;this.isChanged=true;}},{key:"strokeColor",get:function get(){return this._style.strokeColor;},set:function set(value){this._getTextStyle().strokeColor=value;this.isChanged=true;}},{key:"isChanged",set:function set(value){if(this._isChanged!==value){this._isChanged=value;value&&ILaya.systemTimer.callLater(this,this.typeset);}}},{key:"scrollX",set:function set(value){if(this.overflow!=Text.SCROLL||this.textWidth<this._width||!this._clipPoint)return;value=value<this.padding[3]?this.padding[3]:value;var maxScrollX=this._textWidth-this._width;value=value>maxScrollX?maxScrollX:value;this._clipPoint.x=value;this._renderText();},get:function get(){if(!this._clipPoint)return 0;return this._clipPoint.x;}},{key:"scrollY",set:function set(value){if(this.overflow!=Text.SCROLL||this.textHeight<this._height||!this._clipPoint)return;value=value<this.padding[0]?this.padding[0]:value;var maxScrollY=this._textHeight-this._height;value=value>maxScrollY?maxScrollY:value;this._clipPoint.y=value;this._renderText();},get:function get(){if(!this._clipPoint)return 0;return this._clipPoint.y;}},{key:"maxScrollX",get:function get(){return this.textWidth<this._width?0:this._textWidth-this._width;}},{key:"maxScrollY",get:function get(){return this.textHeight<this._height?0:this._textHeight-this._height;}},{key:"lines",get:function get(){if(this._isChanged)this.typeset();return this._lines;}},{key:"underlineColor",get:function get(){return this._style.underlineColor;},set:function set(value){this._getTextStyle().underlineColor=value;if(!this._isChanged)this._renderText();}},{key:"underline",get:function get(){return this._style.underline;},set:function set(value){this._getTextStyle().underline=value;}},{key:"singleCharRender",set:function set(value){this._singleCharRender=value;},get:function get(){return this._singleCharRender;}}],[{key:"defaultFontStr",value:function defaultFontStr(){return Text.defaultFontSize+"px "+Text.defaultFont;}},{key:"registerBitmapFont",value:function registerBitmapFont(name,bitmapFont){Text._bitmapFonts||(Text._bitmapFonts={});Text._bitmapFonts[name]=bitmapFont;}},{key:"unregisterBitmapFont",value:function unregisterBitmapFont(name){var destroy=arguments.length>1&&arguments[1]!==undefined?arguments[1]:true;if(Text._bitmapFonts&&Text._bitmapFonts[name]){var tBitmapFont=Text._bitmapFonts[name];if(destroy)tBitmapFont.destroy();delete Text._bitmapFonts[name];}}}]);return Text;}(Sprite);Text.VISIBLE="visible";Text.SCROLL="scroll";Text.HIDDEN="hidden";Text.defaultFontSize=12;Text.defaultFont="Arial";Text.isComplexText=false;Text.fontFamilyMap={"":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-"};Text._testWord="";Text.CharacterCache=true;Text.RightToLeft=false;ILaya.regClass(Text);ClassUtils.regClass("laya.display.Text",Text);ClassUtils.regClass("Laya.Text",Text);var Input=function(_Text){_inherits(Input,_Text);function Input(){_classCallCheck(this,Input);var _this32=_possibleConstructorReturn(this,(Input.__proto__||Object.getPrototypeOf(Input)).call(this));_this32._multiline=false;_this32._editable=true;_this32._maxChars=1E5;_this32._type="text";_this32._prompt='';_this32._promptColor="#A9A9A9";_this32._originColor="#000000";_this32._content='';Input.IOS_IFRAME=ILaya.Browser.onIOS&&ILaya.Browser.window.top!=ILaya.Browser.window.self;_this32._width=100;_this32._height=20;_this32.multiline=false;_this32.overflow=Text.SCROLL;_this32.on(Event.MOUSE_DOWN,_this32,_this32._onMouseDown);_this32.on(Event.UNDISPLAY,_this32,_this32._onUnDisplay);return _this32;}_createClass(Input,[{key:"setSelection",value:function setSelection(startIndex,endIndex){this.focus=true;Input.inputElement.selectionStart=startIndex;Input.inputElement.selectionEnd=endIndex;}},{key:"_onUnDisplay",value:function _onUnDisplay(){var e=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;this.focus=false;}},{key:"_onMouseDown",value:function _onMouseDown(e){this.focus=true;}},{key:"_syncInputTransform",value:function _syncInputTransform(){var inputElement=this.nativeInput;var transform=Utils.getTransformRelativeToWindow(this,this.padding[3],this.padding[0]);var inputWid=this._width-this.padding[1]-this.padding[3];var inputHei=this._height-this.padding[0]-this.padding[2];if(ILaya.Render.isConchApp){inputElement.setScale(transform.scaleX,transform.scaleY);inputElement.setSize(inputWid,inputHei);inputElement.setPos(transform.x,transform.y);}else{Input.inputContainer.style.transform=Input.inputContainer.style.webkitTransform="scale("+transform.scaleX+","+transform.scaleY+") rotate("+ILaya.stage.canvasDegree+"deg)";inputElement.style.width=inputWid+'px';inputElement.style.height=inputHei+'px';Input.inputContainer.style.left=transform.x+'px';Input.inputContainer.style.top=transform.y+'px';}}},{key:"select",value:function select(){this.nativeInput.select();}},{key:"_setInputMethod",value:function _setInputMethod(){Input.input.parentElement&&Input.inputContainer.removeChild(Input.input);Input.area.parentElement&&Input.inputContainer.removeChild(Input.area);Input.inputElement=this._multiline?Input.area:Input.input;Input.inputContainer.appendChild(Input.inputElement);if(Text.RightToLeft){Input.inputElement.style.direction="rtl";}}},{key:"_focusIn",value:function _focusIn(){Input.isInputting=true;var input=this.nativeInput;this._focus=true;var cssStyle=input.style;cssStyle.whiteSpace=this.wordWrap?"pre-wrap":"nowrap";this._setPromptColor();input.readOnly=!this._editable;if(ILaya.Render.isConchApp){input.setType(this._type);input.setForbidEdit(!this._editable);}input.maxLength=this._maxChars;var padding=this.padding;input.value=this._content;input.placeholder=this._prompt;ILaya.stage.off(Event.KEY_DOWN,this,this._onKeyDown);ILaya.stage.on(Event.KEY_DOWN,this,this._onKeyDown);ILaya.stage.focus=this;this.event(Event.FOCUS);if(ILaya.Browser.onPC)input.focus();if(!ILaya.Browser.onMiniGame&&!ILaya.Browser.onBDMiniGame&&!ILaya.Browser.onQGMiniGame&&!ILaya.Browser.onKGMiniGame&&!ILaya.Browser.onVVMiniGame&&!ILaya.Browser.onAlipayMiniGame&&!ILaya.Browser.onQQMiniGame){var temp=this._text;this._text=null;}this.typeset();input.setColor(this._originColor);input.setFontSize(this.fontSize);input.setFontFace(ILaya.Browser.onIPhone?Text.fontFamilyMap[this.font]||this.font:this.font);if(ILaya.Render.isConchApp){input.setMultiAble&&input.setMultiAble(this._multiline);}cssStyle.lineHeight=this.leading+this.fontSize+"px";cssStyle.fontStyle=this.italic?"italic":"normal";cssStyle.fontWeight=this.bold?"bold":"normal";cssStyle.textAlign=this.align;cssStyle.padding="0 0";this._syncInputTransform();if(!ILaya.Render.isConchApp&&ILaya.Browser.onPC)ILaya.systemTimer.frameLoop(1,this,this._syncInputTransform);}},{key:"_setPromptColor",value:function _setPromptColor(){Input.promptStyleDOM=ILaya.Browser.getElementById("promptStyle");if(!Input.promptStyleDOM){Input.promptStyleDOM=ILaya.Browser.createElement("style");Input.promptStyleDOM.setAttribute("id","promptStyle");ILaya.Browser.document.head.appendChild(Input.promptStyleDOM);}Input.promptStyleDOM.innerText="input::-webkit-input-placeholder, textarea::-webkit-input-placeholder {"+"color:"+this._promptColor+"}"+"input:-moz-placeholder, textarea:-moz-placeholder {"+"color:"+this._promptColor+"}"+"input::-moz-placeholder, textarea::-moz-placeholder {"+"color:"+this._promptColor+"}"+"input:-ms-input-placeholder, textarea:-ms-input-placeholder {"+"color:"+this._promptColor+"}";}},{key:"_focusOut",value:function _focusOut(){if(!Input.isInputting)return;Input.isInputting=false;this._focus=false;this._text=null;this._content=this.nativeInput.value;if(!this._content){_get(Input.prototype.__proto__||Object.getPrototypeOf(Input.prototype),"set_text",this).call(this,this._prompt);_get(Input.prototype.__proto__||Object.getPrototypeOf(Input.prototype),"set_color",this).call(this,this._promptColor);}else{_get(Input.prototype.__proto__||Object.getPrototypeOf(Input.prototype),"set_text",this).call(this,this._content);_get(Input.prototype.__proto__||Object.getPrototypeOf(Input.prototype),"set_color",this).call(this,this._originColor);}ILaya.stage.off(Event.KEY_DOWN,this,this._onKeyDown);ILaya.stage.focus=null;this.event(Event.BLUR);this.event(Event.CHANGE);if(ILaya.Render.isConchApp)this.nativeInput.blur();ILaya.Browser.onPC&&ILaya.systemTimer.clear(this,this._syncInputTransform);}},{key:"_onKeyDown",value:function _onKeyDown(e){if(e.keyCode===13){if(ILaya.Browser.onMobile&&!this._multiline)this.focus=false;this.event(Event.ENTER);}}},{key:"changeText",value:function changeText(text){this._content=text;if(this._focus){this.nativeInput.value=text||'';this.event(Event.CHANGE);}else _get(Input.prototype.__proto__||Object.getPrototypeOf(Input.prototype),"changeText",this).call(this,text);}},{key:"multiline",get:function get(){return this._multiline;},set:function set(value){this._multiline=value;this.valign=value?"top":"middle";}},{key:"nativeInput",get:function get(){return this._multiline?Input.area:Input.input;}},{key:"focus",get:function get(){return this._focus;},set:function set(value){var input=this.nativeInput;if(this._focus!==value){if(value){if(input.target){input.target._focusOut();}else{this._setInputMethod();}input.target=this;this._focusIn();}else{input.target=null;this._focusOut();ILaya.Browser.document.body.scrollTop=0;input.blur();if(ILaya.Render.isConchApp)input.setPos(-10000,-10000);else if(Input.inputContainer.contains(input))Input.inputContainer.removeChild(input);}}}},{key:"text",set:function set(value){_get(Input.prototype.__proto__||Object.getPrototypeOf(Input.prototype),"set_color",this).call(this,this._originColor);value+='';if(this._focus){this.nativeInput.value=value||'';this.event(Event.CHANGE);}else{if(!this._multiline)value=value.replace(/\r?\n/g,'');this._content=value;if(value)_get(Input.prototype.__proto__||Object.getPrototypeOf(Input.prototype),"set_text",this).call(this,value);else{_get(Input.prototype.__proto__||Object.getPrototypeOf(Input.prototype),"set_text",this).call(this,this._prompt);_get(Input.prototype.__proto__||Object.getPrototypeOf(Input.prototype),"set_color",this).call(this,this.promptColor);}}},get:function get(){if(this._focus)return this.nativeInput.value;else return this._content||"";}},{key:"color",set:function set(value){if(this._focus)this.nativeInput.setColor(value);_get(Input.prototype.__proto__||Object.getPrototypeOf(Input.prototype),"set_color",this).call(this,this._content?value:this._promptColor);this._originColor=value;},get:function get(){return _get(Input.prototype.__proto__||Object.getPrototypeOf(Input.prototype),"color",this);}},{key:"bgColor",set:function set(value){_get(Input.prototype.__proto__||Object.getPrototypeOf(Input.prototype),"set_bgColor",this).call(this,value);if(ILaya.Render.isConchApp)this.nativeInput.setBgColor(value);},get:function get(){return _get(Input.prototype.__proto__||Object.getPrototypeOf(Input.prototype),"bgColor",this);}},{key:"restrict",get:function get(){if(this._restrictPattern){return this._restrictPattern.source;}return"";},set:function set(pattern){if(pattern){pattern="[^"+pattern+"]";if(pattern.indexOf("^^")>-1)pattern=pattern.replace("^^","");this._restrictPattern=new RegExp(pattern,"g");}else this._restrictPattern=null;}},{key:"editable",set:function set(value){this._editable=value;if(ILaya.Render.isConchApp){Input.input.setForbidEdit(!value);}},get:function get(){return this._editable;}},{key:"maxChars",get:function get(){return this._maxChars;},set:function set(value){if(value<=0)value=1E5;this._maxChars=value;}},{key:"prompt",get:function get(){return this._prompt;},set:function set(value){if(!this._text&&value)_get(Input.prototype.__proto__||Object.getPrototypeOf(Input.prototype),"set_color",this).call(this,this._promptColor);this.promptColor=this._promptColor;if(this._text)_get(Input.prototype.__proto__||Object.getPrototypeOf(Input.prototype),"set_text",this).call(this,this._text==this._prompt?value:this._text);else _get(Input.prototype.__proto__||Object.getPrototypeOf(Input.prototype),"set_text",this).call(this,value);this._prompt=Text.langPacks&&Text.langPacks[value]?Text.langPacks[value]:value;}},{key:"promptColor",get:function get(){return this._promptColor;},set:function set(value){this._promptColor=value;if(!this._content)_get(Input.prototype.__proto__||Object.getPrototypeOf(Input.prototype),"set_color",this).call(this,value);}},{key:"type",get:function get(){return this._type;},set:function set(value){if(value==="password")this._getTextStyle().asPassword=true;else this._getTextStyle().asPassword=false;this._type=value;}}],[{key:"__init__",value:function __init__(){Input._createInputElement();if(ILaya.Browser.onMobile){var isTrue=false;if(ILaya.Browser.onMiniGame||ILaya.Browser.onBDMiniGame||ILaya.Browser.onQGMiniGame||ILaya.Browser.onKGMiniGame||ILaya.Browser.onVVMiniGame||ILaya.Browser.onAlipayMiniGame||ILaya.Browser.onQQMiniGame){isTrue=true;}ILaya.Render.canvas.addEventListener(Input.IOS_IFRAME?isTrue?"touchend":"click":"touchend",Input._popupInputMethod);}}},{key:"_popupInputMethod",value:function _popupInputMethod(e){if(!Input.isInputting)return;var input=Input.inputElement;input.focus();}},{key:"_createInputElement",value:function _createInputElement(){Input._initInput(Input.area=ILaya.Browser.createElement("textarea"));Input._initInput(Input.input=ILaya.Browser.createElement("input"));Input.inputContainer=ILaya.Browser.createElement("div");Input.inputContainer.style.position="absolute";Input.inputContainer.style.zIndex=1E5;ILaya.Browser.container.appendChild(Input.inputContainer);Input.inputContainer.setPos=function(x,y){Input.inputContainer.style.left=x+'px';Input.inputContainer.style.top=y+'px';};}},{key:"_initInput",value:function _initInput(input){var style=input.style;style.cssText="position:absolute;overflow:hidden;resize:none;transform-origin:0 0;-webkit-transform-origin:0 0;-moz-transform-origin:0 0;-o-transform-origin:0 0;";style.resize='none';style.backgroundColor='transparent';style.border='none';style.outline='none';style.zIndex=1;input.addEventListener('input',Input._processInputting);input.addEventListener('mousemove',Input._stopEvent);input.addEventListener('mousedown',Input._stopEvent);input.addEventListener('touchmove',Input._stopEvent);input.setFontFace=function(fontFace){input.style.fontFamily=fontFace;};if(!ILaya.Render.isConchApp){input.setColor=function(color){input.style.color=color;};input.setFontSize=function(fontSize){input.style.fontSize=fontSize+'px';};}}},{key:"_processInputting",value:function _processInputting(e){var input=Input.inputElement.target;if(!input)return;var value=Input.inputElement.value;if(input._restrictPattern){value=value.replace(/\u2006|\x27/g,"");if(input._restrictPattern.test(value)){value=value.replace(input._restrictPattern,"");Input.inputElement.value=value;}}input._text=value;input.event(Event.INPUT);}},{key:"_stopEvent",value:function _stopEvent(e){if(e.type=='touchmove')e.preventDefault();e.stopPropagation&&e.stopPropagation();}}]);return Input;}(Text);Input.TYPE_TEXT="text";Input.TYPE_PASSWORD="password";Input.TYPE_EMAIL="email";Input.TYPE_URL="url";Input.TYPE_NUMBER="number";Input.TYPE_RANGE="range";Input.TYPE_DATE="date";Input.TYPE_MONTH="month";Input.TYPE_WEEK="week";Input.TYPE_TIME="time";Input.TYPE_DATE_TIME="datetime";Input.TYPE_DATE_TIME_LOCAL="datetime-local";Input.TYPE_SEARCH="search";Input.IOS_IFRAME=false;Input.inputHeight=45;Input.isInputting=false;ClassUtils.regClass("laya.display.Input",Input);ClassUtils.regClass("Laya.Input",Input);var TouchManager=function(){function TouchManager(){_classCallCheck(this,TouchManager);this.preOvers=[];this.preDowns=[];this.preRightDowns=[];this.enable=true;this._event=new Event();this._lastClickTime=0;}_createClass(TouchManager,[{key:"_clearTempArrs",value:function _clearTempArrs(){TouchManager._oldArr.length=0;TouchManager._newArr.length=0;TouchManager._tEleArr.length=0;}},{key:"getTouchFromArr",value:function getTouchFromArr(touchID,arr){var i,len;len=arr.length;var tTouchO;for(i=0;i<len;i++){tTouchO=arr[i];if(tTouchO.id==touchID){return tTouchO;}}return null;}},{key:"removeTouchFromArr",value:function removeTouchFromArr(touchID,arr){var i;for(i=arr.length-1;i>=0;i--){if(arr[i].id==touchID){arr.splice(i,1);}}}},{key:"createTouchO",value:function createTouchO(ele,touchID){var rst;rst=Pool.getItem("TouchData")||{};rst.id=touchID;rst.tar=ele;return rst;}},{key:"onMouseDown",value:function onMouseDown(ele,touchID){var isLeft=arguments.length>2&&arguments[2]!==undefined?arguments[2]:false;if(!this.enable)return;var preO;var tO;var arrs;preO=this.getTouchFromArr(touchID,this.preOvers);arrs=this.getEles(ele,null,TouchManager._tEleArr);if(!preO){tO=this.createTouchO(ele,touchID);this.preOvers.push(tO);}else{preO.tar=ele;}if(Browser.onMobile)this.sendEvents(arrs,Event.MOUSE_OVER);var preDowns;preDowns=isLeft?this.preDowns:this.preRightDowns;preO=this.getTouchFromArr(touchID,preDowns);if(!preO){tO=this.createTouchO(ele,touchID);preDowns.push(tO);}else{preO.tar=ele;}this.sendEvents(arrs,isLeft?Event.MOUSE_DOWN:Event.RIGHT_MOUSE_DOWN);this._clearTempArrs();}},{key:"sendEvents",value:function sendEvents(eles,type){var i,len;len=eles.length;this._event._stoped=false;var _target;_target=eles[0];for(i=0;i<len;i++){var tE=eles[i];if(tE.destroyed)return;tE.event(type,this._event.setTo(type,tE,_target));if(this._event._stoped)break;}}},{key:"getEles",value:function getEles(start){var end=arguments.length>1&&arguments[1]!==undefined?arguments[1]:null;var rst=arguments.length>2&&arguments[2]!==undefined?arguments[2]:null;if(!rst){rst=[];}else{rst.length=0;}while(start&&start!=end){rst.push(start);start=start.parent;}return rst;}},{key:"checkMouseOutAndOverOfMove",value:function checkMouseOutAndOverOfMove(eleNew,elePre){var touchID=arguments.length>2&&arguments[2]!==undefined?arguments[2]:0;if(elePre==eleNew)return;var tar;var arrs;var i,len;if(elePre.contains(eleNew)){arrs=this.getEles(eleNew,elePre,TouchManager._tEleArr);this.sendEvents(arrs,Event.MOUSE_OVER);}else if(eleNew.contains(elePre)){arrs=this.getEles(elePre,eleNew,TouchManager._tEleArr);this.sendEvents(arrs,Event.MOUSE_OUT);}else{arrs=TouchManager._tEleArr;arrs.length=0;var oldArr;oldArr=this.getEles(elePre,null,TouchManager._oldArr);var newArr;newArr=this.getEles(eleNew,null,TouchManager._newArr);len=oldArr.length;var tIndex;for(i=0;i<len;i++){tar=oldArr[i];tIndex=newArr.indexOf(tar);if(tIndex>=0){newArr.splice(tIndex,newArr.length-tIndex);break;}else{arrs.push(tar);}}if(arrs.length>0){this.sendEvents(arrs,Event.MOUSE_OUT);}if(newArr.length>0){this.sendEvents(newArr,Event.MOUSE_OVER);}}}},{key:"onMouseMove",value:function onMouseMove(ele,touchID){if(!this.enable)return;var preO;preO=this.getTouchFromArr(touchID,this.preOvers);var arrs;if(!preO){arrs=this.getEles(ele,null,TouchManager._tEleArr);this.sendEvents(arrs,Event.MOUSE_OVER);this.preOvers.push(this.createTouchO(ele,touchID));}else{this.checkMouseOutAndOverOfMove(ele,preO.tar);preO.tar=ele;arrs=this.getEles(ele,null,TouchManager._tEleArr);}this.sendEvents(arrs,Event.MOUSE_MOVE);this._clearTempArrs();}},{key:"getLastOvers",value:function getLastOvers(){TouchManager._tEleArr.length=0;if(this.preOvers.length>0&&this.preOvers[0].tar){return this.getEles(this.preOvers[0].tar,null,TouchManager._tEleArr);}TouchManager._tEleArr.push(ILaya.stage);return TouchManager._tEleArr;}},{key:"stageMouseOut",value:function stageMouseOut(){var lastOvers;lastOvers=this.getLastOvers();this.preOvers.length=0;this.sendEvents(lastOvers,Event.MOUSE_OUT);}},{key:"onMouseUp",value:function onMouseUp(ele,touchID){var isLeft=arguments.length>2&&arguments[2]!==undefined?arguments[2]:false;if(!this.enable)return;var preO;var arrs;var oldArr;var i,len;var tar;var sendArr;var onMobile=Browser.onMobile;arrs=this.getEles(ele,null,TouchManager._tEleArr);this.sendEvents(arrs,isLeft?Event.MOUSE_UP:Event.RIGHT_MOUSE_UP);var preDowns;preDowns=isLeft?this.preDowns:this.preRightDowns;preO=this.getTouchFromArr(touchID,preDowns);if(!preO);else{var isDouble;var now=Browser.now();isDouble=now-this._lastClickTime<300;this._lastClickTime=now;if(ele==preO.tar){sendArr=arrs;}else{oldArr=this.getEles(preO.tar,null,TouchManager._oldArr);sendArr=TouchManager._newArr;sendArr.length=0;len=oldArr.length;for(i=0;i<len;i++){tar=oldArr[i];if(arrs.indexOf(tar)>=0){sendArr.push(tar);}}}if(sendArr.length>0){this.sendEvents(sendArr,isLeft?Event.CLICK:Event.RIGHT_CLICK);}if(isLeft&&isDouble){this.sendEvents(sendArr,Event.DOUBLE_CLICK);}this.removeTouchFromArr(touchID,preDowns);preO.tar=null;Pool.recover("TouchData",preO);}preO=this.getTouchFromArr(touchID,this.preOvers);if(!preO);else{if(onMobile){sendArr=this.getEles(preO.tar,null,sendArr);if(sendArr&&sendArr.length>0){this.sendEvents(sendArr,Event.MOUSE_OUT);}this.removeTouchFromArr(touchID,this.preOvers);preO.tar=null;Pool.recover("TouchData",preO);}}this._clearTempArrs();}}]);return TouchManager;}();TouchManager.I=new TouchManager();TouchManager._oldArr=[];TouchManager._newArr=[];TouchManager._tEleArr=[];var MouseManager=function(){function MouseManager(){_classCallCheck(this,MouseManager);this.mouseX=0;this.mouseY=0;this.disableMouseEvent=false;this.mouseDownTime=0;this.mouseMoveAccuracy=2;this._event=new Event();this._captureSp=null;this._captureChain=[];this._captureExlusiveMode=false;this._hitCaputreSp=false;this._point=new Point();this._rect=new Rectangle();this._lastMoveTimer=0;this._prePoint=new Point();this._touchIDs={};this._curTouchID=NaN;this._id=1;}_createClass(MouseManager,[{key:"__init__",value:function __init__(stage,canvas){this._stage=stage;var _this=this;canvas.oncontextmenu=function(e){if(MouseManager.enabled)return false;};canvas.addEventListener('mousedown',function(e){if(MouseManager.enabled){if(!Browser.onIE)e.cancelable&&e.preventDefault();_this.mouseDownTime=Browser.now();_this.runEvent(e);}});canvas.addEventListener('mouseup',function(e){if(MouseManager.enabled){e.cancelable&&e.preventDefault();_this.mouseDownTime=-Browser.now();_this.runEvent(e);}},true);canvas.addEventListener('mousemove',function(e){if(MouseManager.enabled){e.cancelable&&e.preventDefault();var now=Browser.now();if(now-_this._lastMoveTimer<10)return;_this._lastMoveTimer=now;_this.runEvent(e);}},true);canvas.addEventListener("mouseout",function(e){if(MouseManager.enabled)_this.runEvent(e);});canvas.addEventListener("mouseover",function(e){if(MouseManager.enabled)_this.runEvent(e);});canvas.addEventListener("touchstart",function(e){if(MouseManager.enabled){if(!MouseManager._isFirstTouch&&!Input.isInputting)e.cancelable&&e.preventDefault();_this.mouseDownTime=Browser.now();_this.runEvent(e);}});canvas.addEventListener("touchend",function(e){if(MouseManager.enabled){if(!MouseManager._isFirstTouch&&!Input.isInputting)e.cancelable&&e.preventDefault();MouseManager._isFirstTouch=false;_this.mouseDownTime=-Browser.now();_this.runEvent(e);}else{_this._curTouchID=NaN;}},true);canvas.addEventListener("touchmove",function(e){if(MouseManager.enabled){e.cancelable&&e.preventDefault();_this.runEvent(e);}},true);canvas.addEventListener("touchcancel",function(e){if(MouseManager.enabled){e.cancelable&&e.preventDefault();_this.runEvent(e);}else{_this._curTouchID=NaN;}},true);canvas.addEventListener('mousewheel',function(e){if(MouseManager.enabled)_this.runEvent(e);});canvas.addEventListener('DOMMouseScroll',function(e){if(MouseManager.enabled)_this.runEvent(e);});}},{key:"initEvent",value:function initEvent(e){var nativeEvent=arguments.length>1&&arguments[1]!==undefined?arguments[1]:null;var _this=this;_this._event._stoped=false;_this._event.nativeEvent=nativeEvent||e;_this._target=null;this._point.setTo(e.pageX||e.clientX,e.pageY||e.clientY);if(this._stage._canvasTransform){this._stage._canvasTransform.invertTransformPoint(this._point);_this.mouseX=this._point.x;_this.mouseY=this._point.y;}_this._event.touchId=e.identifier||0;this._tTouchID=_this._event.touchId;var evt;evt=TouchManager.I._event;evt._stoped=false;evt.nativeEvent=_this._event.nativeEvent;evt.touchId=_this._event.touchId;}},{key:"checkMouseWheel",value:function checkMouseWheel(e){this._event.delta=e.wheelDelta?e.wheelDelta*0.025:-e.detail;var _lastOvers=TouchManager.I.getLastOvers();for(var i=0,n=_lastOvers.length;i<n;i++){var ele=_lastOvers[i];ele.event(Event.MOUSE_WHEEL,this._event.setTo(Event.MOUSE_WHEEL,ele,this._target));}}},{key:"onMouseMove",value:function onMouseMove(ele){TouchManager.I.onMouseMove(ele,this._tTouchID);}},{key:"onMouseDown",value:function onMouseDown(ele){if(Input.isInputting&&ILaya.stage.focus&&ILaya.stage.focus["focus"]&&!ILaya.stage.focus.contains(this._target)){var pre_input=ILaya.stage.focus['_tf']||ILaya.stage.focus;var new_input=ele['_tf']||ele;if(new_input instanceof Input&&new_input.multiline==pre_input.multiline)pre_input['_focusOut']();else pre_input.focus=false;}TouchManager.I.onMouseDown(ele,this._tTouchID,this._isLeftMouse);}},{key:"onMouseUp",value:function onMouseUp(ele){TouchManager.I.onMouseUp(ele,this._tTouchID,this._isLeftMouse);}},{key:"check",value:function check(sp,mouseX,mouseY,callBack){this._point.setTo(mouseX,mouseY);sp.fromParentPoint(this._point);mouseX=this._point.x;mouseY=this._point.y;var scrollRect=sp._style.scrollRect;if(scrollRect){this._rect.setTo(scrollRect.x,scrollRect.y,scrollRect.width,scrollRect.height);if(!this._rect.contains(mouseX,mouseY))return false;}if(!this.disableMouseEvent){if(sp.hitTestPrior&&!sp.mouseThrough&&!this.hitTest(sp,mouseX,mouseY)){return false;}for(var i=sp._children.length-1;i>-1;i--){var child=sp._children[i];if(!child.destroyed&&child._mouseState>1&&child._visible){if(this.check(child,mouseX,mouseY,callBack))return true;}}for(i=sp._extUIChild.length-1;i>=0;i--){var c=sp._extUIChild[i];if(!c.destroyed&&c._mouseState>1&&c._visible){if(this.check(c,mouseX,mouseY,callBack))return true;}}}var isHit=sp.hitTestPrior&&!sp.mouseThrough&&!this.disableMouseEvent?true:this.hitTest(sp,mouseX,mouseY);if(isHit){this._target=sp;callBack.call(this,sp);if(this._target==this._hitCaputreSp){this._hitCaputreSp=true;}}else if(callBack===this.onMouseUp&&sp===this._stage){this._target=this._stage;callBack.call(this,this._target);}return isHit;}},{key:"hitTest",value:function hitTest(sp,mouseX,mouseY){var isHit=false;if(sp.scrollRect){mouseX-=sp._style.scrollRect.x;mouseY-=sp._style.scrollRect.y;}var hitArea=sp._style.hitArea;if(hitArea&&hitArea._hit){return hitArea.contains(mouseX,mouseY);}if(sp.width>0&&sp.height>0||sp.mouseThrough||hitArea){if(!sp.mouseThrough){isHit=(hitArea?hitArea:this._rect.setTo(0,0,sp.width,sp.height)).contains(mouseX,mouseY);}else{isHit=sp.getGraphicBounds().contains(mouseX,mouseY);}}return isHit;}},{key:"_checkAllBaseUI",value:function _checkAllBaseUI(mousex,mousey,callback){var ret=this.handleExclusiveCapture(this.mouseX,this.mouseY,callback);if(ret)return true;ret=this.check(this._stage,this.mouseX,this.mouseY,callback);return this.handleCapture(this.mouseX,this.mouseY,callback)||ret;}},{key:"check3DUI",value:function check3DUI(mousex,mousey,callback){var uis=this._stage._3dUI;var i=0;var ret=false;for(;i<uis.length;i++){var curui=uis[i];this._stage._curUIBase=curui;if(!curui.destroyed&&curui._mouseState>1&&curui._visible){ret=ret||this.check(curui,this.mouseX,this.mouseY,callback);}}this._stage._curUIBase=this._stage;return ret;}},{key:"handleExclusiveCapture",value:function handleExclusiveCapture(mousex,mousey,callback){if(this._captureExlusiveMode&&this._captureSp&&this._captureChain.length>0){var cursp;this._point.setTo(mousex,mousey);for(var i=0;i<this._captureChain.length;i++){cursp=this._captureChain[i];cursp.fromParentPoint(this._point);}this._target=cursp;callback.call(this,cursp);return true;}return false;}},{key:"handleCapture",value:function handleCapture(mousex,mousey,callback){if(!this._hitCaputreSp&&this._captureSp&&this._captureChain.length>0){var cursp;this._point.setTo(mousex,mousey);for(var i=0;i<this._captureChain.length;i++){cursp=this._captureChain[i];cursp.fromParentPoint(this._point);}this._target=cursp;callback.call(this,cursp);return true;}return false;}},{key:"runEvent",value:function runEvent(evt){var i,n,touch;if(evt.type!=='mousemove')this._prePoint.x=this._prePoint.y=-1000000;switch(evt.type){case'mousedown':this._touchIDs[0]=this._id++;if(!MouseManager._isTouchRespond){this._isLeftMouse=evt.button===0;this.initEvent(evt);this._checkAllBaseUI(this.mouseX,this.mouseY,this.onMouseDown);}else MouseManager._isTouchRespond=false;break;case'mouseup':this._isLeftMouse=evt.button===0;this.initEvent(evt);this._checkAllBaseUI(this.mouseX,this.mouseY,this.onMouseUp);break;case'mousemove':if(Math.abs(this._prePoint.x-evt.clientX)+Math.abs(this._prePoint.y-evt.clientY)>=this.mouseMoveAccuracy){this._prePoint.x=evt.clientX;this._prePoint.y=evt.clientY;this.initEvent(evt);this._checkAllBaseUI(this.mouseX,this.mouseY,this.onMouseMove);}break;case"touchstart":MouseManager._isTouchRespond=true;this._isLeftMouse=true;var touches=evt.changedTouches;for(i=0,n=touches.length;i<n;i++){touch=touches[i];if(MouseManager.multiTouchEnabled||isNaN(this._curTouchID)){this._curTouchID=touch.identifier;if(this._id%200===0)this._touchIDs={};this._touchIDs[touch.identifier]=this._id++;this.initEvent(touch,evt);this._checkAllBaseUI(this.mouseX,this.mouseY,this.onMouseDown);}}break;case"touchend":case"touchcancel":MouseManager._isTouchRespond=true;this._isLeftMouse=true;var touchends=evt.changedTouches;for(i=0,n=touchends.length;i<n;i++){touch=touchends[i];if(MouseManager.multiTouchEnabled||touch.identifier==this._curTouchID){this._curTouchID=NaN;this.initEvent(touch,evt);var isChecked;isChecked=this._checkAllBaseUI(this.mouseX,this.mouseY,this.onMouseUp);if(!isChecked){this.onMouseUp(null);}}}break;case"touchmove":var touchemoves=evt.changedTouches;for(i=0,n=touchemoves.length;i<n;i++){touch=touchemoves[i];if(MouseManager.multiTouchEnabled||touch.identifier==this._curTouchID){this.initEvent(touch,evt);this._checkAllBaseUI(this.mouseX,this.mouseY,this.onMouseMove);}}break;case"wheel":case"mousewheel":case"DOMMouseScroll":this.checkMouseWheel(evt);break;case"mouseout":TouchManager.I.stageMouseOut();break;case"mouseover":this._stage.event(Event.MOUSE_OVER,this._event.setTo(Event.MOUSE_OVER,this._stage,this._stage));break;}}},{key:"setCapture",value:function setCapture(sp){var exclusive=arguments.length>1&&arguments[1]!==undefined?arguments[1]:false;this._captureSp=sp;this._captureExlusiveMode=exclusive;this._captureChain.length=0;this._captureChain.push(sp);var cursp=sp;while(true){if(cursp==ILaya.stage)break;if(cursp==ILaya.stage._curUIBase)break;cursp=cursp.parent;if(!cursp)break;this._captureChain.splice(0,0,cursp);}}},{key:"releaseCapture",value:function releaseCapture(){console.log('release capture');this._captureSp=null;}}]);return MouseManager;}();MouseManager.instance=new MouseManager();MouseManager.enabled=true;MouseManager.multiTouchEnabled=true;MouseManager._isFirstTouch=true;var CallLater=function(){function CallLater(){_classCallCheck(this,CallLater);this._pool=[];this._map={};this._laters=[];}_createClass(CallLater,[{key:"_update",value:function _update(){var laters=this._laters;var len=laters.length;if(len>0){for(var _i=0,n=len-1;_i<=n;_i++){var handler=laters[_i];this._map[handler.key]=null;if(handler.method!==null){handler.run();handler.clear();}this._pool.push(handler);_i===n&&(n=laters.length-1);}laters.length=0;}}},{key:"_getHandler",value:function _getHandler(caller,method){var cid=caller?caller.$_GID||(caller.$_GID=ILaya.Utils.getGID()):0;var mid=method.$_TID||(method.$_TID=ILaya.Timer._mid++);return this._map[cid+'.'+mid];}},{key:"callLater",value:function callLater(caller,method){var args=arguments.length>2&&arguments[2]!==undefined?arguments[2]:null;if(this._getHandler(caller,method)==null){var handler=void 0;if(this._pool.length)handler=this._pool.pop();else handler=new LaterHandler();handler.caller=caller;handler.method=method;handler.args=args;var cid=caller?caller.$_GID:0;var mid=method["$_TID"];handler.key=cid+'.'+mid;this._map[handler.key]=handler;this._laters.push(handler);}}},{key:"runCallLater",value:function runCallLater(caller,method){var handler=this._getHandler(caller,method);if(handler&&handler.method!=null){this._map[handler.key]=null;handler.run();handler.clear();}}}]);return CallLater;}();CallLater.I=new CallLater();var LaterHandler=function(){function LaterHandler(){_classCallCheck(this,LaterHandler);}_createClass(LaterHandler,[{key:"clear",value:function clear(){this.caller=null;this.method=null;this.args=null;}},{key:"run",value:function run(){var caller=this.caller;if(caller&&caller.destroyed)return this.clear();var method=this.method;var args=this.args;if(method==null)return;args?method.apply(caller,args):method.call(caller);}}]);return LaterHandler;}();var RunDriver=function RunDriver(){_classCallCheck(this,RunDriver);};RunDriver.createShaderCondition=function(conditionScript){var fn="(function() {return "+conditionScript+";})";return window.Laya._runScript(fn);};RunDriver.changeWebGLSize=function(w,h){WebGL.onStageResize(w,h);};var Stage=function(_Sprite2){_inherits(Stage,_Sprite2);function Stage(){_classCallCheck(this,Stage);var _this33=_possibleConstructorReturn(this,(Stage.__proto__||Object.getPrototypeOf(Stage)).call(this));_this33.offset=new Point();_this33._frameRate="fast";_this33.designWidth=0;_this33.designHeight=0;_this33.canvasRotation=false;_this33.canvasDegree=0;_this33.renderingEnabled=true;_this33.screenAdaptationEnabled=true;_this33._canvasTransform=new Matrix();_this33._screenMode="none";_this33._scaleMode="noscale";_this33._alignV="top";_this33._alignH="left";_this33._bgColor="black";_this33._mouseMoveTime=0;_this33._renderCount=0;_this33._safariOffsetY=0;_this33._frameStartTime=0;_this33._previousOrientation=Browser.window.orientation;_this33._wgColor=[0,0,0,1];_this33._scene3Ds=[];_this33._globalRepaintSet=false;_this33._globalRepaintGet=false;_this33._3dUI=[];_this33._curUIBase=null;_this33.useRetinalCanvas=false;_get(Stage.prototype.__proto__||Object.getPrototypeOf(Stage.prototype),"set_transform",_this33).call(_this33,_this33._createTransform());_this33.mouseEnabled=true;_this33.hitTestPrior=true;_this33.autoSize=false;_this33._setBit(Const.DISPLAYED_INSTAGE,true);_this33._setBit(Const.ACTIVE_INHIERARCHY,true);_this33._isFocused=true;_this33._isVisibility=true;_this33.useRetinalCanvas=Config.useRetinalCanvas;var window=Browser.window;window.addEventListener("focus",function(){_this33._isFocused=true;_this33.event(Event.FOCUS);_this33.event(Event.FOCUS_CHANGE);});window.addEventListener("blur",function(){_this33._isFocused=false;_this33.event(Event.BLUR);_this33.event(Event.FOCUS_CHANGE);if(_this33._isInputting())Input["inputElement"].target.focus=false;});var state="visibilityState",visibilityChange="visibilitychange";var document=window.document;if(typeof document.hidden!=="undefined"){visibilityChange="visibilitychange";state="visibilityState";}else if(typeof document.mozHidden!=="undefined"){visibilityChange="mozvisibilitychange";state="mozVisibilityState";}else if(typeof document.msHidden!=="undefined"){visibilityChange="msvisibilitychange";state="msVisibilityState";}else if(typeof document.webkitHidden!=="undefined"){visibilityChange="webkitvisibilitychange";state="webkitVisibilityState";}window.document.addEventListener(visibilityChange,function(){if(Browser.document[state]=="hidden"){_this33._isVisibility=false;if(_this33._isInputting())Input["inputElement"].target.focus=false;}else{_this33._isVisibility=true;}_this33.renderingEnabled=_this33._isVisibility;_this33.event(Event.VISIBILITY_CHANGE);});window.addEventListener("resize",function(){var orientation=Browser.window.orientation;if(orientation!=null&&orientation!=_this33._previousOrientation&&_this33._isInputting()){Input["inputElement"].target.focus=false;}_this33._previousOrientation=orientation;if(_this33._isInputting())return;if(Browser.onSafari)_this33._safariOffsetY=(Browser.window.__innerHeight||Browser.document.body.clientHeight||Browser.document.documentElement.clientHeight)-Browser.window.innerHeight;_this33._resetCanvas();});window.addEventListener("orientationchange",function(e){_this33._resetCanvas();});_this33.on(Event.MOUSE_MOVE,_this33,_this33._onmouseMove);if(Browser.onMobile)_this33.on(Event.MOUSE_DOWN,_this33,_this33._onmouseMove);return _this33;}_createClass(Stage,[{key:"_isInputting",value:function _isInputting(){return Browser.onMobile&&Input.isInputting;}},{key:"_changeCanvasSize",value:function _changeCanvasSize(){this.setScreenSize(Browser.clientWidth*Browser.pixelRatio,Browser.clientHeight*Browser.pixelRatio);}},{key:"_resetCanvas",value:function _resetCanvas(){if(!this.screenAdaptationEnabled)return;this._changeCanvasSize();}},{key:"setScreenSize",value:function setScreenSize(screenWidth,screenHeight){var rotation=false;if(this._screenMode!==Stage.SCREEN_NONE){var screenType=screenWidth/screenHeight<1?Stage.SCREEN_VERTICAL:Stage.SCREEN_HORIZONTAL;rotation=screenType!==this._screenMode;if(rotation){var temp=screenHeight;screenHeight=screenWidth;screenWidth=temp;}}this.canvasRotation=rotation;var canvas=Render._mainCanvas;var canvasStyle=canvas.source.style;var mat=this._canvasTransform.identity();var scaleMode=this._scaleMode;var scaleX=screenWidth/this.designWidth;var scaleY=screenHeight/this.designHeight;var canvasWidth=this.useRetinalCanvas?screenWidth:this.designWidth;var canvasHeight=this.useRetinalCanvas?screenHeight:this.designHeight;var realWidth=screenWidth;var realHeight=screenHeight;var pixelRatio=Browser.pixelRatio;this._width=this.designWidth;this._height=this.designHeight;switch(scaleMode){case Stage.SCALE_NOSCALE:scaleX=scaleY=1;realWidth=this.designWidth;realHeight=this.designHeight;break;case Stage.SCALE_SHOWALL:scaleX=scaleY=Math.min(scaleX,scaleY);canvasWidth=realWidth=Math.round(this.designWidth*scaleX);canvasHeight=realHeight=Math.round(this.designHeight*scaleY);break;case Stage.SCALE_NOBORDER:scaleX=scaleY=Math.max(scaleX,scaleY);realWidth=Math.round(this.designWidth*scaleX);realHeight=Math.round(this.designHeight*scaleY);break;case Stage.SCALE_FULL:scaleX=scaleY=1;this._width=canvasWidth=screenWidth;this._height=canvasHeight=screenHeight;break;case Stage.SCALE_FIXED_WIDTH:scaleY=scaleX;this._height=canvasHeight=Math.round(screenHeight/scaleX);break;case Stage.SCALE_FIXED_HEIGHT:scaleX=scaleY;this._width=canvasWidth=Math.round(screenWidth/scaleY);break;case Stage.SCALE_FIXED_AUTO:if(screenWidth/screenHeight<this.designWidth/this.designHeight){scaleY=scaleX;this._height=canvasHeight=Math.round(screenHeight/scaleX);}else{scaleX=scaleY;this._width=canvasWidth=Math.round(screenWidth/scaleY);}break;}if(this.useRetinalCanvas){canvasWidth=screenWidth;canvasHeight=screenHeight;}scaleX*=this.scaleX;scaleY*=this.scaleY;if(scaleX===1&&scaleY===1){this.transform.identity();}else{this.transform.a=this._formatData(scaleX/(realWidth/canvasWidth));this.transform.d=this._formatData(scaleY/(realHeight/canvasHeight));}canvas.size(canvasWidth,canvasHeight);RunDriver.changeWebGLSize(canvasWidth,canvasHeight);mat.scale(realWidth/canvasWidth/pixelRatio,realHeight/canvasHeight/pixelRatio);if(this._alignH===Stage.ALIGN_LEFT)this.offset.x=0;else if(this._alignH===Stage.ALIGN_RIGHT)this.offset.x=screenWidth-realWidth;else this.offset.x=(screenWidth-realWidth)*0.5/pixelRatio;if(this._alignV===Stage.ALIGN_TOP)this.offset.y=0;else if(this._alignV===Stage.ALIGN_BOTTOM)this.offset.y=screenHeight-realHeight;else this.offset.y=(screenHeight-realHeight)*0.5/pixelRatio;this.offset.x=Math.round(this.offset.x);this.offset.y=Math.round(this.offset.y);mat.translate(this.offset.x,this.offset.y);if(this._safariOffsetY)mat.translate(0,this._safariOffsetY);this.canvasDegree=0;if(rotation){if(this._screenMode===Stage.SCREEN_HORIZONTAL){mat.rotate(Math.PI/2);mat.translate(screenHeight/pixelRatio,0);this.canvasDegree=90;}else{mat.rotate(-Math.PI/2);mat.translate(0,screenWidth/pixelRatio);this.canvasDegree=-90;}}mat.a=this._formatData(mat.a);mat.d=this._formatData(mat.d);mat.tx=this._formatData(mat.tx);mat.ty=this._formatData(mat.ty);_get(Stage.prototype.__proto__||Object.getPrototypeOf(Stage.prototype),"set_transform",this).call(this,this.transform);canvasStyle.transformOrigin=canvasStyle.webkitTransformOrigin=canvasStyle.msTransformOrigin=canvasStyle.mozTransformOrigin=canvasStyle.oTransformOrigin="0px 0px 0px";canvasStyle.transform=canvasStyle.webkitTransform=canvasStyle.msTransform=canvasStyle.mozTransform=canvasStyle.oTransform="matrix("+mat.toString()+")";if(this._safariOffsetY)mat.translate(0,-this._safariOffsetY);mat.translate(parseInt(canvasStyle.left)||0,parseInt(canvasStyle.top)||0);this.visible=true;this._repaint|=SpriteConst.REPAINT_CACHE;this.event(Event.RESIZE);}},{key:"_formatData",value:function _formatData(value){if(Math.abs(value)<0.000001)return 0;if(Math.abs(1-value)<0.001)return value>0?1:-1;return value;}},{key:"getMousePoint",value:function getMousePoint(){return Point.TEMP.setTo(this.mouseX,this.mouseY);}},{key:"repaint",value:function repaint(){var type=arguments.length>0&&arguments[0]!==undefined?arguments[0]:SpriteConst.REPAINT_CACHE;this._repaint|=type;}},{key:"parentRepaint",value:function parentRepaint(){var type=arguments.length>0&&arguments[0]!==undefined?arguments[0]:SpriteConst.REPAINT_CACHE;}},{key:"_loop",value:function _loop(){this._globalRepaintGet=this._globalRepaintSet;this._globalRepaintSet=false;this.render(Render._context,0,0);return true;}},{key:"getFrameTm",value:function getFrameTm(){return this._frameStartTime;}},{key:"_onmouseMove",value:function _onmouseMove(e){this._mouseMoveTime=Browser.now();}},{key:"getTimeFromFrameStart",value:function getTimeFromFrameStart(){return Browser.now()-this._frameStartTime;}},{key:"render",value:function render(context,x,y){if(window.conch){this.renderToNative(context,x,y);return;}Stage._dbgSprite.graphics.clear();if(this._frameRate===Stage.FRAME_SLEEP){var now=Browser.now();if(now-this._frameStartTime>=1000)this._frameStartTime=now;else return;}else{if(!this._visible){this._renderCount++;if(this._renderCount%5===0){CallLater.I._update();Stat.loopCount++;RenderInfo.loopCount=Stat.loopCount;this._updateTimers();}return;}this._frameStartTime=Browser.now();RenderInfo.loopStTm=this._frameStartTime;}this._renderCount++;var frameMode=this._frameRate===Stage.FRAME_MOUSE?this._frameStartTime-this._mouseMoveTime<2000?Stage.FRAME_FAST:Stage.FRAME_SLOW:this._frameRate;var isFastMode=frameMode!==Stage.FRAME_SLOW;var isDoubleLoop=this._renderCount%2===0;Stat.renderSlow=!isFastMode;if(!isFastMode&&!isDoubleLoop)return;CallLater.I._update();Stat.loopCount++;RenderInfo.loopCount=Stat.loopCount;if(this.renderingEnabled){for(var i=0,n=this._scene3Ds.length;i<n;i++){this._scene3Ds[i]._update();}context.clear();_get(Stage.prototype.__proto__||Object.getPrototypeOf(Stage.prototype),"render",this).call(this,context,x,y);Stat._StatRender.renderNotCanvas(context,x,y);}Stage._dbgSprite.render(context,0,0);if(this.renderingEnabled){Stage.clear(this._bgColor);context.flush();VectorGraphManager.instance&&VectorGraphManager.getInstance().endDispose();}this._updateTimers();}},{key:"renderToNative",value:function renderToNative(context,x,y){this._renderCount++;if(!this._visible){if(this._renderCount%5===0){CallLater.I._update();Stat.loopCount++;RenderInfo.loopCount=Stat.loopCount;this._updateTimers();}return;}CallLater.I._update();Stat.loopCount++;RenderInfo.loopCount=Stat.loopCount;if(this.renderingEnabled){for(var i=0,n=this._scene3Ds.length;i<n;i++){this._scene3Ds[i]._update();}context.clear();_get(Stage.prototype.__proto__||Object.getPrototypeOf(Stage.prototype),"render",this).call(this,context,x,y);Stat._StatRender.renderNotCanvas(context,x,y);}if(this.renderingEnabled){Stage.clear(this._bgColor);context.flush();VectorGraphManager.instance&&VectorGraphManager.getInstance().endDispose();}this._updateTimers();}},{key:"_updateTimers",value:function _updateTimers(){ILaya.systemTimer._update();ILaya.startTimer._update();ILaya.physicsTimer._update();ILaya.updateTimer._update();ILaya.lateTimer._update();ILaya.timer._update();}},{key:"_requestFullscreen",value:function _requestFullscreen(){var element=Browser.document.documentElement;if(element.requestFullscreen){element.requestFullscreen();}else if(element.mozRequestFullScreen){element.mozRequestFullScreen();}else if(element.webkitRequestFullscreen){element.webkitRequestFullscreen();}else if(element.msRequestFullscreen){element.msRequestFullscreen();}}},{key:"_fullScreenChanged",value:function _fullScreenChanged(){ILaya.stage.event(Event.FULL_SCREEN_CHANGE);}},{key:"exitFullscreen",value:function exitFullscreen(){var document=Browser.document;if(document.exitFullscreen){document.exitFullscreen();}else if(document.mozCancelFullScreen){document.mozCancelFullScreen();}else if(document.webkitExitFullscreen){document.webkitExitFullscreen();}}},{key:"isGlobalRepaint",value:function isGlobalRepaint(){return this._globalRepaintGet;}},{key:"setGlobalRepaint",value:function setGlobalRepaint(){this._globalRepaintSet=true;}},{key:"add3DUI",value:function add3DUI(uibase){var uiroot=uibase.rootView;if(this._3dUI.indexOf(uiroot)>=0)return;this._3dUI.push(uiroot);}},{key:"remove3DUI",value:function remove3DUI(uibase){var uiroot=uibase.rootView;var p=this._3dUI.indexOf(uiroot);if(p>=0){this._3dUI.splice(p,1);return true;}return false;}},{key:"width",set:function set(value){this.designWidth=value;_get(Stage.prototype.__proto__||Object.getPrototypeOf(Stage.prototype),"set_width",this).call(this,value);ILaya.systemTimer.callLater(this,this._changeCanvasSize);},get:function get(){return _get(Stage.prototype.__proto__||Object.getPrototypeOf(Stage.prototype),"get_width",this).call(this);}},{key:"height",set:function set(value){this.designHeight=value;_get(Stage.prototype.__proto__||Object.getPrototypeOf(Stage.prototype),"set_height",this).call(this,value);ILaya.systemTimer.callLater(this,this._changeCanvasSize);},get:function get(){return _get(Stage.prototype.__proto__||Object.getPrototypeOf(Stage.prototype),"get_height",this).call(this);}},{key:"transform",set:function set(value){_get(Stage.prototype.__proto__||Object.getPrototypeOf(Stage.prototype),"set_transform",this).call(this,value);},get:function get(){if(this._tfChanged)this._adjustTransform();return this._transform=this._transform||this._createTransform();}},{key:"isFocused",get:function get(){return this._isFocused;}},{key:"isVisibility",get:function get(){return this._isVisibility;}},{key:"scaleMode",get:function get(){return this._scaleMode;},set:function set(value){this._scaleMode=value;ILaya.systemTimer.callLater(this,this._changeCanvasSize);}},{key:"alignH",get:function get(){return this._alignH;},set:function set(value){this._alignH=value;ILaya.systemTimer.callLater(this,this._changeCanvasSize);}},{key:"alignV",get:function get(){return this._alignV;},set:function set(value){this._alignV=value;ILaya.systemTimer.callLater(this,this._changeCanvasSize);}},{key:"bgColor",get:function get(){return this._bgColor;},set:function set(value){this._bgColor=value;if(value)this._wgColor=ColorUtils.create(value).arrColor;else this._wgColor=null;if(value){Render.canvas.style.background=value;}else{Render.canvas.style.background="none";}}},{key:"mouseX",get:function get(){return Math.round(MouseManager.instance.mouseX/this.clientScaleX);}},{key:"mouseY",get:function get(){return Math.round(MouseManager.instance.mouseY/this.clientScaleY);}},{key:"clientScaleX",get:function get(){return this._transform?this._transform.getScaleX():1;}},{key:"clientScaleY",get:function get(){return this._transform?this._transform.getScaleY():1;}},{key:"screenMode",get:function get(){return this._screenMode;},set:function set(value){this._screenMode=value;}},{key:"visible",set:function set(value){if(this.visible!==value){_get(Stage.prototype.__proto__||Object.getPrototypeOf(Stage.prototype),"set_visible",this).call(this,value);var style=Render._mainCanvas.source.style;style.visibility=value?"visible":"hidden";}},get:function get(){return _get(Stage.prototype.__proto__||Object.getPrototypeOf(Stage.prototype),"visible",this);}},{key:"fullScreenEnabled",set:function set(value){var document=Browser.document;var canvas=Render.canvas;if(value){canvas.addEventListener('mousedown',this._requestFullscreen);canvas.addEventListener('touchstart',this._requestFullscreen);document.addEventListener("fullscreenchange",this._fullScreenChanged);document.addEventListener("mozfullscreenchange",this._fullScreenChanged);document.addEventListener("webkitfullscreenchange",this._fullScreenChanged);document.addEventListener("msfullscreenchange",this._fullScreenChanged);}else{canvas.removeEventListener('mousedown',this._requestFullscreen);canvas.removeEventListener('touchstart',this._requestFullscreen);document.removeEventListener("fullscreenchange",this._fullScreenChanged);document.removeEventListener("mozfullscreenchange",this._fullScreenChanged);document.removeEventListener("webkitfullscreenchange",this._fullScreenChanged);document.removeEventListener("msfullscreenchange",this._fullScreenChanged);}}},{key:"frameRate",get:function get(){if(!ILaya.Render.isConchApp){return this._frameRate;}else{return this._frameRateNative;}},set:function set(value){if(!ILaya.Render.isConchApp){this._frameRate=value;}else{var c=window.conch;switch(value){case Stage.FRAME_FAST:c.config.setLimitFPS(60);break;case Stage.FRAME_MOUSE:c.config.setMouseFrame(2000);break;case Stage.FRAME_SLOW:c.config.setSlowFrame(true);break;case Stage.FRAME_SLEEP:c.config.setLimitFPS(1);break;}this._frameRateNative=value;}}}]);return Stage;}(Sprite);Stage.SCALE_NOSCALE="noscale";Stage.SCALE_EXACTFIT="exactfit";Stage.SCALE_SHOWALL="showall";Stage.SCALE_NOBORDER="noborder";Stage.SCALE_FULL="full";Stage.SCALE_FIXED_WIDTH="fixedwidth";Stage.SCALE_FIXED_HEIGHT="fixedheight";Stage.SCALE_FIXED_AUTO="fixedauto";Stage.ALIGN_LEFT="left";Stage.ALIGN_RIGHT="right";Stage.ALIGN_CENTER="center";Stage.ALIGN_TOP="top";Stage.ALIGN_MIDDLE="middle";Stage.ALIGN_BOTTOM="bottom";Stage.SCREEN_NONE="none";Stage.SCREEN_HORIZONTAL="horizontal";Stage.SCREEN_VERTICAL="vertical";Stage.FRAME_FAST="fast";Stage.FRAME_SLOW="slow";Stage.FRAME_MOUSE="mouse";Stage.FRAME_SLEEP="sleep";Stage._dbgSprite=new Sprite();Stage.clear=function(value){Context.set2DRenderConfig();var gl=LayaGL.instance;RenderState2D.worldScissorTest&&gl.disable(gl.SCISSOR_TEST);var ctx=Render.context;var c=ctx._submits._length==0||Config.preserveDrawingBuffer?ColorUtils.create(value).arrColor:ILaya.stage._wgColor;if(c)ctx.clearBG(c[0],c[1],c[2],c[3]);else ctx.clearBG(0,0,0,0);RenderState2D.clear();};ClassUtils.regClass("laya.display.Stage",Stage);ClassUtils.regClass("Laya.Stage",Stage);var KeyBoardManager=function(){function KeyBoardManager(){_classCallCheck(this,KeyBoardManager);}_createClass(KeyBoardManager,null,[{key:"__init__",value:function __init__(){KeyBoardManager._addEvent("keydown");KeyBoardManager._addEvent("keypress");KeyBoardManager._addEvent("keyup");}},{key:"_addEvent",value:function _addEvent(type){ILaya.Browser.document.addEventListener(type,function(e){KeyBoardManager._dispatch(e,type);},true);}},{key:"_dispatch",value:function _dispatch(e,type){if(!KeyBoardManager.enabled)return;KeyBoardManager._event._stoped=false;KeyBoardManager._event.nativeEvent=e;KeyBoardManager._event.keyCode=e.keyCode||e.which||e.charCode;if(type==="keydown")KeyBoardManager._pressKeys[KeyBoardManager._event.keyCode]=true;else if(type==="keyup")KeyBoardManager._pressKeys[KeyBoardManager._event.keyCode]=null;var target=ILaya.stage.focus&&ILaya.stage.focus.event!=null&&ILaya.stage.focus.displayedInStage?ILaya.stage.focus:ILaya.stage;var ct=target;while(ct){ct.event(type,KeyBoardManager._event.setTo(type,ct,target));ct=ct.parent;}}},{key:"hasKeyDown",value:function hasKeyDown(key){return KeyBoardManager._pressKeys[key];}}]);return KeyBoardManager;}();KeyBoardManager._pressKeys={};KeyBoardManager.enabled=true;KeyBoardManager._event=new Event();var SoundChannel=function(_EventDispatcher4){_inherits(SoundChannel,_EventDispatcher4);function SoundChannel(){_classCallCheck(this,SoundChannel);var _this34=_possibleConstructorReturn(this,(SoundChannel.__proto__||Object.getPrototypeOf(SoundChannel)).apply(this,arguments));_this34.isStopped=false;return _this34;}_createClass(SoundChannel,[{key:"play",value:function play(){}},{key:"stop",value:function stop(){if(this.completeHandler)this.completeHandler.run();}},{key:"pause",value:function pause(){}},{key:"resume",value:function resume(){}},{key:"__runComplete",value:function __runComplete(handler){if(handler){handler.run();}}},{key:"volume",set:function set(v){},get:function get(){return 1;}},{key:"position",get:function get(){return 0;}},{key:"duration",get:function get(){return 0;}}]);return SoundChannel;}(EventDispatcher);var AudioSoundChannel=function(_SoundChannel){_inherits(AudioSoundChannel,_SoundChannel);function AudioSoundChannel(audio){_classCallCheck(this,AudioSoundChannel);var _this35=_possibleConstructorReturn(this,(AudioSoundChannel.__proto__||Object.getPrototypeOf(AudioSoundChannel)).call(this));_this35._audio=null;_this35._onEnd=_this35.__onEnd.bind(_this35);_this35._resumePlay=_this35.__resumePlay.bind(_this35);audio.addEventListener("ended",_this35._onEnd);_this35._audio=audio;return _this35;}_createClass(AudioSoundChannel,[{key:"__onEnd",value:function __onEnd(evt){if(this.loops==1){if(this.completeHandler){ILaya.systemTimer.once(10,this,this.__runComplete,[this.completeHandler],false);this.completeHandler=null;}this.stop();this.event(Event.COMPLETE);return;}if(this.loops>0){this.loops--;}this.startTime=0;this.play();}},{key:"__resumePlay",value:function __resumePlay(){if(this._audio)this._audio.removeEventListener("canplay",this._resumePlay);if(this.isStopped)return;try{this._audio.currentTime=this.startTime;Browser.container.appendChild(this._audio);this._audio.play();}catch(e){this.event(Event.ERROR);}}},{key:"play",value:function play(){this.isStopped=false;try{this._audio.playbackRate=ILaya.SoundManager.playbackRate;this._audio.currentTime=this.startTime;}catch(e){this._audio.addEventListener("canplay",this._resumePlay);return;}ILaya.SoundManager.addChannel(this);Browser.container.appendChild(this._audio);if("play"in this._audio)this._audio.play();}},{key:"stop",value:function stop(){_get(AudioSoundChannel.prototype.__proto__||Object.getPrototypeOf(AudioSoundChannel.prototype),"stop",this).call(this);this.isStopped=true;ILaya.SoundManager.removeChannel(this);this.completeHandler=null;if(!this._audio)return;if("pause"in this._audio)if(ILaya.Render.isConchApp){this._audio.stop();}this._audio.pause();this._audio.removeEventListener("ended",this._onEnd);this._audio.removeEventListener("canplay",this._resumePlay);if(!ILaya.Browser.onIE){if(this._audio!=ILaya.AudioSound._musicAudio){ILaya.Pool.recover("audio:"+this.url,this._audio);}}Browser.removeElement(this._audio);this._audio=null;if(ILaya.SoundManager.autoReleaseSound)ILaya.SoundManager.disposeSoundLater(this.url);}},{key:"pause",value:function pause(){this.isStopped=true;ILaya.SoundManager.removeChannel(this);if("pause"in this._audio)this._audio.pause();if(ILaya.SoundManager.autoReleaseSound)ILaya.SoundManager.disposeSoundLater(this.url);}},{key:"resume",value:function resume(){if(!this._audio)return;this.isStopped=false;ILaya.SoundManager.addChannel(this);if("play"in this._audio)this._audio.play();}},{key:"position",get:function get(){if(!this._audio)return 0;return this._audio.currentTime;}},{key:"duration",get:function get(){if(!this._audio)return 0;return this._audio.duration;}},{key:"volume",set:function set(v){if(!this._audio)return;this._audio.volume=v;},get:function get(){if(!this._audio)return 1;return this._audio.volume;}}]);return AudioSoundChannel;}(SoundChannel);var AudioSound=function(_EventDispatcher5){_inherits(AudioSound,_EventDispatcher5);function AudioSound(){_classCallCheck(this,AudioSound);var _this36=_possibleConstructorReturn(this,(AudioSound.__proto__||Object.getPrototypeOf(AudioSound)).apply(this,arguments));_this36.loaded=false;return _this36;}_createClass(AudioSound,[{key:"dispose",value:function dispose(){var ad=AudioSound._audioCache[this.url];Pool.clearBySign("audio:"+this.url);if(ad){if(!Render.isConchApp){ad.src="";}delete AudioSound._audioCache[this.url];}}},{key:"load",value:function load(url){url=URL.formatURL(url);this.url=url;var ad;if(url==ILaya.SoundManager._bgMusic){AudioSound._initMusicAudio();ad=AudioSound._musicAudio;if(ad.src!=url){AudioSound._audioCache[ad.src]=null;ad=null;}}else{ad=AudioSound._audioCache[url];}if(ad&&ad.readyState>=2){this.event(Event.COMPLETE);return;}if(!ad){if(url==ILaya.SoundManager._bgMusic){AudioSound._initMusicAudio();ad=AudioSound._musicAudio;}else{ad=Browser.createElement("audio");}AudioSound._audioCache[url]=ad;ad.src=url;}ad.addEventListener("canplaythrough",onLoaded);ad.addEventListener("error",onErr);var me=this;function onLoaded(){offs();me.loaded=true;me.event(Event.COMPLETE);}function onErr(){ad.load=null;offs();me.event(Event.ERROR);}function offs(){ad.removeEventListener("canplaythrough",onLoaded);ad.removeEventListener("error",onErr);}this.audio=ad;if(ad.load){ad.load();}else{onErr();}}},{key:"play",value:function play(){var startTime=arguments.length>0&&arguments[0]!==undefined?arguments[0]:0;var loops=arguments.length>1&&arguments[1]!==undefined?arguments[1]:0;if(!this.url)return null;var ad;if(this.url==ILaya.SoundManager._bgMusic){ad=AudioSound._musicAudio;}else{ad=AudioSound._audioCache[this.url];}if(!ad)return null;var tAd;tAd=Pool.getItem("audio:"+this.url);if(Render.isConchApp){if(!tAd){tAd=Browser.createElement("audio");tAd.src=this.url;}}else{if(this.url==ILaya.SoundManager._bgMusic){AudioSound._initMusicAudio();tAd=AudioSound._musicAudio;tAd.src=this.url;}else{tAd=tAd?tAd:ad.cloneNode(true);}}var channel=new AudioSoundChannel(tAd);channel.url=this.url;channel.loops=loops;channel.startTime=startTime;channel.play();ILaya.SoundManager.addChannel(channel);return channel;}},{key:"duration",get:function get(){var ad;ad=AudioSound._audioCache[this.url];if(!ad)return 0;return ad.duration;}}],[{key:"_initMusicAudio",value:function _initMusicAudio(){if(AudioSound._musicAudio)return;if(!AudioSound._musicAudio)AudioSound._musicAudio=Browser.createElement("audio");if(!Render.isConchApp){Browser.document.addEventListener("mousedown",AudioSound._makeMusicOK);}}},{key:"_makeMusicOK",value:function _makeMusicOK(){Browser.document.removeEventListener("mousedown",AudioSound._makeMusicOK);if(!AudioSound._musicAudio.src){AudioSound._musicAudio.src="";AudioSound._musicAudio.load();}else{AudioSound._musicAudio.play();}}}]);return AudioSound;}(EventDispatcher);AudioSound._audioCache={};var WebAudioSoundChannel=function(_SoundChannel2){_inherits(WebAudioSoundChannel,_SoundChannel2);function WebAudioSoundChannel(){_classCallCheck(this,WebAudioSoundChannel);var _this37=_possibleConstructorReturn(this,(WebAudioSoundChannel.__proto__||Object.getPrototypeOf(WebAudioSoundChannel)).call(this));_this37.bufferSource=null;_this37._currentTime=0;_this37._volume=1;_this37._startTime=0;_this37._pauseTime=0;_this37.context=ILaya.WebAudioSound.ctx;_this37._onPlayEnd=Utils.bind(_this37.__onPlayEnd,_this37);if(_this37.context["createGain"]){_this37.gain=_this37.context["createGain"]();}else{_this37.gain=_this37.context["createGainNode"]();}return _this37;}_createClass(WebAudioSoundChannel,[{key:"play",value:function play(){ILaya.SoundManager.addChannel(this);this.isStopped=false;this._clearBufferSource();if(!this.audioBuffer)return;if(this.startTime>=this.duration)return stop();var context=this.context;var gain=this.gain;var bufferSource=context.createBufferSource();this.bufferSource=bufferSource;bufferSource.buffer=this.audioBuffer;bufferSource.connect(gain);if(gain)gain.disconnect();gain.connect(context.destination);bufferSource.onended=this._onPlayEnd;this._startTime=Browser.now();if(this.gain.gain.setTargetAtTime){this.gain.gain.setTargetAtTime(this._volume,this.context.currentTime,WebAudioSoundChannel.SetTargetDelay);}else this.gain.gain.value=this._volume;if(this.loops==0){bufferSource.loop=true;}if(bufferSource.playbackRate.setTargetAtTime){bufferSource.playbackRate.setTargetAtTime(ILaya.SoundManager.playbackRate,this.context.currentTime,WebAudioSoundChannel.SetTargetDelay);}else bufferSource.playbackRate.value=ILaya.SoundManager.playbackRate;bufferSource.start(0,this.startTime);this._currentTime=0;}},{key:"__onPlayEnd",value:function __onPlayEnd(){if(this.loops==1){if(this.completeHandler){ILaya.timer.once(10,this,this.__runComplete,[this.completeHandler],false);this.completeHandler=null;}this.stop();this.event(Event.COMPLETE);return;}if(this.loops>0){this.loops--;}this.startTime=0;this.play();}},{key:"_clearBufferSource",value:function _clearBufferSource(){if(this.bufferSource){var sourceNode=this.bufferSource;if(sourceNode.stop){sourceNode.stop(0);}else{sourceNode.noteOff(0);}sourceNode.disconnect(0);sourceNode.onended=null;if(!WebAudioSoundChannel._tryCleanFailed)this._tryClearBuffer(sourceNode);this.bufferSource=null;}}},{key:"_tryClearBuffer",value:function _tryClearBuffer(sourceNode){if(!Browser.onMac){try{sourceNode.buffer=null;}catch(e){WebAudioSoundChannel._tryCleanFailed=true;}return;}try{sourceNode.buffer=ILaya.WebAudioSound._miniBuffer;}catch(e){WebAudioSoundChannel._tryCleanFailed=true;}}},{key:"stop",value:function stop(){_get(WebAudioSoundChannel.prototype.__proto__||Object.getPrototypeOf(WebAudioSoundChannel.prototype),"stop",this).call(this);this._clearBufferSource();this.audioBuffer=null;if(this.gain)this.gain.disconnect();this.isStopped=true;ILaya.SoundManager.removeChannel(this);this.completeHandler=null;if(ILaya.SoundManager.autoReleaseSound)ILaya.SoundManager.disposeSoundLater(this.url);}},{key:"pause",value:function pause(){if(!this.isStopped){this._pauseTime=this.position;}this._clearBufferSource();if(this.gain)this.gain.disconnect();this.isStopped=true;ILaya.SoundManager.removeChannel(this);if(ILaya.SoundManager.autoReleaseSound)ILaya.SoundManager.disposeSoundLater(this.url);}},{key:"resume",value:function resume(){this.startTime=this._pauseTime;this.play();}},{key:"position",get:function get(){if(this.bufferSource){return(Browser.now()-this._startTime)/1000+this.startTime;}return 0;}},{key:"duration",get:function get(){if(this.audioBuffer){return this.audioBuffer.duration;}return 0;}},{key:"volume",set:function set(v){this._volume=v;if(this.isStopped){return;}if(this.gain.gain.setTargetAtTime){this.gain.gain.setTargetAtTime(v,this.context.currentTime,WebAudioSoundChannel.SetTargetDelay);}else this.gain.gain.value=v;},get:function get(){return this._volume;}}]);return WebAudioSoundChannel;}(SoundChannel);WebAudioSoundChannel._tryCleanFailed=false;WebAudioSoundChannel.SetTargetDelay=0.001;var WebAudioSound=function(_EventDispatcher6){_inherits(WebAudioSound,_EventDispatcher6);function WebAudioSound(){_classCallCheck(this,WebAudioSound);var _this38=_possibleConstructorReturn(this,(WebAudioSound.__proto__||Object.getPrototypeOf(WebAudioSound)).apply(this,arguments));_this38.loaded=false;_this38._disposed=false;return _this38;}_createClass(WebAudioSound,[{key:"load",value:function load(url){var me=this;url=URL.formatURL(url);this.url=url;this.audioBuffer=WebAudioSound._dataCache[url];if(this.audioBuffer){this._loaded(this.audioBuffer);return;}WebAudioSound.e.on("loaded:"+url,this,this._loaded);WebAudioSound.e.on("err:"+url,this,this._err);if(WebAudioSound.__loadingSound[url]){return;}WebAudioSound.__loadingSound[url]=true;var request=new XMLHttpRequest();request.open("GET",url,true);request.responseType="arraybuffer";request.onload=function(){if(me._disposed){me._removeLoadEvents();return;}me.data=request.response;WebAudioSound.buffs.push({"buffer":me.data,"url":me.url});WebAudioSound.decode();};request.onerror=function(e){me._err();};request.send();}},{key:"_err",value:function _err(){this._removeLoadEvents();WebAudioSound.__loadingSound[this.url]=false;this.event(Event.ERROR);}},{key:"_loaded",value:function _loaded(audioBuffer){this._removeLoadEvents();if(this._disposed){return;}this.audioBuffer=audioBuffer;WebAudioSound._dataCache[this.url]=this.audioBuffer;this.loaded=true;this.event(Event.COMPLETE);}},{key:"_removeLoadEvents",value:function _removeLoadEvents(){WebAudioSound.e.off("loaded:"+this.url,this,this._loaded);WebAudioSound.e.off("err:"+this.url,this,this._err);}},{key:"__playAfterLoaded",value:function __playAfterLoaded(){if(!this.__toPlays)return;var i,len;var toPlays;toPlays=this.__toPlays;len=toPlays.length;var tParams;for(i=0;i<len;i++){tParams=toPlays[i];if(tParams[2]&&!tParams[2].isStopped){this.play(tParams[0],tParams[1],tParams[2]);}}this.__toPlays.length=0;}},{key:"play",value:function play(){var startTime=arguments.length>0&&arguments[0]!==undefined?arguments[0]:0;var loops=arguments.length>1&&arguments[1]!==undefined?arguments[1]:0;var channel=arguments.length>2&&arguments[2]!==undefined?arguments[2]:null;channel=channel?channel:new WebAudioSoundChannel();if(!this.audioBuffer){if(this.url){if(!this.__toPlays)this.__toPlays=[];this.__toPlays.push([startTime,loops,channel]);this.once(Event.COMPLETE,this,this.__playAfterLoaded);this.load(this.url);}}channel.url=this.url;channel.loops=loops;channel["audioBuffer"]=this.audioBuffer;channel.startTime=startTime;channel.play();ILaya.SoundManager.addChannel(channel);return channel;}},{key:"dispose",value:function dispose(){this._disposed=true;delete WebAudioSound._dataCache[this.url];delete WebAudioSound.__loadingSound[this.url];this.audioBuffer=null;this.data=null;this.__toPlays=[];}},{key:"duration",get:function get(){if(this.audioBuffer){return this.audioBuffer.duration;}return 0;}}],[{key:"decode",value:function decode(){if(WebAudioSound.buffs.length<=0||WebAudioSound.isDecoding){return;}WebAudioSound.isDecoding=true;WebAudioSound.tInfo=WebAudioSound.buffs.shift();WebAudioSound.ctx.decodeAudioData(WebAudioSound.tInfo["buffer"],WebAudioSound._done,WebAudioSound._fail);}},{key:"_done",value:function _done(audioBuffer){WebAudioSound.e.event("loaded:"+WebAudioSound.tInfo.url,audioBuffer);WebAudioSound.isDecoding=false;WebAudioSound.decode();}},{key:"_fail",value:function _fail(){WebAudioSound.e.event("err:"+WebAudioSound.tInfo.url,null);WebAudioSound.isDecoding=false;WebAudioSound.decode();}},{key:"_playEmptySound",value:function _playEmptySound(){if(WebAudioSound.ctx==null){return;}var source=WebAudioSound.ctx.createBufferSource();source.buffer=WebAudioSound._miniBuffer;source.connect(WebAudioSound.ctx.destination);source.start(0,0,0);}},{key:"_unlock",value:function _unlock(){if(WebAudioSound._unlocked){return;}WebAudioSound._playEmptySound();if(WebAudioSound.ctx.state=="running"){window.document.removeEventListener("mousedown",WebAudioSound._unlock,true);window.document.removeEventListener("touchend",WebAudioSound._unlock,true);window.document.removeEventListener("touchstart",WebAudioSound._unlock,true);WebAudioSound._unlocked=true;}}},{key:"initWebAudio",value:function initWebAudio(){if(WebAudioSound.ctx.state!="running"){WebAudioSound._unlock();window.document.addEventListener("mousedown",WebAudioSound._unlock,true);window.document.addEventListener("touchend",WebAudioSound._unlock,true);window.document.addEventListener("touchstart",WebAudioSound._unlock,true);}}}]);return WebAudioSound;}(EventDispatcher);WebAudioSound._dataCache={};WebAudioSound.webAudioEnabled=window["AudioContext"]||window["webkitAudioContext"]||window["mozAudioContext"];WebAudioSound.ctx=WebAudioSound.webAudioEnabled?new(window["AudioContext"]||window["webkitAudioContext"]||window["mozAudioContext"])():undefined;WebAudioSound.buffs=[];WebAudioSound.isDecoding=false;WebAudioSound._miniBuffer=WebAudioSound.ctx?WebAudioSound.ctx.createBuffer(1,1,22050):undefined;WebAudioSound.e=new EventDispatcher();WebAudioSound._unlocked=false;WebAudioSound.__loadingSound={};var SoundManager=function(){function SoundManager(){_classCallCheck(this,SoundManager);}_createClass(SoundManager,null,[{key:"__init__",value:function __init__(){var win=ILaya.Browser.window;var supportWebAudio=win["AudioContext"]||win["webkitAudioContext"]||win["mozAudioContext"]?true:false;if(supportWebAudio)WebAudioSound.initWebAudio();SoundManager._soundClass=supportWebAudio?WebAudioSound:AudioSound;AudioSound._initMusicAudio();SoundManager._musicClass=AudioSound;return supportWebAudio;}},{key:"addChannel",value:function addChannel(channel){if(SoundManager._channels.indexOf(channel)>=0)return;SoundManager._channels.push(channel);}},{key:"removeChannel",value:function removeChannel(channel){var i;for(i=SoundManager._channels.length-1;i>=0;i--){if(SoundManager._channels[i]==channel){SoundManager._channels.splice(i,1);}}}},{key:"disposeSoundLater",value:function disposeSoundLater(url){SoundManager._lastSoundUsedTimeDic[url]=ILaya.Browser.now();if(!SoundManager._isCheckingDispose){SoundManager._isCheckingDispose=true;ILaya.timer.loop(5000,null,SoundManager._checkDisposeSound);}}},{key:"_checkDisposeSound",value:function _checkDisposeSound(){var key;var tTime=ILaya.Browser.now();var hasCheck=false;for(key in SoundManager._lastSoundUsedTimeDic){if(tTime-SoundManager._lastSoundUsedTimeDic[key]>30000){delete SoundManager._lastSoundUsedTimeDic[key];SoundManager.disposeSoundIfNotUsed(key);}else{hasCheck=true;}}if(!hasCheck){SoundManager._isCheckingDispose=false;ILaya.timer.clear(null,SoundManager._checkDisposeSound);}}},{key:"disposeSoundIfNotUsed",value:function disposeSoundIfNotUsed(url){var i;for(i=SoundManager._channels.length-1;i>=0;i--){if(SoundManager._channels[i].url==url){return;}}SoundManager.destroySound(url);}},{key:"_visibilityChange",value:function _visibilityChange(){if(ILaya.stage.isVisibility){SoundManager._stageOnFocus();}else{SoundManager._stageOnBlur();}}},{key:"_stageOnBlur",value:function _stageOnBlur(){SoundManager._isActive=false;if(SoundManager._musicChannel){if(!SoundManager._musicChannel.isStopped){SoundManager._blurPaused=true;SoundManager._musicChannel.pause();}}SoundManager.stopAllSound();ILaya.stage.once(Event.MOUSE_DOWN,null,SoundManager._stageOnFocus);}},{key:"_recoverWebAudio",value:function _recoverWebAudio(){if(WebAudioSound.ctx&&WebAudioSound.ctx.state!="running"&&WebAudioSound.ctx.resume)WebAudioSound.ctx.resume();}},{key:"_stageOnFocus",value:function _stageOnFocus(){SoundManager._isActive=true;SoundManager._recoverWebAudio();ILaya.stage.off(Event.MOUSE_DOWN,null,SoundManager._stageOnFocus);if(SoundManager._blurPaused){if(SoundManager._musicChannel&&SoundManager._musicChannel.isStopped){SoundManager._blurPaused=false;SoundManager._musicChannel.resume();}}}},{key:"playSound",value:function playSound(url){var loops=arguments.length>1&&arguments[1]!==undefined?arguments[1]:1;var complete=arguments.length>2&&arguments[2]!==undefined?arguments[2]:null;var soundClass=arguments.length>3&&arguments[3]!==undefined?arguments[3]:null;var startTime=arguments.length>4&&arguments[4]!==undefined?arguments[4]:0;if(!SoundManager._isActive||!url)return null;if(SoundManager._muted)return null;SoundManager._recoverWebAudio();url=URL.formatURL(url);if(url==SoundManager._bgMusic){if(SoundManager._musicMuted)return null;}else{if(ILaya.Render.isConchApp){var ext=Utils.getFileExtension(url);if(ext!="wav"&&ext!="ogg"){alert("The sound only supports wav or ogg format,for optimal performance reason,please refer to the official website document.");return null;}}if(SoundManager._soundMuted)return null;}var tSound;if(!ILaya.Browser.onBDMiniGame&&!ILaya.Browser.onMiniGame&&!ILaya.Browser.onKGMiniGame&&!ILaya.Browser.onQGMiniGame&&!ILaya.Browser.onVVMiniGame&&!ILaya.Browser.onAlipayMiniGame&&!ILaya.Browser.onQQMiniGame){tSound=ILaya.loader.getRes(url);}if(!soundClass)soundClass=SoundManager._soundClass;if(!tSound){tSound=new soundClass();tSound.load(url);if(!ILaya.Browser.onBDMiniGame&&!ILaya.Browser.onMiniGame&&!ILaya.Browser.onKGMiniGame&&!ILaya.Browser.onQGMiniGame&&!ILaya.Browser.onVVMiniGame&&!ILaya.Browser.onAlipayMiniGame&&!ILaya.Browser.onQQMiniGame){ILaya.Loader.cacheRes(url,tSound);}}var channel;channel=tSound.play(startTime,loops);if(!channel)return null;channel.url=url;channel.volume=url==SoundManager._bgMusic?SoundManager.musicVolume:SoundManager.soundVolume;channel.completeHandler=complete;return channel;}},{key:"destroySound",value:function destroySound(url){var tSound=ILaya.loader.getRes(url);if(tSound){ILaya.Loader.clearRes(url);tSound.dispose();}}},{key:"playMusic",value:function playMusic(url){var loops=arguments.length>1&&arguments[1]!==undefined?arguments[1]:0;var complete=arguments.length>2&&arguments[2]!==undefined?arguments[2]:null;var startTime=arguments.length>3&&arguments[3]!==undefined?arguments[3]:0;url=URL.formatURL(url);SoundManager._bgMusic=url;if(SoundManager._musicChannel)SoundManager._musicChannel.stop();return SoundManager._musicChannel=SoundManager.playSound(url,loops,complete,SoundManager._musicClass,startTime);}},{key:"stopSound",value:function stopSound(url){url=URL.formatURL(url);var i;var channel;for(i=SoundManager._channels.length-1;i>=0;i--){channel=SoundManager._channels[i];if(channel.url==url){channel.stop();}}}},{key:"stopAll",value:function stopAll(){SoundManager._bgMusic=null;var i;var channel;for(i=SoundManager._channels.length-1;i>=0;i--){channel=SoundManager._channels[i];channel.stop();}}},{key:"stopAllSound",value:function stopAllSound(){var i;var channel;for(i=SoundManager._channels.length-1;i>=0;i--){channel=SoundManager._channels[i];if(channel.url!=SoundManager._bgMusic){channel.stop();}}}},{key:"stopMusic",value:function stopMusic(){if(SoundManager._musicChannel)SoundManager._musicChannel.stop();SoundManager._bgMusic=null;}},{key:"setSoundVolume",value:function setSoundVolume(volume){var url=arguments.length>1&&arguments[1]!==undefined?arguments[1]:null;if(url){url=URL.formatURL(url);SoundManager._setVolume(url,volume);}else{SoundManager.soundVolume=volume;var i;var channel;for(i=SoundManager._channels.length-1;i>=0;i--){channel=SoundManager._channels[i];if(channel.url!=SoundManager._bgMusic){channel.volume=volume;}}}}},{key:"setMusicVolume",value:function setMusicVolume(volume){SoundManager.musicVolume=volume;SoundManager._setVolume(SoundManager._bgMusic,volume);}},{key:"_setVolume",value:function _setVolume(url,volume){url=URL.formatURL(url);var i;var channel;for(i=SoundManager._channels.length-1;i>=0;i--){channel=SoundManager._channels[i];if(channel.url==url){channel.volume=volume;}}}},{key:"autoStopMusic",set:function set(v){ILaya.stage.off(Event.BLUR,null,SoundManager._stageOnBlur);ILaya.stage.off(Event.FOCUS,null,SoundManager._stageOnFocus);ILaya.stage.off(Event.VISIBILITY_CHANGE,null,SoundManager._visibilityChange);SoundManager._autoStopMusic=v;if(v){ILaya.stage.on(Event.BLUR,null,SoundManager._stageOnBlur);ILaya.stage.on(Event.FOCUS,null,SoundManager._stageOnFocus);ILaya.stage.on(Event.VISIBILITY_CHANGE,null,SoundManager._visibilityChange);}},get:function get(){return SoundManager._autoStopMusic;}},{key:"muted",set:function set(value){if(value==SoundManager._muted)return;if(value){SoundManager.stopAllSound();}SoundManager.musicMuted=value;SoundManager._muted=value;},get:function get(){return SoundManager._muted;}},{key:"soundMuted",set:function set(value){SoundManager._soundMuted=value;},get:function get(){return SoundManager._soundMuted;}},{key:"musicMuted",set:function set(value){if(value==SoundManager._musicMuted)return;if(value){if(SoundManager._bgMusic){if(SoundManager._musicChannel&&!SoundManager._musicChannel.isStopped){if(ILaya.Render.isConchApp){if(SoundManager._musicChannel._audio)SoundManager._musicChannel._audio.muted=true;}else{SoundManager._musicChannel.pause();}}else{SoundManager._musicChannel=null;}}else{SoundManager._musicChannel=null;}SoundManager._musicMuted=value;}else{SoundManager._musicMuted=value;if(SoundManager._bgMusic){if(SoundManager._musicChannel){if(ILaya.Render.isConchApp){if(SoundManager._musicChannel._audio)SoundManager._musicChannel._audio.muted=false;}else{SoundManager._musicChannel.resume();}}}}},get:function get(){return SoundManager._musicMuted;}},{key:"useAudioMusic",get:function get(){return SoundManager._useAudioMusic;},set:function set(value){SoundManager._useAudioMusic=value;if(value){SoundManager._musicClass=AudioSound;}else{SoundManager._musicClass=null;}}}]);return SoundManager;}();SoundManager.musicVolume=1;SoundManager.soundVolume=1;SoundManager.playbackRate=1;SoundManager._useAudioMusic=true;SoundManager._muted=false;SoundManager._soundMuted=false;SoundManager._musicMuted=false;SoundManager._bgMusic=null;SoundManager._musicChannel=null;SoundManager._channels=[];SoundManager._blurPaused=false;SoundManager._isActive=true;SoundManager._lastSoundUsedTimeDic={};SoundManager._isCheckingDispose=false;SoundManager.autoReleaseSound=true;var Prefab=function(){function Prefab(){_classCallCheck(this,Prefab);}_createClass(Prefab,[{key:"create",value:function create(){if(this.json)return ILaya.SceneUtils.createByData(null,this.json);return null;}}]);return Prefab;}();var Byte=function(){function Byte(){var data=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;_classCallCheck(this,Byte);this._xd_=true;this._allocated_=8;this._pos_=0;this._length=0;if(data){this._u8d_=new Uint8Array(data);this._d_=new DataView(this._u8d_.buffer);this._length=this._d_.byteLength;}else{this._resizeBuffer(this._allocated_);}}_createClass(Byte,[{key:"_resizeBuffer",value:function _resizeBuffer(len){try{var newByteView=new Uint8Array(len);if(this._u8d_!=null){if(this._u8d_.length<=len)newByteView.set(this._u8d_);else newByteView.set(this._u8d_.subarray(0,len));}this._u8d_=newByteView;this._d_=new DataView(newByteView.buffer);}catch(err){throw"Invalid typed array length:"+len;}}},{key:"getString",value:function getString(){return this.readString();}},{key:"readString",value:function readString(){return this._rUTF(this.getUint16());}},{key:"getFloat32Array",value:function getFloat32Array(start,len){return this.readFloat32Array(start,len);}},{key:"readFloat32Array",value:function readFloat32Array(start,len){var end=start+len;end=end>this._length?this._length:end;var v=new Float32Array(this._d_.buffer.slice(start,end));this._pos_=end;return v;}},{key:"getUint8Array",value:function getUint8Array(start,len){return this.readUint8Array(start,len);}},{key:"readUint8Array",value:function readUint8Array(start,len){var end=start+len;end=end>this._length?this._length:end;var v=new Uint8Array(this._d_.buffer.slice(start,end));this._pos_=end;return v;}},{key:"getInt16Array",value:function getInt16Array(start,len){return this.readInt16Array(start,len);}},{key:"readInt16Array",value:function readInt16Array(start,len){var end=start+len;end=end>this._length?this._length:end;var v=new Int16Array(this._d_.buffer.slice(start,end));this._pos_=end;return v;}},{key:"getFloat32",value:function getFloat32(){return this.readFloat32();}},{key:"readFloat32",value:function readFloat32(){if(this._pos_+4>this._length)throw"getFloat32 error - Out of bounds";var v=this._d_.getFloat32(this._pos_,this._xd_);this._pos_+=4;return v;}},{key:"getFloat64",value:function getFloat64(){return this.readFloat64();}},{key:"readFloat64",value:function readFloat64(){if(this._pos_+8>this._length)throw"getFloat64 error - Out of bounds";var v=this._d_.getFloat64(this._pos_,this._xd_);this._pos_+=8;return v;}},{key:"writeFloat32",value:function writeFloat32(value){this._ensureWrite(this._pos_+4);this._d_.setFloat32(this._pos_,value,this._xd_);this._pos_+=4;}},{key:"writeFloat64",value:function writeFloat64(value){this._ensureWrite(this._pos_+8);this._d_.setFloat64(this._pos_,value,this._xd_);this._pos_+=8;}},{key:"getInt32",value:function getInt32(){return this.readInt32();}},{key:"readInt32",value:function readInt32(){if(this._pos_+4>this._length)throw"getInt32 error - Out of bounds";var float=this._d_.getInt32(this._pos_,this._xd_);this._pos_+=4;return float;}},{key:"getUint32",value:function getUint32(){return this.readUint32();}},{key:"readUint32",value:function readUint32(){if(this._pos_+4>this._length)throw"getUint32 error - Out of bounds";var v=this._d_.getUint32(this._pos_,this._xd_);this._pos_+=4;return v;}},{key:"writeInt32",value:function writeInt32(value){this._ensureWrite(this._pos_+4);this._d_.setInt32(this._pos_,value,this._xd_);this._pos_+=4;}},{key:"writeUint32",value:function writeUint32(value){this._ensureWrite(this._pos_+4);this._d_.setUint32(this._pos_,value,this._xd_);this._pos_+=4;}},{key:"getInt16",value:function getInt16(){return this.readInt16();}},{key:"readInt16",value:function readInt16(){if(this._pos_+2>this._length)throw"getInt16 error - Out of bounds";var us=this._d_.getInt16(this._pos_,this._xd_);this._pos_+=2;return us;}},{key:"getUint16",value:function getUint16(){return this.readUint16();}},{key:"readUint16",value:function readUint16(){if(this._pos_+2>this._length)throw"getUint16 error - Out of bounds";var us=this._d_.getUint16(this._pos_,this._xd_);this._pos_+=2;return us;}},{key:"writeUint16",value:function writeUint16(value){this._ensureWrite(this._pos_+2);this._d_.setUint16(this._pos_,value,this._xd_);this._pos_+=2;}},{key:"writeInt16",value:function writeInt16(value){this._ensureWrite(this._pos_+2);this._d_.setInt16(this._pos_,value,this._xd_);this._pos_+=2;}},{key:"getUint8",value:function getUint8(){return this.readUint8();}},{key:"readUint8",value:function readUint8(){if(this._pos_+1>this._length)throw"getUint8 error - Out of bounds";return this._u8d_[this._pos_++];}},{key:"writeUint8",value:function writeUint8(value){this._ensureWrite(this._pos_+1);this._d_.setUint8(this._pos_,value);this._pos_++;}},{key:"_getUInt8",value:function _getUInt8(pos){return this._readUInt8(pos);}},{key:"_readUInt8",value:function _readUInt8(pos){return this._d_.getUint8(pos);}},{key:"_getUint16",value:function _getUint16(pos){return this._readUint16(pos);}},{key:"_readUint16",value:function _readUint16(pos){return this._d_.getUint16(pos,this._xd_);}},{key:"_getMatrix",value:function _getMatrix(){return this._readMatrix();}},{key:"_readMatrix",value:function _readMatrix(){var rst=new Matrix(this.getFloat32(),this.getFloat32(),this.getFloat32(),this.getFloat32(),this.getFloat32(),this.getFloat32());return rst;}},{key:"_rUTF",value:function _rUTF(len){var max=this._pos_+len,c,c2,c3,f=String.fromCharCode;var u=this._u8d_;var strs=[];var n=0;strs.length=1000;while(this._pos_<max){c=u[this._pos_++];if(c<0x80){if(c!=0)strs[n++]=f(c);}else if(c<0xE0){strs[n++]=f((c&0x3F)<<6|u[this._pos_++]&0x7F);}else if(c<0xF0){c2=u[this._pos_++];strs[n++]=f((c&0x1F)<<12|(c2&0x7F)<<6|u[this._pos_++]&0x7F);}else{c2=u[this._pos_++];c3=u[this._pos_++];var _code=(c&0x0F)<<18|(c2&0x7F)<<12|(c3&0x7F)<<6|u[this._pos_++]&0x7F;if(_code>=0x10000){var _offset=_code-0x10000;var _lead=0xd800|_offset>>10;var _trail=0xdc00|_offset&0x3ff;strs[n++]=f(_lead);strs[n++]=f(_trail);}else{strs[n++]=f(_code);}}}strs.length=n;return strs.join('');}},{key:"getCustomString",value:function getCustomString(len){return this.readCustomString(len);}},{key:"readCustomString",value:function readCustomString(len){var v="",ulen=0,c,c2,f=String.fromCharCode;var u=this._u8d_;while(len>0){c=u[this._pos_];if(c<0x80){v+=f(c);this._pos_++;len--;}else{ulen=c-0x80;this._pos_++;len-=ulen;while(ulen>0){c=u[this._pos_++];c2=u[this._pos_++];v+=f(c2<<8|c);ulen--;}}}return v;}},{key:"clear",value:function clear(){this._pos_=0;this.length=0;}},{key:"__getBuffer",value:function __getBuffer(){return this._d_.buffer;}},{key:"writeUTFBytes",value:function writeUTFBytes(value){value=value+"";for(var i=0,sz=value.length;i<sz;i++){var c=value.charCodeAt(i);if(c<=0x7F){this.writeByte(c);}else if(c<=0x7FF){this._ensureWrite(this._pos_+2);this._u8d_.set([0xC0|c>>6,0x80|c&0x3F],this._pos_);this._pos_+=2;}else if(c>=0xD800&&c<=0xDBFF){i++;var c2=value.charCodeAt(i);if(!Number.isNaN(c2)&&c2>=0xDC00&&c2<=0xDFFF){var _p1=(c&0x3FF)+0x40;var _p2=c2&0x3FF;var _b1=0xF0|_p1>>8&0x3F;var _b2=0x80|_p1>>2&0x3F;var _b3=0x80|(_p1&0x3)<<4|_p2>>6&0xF;var _b4=0x80|_p2&0x3F;this._ensureWrite(this._pos_+4);this._u8d_.set([_b1,_b2,_b3,_b4],this._pos_);this._pos_+=4;}}else if(c<=0xFFFF){this._ensureWrite(this._pos_+3);this._u8d_.set([0xE0|c>>12,0x80|c>>6&0x3F,0x80|c&0x3F],this._pos_);this._pos_+=3;}else{this._ensureWrite(this._pos_+4);this._u8d_.set([0xF0|c>>18,0x80|c>>12&0x3F,0x80|c>>6&0x3F,0x80|c&0x3F],this._pos_);this._pos_+=4;}}}},{key:"writeUTFString",value:function writeUTFString(value){var tPos=this.pos;this.writeUint16(1);this.writeUTFBytes(value);var dPos=this.pos-tPos-2;this._d_.setUint16(tPos,dPos,this._xd_);}},{key:"readUTFString",value:function readUTFString(){return this.readUTFBytes(this.getUint16());}},{key:"getUTFString",value:function getUTFString(){return this.readUTFString();}},{key:"readUTFBytes",value:function readUTFBytes(){var len=arguments.length>0&&arguments[0]!==undefined?arguments[0]:-1;if(len===0)return"";var lastBytes=this.bytesAvailable;if(len>lastBytes)throw"readUTFBytes error - Out of bounds";len=len>0?len:lastBytes;return this._rUTF(len);}},{key:"getUTFBytes",value:function getUTFBytes(){var len=arguments.length>0&&arguments[0]!==undefined?arguments[0]:-1;return this.readUTFBytes(len);}},{key:"writeByte",value:function writeByte(value){this._ensureWrite(this._pos_+1);this._d_.setInt8(this._pos_,value);this._pos_+=1;}},{key:"readByte",value:function readByte(){if(this._pos_+1>this._length)throw"readByte error - Out of bounds";return this._d_.getInt8(this._pos_++);}},{key:"getByte",value:function getByte(){return this.readByte();}},{key:"_ensureWrite",value:function _ensureWrite(lengthToEnsure){if(this._length<lengthToEnsure)this._length=lengthToEnsure;if(this._allocated_<lengthToEnsure)this.length=lengthToEnsure;}},{key:"writeArrayBuffer",value:function writeArrayBuffer(arraybuffer){var offset=arguments.length>1&&arguments[1]!==undefined?arguments[1]:0;var length=arguments.length>2&&arguments[2]!==undefined?arguments[2]:0;if(offset<0||length<0)throw"writeArrayBuffer error - Out of bounds";if(length==0)length=arraybuffer.byteLength-offset;this._ensureWrite(this._pos_+length);var uint8array=new Uint8Array(arraybuffer);this._u8d_.set(uint8array.subarray(offset,offset+length),this._pos_);this._pos_+=length;}},{key:"readArrayBuffer",value:function readArrayBuffer(length){var rst;rst=this._u8d_.buffer.slice(this._pos_,this._pos_+length);this._pos_=this._pos_+length;return rst;}},{key:"buffer",get:function get(){var rstBuffer=this._d_.buffer;if(rstBuffer.byteLength===this._length)return rstBuffer;return rstBuffer.slice(0,this._length);}},{key:"endian",get:function get(){return this._xd_?Byte.LITTLE_ENDIAN:Byte.BIG_ENDIAN;},set:function set(value){this._xd_=value===Byte.LITTLE_ENDIAN;}},{key:"length",set:function set(value){if(this._allocated_<value)this._resizeBuffer(this._allocated_=Math.floor(Math.max(value,this._allocated_*2)));else if(this._allocated_>value)this._resizeBuffer(this._allocated_=value);this._length=value;},get:function get(){return this._length;}},{key:"pos",get:function get(){return this._pos_;},set:function set(value){this._pos_=value;}},{key:"bytesAvailable",get:function get(){return this._length-this._pos_;}}],[{key:"getSystemEndian",value:function getSystemEndian(){if(!Byte._sysEndian){var buffer=new ArrayBuffer(2);new DataView(buffer).setInt16(0,256,true);Byte._sysEndian=new Int16Array(buffer)[0]===256?Byte.LITTLE_ENDIAN:Byte.BIG_ENDIAN;}return Byte._sysEndian;}}]);return Byte;}();Byte.BIG_ENDIAN="bigEndian";Byte.LITTLE_ENDIAN="littleEndian";Byte._sysEndian=null;var BitmapFont=function(){function BitmapFont(){_classCallCheck(this,BitmapFont);this._fontCharDic={};this._fontWidthMap={};this._maxWidth=0;this._spaceWidth=10;this.fontSize=12;this.autoScaleSize=false;this.letterSpacing=0;}_createClass(BitmapFont,[{key:"loadFont",value:function loadFont(path,complete){this._path=path;this._complete=complete;if(!path||path.indexOf(".fnt")===-1){console.error('Bitmap font configuration information must be a ".fnt" file');return;}ILaya.loader.load([{url:path,type:ILaya.Loader.XML},{url:path.replace(".fnt",".png"),type:ILaya.Loader.IMAGE}],Handler.create(this,this._onLoaded));}},{key:"_onLoaded",value:function _onLoaded(){this.parseFont(ILaya.Loader.getRes(this._path),ILaya.Loader.getRes(this._path.replace(".fnt",".png")));this._complete&&this._complete.run();}},{key:"parseFont",value:function parseFont(xml,texture){if(xml==null||texture==null)return;this._texture=texture;var tScale=1;var tInfo=xml.getElementsByTagName("info");if(!tInfo[0].getAttributeNode){return this.parseFont2(xml,texture);}this.fontSize=parseInt(tInfo[0].getAttributeNode("size").nodeValue);var tPadding=tInfo[0].getAttributeNode("padding").nodeValue;var tPaddingArray=tPadding.split(",");this._padding=[parseInt(tPaddingArray[0]),parseInt(tPaddingArray[1]),parseInt(tPaddingArray[2]),parseInt(tPaddingArray[3])];var chars=xml.getElementsByTagName("char");var i=0;for(i=0;i<chars.length;i++){var tAttribute=chars[i];var tId=parseInt(tAttribute.getAttributeNode("id").nodeValue);var xOffset=parseInt(tAttribute.getAttributeNode("xoffset").nodeValue)/tScale;var yOffset=parseInt(tAttribute.getAttributeNode("yoffset").nodeValue)/tScale;var xAdvance=parseInt(tAttribute.getAttributeNode("xadvance").nodeValue)/tScale;var region=new Rectangle();region.x=parseInt(tAttribute.getAttributeNode("x").nodeValue);region.y=parseInt(tAttribute.getAttributeNode("y").nodeValue);region.width=parseInt(tAttribute.getAttributeNode("width").nodeValue);region.height=parseInt(tAttribute.getAttributeNode("height").nodeValue);var tTexture=Texture.create(texture,region.x,region.y,region.width,region.height,xOffset,yOffset);this._maxWidth=Math.max(this._maxWidth,xAdvance+this.letterSpacing);this._fontCharDic[tId]=tTexture;this._fontWidthMap[tId]=xAdvance;}}},{key:"parseFont2",value:function parseFont2(xml,texture){if(xml==null||texture==null)return;this._texture=texture;var tScale=1;var tInfo=xml.getElementsByTagName("info");this.fontSize=parseInt(tInfo[0].attributes["size"].nodeValue);var tPadding=tInfo[0].attributes["padding"].nodeValue;var tPaddingArray=tPadding.split(",");this._padding=[parseInt(tPaddingArray[0]),parseInt(tPaddingArray[1]),parseInt(tPaddingArray[2]),parseInt(tPaddingArray[3])];var chars=xml.getElementsByTagName("char");var i=0;for(i=0;i<chars.length;i++){var tAttribute=chars[i].attributes;var tId=parseInt(tAttribute["id"].nodeValue);var xOffset=parseInt(tAttribute["xoffset"].nodeValue)/tScale;var yOffset=parseInt(tAttribute["yoffset"].nodeValue)/tScale;var xAdvance=parseInt(tAttribute["xadvance"].nodeValue)/tScale;var region=new Rectangle();region.x=parseInt(tAttribute["x"].nodeValue);region.y=parseInt(tAttribute["y"].nodeValue);region.width=parseInt(tAttribute["width"].nodeValue);region.height=parseInt(tAttribute["height"].nodeValue);var tTexture=Texture.create(texture,region.x,region.y,region.width,region.height,xOffset,yOffset);this._maxWidth=Math.max(this._maxWidth,xAdvance+this.letterSpacing);this._fontCharDic[tId]=tTexture;this._fontWidthMap[tId]=xAdvance;}}},{key:"getCharTexture",value:function getCharTexture(char){return this._fontCharDic[char.charCodeAt(0)];}},{key:"destroy",value:function destroy(){if(this._texture){for(var p in this._fontCharDic){var tTexture=this._fontCharDic[p];if(tTexture)tTexture.destroy();}this._texture.destroy();this._fontCharDic=null;this._fontWidthMap=null;this._texture=null;this._complete=null;this._padding=null;}}},{key:"setSpaceWidth",value:function setSpaceWidth(spaceWidth){this._spaceWidth=spaceWidth;}},{key:"getCharWidth",value:function getCharWidth(char){var code=char.charCodeAt(0);if(this._fontWidthMap[code])return this._fontWidthMap[code]+this.letterSpacing;if(char===" ")return this._spaceWidth+this.letterSpacing;return 0;}},{key:"getTextWidth",value:function getTextWidth(text){var tWidth=0;for(var i=0,n=text.length;i<n;i++){tWidth+=this.getCharWidth(text.charAt(i));}return tWidth;}},{key:"getMaxWidth",value:function getMaxWidth(){return this._maxWidth;}},{key:"getMaxHeight",value:function getMaxHeight(){return this.fontSize;}},{key:"_drawText",value:function _drawText(text,sprite,drawX,drawY,align,width){var tWidth=this.getTextWidth(text);var tTexture;var dx=0;align==="center"&&(dx=(width-tWidth)/2);align==="right"&&(dx=width-tWidth);var tx=0;for(var i=0,n=text.length;i<n;i++){tTexture=this.getCharTexture(text.charAt(i));if(tTexture){sprite.graphics.drawImage(tTexture,drawX+tx+dx,drawY);tx+=this.getCharWidth(text.charAt(i));}}}}]);return BitmapFont;}();ClassUtils.regClass("laya.display.BitmapFont",BitmapFont);ClassUtils.regClass("Laya.BitmapFont",BitmapFont);var HttpRequest=function(_EventDispatcher7){_inherits(HttpRequest,_EventDispatcher7);function HttpRequest(){_classCallCheck(this,HttpRequest);var _this39=_possibleConstructorReturn(this,(HttpRequest.__proto__||Object.getPrototypeOf(HttpRequest)).apply(this,arguments));_this39._http=new XMLHttpRequest();return _this39;}_createClass(HttpRequest,[{key:"send",value:function send(url){var data=arguments.length>1&&arguments[1]!==undefined?arguments[1]:null;var method=arguments.length>2&&arguments[2]!==undefined?arguments[2]:"get";var responseType=arguments.length>3&&arguments[3]!==undefined?arguments[3]:"text";var headers=arguments.length>4&&arguments[4]!==undefined?arguments[4]:null;this._responseType=responseType;this._data=null;if(Browser.onVVMiniGame||Browser.onQGMiniGame||Browser.onQQMiniGame){url=encodeURI(url);}this._url=url;var _this=this;var http=this._http;url=URL.getAdptedFilePath(url);http.open(method,url,true);if(headers){for(var i=0;i<headers.length;i++){http.setRequestHeader(headers[i++],headers[i]);}}else if(!window.conch){if(!data||typeof data=='string')http.setRequestHeader("Content-Type","application/x-www-form-urlencoded");else http.setRequestHeader("Content-Type","application/json");}var restype=responseType!=="arraybuffer"?"text":"arraybuffer";http.responseType=restype;if(http.dataType){http.dataType=restype;}http.onerror=function(e){_this._onError(e);};http.onabort=function(e){_this._onAbort(e);};http.onprogress=function(e){_this._onProgress(e);};http.onload=function(e){_this._onLoad(e);};http.send(data);}},{key:"_onProgress",value:function _onProgress(e){if(e&&e.lengthComputable)this.event(Event.PROGRESS,e.loaded/e.total);}},{key:"_onAbort",value:function _onAbort(e){this.error("Request was aborted by user");}},{key:"_onError",value:function _onError(e){this.error("Request failed Status:"+this._http.status+" text:"+this._http.statusText);}},{key:"_onLoad",value:function _onLoad(e){var http=this._http;var status=http.status!==undefined?http.status:200;if(status===200||status===204||status===0){this.complete();}else{this.error("["+http.status+"]"+http.statusText+":"+http.responseURL);}}},{key:"error",value:function error(message){this.clear();console.warn(this.url,message);this.event(Event.ERROR,message);}},{key:"complete",value:function complete(){this.clear();var flag=true;try{if(this._responseType==="json"){this._data=JSON.parse(this._http.responseText);}else if(this._responseType==="xml"){this._data=Utils.parseXMLFromString(this._http.responseText);}else{this._data=this._http.response||this._http.responseText;}}catch(e){flag=false;this.error(e.message);}flag&&this.event(Event.COMPLETE,this._data instanceof Array?[this._data]:this._data);}},{key:"clear",value:function clear(){var http=this._http;http.onerror=http.onabort=http.onprogress=http.onload=null;}},{key:"url",get:function get(){return this._url;}},{key:"data",get:function get(){return this._data;}},{key:"http",get:function get(){return this._http;}}]);return HttpRequest;}(EventDispatcher);var Loader=function(_EventDispatcher8){_inherits(Loader,_EventDispatcher8);function Loader(){_classCallCheck(this,Loader);var _this40=_possibleConstructorReturn(this,(Loader.__proto__||Object.getPrototypeOf(Loader)).apply(this,arguments));_this40._customParse=false;return _this40;}_createClass(Loader,[{key:"load",value:function load(url){var type=arguments.length>1&&arguments[1]!==undefined?arguments[1]:null;var cache=arguments.length>2&&arguments[2]!==undefined?arguments[2]:true;var group=arguments.length>3&&arguments[3]!==undefined?arguments[3]:null;var ignoreCache=arguments.length>4&&arguments[4]!==undefined?arguments[4]:false;var useWorkerLoader=arguments.length>5&&arguments[5]!==undefined?arguments[5]:ILaya.WorkerLoader.enable;if(!url){this.onLoaded(null);return;}Loader.setGroup(url,"666");this._url=url;if(url.indexOf("data:image")===0)type=Loader.IMAGE;else url=URL.formatURL(url);this._type=type||(type=Loader.getTypeFromUrl(this._url));this._cache=cache;this._useWorkerLoader=useWorkerLoader;this._data=null;if(useWorkerLoader)ILaya.WorkerLoader.enableWorkerLoader();var cacheRes;if(type==Loader.IMAGE)cacheRes=Loader.textureMap[url];else cacheRes=Loader.loadedMap[url];if(!ignoreCache&&cacheRes){this._data=cacheRes;this.event(Event.PROGRESS,1);this.event(Event.COMPLETE,this._data);return;}if(group)Loader.setGroup(url,group);if(Loader.parserMap[type]!=null){this._customParse=true;if(Loader.parserMap[type]instanceof Handler)Loader.parserMap[type].runWith(this);else Loader.parserMap[type].call(null,this);return;}this._loadResourceFilter(type,url);}},{key:"_loadResourceFilter",value:function _loadResourceFilter(type,url){this._loadResource(type,url);}},{key:"_loadResource",value:function _loadResource(type,url){switch(type){case Loader.IMAGE:case"htmlimage":case"nativeimage":this._loadImage(url);break;case Loader.SOUND:this._loadSound(url);break;case Loader.TTF:this._loadTTF(url);break;case Loader.ATLAS:case Loader.PREFAB:case Loader.PLF:this._loadHttpRequestWhat(url,Loader.JSON);break;case Loader.FONT:this._loadHttpRequestWhat(url,Loader.XML);break;case Loader.PLFB:this._loadHttpRequestWhat(url,Loader.BUFFER);break;default:this._loadHttpRequestWhat(url,type);}}},{key:"_loadHttpRequest",value:function _loadHttpRequest(url,contentType,onLoadCaller,onLoad,onProcessCaller,onProcess,onErrorCaller,onError){if(Browser.onVVMiniGame){this._http=new HttpRequest();}else{if(!this._http)this._http=new HttpRequest();}onProcess&&this._http.on(Event.PROGRESS,onProcessCaller,onProcess);onLoad&&this._http.on(Event.COMPLETE,onLoadCaller,onLoad);this._http.on(Event.ERROR,onErrorCaller,onError);this._http.send(url,null,"get",contentType);}},{key:"_loadHtmlImage",value:function _loadHtmlImage(url,onLoadCaller,onLoad,onErrorCaller,onError){var image;function clear(){var img=image;img.onload=null;img.onerror=null;delete Loader._imgCache[url];}var onerror=function onerror(){clear();onError.call(onErrorCaller);};var onload=function onload(){clear();onLoad.call(onLoadCaller,image);};image=new Browser.window.Image();image.crossOrigin="";image.onload=onload;image.onerror=onerror;image.src=url;Loader._imgCache[url]=image;}},{key:"_loadHttpRequestWhat",value:function _loadHttpRequestWhat(url,contentType){if(Loader.preLoadedMap[url])this.onLoaded(Loader.preLoadedMap[url]);else this._loadHttpRequest(url,contentType,this,this.onLoaded,this,this.onProgress,this,this.onError);}},{key:"_loadTTF",value:function _loadTTF(url){url=URL.formatURL(url);var ttfLoader=new ILaya.TTFLoader();ttfLoader.complete=Handler.create(this,this.onLoaded);ttfLoader.load(url);}},{key:"_loadImage",value:function _loadImage(url){var _this41=this;var isformatURL=arguments.length>1&&arguments[1]!==undefined?arguments[1]:true;var _this=this;if(isformatURL)url=URL.formatURL(url);var onLoaded;var onError=function onError(){_this.event(Event.ERROR,"Load image failed");};if(this._type==="nativeimage"){onLoaded=function onLoaded(image){_this41.onLoaded(image);};this._loadHtmlImage(url,this,onLoaded,this,onError);}else{var ext=Utils.getFileExtension(url);if(ext==="ktx"||ext==="pvr"){onLoaded=function onLoaded(imageData){var format=void 0;switch(ext){case"ktx":format=exports.TextureFormat.ETC1RGB;break;case"pvr":format=exports.TextureFormat.PVRTCRGBA_4BPPV;break;default:{console.error('unknown format',ext);return;}}var tex=new Texture2D(0,0,format,false,false);tex.wrapModeU=BaseTexture.WARPMODE_CLAMP;tex.wrapModeV=BaseTexture.WARPMODE_CLAMP;tex.setCompressData(imageData);tex._setCreateURL(url);_this.onLoaded(tex);};this._loadHttpRequest(url,Loader.BUFFER,this,onLoaded,null,null,this,onError);}else{onLoaded=function onLoaded(image){var tex=new Texture2D(image.width,image.height,1,false,false);tex.wrapModeU=BaseTexture.WARPMODE_CLAMP;tex.wrapModeV=BaseTexture.WARPMODE_CLAMP;tex.loadImageSource(image,true);tex._setCreateURL(url);_this.onLoaded(tex);};this._loadHtmlImage(url,this,onLoaded,this,onError);}}}},{key:"_loadSound",value:function _loadSound(url){var sound=new SoundManager._soundClass();var _this=this;sound.on(Event.COMPLETE,this,soundOnload);sound.on(Event.ERROR,this,soundOnErr);sound.load(url);function soundOnload(){clear();_this.onLoaded(sound);}function soundOnErr(){clear();sound.dispose();_this.event(Event.ERROR,"Load sound failed");}function clear(){sound.offAll();}}},{key:"onProgress",value:function onProgress(value){if(this._type===Loader.ATLAS)this.event(Event.PROGRESS,value*0.3);else this.event(Event.PROGRESS,value);}},{key:"onError",value:function onError(message){this.event(Event.ERROR,message);}},{key:"onLoaded",value:function onLoaded(){var data=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;var type=this._type;if(type==Loader.PLFB){this.parsePLFBData(data);this.complete(data);}else if(type==Loader.PLF){this.parsePLFData(data);this.complete(data);}else if(type===Loader.IMAGE){var tex=new Texture(data);tex.url=this._url;this.complete(tex);}else if(type===Loader.SOUND||type==="htmlimage"||type==="nativeimage"){this.complete(data);}else if(type===Loader.ATLAS){if(!(data instanceof Texture2D)){var toloadPics=[];if(!this._data){this._data=data;if(data.meta&&data.meta.image){toloadPics=data.meta.image.split(",");var split=this._url.indexOf("/")>=0?"/":"\\";var idx=this._url.lastIndexOf(split);var folderPath=idx>=0?this._url.substr(0,idx+1):"";var changeType=null;if(Browser.onAndroid&&data.meta.compressTextureAndroid){changeType=".ktx";}if(Browser.onIOS&&data.meta.compressTextureIOS){changeType=".pvr";}for(var i=0,len=toloadPics.length;i<len;i++){if(changeType){toloadPics[i]=folderPath+toloadPics[i].replace(".png",changeType);}else{toloadPics[i]=folderPath+toloadPics[i];}}}else{toloadPics=[this._url.replace(".json",".png")];}toloadPics.reverse();data.toLoads=toloadPics;data.pics=[];}this.event(Event.PROGRESS,0.3+1/toloadPics.length*0.6);return this._loadResourceFilter(Loader.IMAGE,toloadPics.pop());}else{this._data.pics.push(data);if(this._data.toLoads.length>0){this.event(Event.PROGRESS,0.3+1/this._data.toLoads.length*0.6);return this._loadResourceFilter(Loader.IMAGE,this._data.toLoads.pop());}var frames=this._data.frames;var cleanUrl=this._url.split("?")[0];var directory=this._data.meta&&this._data.meta.prefix?this._data.meta.prefix:cleanUrl.substring(0,cleanUrl.lastIndexOf("."))+"/";var pics=this._data.pics;var atlasURL=URL.formatURL(this._url);var map=Loader.atlasMap[atlasURL]||(Loader.atlasMap[atlasURL]=[]);map.dir=directory;var scaleRate=1;if(this._data.meta&&this._data.meta.scale&&this._data.meta.scale!=1){scaleRate=parseFloat(this._data.meta.scale);for(var name in frames){var obj=frames[name];var tPic=pics[obj.frame.idx?obj.frame.idx:0];var url=URL.formatURL(directory+name);tPic.scaleRate=scaleRate;var tTexture;tTexture=Texture._create(tPic,obj.frame.x,obj.frame.y,obj.frame.w,obj.frame.h,obj.spriteSourceSize.x,obj.spriteSourceSize.y,obj.sourceSize.w,obj.sourceSize.h,Loader.getRes(url));Loader.cacheTexture(url,tTexture);tTexture.url=url;map.push(url);}}else{for(name in frames){obj=frames[name];tPic=pics[obj.frame.idx?obj.frame.idx:0];url=URL.formatURL(directory+name);tTexture=Texture._create(tPic,obj.frame.x,obj.frame.y,obj.frame.w,obj.frame.h,obj.spriteSourceSize.x,obj.spriteSourceSize.y,obj.sourceSize.w,obj.sourceSize.h,Loader.getRes(url));Loader.cacheTexture(url,tTexture);tTexture.url=url;map.push(url);}}delete this._data.pics;this.complete(this._data);}}else if(type===Loader.FONT){if(!data._source){this._data=data;this.event(Event.PROGRESS,0.5);return this._loadResourceFilter(Loader.IMAGE,this._url.replace(".fnt",".png"));}else{var bFont=new BitmapFont();bFont.parseFont(this._data,new Texture(data));var tArr=this._url.split(".fnt")[0].split("/");var fontName=tArr[tArr.length-1];Text.registerBitmapFont(fontName,bFont);this._data=bFont;this.complete(this._data);}}else if(type===Loader.PREFAB){var prefab=new Prefab();prefab.json=data;this.complete(prefab);}else{this.complete(data);}}},{key:"parsePLFData",value:function parsePLFData(plfData){var type;var filePath;var fileDic;for(type in plfData){fileDic=plfData[type];switch(type){case"json":case"text":for(filePath in fileDic){Loader.preLoadedMap[URL.formatURL(filePath)]=fileDic[filePath];}break;default:for(filePath in fileDic){Loader.preLoadedMap[URL.formatURL(filePath)]=fileDic[filePath];}}}}},{key:"parsePLFBData",value:function parsePLFBData(plfData){var byte;byte=new Byte(plfData);var i,len;len=byte.getInt32();for(i=0;i<len;i++){this.parseOnePLFBFile(byte);}}},{key:"parseOnePLFBFile",value:function parseOnePLFBFile(byte){var fileLen;var fileName;var fileData;fileName=byte.getUTFString();fileLen=byte.getInt32();fileData=byte.readArrayBuffer(fileLen);Loader.preLoadedMap[URL.formatURL(fileName)]=fileData;}},{key:"complete",value:function complete(data){this._data=data;if(this._customParse){this.event(Event.LOADED,data instanceof Array?[data]:data);}else{Loader._loaders.push(this);if(!Loader._isWorking)Loader.checkNext();}}},{key:"endLoad",value:function endLoad(){var content=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;content&&(this._data=content);if(this._cache)Loader.cacheRes(this._url,this._data);this.event(Event.PROGRESS,1);this.event(Event.COMPLETE,this.data instanceof Array?[this.data]:this.data);}},{key:"url",get:function get(){return this._url;}},{key:"type",get:function get(){return this._type;}},{key:"cache",get:function get(){return this._cache;}},{key:"data",get:function get(){return this._data;}}],[{key:"getTypeFromUrl",value:function getTypeFromUrl(url){var type=Utils.getFileExtension(url);if(type)return Loader.typeMap[type];console.warn("Not recognize the resources suffix",url);return"text";}},{key:"checkNext",value:function checkNext(){Loader._isWorking=true;var startTimer=Browser.now();while(Loader._startIndex<Loader._loaders.length){Loader._loaders[Loader._startIndex].endLoad();Loader._startIndex++;if(Browser.now()-startTimer>Loader.maxTimeOut){console.warn("loader callback cost a long time:"+(Browser.now()-startTimer)+" url="+Loader._loaders[Loader._startIndex-1].url);ILaya.systemTimer.frameOnce(1,null,Loader.checkNext);return;}}Loader._loaders.length=0;Loader._startIndex=0;Loader._isWorking=false;}},{key:"clearRes",value:function clearRes(url){url=URL.formatURL(url);var arr=Loader.getAtlas(url);if(arr){for(var i=0,n=arr.length;i<n;i++){var resUrl=arr[i];var tex=Loader.getRes(resUrl);delete Loader.textureMap[resUrl];if(tex)tex.destroy();}arr.length=0;delete Loader.atlasMap[url];}var texture=Loader.textureMap[url];if(texture){texture.destroy();delete Loader.textureMap[url];}var res=Loader.loadedMap[url];res&&delete Loader.loadedMap[url];}},{key:"clearTextureRes",value:function clearTextureRes(url){url=URL.formatURL(url);var arr=Loader.getAtlas(url);if(arr&&arr.length>0){arr.forEach(function(t){var tex=Loader.getRes(t);if(tex instanceof Texture){tex.disposeBitmap();}});}else{var t=Loader.getRes(url);if(t instanceof Texture){t.disposeBitmap();}}}},{key:"getRes",value:function getRes(url){var res=Loader.textureMap[URL.formatURL(url)];if(res)return res;else return Loader.loadedMap[URL.formatURL(url)];}},{key:"getAtlas",value:function getAtlas(url){return Loader.atlasMap[URL.formatURL(url)];}},{key:"cacheRes",value:function cacheRes(url,data){url=URL.formatURL(url);if(Loader.loadedMap[url]!=null){console.warn("Resources already exist,is repeated loading:",url);}else{if(data instanceof Texture){Loader.loadedMap[url]=data.bitmap;Loader.textureMap[url]=data;}else{Loader.loadedMap[url]=data;}}}},{key:"cacheTexture",value:function cacheTexture(url,data){url=URL.formatURL(url);if(Loader.textureMap[url]!=null){console.warn("Resources already exist,is repeated loading:",url);}else{Loader.textureMap[url]=data;}}},{key:"setGroup",value:function setGroup(url,group){if(!Loader.groupMap[group])Loader.groupMap[group]=[];Loader.groupMap[group].push(url);}},{key:"clearResByGroup",value:function clearResByGroup(group){if(!Loader.groupMap[group])return;var arr=Loader.groupMap[group],i,len=arr.length;for(i=0;i<len;i++){Loader.clearRes(arr[i]);}arr.length=0;}}]);return Loader;}(EventDispatcher);Loader.TEXT="text";Loader.JSON="json";Loader.PREFAB="prefab";Loader.XML="xml";Loader.BUFFER="arraybuffer";Loader.IMAGE="image";Loader.SOUND="sound";Loader.ATLAS="atlas";Loader.FONT="font";Loader.TTF="ttf";Loader.PLF="plf";Loader.PLFB="plfb";Loader.HIERARCHY="HIERARCHY";Loader.MESH="MESH";Loader.MATERIAL="MATERIAL";Loader.TEXTURE2D="TEXTURE2D";Loader.TEXTURECUBE="TEXTURECUBE";Loader.ANIMATIONCLIP="ANIMATIONCLIP";Loader.AVATAR="AVATAR";Loader.TERRAINHEIGHTDATA="TERRAINHEIGHTDATA";Loader.TERRAINRES="TERRAIN";Loader.typeMap={"ttf":"ttf","png":"image","jpg":"image","jpeg":"image","ktx":"image","pvr":"image","txt":"text","json":"json","prefab":"prefab","xml":"xml","als":"atlas","atlas":"atlas","mp3":"sound","ogg":"sound","wav":"sound","part":"json","fnt":"font","plf":"plf","plfb":"plfb","scene":"json","ani":"json","sk":"arraybuffer"};Loader.parserMap={};Loader.maxTimeOut=100;Loader.groupMap={};Loader.loadedMap={};Loader.atlasMap={};Loader.textureMap={};Loader.preLoadedMap={};Loader._imgCache={};Loader._loaders=[];Loader._isWorking=false;Loader._startIndex=0;var AtlasInfoManager=function(){function AtlasInfoManager(){_classCallCheck(this,AtlasInfoManager);}_createClass(AtlasInfoManager,null,[{key:"enable",value:function enable(infoFile){var callback=arguments.length>1&&arguments[1]!==undefined?arguments[1]:null;ILaya.loader.load(infoFile,Handler.create(null,AtlasInfoManager._onInfoLoaded,[callback]),null,Loader.JSON);}},{key:"_onInfoLoaded",value:function _onInfoLoaded(callback,data){var tKey;var tPrefix;var tArr;var i,len;for(tKey in data){tArr=data[tKey];tPrefix=tArr[0];tArr=tArr[1];len=tArr.length;for(i=0;i<len;i++){AtlasInfoManager._fileLoadDic[tPrefix+tArr[i]]=tKey;}}callback&&callback.run();}},{key:"getFileLoadPath",value:function getFileLoadPath(file){return AtlasInfoManager._fileLoadDic[file]||file;}}]);return AtlasInfoManager;}();AtlasInfoManager._fileLoadDic={};var LoaderManager=function(_EventDispatcher9){_inherits(LoaderManager,_EventDispatcher9);function LoaderManager(){_classCallCheck(this,LoaderManager);var _this42=_possibleConstructorReturn(this,(LoaderManager.__proto__||Object.getPrototypeOf(LoaderManager)).call(this));_this42.retryNum=1;_this42.retryDelay=0;_this42.maxLoader=5;_this42._loaders=[];_this42._loaderCount=0;_this42._resInfos=[];_this42._infoPool=[];_this42._maxPriority=5;_this42._failRes={};_this42._statInfo={count:1,loaded:1};for(var i=0;i<_this42._maxPriority;i++){_this42._resInfos[i]=[];}return _this42;}_createClass(LoaderManager,[{key:"getProgress",value:function getProgress(){return this._statInfo.loaded/this._statInfo.count;}},{key:"resetProgress",value:function resetProgress(){this._statInfo.count=this._statInfo.loaded=1;}},{key:"create",value:function create(url){var complete=arguments.length>1&&arguments[1]!==undefined?arguments[1]:null;var progress=arguments.length>2&&arguments[2]!==undefined?arguments[2]:null;var type=arguments.length>3&&arguments[3]!==undefined?arguments[3]:null;var constructParams=arguments.length>4&&arguments[4]!==undefined?arguments[4]:null;var propertyParams=arguments.length>5&&arguments[5]!==undefined?arguments[5]:null;var priority=arguments.length>6&&arguments[6]!==undefined?arguments[6]:1;var cache=arguments.length>7&&arguments[7]!==undefined?arguments[7]:true;this._create(url,true,complete,progress,type,constructParams,propertyParams,priority,cache);}},{key:"_create",value:function _create(url,mainResou){var complete=arguments.length>2&&arguments[2]!==undefined?arguments[2]:null;var progress=arguments.length>3&&arguments[3]!==undefined?arguments[3]:null;var type=arguments.length>4&&arguments[4]!==undefined?arguments[4]:null;var constructParams=arguments.length>5&&arguments[5]!==undefined?arguments[5]:null;var propertyParams=arguments.length>6&&arguments[6]!==undefined?arguments[6]:null;var priority=arguments.length>7&&arguments[7]!==undefined?arguments[7]:1;var cache=arguments.length>8&&arguments[8]!==undefined?arguments[8]:true;if(url instanceof Array){var allScuess=true;var items=url;var itemCount=items.length;var loadedCount=0;if(progress){var progress2=Handler.create(progress.caller,progress?progress.method:null,progress.args,false);}for(var i=0;i<itemCount;i++){var item=items[i];if(typeof item=='string')item=items[i]={url:item};item.progress=0;}for(i=0;i<itemCount;i++){item=items[i];var progressHandler=progress?Handler.create(null,function(item,value){item.progress=value;var num=0;for(var j=0;j<itemCount;j++){var item1=items[j];num+=item1.progress;}var v=num/itemCount;progress2.runWith(v);},[item],false):null;var completeHandler=progress||complete?Handler.create(null,function(item){var content=arguments.length>1&&arguments[1]!==undefined?arguments[1]:null;loadedCount++;item.progress=1;content||(allScuess=false);if(loadedCount===itemCount&&complete){complete.runWith(allScuess);}},[item]):null;this._createOne(item.url,mainResou,completeHandler,progressHandler,item.type||type,item.constructParams||constructParams,item.propertyParams||propertyParams,item.priority||priority,cache);}}else{this._createOne(url,mainResou,complete,progress,type,constructParams,propertyParams,priority,cache);}}},{key:"_createOne",value:function _createOne(url,mainResou){var complete=arguments.length>2&&arguments[2]!==undefined?arguments[2]:null;var progress=arguments.length>3&&arguments[3]!==undefined?arguments[3]:null;var type=arguments.length>4&&arguments[4]!==undefined?arguments[4]:null;var constructParams=arguments.length>5&&arguments[5]!==undefined?arguments[5]:null;var propertyParams=arguments.length>6&&arguments[6]!==undefined?arguments[6]:null;var priority=arguments.length>7&&arguments[7]!==undefined?arguments[7]:1;var cache=arguments.length>8&&arguments[8]!==undefined?arguments[8]:true;var item=this.getRes(url);if(!item){var extension=Utils.getFileExtension(url);type||(type=LoaderManager.createMap[extension]?LoaderManager.createMap[extension][0]:null);if(!type){this.load(url,complete,progress,type,priority,cache);return;}var parserMap=Loader.parserMap;if(!parserMap[type]){this.load(url,complete,progress,type,priority,cache);return;}this._createLoad(url,Handler.create(null,function(createRes){if(createRes){if(!mainResou&&createRes instanceof Resource)createRes._addReference();createRes._setCreateURL(url);}complete&&complete.runWith(createRes);ILaya.loader.event(url);}),progress,type,constructParams,propertyParams,priority,cache,true);}else{if(!mainResou&&item instanceof Resource)item._addReference();progress&&progress.runWith(1);complete&&complete.runWith(item);}}},{key:"load",value:function load(url){var complete=arguments.length>1&&arguments[1]!==undefined?arguments[1]:null;var progress=arguments.length>2&&arguments[2]!==undefined?arguments[2]:null;var type=arguments.length>3&&arguments[3]!==undefined?arguments[3]:null;var priority=arguments.length>4&&arguments[4]!==undefined?arguments[4]:1;var cache=arguments.length>5&&arguments[5]!==undefined?arguments[5]:true;var group=arguments.length>6&&arguments[6]!==undefined?arguments[6]:null;var ignoreCache=arguments.length>7&&arguments[7]!==undefined?arguments[7]:false;var useWorkerLoader=arguments.length>8&&arguments[8]!==undefined?arguments[8]:ILaya.WorkerLoader.enable;if(url instanceof Array){return this._loadAssets(url,complete,progress,type,priority,cache,group);}var content;if(type===Loader.IMAGE)content=Loader.textureMap[URL.formatURL(url)];else content=Loader.loadedMap[URL.formatURL(url)];if(!ignoreCache&&content!=null){ILaya.systemTimer.frameOnce(1,this,function(){progress&&progress.runWith(1);complete&&complete.runWith(content instanceof Array?[content]:content);this._loaderCount||this.event(Event.COMPLETE);});}else{var original;original=url;url=AtlasInfoManager.getFileLoadPath(url);if(url!=original&&type!=="nativeimage"){type=Loader.ATLAS;}else{original=null;}var info=LoaderManager._resMap[url];if(!info){info=this._infoPool.length?this._infoPool.pop():new ResInfo();info.url=url;info.type=type;info.cache=cache;info.group=group;info.ignoreCache=ignoreCache;info.useWorkerLoader=useWorkerLoader;info.originalUrl=original;complete&&info.on(Event.COMPLETE,complete.caller,complete.method,complete.args);progress&&info.on(Event.PROGRESS,progress.caller,progress.method,progress.args);LoaderManager._resMap[url]=info;priority=priority<this._maxPriority?priority:this._maxPriority-1;this._resInfos[priority].push(info);this._statInfo.count++;this.event(Event.PROGRESS,this.getProgress());this._next();}else{if(complete){if(original){complete&&info._createListener(Event.COMPLETE,this,this._resInfoLoaded,[original,complete],false,false);}else{complete&&info._createListener(Event.COMPLETE,complete.caller,complete.method,complete.args,false,false);}}progress&&info._createListener(Event.PROGRESS,progress.caller,progress.method,progress.args,false,false);}}return this;}},{key:"_resInfoLoaded",value:function _resInfoLoaded(original,complete){complete.runWith(Loader.getRes(original));}},{key:"_createLoad",value:function _createLoad(url){var complete=arguments.length>1&&arguments[1]!==undefined?arguments[1]:null;var progress=arguments.length>2&&arguments[2]!==undefined?arguments[2]:null;var type=arguments.length>3&&arguments[3]!==undefined?arguments[3]:null;var constructParams=arguments.length>4&&arguments[4]!==undefined?arguments[4]:null;var propertyParams=arguments.length>5&&arguments[5]!==undefined?arguments[5]:null;var priority=arguments.length>6&&arguments[6]!==undefined?arguments[6]:1;var cache=arguments.length>7&&arguments[7]!==undefined?arguments[7]:true;var ignoreCache=arguments.length>8&&arguments[8]!==undefined?arguments[8]:false;if(url instanceof Array)return this._loadAssets(url,complete,progress,type,priority,cache);var content=Loader.getRes(url);if(content!=null){ILaya.systemTimer.frameOnce(1,this,function(){progress&&progress.runWith(1);complete&&complete.runWith(content);this._loaderCount||this.event(Event.COMPLETE);});}else{var info=LoaderManager._resMap[url];if(!info){info=this._infoPool.length?this._infoPool.pop():new ResInfo();info.url=url;info.type=type;info.cache=false;info.ignoreCache=ignoreCache;info.originalUrl=null;info.group=null;info.createCache=cache;info.createConstructParams=constructParams;info.createPropertyParams=propertyParams;complete&&info.on(Event.COMPLETE,complete.caller,complete.method,complete.args);progress&&info.on(Event.PROGRESS,progress.caller,progress.method,progress.args);LoaderManager._resMap[url]=info;priority=priority<this._maxPriority?priority:this._maxPriority-1;this._resInfos[priority].push(info);this._statInfo.count++;this.event(Event.PROGRESS,this.getProgress());this._next();}else{complete&&info._createListener(Event.COMPLETE,complete.caller,complete.method,complete.args,false,false);progress&&info._createListener(Event.PROGRESS,progress.caller,progress.method,progress.args,false,false);}}return this;}},{key:"_next",value:function _next(){if(this._loaderCount>=this.maxLoader)return;for(var i=0;i<this._maxPriority;i++){var infos=this._resInfos[i];while(infos.length>0){var info=infos.shift();if(info)return this._doLoad(info);}}this._loaderCount||this.event(Event.COMPLETE);}},{key:"_doLoad",value:function _doLoad(resInfo){this._loaderCount++;var loader=this._loaders.length?this._loaders.pop():new Loader();loader.on(Event.COMPLETE,null,onLoaded);loader.on(Event.PROGRESS,null,function(num){resInfo.event(Event.PROGRESS,num);});loader.on(Event.ERROR,null,function(msg){onLoaded(null);});var _me=this;function onLoaded(){var data=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;loader.offAll();loader._data=null;loader._customParse=false;_me._loaders.push(loader);_me._endLoad(resInfo,data instanceof Array?[data]:data);_me._loaderCount--;_me._next();}loader._constructParams=resInfo.createConstructParams;loader._propertyParams=resInfo.createPropertyParams;loader._createCache=resInfo.createCache;loader.load(resInfo.url,resInfo.type,resInfo.cache,resInfo.group,resInfo.ignoreCache,resInfo.useWorkerLoader);}},{key:"_endLoad",value:function _endLoad(resInfo,content){var url=resInfo.url;if(content==null){var errorCount=this._failRes[url]||0;if(errorCount<this.retryNum){console.warn("[warn]Retry to load:",url);this._failRes[url]=errorCount+1;ILaya.systemTimer.once(this.retryDelay,this,this._addReTry,[resInfo],false);return;}else{Loader.clearRes(url);console.warn("[error]Failed to load:",url);this.event(Event.ERROR,url);}}if(this._failRes[url])this._failRes[url]=0;delete LoaderManager._resMap[url];if(resInfo.originalUrl){content=Loader.getRes(resInfo.originalUrl);}resInfo.event(Event.COMPLETE,content);resInfo.offAll();this._infoPool.push(resInfo);this._statInfo.loaded++;this.event(Event.PROGRESS,this.getProgress());}},{key:"_addReTry",value:function _addReTry(resInfo){this._resInfos[this._maxPriority-1].push(resInfo);this._next();}},{key:"clearRes",value:function clearRes(url){Loader.clearRes(url);}},{key:"clearTextureRes",value:function clearTextureRes(url){Loader.clearTextureRes(url);}},{key:"getRes",value:function getRes(url){return Loader.getRes(url);}},{key:"cacheRes",value:function cacheRes(url,data){Loader.cacheRes(url,data);}},{key:"setGroup",value:function setGroup(url,group){Loader.setGroup(url,group);}},{key:"clearResByGroup",value:function clearResByGroup(group){Loader.clearResByGroup(group);}},{key:"clearUnLoaded",value:function clearUnLoaded(){for(var i=0;i<this._maxPriority;i++){var infos=this._resInfos[i];for(var j=infos.length-1;j>-1;j--){var info=infos[j];if(info){info.offAll();this._infoPool.push(info);}}infos.length=0;}this._loaderCount=0;LoaderManager._resMap={};}},{key:"cancelLoadByUrls",value:function cancelLoadByUrls(urls){if(!urls)return;for(var i=0,n=urls.length;i<n;i++){this.cancelLoadByUrl(urls[i]);}}},{key:"cancelLoadByUrl",value:function cancelLoadByUrl(url){for(var i=0;i<this._maxPriority;i++){var infos=this._resInfos[i];for(var j=infos.length-1;j>-1;j--){var info=infos[j];if(info&&info.url===url){infos[j]=null;info.offAll();this._infoPool.push(info);}}}if(LoaderManager._resMap[url])delete LoaderManager._resMap[url];}},{key:"_loadAssets",value:function _loadAssets(arr){var complete=arguments.length>1&&arguments[1]!==undefined?arguments[1]:null;var progress=arguments.length>2&&arguments[2]!==undefined?arguments[2]:null;var type=arguments.length>3&&arguments[3]!==undefined?arguments[3]:null;var priority=arguments.length>4&&arguments[4]!==undefined?arguments[4]:1;var cache=arguments.length>5&&arguments[5]!==undefined?arguments[5]:true;var group=arguments.length>6&&arguments[6]!==undefined?arguments[6]:null;var itemCount=arr.length;var loadedCount=0;var totalSize=0;var items=[];var success=true;for(var i=0;i<itemCount;i++){var url=arr[i];var item=void 0;if(typeof url=='string')item={url:url,type:type,size:1,priority:priority};else item=url;if(!item.size)item.size=1;item.progress=0;totalSize+=item.size;items.push(item);var progressHandler=progress?Handler.create(null,loadProgress,[item],false):null;var completeHandler=complete||progress?Handler.create(null,loadComplete,[item]):null;this.load(item.url,completeHandler,progressHandler,item.type,item.priority||1,cache,item.group||group,false,item.useWorkerLoader);}function loadComplete(item){var content=arguments.length>1&&arguments[1]!==undefined?arguments[1]:null;loadedCount++;item.progress=1;if(!content)success=false;if(loadedCount===itemCount&&complete){complete.runWith(success);}}function loadProgress(item,value){if(progress!=null){item.progress=value;var num=0;for(var j=0;j<items.length;j++){var item1=items[j];if(item1){var prog=item1.progress==undefined?0:item1.progress;num+=item1.size==undefined?0:item1.size*prog;}}var v=num/totalSize;progress.runWith(v);}}return this;}},{key:"decodeBitmaps",value:function decodeBitmaps(urls){var i,len=urls.length;var ctx;ctx=ILaya.Render._context;for(i=0;i<len;i++){var atlas;atlas=Loader.getAtlas(urls[i]);if(atlas){this._decodeTexture(atlas[0],ctx);}else{var tex;tex=this.getRes(urls[i]);if(tex&&tex instanceof Texture){this._decodeTexture(tex,ctx);}}}}},{key:"_decodeTexture",value:function _decodeTexture(tex,ctx){var bitmap=tex.bitmap;if(!tex||!bitmap)return;var tImg=bitmap.source||bitmap.image;if(!tImg)return;if(tImg instanceof HTMLImageElement){ctx.drawImage(tImg,0,0,1,1);var info=ctx.getImageData(0,0,1,1);}}}],[{key:"cacheRes",value:function cacheRes(url,data){Loader.cacheRes(url,data);}}]);return LoaderManager;}(EventDispatcher);LoaderManager._resMap={};LoaderManager.createMap={atlas:[null,Loader.ATLAS]};var ResInfo=function(_EventDispatcher10){_inherits(ResInfo,_EventDispatcher10);function ResInfo(){_classCallCheck(this,ResInfo);return _possibleConstructorReturn(this,(ResInfo.__proto__||Object.getPrototypeOf(ResInfo)).apply(this,arguments));}return ResInfo;}(EventDispatcher);var LocalStorage=function(){function LocalStorage(){_classCallCheck(this,LocalStorage);}_createClass(LocalStorage,null,[{key:"__init__",value:function __init__(){if(!LocalStorage._baseClass){LocalStorage._baseClass=Storage;Storage.init();}LocalStorage.items=LocalStorage._baseClass.items;LocalStorage.support=LocalStorage._baseClass.support;return LocalStorage.support;}},{key:"setItem",value:function setItem(key,value){LocalStorage._baseClass.setItem(key,value);}},{key:"getItem",value:function getItem(key){return LocalStorage._baseClass.getItem(key);}},{key:"setJSON",value:function setJSON(key,value){LocalStorage._baseClass.setJSON(key,value);}},{key:"getJSON",value:function getJSON(key){return LocalStorage._baseClass.getJSON(key);}},{key:"removeItem",value:function removeItem(key){LocalStorage._baseClass.removeItem(key);}},{key:"clear",value:function clear(){LocalStorage._baseClass.clear();}}]);return LocalStorage;}();LocalStorage.support=false;var Storage=function(){function Storage(){_classCallCheck(this,Storage);}_createClass(Storage,null,[{key:"init",value:function init(){try{Storage.support=true;Storage.items=window.localStorage;Storage.setItem('laya','1');Storage.removeItem('laya');}catch(e){Storage.support=false;}if(!Storage.support)console.log('LocalStorage is not supprot or browser is private mode.');}},{key:"setItem",value:function setItem(key,value){try{Storage.support&&Storage.items.setItem(key,value);}catch(e){console.warn("set localStorage failed",e);}}},{key:"getItem",value:function getItem(key){return Storage.support?Storage.items.getItem(key):null;}},{key:"setJSON",value:function setJSON(key,value){try{Storage.support&&Storage.items.setItem(key,JSON.stringify(value));}catch(e){console.warn("set localStorage failed",e);}}},{key:"getJSON",value:function getJSON(key){try{var obj=JSON.parse(Storage.support?Storage.items.getItem(key):null);return obj;}catch(err){return Storage.items.getItem(key);}}},{key:"removeItem",value:function removeItem(key){Storage.support&&Storage.items.removeItem(key);}},{key:"clear",value:function clear(){Storage.support&&Storage.items.clear();}}]);return Storage;}();Storage.support=false;var TTFLoader=function(){function TTFLoader(){_classCallCheck(this,TTFLoader);}_createClass(TTFLoader,[{key:"load",value:function load(fontPath){this._url=fontPath;var tArr=fontPath.split(".ttf")[0].split("/");this.fontName=tArr[tArr.length-1];if(ILaya.Render.isConchApp){this._loadConch();}else if(window.FontFace){this._loadWithFontFace();}else{this._loadWithCSS();}}},{key:"_loadConch",value:function _loadConch(){this._http=new HttpRequest();this._http.on(Event.ERROR,this,this._onErr);this._http.on(Event.COMPLETE,this,this._onHttpLoaded);this._http.send(this._url,null,"get",Loader.BUFFER);}},{key:"_onHttpLoaded",value:function _onHttpLoaded(){var data=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;window["conchTextCanvas"].setFontFaceFromBuffer(this.fontName,data);this._clearHttp();this._complete();}},{key:"_clearHttp",value:function _clearHttp(){if(this._http){this._http.off(Event.ERROR,this,this._onErr);this._http.off(Event.COMPLETE,this,this._onHttpLoaded);this._http=null;}}},{key:"_onErr",value:function _onErr(){this._clearHttp();if(this.err){this.err.runWith("fail:"+this._url);this.err=null;}}},{key:"_complete",value:function _complete(){ILaya.systemTimer.clear(this,this._complete);ILaya.systemTimer.clear(this,this._checkComplete);if(this._div&&this._div.parentNode){this._div.parentNode.removeChild(this._div);this._div=null;}if(this.complete){this.complete.runWith(this);this.complete=null;}}},{key:"_checkComplete",value:function _checkComplete(){if(ILaya.Browser.measureText(TTFLoader._testString,this._fontTxt).width!=this._txtWidth){this._complete();}}},{key:"_loadWithFontFace",value:function _loadWithFontFace(){var fontFace=new window.FontFace(this.fontName,"url('"+this._url+"')");document.fonts.add(fontFace);var self=this;fontFace.loaded.then(function(){self._complete();});fontFace.load();}},{key:"_createDiv",value:function _createDiv(){this._div=Browser.createElement("div");this._div.innerHTML="laya";var _style=this._div.style;_style.fontFamily=this.fontName;_style.position="absolute";_style.left="-100px";_style.top="-100px";document.body.appendChild(this._div);}},{key:"_loadWithCSS",value:function _loadWithCSS(){var fontStyle=Browser.createElement("style");fontStyle.type="text/css";document.body.appendChild(fontStyle);fontStyle.textContent="@font-face { font-family:'"+this.fontName+"'; src:url('"+this._url+"');}";this._fontTxt="40px "+this.fontName;this._txtWidth=Browser.measureText(TTFLoader._testString,this._fontTxt).width;var self=this;fontStyle.onload=function(){ILaya.systemTimer.once(10000,self,this._complete);};ILaya.systemTimer.loop(20,this,this._checkComplete);this._createDiv();}}]);return TTFLoader;}();TTFLoader._testString="LayaTTFFont";var Ease=function(){function Ease(){_classCallCheck(this,Ease);}_createClass(Ease,null,[{key:"linearNone",value:function linearNone(t,b,c,d){return c*t/d+b;}},{key:"linearIn",value:function linearIn(t,b,c,d){return c*t/d+b;}},{key:"linearInOut",value:function linearInOut(t,b,c,d){return c*t/d+b;}},{key:"linearOut",value:function linearOut(t,b,c,d){return c*t/d+b;}},{key:"bounceIn",value:function bounceIn(t,b,c,d){return c-Ease.bounceOut(d-t,0,c,d)+b;}},{key:"bounceInOut",value:function bounceInOut(t,b,c,d){if(t<d*0.5)return Ease.bounceIn(t*2,0,c,d)*.5+b;else return Ease.bounceOut(t*2-d,0,c,d)*.5+c*.5+b;}},{key:"bounceOut",value:function bounceOut(t,b,c,d){if((t/=d)<1/2.75)return c*(7.5625*t*t)+b;else if(t<2/2.75)return c*(7.5625*(t-=1.5/2.75)*t+.75)+b;else if(t<2.5/2.75)return c*(7.5625*(t-=2.25/2.75)*t+.9375)+b;else return c*(7.5625*(t-=2.625/2.75)*t+.984375)+b;}},{key:"backIn",value:function backIn(t,b,c,d){var s=arguments.length>4&&arguments[4]!==undefined?arguments[4]:1.70158;return c*(t/=d)*t*((s+1)*t-s)+b;}},{key:"backInOut",value:function backInOut(t,b,c,d){var s=arguments.length>4&&arguments[4]!==undefined?arguments[4]:1.70158;if((t/=d*0.5)<1)return c*0.5*(t*t*(((s*=1.525)+1)*t-s))+b;return c/2*((t-=2)*t*(((s*=1.525)+1)*t+s)+2)+b;}},{key:"backOut",value:function backOut(t,b,c,d){var s=arguments.length>4&&arguments[4]!==undefined?arguments[4]:1.70158;return c*((t=t/d-1)*t*((s+1)*t+s)+1)+b;}},{key:"elasticIn",value:function elasticIn(t,b,c,d){var a=arguments.length>4&&arguments[4]!==undefined?arguments[4]:0;var p=arguments.length>5&&arguments[5]!==undefined?arguments[5]:0;var s;if(t==0)return b;if((t/=d)==1)return b+c;if(!p)p=d*.3;if(!a||c>0&&a<c||c<0&&a<-c){a=c;s=p/4;}else s=p/Ease.PI2*Math.asin(c/a);return-(a*Math.pow(2,10*(t-=1))*Math.sin((t*d-s)*Ease.PI2/p))+b;}},{key:"elasticInOut",value:function elasticInOut(t,b,c,d){var a=arguments.length>4&&arguments[4]!==undefined?arguments[4]:0;var p=arguments.length>5&&arguments[5]!==undefined?arguments[5]:0;var s;if(t==0)return b;if((t/=d*0.5)==2)return b+c;if(!p)p=d*(.3*1.5);if(!a||c>0&&a<c||c<0&&a<-c){a=c;s=p/4;}else s=p/Ease.PI2*Math.asin(c/a);if(t<1)return-.5*(a*Math.pow(2,10*(t-=1))*Math.sin((t*d-s)*Ease.PI2/p))+b;return a*Math.pow(2,-10*(t-=1))*Math.sin((t*d-s)*Ease.PI2/p)*.5+c+b;}},{key:"elasticOut",value:function elasticOut(t,b,c,d){var a=arguments.length>4&&arguments[4]!==undefined?arguments[4]:0;var p=arguments.length>5&&arguments[5]!==undefined?arguments[5]:0;var s;if(t==0)return b;if((t/=d)==1)return b+c;if(!p)p=d*.3;if(!a||c>0&&a<c||c<0&&a<-c){a=c;s=p/4;}else s=p/Ease.PI2*Math.asin(c/a);return a*Math.pow(2,-10*t)*Math.sin((t*d-s)*Ease.PI2/p)+c+b;}},{key:"strongIn",value:function strongIn(t,b,c,d){return c*(t/=d)*t*t*t*t+b;}},{key:"strongInOut",value:function strongInOut(t,b,c,d){if((t/=d*0.5)<1)return c*0.5*t*t*t*t*t+b;return c*0.5*((t-=2)*t*t*t*t+2)+b;}},{key:"strongOut",value:function strongOut(t,b,c,d){return c*((t=t/d-1)*t*t*t*t+1)+b;}},{key:"sineInOut",value:function sineInOut(t,b,c,d){return-c*0.5*(Math.cos(Math.PI*t/d)-1)+b;}},{key:"sineIn",value:function sineIn(t,b,c,d){return-c*Math.cos(t/d*Ease.HALF_PI)+c+b;}},{key:"sineOut",value:function sineOut(t,b,c,d){return c*Math.sin(t/d*Ease.HALF_PI)+b;}},{key:"quintIn",value:function quintIn(t,b,c,d){return c*(t/=d)*t*t*t*t+b;}},{key:"quintInOut",value:function quintInOut(t,b,c,d){if((t/=d*0.5)<1)return c*0.5*t*t*t*t*t+b;return c*0.5*((t-=2)*t*t*t*t+2)+b;}},{key:"quintOut",value:function quintOut(t,b,c,d){return c*((t=t/d-1)*t*t*t*t+1)+b;}},{key:"quartIn",value:function quartIn(t,b,c,d){return c*(t/=d)*t*t*t+b;}},{key:"quartInOut",value:function quartInOut(t,b,c,d){if((t/=d*0.5)<1)return c*0.5*t*t*t*t+b;return-c*0.5*((t-=2)*t*t*t-2)+b;}},{key:"quartOut",value:function quartOut(t,b,c,d){return-c*((t=t/d-1)*t*t*t-1)+b;}},{key:"cubicIn",value:function cubicIn(t,b,c,d){return c*(t/=d)*t*t+b;}},{key:"cubicInOut",value:function cubicInOut(t,b,c,d){if((t/=d*0.5)<1)return c*0.5*t*t*t+b;return c*0.5*((t-=2)*t*t+2)+b;}},{key:"cubicOut",value:function cubicOut(t,b,c,d){return c*((t=t/d-1)*t*t+1)+b;}},{key:"quadIn",value:function quadIn(t,b,c,d){return c*(t/=d)*t+b;}},{key:"quadInOut",value:function quadInOut(t,b,c,d){if((t/=d*0.5)<1)return c*0.5*t*t+b;return-c*0.5*(--t*(t-2)-1)+b;}},{key:"quadOut",value:function quadOut(t,b,c,d){return-c*(t/=d)*(t-2)+b;}},{key:"expoIn",value:function expoIn(t,b,c,d){return t==0?b:c*Math.pow(2,10*(t/d-1))+b-c*0.001;}},{key:"expoInOut",value:function expoInOut(t,b,c,d){if(t==0)return b;if(t==d)return b+c;if((t/=d*0.5)<1)return c*0.5*Math.pow(2,10*(t-1))+b;return c*0.5*(-Math.pow(2,-10*--t)+2)+b;}},{key:"expoOut",value:function expoOut(t,b,c,d){return t==d?b+c:c*(-Math.pow(2,-10*t/d)+1)+b;}},{key:"circIn",value:function circIn(t,b,c,d){return-c*(Math.sqrt(1-(t/=d)*t)-1)+b;}},{key:"circInOut",value:function circInOut(t,b,c,d){if((t/=d*0.5)<1)return-c*0.5*(Math.sqrt(1-t*t)-1)+b;return c*0.5*(Math.sqrt(1-(t-=2)*t)+1)+b;}},{key:"circOut",value:function circOut(t,b,c,d){return c*Math.sqrt(1-(t=t/d-1)*t)+b;}}]);return Ease;}();Ease.HALF_PI=Math.PI*0.5;Ease.PI2=Math.PI*2;var Tween=function(){function Tween(){_classCallCheck(this,Tween);this.gid=0;this.repeat=1;this._count=0;}_createClass(Tween,[{key:"to",value:function to(target,props,duration){var ease=arguments.length>3&&arguments[3]!==undefined?arguments[3]:null;var complete=arguments.length>4&&arguments[4]!==undefined?arguments[4]:null;var delay=arguments.length>5&&arguments[5]!==undefined?arguments[5]:0;var coverBefore=arguments.length>6&&arguments[6]!==undefined?arguments[6]:false;return this._create(target,props,duration,ease,complete,delay,coverBefore,true,false,true);}},{key:"from",value:function from(target,props,duration){var ease=arguments.length>3&&arguments[3]!==undefined?arguments[3]:null;var complete=arguments.length>4&&arguments[4]!==undefined?arguments[4]:null;var delay=arguments.length>5&&arguments[5]!==undefined?arguments[5]:0;var coverBefore=arguments.length>6&&arguments[6]!==undefined?arguments[6]:false;return this._create(target,props,duration,ease,complete,delay,coverBefore,false,false,true);}},{key:"_create",value:function _create(target,props,duration,ease,complete,delay,coverBefore,isTo,usePool,runNow){if(!target)throw new Error("Tween:target is null");this._target=target;this._duration=duration;this._ease=ease||props.ease||Tween.easeNone;this._complete=complete||props.complete;this._delay=delay;this._props=[];this._usedTimer=0;this._startTimer=Browser.now();this._usedPool=usePool;this._delayParam=null;this.update=props.update;var gid=target.$_GID||(target.$_GID=Utils.getGID());if(!Tween.tweenMap[gid]){Tween.tweenMap[gid]=[this];}else{if(coverBefore)Tween.clearTween(target);Tween.tweenMap[gid].push(this);}if(runNow){if(delay<=0)this.firstStart(target,props,isTo);else{this._delayParam=[target,props,isTo];ILaya.timer.once(delay,this,this.firstStart,this._delayParam);}}else{this._initProps(target,props,isTo);}return this;}},{key:"firstStart",value:function firstStart(target,props,isTo){this._delayParam=null;if(target.destroyed){this.clear();return;}this._initProps(target,props,isTo);this._beginLoop();}},{key:"_initProps",value:function _initProps(target,props,isTo){for(var p in props){if(typeof target[p]=='number'){var start=isTo?target[p]:props[p];var end=isTo?props[p]:target[p];this._props.push([p,start,end-start]);if(!isTo)target[p]=start;}}}},{key:"_beginLoop",value:function _beginLoop(){ILaya.timer.frameLoop(1,this,this._doEase);}},{key:"_doEase",value:function _doEase(){this._updateEase(Browser.now());}},{key:"_updateEase",value:function _updateEase(time){var target=this._target;if(!target)return;if(target.destroyed)return Tween.clearTween(target);var usedTimer=this._usedTimer=time-this._startTimer-this._delay;if(usedTimer<0)return;if(usedTimer>=this._duration)return this.complete();var ratio=usedTimer>0?this._ease(usedTimer,0,1,this._duration):0;var props=this._props;for(var i=0,n=props.length;i<n;i++){var prop=props[i];target[prop[0]]=prop[1]+ratio*prop[2];}if(this.update)this.update.run();}},{key:"complete",value:function complete(){if(!this._target)return;ILaya.timer.runTimer(this,this.firstStart);var target=this._target;var props=this._props;var handler=this._complete;for(var i=0,n=props.length;i<n;i++){var prop=props[i];target[prop[0]]=prop[1]+prop[2];}if(this.update)this.update.run();this._count++;if(this.repeat!=0&&this._count>=this.repeat){this.clear();handler&&handler.run();}else{this.restart();}}},{key:"pause",value:function pause(){ILaya.timer.clear(this,this._beginLoop);ILaya.timer.clear(this,this._doEase);ILaya.timer.clear(this,this.firstStart);var time=Browser.now();var dTime;dTime=time-this._startTimer-this._delay;if(dTime<0){this._usedTimer=dTime;}}},{key:"setStartTime",value:function setStartTime(startTime){this._startTimer=startTime;}},{key:"clear",value:function clear(){if(this._target){this._remove();this._clear();}}},{key:"_clear",value:function _clear(){this.pause();ILaya.timer.clear(this,this.firstStart);this._complete=null;this._target=null;this._ease=null;this._props=null;this._delayParam=null;this.repeat=1;if(this._usedPool){this.update=null;Pool.recover("tween",this);}}},{key:"recover",value:function recover(){this._usedPool=true;this._clear();}},{key:"_remove",value:function _remove(){var tweens=Tween.tweenMap[this._target.$_GID];if(tweens){for(var i=0,n=tweens.length;i<n;i++){if(tweens[i]===this){tweens.splice(i,1);break;}}}}},{key:"restart",value:function restart(){this.pause();this._usedTimer=0;this._startTimer=Browser.now();if(this._delayParam){ILaya.timer.once(this._delay,this,this.firstStart,this._delayParam);return;}var props=this._props;for(var i=0,n=props.length;i<n;i++){var prop=props[i];this._target[prop[0]]=prop[1];}ILaya.timer.once(this._delay,this,this._beginLoop);}},{key:"resume",value:function resume(){if(this._usedTimer>=this._duration)return;this._startTimer=Browser.now()-this._usedTimer-this._delay;if(this._delayParam){if(this._usedTimer<0){ILaya.timer.once(-this._usedTimer,this,this.firstStart,this._delayParam);}else{this.firstStart.apply(this,this._delayParam);}}else{this._beginLoop();}}},{key:"progress",set:function set(v){var uTime=v*this._duration;this._startTimer=Browser.now()-this._delay-uTime;}}],[{key:"to",value:function to(target,props,duration){var ease=arguments.length>3&&arguments[3]!==undefined?arguments[3]:null;var complete=arguments.length>4&&arguments[4]!==undefined?arguments[4]:null;var delay=arguments.length>5&&arguments[5]!==undefined?arguments[5]:0;var coverBefore=arguments.length>6&&arguments[6]!==undefined?arguments[6]:false;var autoRecover=arguments.length>7&&arguments[7]!==undefined?arguments[7]:true;return Pool.getItemByClass("tween",Tween)._create(target,props,duration,ease,complete,delay,coverBefore,true,autoRecover,true);}},{key:"from",value:function from(target,props,duration){var ease=arguments.length>3&&arguments[3]!==undefined?arguments[3]:null;var complete=arguments.length>4&&arguments[4]!==undefined?arguments[4]:null;var delay=arguments.length>5&&arguments[5]!==undefined?arguments[5]:0;var coverBefore=arguments.length>6&&arguments[6]!==undefined?arguments[6]:false;var autoRecover=arguments.length>7&&arguments[7]!==undefined?arguments[7]:true;return Pool.getItemByClass("tween",Tween)._create(target,props,duration,ease,complete,delay,coverBefore,false,autoRecover,true);}},{key:"clearAll",value:function clearAll(target){if(!target||!target.$_GID)return;var tweens=Tween.tweenMap[target.$_GID];if(tweens){for(var i=0,n=tweens.length;i<n;i++){tweens[i]._clear();}tweens.length=0;}}},{key:"clear",value:function clear(tween){tween.clear();}},{key:"clearTween",value:function clearTween(target){Tween.clearAll(target);}},{key:"easeNone",value:function easeNone(t,b,c,d){return c*t/d+b;}}]);return Tween;}();Tween.tweenMap=[];var Dragging=function(){function Dragging(){_classCallCheck(this,Dragging);this.ratio=0.92;this.maxOffset=60;this._dragging=false;this._clickOnly=true;}_createClass(Dragging,[{key:"start",value:function start(target,area,hasInertia,elasticDistance,elasticBackTime,data,disableMouseEvent){var ratio=arguments.length>7&&arguments[7]!==undefined?arguments[7]:0.92;this.clearTimer();this.target=target;this.area=area;this.hasInertia=hasInertia;this.elasticDistance=area?elasticDistance:0;this.elasticBackTime=elasticBackTime;this.data=data;this._disableMouseEvent=disableMouseEvent;this.ratio=ratio;this._parent=target.parent;this._clickOnly=true;this._dragging=true;this._elasticRateX=this._elasticRateY=1;this._lastX=this._parent.mouseX;this._lastY=this._parent.mouseY;ILaya.stage.on(Event.MOUSE_UP,this,this.onStageMouseUp);ILaya.stage.on(Event.MOUSE_OUT,this,this.onStageMouseUp);ILaya.systemTimer.frameLoop(1,this,this.loop);}},{key:"clearTimer",value:function clearTimer(){ILaya.systemTimer.clear(this,this.loop);ILaya.systemTimer.clear(this,this.tweenMove);if(this._tween){this._tween.recover();this._tween=null;}}},{key:"stop",value:function stop(){if(this._dragging){MouseManager.instance.disableMouseEvent=false;ILaya.stage.off(Event.MOUSE_UP,this,this.onStageMouseUp);ILaya.stage.off(Event.MOUSE_OUT,this,this.onStageMouseUp);this._dragging=false;this.target&&this.area&&this.backToArea();this.clear();}}},{key:"loop",value:function loop(){var point=this._parent.getMousePoint();var mouseX=point.x;var mouseY=point.y;var offsetX=mouseX-this._lastX;var offsetY=mouseY-this._lastY;if(this._clickOnly){if(Math.abs(offsetX*ILaya.stage._canvasTransform.getScaleX())>1||Math.abs(offsetY*ILaya.stage._canvasTransform.getScaleY())>1){this._clickOnly=false;this._offsets||(this._offsets=[]);this._offsets.length=0;this.target.event(Event.DRAG_START,this.data);MouseManager.instance.disableMouseEvent=this._disableMouseEvent;}else return;}else{this._offsets.push(offsetX,offsetY);}if(offsetX===0&&offsetY===0)return;this._lastX=mouseX;this._lastY=mouseY;this.target.x+=offsetX*this._elasticRateX;this.target.y+=offsetY*this._elasticRateY;this.area&&this.checkArea();this.target.event(Event.DRAG_MOVE,this.data);}},{key:"checkArea",value:function checkArea(){if(this.elasticDistance<=0){this.backToArea();}else{if(this.target._x<this.area.x){var offsetX=this.area.x-this.target._x;}else if(this.target._x>this.area.x+this.area.width){offsetX=this.target._x-this.area.x-this.area.width;}else{offsetX=0;}this._elasticRateX=Math.max(0,1-offsetX/this.elasticDistance);if(this.target._y<this.area.y){var offsetY=this.area.y-this.target.y;}else if(this.target._y>this.area.y+this.area.height){offsetY=this.target._y-this.area.y-this.area.height;}else{offsetY=0;}this._elasticRateY=Math.max(0,1-offsetY/this.elasticDistance);}}},{key:"backToArea",value:function backToArea(){this.target.x=Math.min(Math.max(this.target._x,this.area.x),this.area.x+this.area.width);this.target.y=Math.min(Math.max(this.target._y,this.area.y),this.area.y+this.area.height);}},{key:"onStageMouseUp",value:function onStageMouseUp(e){MouseManager.instance.disableMouseEvent=false;ILaya.stage.off(Event.MOUSE_UP,this,this.onStageMouseUp);ILaya.stage.off(Event.MOUSE_OUT,this,this.onStageMouseUp);ILaya.systemTimer.clear(this,this.loop);if(this._clickOnly||!this.target)return;if(this.hasInertia){if(this._offsets.length<1){this._offsets.push(this._parent.mouseX-this._lastX,this._parent.mouseY-this._lastY);}this._offsetX=this._offsetY=0;var len=this._offsets.length;var n=Math.min(len,6);var m=this._offsets.length-n;for(var i=len-1;i>m;i--){this._offsetY+=this._offsets[i--];this._offsetX+=this._offsets[i];}this._offsetX=this._offsetX/n*2;this._offsetY=this._offsetY/n*2;if(Math.abs(this._offsetX)>this.maxOffset)this._offsetX=this._offsetX>0?this.maxOffset:-this.maxOffset;if(Math.abs(this._offsetY)>this.maxOffset)this._offsetY=this._offsetY>0?this.maxOffset:-this.maxOffset;ILaya.systemTimer.frameLoop(1,this,this.tweenMove);}else if(this.elasticDistance>0){this.checkElastic();}else{this.clear();}}},{key:"checkElastic",value:function checkElastic(){var tx=NaN;var ty=NaN;if(this.target.x<this.area.x)tx=this.area.x;else if(this.target._x>this.area.x+this.area.width)tx=this.area.x+this.area.width;if(this.target.y<this.area.y)ty=this.area.y;else if(this.target._y>this.area.y+this.area.height)ty=this.area.y+this.area.height;if(!isNaN(tx)||!isNaN(ty)){var obj={};if(!isNaN(tx))obj.x=tx;if(!isNaN(ty))obj.y=ty;this._tween=Tween.to(this.target,obj,this.elasticBackTime,Ease.sineOut,Handler.create(this,this.clear),0,false,false);}else{this.clear();}}},{key:"tweenMove",value:function tweenMove(){this._offsetX*=this.ratio*this._elasticRateX;this._offsetY*=this.ratio*this._elasticRateY;this.target.x+=this._offsetX;this.target.y+=this._offsetY;this.area&&this.checkArea();this.target.event(Event.DRAG_MOVE,this.data);if(Math.abs(this._offsetX)<1&&Math.abs(this._offsetY)<1||this._elasticRateX<0.5||this._elasticRateY<0.5){ILaya.systemTimer.clear(this,this.tweenMove);if(this.elasticDistance>0)this.checkElastic();else this.clear();}}},{key:"clear",value:function clear(){if(this.target){this.clearTimer();var sp=this.target;this.target=null;this._parent=null;sp.event(Event.DRAG_END,this.data);}}}]);return Dragging;}();var Component=function(){function Component(){_classCallCheck(this,Component);this._id=Utils.getGID();this._resetComp();}_createClass(Component,[{key:"_isScript",value:function _isScript(){return false;}},{key:"_resetComp",value:function _resetComp(){this._indexInList=-1;this._enabled=true;this._awaked=false;this.owner=null;}},{key:"_getIndexInList",value:function _getIndexInList(){return this._indexInList;}},{key:"_setIndexInList",value:function _setIndexInList(index){this._indexInList=index;}},{key:"_onAdded",value:function _onAdded(){}},{key:"_onAwake",value:function _onAwake(){}},{key:"_onEnable",value:function _onEnable(){}},{key:"_onDisable",value:function _onDisable(){}},{key:"_onDestroy",value:function _onDestroy(){}},{key:"onReset",value:function onReset(){}},{key:"_parse",value:function _parse(data){}},{key:"_cloneTo",value:function _cloneTo(dest){}},{key:"_setActive",value:function _setActive(value){if(value){if(!this._awaked){this._awaked=true;this._onAwake();}this._enabled&&this._onEnable();}else{this._enabled&&this._onDisable();}}},{key:"destroy",value:function destroy(){if(this.owner)this.owner._destroyComponent(this);}},{key:"_destroy",value:function _destroy(){if(this.owner.activeInHierarchy&&this._enabled)this._setActive(false);this._onDestroy();this._destroyed=true;if(this.onReset!==Component.prototype.onReset){this.onReset();this._resetComp();Pool.recoverByClass(this);}else{this._resetComp();}}},{key:"id",get:function get(){return this._id;}},{key:"enabled",get:function get(){return this._enabled;},set:function set(value){if(this._enabled!=value){this._enabled=value;if(this.owner){if(value)this.owner.activeInHierarchy&&this._onEnable();else this.owner.activeInHierarchy&&this._onDisable();}}}},{key:"isSingleton",get:function get(){return true;}},{key:"destroyed",get:function get(){return this._destroyed;}}]);return Component;}();var AnimationBase=function(_Sprite3){_inherits(AnimationBase,_Sprite3);function AnimationBase(){_classCallCheck(this,AnimationBase);var _this44=_possibleConstructorReturn(this,(AnimationBase.__proto__||Object.getPrototypeOf(AnimationBase)).call(this));_this44.wrapMode=0;_this44._interval=Config.animationInterval;_this44._isReverse=false;_this44._frameRateChanged=false;_this44._setBitUp(Const.DISPLAY);return _this44;}_createClass(AnimationBase,[{key:"play",value:function play(){var start=arguments.length>0&&arguments[0]!==undefined?arguments[0]:0;var loop=arguments.length>1&&arguments[1]!==undefined?arguments[1]:true;var name=arguments.length>2&&arguments[2]!==undefined?arguments[2]:"";this._isPlaying=true;this._actionName=name;this.index=typeof start=='string'?this._getFrameByLabel(start):start;this.loop=loop;this._isReverse=this.wrapMode===AnimationBase.WRAP_REVERSE;if(this.index==0&&this._isReverse){this.index=this.count-1;}if(this.interval>0)this.timerLoop(this.interval,this,this._frameLoop,null,true,true);}},{key:"_getFrameByLabel",value:function _getFrameByLabel(label){for(var i=0;i<this._count;i++){var item=this._labels[i];if(item&&item.indexOf(label)>-1)return i;}return 0;}},{key:"_frameLoop",value:function _frameLoop(){if(this._isReverse){this._index--;if(this._index<0){if(this.loop){if(this.wrapMode==AnimationBase.WRAP_PINGPONG){this._index=this._count>0?1:0;this._isReverse=false;}else{this._index=this._count-1;}this.event(Event.COMPLETE);}else{this._index=0;this.stop();this.event(Event.COMPLETE);return;}}}else{this._index++;if(this._index>=this._count){if(this.loop){if(this.wrapMode==AnimationBase.WRAP_PINGPONG){this._index=this._count-2>=0?this._count-2:0;this._isReverse=true;}else{this._index=0;}this.event(Event.COMPLETE);}else{this._index--;this.stop();this.event(Event.COMPLETE);return;}}}this.index=this._index;}},{key:"_setControlNode",value:function _setControlNode(node){if(this._controlNode){this._controlNode.off(Event.DISPLAY,this,this._resumePlay);this._controlNode.off(Event.UNDISPLAY,this,this._resumePlay);}this._controlNode=node;if(node&&node!=this){node.on(Event.DISPLAY,this,this._resumePlay);node.on(Event.UNDISPLAY,this,this._resumePlay);}}},{key:"_setDisplay",value:function _setDisplay(value){_get(AnimationBase.prototype.__proto__||Object.getPrototypeOf(AnimationBase.prototype),"_setDisplay",this).call(this,value);this._resumePlay();}},{key:"_resumePlay",value:function _resumePlay(){if(this._isPlaying){if(this._controlNode.displayedInStage)this.play(this._index,this.loop,this._actionName);else this.clearTimer(this,this._frameLoop);}}},{key:"stop",value:function stop(){this._isPlaying=false;this.clearTimer(this,this._frameLoop);}},{key:"addLabel",value:function addLabel(label,index){if(!this._labels)this._labels={};if(!this._labels[index])this._labels[index]=[];this._labels[index].push(label);}},{key:"removeLabel",value:function removeLabel(label){if(!label)this._labels=null;else if(this._labels){for(var name in this._labels){this._removeLabelFromList(this._labels[name],label);}}}},{key:"_removeLabelFromList",value:function _removeLabelFromList(list,label){if(!list)return;for(var i=list.length-1;i>=0;i--){if(list[i]==label){list.splice(i,1);}}}},{key:"gotoAndStop",value:function gotoAndStop(position){this.index=typeof position=='string'?this._getFrameByLabel(position):position;this.stop();}},{key:"_displayToIndex",value:function _displayToIndex(value){}},{key:"clear",value:function clear(){this.stop();this._labels=null;return this;}},{key:"interval",get:function get(){return this._interval;},set:function set(value){if(this._interval!=value){this._frameRateChanged=true;this._interval=value;if(this._isPlaying&&value>0){this.timerLoop(value,this,this._frameLoop,null,true,true);}}}},{key:"isPlaying",get:function get(){return this._isPlaying;}},{key:"index",get:function get(){return this._index;},set:function set(value){this._index=value;this._displayToIndex(value);if(this._labels&&this._labels[value]){var tArr=this._labels[value];for(var i=0,len=tArr.length;i<len;i++){this.event(Event.LABEL,tArr[i]);}}}},{key:"count",get:function get(){return this._count;}}]);return AnimationBase;}(Sprite);AnimationBase.WRAP_POSITIVE=0;AnimationBase.WRAP_REVERSE=1;AnimationBase.WRAP_PINGPONG=2;ClassUtils.regClass("laya.display.AnimationBase",AnimationBase);ClassUtils.regClass("Laya.AnimationBase",AnimationBase);var MathUtil=function(){function MathUtil(){_classCallCheck(this,MathUtil);}_createClass(MathUtil,null,[{key:"subtractVector3",value:function subtractVector3(l,r,o){o[0]=l[0]-r[0];o[1]=l[1]-r[1];o[2]=l[2]-r[2];}},{key:"lerp",value:function lerp(left,right,amount){return left*(1-amount)+right*amount;}},{key:"scaleVector3",value:function scaleVector3(f,b,e){e[0]=f[0]*b;e[1]=f[1]*b;e[2]=f[2]*b;}},{key:"lerpVector3",value:function lerpVector3(l,r,t,o){var ax=l[0],ay=l[1],az=l[2];o[0]=ax+t*(r[0]-ax);o[1]=ay+t*(r[1]-ay);o[2]=az+t*(r[2]-az);}},{key:"lerpVector4",value:function lerpVector4(l,r,t,o){var ax=l[0],ay=l[1],az=l[2],aw=l[3];o[0]=ax+t*(r[0]-ax);o[1]=ay+t*(r[1]-ay);o[2]=az+t*(r[2]-az);o[3]=aw+t*(r[3]-aw);}},{key:"slerpQuaternionArray",value:function slerpQuaternionArray(a,Offset1,b,Offset2,t,out,Offset3){var ax=a[Offset1+0],ay=a[Offset1+1],az=a[Offset1+2],aw=a[Offset1+3],bx=b[Offset2+0],by=b[Offset2+1],bz=b[Offset2+2],bw=b[Offset2+3];var omega,cosom,sinom,scale0,scale1;cosom=ax*bx+ay*by+az*bz+aw*bw;if(cosom<0.0){cosom=-cosom;bx=-bx;by=-by;bz=-bz;bw=-bw;}if(1.0-cosom>0.000001){omega=Math.acos(cosom);sinom=Math.sin(omega);scale0=Math.sin((1.0-t)*omega)/sinom;scale1=Math.sin(t*omega)/sinom;}else{scale0=1.0-t;scale1=t;}out[Offset3+0]=scale0*ax+scale1*bx;out[Offset3+1]=scale0*ay+scale1*by;out[Offset3+2]=scale0*az+scale1*bz;out[Offset3+3]=scale0*aw+scale1*bw;return out;}},{key:"getRotation",value:function getRotation(x0,y0,x1,y1){return Math.atan2(y1-y0,x1-x0)/Math.PI*180;}},{key:"sortBigFirst",value:function sortBigFirst(a,b){if(a==b)return 0;return b>a?1:-1;}},{key:"sortSmallFirst",value:function sortSmallFirst(a,b){if(a==b)return 0;return b>a?-1:1;}},{key:"sortNumBigFirst",value:function sortNumBigFirst(a,b){return parseFloat(b)-parseFloat(a);}},{key:"sortNumSmallFirst",value:function sortNumSmallFirst(a,b){return parseFloat(a)-parseFloat(b);}},{key:"sortByKey",value:function sortByKey(key){var bigFirst=arguments.length>1&&arguments[1]!==undefined?arguments[1]:false;var forceNum=arguments.length>2&&arguments[2]!==undefined?arguments[2]:true;var _sortFun;if(bigFirst){_sortFun=forceNum?MathUtil.sortNumBigFirst:MathUtil.sortBigFirst;}else{_sortFun=forceNum?MathUtil.sortNumSmallFirst:MathUtil.sortSmallFirst;}return function(a,b){return _sortFun(a[key],b[key]);};}}]);return MathUtil;}();var FrameAnimation=function(_AnimationBase){_inherits(FrameAnimation,_AnimationBase);function FrameAnimation(){_classCallCheck(this,FrameAnimation);var _this45=_possibleConstructorReturn(this,(FrameAnimation.__proto__||Object.getPrototypeOf(FrameAnimation)).call(this));if(FrameAnimation._sortIndexFun===null){FrameAnimation._sortIndexFun=MathUtil.sortByKey("index",false,true);}return _this45;}_createClass(FrameAnimation,[{key:"_setUp",value:function _setUp(targetDic,animationData){this._targetDic=targetDic;this._animationData=animationData;this.interval=1000/animationData.frameRate;if(animationData.parsed){this._count=animationData.count;this._labels=animationData.labels;this._usedFrames=animationData.animationNewFrames;}else{this._usedFrames=[];this._calculateDatas();animationData.parsed=true;animationData.labels=this._labels;animationData.count=this._count;animationData.animationNewFrames=this._usedFrames;}}},{key:"clear",value:function clear(){_get(FrameAnimation.prototype.__proto__||Object.getPrototypeOf(FrameAnimation.prototype),"clear",this).call(this);this._targetDic=null;this._animationData=null;return this;}},{key:"_displayToIndex",value:function _displayToIndex(value){if(!this._animationData)return;if(value<0)value=0;if(value>this._count)value=this._count;var nodes=this._animationData.nodes,i,len=nodes.length;for(i=0;i<len;i++){this._displayNodeToFrame(nodes[i],value);}}},{key:"_displayNodeToFrame",value:function _displayNodeToFrame(node,frame){var targetDic=arguments.length>2&&arguments[2]!==undefined?arguments[2]:null;if(!targetDic)targetDic=this._targetDic;var target=targetDic[node.target];if(!target){return;}var frames=node.frames,key,propFrames,value;var keys=node.keys,i,len=keys.length;for(i=0;i<len;i++){key=keys[i];propFrames=frames[key];if(propFrames.length>frame){value=propFrames[frame];}else{value=propFrames[propFrames.length-1];}target[key]=value;}var funkeys=node.funkeys;len=funkeys.length;var funFrames;if(len==0)return;for(i=0;i<len;i++){key=funkeys[i];funFrames=frames[key];if(funFrames[frame]!==undefined){target[key]&&target[key].apply(target,funFrames[frame]);}}}},{key:"_calculateDatas",value:function _calculateDatas(){if(!this._animationData)return;var nodes=this._animationData.nodes,i,len=nodes.length,tNode;this._count=0;for(i=0;i<len;i++){tNode=nodes[i];this._calculateKeyFrames(tNode);}this._count+=1;}},{key:"_calculateKeyFrames",value:function _calculateKeyFrames(node){var keyFrames=node.keyframes,key,tKeyFrames,target=node.target;if(!node.frames)node.frames={};if(!node.keys)node.keys=[];else node.keys.length=0;if(!node.funkeys)node.funkeys=[];else node.funkeys.length=0;if(!node.initValues)node.initValues={};for(key in keyFrames){var isFun=key.indexOf("()")!=-1;tKeyFrames=keyFrames[key];if(isFun)key=key.substr(0,key.length-2);if(!node.frames[key]){node.frames[key]=[];}if(!isFun){if(this._targetDic&&this._targetDic[target]){node.initValues[key]=this._targetDic[target][key];}tKeyFrames.sort(FrameAnimation._sortIndexFun);node.keys.push(key);this._calculateNodePropFrames(tKeyFrames,node.frames[key],key,target);}else{node.funkeys.push(key);var map=node.frames[key];for(var i=0;i<tKeyFrames.length;i++){var temp=tKeyFrames[i];map[temp.index]=temp.value;if(temp.index>this._count)this._count=temp.index;}}}}},{key:"resetNodes",value:function resetNodes(){if(!this._targetDic)return;if(!this._animationData)return;var nodes=this._animationData.nodes,i,len=nodes.length;var tNode;var initValues;for(i=0;i<len;i++){tNode=nodes[i];initValues=tNode.initValues;if(!initValues)continue;var target=this._targetDic[tNode.target];if(!target)continue;var key;for(key in initValues){target[key]=initValues[key];}}}},{key:"_calculateNodePropFrames",value:function _calculateNodePropFrames(keyframes,frames,key,target){var i,len=keyframes.length-1;frames.length=keyframes[len].index+1;for(i=0;i<len;i++){this._dealKeyFrame(keyframes[i]);this._calculateFrameValues(keyframes[i],keyframes[i+1],frames);}if(len==0){frames[0]=keyframes[0].value;if(this._usedFrames)this._usedFrames[keyframes[0].index]=true;}this._dealKeyFrame(keyframes[i]);}},{key:"_dealKeyFrame",value:function _dealKeyFrame(keyFrame){if(keyFrame.label&&keyFrame.label!="")this.addLabel(keyFrame.label,keyFrame.index);}},{key:"_calculateFrameValues",value:function _calculateFrameValues(startFrame,endFrame,result){var i,easeFun;var start=startFrame.index,end=endFrame.index;var startValue=startFrame.value;var dValue=endFrame.value-startFrame.value;var dLen=end-start;var frames=this._usedFrames;if(end>this._count)this._count=end;if(startFrame.tween){easeFun=Ease[startFrame.tweenMethod];if(easeFun==null)easeFun=Ease.linearNone;for(i=start;i<end;i++){result[i]=easeFun(i-start,startValue,dValue,dLen);if(frames)frames[i]=true;}}else{for(i=start;i<end;i++){result[i]=startValue;}}if(frames){frames[startFrame.index]=true;frames[endFrame.index]=true;}result[endFrame.index]=endFrame.value;}}]);return FrameAnimation;}(AnimationBase);ClassUtils.regClass("laya.display.FrameAnimation",FrameAnimation);ClassUtils.regClass("Laya.FrameAnimation",FrameAnimation);var WeakObject=function(){function WeakObject(){_classCallCheck(this,WeakObject);this._obj={};WeakObject._maps.push(this);}_createClass(WeakObject,[{key:"set",value:function set(key,value){if(key==null)return;if(WeakObject.supportWeakMap);else{if(typeof key=='string'||typeof key=='number'){this._obj[key]=value;}else{key.$_GID||(key.$_GID=Utils.getGID());this._obj[key.$_GID]=value;}}}},{key:"get",value:function get(key){if(key==null)return null;if(WeakObject.supportWeakMap);else{if(typeof key=='string'||typeof key=='number')return this._obj[key];return this._obj[key.$_GID];}}},{key:"del",value:function del(key){if(key==null)return;if(WeakObject.supportWeakMap);else{if(typeof key=='string'||typeof key=='number')delete this._obj[key];else delete this._obj[this._obj.$_GID];}}},{key:"has",value:function has(key){if(key==null)return false;if(WeakObject.supportWeakMap);else{if(typeof key=='string'||typeof key=='number')return this._obj[key]!=null;return this._obj[this._obj.$_GID]!=null;}}}],[{key:"__init__",value:function __init__(){WeakObject.I=new WeakObject();if(!WeakObject.supportWeakMap)ILaya.systemTimer.loop(WeakObject.delInterval,null,WeakObject.clearCache);}},{key:"clearCache",value:function clearCache(){for(var i=0,n=WeakObject._maps.length;i<n;i++){var obj=WeakObject._maps[i];obj._obj={};}}}]);return WeakObject;}();WeakObject.supportWeakMap=false;WeakObject.delInterval=10*60*1000;WeakObject._maps=[];var SceneUtils=function(){function SceneUtils(){_classCallCheck(this,SceneUtils);}_createClass(SceneUtils,null,[{key:"__init",value:function __init(){SceneUtils._funMap=new WeakObject();}},{key:"getBindFun",value:function getBindFun(value){var fun=SceneUtils._funMap.get(value);if(fun==null){var temp="\""+value+"\"";temp=temp.replace(/^"\${|}"$/g,"").replace(/\${/g,"\"+").replace(/}/g,"+\"");var str="(function(data){if(data==null)return;with(data){try{\nreturn "+temp+"\n}catch(e){}}})";fun=window.Laya._runScript(str);SceneUtils._funMap.set(value,fun);}return fun;}},{key:"createByData",value:function createByData(root,uiView){var tInitTool=InitTool.create();root=SceneUtils.createComp(uiView,root,root,null,tInitTool);root._setBit(Const.NOT_READY,true);if("_idMap"in root){root["_idMap"]=tInitTool._idMap;}if(uiView.animations){var anilist=[];var animations=uiView.animations;var i,len=animations.length;var tAni;var tAniO;for(i=0;i<len;i++){tAni=new FrameAnimation();tAniO=animations[i];tAni._setUp(tInitTool._idMap,tAniO);root[tAniO.name]=tAni;tAni._setControlNode(root);switch(tAniO.action){case 1:tAni.play(0,false);break;case 2:tAni.play(0,true);break;}anilist.push(tAni);}root._aniList=anilist;}if(root._$componentType==="Scene"&&root._width>0&&uiView.props.hitTestPrior==null&&!root.mouseThrough)root.hitTestPrior=true;tInitTool.beginLoad(root);return root;}},{key:"createInitTool",value:function createInitTool(){return InitTool.create();}},{key:"createComp",value:function createComp(uiView){var comp=arguments.length>1&&arguments[1]!==undefined?arguments[1]:null;var view=arguments.length>2&&arguments[2]!==undefined?arguments[2]:null;var dataMap=arguments.length>3&&arguments[3]!==undefined?arguments[3]:null;var initTool=arguments.length>4&&arguments[4]!==undefined?arguments[4]:null;if(uiView.type=="Scene3D"||uiView.type=="Sprite3D"){var outBatchSprits=[];var scene3D=ILaya.Laya["Utils3D"]._createSceneByJsonForMaker(uiView,outBatchSprits,initTool);if(uiView.type=="Sprite3D")ILaya.Laya["StaticBatchManager"].combine(scene3D,outBatchSprits);else ILaya.Laya["StaticBatchManager"].combine(null,outBatchSprits);return scene3D;}comp=comp||SceneUtils.getCompInstance(uiView);if(!comp){if(uiView.props&&uiView.props.runtime)console.warn("runtime not found:"+uiView.props.runtime);else console.warn("can not create:"+uiView.type);return null;}var child=uiView.child;if(child){var isList=comp["_$componentType"]=="List";for(var i=0,n=child.length;i<n;i++){var node=child[i];if('itemRender'in comp&&(node.props.name=="render"||node.props.renderType==="render")){comp["itemRender"]=node;}else if(node.type=="Graphic"){ILaya.ClassUtils._addGraphicsToSprite(node,comp);}else if(ILaya.ClassUtils._isDrawType(node.type)){ILaya.ClassUtils._addGraphicToSprite(node,comp,true);}else{if(isList){var arr=[];var tChild=SceneUtils.createComp(node,null,view,arr,initTool);if(arr.length)tChild["_$bindData"]=arr;}else{tChild=SceneUtils.createComp(node,null,view,dataMap,initTool);}if(node.type=="Script"){if(tChild instanceof Component){comp._addComponentInstance(tChild);}else{if("owner"in tChild){tChild["owner"]=comp;}else if("target"in tChild){tChild["target"]=comp;}}}else if(node.props.renderType=="mask"||node.props.name=="mask"){comp.mask=tChild;}else{tChild instanceof Node&&comp.addChild(tChild);}}}}var props=uiView.props;for(var prop in props){var value=props[prop];if(typeof value=='string'&&(value.indexOf("@node:")>=0||value.indexOf("@Prefab:")>=0)){if(initTool){initTool.addNodeRef(comp,prop,value);}}else SceneUtils.setCompValue(comp,prop,value,view,dataMap);}if(comp._afterInited){comp._afterInited();}if(uiView.compId&&initTool&&initTool._idMap){initTool._idMap[uiView.compId]=comp;}return comp;}},{key:"setCompValue",value:function setCompValue(comp,prop,value){var view=arguments.length>3&&arguments[3]!==undefined?arguments[3]:null;var dataMap=arguments.length>4&&arguments[4]!==undefined?arguments[4]:null;if(typeof value=='string'&&value.indexOf("${")>-1){SceneUtils._sheet||(SceneUtils._sheet=ILaya.ClassUtils.getClass("laya.data.Table"));if(!SceneUtils._sheet){console.warn("Can not find class Sheet");return;}if(dataMap){dataMap.push(comp,prop,value);}else if(view){if(value.indexOf("].")==-1){value=value.replace(".","[0].");}var watcher=new DataWatcher(comp,prop,value);watcher.exe(view);var one,temp;var str=value.replace(/\[.*?\]\./g,".");while((one=SceneUtils._parseWatchData.exec(str))!=null){var key1=one[1];while((temp=SceneUtils._parseKeyWord.exec(key1))!=null){var key2=temp[0];var arr=view._watchMap[key2]||(view._watchMap[key2]=[]);arr.push(watcher);SceneUtils._sheet.I.notifer.on(key2,view,view.changeData,[key2]);}arr=view._watchMap[key1]||(view._watchMap[key1]=[]);arr.push(watcher);SceneUtils._sheet.I.notifer.on(key1,view,view.changeData,[key1]);}}return;}if(prop==="var"&&view){view[value]=comp;}else{comp[prop]=value==="true"?true:value==="false"?false:value;}}},{key:"getCompInstance",value:function getCompInstance(json){if(json.type=="UIView"){if(json.props&&json.props.pageData){return SceneUtils.createByData(null,json.props.pageData);}}var runtime=json.props&&json.props.runtime||json.type;var compClass=ILaya.ClassUtils.getClass(runtime);if(!compClass)throw"Can not find class "+runtime;if(json.type==="Script"&&compClass.prototype._doAwake){var comp=Pool.createByClass(compClass);comp._destroyed=false;return comp;}if(json.props&&"renderType"in json.props&&json.props["renderType"]=="instance"){if(!compClass["instance"])compClass["instance"]=new compClass();return compClass["instance"];}return new compClass();}}]);return SceneUtils;}();SceneUtils._parseWatchData=/\${(.*?)}/g;SceneUtils._parseKeyWord=/[a-zA-Z_][a-zA-Z0-9_]*(?:(?:\.[a-zA-Z_][a-zA-Z0-9_]*)+)/g;var DataWatcher=function(){function DataWatcher(comp,prop,value){_classCallCheck(this,DataWatcher);this.comp=comp;this.prop=prop;this.value=value;}_createClass(DataWatcher,[{key:"exe",value:function exe(view){var fun=SceneUtils.getBindFun(this.value);this.comp[this.prop]=fun.call(this,view);}}]);return DataWatcher;}();var InitTool=function(){function InitTool(){_classCallCheck(this,InitTool);}_createClass(InitTool,[{key:"reset",value:function reset(){this._nodeRefList=null;this._initList=null;this._idMap=null;this._loadList=null;this._scene=null;}},{key:"recover",value:function recover(){this.reset();Pool.recover("InitTool",this);}},{key:"addLoadRes",value:function addLoadRes(url){var type=arguments.length>1&&arguments[1]!==undefined?arguments[1]:null;if(!this._loadList)this._loadList=[];if(!type){this._loadList.push(url);}else{this._loadList.push({url:url,type:type});}}},{key:"addNodeRef",value:function addNodeRef(node,prop,referStr){if(!this._nodeRefList)this._nodeRefList=[];this._nodeRefList.push([node,prop,referStr]);if(referStr.indexOf("@Prefab:")>=0){this.addLoadRes(referStr.replace("@Prefab:",""),Loader.PREFAB);}}},{key:"setNodeRef",value:function setNodeRef(){if(!this._nodeRefList)return;if(!this._idMap){this._nodeRefList=null;return;}var i,len;len=this._nodeRefList.length;var tRefInfo;for(i=0;i<len;i++){tRefInfo=this._nodeRefList[i];tRefInfo[0][tRefInfo[1]]=this.getReferData(tRefInfo[2]);}this._nodeRefList=null;}},{key:"getReferData",value:function getReferData(referStr){if(referStr.indexOf("@Prefab:")>=0){var prefab;prefab=Loader.getRes(referStr.replace("@Prefab:",""));return prefab;}else if(referStr.indexOf("@arr:")>=0){referStr=referStr.replace("@arr:","");var list;list=referStr.split(",");var i,len;var tStr;len=list.length;for(i=0;i<len;i++){tStr=list[i];if(tStr){list[i]=this._idMap[tStr.replace("@node:","")];}else{list[i]=null;}}return list;}else{return this._idMap[referStr.replace("@node:","")];}}},{key:"addInitItem",value:function addInitItem(item){if(!this._initList)this._initList=[];this._initList.push(item);}},{key:"doInits",value:function doInits(){if(!this._initList)return;this._initList=null;}},{key:"finish",value:function finish(){this.setNodeRef();this.doInits();this._scene._setBit(Const.NOT_READY,false);if(this._scene.parent&&this._scene.parent.activeInHierarchy&&this._scene.active)this._scene._processActive();this._scene.event("onViewCreated");this.recover();}},{key:"beginLoad",value:function beginLoad(scene){this._scene=scene;if(!this._loadList||this._loadList.length<1){this.finish();}else{ILaya.loader.load(this._loadList,Handler.create(this,this.finish));}}}],[{key:"create",value:function create(){var tool=Pool.getItemByClass("InitTool",InitTool);tool._idMap=[];return tool;}}]);return InitTool;}();var IStatRender=function(){function IStatRender(){_classCallCheck(this,IStatRender);}_createClass(IStatRender,[{key:"show",value:function show(){var x=arguments.length>0&&arguments[0]!==undefined?arguments[0]:0;var y=arguments.length>1&&arguments[1]!==undefined?arguments[1]:0;}},{key:"enable",value:function enable(){}},{key:"hide",value:function hide(){}},{key:"set_onclick",value:function set_onclick(fn){}},{key:"isCanvasRender",value:function isCanvasRender(){return true;}},{key:"renderNotCanvas",value:function renderNotCanvas(ctx,x,y){}}]);return IStatRender;}();var StatUI=function(_IStatRender){_inherits(StatUI,_IStatRender);function StatUI(){_classCallCheck(this,StatUI);var _this46=_possibleConstructorReturn(this,(StatUI.__proto__||Object.getPrototypeOf(StatUI)).apply(this,arguments));_this46._show=false;_this46._useCanvas=false;_this46._height=100;_this46._view=[];return _this46;}_createClass(StatUI,[{key:"show",value:function show(){var x=arguments.length>0&&arguments[0]!==undefined?arguments[0]:0;var y=arguments.length>1&&arguments[1]!==undefined?arguments[1]:0;if(!Browser.onMiniGame&&!ILaya.Render.isConchApp&&!Browser.onBDMiniGame&&!Browser.onKGMiniGame&&!Browser.onQGMiniGame&&!Browser.onQQMiniGame&&!Browser.onAlipayMiniGame)this._useCanvas=true;this._show=true;Stat._fpsData.length=60;this._view[0]={title:"FPS(Canvas)",value:"_fpsStr",color:"yellow",units:"int"};this._view[1]={title:"Sprite",value:"_spriteStr",color:"white",units:"int"};this._view[2]={title:"RenderBatches",value:"renderBatches",color:"white",units:"int"};this._view[3]={title:"SavedRenderBatches",value:"savedRenderBatches",color:"white",units:"int"};this._view[4]={title:"CPUMemory",value:"cpuMemory",color:"yellow",units:"M"};this._view[5]={title:"GPUMemory",value:"gpuMemory",color:"yellow",units:"M"};this._view[6]={title:"Shader",value:"shaderCall",color:"white",units:"int"};if(!Render.is3DMode){this._view[0].title="FPS(WebGL)";this._view[7]={title:"Canvas",value:"_canvasStr",color:"white",units:"int"};}else{this._view[0].title="FPS(3D)";this._view[7]={title:"TriFaces",value:"trianglesFaces",color:"white",units:"int"};this._view[8]={title:"FrustumCulling",value:"frustumCulling",color:"white",units:"int"};this._view[9]={title:"OctreeNodeCulling",value:"octreeNodeCulling",color:"white",units:"int"};}if(this._useCanvas){this.createUIPre(x,y);}else this.createUI(x,y);this.enable();}},{key:"createUIPre",value:function createUIPre(x,y){var pixel=Browser.pixelRatio;this._width=pixel*180;this._vx=pixel*120;this._height=pixel*(this._view.length*12+3*pixel)+4;StatUI._fontSize=12*pixel;for(var i=0;i<this._view.length;i++){this._view[i].x=4;this._view[i].y=i*StatUI._fontSize+2*pixel;}if(!this._canvas){this._canvas=new HTMLCanvas(true);this._canvas.size(this._width,this._height);this._ctx=this._canvas.getContext('2d');this._ctx.textBaseline="top";this._ctx.font=StatUI._fontSize+"px Arial";this._canvas.source.style.cssText="pointer-events:none;background:rgba(150,150,150,0.8);z-index:100000;position: absolute;direction:ltr;left:"+x+"px;top:"+y+"px;width:"+this._width/pixel+"px;height:"+this._height/pixel+"px;";}if(!Browser.onKGMiniGame){Browser.container.appendChild(this._canvas.source);}this._first=true;this.loop();this._first=false;}},{key:"createUI",value:function createUI(x,y){var stat=this._sp;var pixel=Browser.pixelRatio;if(!stat){stat=new Sprite();this._leftText=new Text();this._leftText.pos(5,5);this._leftText.color="#ffffff";stat.addChild(this._leftText);this._txt=new Text();this._txt.pos(130*pixel,5);this._txt.color="#ffffff";stat.addChild(this._txt);this._sp=stat;}stat.pos(x,y);var text="";for(var i=0;i<this._view.length;i++){var one=this._view[i];text+=one.title+"\n";}this._leftText.text=text;var width=pixel*138;var height=pixel*(this._view.length*12+3*pixel)+4;this._txt.fontSize=StatUI._fontSize*pixel;this._leftText.fontSize=StatUI._fontSize*pixel;stat.size(width,height);stat.graphics.clear();stat.graphics.alpha(0.5);stat.graphics.drawRect(0,0,width+110,height+30,"#999999");stat.graphics.alpha(2);this.loop();}},{key:"enable",value:function enable(){ILaya.systemTimer.frameLoop(1,this,this.loop);}},{key:"hide",value:function hide(){this._show=false;ILaya.systemTimer.clear(this,this.loop);if(this._canvas){Browser.removeElement(this._canvas.source);}}},{key:"set_onclick",value:function set_onclick(fn){if(this._sp){this._sp.on("click",this._sp,fn);}if(this._canvas){this._canvas.source.onclick=fn;this._canvas.source.style.pointerEvents='';}}},{key:"loop",value:function loop(){Stat._count++;var timer=Browser.now();if(timer-Stat._timer<1000)return;var count=Stat._count;Stat.FPS=Math.round(count*1000/(timer-Stat._timer));if(this._show){Stat.trianglesFaces=Math.round(Stat.trianglesFaces/count);if(!this._useCanvas){Stat.renderBatches=Math.round(Stat.renderBatches/count)-1;}else{Stat.renderBatches=Math.round(Stat.renderBatches/count);}Stat.savedRenderBatches=Math.round(Stat.savedRenderBatches/count);Stat.shaderCall=Math.round(Stat.shaderCall/count);Stat.spriteRenderUseCacheCount=Math.round(Stat.spriteRenderUseCacheCount/count);Stat.canvasNormal=Math.round(Stat.canvasNormal/count);Stat.canvasBitmap=Math.round(Stat.canvasBitmap/count);Stat.canvasReCache=Math.ceil(Stat.canvasReCache/count);Stat.frustumCulling=Math.round(Stat.frustumCulling/count);Stat.octreeNodeCulling=Math.round(Stat.octreeNodeCulling/count);var delay=Stat.FPS>0?Math.floor(1000/Stat.FPS).toString():" ";Stat._fpsStr=Stat.FPS+(Stat.renderSlow?" slow":"")+" "+delay;Stat._spriteStr=Stat.spriteCount+(Stat.spriteRenderUseCacheCount?"/"+Stat.spriteRenderUseCacheCount:'');Stat._canvasStr=Stat.canvasReCache+"/"+Stat.canvasNormal+"/"+Stat.canvasBitmap;Stat.cpuMemory=Resource.cpuMemory;Stat.gpuMemory=Resource.gpuMemory;if(this._useCanvas){this.renderInfoPre();}else this.renderInfo();Stat.clear();}Stat._count=0;Stat._timer=timer;}},{key:"renderInfoPre",value:function renderInfoPre(){var i=0;var one;var value;if(this._canvas){var ctx=this._ctx;ctx.clearRect(this._first?0:this._vx,0,this._width,this._height);for(i=0;i<this._view.length;i++){one=this._view[i];if(this._first){ctx.fillStyle="white";ctx.fillText(one.title,one.x,one.y);}ctx.fillStyle=one.color;value=Stat[one.value];one.units=="M"&&(value=Math.floor(value/(1024*1024)*100)/100+" M");ctx.fillText(value+"",one.x+this._vx,one.y);}}}},{key:"renderInfo",value:function renderInfo(){var text="";for(var i=0;i<this._view.length;i++){var one=this._view[i];var value=Stat[one.value];one.units=="M"&&(value=Math.floor(value/(1024*1024)*100)/100+" M");one.units=="K"&&(value=Math.floor(value/1024*100)/100+" K");text+=value+"\n";}this._txt.text=text;}},{key:"isCanvasRender",value:function isCanvasRender(){return this._useCanvas;}},{key:"renderNotCanvas",value:function renderNotCanvas(ctx,x,y){this._show&&this._sp&&this._sp.render(ctx,0,0);}}]);return StatUI;}(IStatRender);StatUI._fontSize=12;var Timer=function(){function Timer(){var autoActive=arguments.length>0&&arguments[0]!==undefined?arguments[0]:true;_classCallCheck(this,Timer);this.scale=1;this.currTimer=Date.now();this.currFrame=0;this._delta=0;this._lastTimer=Date.now();this._map=[];this._handlers=[];this._temp=[];this._count=0;autoActive&&Timer.gSysTimer&&Timer.gSysTimer.frameLoop(1,this,this._update);}_createClass(Timer,[{key:"_update",value:function _update(){if(this.scale<=0){this._lastTimer=Date.now();this._delta=0;return;}var frame=this.currFrame=this.currFrame+this.scale;var now=Date.now();var awake=now-this._lastTimer>30000;this._delta=(now-this._lastTimer)*this.scale;var timer=this.currTimer=this.currTimer+this._delta;this._lastTimer=now;var handlers=this._handlers;this._count=0;for(var i=0,n=handlers.length;i<n;i++){var handler=handlers[i];if(handler.method!==null){var t=handler.userFrame?frame:timer;if(t>=handler.exeTime){if(handler.repeat){if(!handler.jumpFrame||awake){handler.exeTime+=handler.delay;handler.run(false);if(t>handler.exeTime){handler.exeTime+=Math.ceil((t-handler.exeTime)/handler.delay)*handler.delay;}}else{while(t>=handler.exeTime){handler.exeTime+=handler.delay;handler.run(false);}}}else{handler.run(true);}}}else{this._count++;}}// if (this._count > 30 || frame % 200 === 0)
this._clearHandlers();}},{key:"_clearHandlers",value:function _clearHandlers(){var handlers=this._handlers;for(var i=0,n=handlers.length;i<n;i++){var handler=handlers[i];if(handler.method!==null)this._temp.push(handler);else this._recoverHandler(handler);}this._handlers=this._temp;handlers.length=0;this._temp=handlers;}},{key:"_recoverHandler",value:function _recoverHandler(handler){if(this._map[handler.key]==handler)this._map[handler.key]=null;handler.clear();Timer._pool.push(handler);}},{key:"_create",value:function _create(useFrame,repeat,delay,caller,method,args,coverBefore){if(!delay){method.apply(caller,args);return null;}if(coverBefore){var handler=this._getHandler(caller,method);if(handler){handler.repeat=repeat;handler.userFrame=useFrame;handler.delay=delay;handler.caller=caller;handler.method=method;handler.args=args;handler.exeTime=delay+(useFrame?this.currFrame:this.currTimer+Date.now()-this._lastTimer);return handler;}}handler=Timer._pool.length>0?Timer._pool.pop():new TimerHandler();handler.repeat=repeat;handler.userFrame=useFrame;handler.delay=delay;handler.caller=caller;handler.method=method;handler.args=args;handler.exeTime=delay+(useFrame?this.currFrame:this.currTimer+Date.now()-this._lastTimer);this._indexHandler(handler);this._handlers.push(handler);return handler;}},{key:"_indexHandler",value:function _indexHandler(handler){var caller=handler.caller;var method=handler.method;var cid=caller?caller.$_GID||(caller.$_GID=ILaya.Utils.getGID()):0;var mid=method.$_TID||(method.$_TID=Timer._mid++*100000);handler.key=cid+mid;this._map[handler.key]=handler;}},{key:"once",value:function once(delay,caller,method){var args=arguments.length>3&&arguments[3]!==undefined?arguments[3]:null;var coverBefore=arguments.length>4&&arguments[4]!==undefined?arguments[4]:true;this._create(false,false,delay,caller,method,args,coverBefore);}},{key:"loop",value:function loop(delay,caller,method){var args=arguments.length>3&&arguments[3]!==undefined?arguments[3]:null;var coverBefore=arguments.length>4&&arguments[4]!==undefined?arguments[4]:true;var jumpFrame=arguments.length>5&&arguments[5]!==undefined?arguments[5]:false;var handler=this._create(false,true,delay,caller,method,args,coverBefore);if(handler)handler.jumpFrame=jumpFrame;}},{key:"frameOnce",value:function frameOnce(delay,caller,method){var args=arguments.length>3&&arguments[3]!==undefined?arguments[3]:null;var coverBefore=arguments.length>4&&arguments[4]!==undefined?arguments[4]:true;this._create(true,false,delay,caller,method,args,coverBefore);}},{key:"frameLoop",value:function frameLoop(delay,caller,method){var args=arguments.length>3&&arguments[3]!==undefined?arguments[3]:null;var coverBefore=arguments.length>4&&arguments[4]!==undefined?arguments[4]:true;this._create(true,true,delay,caller,method,args,coverBefore);}},{key:"toString",value:function toString(){return" handlers:"+this._handlers.length+" pool:"+Timer._pool.length;}},{key:"clear",value:function clear(caller,method){var handler=this._getHandler(caller,method);if(handler){this._map[handler.key]=null;handler.key=0;handler.clear();}}},{key:"clearAll",value:function clearAll(caller){if(!caller)return;for(var i=0,n=this._handlers.length;i<n;i++){var handler=this._handlers[i];if(handler.caller===caller){this._map[handler.key]=null;handler.key=0;handler.clear();}}}},{key:"_getHandler",value:function _getHandler(caller,method){var cid=caller?caller.$_GID||(caller.$_GID=ILaya.Utils.getGID()):0;var mid=method.$_TID||(method.$_TID=Timer._mid++*100000);return this._map[cid+mid];}},{key:"callLater",value:function callLater(caller,method){var args=arguments.length>2&&arguments[2]!==undefined?arguments[2]:null;CallLater.I.callLater(caller,method,args);}},{key:"runCallLater",value:function runCallLater(caller,method){CallLater.I.runCallLater(caller,method);}},{key:"runTimer",value:function runTimer(caller,method){var handler=this._getHandler(caller,method);if(handler&&handler.method!=null){this._map[handler.key]=null;handler.run(true);}}},{key:"pause",value:function pause(){this.scale=0;}},{key:"resume",value:function resume(){this.scale=1;}},{key:"delta",get:function get(){return this._delta;}}]);return Timer;}();Timer.gSysTimer=null;Timer._pool=[];Timer._mid=1;var TimerHandler=function(){function TimerHandler(){_classCallCheck(this,TimerHandler);}_createClass(TimerHandler,[{key:"clear",value:function clear(){this.caller=null;this.method=null;this.args=null;}},{key:"run",value:function run(withClear){var caller=this.caller;if(caller&&caller.destroyed)return this.clear();var method=this.method;var args=this.args;withClear&&this.clear();if(method==null)return;args?method.apply(caller,args):method.call(caller);}}]);return TimerHandler;}();var SkinSV=function(_Value2D){_inherits(SkinSV,_Value2D);function SkinSV(type){_classCallCheck(this,SkinSV);var _this47=_possibleConstructorReturn(this,(SkinSV.__proto__||Object.getPrototypeOf(SkinSV)).call(this,ShaderDefines2D.SKINMESH,0));_this47.offsetX=300;_this47.offsetY=0;var gl=WebGLContext.mainContext;var _vlen=8*CONST3D2D.BYTES_PE;_this47.position=[2,gl.FLOAT,false,_vlen,0];_this47.texcoord=[2,gl.FLOAT,false,_vlen,2*CONST3D2D.BYTES_PE];_this47.color=[4,gl.FLOAT,false,_vlen,4*CONST3D2D.BYTES_PE];return _this47;}return SkinSV;}(Value2D);var PrimitiveSV=function(_Value2D2){_inherits(PrimitiveSV,_Value2D2);function PrimitiveSV(args){_classCallCheck(this,PrimitiveSV);var _this48=_possibleConstructorReturn(this,(PrimitiveSV.__proto__||Object.getPrototypeOf(PrimitiveSV)).call(this,ShaderDefines2D.PRIMITIVE,0));_this48._attribLocation=['position',0,'attribColor',1];return _this48;}return PrimitiveSV;}(Value2D);var TextureSV=function(_Value2D3){_inherits(TextureSV,_Value2D3);function TextureSV(){var subID=arguments.length>0&&arguments[0]!==undefined?arguments[0]:0;_classCallCheck(this,TextureSV);var _this49=_possibleConstructorReturn(this,(TextureSV.__proto__||Object.getPrototypeOf(TextureSV)).call(this,ShaderDefines2D.TEXTURE2D,subID));_this49.strength=0;_this49.blurInfo=null;_this49.colorMat=null;_this49.colorAlpha=null;_this49._attribLocation=['posuv',0,'attribColor',1,'attribFlags',2];return _this49;}_createClass(TextureSV,[{key:"clear",value:function clear(){this.texture=null;this.shader=null;this.defines._value=this.subID;}}]);return TextureSV;}(Value2D);var InlcudeFile=function(){function InlcudeFile(txt){_classCallCheck(this,InlcudeFile);this.codes={};this.funs={};this.curUseID=-1;this.funnames="";this.script=txt;var begin=0,ofs,end;while(true){begin=txt.indexOf("#begin",begin);if(begin<0)break;end=begin+5;while(true){end=txt.indexOf("#end",end);if(end<0)break;if(txt.charAt(end+4)==='i')end+=5;else break;}if(end<0){throw"add include err,no #end:"+txt;}ofs=txt.indexOf('\n',begin);var words=ILaya.ShaderCompile.splitToWords(txt.substr(begin,ofs-begin),null);if(words[1]=='code'){this.codes[words[2]]=txt.substr(ofs+1,end-ofs-1);}else if(words[1]=='function'){ofs=txt.indexOf("function",begin);ofs+="function".length;this.funs[words[3]]=txt.substr(ofs+1,end-ofs-1);this.funnames+=words[3]+";";}begin=end+1;}}_createClass(InlcudeFile,[{key:"getWith",value:function getWith(){var name=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;var r=name?this.codes[name]:this.script;if(!r){throw"get with error:"+name;}return r;}},{key:"getFunsScript",value:function getFunsScript(funsdef){var r="";for(var i in this.funs){if(funsdef.indexOf(i+";")>=0){r+=this.funs[i];}}return r;}}]);return InlcudeFile;}();var ShaderNode=function(){function ShaderNode(includefiles){_classCallCheck(this,ShaderNode);this.childs=[];this.text="";this.useFuns="";this.z=0;this.includefiles=includefiles;}_createClass(ShaderNode,[{key:"setParent",value:function setParent(parent){parent.childs.push(this);this.z=parent.z+1;this.parent=parent;}},{key:"setCondition",value:function setCondition(condition,type){if(condition){this.conditionType=type;condition=condition.replace(/(\s*$)/g,"");this.condition=function(){return this[condition];};this.condition.__condition=condition;}}},{key:"toscript",value:function toscript(def,out){return this._toscript(def,out,++ShaderNode.__id);}},{key:"_toscript",value:function _toscript(def,out,id){if(this.childs.length<1&&!this.text)return out;var outIndex=out.length;if(this.condition){var ifdef=!!this.condition.call(def);this.conditionType===ILaya.ShaderCompile.IFDEF_ELSE&&(ifdef=!ifdef);if(!ifdef)return out;}this.text&&out.push(this.text);this.childs.length>0&&this.childs.forEach(function(o,index,arr){o._toscript(def,out,id);});if(this.includefiles.length>0&&this.useFuns.length>0){var funsCode;for(var i=0,n=this.includefiles.length;i<n;i++){if(this.includefiles[i].curUseID==id){continue;}funsCode=this.includefiles[i].file.getFunsScript(this.useFuns);if(funsCode.length>0){this.includefiles[i].curUseID=id;out[0]=funsCode+out[0];}}}return out;}}]);return ShaderNode;}();ShaderNode.__id=1;var ShaderCompile=function(){function ShaderCompile(vs,ps,nameMap){_classCallCheck(this,ShaderCompile);this.defs={};var _this=this;function _compile(script){script=script.replace(ShaderCompile._clearCR,"");var includefiles=[];var top=new ShaderNode(includefiles);_this._compileToTree(top,script.split('\n'),0,includefiles,_this.defs);return top;}var startTime=Date.now();this._VS=_compile(vs);this._PS=_compile(ps);this._nameMap=nameMap;if(Date.now()-startTime>2)console.log("ShaderCompile use time:"+(Date.now()-startTime)+"  size:"+vs.length+"/"+ps.length);}_createClass(ShaderCompile,[{key:"_compileToTree",value:function _compileToTree(parent,lines,start,includefiles,defs){var node,preNode;var text,name,fname;var ofs,words,noUseNode;var i,n,j;for(i=start;i<lines.length;i++){text=lines[i];if(text.length<1)continue;ofs=text.indexOf("//");if(ofs===0)continue;if(ofs>=0)text=text.substr(0,ofs);node=noUseNode||new ShaderNode(includefiles);noUseNode=null;node.text=text;node.noCompile=true;if((ofs=text.indexOf("#"))>=0){name="#";for(j=ofs+1,n=text.length;j<n;j++){var c=text.charAt(j);if(c===' '||c==='\t'||c==='?')break;name+=c;}node.name=name;switch(name){case"#ifdef":case"#ifndef":node.src=text;node.noCompile=text.match(/[!&|()=<>]/)!=null;if(!node.noCompile){words=text.replace(/^\s*/,'').split(/\s+/);node.setCondition(words[1],name==="#ifdef"?ShaderCompile.IFDEF_YES:ShaderCompile.IFDEF_ELSE);node.text="//"+node.text;}else{console.log("function():Boolean{return "+text.substr(ofs+node.name.length)+"}");}node.setParent(parent);parent=node;if(defs){words=text.substr(j).split(ShaderCompile._splitToWordExps3);for(j=0;j<words.length;j++){text=words[j];text.length&&(defs[text]=true);}}continue;case"#if":node.src=text;node.noCompile=true;node.setParent(parent);parent=node;if(defs){words=text.substr(j).split(ShaderCompile._splitToWordExps3);for(j=0;j<words.length;j++){text=words[j];text.length&&text!="defined"&&(defs[text]=true);}}continue;case"#else":node.src=text;parent=parent.parent;preNode=parent.childs[parent.childs.length-1];node.noCompile=preNode.noCompile;if(!node.noCompile){node.condition=preNode.condition;node.conditionType=preNode.conditionType==ShaderCompile.IFDEF_YES?ShaderCompile.IFDEF_ELSE:ShaderCompile.IFDEF_YES;node.text="//"+node.text+" "+preNode.text+" "+node.conditionType;}node.setParent(parent);parent=node;continue;case"#endif":parent=parent.parent;preNode=parent.childs[parent.childs.length-1];node.noCompile=preNode.noCompile;if(!node.noCompile){node.text="//"+node.text;}node.setParent(parent);continue;case"#include":words=ShaderCompile.splitToWords(text,null);var inlcudeFile=ShaderCompile.includes[words[1]];if(!inlcudeFile){throw"ShaderCompile error no this include file:"+words[1];}if((ofs=words[0].indexOf("?"))<0){node.setParent(parent);text=inlcudeFile.getWith(words[2]=='with'?words[3]:null);this._compileToTree(node,text.split('\n'),0,includefiles,defs);node.text="";continue;}node.setCondition(words[0].substr(ofs+1),ShaderCompile.IFDEF_YES);node.text=inlcudeFile.getWith(words[2]=='with'?words[3]:null);break;case"#import":words=ShaderCompile.splitToWords(text,null);fname=words[1];includefiles.push({node:node,file:ShaderCompile.includes[fname],ofs:node.text.length});continue;}}else{preNode=parent.childs[parent.childs.length-1];if(preNode&&!preNode.name){includefiles.length>0&&ShaderCompile.splitToWords(text,preNode);noUseNode=node;preNode.text+="\n"+text;continue;}includefiles.length>0&&ShaderCompile.splitToWords(text,node);}node.setParent(parent);}}},{key:"createShader",value:function createShader(define,shaderName,_createShader2,bindAttrib){var defMap={};var defineStr="";if(define){for(var i in define){defineStr+="#define "+i+"\n";defMap[i]=true;}}var vs=this._VS.toscript(defMap,[]);var ps=this._PS.toscript(defMap,[]);return(_createShader2||Shader.create)(defineStr+vs.join('\n'),defineStr+ps.join('\n'),shaderName,this._nameMap,bindAttrib);}}],[{key:"__init__",value:function __init__(){var gl=LayaGL.instance;ShaderCompile.shaderParamsMap={"float":gl.FLOAT,"int":gl.INT,"bool":gl.BOOL,"vec2":gl.FLOAT_VEC2,"vec3":gl.FLOAT_VEC3,"vec4":gl.FLOAT_VEC4,"ivec2":gl.INT_VEC2,"ivec3":gl.INT_VEC3,"ivec4":gl.INT_VEC4,"bvec2":gl.BOOL_VEC2,"bvec3":gl.BOOL_VEC3,"bvec4":gl.BOOL_VEC4,"mat2":gl.FLOAT_MAT2,"mat3":gl.FLOAT_MAT3,"mat4":gl.FLOAT_MAT4,"sampler2D":gl.SAMPLER_2D,"samplerCube":gl.SAMPLER_CUBE};}},{key:"_parseOne",value:function _parseOne(attributes,uniforms,words,i,word,b){var one={type:ShaderCompile.shaderParamsMap[words[i+1]],name:words[i+2],size:isNaN(parseInt(words[i+3]))?1:parseInt(words[i+3])};if(b){if(word=="attribute"){attributes.push(one);}else{uniforms.push(one);}}if(words[i+3]==':'){one.type=words[i+4];i+=2;}i+=2;return i;}},{key:"addInclude",value:function addInclude(fileName,txt){if(!txt||txt.length===0)throw new Error("add shader include file err:"+fileName);if(ShaderCompile.includes[fileName])throw new Error("add shader include file err, has add:"+fileName);ShaderCompile.includes[fileName]=new InlcudeFile(txt);}},{key:"preGetParams",value:function preGetParams(vs,ps){var text=[vs,ps];var result={};var attributes=[];var uniforms=[];var definesInfo={};var definesName=[];result.attributes=attributes;result.uniforms=uniforms;result.defines=definesInfo;var i,n;for(var s=0;s<2;s++){text[s]=text[s].replace(ShaderCompile._removeAnnotation,"");var words=text[s].match(ShaderCompile._reg);var tempelse;for(i=0,n=words.length;i<n;i++){var word=words[i];if(word!="attribute"&&word!="uniform"){if(word=="#define"){word=words[++i];definesName[word]=1;continue;}else if(word=="#ifdef"){tempelse=words[++i];var def=definesInfo[tempelse]=definesInfo[tempelse]||[];for(i++;i<n;i++){word=words[i];if(word!="attribute"&&word!="uniform"){if(word=="#else"){for(i++;i<n;i++){word=words[i];if(word!="attribute"&&word!="uniform"){if(word=="#endif"){break;}continue;}i=ShaderCompile._parseOne(attributes,uniforms,words,i,word,!definesName[tempelse]);}}continue;}i=ShaderCompile._parseOne(attributes,uniforms,words,i,word,definesName[tempelse]);}}continue;}i=ShaderCompile._parseOne(attributes,uniforms,words,i,word,true);}}return result;}},{key:"splitToWords",value:function splitToWords(str,block){var out=[];var c;var ofs=-1;var word;for(var i=0,n=str.length;i<n;i++){c=str.charAt(i);if(" \t=+-*/&%!<>()'\",;".indexOf(c)>=0){if(ofs>=0&&i-ofs>1){word=str.substr(ofs,i-ofs);out.push(word);}if(c=='"'||c=="'"){var ofs2=str.indexOf(c,i+1);if(ofs2<0){throw"Sharder err:"+str;}out.push(str.substr(i+1,ofs2-i-1));i=ofs2;ofs=-1;continue;}if(c=='('&&block&&out.length>0){word=out[out.length-1]+";";if("vec4;main;".indexOf(word)<0)block.useFuns+=word;}ofs=-1;continue;}if(ofs<0)ofs=i;}if(ofs<n&&n-ofs>1){word=str.substr(ofs,n-ofs);out.push(word);}return out;}}]);return ShaderCompile;}();ShaderCompile.IFDEF_NO=0;ShaderCompile.IFDEF_YES=1;ShaderCompile.IFDEF_ELSE=2;ShaderCompile.IFDEF_PARENT=3;ShaderCompile._removeAnnotation=new RegExp("(/\\*([^*]|[\\r\\\n]|(\\*+([^*/]|[\\r\\n])))*\\*+/)|(//.*)","g");ShaderCompile._reg=new RegExp("(\".*\")|('.*')|([#\\w\\*-\\.+/()=<>{}\\\\]+)|([,;:\\\\])","g");ShaderCompile._splitToWordExps=new RegExp("[(\".*\")]+|[('.*')]+|([ \\t=\\+\\-*/&%!<>!%\(\),;])","g");ShaderCompile.includes={};ShaderCompile._clearCR=new RegExp("\r","g");ShaderCompile._splitToWordExps3=new RegExp("[ \\t=\\+\\-*/&%!<>!%\(\),;\\|]","g");var WorkerLoader=function(_EventDispatcher11){_inherits(WorkerLoader,_EventDispatcher11);function WorkerLoader(){_classCallCheck(this,WorkerLoader);var _this50=_possibleConstructorReturn(this,(WorkerLoader.__proto__||Object.getPrototypeOf(WorkerLoader)).call(this));_this50.worker=new Worker(WorkerLoader.workerPath);var me=_this50;_this50.worker.onmessage=function(evt){me.workerMessage(evt.data);};return _this50;}_createClass(WorkerLoader,[{key:"workerMessage",value:function workerMessage(data){if(data){switch(data.type){case"Image":this.imageLoaded(data);break;case"Disable":WorkerLoader.enable=false;break;}}}},{key:"imageLoaded",value:function imageLoaded(data){if(!data.dataType||data.dataType!="imageBitmap"){this.event(data.url,null);return;}var imageData=data.imageBitmap;var tex=new Texture2D();tex.loadImageSource(imageData);console.log("load:",data.url);this.event(data.url,tex);}},{key:"loadImage",value:function loadImage(url){this.worker.postMessage(url);}},{key:"_loadImage",value:function _loadImage(url){var _this=this;if(!this._useWorkerLoader||!WorkerLoader._enable){WorkerLoader._preLoadFun.call(_this,url);return;}url=URL.formatURL(url);function clear(){WorkerLoader.I.off(url,_this,onload);}var onload=function onload(image){clear();if(image){_this["onLoaded"](image);}else{WorkerLoader._preLoadFun.call(_this,url);}};WorkerLoader.I.on(url,_this,onload);WorkerLoader.I.loadImage(url);}}],[{key:"__init__",value:function __init__(){if(WorkerLoader._preLoadFun!=null)return false;if(!Worker)return false;WorkerLoader._preLoadFun=Loader["prototype"]["_loadImage"];Loader["prototype"]["_loadImage"]=WorkerLoader["prototype"]["_loadImage"];if(!WorkerLoader.I)WorkerLoader.I=new WorkerLoader();return true;}},{key:"workerSupported",value:function workerSupported(){return Worker?true:false;}},{key:"enableWorkerLoader",value:function enableWorkerLoader(){if(!WorkerLoader._tryEnabled){WorkerLoader.enable=true;WorkerLoader._tryEnabled=true;}}},{key:"enable",set:function set(value){if(WorkerLoader._enable!=value){WorkerLoader._enable=value;if(value&&WorkerLoader._preLoadFun==null)WorkerLoader._enable=WorkerLoader.__init__();}},get:function get(){return WorkerLoader._enable;}}]);return WorkerLoader;}(EventDispatcher);WorkerLoader.workerPath="libs/workerloader.js";WorkerLoader._enable=false;WorkerLoader._tryEnabled=false;var Mouse=function(){function Mouse(){_classCallCheck(this,Mouse);}_createClass(Mouse,null,[{key:"__init__",value:function __init__(){}},{key:"hide",value:function hide(){if(Mouse.cursor!="none"){Mouse._preCursor=Mouse.cursor;Mouse.cursor="none";}}},{key:"show",value:function show(){if(Mouse.cursor=="none"){if(Mouse._preCursor){Mouse.cursor=Mouse._preCursor;}else{Mouse.cursor="auto";}}}},{key:"cursor",set:function set(cursorStr){Mouse._style.cursor=cursorStr;},get:function get(){return Mouse._style.cursor;}}]);return Mouse;}();var MeshParticle2D=function(_Mesh2D4){_inherits(MeshParticle2D,_Mesh2D4);function MeshParticle2D(maxNum){_classCallCheck(this,MeshParticle2D);var _this51=_possibleConstructorReturn(this,(MeshParticle2D.__proto__||Object.getPrototypeOf(MeshParticle2D)).call(this,MeshParticle2D.const_stride,maxNum*4*MeshParticle2D.const_stride,4));_this51.canReuse=true;_this51.setAttributes(MeshParticle2D._fixattriInfo);_this51.createQuadIB(maxNum);_this51._quadNum=maxNum;return _this51;}_createClass(MeshParticle2D,[{key:"setMaxParticleNum",value:function setMaxParticleNum(maxNum){this._vb._resizeBuffer(maxNum*4*MeshParticle2D.const_stride,false);this.createQuadIB(maxNum);}},{key:"releaseMesh",value:function releaseMesh(){this._vb.setByteLength(0);this.vertNum=0;this.indexNum=0;MeshParticle2D._POOL.push(this);}},{key:"destroy",value:function destroy(){this._ib.destroy();this._vb.destroy();this._vb.deleteBuffer();}}],[{key:"__init__",value:function __init__(){var gl=LayaGL.instance;MeshParticle2D._fixattriInfo=[gl.FLOAT,4,0,gl.FLOAT,3,16,gl.FLOAT,3,28,gl.FLOAT,4,40,gl.FLOAT,4,56,gl.FLOAT,3,72,gl.FLOAT,2,84,gl.FLOAT,4,92,gl.FLOAT,1,108,gl.FLOAT,1,112];}},{key:"getAMesh",value:function getAMesh(maxNum){if(MeshParticle2D._POOL.length){var ret=MeshParticle2D._POOL.pop();ret.setMaxParticleNum(maxNum);return ret;}return new MeshParticle2D(maxNum);}}]);return MeshParticle2D;}(Mesh2D);MeshParticle2D.const_stride=116;MeshParticle2D._POOL=[];var HTMLImage=function(_Bitmap3){_inherits(HTMLImage,_Bitmap3);function HTMLImage(){_classCallCheck(this,HTMLImage);return _possibleConstructorReturn(this,(HTMLImage.__proto__||Object.getPrototypeOf(HTMLImage)).apply(this,arguments));}return HTMLImage;}(Bitmap);HTMLImage.create=function(width,height,format){var tex=new Texture2D(width,height,format,false,false);tex.wrapModeU=BaseTexture.WARPMODE_CLAMP;tex.wrapModeV=BaseTexture.WARPMODE_CLAMP;return tex;};var Laya=function(){function Laya(){_classCallCheck(this,Laya);}_createClass(Laya,null,[{key:"__init",value:function __init(_classs){_classs.forEach(function(o){o.__init$&&o.__init$();});}},{key:"init",value:function init(width,height){if(Laya._isinit)return;Laya._isinit=true;ArrayBuffer.prototype.slice||(ArrayBuffer.prototype.slice=Laya._arrayBufferSlice);Browser.__init__();var mainCanv=Browser.mainCanvas=new HTMLCanvas(true);var style=mainCanv.source.style;style.position='absolute';style.top=style.left="0px";style.background="#000000";if(!Browser.onKGMiniGame&&!Browser.onAlipayMiniGame){Browser.container.appendChild(mainCanv.source);}Browser.canvas=new HTMLCanvas(true);Browser.context=Browser.canvas.getContext('2d');Browser.supportWebAudio=SoundManager.__init__();Browser.supportLocalStorage=LocalStorage.__init__();Laya.systemTimer=new Timer(false);exports.systemTimer=Timer.gSysTimer=Laya.systemTimer;Laya.startTimer=new Timer(false);Laya.physicsTimer=new Timer(false);Laya.updateTimer=new Timer(false);Laya.lateTimer=new Timer(false);Laya.timer=new Timer(false);exports.startTimer=ILaya.startTimer=Laya.startTimer;exports.lateTimer=ILaya.lateTimer=Laya.lateTimer;exports.updateTimer=ILaya.updateTimer=Laya.updateTimer;ILaya.systemTimer=Laya.systemTimer;exports.timer=ILaya.timer=Laya.timer;exports.physicsTimer=ILaya.physicsTimer=Laya.physicsTimer;Laya.loader=new LoaderManager();ILaya.Laya=Laya;exports.loader=ILaya.loader=Laya.loader;WeakObject.__init__();SceneUtils.__init();Mouse.__init__();WebGL.inner_enable();for(var _len=arguments.length,plugins=Array(_len>2?_len-2:0),_key=2;_key<_len;_key++){plugins[_key-2]=arguments[_key];}if(plugins){for(var i=0,n=plugins.length;i<n;i++){if(plugins[i]&&plugins[i].enable){plugins[i].enable();}}}if(ILaya.Render.isConchApp){Laya.enableNative();}Laya.enableWebGLPlus();CacheManger.beginCheck();exports.stage=Laya.stage=new Stage();ILaya.stage=Laya.stage;Utils.gStage=Laya.stage;URL.rootPath=URL._basePath=Laya._getUrlPath();MeshQuadTexture.__int__();MeshVG.__init__();MeshTexture.__init__();Laya.render=new Render(0,0,Browser.mainCanvas);exports.render=Laya.render;Laya.stage.size(width,height);window.stage=Laya.stage;WebGLContext.__init__();MeshParticle2D.__init__();ShaderCompile.__init__();RenderSprite.__init__();KeyBoardManager.__init__();MouseManager.instance.__init__(Laya.stage,Render.canvas);Input.__init__();SoundManager.autoStopMusic=true;Stat._StatRender=new StatUI();Value2D._initone(ShaderDefines2D.TEXTURE2D,TextureSV);Value2D._initone(ShaderDefines2D.TEXTURE2D|ShaderDefines2D.FILTERGLOW,TextureSV);Value2D._initone(ShaderDefines2D.PRIMITIVE,PrimitiveSV);Value2D._initone(ShaderDefines2D.SKINMESH,SkinSV);return Render.canvas;}},{key:"_getUrlPath",value:function _getUrlPath(){var location=Browser.window.location;var pathName=location.pathname;pathName=pathName.charAt(2)==':'?pathName.substring(1):pathName;return URL.getPath(location.protocol=="file:"?pathName:location.protocol+"//"+location.host+location.pathname);}},{key:"_arrayBufferSlice",value:function _arrayBufferSlice(start,end){var arr=this;var arrU8List=new Uint8Array(arr,start,end-start);var newU8List=new Uint8Array(arrU8List.length);newU8List.set(arrU8List);return newU8List.buffer;}},{key:"_runScript",value:function _runScript(script){return Browser.window[Laya._evcode](script);}},{key:"enableDebugPanel",value:function enableDebugPanel(){var debugJsPath=arguments.length>0&&arguments[0]!==undefined?arguments[0]:"libs/laya.debugtool.js";if(!window['Laya']["DebugPanel"]){var script=Browser.createElement("script");script.onload=function(){window['Laya']["DebugPanel"].enable();};script.src=debugJsPath;Browser.document.body.appendChild(script);}else{window['Laya']["DebugPanel"].enable();}}},{key:"enableWebGLPlus",value:function enableWebGLPlus(){WebGLContext.__init_native();}},{key:"enableNative",value:function enableNative(){if(Laya.isNativeRender_enable)return;Laya.isNativeRender_enable=true;if(Render.supportWebGLPlusRendering){Shader.prototype.uploadTexture2D=function(value){var gl=LayaGL.instance;gl.bindTexture(gl.TEXTURE_2D,value);};}RenderState2D.width=Browser.window.innerWidth;RenderState2D.height=Browser.window.innerHeight;Browser.measureText=function(txt,font){window["conchTextCanvas"].font=font;return window["conchTextCanvas"].measureText(txt);};Stage.clear=function(color){Context.set2DRenderConfig();var c=ColorUtils.create(color).arrColor;var gl=LayaGL.instance;if(c)gl.clearColor(c[0],c[1],c[2],c[3]);gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT|gl.STENCIL_BUFFER_BIT);RenderState2D.clear();};Sprite.drawToCanvas=Sprite.drawToTexture=function(sprite,_renderType,canvasWidth,canvasHeight,offsetX,offsetY){offsetX-=sprite.x;offsetY-=sprite.y;offsetX|=0;offsetY|=0;canvasWidth|=0;canvasHeight|=0;var canv=new HTMLCanvas(false);var ctx=canv.getContext('2d');canv.size(canvasWidth,canvasHeight);ctx.asBitmap=true;ctx._targets.start();RenderSprite.renders[_renderType]._fun(sprite,ctx,offsetX,offsetY);ctx.flush();ctx._targets.end();ctx._targets.restore();return canv;};Object["defineProperty"](RenderTexture2D.prototype,"uv",{"get":function get(){return this._uv;},"set":function set(v){this._uv=v;}});HTMLCanvas.prototype.getTexture=function(){if(!this._texture){this._texture=this.context._targets;this._texture.uv=RenderTexture2D.flipyuv;this._texture.bitmap=this._texture;}return this._texture;};}},{key:"alertGlobalError",set:function set(value){var erralert=0;if(value){Browser.window.onerror=function(msg,url,line,column,detail){if(erralert++<5&&detail)this.alert("\n"+msg+"\n"+detail.stack);};}else{Browser.window.onerror=null;}}}]);return Laya;}();Laya.stage=null;Laya.systemTimer=null;Laya.startTimer=null;Laya.physicsTimer=null;Laya.updateTimer=null;Laya.lateTimer=null;Laya.timer=null;Laya.loader=null;Laya.version="2.4.0";Laya._isinit=false;Laya.isWXOpenDataContext=false;Laya.isWXPosMsg=false;Laya.__classmap=null;Laya.Config=Config;Laya.TextRender=TextRender;Laya.EventDispatcher=EventDispatcher;Laya.SoundChannel=SoundChannel;Laya.Stage=Stage;Laya.Render=Render;Laya.Browser=Browser;Laya.Sprite=Sprite;Laya.Node=Node;Laya.Context=Context;Laya.WebGL=WebGL;Laya.Handler=Handler;Laya.RunDriver=RunDriver;Laya.Utils=Utils;Laya.Input=Input;Laya.Loader=Loader;Laya.LocalStorage=LocalStorage;Laya.SoundManager=SoundManager;Laya.URL=URL;Laya.Event=Event;Laya.Matrix=Matrix;Laya.HTMLImage=HTMLImage;Laya.Laya=Laya;Laya._evcode="eva"+"l";Laya.isNativeRender_enable=false;Laya.__classmap=ILaya.__classMap;ILaya.Timer=Timer;ILaya.Dragging=Dragging;ILaya.GraphicsBounds=GraphicsBounds;ILaya.Sprite=Sprite;ILaya.TextRender=TextRender;ILaya.Loader=Loader;ILaya.TTFLoader=TTFLoader;ILaya.WebAudioSound=WebAudioSound;ILaya.SoundManager=SoundManager;ILaya.ShaderCompile=ShaderCompile;ILaya.ClassUtils=ClassUtils;ILaya.SceneUtils=SceneUtils;ILaya.Context=Context;ILaya.Render=Render;ILaya.MouseManager=MouseManager;ILaya.Text=Text;ILaya.Browser=Browser;ILaya.WebGL=WebGL;ILaya.AudioSound=AudioSound;ILaya.Pool=Pool;ILaya.Utils=Utils;ILaya.Graphics=Graphics;ILaya.Submit=Submit;ILaya.Stage=Stage;ILaya.Resource=Resource;ILaya.WorkerLoader=WorkerLoader;var libs=window._layalibs;if(libs){libs.sort(function(a,b){return a.i-b.i;});for(var j=0;j<libs.length;j++){libs[j].f(window,window.document,Laya);}}var win=window;if(win.Laya){win.Laya.Laya=Laya;Object.assign(win.Laya,Laya);}else win.Laya=Laya;var __init=Laya.__init;var init=Laya.init;var version=Laya.version;var isWXOpenDataContext;var isWXPosMsg;var alertGlobalError=Laya.alertGlobalError;var enableDebugPanel=Laya.enableDebugPanel;function _static(_class,def){for(var i=0,sz=def.length;i<sz;i+=2){if(def[i]=='length')_class.length=def[i+1].call(_class);else{var tmp=function tmp(){var name=def[i];var getfn=def[i+1];Object.defineProperty(_class,name,{get:function get(){delete this[name];return this[name]=getfn.call(this);},set:function set(v){delete this[name];this[name]=v;},enumerable:true,configurable:true});};tmp();}}}var CommonScript=function(_Component){_inherits(CommonScript,_Component);_createClass(CommonScript,[{key:"isSingleton",get:function get(){return false;}}]);function CommonScript(){_classCallCheck(this,CommonScript);return _possibleConstructorReturn(this,(CommonScript.__proto__||Object.getPrototypeOf(CommonScript)).call(this));}_createClass(CommonScript,[{key:"onAwake",value:function onAwake(){}},{key:"onEnable",value:function onEnable(){}},{key:"onStart",value:function onStart(){}},{key:"onUpdate",value:function onUpdate(){}},{key:"onLateUpdate",value:function onLateUpdate(){}},{key:"onDisable",value:function onDisable(){}},{key:"onDestroy",value:function onDestroy(){}}]);return CommonScript;}(Component);var Script=function(_Component2){_inherits(Script,_Component2);function Script(){_classCallCheck(this,Script);return _possibleConstructorReturn(this,(Script.__proto__||Object.getPrototypeOf(Script)).apply(this,arguments));}_createClass(Script,[{key:"_onAwake",value:function _onAwake(){this.onAwake();if(this.onStart!==Script.prototype.onStart){ILaya.startTimer.callLater(this,this.onStart);}}},{key:"_onEnable",value:function _onEnable(){var proto=Script.prototype;if(this.onTriggerEnter!==proto.onTriggerEnter){this.owner.on(Event.TRIGGER_ENTER,this,this.onTriggerEnter);}if(this.onTriggerStay!==proto.onTriggerStay){this.owner.on(Event.TRIGGER_STAY,this,this.onTriggerStay);}if(this.onTriggerExit!==proto.onTriggerExit){this.owner.on(Event.TRIGGER_EXIT,this,this.onTriggerExit);}if(this.onMouseDown!==proto.onMouseDown){this.owner.on(Event.MOUSE_DOWN,this,this.onMouseDown);}if(this.onMouseUp!==proto.onMouseUp){this.owner.on(Event.MOUSE_UP,this,this.onMouseUp);}if(this.onClick!==proto.onClick){this.owner.on(Event.CLICK,this,this.onClick);}if(this.onStageMouseDown!==proto.onStageMouseDown){ILaya.stage.on(Event.MOUSE_DOWN,this,this.onStageMouseDown);}if(this.onStageMouseUp!==proto.onStageMouseUp){ILaya.stage.on(Event.MOUSE_UP,this,this.onStageMouseUp);}if(this.onStageClick!==proto.onStageClick){ILaya.stage.on(Event.CLICK,this,this.onStageClick);}if(this.onStageMouseMove!==proto.onStageMouseMove){ILaya.stage.on(Event.MOUSE_MOVE,this,this.onStageMouseMove);}if(this.onDoubleClick!==proto.onDoubleClick){this.owner.on(Event.DOUBLE_CLICK,this,this.onDoubleClick);}if(this.onRightClick!==proto.onRightClick){this.owner.on(Event.RIGHT_CLICK,this,this.onRightClick);}if(this.onMouseMove!==proto.onMouseMove){this.owner.on(Event.MOUSE_MOVE,this,this.onMouseMove);}if(this.onMouseOver!==proto.onMouseOver){this.owner.on(Event.MOUSE_OVER,this,this.onMouseOver);}if(this.onMouseOut!==proto.onMouseOut){this.owner.on(Event.MOUSE_OUT,this,this.onMouseOut);}if(this.onKeyDown!==proto.onKeyDown){ILaya.stage.on(Event.KEY_DOWN,this,this.onKeyDown);}if(this.onKeyPress!==proto.onKeyPress){ILaya.stage.on(Event.KEY_PRESS,this,this.onKeyPress);}if(this.onKeyUp!==proto.onKeyUp){ILaya.stage.on(Event.KEY_UP,this,this.onKeyUp);}if(this.onUpdate!==proto.onUpdate){ILaya.updateTimer.frameLoop(1,this,this.onUpdate);}if(this.onLateUpdate!==proto.onLateUpdate){ILaya.lateTimer.frameLoop(1,this,this.onLateUpdate);}if(this.onPreRender!==proto.onPreRender){ILaya.lateTimer.frameLoop(1,this,this.onPreRender);}}},{key:"_onDisable",value:function _onDisable(){this.owner.offAllCaller(this);ILaya.stage.offAllCaller(this);ILaya.startTimer.clearAll(this);ILaya.updateTimer.clearAll(this);ILaya.lateTimer.clearAll(this);}},{key:"_isScript",value:function _isScript(){return true;}},{key:"_onDestroy",value:function _onDestroy(){this.onDestroy();}},{key:"onAwake",value:function onAwake(){}},{key:"onEnable",value:function onEnable(){}},{key:"onStart",value:function onStart(){}},{key:"onTriggerEnter",value:function onTriggerEnter(other,self,contact){}},{key:"onTriggerStay",value:function onTriggerStay(other,self,contact){}},{key:"onTriggerExit",value:function onTriggerExit(other,self,contact){}},{key:"onMouseDown",value:function onMouseDown(e){}},{key:"onMouseUp",value:function onMouseUp(e){}},{key:"onClick",value:function onClick(e){}},{key:"onStageMouseDown",value:function onStageMouseDown(e){}},{key:"onStageMouseUp",value:function onStageMouseUp(e){}},{key:"onStageClick",value:function onStageClick(e){}},{key:"onStageMouseMove",value:function onStageMouseMove(e){}},{key:"onDoubleClick",value:function onDoubleClick(e){}},{key:"onRightClick",value:function onRightClick(e){}},{key:"onMouseMove",value:function onMouseMove(e){}},{key:"onMouseOver",value:function onMouseOver(e){}},{key:"onMouseOut",value:function onMouseOut(e){}},{key:"onKeyDown",value:function onKeyDown(e){}},{key:"onKeyPress",value:function onKeyPress(e){}},{key:"onKeyUp",value:function onKeyUp(e){}},{key:"onUpdate",value:function onUpdate(){}},{key:"onLateUpdate",value:function onLateUpdate(){}},{key:"onPreRender",value:function onPreRender(){}},{key:"onPostRender",value:function onPostRender(){}},{key:"onDisable",value:function onDisable(){}},{key:"onDestroy",value:function onDestroy(){}},{key:"isSingleton",get:function get(){return false;}}]);return Script;}(Component);var GraphicAnimation=function(_FrameAnimation){_inherits(GraphicAnimation,_FrameAnimation);function GraphicAnimation(){_classCallCheck(this,GraphicAnimation);var _this55=_possibleConstructorReturn(this,(GraphicAnimation.__proto__||Object.getPrototypeOf(GraphicAnimation)).apply(this,arguments));_this55._nodeIDAniDic={};return _this55;}_createClass(GraphicAnimation,[{key:"_parseNodeList",value:function _parseNodeList(uiView){if(!this._nodeList)this._nodeList=[];this._nodeDefaultProps[uiView.compId]=uiView.props;if(uiView.compId)this._nodeList.push(uiView.compId);var childs=uiView.child;if(childs){var i,len=childs.length;for(i=0;i<len;i++){this._parseNodeList(childs[i]);}}}},{key:"_calGraphicData",value:function _calGraphicData(aniData){this._setUp(null,aniData);this._createGraphicData();if(this._nodeIDAniDic){var key;for(key in this._nodeIDAniDic){this._nodeIDAniDic[key]=null;}}}},{key:"_createGraphicData",value:function _createGraphicData(){var gList=[];var i,len=this.count;var animationDataNew=this._usedFrames;if(!animationDataNew)animationDataNew=[];var preGraphic;for(i=0;i<len;i++){if(animationDataNew[i]||!preGraphic){preGraphic=this._createFrameGraphic(i);}gList.push(preGraphic);}this._gList=gList;}},{key:"_createFrameGraphic",value:function _createFrameGraphic(frame){var g=new Graphics();if(!GraphicAnimation._rootMatrix)GraphicAnimation._rootMatrix=new Matrix();this._updateNodeGraphic(this._rootNode,frame,GraphicAnimation._rootMatrix,g);return g;}},{key:"_updateNodeGraphic",value:function _updateNodeGraphic(node,frame,parentTransfrom,g){var alpha=arguments.length>4&&arguments[4]!==undefined?arguments[4]:1;var tNodeG;tNodeG=this._nodeGDic[node.compId]=this._getNodeGraphicData(node.compId,frame,this._nodeGDic[node.compId]);if(!tNodeG.resultTransform)tNodeG.resultTransform=new Matrix();var tResultTransform;tResultTransform=tNodeG.resultTransform;Matrix.mul(tNodeG.transform,parentTransfrom,tResultTransform);var tTex;var tGraphicAlpha=tNodeG.alpha*alpha;if(tGraphicAlpha<0.01)return;if(tNodeG.skin){tTex=this._getTextureByUrl(tNodeG.skin);if(tTex){if(tResultTransform._checkTransform()){g.drawTexture(tTex,0,0,tNodeG.width,tNodeG.height,tResultTransform,tGraphicAlpha);tNodeG.resultTransform=null;}else{g.drawTexture(tTex,tResultTransform.tx,tResultTransform.ty,tNodeG.width,tNodeG.height,null,tGraphicAlpha);}}}var childs=node.child;if(!childs)return;var i,len;len=childs.length;for(i=0;i<len;i++){this._updateNodeGraphic(childs[i],frame,tResultTransform,g,tGraphicAlpha);}}},{key:"_updateNoChilds",value:function _updateNoChilds(tNodeG,g){if(!tNodeG.skin)return;var tTex=this._getTextureByUrl(tNodeG.skin);if(!tTex)return;var tTransform=tNodeG.transform;tTransform._checkTransform();var onlyTranslate;onlyTranslate=!tTransform._bTransform;if(!onlyTranslate){g.drawTexture(tTex,0,0,tNodeG.width,tNodeG.height,tTransform.clone(),tNodeG.alpha);}else{g.drawTexture(tTex,tTransform.tx,tTransform.ty,tNodeG.width,tNodeG.height,null,tNodeG.alpha);}}},{key:"_updateNodeGraphic2",value:function _updateNodeGraphic2(node,frame,g){var tNodeG;tNodeG=this._nodeGDic[node.compId]=this._getNodeGraphicData(node.compId,frame,this._nodeGDic[node.compId]);if(!node.child){this._updateNoChilds(tNodeG,g);return;}var tTransform=tNodeG.transform;tTransform._checkTransform();var onlyTranslate;onlyTranslate=!tTransform._bTransform;var hasTrans;hasTrans=onlyTranslate&&(tTransform.tx!=0||tTransform.ty!=0);var ifSave;ifSave=tTransform._bTransform||tNodeG.alpha!=1;if(ifSave)g.save();if(tNodeG.alpha!=1)g.alpha(tNodeG.alpha);if(!onlyTranslate)g.transform(tTransform.clone());else if(hasTrans)g.translate(tTransform.tx,tTransform.ty);var childs=node.child;var tTex;if(tNodeG.skin){tTex=this._getTextureByUrl(tNodeG.skin);if(tTex){g.drawImage(tTex,0,0,tNodeG.width,tNodeG.height);}}if(childs){var i,len;len=childs.length;for(i=0;i<len;i++){this._updateNodeGraphic2(childs[i],frame,g);}}if(ifSave){g.restore();}else{if(!onlyTranslate){g.transform(tTransform.clone().invert());}else if(hasTrans){g.translate(-tTransform.tx,-tTransform.ty);}}}},{key:"_calculateKeyFrames",value:function _calculateKeyFrames(node){_get(GraphicAnimation.prototype.__proto__||Object.getPrototypeOf(GraphicAnimation.prototype),"_calculateKeyFrames",this).call(this,node);this._nodeIDAniDic[node.target]=node;}},{key:"getNodeDataByID",value:function getNodeDataByID(nodeID){return this._nodeIDAniDic[nodeID];}},{key:"_getParams",value:function _getParams(obj,params,frame,obj2){var rst=GraphicAnimation._temParam;rst.length=params.length;var i,len=params.length;for(i=0;i<len;i++){rst[i]=this._getObjVar(obj,params[i][0],frame,params[i][1],obj2);}return rst;}},{key:"_getObjVar",value:function _getObjVar(obj,key,frame,noValue,obj2){if(key in obj){var vArr=obj[key];if(frame>=vArr.length)frame=vArr.length-1;return obj[key][frame];}if(key in obj2){return obj2[key];}return noValue;}},{key:"_getNodeGraphicData",value:function _getNodeGraphicData(nodeID,frame,rst){if(!rst)rst=new GraphicNode();if(!rst.transform){rst.transform=new Matrix();}else{rst.transform.identity();}var node=this.getNodeDataByID(nodeID);if(!node)return rst;var frameData=node.frames;var params=this._getParams(frameData,GraphicAnimation._drawTextureCmd,frame,this._nodeDefaultProps[nodeID]);var url=params[0];var width,height;var px=params[5],py=params[6];var aX=params[13],aY=params[14];var sx=params[7],sy=params[8];var rotate=params[9];var skewX=params[11],skewY=params[12];width=params[3];height=params[4];if(width==0||height==0)url=null;if(width==-1)width=0;if(height==-1)height=0;var tex;rst.skin=url;rst.width=width;rst.height=height;if(url){tex=this._getTextureByUrl(url);if(tex){if(!width)width=tex.sourceWidth;if(!height)height=tex.sourceHeight;}else{console.warn("lost skin:",url,",you may load pics first");}}rst.alpha=params[10];var m=rst.transform;if(aX!=0){px=aX*width;}if(aY!=0){py=aY*height;}if(px!=0||py!=0){m.translate(-px,-py);}var tm=null;if(rotate||sx!==1||sy!==1||skewX||skewY){tm=GraphicAnimation._tempMt;tm.identity();tm._bTransform=true;var skx=(rotate-skewX)*0.0174532922222222;var sky=(rotate+skewY)*0.0174532922222222;var cx=Math.cos(sky);var ssx=Math.sin(sky);var cy=Math.sin(skx);var ssy=Math.cos(skx);tm.a=sx*cx;tm.b=sx*ssx;tm.c=-sy*cy;tm.d=sy*ssy;tm.tx=tm.ty=0;}if(tm){m=Matrix.mul(m,tm,m);}m.translate(params[1],params[2]);return rst;}},{key:"_getTextureByUrl",value:function _getTextureByUrl(url){return Loader.getRes(url);}},{key:"setAniData",value:function setAniData(uiView){var aniName=arguments.length>1&&arguments[1]!==undefined?arguments[1]:null;if(uiView.animations){this._nodeDefaultProps={};this._nodeGDic={};if(this._nodeList)this._nodeList.length=0;this._rootNode=uiView;this._parseNodeList(uiView);var aniDic={};var anilist=[];var animations=uiView.animations;var i,len=animations.length;var tAniO;for(i=0;i<len;i++){tAniO=animations[i];this._labels=null;if(aniName&&aniName!=tAniO.name){continue;}if(!tAniO)continue;try{this._calGraphicData(tAniO);}catch(e){console.warn("parse animation fail:"+tAniO.name+",empty animation created");this._gList=[];}var frameO={};frameO.interval=1000/tAniO["frameRate"];frameO.frames=this._gList;frameO.labels=this._labels;frameO.name=tAniO.name;anilist.push(frameO);aniDic[tAniO.name]=frameO;}this.animationList=anilist;this.animationDic=aniDic;}GraphicAnimation._temParam.length=0;}},{key:"parseByData",value:function parseByData(aniData){var rootNode,aniO;rootNode=aniData.nodeRoot;aniO=aniData.aniO;delete aniData.nodeRoot;delete aniData.aniO;this._nodeDefaultProps={};this._nodeGDic={};if(this._nodeList)this._nodeList.length=0;this._rootNode=rootNode;this._parseNodeList(rootNode);this._labels=null;try{this._calGraphicData(aniO);}catch(e){console.warn("parse animation fail:"+aniO.name+",empty animation created");this._gList=[];}var frameO=aniData;frameO.interval=1000/aniO["frameRate"];frameO.frames=this._gList;frameO.labels=this._labels;frameO.name=aniO.name;return frameO;}},{key:"setUpAniData",value:function setUpAniData(uiView){if(uiView.animations){var aniDic={};var anilist=[];var animations=uiView.animations;var i,len=animations.length;var tAniO;for(i=0;i<len;i++){tAniO=animations[i];if(!tAniO)continue;var frameO={};frameO.name=tAniO.name;frameO.aniO=tAniO;frameO.nodeRoot=uiView;anilist.push(frameO);aniDic[tAniO.name]=frameO;}this.animationList=anilist;this.animationDic=aniDic;}}},{key:"_clear",value:function _clear(){this.animationList=null;this.animationDic=null;this._gList=null;this._nodeGDic=null;}}],[{key:"parseAnimationByData",value:function parseAnimationByData(animationObject){if(!GraphicAnimation._I)GraphicAnimation._I=new GraphicAnimation();var rst;rst=GraphicAnimation._I.parseByData(animationObject);GraphicAnimation._I._clear();return rst;}},{key:"parseAnimationData",value:function parseAnimationData(aniData){if(!GraphicAnimation._I)GraphicAnimation._I=new GraphicAnimation();GraphicAnimation._I.setUpAniData(aniData);var rst;rst={};rst.animationList=GraphicAnimation._I.animationList;rst.animationDic=GraphicAnimation._I.animationDic;GraphicAnimation._I._clear();return rst;}}]);return GraphicAnimation;}(FrameAnimation);GraphicAnimation._drawTextureCmd=[["skin",null],["x",0],["y",0],["width",-1],["height",-1],["pivotX",0],["pivotY",0],["scaleX",1],["scaleY",1],["rotation",0],["alpha",1],["skewX",0],["skewY",0],["anchorX",0],["anchorY",0]];GraphicAnimation._temParam=[];GraphicAnimation._tempMt=new Matrix();var GraphicNode=function GraphicNode(){_classCallCheck(this,GraphicNode);this.alpha=1;};var Animation=function(_AnimationBase2){_inherits(Animation,_AnimationBase2);function Animation(){_classCallCheck(this,Animation);var _this56=_possibleConstructorReturn(this,(Animation.__proto__||Object.getPrototypeOf(Animation)).call(this));_this56._setControlNode(_this56);return _this56;}_createClass(Animation,[{key:"destroy",value:function destroy(){var destroyChild=arguments.length>0&&arguments[0]!==undefined?arguments[0]:true;this.stop();_get(Animation.prototype.__proto__||Object.getPrototypeOf(Animation.prototype),"destroy",this).call(this,destroyChild);this._frames=null;this._labels=null;}},{key:"play",value:function play(){var start=arguments.length>0&&arguments[0]!==undefined?arguments[0]:0;var loop=arguments.length>1&&arguments[1]!==undefined?arguments[1]:true;var name=arguments.length>2&&arguments[2]!==undefined?arguments[2]:"";if(name)this._setFramesFromCache(name,true);_get(Animation.prototype.__proto__||Object.getPrototypeOf(Animation.prototype),"play",this).call(this,start,loop,name);}},{key:"_setFramesFromCache",value:function _setFramesFromCache(name){var showWarn=arguments.length>1&&arguments[1]!==undefined?arguments[1]:false;if(this._url)name=this._url+"#"+name;if(name&&Animation.framesMap[name]){var tAniO=Animation.framesMap[name];if(tAniO instanceof Array){this._frames=Animation.framesMap[name];this._count=this._frames.length;}else{if(tAniO.nodeRoot){Animation.framesMap[name]=GraphicAnimation.parseAnimationByData(tAniO);tAniO=Animation.framesMap[name];}this._frames=tAniO.frames;this._count=this._frames.length;if(!this._frameRateChanged)this._interval=tAniO.interval;this._labels=this._copyLabels(tAniO.labels);}return true;}else{if(showWarn)console.log("ani not found:",name);}return false;}},{key:"_copyLabels",value:function _copyLabels(labels){if(!labels)return null;var rst;rst={};var key;for(key in labels){rst[key]=Utils.copyArray([],labels[key]);}return rst;}},{key:"_frameLoop",value:function _frameLoop(){if(this._visible&&this._style.alpha>0.01&&this._frames){_get(Animation.prototype.__proto__||Object.getPrototypeOf(Animation.prototype),"_frameLoop",this).call(this);}}},{key:"_displayToIndex",value:function _displayToIndex(value){if(this._frames)this.graphics=this._frames[value];}},{key:"clear",value:function clear(){_get(Animation.prototype.__proto__||Object.getPrototypeOf(Animation.prototype),"clear",this).call(this);this.stop();this.graphics=null;this._frames=null;this._labels=null;return this;}},{key:"loadImages",value:function loadImages(urls){var cacheName=arguments.length>1&&arguments[1]!==undefined?arguments[1]:"";this._url="";if(!this._setFramesFromCache(cacheName)){this.frames=Animation.framesMap[cacheName]?Animation.framesMap[cacheName]:Animation.createFrames(urls,cacheName);}return this;}},{key:"loadAtlas",value:function loadAtlas(url){var loaded=arguments.length>1&&arguments[1]!==undefined?arguments[1]:null;var cacheName=arguments.length>2&&arguments[2]!==undefined?arguments[2]:"";this._url="";var _this=this;if(!_this._setFramesFromCache(cacheName)){var onLoaded=function onLoaded(loadUrl){if(url===loadUrl){_this.frames=Animation.framesMap[cacheName]?Animation.framesMap[cacheName]:Animation.createFrames(url,cacheName);if(loaded)loaded.run();}};if(Loader.getAtlas(url))onLoaded(url);else ILaya.loader.load(url,Handler.create(null,onLoaded,[url]),null,Loader.ATLAS);}return this;}},{key:"loadAnimation",value:function loadAnimation(url){var loaded=arguments.length>1&&arguments[1]!==undefined?arguments[1]:null;var atlas=arguments.length>2&&arguments[2]!==undefined?arguments[2]:null;this._url=url;var _this=this;if(!this._actionName)this._actionName="";if(!_this._setFramesFromCache(this._actionName)){if(!atlas||Loader.getAtlas(atlas)){this._loadAnimationData(url,loaded,atlas);}else{ILaya.loader.load(atlas,Handler.create(this,this._loadAnimationData,[url,loaded,atlas]),null,Loader.ATLAS);}}else{_this._setFramesFromCache(this._actionName,true);this.index=0;if(loaded)loaded.run();}return this;}},{key:"_loadAnimationData",value:function _loadAnimationData(url){var loaded=arguments.length>1&&arguments[1]!==undefined?arguments[1]:null;var atlas=arguments.length>2&&arguments[2]!==undefined?arguments[2]:null;if(atlas&&!Loader.getAtlas(atlas)){console.warn("atlas load fail:"+atlas);return;}var _this=this;function onLoaded(loadUrl){if(!Loader.getRes(loadUrl)){if(Animation.framesMap[url+"#"]){_this._setFramesFromCache(_this._actionName,true);_this.index=0;_this._resumePlay();if(loaded)loaded.run();}return;}if(url===loadUrl){var tAniO;if(!Animation.framesMap[url+"#"]){var aniData=GraphicAnimation.parseAnimationData(Loader.getRes(url));if(!aniData)return;var aniList=aniData.animationList;var i,len=aniList.length;var defaultO;for(i=0;i<len;i++){tAniO=aniList[i];Animation.framesMap[url+"#"+tAniO.name]=tAniO;if(!defaultO)defaultO=tAniO;}if(defaultO){Animation.framesMap[url+"#"]=defaultO;_this._setFramesFromCache(_this._actionName,true);_this.index=0;}_this._resumePlay();}else{_this._setFramesFromCache(_this._actionName,true);_this.index=0;_this._resumePlay();}if(loaded)loaded.run();}Loader.clearRes(url);}if(Loader.getRes(url))onLoaded(url);else ILaya.loader.load(url,Handler.create(null,onLoaded,[url]),null,Loader.JSON);}},{key:"frames",get:function get(){return this._frames;},set:function set(value){this._frames=value;if(value){this._count=value.length;if(this._actionName)this._setFramesFromCache(this._actionName,true);this.index=this._index;}}},{key:"source",set:function set(value){if(value.indexOf(".ani")>-1)this.loadAnimation(value);else if(value.indexOf(".json")>-1||value.indexOf("als")>-1||value.indexOf("atlas")>-1)this.loadAtlas(value);else this.loadImages(value.split(","));}},{key:"autoAnimation",set:function set(value){this.play(0,true,value);}},{key:"autoPlay",set:function set(value){if(value)this.play();else this.stop();}}],[{key:"createFrames",value:function createFrames(url,name){var arr;if(typeof url=='string'){var atlas=Loader.getAtlas(url);if(atlas&&atlas.length){arr=[];for(var i=0,n=atlas.length;i<n;i++){var g=new Graphics();g.drawImage(Loader.getRes(atlas[i]),0,0);arr.push(g);}}}else if(url instanceof Array){arr=[];for(i=0,n=url.length;i<n;i++){g=new Graphics();g.loadImage(url[i],0,0);arr.push(g);}}if(name)Animation.framesMap[name]=arr;return arr;}},{key:"clearCache",value:function clearCache(key){var cache=Animation.framesMap;var val;var key2=key+"#";for(val in cache){if(val===key||val.indexOf(key2)===0){delete Animation.framesMap[val];}}}}]);return Animation;}(AnimationBase);Animation.framesMap={};ILaya.regClass(Animation);ClassUtils.regClass("laya.display.Animation",Animation);ClassUtils.regClass("Laya.Animation",Animation);var EffectAnimation=function(_FrameAnimation2){_inherits(EffectAnimation,_FrameAnimation2);function EffectAnimation(){_classCallCheck(this,EffectAnimation);var _this57=_possibleConstructorReturn(this,(EffectAnimation.__proto__||Object.getPrototypeOf(EffectAnimation)).apply(this,arguments));_this57._initData={};return _this57;}_createClass(EffectAnimation,[{key:"_onOtherBegin",value:function _onOtherBegin(effect){if(effect===this)return;this.stop();}},{key:"_addEvent",value:function _addEvent(){if(!this._target||!this._playEvent)return;this._setControlNode(this._target);this._target.on(this._playEvent,this,this._onPlayAction);}},{key:"_onPlayAction",value:function _onPlayAction(){this.play(0,false);}},{key:"play",value:function play(){var start=arguments.length>0&&arguments[0]!==undefined?arguments[0]:0;var loop=arguments.length>1&&arguments[1]!==undefined?arguments[1]:true;var name=arguments.length>2&&arguments[2]!==undefined?arguments[2]:"";if(!this._target)return;this._target.event(EffectAnimation.EFFECT_BEGIN,[this]);this._recordInitData();_get(EffectAnimation.prototype.__proto__||Object.getPrototypeOf(EffectAnimation.prototype),"play",this).call(this,start,loop,name);}},{key:"_recordInitData",value:function _recordInitData(){if(!this._aniKeys)return;var i,len;len=this._aniKeys.length;var key;for(i=0;i<len;i++){key=this._aniKeys[i];this._initData[key]=this._target[key];}}},{key:"_displayToIndex",value:function _displayToIndex(value){if(!this._animationData)return;if(value<0)value=0;if(value>this._count)value=this._count;var nodes=this._animationData.nodes,i,len=nodes.length;len=len>1?1:len;for(i=0;i<len;i++){this._displayNodeToFrame(nodes[i],value);}}},{key:"_displayNodeToFrame",value:function _displayNodeToFrame(node,frame){var targetDic=arguments.length>2&&arguments[2]!==undefined?arguments[2]:null;if(!this._target)return;var target=this._target;var frames=node.frames,key,propFrames,value;var keys=node.keys,i,len=keys.length;var secondFrames=node.secondFrames;var tSecondFrame;var easeFun;var tKeyFrames;var startFrame;var endFrame;for(i=0;i<len;i++){key=keys[i];propFrames=frames[key];tSecondFrame=secondFrames[key];if(tSecondFrame==-1){value=this._initData[key];}else{if(frame<tSecondFrame){tKeyFrames=node.keyframes[key];startFrame=tKeyFrames[0];if(startFrame.tween){easeFun=Ease[startFrame.tweenMethod];if(easeFun==null)easeFun=Ease.linearNone;endFrame=tKeyFrames[1];value=easeFun(frame,this._initData[key],endFrame.value-this._initData[key],endFrame.index);}else{value=this._initData[key];}}else{if(propFrames.length>frame)value=propFrames[frame];else value=propFrames[propFrames.length-1];}}target[key]=value;}}},{key:"_calculateKeyFrames",value:function _calculateKeyFrames(node){_get(EffectAnimation.prototype.__proto__||Object.getPrototypeOf(EffectAnimation.prototype),"_calculateKeyFrames",this).call(this,node);var keyFrames=node.keyframes,key,tKeyFrames,target=node.target;var secondFrames={};node.secondFrames=secondFrames;for(key in keyFrames){tKeyFrames=keyFrames[key];if(tKeyFrames.length<=1)secondFrames[key]=-1;else secondFrames[key]=tKeyFrames[1].index;}}},{key:"target",set:function set(v){if(this._target)this._target.off(EffectAnimation.EFFECT_BEGIN,this,this._onOtherBegin);this._target=v;if(this._target)this._target.on(EffectAnimation.EFFECT_BEGIN,this,this._onOtherBegin);this._addEvent();},get:function get(){return this._target;}},{key:"playEvent",set:function set(event){this._playEvent=event;if(!event)return;this._addEvent();}},{key:"effectClass",set:function set(classStr){this._effectClass=ClassUtils.getClass(classStr);if(this._effectClass){var uiData=this._effectClass["uiView"];if(uiData){var aniData=uiData["animations"];if(aniData&&aniData[0]){var data=aniData[0];this._setUp({},data);if(data.nodes&&data.nodes[0]){this._aniKeys=data.nodes[0].keys;}}}}}},{key:"effectData",set:function set(uiData){if(uiData){var aniData=uiData["animations"];if(aniData&&aniData[0]){var data=aniData[0];this._setUp({},data);if(data.nodes&&data.nodes[0]){this._aniKeys=data.nodes[0].keys;}}}}}]);return EffectAnimation;}(FrameAnimation);EffectAnimation.EFFECT_BEGIN="effectbegin";ClassUtils.regClass("laya.display.EffectAnimation",EffectAnimation);ClassUtils.regClass("Laya.EffectAnimation",EffectAnimation);var SceneLoader=function(_EventDispatcher12){_inherits(SceneLoader,_EventDispatcher12);function SceneLoader(){_classCallCheck(this,SceneLoader);var _this58=_possibleConstructorReturn(this,(SceneLoader.__proto__||Object.getPrototypeOf(SceneLoader)).call(this));_this58._completeHandler=new Handler(_this58,_this58.onOneLoadComplete);_this58.reset();return _this58;}_createClass(SceneLoader,[{key:"reset",value:function reset(){this._toLoadList=[];this._isLoading=false;this.totalCount=0;}},{key:"load",value:function load(url){var is3D=arguments.length>1&&arguments[1]!==undefined?arguments[1]:false;var ifCheck=arguments.length>2&&arguments[2]!==undefined?arguments[2]:true;if(url instanceof Array){var i,len;len=url.length;for(i=0;i<len;i++){this._addToLoadList(url[i],is3D);}}else{this._addToLoadList(url,is3D);}if(ifCheck)this._checkNext();}},{key:"_addToLoadList",value:function _addToLoadList(url){var is3D=arguments.length>1&&arguments[1]!==undefined?arguments[1]:false;if(this._toLoadList.indexOf(url)>=0)return;if(Loader.getRes(url))return;if(is3D){this._toLoadList.push({url:url});}else this._toLoadList.push(url);this.totalCount++;}},{key:"_checkNext",value:function _checkNext(){if(!this._isLoading){if(this._toLoadList.length==0){this.event(Event.COMPLETE);return;}var tItem;tItem=this._toLoadList.pop();if(typeof tItem=='string'){this.loadOne(tItem);}else{this.loadOne(tItem.url,true);}}}},{key:"loadOne",value:function loadOne(url){var is3D=arguments.length>1&&arguments[1]!==undefined?arguments[1]:false;this._curUrl=url;var type=Utils.getFileExtension(this._curUrl);if(is3D){ILaya.loader.create(url,this._completeHandler);}else if(SceneLoader.LoadableExtensions[type]){ILaya.loader.load(url,this._completeHandler,null,SceneLoader.LoadableExtensions[type]);}else if(url!=AtlasInfoManager.getFileLoadPath(url)||SceneLoader.No3dLoadTypes[type]||!LoaderManager.createMap[type]){ILaya.loader.load(url,this._completeHandler);}else{ILaya.loader.create(url,this._completeHandler);}}},{key:"onOneLoadComplete",value:function onOneLoadComplete(){this._isLoading=false;if(!Loader.getRes(this._curUrl)){console.log("Fail to load:",this._curUrl);}var type=Utils.getFileExtension(this._curUrl);if(SceneLoader.LoadableExtensions[type]){var dataO;dataO=Loader.getRes(this._curUrl);if(dataO&&dataO instanceof Prefab){dataO=dataO.json;}if(dataO){if(dataO.loadList){this.load(dataO.loadList,false,false);}if(dataO.loadList3D){this.load(dataO.loadList3D,true,false);}}}if(type=="sk"){this.load(this._curUrl.replace(".sk",".png"),false,false);}this.event(Event.PROGRESS,this.getProgress());this._checkNext();}},{key:"getProgress",value:function getProgress(){return this.loadedCount/this.totalCount;}},{key:"leftCount",get:function get(){if(this._isLoading)return this._toLoadList.length+1;return this._toLoadList.length;}},{key:"loadedCount",get:function get(){return this.totalCount-this.leftCount;}}]);return SceneLoader;}(EventDispatcher);SceneLoader.LoadableExtensions={"scene":Loader.JSON,"scene3d":Loader.JSON,"ani":Loader.JSON,"ui":Loader.JSON,"prefab":Loader.PREFAB};SceneLoader.No3dLoadTypes={"png":true,"jpg":true,"txt":true};var Scene=function(_Sprite4){_inherits(Scene,_Sprite4);function Scene(){var createChildren=arguments.length>0&&arguments[0]!==undefined?arguments[0]:true;_classCallCheck(this,Scene);var _this59=_possibleConstructorReturn(this,(Scene.__proto__||Object.getPrototypeOf(Scene)).call(this));_this59.autoDestroyAtClosed=false;_this59.url=null;_this59._viewCreated=false;_this59._$componentType="Scene";_this59._setBit(Const.NOT_READY,true);Scene.unDestroyedScenes.push(_this59);_this59._scene=_this59;if(createChildren)_this59.createChildren();return _this59;}_createClass(Scene,[{key:"createChildren",value:function createChildren(){}},{key:"loadScene",value:function loadScene(path){var url=path.indexOf(".")>-1?path:path+".scene";var view=ILaya.loader.getRes(url);if(view){this.createView(view);}else{ILaya.loader.resetProgress();var loader=new SceneLoader();loader.on(Event.COMPLETE,this,this._onSceneLoaded,[url]);loader.load(url);}}},{key:"_onSceneLoaded",value:function _onSceneLoaded(url){this.createView(ILaya.Loader.getRes(url));}},{key:"createView",value:function createView(view){if(view&&!this._viewCreated){this._viewCreated=true;SceneUtils.createByData(this,view);}}},{key:"getNodeByID",value:function getNodeByID(id){if(this._idMap)return this._idMap[id];return null;}},{key:"open",value:function open(){var closeOther=arguments.length>0&&arguments[0]!==undefined?arguments[0]:true;var param=arguments.length>1&&arguments[1]!==undefined?arguments[1]:null;if(closeOther)Scene.closeAll();Scene.root.addChild(this);this.onOpened(param);}},{key:"onOpened",value:function onOpened(param){}},{key:"close",value:function close(){var type=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;this.onClosed(type);if(this.autoDestroyAtClosed)this.destroy();else this.removeSelf();}},{key:"onClosed",value:function onClosed(){var type=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;}},{key:"destroy",value:function destroy(){var destroyChild=arguments.length>0&&arguments[0]!==undefined?arguments[0]:true;this._idMap=null;_get(Scene.prototype.__proto__||Object.getPrototypeOf(Scene.prototype),"destroy",this).call(this,destroyChild);var list=Scene.unDestroyedScenes;for(var i=list.length-1;i>-1;i--){if(list[i]===this){list.splice(i,1);return;}}}},{key:"_sizeChanged",value:function _sizeChanged(){this.event(Event.RESIZE);}},{key:"scaleX",set:function set(value){if(_get(Scene.prototype.__proto__||Object.getPrototypeOf(Scene.prototype),"get_scaleX",this).call(this)==value)return;_get(Scene.prototype.__proto__||Object.getPrototypeOf(Scene.prototype),"set_scaleX",this).call(this,value);this.event(Event.RESIZE);},get:function get(){return _get(Scene.prototype.__proto__||Object.getPrototypeOf(Scene.prototype),"scaleX",this);}},{key:"scaleY",set:function set(value){if(_get(Scene.prototype.__proto__||Object.getPrototypeOf(Scene.prototype),"get_scaleY",this).call(this)==value)return;_get(Scene.prototype.__proto__||Object.getPrototypeOf(Scene.prototype),"set_scaleY",this).call(this,value);this.event(Event.RESIZE);},get:function get(){return _get(Scene.prototype.__proto__||Object.getPrototypeOf(Scene.prototype),"scaleY",this);}},{key:"width",get:function get(){if(this._width)return this._width;var max=0;for(var i=this.numChildren-1;i>-1;i--){var comp=this.getChildAt(i);if(comp._visible){max=Math.max(comp._x+comp.width*comp.scaleX,max);}}return max;},set:function set(value){if(_get(Scene.prototype.__proto__||Object.getPrototypeOf(Scene.prototype),"get_width",this).call(this)==value)return;_get(Scene.prototype.__proto__||Object.getPrototypeOf(Scene.prototype),"set_width",this).call(this,value);this.callLater(this._sizeChanged);}},{key:"height",get:function get(){if(this._height)return this._height;var max=0;for(var i=this.numChildren-1;i>-1;i--){var comp=this.getChildAt(i);if(comp._visible){max=Math.max(comp._y+comp.height*comp.scaleY,max);}}return max;},set:function set(value){if(_get(Scene.prototype.__proto__||Object.getPrototypeOf(Scene.prototype),"get_height",this).call(this)==value)return;_get(Scene.prototype.__proto__||Object.getPrototypeOf(Scene.prototype),"set_height",this).call(this,value);this.callLater(this._sizeChanged);}},{key:"timer",get:function get(){return this._timer||ILaya.timer;},set:function set(value){this._timer=value;}}],[{key:"setUIMap",value:function setUIMap(url){var uimap=ILaya.loader.getRes(url);if(uimap){for(var key in uimap){ILaya.Loader.loadedMap[URL.formatURL(key+".scene")]=uimap[key];}}else{throw"uimapjson";}}},{key:"load",value:function load(url){var complete=arguments.length>1&&arguments[1]!==undefined?arguments[1]:null;var progress=arguments.length>2&&arguments[2]!==undefined?arguments[2]:null;ILaya.loader.resetProgress();var loader=new SceneLoader();loader.on(Event.PROGRESS,null,onProgress);loader.once(Event.COMPLETE,null,create);loader.load(url);function onProgress(value){if(Scene._loadPage)Scene._loadPage.event("progress",value);progress&&progress.runWith(value);}function create(){loader.off(Event.PROGRESS,null,onProgress);var obj=ILaya.Loader.getRes(url);if(!obj)throw"Can not find scene:"+url;if(!obj.props)throw"Scene data is error:"+url;var runtime=obj.props.runtime?obj.props.runtime:obj.type;var clas=ILaya.ClassUtils.getClass(runtime);if(obj.props.renderType=="instance"){var scene=clas.instance||(clas.instance=new clas());}else{scene=new clas();}if(scene&&scene instanceof Node){scene.url=url;if(!scene._getBit(Const.NOT_READY)){complete&&complete.runWith(scene);}else{scene.on("onViewCreated",null,function(){complete&&complete.runWith(scene);});scene.createView(obj);}Scene.hideLoadingPage();}else{throw"Can not find scene:"+runtime;}}}},{key:"open",value:function open(url){var closeOther=arguments.length>1&&arguments[1]!==undefined?arguments[1]:true;var param=arguments.length>2&&arguments[2]!==undefined?arguments[2]:null;var complete=arguments.length>3&&arguments[3]!==undefined?arguments[3]:null;var progress=arguments.length>4&&arguments[4]!==undefined?arguments[4]:null;if(param instanceof Handler){var temp=complete;complete=param;param=temp;}Scene.showLoadingPage();Scene.load(url,Handler.create(null,this._onSceneLoaded,[closeOther,complete,param]),progress);}},{key:"_onSceneLoaded",value:function _onSceneLoaded(closeOther,complete,param,scene){scene.open(closeOther,param);if(complete)complete.runWith(scene);}},{key:"close",value:function close(url){var name=arguments.length>1&&arguments[1]!==undefined?arguments[1]:"";var flag=false;var list=Scene.unDestroyedScenes;for(var i=0,n=list.length;i<n;i++){var scene=list[i];if(scene&&scene.parent&&scene.url===url&&scene.name==name){scene.close();flag=true;}}return flag;}},{key:"closeAll",value:function closeAll(){var root=Scene.root;for(var i=0,n=root.numChildren;i<n;i++){var scene=root.getChildAt(0);if(scene instanceof Scene)scene.close();else scene.removeSelf();}}},{key:"destroy",value:function destroy(url){var name=arguments.length>1&&arguments[1]!==undefined?arguments[1]:"";var flag=false;var list=Scene.unDestroyedScenes;for(var i=0,n=list.length;i<n;i++){var scene=list[i];if(scene.url===url&&scene.name==name){scene.destroy();flag=true;}}return flag;}},{key:"gc",value:function gc(){Resource.destroyUnusedResources();}},{key:"setLoadingPage",value:function setLoadingPage(loadPage){if(Scene._loadPage!=loadPage){Scene._loadPage=loadPage;}}},{key:"showLoadingPage",value:function showLoadingPage(){var param=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;var delay=arguments.length>1&&arguments[1]!==undefined?arguments[1]:500;if(Scene._loadPage){ILaya.systemTimer.clear(null,Scene._showLoading);ILaya.systemTimer.clear(null,Scene._hideLoading);ILaya.systemTimer.once(delay,null,Scene._showLoading,[param],false);}}},{key:"_showLoading",value:function _showLoading(param){ILaya.stage.addChild(Scene._loadPage);Scene._loadPage.onOpened(param);}},{key:"_hideLoading",value:function _hideLoading(){Scene._loadPage.close();}},{key:"hideLoadingPage",value:function hideLoadingPage(){var delay=arguments.length>0&&arguments[0]!==undefined?arguments[0]:500;if(Scene._loadPage){ILaya.systemTimer.clear(null,Scene._showLoading);ILaya.systemTimer.clear(null,Scene._hideLoading);ILaya.systemTimer.once(delay,null,Scene._hideLoading);}}},{key:"root",get:function get(){if(!Scene._root){Scene._root=ILaya.stage.addChild(new Sprite());Scene._root.name="root";ILaya.stage.on("resize",null,function(){Scene._root.size(ILaya.stage.width,ILaya.stage.height);Scene._root.event(Event.RESIZE);});Scene._root.size(ILaya.stage.width,ILaya.stage.height);Scene._root.event(Event.RESIZE);}return Scene._root;}}]);return Scene;}(Sprite);Scene.unDestroyedScenes=[];ILaya.regClass(Scene);ClassUtils.regClass("laya.display.Scene",Scene);ClassUtils.regClass("Laya.Scene",Scene);var DrawParticleCmd=function(){function DrawParticleCmd(){_classCallCheck(this,DrawParticleCmd);}_createClass(DrawParticleCmd,[{key:"recover",value:function recover(){this._templ=null;Pool.recover("DrawParticleCmd",this);}},{key:"run",value:function run(context,gx,gy){context.drawParticle(gx,gy,this._templ);}},{key:"cmdID",get:function get(){return DrawParticleCmd.ID;}}],[{key:"create",value:function create(_temp){var cmd=Pool.getItemByClass("DrawParticleCmd",DrawParticleCmd);cmd._templ=_temp;return cmd;}}]);return DrawParticleCmd;}();DrawParticleCmd.ID="DrawParticleCmd";var FilterSetterBase=function(){function FilterSetterBase(){_classCallCheck(this,FilterSetterBase);}_createClass(FilterSetterBase,[{key:"paramChanged",value:function paramChanged(){Laya.systemTimer.callLater(this,this.buildFilter);}},{key:"buildFilter",value:function buildFilter(){if(this._target){this.addFilter(this._target);}}},{key:"addFilter",value:function addFilter(sprite){if(!sprite)return;if(!sprite.filters){sprite.filters=[this._filter];}else{var preFilters;preFilters=sprite.filters;if(preFilters.indexOf(this._filter)<0){preFilters.push(this._filter);sprite.filters=Utils.copyArray([],preFilters);}}}},{key:"removeFilter",value:function removeFilter(sprite){if(!sprite)return;sprite.filters=null;}},{key:"target",set:function set(value){if(this._target!=value){this._target=value;this.paramChanged();}}}]);return FilterSetterBase;}();var BlurFilterGLRender=function(){function BlurFilterGLRender(){_classCallCheck(this,BlurFilterGLRender);}_createClass(BlurFilterGLRender,[{key:"render",value:function render(rt,ctx,width,height,filter){var shaderValue=Value2D.create(ShaderDefines2D.TEXTURE2D,0);this.setShaderInfo(shaderValue,filter,rt.width,rt.height);ctx.drawTarget(rt,0,0,width,height,Matrix.EMPTY.identity(),shaderValue);}},{key:"setShaderInfo",value:function setShaderInfo(shader,filter,w,h){shader.defines.add(Filter.BLUR);var sv=shader;BlurFilterGLRender.blurinfo[0]=w;BlurFilterGLRender.blurinfo[1]=h;sv.blurInfo=BlurFilterGLRender.blurinfo;var sigma=filter.strength/3.0;var sigma2=sigma*sigma;filter.strength_sig2_2sig2_gauss1[0]=filter.strength;filter.strength_sig2_2sig2_gauss1[1]=sigma2;filter.strength_sig2_2sig2_gauss1[2]=2.0*sigma2;filter.strength_sig2_2sig2_gauss1[3]=1.0/(2.0*Math.PI*sigma2);sv.strength_sig2_2sig2_gauss1=filter.strength_sig2_2sig2_gauss1;}}]);return BlurFilterGLRender;}();BlurFilterGLRender.blurinfo=new Array(2);var BlurFilter=function(_Filter2){_inherits(BlurFilter,_Filter2);function BlurFilter(){var strength=arguments.length>0&&arguments[0]!==undefined?arguments[0]:4;_classCallCheck(this,BlurFilter);var _this60=_possibleConstructorReturn(this,(BlurFilter.__proto__||Object.getPrototypeOf(BlurFilter)).call(this));_this60.strength_sig2_2sig2_gauss1=[];_this60.strength=strength;_this60._glRender=new BlurFilterGLRender();return _this60;}_createClass(BlurFilter,[{key:"getStrenth_sig2_2sig2_native",value:function getStrenth_sig2_2sig2_native(){if(!this.strength_sig2_native){this.strength_sig2_native=new Float32Array(4);}var sigma=this.strength/3.0;var sigma2=sigma*sigma;this.strength_sig2_native[0]=this.strength;this.strength_sig2_native[1]=sigma2;this.strength_sig2_native[2]=2.0*sigma2;this.strength_sig2_native[3]=1.0/(2.0*Math.PI*sigma2);return this.strength_sig2_native;}},{key:"type",get:function get(){return Filter.BLUR;}}]);return BlurFilter;}(Filter);var BlurFilterSetter=function(_FilterSetterBase){_inherits(BlurFilterSetter,_FilterSetterBase);function BlurFilterSetter(){_classCallCheck(this,BlurFilterSetter);var _this61=_possibleConstructorReturn(this,(BlurFilterSetter.__proto__||Object.getPrototypeOf(BlurFilterSetter)).call(this));_this61._strength=4;_this61._filter=new BlurFilter(_this61.strength);return _this61;}_createClass(BlurFilterSetter,[{key:"buildFilter",value:function buildFilter(){this._filter=new BlurFilter(this.strength);_get(BlurFilterSetter.prototype.__proto__||Object.getPrototypeOf(BlurFilterSetter.prototype),"buildFilter",this).call(this);}},{key:"strength",get:function get(){return this._strength;},set:function set(value){this._strength=value;}}]);return BlurFilterSetter;}(FilterSetterBase);var ButtonEffect=function(){function ButtonEffect(){_classCallCheck(this,ButtonEffect);this._curState=0;this.effectScale=1.5;this.tweenTime=300;}_createClass(ButtonEffect,[{key:"toChangedState",value:function toChangedState(){this._curState=1;if(this._curTween)Tween.clear(this._curTween);this._curTween=Tween.to(this._tar,{scaleX:this.effectScale,scaleY:this.effectScale},this.tweenTime,Ease[this.effectEase],Handler.create(this,this.tweenComplete));}},{key:"toInitState",value:function toInitState(){if(this._curState==2)return;if(this._curTween)Tween.clear(this._curTween);this._curState=2;this._curTween=Tween.to(this._tar,{scaleX:1,scaleY:1},this.tweenTime,Ease[this.backEase],Handler.create(this,this.tweenComplete));}},{key:"tweenComplete",value:function tweenComplete(){this._curState=0;this._curTween=null;}},{key:"target",set:function set(tar){this._tar=tar;tar.on(Event.MOUSE_DOWN,this,this.toChangedState);tar.on(Event.MOUSE_UP,this,this.toInitState);tar.on(Event.MOUSE_OUT,this,this.toInitState);}}]);return ButtonEffect;}();var ColorFilterSetter=function(_FilterSetterBase2){_inherits(ColorFilterSetter,_FilterSetterBase2);function ColorFilterSetter(){_classCallCheck(this,ColorFilterSetter);var _this62=_possibleConstructorReturn(this,(ColorFilterSetter.__proto__||Object.getPrototypeOf(ColorFilterSetter)).call(this));_this62._brightness=0;_this62._contrast=0;_this62._saturation=0;_this62._hue=0;_this62._red=0;_this62._green=0;_this62._blue=0;_this62._alpha=0;_this62._filter=new ColorFilter();return _this62;}_createClass(ColorFilterSetter,[{key:"buildFilter",value:function buildFilter(){this._filter.reset();this._filter.color(this.red,this.green,this.blue,this.alpha);this._filter.adjustHue(this.hue);this._filter.adjustContrast(this.contrast);this._filter.adjustBrightness(this.brightness);this._filter.adjustSaturation(this.saturation);_get(ColorFilterSetter.prototype.__proto__||Object.getPrototypeOf(ColorFilterSetter.prototype),"buildFilter",this).call(this);}},{key:"brightness",get:function get(){return this._brightness;},set:function set(value){this._brightness=value;this.paramChanged();}},{key:"contrast",get:function get(){return this._contrast;},set:function set(value){this._contrast=value;this.paramChanged();}},{key:"saturation",get:function get(){return this._saturation;},set:function set(value){this._saturation=value;this.paramChanged();}},{key:"hue",get:function get(){return this._hue;},set:function set(value){this._hue=value;this.paramChanged();}},{key:"red",get:function get(){return this._red;},set:function set(value){this._red=value;this.paramChanged();}},{key:"green",get:function get(){return this._green;},set:function set(value){this._green=value;this.paramChanged();}},{key:"blue",get:function get(){return this._blue;},set:function set(value){this._blue=value;this.paramChanged();}},{key:"color",get:function get(){return this._color;},set:function set(value){this._color=value;var colorO;colorO=ColorUtils.create(value);this._red=colorO.arrColor[0]*255;this._green=colorO.arrColor[1]*255;this._blue=colorO.arrColor[2]*255;this.paramChanged();}},{key:"alpha",get:function get(){return this._alpha;},set:function set(value){this._alpha=value;this.paramChanged();}}]);return ColorFilterSetter;}(FilterSetterBase);var EffectBase=function(_Component3){_inherits(EffectBase,_Component3);function EffectBase(){_classCallCheck(this,EffectBase);var _this63=_possibleConstructorReturn(this,(EffectBase.__proto__||Object.getPrototypeOf(EffectBase)).apply(this,arguments));_this63.duration=1000;_this63.delay=0;_this63.repeat=0;_this63.autoDestroyAtComplete=true;return _this63;}_createClass(EffectBase,[{key:"_onAwake",value:function _onAwake(){this.target=this.target||this.owner;if(this.autoDestroyAtComplete)this._comlete=Handler.create(this.target,this.target.destroy,null,false);if(this.eventName)this.owner.on(this.eventName,this,this._exeTween);else this._exeTween();}},{key:"_exeTween",value:function _exeTween(){this._tween=this._doTween();this._tween.repeat=this.repeat;}},{key:"_doTween",value:function _doTween(){return null;}},{key:"onReset",value:function onReset(){this.duration=1000;this.delay=0;this.repeat=0;this.ease=null;this.target=null;if(this.eventName){this.owner.off(this.eventName,this,this._exeTween);this.eventName=null;}if(this._comlete){this._comlete.recover();this._comlete=null;}if(this._tween){this._tween.clear();this._tween=null;}}}]);return EffectBase;}(Component);var FadeIn=function(_EffectBase){_inherits(FadeIn,_EffectBase);function FadeIn(){_classCallCheck(this,FadeIn);return _possibleConstructorReturn(this,(FadeIn.__proto__||Object.getPrototypeOf(FadeIn)).apply(this,arguments));}_createClass(FadeIn,[{key:"_doTween",value:function _doTween(){this.target.alpha=0;return Tween.to(this.target,{alpha:1},this.duration,Ease[this.ease],this._comlete,this.delay);}}]);return FadeIn;}(EffectBase);var FadeOut=function(_EffectBase2){_inherits(FadeOut,_EffectBase2);function FadeOut(){_classCallCheck(this,FadeOut);return _possibleConstructorReturn(this,(FadeOut.__proto__||Object.getPrototypeOf(FadeOut)).apply(this,arguments));}_createClass(FadeOut,[{key:"_doTween",value:function _doTween(){this.target.alpha=1;return Tween.to(this.target,{alpha:0},this.duration,Ease[this.ease],this._comlete,this.delay);}}]);return FadeOut;}(EffectBase);var GlowFilterGLRender=function(){function GlowFilterGLRender(){_classCallCheck(this,GlowFilterGLRender);}_createClass(GlowFilterGLRender,[{key:"setShaderInfo",value:function setShaderInfo(shader,w,h,data){shader.defines.add(data.type);var sv=shader;sv.u_blurInfo1=data._sv_blurInfo1;var info2=data._sv_blurInfo2;info2[0]=w;info2[1]=h;sv.u_blurInfo2=info2;sv.u_color=data.getColor();}},{key:"render",value:function render(rt,ctx,width,height,filter){var w=width,h=height;var svBlur=Value2D.create(ShaderDefines2D.TEXTURE2D,0);this.setShaderInfo(svBlur,w,h,filter);var svCP=Value2D.create(ShaderDefines2D.TEXTURE2D,0);var matI=Matrix.TEMP.identity();ctx.drawTarget(rt,0,0,w,h,matI,svBlur);ctx.drawTarget(rt,0,0,w,h,matI,svCP);}}]);return GlowFilterGLRender;}();var GlowFilter=function(_Filter3){_inherits(GlowFilter,_Filter3);function GlowFilter(color){var blur=arguments.length>1&&arguments[1]!==undefined?arguments[1]:4;var offX=arguments.length>2&&arguments[2]!==undefined?arguments[2]:6;var offY=arguments.length>3&&arguments[3]!==undefined?arguments[3]:6;_classCallCheck(this,GlowFilter);var _this66=_possibleConstructorReturn(this,(GlowFilter.__proto__||Object.getPrototypeOf(GlowFilter)).call(this));_this66._elements=new Float32Array(9);_this66._sv_blurInfo1=new Array(4);_this66._sv_blurInfo2=[0,0,1,0];_this66._color=new ColorUtils(color);_this66.blur=Math.min(blur,20);_this66.offX=offX;_this66.offY=offY;_this66._sv_blurInfo1[0]=_this66._sv_blurInfo1[1]=_this66.blur;_this66._sv_blurInfo1[2]=offX;_this66._sv_blurInfo1[3]=-offY;_this66._glRender=new GlowFilterGLRender();return _this66;}_createClass(GlowFilter,[{key:"getColor",value:function getColor(){return this._color.arrColor;}},{key:"getColorNative",value:function getColorNative(){if(!this._color_native){this._color_native=new Float32Array(4);}var color=this.getColor();this._color_native[0]=color[0];this._color_native[1]=color[1];this._color_native[2]=color[2];this._color_native[3]=color[3];return this._color_native;}},{key:"getBlurInfo1Native",value:function getBlurInfo1Native(){if(!this._blurInof1_native){this._blurInof1_native=new Float32Array(4);}this._blurInof1_native[0]=this._blurInof1_native[1]=this.blur;this._blurInof1_native[2]=this.offX;this._blurInof1_native[3]=this.offY;return this._blurInof1_native;}},{key:"getBlurInfo2Native",value:function getBlurInfo2Native(){if(!this._blurInof2_native){this._blurInof2_native=new Float32Array(4);}this._blurInof2_native[2]=1;return this._blurInof2_native;}},{key:"type",get:function get(){return BlurFilter.GLOW;}},{key:"offY",get:function get(){return this._elements[6];},set:function set(value){this._elements[6]=value;this._sv_blurInfo1[3]=-value;}},{key:"offX",get:function get(){return this._elements[5];},set:function set(value){this._elements[5]=value;this._sv_blurInfo1[2]=value;}},{key:"blur",get:function get(){return this._elements[4];},set:function set(value){this._elements[4]=value;this._sv_blurInfo1[0]=this._sv_blurInfo1[1]=value;}}]);return GlowFilter;}(Filter);var GlowFilterSetter=function(_FilterSetterBase3){_inherits(GlowFilterSetter,_FilterSetterBase3);function GlowFilterSetter(){_classCallCheck(this,GlowFilterSetter);var _this67=_possibleConstructorReturn(this,(GlowFilterSetter.__proto__||Object.getPrototypeOf(GlowFilterSetter)).call(this));_this67._color="#ff0000";_this67._blur=4;_this67._offX=6;_this67._offY=6;_this67._filter=new GlowFilter(_this67._color);return _this67;}_createClass(GlowFilterSetter,[{key:"buildFilter",value:function buildFilter(){this._filter=new GlowFilter(this.color,this.blur,this.offX,this.offY);_get(GlowFilterSetter.prototype.__proto__||Object.getPrototypeOf(GlowFilterSetter.prototype),"buildFilter",this).call(this);}},{key:"color",get:function get(){return this._color;},set:function set(value){this._color=value;this.paramChanged();}},{key:"blur",get:function get(){return this._blur;},set:function set(value){this._blur=value;this.paramChanged();}},{key:"offX",get:function get(){return this._offX;},set:function set(value){this._offX=value;this.paramChanged();}},{key:"offY",get:function get(){return this._offY;},set:function set(value){this._offY=value;this.paramChanged();}}]);return GlowFilterSetter;}(FilterSetterBase);var KeyLocation=function KeyLocation(){_classCallCheck(this,KeyLocation);};KeyLocation.STANDARD=0;KeyLocation.LEFT=1;KeyLocation.RIGHT=2;KeyLocation.NUM_PAD=3;var Keyboard=function Keyboard(){_classCallCheck(this,Keyboard);};Keyboard.NUMBER_0=48;Keyboard.NUMBER_1=49;Keyboard.NUMBER_2=50;Keyboard.NUMBER_3=51;Keyboard.NUMBER_4=52;Keyboard.NUMBER_5=53;Keyboard.NUMBER_6=54;Keyboard.NUMBER_7=55;Keyboard.NUMBER_8=56;Keyboard.NUMBER_9=57;Keyboard.A=65;Keyboard.B=66;Keyboard.C=67;Keyboard.D=68;Keyboard.E=69;Keyboard.F=70;Keyboard.G=71;Keyboard.H=72;Keyboard.I=73;Keyboard.J=74;Keyboard.K=75;Keyboard.L=76;Keyboard.M=77;Keyboard.N=78;Keyboard.O=79;Keyboard.P=80;Keyboard.Q=81;Keyboard.R=82;Keyboard.S=83;Keyboard.T=84;Keyboard.U=85;Keyboard.V=86;Keyboard.W=87;Keyboard.X=88;Keyboard.Y=89;Keyboard.Z=90;Keyboard.F1=112;Keyboard.F2=113;Keyboard.F3=114;Keyboard.F4=115;Keyboard.F5=116;Keyboard.F6=117;Keyboard.F7=118;Keyboard.F8=119;Keyboard.F9=120;Keyboard.F10=121;Keyboard.F11=122;Keyboard.F12=123;Keyboard.F13=124;Keyboard.F14=125;Keyboard.F15=126;Keyboard.NUMPAD=21;Keyboard.NUMPAD_0=96;Keyboard.NUMPAD_1=97;Keyboard.NUMPAD_2=98;Keyboard.NUMPAD_3=99;Keyboard.NUMPAD_4=100;Keyboard.NUMPAD_5=101;Keyboard.NUMPAD_6=102;Keyboard.NUMPAD_7=103;Keyboard.NUMPAD_8=104;Keyboard.NUMPAD_9=105;Keyboard.NUMPAD_ADD=107;Keyboard.NUMPAD_DECIMAL=110;Keyboard.NUMPAD_DIVIDE=111;Keyboard.NUMPAD_ENTER=108;Keyboard.NUMPAD_MULTIPLY=106;Keyboard.NUMPAD_SUBTRACT=109;Keyboard.SEMICOLON=186;Keyboard.EQUAL=187;Keyboard.COMMA=188;Keyboard.MINUS=189;Keyboard.PERIOD=190;Keyboard.SLASH=191;Keyboard.BACKQUOTE=192;Keyboard.LEFTBRACKET=219;Keyboard.BACKSLASH=220;Keyboard.RIGHTBRACKET=221;Keyboard.QUOTE=222;Keyboard.ALTERNATE=18;Keyboard.BACKSPACE=8;Keyboard.CAPS_LOCK=20;Keyboard.COMMAND=15;Keyboard.CONTROL=17;Keyboard.DELETE=46;Keyboard.ENTER=13;Keyboard.ESCAPE=27;Keyboard.PAGE_UP=33;Keyboard.PAGE_DOWN=34;Keyboard.END=35;Keyboard.HOME=36;Keyboard.LEFT=37;Keyboard.UP=38;Keyboard.RIGHT=39;Keyboard.DOWN=40;Keyboard.SHIFT=16;Keyboard.SPACE=32;Keyboard.TAB=9;Keyboard.INSERT=45;var CommandEncoder=function(){function CommandEncoder(layagl,reserveSize,adjustSize,isSyncToRenderThread){_classCallCheck(this,CommandEncoder);this._idata=[];}_createClass(CommandEncoder,[{key:"getArrayData",value:function getArrayData(){return this._idata;}},{key:"getPtrID",value:function getPtrID(){return 0;}},{key:"beginEncoding",value:function beginEncoding(){}},{key:"endEncoding",value:function endEncoding(){}},{key:"clearEncoding",value:function clearEncoding(){this._idata.length=0;}},{key:"getCount",value:function getCount(){return this._idata.length;}},{key:"add_ShaderValue",value:function add_ShaderValue(o){this._idata.push(o);}},{key:"addShaderUniform",value:function addShaderUniform(one){this.add_ShaderValue(one);}}]);return CommandEncoder;}();var LayaGLRunner=function(){function LayaGLRunner(){_classCallCheck(this,LayaGLRunner);}_createClass(LayaGLRunner,null,[{key:"uploadShaderUniforms",value:function uploadShaderUniforms(layaGL,commandEncoder,shaderData,uploadUnTexture){var data=shaderData._data;var shaderUniform=commandEncoder.getArrayData();var shaderCall=0;for(var i=0,n=shaderUniform.length;i<n;i++){var one=shaderUniform[i];if(uploadUnTexture||one.textureID!==-1){var value=data[one.dataOffset];if(value!=null)shaderCall+=one.fun.call(one.caller,one,value);}}return shaderCall;}},{key:"uploadCustomUniform",value:function uploadCustomUniform(layaGL,custom,index,data){var shaderCall=0;var one=custom[index];if(one&&data!=null)shaderCall+=one.fun.call(one.caller,one,data);return shaderCall;}},{key:"uploadShaderUniformsForNative",value:function uploadShaderUniformsForNative(layaGL,commandEncoder,shaderData){var nType=LayaGL.UPLOAD_SHADER_UNIFORM_TYPE_ID;if(shaderData._runtimeCopyValues.length>0){nType=LayaGL.UPLOAD_SHADER_UNIFORM_TYPE_DATA;}var data=shaderData._data;return LayaGL.instance.uploadShaderUniforms(commandEncoder,data,nType);}}]);return LayaGLRunner;}();var QuickTestTool=function(){function QuickTestTool(){_classCallCheck(this,QuickTestTool);}_createClass(QuickTestTool,[{key:"render",value:function render(context,x,y){QuickTestTool._addType(this._renderType);QuickTestTool.showRenderTypeInfo(this._renderType);RenderSprite.renders[this._renderType]._fun(this,context,x+this._x,y+this._y);this._repaint=0;}},{key:"_stageRender",value:function _stageRender(context,x,y){QuickTestTool._countStart();QuickTestTool._PreStageRender.call(ILaya.stage,context,x,y);QuickTestTool._countEnd();}}],[{key:"getMCDName",value:function getMCDName(type){return QuickTestTool._typeToNameDic[type];}},{key:"showRenderTypeInfo",value:function showRenderTypeInfo(type){var force=arguments.length>1&&arguments[1]!==undefined?arguments[1]:false;if(!force&&QuickTestTool.showedDic[type])return;QuickTestTool.showedDic[type]=true;if(!QuickTestTool._rendertypeToStrDic[type]){var arr=[];var tType;tType=1;while(tType<=type){if(tType&type){arr.push(QuickTestTool.getMCDName(tType&type));}tType=tType<<1;}QuickTestTool._rendertypeToStrDic[type]=arr.join(",");}console.log("cmd:",QuickTestTool._rendertypeToStrDic[type]);}},{key:"__init__",value:function __init__(){QuickTestTool._typeToNameDic[SpriteConst.ALPHA]="ALPHA";QuickTestTool._typeToNameDic[SpriteConst.TRANSFORM]="TRANSFORM";QuickTestTool._typeToNameDic[SpriteConst.TEXTURE]="TEXTURE";QuickTestTool._typeToNameDic[SpriteConst.GRAPHICS]="GRAPHICS";QuickTestTool._typeToNameDic[SpriteConst.ONECHILD]="ONECHILD";QuickTestTool._typeToNameDic[SpriteConst.CHILDS]="CHILDS";QuickTestTool._typeToNameDic[SpriteConst.TRANSFORM|SpriteConst.ALPHA]="TRANSFORM|ALPHA";QuickTestTool._typeToNameDic[SpriteConst.CANVAS]="CANVAS";QuickTestTool._typeToNameDic[SpriteConst.BLEND]="BLEND";QuickTestTool._typeToNameDic[SpriteConst.FILTERS]="FILTERS";QuickTestTool._typeToNameDic[SpriteConst.MASK]="MASK";QuickTestTool._typeToNameDic[SpriteConst.CLIP]="CLIP";QuickTestTool._typeToNameDic[SpriteConst.LAYAGL3D]="LAYAGL3D";}},{key:"_countStart",value:function _countStart(){var key;for(key in QuickTestTool._countDic){QuickTestTool._countDic[key]=0;}}},{key:"_countEnd",value:function _countEnd(){QuickTestTool._i++;if(QuickTestTool._i>60){QuickTestTool.showCountInfo();QuickTestTool._i=0;}}},{key:"_addType",value:function _addType(type){if(!QuickTestTool._countDic[type]){QuickTestTool._countDic[type]=1;}else{QuickTestTool._countDic[type]+=1;}}},{key:"showCountInfo",value:function showCountInfo(){console.log("===================");var key;for(key in QuickTestTool._countDic){console.log("count:"+QuickTestTool._countDic[key]);QuickTestTool.showRenderTypeInfo(key,true);}}},{key:"enableQuickTest",value:function enableQuickTest(){QuickTestTool.__init__();Sprite["prototype"]["render"]=QuickTestTool["prototype"]["render"];QuickTestTool._PreStageRender=Stage["prototype"]["render"];Stage["prototype"]["render"]=QuickTestTool["prototype"]["_stageRender"];}}]);return QuickTestTool;}();QuickTestTool.showedDic={};QuickTestTool._rendertypeToStrDic={};QuickTestTool._typeToNameDic={};QuickTestTool._countDic={};QuickTestTool._i=0;var Sound=function(_EventDispatcher13){_inherits(Sound,_EventDispatcher13);function Sound(){_classCallCheck(this,Sound);return _possibleConstructorReturn(this,(Sound.__proto__||Object.getPrototypeOf(Sound)).apply(this,arguments));}_createClass(Sound,[{key:"load",value:function load(url){}},{key:"play",value:function play(){var startTime=arguments.length>0&&arguments[0]!==undefined?arguments[0]:0;var loops=arguments.length>1&&arguments[1]!==undefined?arguments[1]:0;return null;}},{key:"dispose",value:function dispose(){}},{key:"duration",get:function get(){return 0;}}]);return Sound;}(EventDispatcher);var SoundNode=function(_Sprite5){_inherits(SoundNode,_Sprite5);function SoundNode(){_classCallCheck(this,SoundNode);var _this69=_possibleConstructorReturn(this,(SoundNode.__proto__||Object.getPrototypeOf(SoundNode)).call(this));_this69.visible=false;_this69.on(Event.ADDED,_this69,_this69._onParentChange);_this69.on(Event.REMOVED,_this69,_this69._onParentChange);return _this69;}_createClass(SoundNode,[{key:"_onParentChange",value:function _onParentChange(){this.target=this.parent;}},{key:"play",value:function play(){var loops=arguments.length>0&&arguments[0]!==undefined?arguments[0]:1;var complete=arguments.length>1&&arguments[1]!==undefined?arguments[1]:null;if(isNaN(loops)){loops=1;}if(!this.url)return;this.stop();this._channel=SoundManager.playSound(this.url,loops,complete);}},{key:"stop",value:function stop(){if(this._channel&&!this._channel.isStopped){this._channel.stop();}this._channel=null;}},{key:"_setPlayAction",value:function _setPlayAction(tar,event,action){var add=arguments.length>3&&arguments[3]!==undefined?arguments[3]:true;if(!this[action])return;if(!tar)return;if(add){tar.on(event,this,this[action]);}else{tar.off(event,this,this[action]);}}},{key:"_setPlayActions",value:function _setPlayActions(tar,events,action){var add=arguments.length>3&&arguments[3]!==undefined?arguments[3]:true;if(!tar)return;if(!events)return;var eventArr=events.split(",");var i,len;len=eventArr.length;for(i=0;i<len;i++){this._setPlayAction(tar,eventArr[i],action,add);}}},{key:"playEvent",set:function set(events){this._playEvents=events;if(!events)return;if(this._tar){this._setPlayActions(this._tar,events,"play");}}},{key:"target",set:function set(tar){if(this._tar){this._setPlayActions(this._tar,this._playEvents,"play",false);this._setPlayActions(this._tar,this._stopEvents,"stop",false);}this._tar=tar;if(this._tar){this._setPlayActions(this._tar,this._playEvents,"play",true);this._setPlayActions(this._tar,this._stopEvents,"stop",true);}}},{key:"stopEvent",set:function set(events){this._stopEvents=events;if(!events)return;if(this._tar){this._setPlayActions(this._tar,events,"stop");}}}]);return SoundNode;}(Sprite);var ResourceVersion=function(){function ResourceVersion(){_classCallCheck(this,ResourceVersion);}_createClass(ResourceVersion,null,[{key:"enable",value:function enable(manifestFile,callback){var type=arguments.length>2&&arguments[2]!==undefined?arguments[2]:2;ResourceVersion.type=type;ILaya.loader.load(manifestFile,Handler.create(null,ResourceVersion.onManifestLoaded,[callback]),null,Loader.JSON);}},{key:"onManifestLoaded",value:function onManifestLoaded(callback,data){ResourceVersion.manifest=data;URL.customFormat=ResourceVersion.addVersionPrefix;callback.run();if(!data){console.warn("ERR_FILE_NOT_FOUND");}}},{key:"addVersionPrefix",value:function addVersionPrefix(originURL){originURL=URL.getAdptedFilePath(originURL);if(ResourceVersion.manifest&&ResourceVersion.manifest[originURL]){if(ResourceVersion.type==ResourceVersion.FILENAME_VERSION)return ResourceVersion.manifest[originURL];return ResourceVersion.manifest[originURL]+"/"+originURL;}return originURL;}}]);return ResourceVersion;}();ResourceVersion.FOLDER_VERSION=1;ResourceVersion.FILENAME_VERSION=2;ResourceVersion.type=ResourceVersion.FOLDER_VERSION;var Socket=function(_EventDispatcher14){_inherits(Socket,_EventDispatcher14);function Socket(){var host=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;var port=arguments.length>1&&arguments[1]!==undefined?arguments[1]:0;var byteClass=arguments.length>2&&arguments[2]!==undefined?arguments[2]:null;var protocols=arguments.length>3&&arguments[3]!==undefined?arguments[3]:null;_classCallCheck(this,Socket);var _this70=_possibleConstructorReturn(this,(Socket.__proto__||Object.getPrototypeOf(Socket)).call(this));_this70.disableInput=false;_this70.protocols=[];_this70._byteClass=byteClass?byteClass:Byte;_this70.protocols=protocols;_this70.endian=Socket.BIG_ENDIAN;if(host&&port>0&&port<65535)_this70.connect(host,port);return _this70;}_createClass(Socket,[{key:"connect",value:function connect(host,port){var url="ws://"+host+":"+port;this.connectByUrl(url);}},{key:"connectByUrl",value:function connectByUrl(url){var _this71=this;if(this._socket!=null)this.close();this._socket&&this.cleanSocket();if(!this.protocols||this.protocols.length==0){this._socket=new Browser.window.WebSocket(url);}else{this._socket=new Browser.window.WebSocket(url,this.protocols);}this._socket.binaryType="arraybuffer";this._output=new this._byteClass();this._output.endian=this.endian;this._input=new this._byteClass();this._input.endian=this.endian;this._addInputPosition=0;this._socket.onopen=function(e){_this71._onOpen(e);};this._socket.onmessage=function(msg){_this71._onMessage(msg);};this._socket.onclose=function(e){_this71._onClose(e);};this._socket.onerror=function(e){_this71._onError(e);};}},{key:"cleanSocket",value:function cleanSocket(){this.close();this._connected=false;this._socket.onopen=null;this._socket.onmessage=null;this._socket.onclose=null;this._socket.onerror=null;this._socket=null;}},{key:"close",value:function close(){if(this._socket!=null){try{this._socket.close();}catch(e){}}}},{key:"_onOpen",value:function _onOpen(e){this._connected=true;this.event(Event.OPEN,e);}},{key:"_onMessage",value:function _onMessage(msg){if(!msg||!msg.data)return;var data=msg.data;if(this.disableInput&&data){this.event(Event.MESSAGE,data);return;}if(this._input.length>0&&this._input.bytesAvailable<1){this._input.clear();this._addInputPosition=0;}var pre=this._input.pos;!this._addInputPosition&&(this._addInputPosition=0);this._input.pos=this._addInputPosition;if(data){if(typeof data=='string'){this._input.writeUTFBytes(data);}else{this._input.writeArrayBuffer(data);}this._addInputPosition=this._input.pos;this._input.pos=pre;}this.event(Event.MESSAGE,data);}},{key:"_onClose",value:function _onClose(e){this._connected=false;this.event(Event.CLOSE,e);}},{key:"_onError",value:function _onError(e){this.event(Event.ERROR,e);}},{key:"send",value:function send(data){this._socket.send(data);}},{key:"flush",value:function flush(){if(this._output&&this._output.length>0){var evt;try{this._socket&&this._socket.send(this._output.__getBuffer().slice(0,this._output.length));}catch(e){evt=e;}this._output.endian=this.endian;this._output.clear();if(evt)this.event(Event.ERROR,evt);}}},{key:"input",get:function get(){return this._input;}},{key:"output",get:function get(){return this._output;}},{key:"connected",get:function get(){return this._connected;}},{key:"endian",get:function get(){return this._endian;},set:function set(value){this._endian=value;if(this._input!=null)this._input.endian=value;if(this._output!=null)this._output.endian=value;}}]);return Socket;}(EventDispatcher);Socket.LITTLE_ENDIAN="littleEndian";Socket.BIG_ENDIAN="bigEndian";var System=function(){function System(){_classCallCheck(this,System);}_createClass(System,null,[{key:"changeDefinition",value:function changeDefinition(name,classObj){window.Laya[name]=classObj;var str=name+"=classObj";window['eval'](str);}}]);return System;}();var HTMLChar=function(){function HTMLChar(){_classCallCheck(this,HTMLChar);this.reset();}_createClass(HTMLChar,[{key:"setData",value:function setData(char,w,h,style){this.char=char;this.charNum=char.charCodeAt(0);this.x=this.y=0;this.width=w;this.height=h;this.style=style;this.isWord=!HTMLChar._isWordRegExp.test(char);return this;}},{key:"reset",value:function reset(){this.x=this.y=this.width=this.height=0;this.isWord=false;this.char=null;this.charNum=0;this.style=null;return this;}},{key:"recover",value:function recover(){Pool.recover("HTMLChar",this.reset());}},{key:"_isChar",value:function _isChar(){return true;}},{key:"_getCSSStyle",value:function _getCSSStyle(){return this.style;}}],[{key:"create",value:function create(){return Pool.getItemByClass("HTMLChar",HTMLChar);}}]);return HTMLChar;}();HTMLChar._isWordRegExp=new RegExp("[\\w\.]","");var Log=function(){function Log(){_classCallCheck(this,Log);}_createClass(Log,null,[{key:"enable",value:function enable(){if(!Log._logdiv){Log._logdiv=Browser.createElement('div');Log._logdiv.style.cssText="border:white;padding:4px;overflow-y:auto;z-index:1000000;background:rgba(100,100,100,0.6);color:white;position: absolute;left:0px;top:0px;width:50%;height:50%;";Browser.document.body.appendChild(Log._logdiv);Log._btn=Browser.createElement("button");Log._btn.innerText="Hide";Log._btn.style.cssText="z-index:1000001;position: absolute;left:10px;top:10px;";Log._btn.onclick=Log.toggle;Browser.document.body.appendChild(Log._btn);}}},{key:"toggle",value:function toggle(){var style=Log._logdiv.style;if(style.display===""){Log._btn.innerText="Show";style.display="none";}else{Log._btn.innerText="Hide";style.display="";}}},{key:"print",value:function print(value){if(Log._logdiv){if(Log._count>=Log.maxCount)Log.clear();Log._count++;Log._logdiv.innerText+=value+"\n";if(Log.autoScrollToBottom){if(Log._logdiv.scrollHeight-Log._logdiv.scrollTop-Log._logdiv.clientHeight<50){Log._logdiv.scrollTop=Log._logdiv.scrollHeight;}}}}},{key:"clear",value:function clear(){Log._logdiv.innerText="";Log._count=0;}}]);return Log;}();Log._count=0;Log.maxCount=50;Log.autoScrollToBottom=true;var DATANUM=300;var PerfData=function(){function PerfData(id,color,name,scale){_classCallCheck(this,PerfData);this.scale=1.0;this.datas=new Array(DATANUM);this.datapos=0;this.id=id;this.color=color;this.name=name;this.scale=scale;}_createClass(PerfData,[{key:"addData",value:function addData(v){this.datas[this.datapos]=v;this.datapos++;this.datapos%=DATANUM;}}]);return PerfData;}();var PerfHUD=function(_Sprite6){_inherits(PerfHUD,_Sprite6);function PerfHUD(){_classCallCheck(this,PerfHUD);var _this72=_possibleConstructorReturn(this,(PerfHUD.__proto__||Object.getPrototypeOf(PerfHUD)).call(this));_this72.datas=[];_this72.xdata=new Array(PerfHUD.DATANUM);_this72.ydata=new Array(PerfHUD.DATANUM);_this72.hud_width=800;_this72.hud_height=200;_this72.gMinV=0;_this72.gMaxV=100;_this72.textSpace=40;_this72.sttm=0;PerfHUD.inst=_this72;_this72._renderType|=SpriteConst.CUSTOM;_this72._setRenderType(_this72._renderType);_this72._setCustomRender();_this72.addDataDef(0,0xffffff,'frame',1.0);_this72.addDataDef(1,0x00ff00,'update',1.0);_this72.addDataDef(2,0xff0000,'flush',1.0);PerfHUD._now=performance?performance.now.bind(performance):Date.now;return _this72;}_createClass(PerfHUD,[{key:"now",value:function now(){return PerfHUD._now();}},{key:"start",value:function start(){this.sttm=PerfHUD._now();}},{key:"end",value:function end(i){var dt=PerfHUD._now()-this.sttm;this.updateValue(i,dt);}},{key:"config",value:function config(w,h){this.hud_width=w;this.hud_height=h;}},{key:"addDataDef",value:function addDataDef(id,color,name,scale){this.datas[id]=new PerfData(id,color,name,scale);}},{key:"updateValue",value:function updateValue(id,v){this.datas[id].addData(v);}},{key:"v2y",value:function v2y(v){var bb=this._y+this.hud_height*(1-(v-this.gMinV)/this.gMaxV);return this._y+this.hud_height*(1-(v-this.gMinV)/this.gMaxV);}},{key:"drawHLine",value:function drawHLine(ctx,v,color,text){var sx=this._x;var ex=this._x+this.hud_width;var sy=this.v2y(v);ctx.fillText(text,sx,sy-6,null,'green',null);sx+=this.textSpace;ctx.fillStyle=color;ctx.fillRect(sx,sy,this._x+this.hud_width,1,null);}},{key:"customRender",value:function customRender(ctx,x,y){var now=performance.now();if(PerfHUD._lastTm<=0)PerfHUD._lastTm=now;this.updateValue(0,now-PerfHUD._lastTm);PerfHUD._lastTm=now;ctx.save();ctx.fillRect(this._x,this._y,this.hud_width,this.hud_height+4,'#000000cc');ctx.globalAlpha=0.9;this.drawHLine(ctx,0,'green','    0');this.drawHLine(ctx,10,'green','  10');this.drawHLine(ctx,16.667,'red',' ');this.drawHLine(ctx,20,'green','50|20');this.drawHLine(ctx,16.667*2,'yellow','');this.drawHLine(ctx,16.667*3,'yellow','');this.drawHLine(ctx,16.667*4,'yellow','');this.drawHLine(ctx,50,'green','20|50');this.drawHLine(ctx,100,'green','10|100');for(var di=0,sz=this.datas.length;di<sz;di++){var cd=this.datas[di];if(!cd)continue;var dtlen=cd.datas.length;var dx=(this.hud_width-this.textSpace)/dtlen;var cx=cd.datapos;var _cx=this._x+this.textSpace;ctx.fillStyle=cd.color;for(var dtsz=dtlen;cx<dtsz;cx++){var sty=this.v2y(cd.datas[cx]*cd.scale);ctx.fillRect(_cx,sty,dx,this.hud_height+this._y-sty,null);_cx+=dx;}for(cx=0;cx<cd.datapos;cx++){sty=this.v2y(cd.datas[cx]*cd.scale);ctx.fillRect(_cx,sty,dx,this.hud_height+this._y-sty,null);_cx+=dx;}}ctx.restore();}}]);return PerfHUD;}(Sprite);PerfHUD._lastTm=0;PerfHUD._now=null;PerfHUD.DATANUM=300;PerfHUD.drawTexTm=0;var PoolCache=function(){function PoolCache(){_classCallCheck(this,PoolCache);this.maxCount=1000;}_createClass(PoolCache,[{key:"getCacheList",value:function getCacheList(){return Pool.getPoolBySign(this.sign);}},{key:"tryDispose",value:function tryDispose(force){var list;list=Pool.getPoolBySign(this.sign);if(list.length>this.maxCount){list.splice(this.maxCount,list.length-this.maxCount);}}}],[{key:"addPoolCacheManager",value:function addPoolCacheManager(sign){var maxCount=arguments.length>1&&arguments[1]!==undefined?arguments[1]:100;var cache;cache=new PoolCache();cache.sign=sign;cache.maxCount=maxCount;CacheManger.regCacheByFunction(Utils.bind(cache.tryDispose,cache),Utils.bind(cache.getCacheList,cache));}}]);return PoolCache;}();var TimeLine=function(_EventDispatcher15){_inherits(TimeLine,_EventDispatcher15);function TimeLine(){_classCallCheck(this,TimeLine);var _this73=_possibleConstructorReturn(this,(TimeLine.__proto__||Object.getPrototypeOf(TimeLine)).apply(this,arguments));_this73._tweenDic={};_this73._tweenDataList=[];_this73._currTime=0;_this73._lastTime=0;_this73._startTime=0;_this73._index=0;_this73._gidIndex=0;_this73._firstTweenDic={};_this73._startTimeSort=false;_this73._endTimeSort=false;_this73._loopKey=false;_this73.scale=1;_this73._frameRate=60;_this73._frameIndex=0;_this73._total=0;return _this73;}_createClass(TimeLine,[{key:"to",value:function to(target,props,duration){var ease=arguments.length>3&&arguments[3]!==undefined?arguments[3]:null;var offset=arguments.length>4&&arguments[4]!==undefined?arguments[4]:0;return this._create(target,props,duration,ease,offset,true);}},{key:"from",value:function from(target,props,duration){var ease=arguments.length>3&&arguments[3]!==undefined?arguments[3]:null;var offset=arguments.length>4&&arguments[4]!==undefined?arguments[4]:0;return this._create(target,props,duration,ease,offset,false);}},{key:"_create",value:function _create(target,props,duration,ease,offset,isTo){var tTweenData=Pool.getItemByClass("tweenData",tweenData);tTweenData.isTo=isTo;tTweenData.type=0;tTweenData.target=target;tTweenData.duration=duration;tTweenData.data=props;tTweenData.startTime=this._startTime+offset;tTweenData.endTime=tTweenData.startTime+tTweenData.duration;tTweenData.ease=ease;this._startTime=Math.max(tTweenData.endTime,this._startTime);this._tweenDataList.push(tTweenData);this._startTimeSort=true;this._endTimeSort=true;return this;}},{key:"addLabel",value:function addLabel(label,offset){var tTweenData=Pool.getItemByClass("tweenData",tweenData);tTweenData.type=1;tTweenData.data=label;tTweenData.endTime=tTweenData.startTime=this._startTime+offset;this._labelDic||(this._labelDic={});this._labelDic[label]=tTweenData;this._tweenDataList.push(tTweenData);return this;}},{key:"removeLabel",value:function removeLabel(label){if(this._labelDic&&this._labelDic[label]){var tTweenData=this._labelDic[label];if(tTweenData){var tIndex=this._tweenDataList.indexOf(tTweenData);if(tIndex>-1){this._tweenDataList.splice(tIndex,1);}}delete this._labelDic[label];}}},{key:"gotoTime",value:function gotoTime(time){if(this._tweenDataList==null||this._tweenDataList.length==0)return;var tTween;var tObject;for(var p in this._firstTweenDic){tObject=this._firstTweenDic[p];if(tObject){for(var tDataP in tObject){if(tDataP in tObject.diyTarget){tObject.diyTarget[tDataP]=tObject[tDataP];}}}}for(p in this._tweenDic){tTween=this._tweenDic[p];tTween.clear();delete this._tweenDic[p];}this._index=0;this._gidIndex=0;this._currTime=time;this._lastTime=Browser.now();var tTweenDataCopyList;if(this._endTweenDataList==null||this._endTimeSort){var Compare=function Compare(paraA,paraB){if(paraA.endTime>paraB.endTime){return 1;}else if(paraA.endTime<paraB.endTime){return-1;}else{return 0;}};this._endTimeSort=false;this._endTweenDataList=tTweenDataCopyList=this._tweenDataList.concat();tTweenDataCopyList.sort(Compare);}else{tTweenDataCopyList=this._endTweenDataList;}var tTweenData;for(var i=0,n=tTweenDataCopyList.length;i<n;i++){tTweenData=tTweenDataCopyList[i];if(tTweenData.type==0){if(time>=tTweenData.endTime){this._index=Math.max(this._index,i+1);var props=tTweenData.data;if(tTweenData.isTo){for(var tP in props){tTweenData.target[tP]=props[tP];}}}else{break;}}}for(i=0,n=this._tweenDataList.length;i<n;i++){tTweenData=this._tweenDataList[i];if(tTweenData.type==0){if(time>=tTweenData.startTime&&time<tTweenData.endTime){this._index=Math.max(this._index,i+1);this._gidIndex++;tTween=Pool.getItemByClass("tween",Tween);tTween._create(tTweenData.target,tTweenData.data,tTweenData.duration,tTweenData.ease,Handler.create(this,this._animComplete,[this._gidIndex]),0,false,tTweenData.isTo,true,false);tTween.setStartTime(this._currTime-(time-tTweenData.startTime));tTween._updateEase(this._currTime);tTween.gid=this._gidIndex;this._tweenDic[this._gidIndex]=tTween;}}}}},{key:"gotoLabel",value:function gotoLabel(Label){if(this._labelDic==null)return;var tLabelData=this._labelDic[Label];if(tLabelData)this.gotoTime(tLabelData.startTime);}},{key:"pause",value:function pause(){ILaya.timer.clear(this,this._update);}},{key:"resume",value:function resume(){this.play(this._currTime,this._loopKey);}},{key:"play",value:function play(){var timeOrLabel=arguments.length>0&&arguments[0]!==undefined?arguments[0]:0;var loop=arguments.length>1&&arguments[1]!==undefined?arguments[1]:false;if(!this._tweenDataList)return;if(this._startTimeSort){var Compare=function Compare(paraA,paraB){if(paraA.startTime>paraB.startTime){return 1;}else if(paraA.startTime<paraB.startTime){return-1;}else{return 0;}};this._startTimeSort=false;this._tweenDataList.sort(Compare);for(var i=0,n=this._tweenDataList.length;i<n;i++){var tTweenData=this._tweenDataList[i];if(tTweenData!=null&&tTweenData.type==0){var tTarget=tTweenData.target;var gid=tTarget.$_GID||(tTarget.$_GID=Utils.getGID());var tSrcData=null;if(this._firstTweenDic[gid]==null){tSrcData={};tSrcData.diyTarget=tTarget;this._firstTweenDic[gid]=tSrcData;}else{tSrcData=this._firstTweenDic[gid];}for(var p in tTweenData.data){if(tSrcData[p]==null){tSrcData[p]=tTarget[p];}}}}}if(typeof timeOrLabel=='string'){this.gotoLabel(timeOrLabel);}else{this.gotoTime(timeOrLabel);}this._loopKey=loop;this._lastTime=Browser.now();ILaya.timer.frameLoop(1,this,this._update);}},{key:"_update",value:function _update(){if(this._currTime>=this._startTime){if(this._loopKey){this._complete();if(!this._tweenDataList)return;this.gotoTime(0);}else{for(var p in this._tweenDic){tTween=this._tweenDic[p];tTween.complete();}this.pause();this._complete();return;}}var tNow=Browser.now();var tFrameTime=tNow-this._lastTime;var tCurrTime=this._currTime+=tFrameTime*this.scale;this._lastTime=tNow;for(p in this._tweenDic){tTween=this._tweenDic[p];tTween._updateEase(tCurrTime);}var tTween;if(this._tweenDataList.length!=0&&this._index<this._tweenDataList.length){var tTweenData=this._tweenDataList[this._index];if(tCurrTime>=tTweenData.startTime){this._index++;if(tTweenData.type==0){this._gidIndex++;tTween=Pool.getItemByClass("tween",Tween);tTween._create(tTweenData.target,tTweenData.data,tTweenData.duration,tTweenData.ease,Handler.create(this,this._animComplete,[this._gidIndex]),0,false,tTweenData.isTo,true,false);tTween.setStartTime(tCurrTime);tTween.gid=this._gidIndex;this._tweenDic[this._gidIndex]=tTween;tTween._updateEase(tCurrTime);}else{this.event(Event.LABEL,tTweenData.data);}}}}},{key:"_animComplete",value:function _animComplete(index){var tTween=this._tweenDic[index];if(tTween)delete this._tweenDic[index];}},{key:"_complete",value:function _complete(){this.event(Event.COMPLETE);}},{key:"reset",value:function reset(){var p;if(this._labelDic){for(p in this._labelDic){delete this._labelDic[p];}}var tTween;for(p in this._tweenDic){tTween=this._tweenDic[p];tTween.clear();delete this._tweenDic[p];}for(p in this._firstTweenDic){delete this._firstTweenDic[p];}this._endTweenDataList=null;if(this._tweenDataList&&this._tweenDataList.length){var i,len;len=this._tweenDataList.length;for(i=0;i<len;i++){if(this._tweenDataList[i])this._tweenDataList[i].destroy();}}this._tweenDataList.length=0;this._currTime=0;this._lastTime=0;this._startTime=0;this._index=0;this._gidIndex=0;this.scale=1;ILaya.timer.clear(this,this._update);}},{key:"destroy",value:function destroy(){this.reset();this._labelDic=null;this._tweenDic=null;this._tweenDataList=null;this._firstTweenDic=null;}},{key:"index",get:function get(){return this._frameIndex;},set:function set(value){this._frameIndex=value;this.gotoTime(this._frameIndex/this._frameRate*1000);}},{key:"total",get:function get(){this._total=Math.floor(this._startTime/1000*this._frameRate);return this._total;}}],[{key:"to",value:function to(target,props,duration){var ease=arguments.length>3&&arguments[3]!==undefined?arguments[3]:null;var offset=arguments.length>4&&arguments[4]!==undefined?arguments[4]:0;return new TimeLine().to(target,props,duration,ease,offset);}},{key:"from",value:function from(target,props,duration){var ease=arguments.length>3&&arguments[3]!==undefined?arguments[3]:null;var offset=arguments.length>4&&arguments[4]!==undefined?arguments[4]:0;return new TimeLine().from(target,props,duration,ease,offset);}}]);return TimeLine;}(EventDispatcher);var tweenData=function(){function tweenData(){_classCallCheck(this,tweenData);this.type=0;this.isTo=true;}_createClass(tweenData,[{key:"destroy",value:function destroy(){this.target=null;this.ease=null;this.data=null;this.isTo=true;this.type=0;Pool.recover("tweenData",this);}}]);return tweenData;}();var ShaderValue=function ShaderValue(){_classCallCheck(this,ShaderValue);};var ArabicReshaper=function(){function ArabicReshaper(){_classCallCheck(this,ArabicReshaper);}_createClass(ArabicReshaper,[{key:"characterMapContains",value:function characterMapContains(c){for(var i=0;i<ArabicReshaper.charsMap.length;++i){if(ArabicReshaper.charsMap[i][0]===c){return true;}}return false;}},{key:"getCharRep",value:function getCharRep(c){for(var i=0;i<ArabicReshaper.charsMap.length;++i){if(ArabicReshaper.charsMap[i][0]===c){return ArabicReshaper.charsMap[i];}}return false;}},{key:"getCombCharRep",value:function getCombCharRep(c1,c2){for(var i=0;i<ArabicReshaper.combCharsMap.length;++i){if(ArabicReshaper.combCharsMap[i][0][0]===c1&&ArabicReshaper.combCharsMap[i][0][1]===c2){return ArabicReshaper.combCharsMap[i];}}return false;}},{key:"isTransparent",value:function isTransparent(c){for(var i=0;i<ArabicReshaper.transChars.length;++i){if(ArabicReshaper.transChars[i]===c){return true;}}return false;}},{key:"getOriginalCharsFromCode",value:function getOriginalCharsFromCode(code){var j;for(j=0;j<ArabicReshaper.charsMap.length;++j){if(ArabicReshaper.charsMap[j].indexOf(code)>-1){return String.fromCharCode(ArabicReshaper.charsMap[j][0]);}}for(j=0;j<ArabicReshaper.combCharsMap.length;++j){if(ArabicReshaper.combCharsMap[j].indexOf(code)>-1){return String.fromCharCode(ArabicReshaper.combCharsMap[j][0][0])+String.fromCharCode(ArabicReshaper.combCharsMap[j][0][1]);}}return String.fromCharCode(code);}},{key:"convertArabic",value:function convertArabic(normal){var crep,combcrep,shaped='';for(var i=0;i<normal.length;++i){var current=normal.charCodeAt(i);if(this.characterMapContains(current)){var prev=null,next=null,prevID=i-1,nextID=i+1;for(;prevID>=0;--prevID){if(!this.isTransparent(normal.charCodeAt(prevID))){break;}}prev=prevID>=0?normal.charCodeAt(prevID):null;crep=prev?this.getCharRep(prev):false;if(!crep||crep[2]==null&&crep[3]==null){prev=null;}for(;nextID<normal.length;++nextID){if(!this.isTransparent(normal.charCodeAt(nextID))){break;}}next=nextID<normal.length?normal.charCodeAt(nextID):null;crep=next?this.getCharRep(next):false;if(!crep||crep[3]==null&&crep[4]==null){next=null;}if(current===0x0644&&next!=null&&(next===0x0622||next===0x0623||next===0x0625||next===0x0627)){combcrep=this.getCombCharRep(current,next);if(prev!=null){shaped+=String.fromCharCode(combcrep[4]);}else{shaped+=String.fromCharCode(combcrep[1]);}++i;continue;}crep=this.getCharRep(current);if(prev!=null&&next!=null&&crep[3]!=null){shaped+=String.fromCharCode(crep[3]);continue;}else if(prev!=null&&crep[4]!=null){shaped+=String.fromCharCode(crep[4]);continue;}else if(next!=null&&crep[2]!=null){shaped+=String.fromCharCode(crep[2]);continue;}else{shaped+=String.fromCharCode(crep[1]);}}else{shaped+=String.fromCharCode(current);}}return shaped;}},{key:"convertArabicBack",value:function convertArabicBack(apfb){var toReturn='',selectedChar;var i;for(i=0;i<apfb.length;++i){selectedChar=apfb.charCodeAt(i);toReturn+=this.getOriginalCharsFromCode(selectedChar);}return toReturn;}}]);return ArabicReshaper;}();ArabicReshaper.charsMap=[[0x0621,0xFE80,null,null,null],[0x0622,0xFE81,null,null,0xFE82],[0x0623,0xFE83,null,null,0xFE84],[0x0624,0xFE85,null,null,0xFE86],[0x0625,0xFE87,null,null,0xFE88],[0x0626,0xFE89,0xFE8B,0xFE8C,0xFE8A],[0x0627,0xFE8D,null,null,0xFE8E],[0x0628,0xFE8F,0xFE91,0xFE92,0xFE90],[0x0629,0xFE93,null,null,0xFE94],[0x062A,0xFE95,0xFE97,0xFE98,0xFE96],[0x062B,0xFE99,0xFE9B,0xFE9C,0xFE9A],[0x062C,0xFE9D,0xFE9F,0xFEA0,0xFE9E],[0x062D,0xFEA1,0xFEA3,0xFEA4,0xFEA2],[0x062E,0xFEA5,0xFEA7,0xFEA8,0xFEA6],[0x062F,0xFEA9,null,null,0xFEAA],[0x0630,0xFEAB,null,null,0xFEAC],[0x0631,0xFEAD,null,null,0xFEAE],[0x0632,0xFEAF,null,null,0xFEB0],[0x0633,0xFEB1,0xFEB3,0xFEB4,0xFEB2],[0x0634,0xFEB5,0xFEB7,0xFEB8,0xFEB6],[0x0635,0xFEB9,0xFEBB,0xFEBC,0xFEBA],[0x0636,0xFEBD,0xFEBF,0xFEC0,0xFEBE],[0x0637,0xFEC1,0xFEC3,0xFEC4,0xFEC2],[0x0638,0xFEC5,0xFEC7,0xFEC8,0xFEC6],[0x0639,0xFEC9,0xFECB,0xFECC,0xFECA],[0x063A,0xFECD,0xFECF,0xFED0,0xFECE],[0x0640,0x0640,0x0640,0x0640,0x0640],[0x0641,0xFED1,0xFED3,0xFED4,0xFED2],[0x0642,0xFED5,0xFED7,0xFED8,0xFED6],[0x0643,0xFED9,0xFEDB,0xFEDC,0xFEDA],[0x0644,0xFEDD,0xFEDF,0xFEE0,0xFEDE],[0x0645,0xFEE1,0xFEE3,0xFEE4,0xFEE2],[0x0646,0xFEE5,0xFEE7,0xFEE8,0xFEE6],[0x0647,0xFEE9,0xFEEB,0xFEEC,0xFEEA],[0x0648,0xFEED,null,null,0xFEEE],[0x0649,0xFEEF,null,null,0xFEF0],[0x064A,0xFEF1,0xFEF3,0xFEF4,0xFEF2],[0x067E,0xFB56,0xFB58,0xFB59,0xFB57],[0x06CC,0xFBFC,0xFBFE,0xFBFF,0xFBFD],[0x0686,0xFB7A,0xFB7C,0xFB7D,0xFB7B],[0x06A9,0xFB8E,0xFB90,0xFB91,0xFB8F],[0x06AF,0xFB92,0xFB94,0xFB95,0xFB93],[0x0698,0xFB8A,null,null,0xFB8B]];ArabicReshaper.combCharsMap=[[[0x0644,0x0622],0xFEF5,null,null,0xFEF6],[[0x0644,0x0623],0xFEF7,null,null,0xFEF8],[[0x0644,0x0625],0xFEF9,null,null,0xFEFA],[[0x0644,0x0627],0xFEFB,null,null,0xFEFC]];ArabicReshaper.transChars=[0x0610,0x0612,0x0613,0x0614,0x0615,0x064B,0x064C,0x064D,0x064E,0x064F,0x0650,0x0651,0x0652,0x0653,0x0654,0x0655,0x0656,0x0657,0x0658,0x0670,0x06D6,0x06D7,0x06D8,0x06D9,0x06DA,0x06DB,0x06DC,0x06DF,0x06E0,0x06E1,0x06E2,0x06E3,0x06E4,0x06E7,0x06E8,0x06EA,0x06EB,0x06EC,0x06ED];var MatirxArray=function(){function MatirxArray(){_classCallCheck(this,MatirxArray);}_createClass(MatirxArray,null,[{key:"ArrayMul",value:function ArrayMul(a,b,o){if(!a){MatirxArray.copyArray(b,o);return;}if(!b){MatirxArray.copyArray(a,o);return;}var ai0,ai1,ai2,ai3;for(var i=0;i<4;i++){ai0=a[i];ai1=a[i+4];ai2=a[i+8];ai3=a[i+12];o[i]=ai0*b[0]+ai1*b[1]+ai2*b[2]+ai3*b[3];o[i+4]=ai0*b[4]+ai1*b[5]+ai2*b[6]+ai3*b[7];o[i+8]=ai0*b[8]+ai1*b[9]+ai2*b[10]+ai3*b[11];o[i+12]=ai0*b[12]+ai1*b[13]+ai2*b[14]+ai3*b[15];}}},{key:"copyArray",value:function copyArray(f,t){if(!f)return;if(!t)return;for(var i=0;i<f.length;i++){t[i]=f[i];}}}]);return MatirxArray;}();exports.AlphaCmd=AlphaCmd;exports.Animation=Animation;exports.AnimationBase=AnimationBase;exports.ArabicReshaper=ArabicReshaper;exports.AtlasGrid=AtlasGrid;exports.AtlasInfoManager=AtlasInfoManager;exports.AudioSound=AudioSound;exports.AudioSoundChannel=AudioSoundChannel;exports.BasePoly=BasePoly;exports.BaseShader=BaseShader;exports.BaseTexture=BaseTexture;exports.Bezier=Bezier;exports.Bitmap=Bitmap;exports.BitmapFont=BitmapFont;exports.BlendMode=BlendMode;exports.BlurFilter=BlurFilter;exports.BlurFilterGLRender=BlurFilterGLRender;exports.BlurFilterSetter=BlurFilterSetter;exports.BoundsStyle=BoundsStyle;exports.Browser=Browser;exports.Buffer=Buffer;exports.Buffer2D=Buffer2D;exports.BufferState2D=BufferState2D;exports.BufferStateBase=BufferStateBase;exports.ButtonEffect=ButtonEffect;exports.Byte=Byte;exports.CONST3D2D=CONST3D2D;exports.CacheManger=CacheManger;exports.CacheStyle=CacheStyle;exports.CallLater=CallLater;exports.CharRenderInfo=CharRenderInfo;exports.CharRender_Canvas=CharRender_Canvas;exports.CharRender_Native=CharRender_Native;exports.CharSubmitCache=CharSubmitCache;exports.ClassUtils=ClassUtils;exports.ClipRectCmd=ClipRectCmd;exports.ColorFilter=ColorFilter;exports.ColorFilterSetter=ColorFilterSetter;exports.ColorUtils=ColorUtils;exports.CommandEncoder=CommandEncoder;exports.CommonScript=CommonScript;exports.Component=Component;exports.Config=Config;exports.Const=Const;exports.Context=Context;exports.Dragging=Dragging;exports.Draw9GridTexture=Draw9GridTexture;exports.DrawCircleCmd=DrawCircleCmd;exports.DrawCurvesCmd=DrawCurvesCmd;exports.DrawImageCmd=DrawImageCmd;exports.DrawLineCmd=DrawLineCmd;exports.DrawLinesCmd=DrawLinesCmd;exports.DrawParticleCmd=DrawParticleCmd;exports.DrawPathCmd=DrawPathCmd;exports.DrawPieCmd=DrawPieCmd;exports.DrawPolyCmd=DrawPolyCmd;exports.DrawRectCmd=DrawRectCmd;exports.DrawStyle=DrawStyle;exports.DrawTextureCmd=DrawTextureCmd;exports.DrawTexturesCmd=DrawTexturesCmd;exports.DrawTrianglesCmd=DrawTrianglesCmd;exports.Earcut=Earcut;exports.EarcutNode=EarcutNode;exports.Ease=Ease;exports.EffectAnimation=EffectAnimation;exports.EffectBase=EffectBase;exports.Event=Event;exports.EventDispatcher=EventDispatcher;exports.FadeIn=FadeIn;exports.FadeOut=FadeOut;exports.FillTextCmd=FillTextCmd;exports.FillTextureCmd=FillTextureCmd;exports.Filter=Filter;exports.FilterSetterBase=FilterSetterBase;exports.FontInfo=FontInfo;exports.FrameAnimation=FrameAnimation;exports.GlowFilter=GlowFilter;exports.GlowFilterGLRender=GlowFilterGLRender;exports.GlowFilterSetter=GlowFilterSetter;exports.GrahamScan=GrahamScan;exports.GraphicAnimation=GraphicAnimation;exports.Graphics=Graphics;exports.GraphicsBounds=GraphicsBounds;exports.HTMLCanvas=HTMLCanvas;exports.HTMLChar=HTMLChar;exports.HTMLImage=HTMLImage;exports.Handler=Handler;exports.HitArea=HitArea;exports.HttpRequest=HttpRequest;exports.ICharRender=ICharRender;exports.ILaya=ILaya;exports.IStatRender=IStatRender;exports.IndexBuffer2D=IndexBuffer2D;exports.InlcudeFile=InlcudeFile;exports.Input=Input;exports.KeyBoardManager=KeyBoardManager;exports.KeyLocation=KeyLocation;exports.Keyboard=Keyboard;exports.Laya=Laya;exports.LayaGL=LayaGL;exports.LayaGLQuickRunner=LayaGLQuickRunner;exports.LayaGLRunner=LayaGLRunner;exports.LayaGPU=LayaGPU;exports.Loader=Loader;exports.LoaderManager=LoaderManager;exports.LocalStorage=LocalStorage;exports.Log=Log;exports.MathUtil=MathUtil;exports.MatirxArray=MatirxArray;exports.Matrix=Matrix;exports.Mesh2D=Mesh2D;exports.MeshParticle2D=MeshParticle2D;exports.MeshQuadTexture=MeshQuadTexture;exports.MeshTexture=MeshTexture;exports.MeshVG=MeshVG;exports.Mouse=Mouse;exports.MouseManager=MouseManager;exports.Node=Node;exports.Path=Path;exports.PerfData=PerfData;exports.PerfHUD=PerfHUD;exports.Point=Point;exports.Pool=Pool;exports.PoolCache=PoolCache;exports.Prefab=Prefab;exports.PrimitiveSV=PrimitiveSV;exports.QuickTestTool=QuickTestTool;exports.Rectangle=Rectangle;exports.Render=Render;exports.RenderInfo=RenderInfo;exports.RenderSprite=RenderSprite;exports.RenderState2D=RenderState2D;exports.RenderTexture2D=RenderTexture2D;exports.Resource=Resource;exports.ResourceVersion=ResourceVersion;exports.RestoreCmd=RestoreCmd;exports.RotateCmd=RotateCmd;exports.RunDriver=RunDriver;exports.SaveBase=SaveBase;exports.SaveClipRect=SaveClipRect;exports.SaveCmd=SaveCmd;exports.SaveMark=SaveMark;exports.SaveTransform=SaveTransform;exports.SaveTranslate=SaveTranslate;exports.ScaleCmd=ScaleCmd;exports.Scene=Scene;exports.SceneLoader=SceneLoader;exports.SceneUtils=SceneUtils;exports.Script=Script;exports.Shader=Shader;exports.Shader2D=Shader2D;exports.Shader2X=Shader2X;exports.ShaderCompile=ShaderCompile;exports.ShaderDefines2D=ShaderDefines2D;exports.ShaderDefinesBase=ShaderDefinesBase;exports.ShaderNode=ShaderNode;exports.ShaderValue=ShaderValue;exports.SkinMeshBuffer=SkinMeshBuffer;exports.SkinSV=SkinSV;exports.Socket=Socket;exports.Sound=Sound;exports.SoundChannel=SoundChannel;exports.SoundManager=SoundManager;exports.SoundNode=SoundNode;exports.Sprite=Sprite;exports.SpriteConst=SpriteConst;exports.SpriteStyle=SpriteStyle;exports.Stage=Stage;exports.Stat=Stat;exports.StatUI=StatUI;exports.StringKey=StringKey;exports.Submit=Submit;exports.SubmitBase=SubmitBase;exports.SubmitCMD=SubmitCMD;exports.SubmitCanvas=SubmitCanvas;exports.SubmitKey=SubmitKey;exports.SubmitTarget=SubmitTarget;exports.SubmitTexture=SubmitTexture;exports.System=System;exports.TTFLoader=TTFLoader;exports.Text=Text;exports.TextAtlas=TextAtlas;exports.TextRender=TextRender;exports.TextStyle=TextStyle;exports.TextTexture=TextTexture;exports.Texture=Texture;exports.Texture2D=Texture2D;exports.TextureSV=TextureSV;exports.TimeLine=TimeLine;exports.Timer=Timer;exports.TouchManager=TouchManager;exports.TransformCmd=TransformCmd;exports.TranslateCmd=TranslateCmd;exports.Tween=Tween;exports.URL=URL;exports.Utils=Utils;exports.Value2D=Value2D;exports.VectorGraphManager=VectorGraphManager;exports.VertexArrayObject=VertexArrayObject;exports.VertexBuffer2D=VertexBuffer2D;exports.WeakObject=WeakObject;exports.WebAudioSound=WebAudioSound;exports.WebAudioSoundChannel=WebAudioSoundChannel;exports.WebGL=WebGL;exports.WebGLCacheAsNormalCanvas=WebGLCacheAsNormalCanvas;exports.WebGLContext=WebGLContext;exports.WebGLRTMgr=WebGLRTMgr;exports.WordText=WordText;exports.WorkerLoader=WorkerLoader;exports.__init=__init;exports._static=_static;exports.alertGlobalError=alertGlobalError;exports.enableDebugPanel=enableDebugPanel;exports.init=init;exports.isWXOpenDataContext=isWXOpenDataContext;exports.isWXPosMsg=isWXPosMsg;exports.version=version;exports.static=_static;return exports;}({});(function(exports,Laya){'use strict';var UIConfig=function UIConfig(){_classCallCheck(this,UIConfig);};UIConfig.touchScrollEnable=true;UIConfig.mouseWheelEnable=true;UIConfig.showButtons=true;UIConfig.popupBgColor="#000000";UIConfig.popupBgAlpha=0.5;UIConfig.closeDialogOnSide=true;window.UIConfig=UIConfig;var Styles=function Styles(){_classCallCheck(this,Styles);};Styles.defaultSizeGrid=[4,4,4,4,0];Styles.labelColor="#000000";Styles.labelPadding=[2,2,2,2];Styles.inputLabelPadding=[1,1,1,3];Styles.buttonStateNum=3;Styles.buttonLabelColors=["#32556b","#32cc6b","#ff0000","#C0C0C0"];Styles.comboBoxItemColors=["#5e95b6","#ffffff","#000000","#8fa4b1","#ffffff"];Styles.scrollBarMinNum=15;Styles.scrollBarDelayTime=500;var AutoBitmap=function(_Laya$Graphics){_inherits(AutoBitmap,_Laya$Graphics);function AutoBitmap(){_classCallCheck(this,AutoBitmap);var _this74=_possibleConstructorReturn(this,(AutoBitmap.__proto__||Object.getPrototypeOf(AutoBitmap)).apply(this,arguments));_this74.autoCacheCmd=true;_this74._width=0;_this74._height=0;_this74.uv=null;return _this74;}_createClass(AutoBitmap,[{key:"destroy",value:function destroy(){_get(AutoBitmap.prototype.__proto__||Object.getPrototypeOf(AutoBitmap.prototype),"destroy",this).call(this);this._source=null;this._sizeGrid=null;this._offset=null;}},{key:"_setChanged",value:function _setChanged(){if(!this._isChanged){this._isChanged=true;Laya.ILaya.timer.callLater(this,this.changeSource);}}},{key:"changeSource",value:function changeSource(){this._isChanged=false;var source=this._source;if(!source||!source.bitmap)return;var width=this.width;var height=this.height;var sizeGrid=this._sizeGrid;var sw=source.sourceWidth;var sh=source.sourceHeight;if(!sizeGrid||sw===width&&sh===height){this.clear();this.drawTexture(source,this._offset?this._offset[0]:0,this._offset?this._offset[1]:0,width,height,null,1,null,null,this.uv);}else{this.clear();this.draw9Grid(source,0,0,width,height,sizeGrid);this._repaint();return;}this._repaint();}},{key:"drawBitmap",value:function drawBitmap(repeat,tex,x,y){var width=arguments.length>4&&arguments[4]!==undefined?arguments[4]:0;var height=arguments.length>5&&arguments[5]!==undefined?arguments[5]:0;if(width<0.1||height<0.1)return;if(repeat&&(tex.width!=width||tex.height!=height))this.fillTexture(tex,x,y,width,height);else this.drawImage(tex,x,y,width,height);}},{key:"sizeGrid",get:function get(){return this._sizeGrid;},set:function set(value){this._sizeGrid=value.map(function(v){return+v;});this._setChanged();}},{key:"width",get:function get(){if(this._width)return this._width;if(this._source)return this._source.sourceWidth;return 0;},set:function set(value){if(this._width!=value){this._width=value;this._setChanged();}}},{key:"height",get:function get(){if(this._height)return this._height;if(this._source)return this._source.sourceHeight;return 0;},set:function set(value){if(this._height!=value){this._height=value;this._setChanged();}}},{key:"source",get:function get(){return this._source;},set:function set(value){if(value){this._source=value;this._setChanged();}else{this._source=null;this.clear();}}}],[{key:"getTexture",value:function getTexture(tex,x,y,width,height){if(width<=0)width=1;if(height<=0)height=1;tex.$_GID||(tex.$_GID=Laya.Utils.getGID());var texture;if(!texture||!texture._getSource()){texture=Laya.Texture.createFromTexture(tex,x,y,width,height);}return texture;}}]);return AutoBitmap;}(Laya.Graphics);Laya.ClassUtils.regClass("laya.ui.AutoBitmap",AutoBitmap);Laya.ClassUtils.regClass("Laya.AutoBitmap",AutoBitmap);var Widget=function(_Laya$Component){_inherits(Widget,_Laya$Component);function Widget(){_classCallCheck(this,Widget);var _this75=_possibleConstructorReturn(this,(Widget.__proto__||Object.getPrototypeOf(Widget)).apply(this,arguments));_this75._top=NaN;_this75._bottom=NaN;_this75._left=NaN;_this75._right=NaN;_this75._centerX=NaN;_this75._centerY=NaN;return _this75;}_createClass(Widget,[{key:"onReset",value:function onReset(){this._top=this._bottom=this._left=this._right=this._centerX=this._centerY=NaN;}},{key:"_onEnable",value:function _onEnable(){if(this.owner.parent)this._onAdded();else this.owner.once(Laya.Event.ADDED,this,this._onAdded);}},{key:"_onDisable",value:function _onDisable(){this.owner.off(Laya.Event.ADDED,this,this._onAdded);if(this.owner.parent)this.owner.parent.off(Laya.Event.RESIZE,this,this._onParentResize);}},{key:"_onAdded",value:function _onAdded(){if(this.owner.parent)this.owner.parent.on(Laya.Event.RESIZE,this,this._onParentResize);this.resetLayoutX();this.resetLayoutY();}},{key:"_onParentResize",value:function _onParentResize(){var flagX=this.resetLayoutX();var flagY=this.resetLayoutY();if(flagX||flagY)this.owner.event(Laya.Event.RESIZE);}},{key:"resetLayoutX",value:function resetLayoutX(){var owner=this.owner;if(!owner)return false;var parent=owner.parent;if(parent){if(!isNaN(this.centerX)){owner.x=Math.round((parent.width-owner.displayWidth)*0.5+this.centerX+owner.pivotX*owner.scaleX);}else if(!isNaN(this.left)){owner.x=Math.round(this.left+owner.pivotX*owner.scaleX);if(!isNaN(this.right)){var temp=(parent._width-this.left-this.right)/(owner.scaleX||0.01);if(temp!=owner.width){owner.width=temp;return true;}}}else if(!isNaN(this.right)){owner.x=Math.round(parent.width-owner.displayWidth-this.right+owner.pivotX*owner.scaleX);}}return false;}},{key:"resetLayoutY",value:function resetLayoutY(){var owner=this.owner;if(!owner)return false;var parent=owner.parent;if(parent){if(!isNaN(this.centerY)){owner.y=Math.round((parent.height-owner.displayHeight)*0.5+this.centerY+owner.pivotY*owner.scaleY);}else if(!isNaN(this.top)){owner.y=Math.round(this.top+owner.pivotY*owner.scaleY);if(!isNaN(this.bottom)){var temp=(parent._height-this.top-this.bottom)/(owner.scaleY||0.01);if(temp!=owner.height){owner.height=temp;return true;}}}else if(!isNaN(this.bottom)){owner.y=Math.round(parent.height-owner.displayHeight-this.bottom+owner.pivotY*owner.scaleY);}}return false;}},{key:"resetLayout",value:function resetLayout(){if(this.owner){this.resetLayoutX();this.resetLayoutY();}}},{key:"top",get:function get(){return this._top;},set:function set(value){if(this._top!=value){this._top=value;this.resetLayoutY();}}},{key:"bottom",get:function get(){return this._bottom;},set:function set(value){if(this._bottom!=value){this._bottom=value;this.resetLayoutY();}}},{key:"left",get:function get(){return this._left;},set:function set(value){if(this._left!=value){this._left=value;this.resetLayoutX();}}},{key:"right",get:function get(){return this._right;},set:function set(value){if(this._right!=value){this._right=value;this.resetLayoutX();}}},{key:"centerX",get:function get(){return this._centerX;},set:function set(value){if(this._centerX!=value){this._centerX=value;this.resetLayoutX();}}},{key:"centerY",get:function get(){return this._centerY;},set:function set(value){if(this._centerY!=value){this._centerY=value;this.resetLayoutY();}}}]);return Widget;}(Laya.Component);Widget.EMPTY=null;Laya.ILaya.regClass(Widget);Widget.EMPTY=new Widget();Laya.ClassUtils.regClass("laya.ui.Widget",Widget);Laya.ClassUtils.regClass("Laya.Widget",Widget);var UIEvent=function(_Laya$Event){_inherits(UIEvent,_Laya$Event);function UIEvent(){_classCallCheck(this,UIEvent);return _possibleConstructorReturn(this,(UIEvent.__proto__||Object.getPrototypeOf(UIEvent)).apply(this,arguments));}return UIEvent;}(Laya.Event);UIEvent.SHOW_TIP="showtip";UIEvent.HIDE_TIP="hidetip";Laya.ILaya.regClass(UIEvent);Laya.ClassUtils.regClass("laya.ui.UIEvent",UIEvent);Laya.ClassUtils.regClass("Laya.UIEvent",UIEvent);var UIUtils=function(){function UIUtils(){_classCallCheck(this,UIUtils);}_createClass(UIUtils,null,[{key:"fillArray",value:function fillArray(arr,str){var type=arguments.length>2&&arguments[2]!==undefined?arguments[2]:null;var temp=arr.concat();if(str){var a=str.split(",");for(var i=0,n=Math.min(temp.length,a.length);i<n;i++){var value=a[i];temp[i]=value=="true"?true:value=="false"?false:value;if(type!=null)temp[i]=type(value);}}return temp;}},{key:"toColor",value:function toColor(color){return Laya.Utils.toHexColor(color);}},{key:"gray",value:function gray(traget){var isGray=arguments.length>1&&arguments[1]!==undefined?arguments[1]:true;if(isGray){UIUtils.addFilter(traget,UIUtils.grayFilter);}else{UIUtils.clearFilter(traget,Laya.ColorFilter);}}},{key:"addFilter",value:function addFilter(target,filter){var filters=target.filters||[];filters.push(filter);target.filters=filters;}},{key:"clearFilter",value:function clearFilter(target,filterType){var filters=target.filters;if(filters!=null&&filters.length>0){for(var i=filters.length-1;i>-1;i--){var filter=filters[i];if(filter instanceof filterType)filters.splice(i,1);}target.filters=filters;}}},{key:"_getReplaceStr",value:function _getReplaceStr(word){return UIUtils.escapeSequence[word];}},{key:"adptString",value:function adptString(str){return str.replace(/\\(\w)/g,UIUtils._getReplaceStr);}},{key:"getBindFun",value:function getBindFun(value){if(!UIUtils._funMap){UIUtils._funMap=new Laya.WeakObject();}var fun=UIUtils._funMap.get(value);if(fun==null){var temp="\""+value+"\"";temp=temp.replace(/^"\${|}"$/g,"").replace(/\${/g,"\"+").replace(/}/g,"+\"");var str="(function(data){if(data==null)return;with(data){try{\nreturn "+temp+"\n}catch(e){}}})";fun=window.Laya._runScript(str);UIUtils._funMap.set(value,fun);}return fun;}}]);return UIUtils;}();UIUtils.grayFilter=new Laya.ColorFilter([0.3086,0.6094,0.082,0,0,0.3086,0.6094,0.082,0,0,0.3086,0.6094,0.082,0,0,0,0,0,1,0]);UIUtils.escapeSequence={"\\n":"\n","\\t":"\t"};UIUtils._funMap=null;Laya.ClassUtils.regClass("laya.ui.UIUtils",UIUtils);Laya.ClassUtils.regClass("Laya.UIUtils",UIUtils);var UIComponent=function(_Laya$Sprite){_inherits(UIComponent,_Laya$Sprite);function UIComponent(){var createChildren=arguments.length>0&&arguments[0]!==undefined?arguments[0]:true;_classCallCheck(this,UIComponent);var _this77=_possibleConstructorReturn(this,(UIComponent.__proto__||Object.getPrototypeOf(UIComponent)).call(this));_this77._anchorX=NaN;_this77._anchorY=NaN;_this77._widget=Widget.EMPTY;if(createChildren){_this77.preinitialize();_this77.createChildren();_this77.initialize();}return _this77;}_createClass(UIComponent,[{key:"destroy",value:function destroy(){var destroyChild=arguments.length>0&&arguments[0]!==undefined?arguments[0]:true;_get(UIComponent.prototype.__proto__||Object.getPrototypeOf(UIComponent.prototype),"destroy",this).call(this,destroyChild);this._dataSource=null;this._tag=null;this._toolTip=null;}},{key:"preinitialize",value:function preinitialize(){}},{key:"createChildren",value:function createChildren(){}},{key:"initialize",value:function initialize(){}},{key:"get_width",value:function get_width(){if(this._width)return this._width;return this.measureWidth();}},{key:"measureWidth",value:function measureWidth(){var max=0;this.commitMeasure();for(var i=this.numChildren-1;i>-1;i--){var comp=this.getChildAt(i);if(comp._visible){max=Math.max(comp._x+comp.width*comp.scaleX,max);}}return max;}},{key:"commitMeasure",value:function commitMeasure(){}},{key:"get_height",value:function get_height(){if(this._height)return this._height;return this.measureHeight();}},{key:"measureHeight",value:function measureHeight(){var max=0;this.commitMeasure();for(var i=this.numChildren-1;i>-1;i--){var comp=this.getChildAt(i);if(comp._visible){max=Math.max(comp._y+comp.height*comp.scaleY,max);}}return max;}},{key:"get_dataSource",value:function get_dataSource(){return this._dataSource;}},{key:"set_dataSource",value:function set_dataSource(value){this._dataSource=value;for(var prop in this._dataSource){if(prop in this&&!(typeof this[prop]=='function')){this[prop]=this._dataSource[prop];}}}},{key:"get_top",value:function get_top(){return this._widget.top;}},{key:"set_top",value:function set_top(value){if(value!=this._widget.top){this._getWidget().top=value;}}},{key:"get_bottom",value:function get_bottom(){return this._widget.bottom;}},{key:"set_bottom",value:function set_bottom(value){if(value!=this._widget.bottom){this._getWidget().bottom=value;}}},{key:"_sizeChanged",value:function _sizeChanged(){if(!isNaN(this._anchorX))this.pivotX=this.anchorX*this.width;if(!isNaN(this._anchorY))this.pivotY=this.anchorY*this.height;this.event(Laya.Event.RESIZE);if(this._widget!==Widget.EMPTY)this._widget.resetLayout();}},{key:"onMouseOver",value:function onMouseOver(e){Laya.ILaya.stage.event(UIEvent.SHOW_TIP,this._toolTip);}},{key:"onMouseOut",value:function onMouseOut(e){Laya.ILaya.stage.event(UIEvent.HIDE_TIP,this._toolTip);}},{key:"_getWidget",value:function _getWidget(){this._widget===Widget.EMPTY&&(this._widget=this.addComponent(Widget));return this._widget;}},{key:"set_scaleX",value:function set_scaleX(value){if(_get(UIComponent.prototype.__proto__||Object.getPrototypeOf(UIComponent.prototype),"get_scaleX",this).call(this)==value)return;_get(UIComponent.prototype.__proto__||Object.getPrototypeOf(UIComponent.prototype),"set_scaleX",this).call(this,value);this.event(Laya.Event.RESIZE);}},{key:"set_scaleY",value:function set_scaleY(value){if(_get(UIComponent.prototype.__proto__||Object.getPrototypeOf(UIComponent.prototype),"get_scaleY",this).call(this)==value)return;_get(UIComponent.prototype.__proto__||Object.getPrototypeOf(UIComponent.prototype),"set_scaleY",this).call(this,value);this.event(Laya.Event.RESIZE);}},{key:"onCompResize",value:function onCompResize(){this._sizeChanged();}},{key:"set_width",value:function set_width(value){if(_get(UIComponent.prototype.__proto__||Object.getPrototypeOf(UIComponent.prototype),"get_width",this).call(this)==value)return;_get(UIComponent.prototype.__proto__||Object.getPrototypeOf(UIComponent.prototype),"set_width",this).call(this,value);this.callLater(this._sizeChanged);}},{key:"set_height",value:function set_height(value){if(_get(UIComponent.prototype.__proto__||Object.getPrototypeOf(UIComponent.prototype),"get_height",this).call(this)==value)return;_get(UIComponent.prototype.__proto__||Object.getPrototypeOf(UIComponent.prototype),"set_height",this).call(this,value);this.callLater(this._sizeChanged);}},{key:"get_anchorX",value:function get_anchorX(){return this._anchorX;}},{key:"set_anchorX",value:function set_anchorX(value){if(this._anchorX!=value){this._anchorX=value;this.callLater(this._sizeChanged);}}},{key:"get_anchorY",value:function get_anchorY(){return this._anchorY;}},{key:"set_anchorY",value:function set_anchorY(value){if(this._anchorY!=value){this._anchorY=value;this.callLater(this._sizeChanged);}}},{key:"_childChanged",value:function _childChanged(){var child=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;this.callLater(this._sizeChanged);_get(UIComponent.prototype.__proto__||Object.getPrototypeOf(UIComponent.prototype),"_childChanged",this).call(this,child);}},{key:"width",get:function get(){return this.get_width();},set:function set(value){this.set_width(value);}},{key:"height",get:function get(){return this.get_height();},set:function set(value){this.set_height(value);}},{key:"dataSource",get:function get(){return this.get_dataSource();},set:function set(value){this.set_dataSource(value);}},{key:"top",get:function get(){return this.get_top();},set:function set(value){this.set_top(value);}},{key:"bottom",get:function get(){return this.get_bottom();},set:function set(value){this.set_bottom(value);}},{key:"left",get:function get(){return this._widget.left;},set:function set(value){if(value!=this._widget.left){this._getWidget().left=value;}}},{key:"right",get:function get(){return this._widget.right;},set:function set(value){if(value!=this._widget.right){this._getWidget().right=value;}}},{key:"centerX",get:function get(){return this._widget.centerX;},set:function set(value){if(value!=this._widget.centerX){this._getWidget().centerX=value;}}},{key:"centerY",get:function get(){return this._widget.centerY;},set:function set(value){if(value!=this._widget.centerY){this._getWidget().centerY=value;}}},{key:"tag",get:function get(){return this._tag;},set:function set(value){this._tag=value;}},{key:"toolTip",get:function get(){return this._toolTip;},set:function set(value){if(this._toolTip!=value){this._toolTip=value;if(value!=null){this.on(Laya.Event.MOUSE_OVER,this,this.onMouseOver);this.on(Laya.Event.MOUSE_OUT,this,this.onMouseOut);}else{this.off(Laya.Event.MOUSE_OVER,this,this.onMouseOver);this.off(Laya.Event.MOUSE_OUT,this,this.onMouseOut);}}}},{key:"gray",get:function get(){return this._gray;},set:function set(value){if(value!==this._gray){this._gray=value;UIUtils.gray(this,value);}}},{key:"disabled",get:function get(){return this._disabled;},set:function set(value){if(value!==this._disabled){this.gray=this._disabled=value;this.mouseEnabled=!value;}}},{key:"scaleX",set:function set(value){this.set_scaleX(value);},get:function get(){return _get(UIComponent.prototype.__proto__||Object.getPrototypeOf(UIComponent.prototype),"scaleX",this);}},{key:"scaleY",set:function set(value){this.set_scaleY(value);},get:function get(){return _get(UIComponent.prototype.__proto__||Object.getPrototypeOf(UIComponent.prototype),"scaleY",this);}},{key:"anchorX",get:function get(){return this.get_anchorX();},set:function set(value){this.set_anchorX(value);}},{key:"anchorY",get:function get(){return this.get_anchorY();},set:function set(value){this.set_anchorY(value);}}]);return UIComponent;}(Laya.Sprite);Laya.ILaya.regClass(UIComponent);Laya.ClassUtils.regClass("laya.ui.UIComponent",UIComponent);Laya.ClassUtils.regClass("Laya.UIComponent",UIComponent);var Image=function(_UIComponent){_inherits(Image,_UIComponent);function Image(){var skin=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;_classCallCheck(this,Image);var _this78=_possibleConstructorReturn(this,(Image.__proto__||Object.getPrototypeOf(Image)).call(this));_this78.skin=skin;return _this78;}_createClass(Image,[{key:"destroy",value:function destroy(){var destroyChild=arguments.length>0&&arguments[0]!==undefined?arguments[0]:true;_get(Image.prototype.__proto__||Object.getPrototypeOf(Image.prototype),"destroy",this).call(this,true);this._bitmap&&this._bitmap.destroy();this._bitmap=null;}},{key:"dispose",value:function dispose(){this.destroy(true);Laya.ILaya.loader.clearRes(this._skin);}},{key:"createChildren",value:function createChildren(){this.graphics=this._bitmap=new AutoBitmap();this._bitmap.autoCacheCmd=false;}},{key:"setSource",value:function setSource(url){var img=arguments.length>1&&arguments[1]!==undefined?arguments[1]:null;if(url===this._skin&&img){this.source=img;this.onCompResize();}}},{key:"measureWidth",value:function measureWidth(){return this._bitmap.width;}},{key:"measureHeight",value:function measureHeight(){return this._bitmap.height;}},{key:"skin",get:function get(){return this._skin;},set:function set(value){if(this._skin!=value){this._skin=value;if(value){var source=Laya.Loader.getRes(value);if(source){this.source=source;this.onCompResize();}else Laya.ILaya.loader.load(this._skin,Laya.Handler.create(this,this.setSource,[this._skin]),null,Laya.Loader.IMAGE,1,true,this._group);}else{this.source=null;}}}},{key:"source",get:function get(){return this._bitmap.source;},set:function set(value){if(!this._bitmap)return;this._bitmap.source=value;this.event(Laya.Event.LOADED);this.repaint();}},{key:"group",get:function get(){return this._group;},set:function set(value){if(value&&this._skin)Laya.Loader.setGroup(this._skin,value);this._group=value;}},{key:"width",set:function set(value){_set(Image.prototype.__proto__||Object.getPrototypeOf(Image.prototype),"width",value,this);this._bitmap.width=value==0?0.0000001:value;},get:function get(){return _get(Image.prototype.__proto__||Object.getPrototypeOf(Image.prototype),"width",this);}},{key:"height",set:function set(value){_set(Image.prototype.__proto__||Object.getPrototypeOf(Image.prototype),"height",value,this);this._bitmap.height=value==0?0.0000001:value;},get:function get(){return _get(Image.prototype.__proto__||Object.getPrototypeOf(Image.prototype),"height",this);}},{key:"sizeGrid",get:function get(){if(this._bitmap.sizeGrid)return this._bitmap.sizeGrid.join(",");return null;},set:function set(value){this._bitmap.sizeGrid=UIUtils.fillArray(Styles.defaultSizeGrid,value,Number);}},{key:"dataSource",set:function set(value){this._dataSource=value;if(typeof value=='string')this.skin=value;else _set(Image.prototype.__proto__||Object.getPrototypeOf(Image.prototype),"dataSource",value,this);},get:function get(){return _get(Image.prototype.__proto__||Object.getPrototypeOf(Image.prototype),"dataSource",this);}}]);return Image;}(UIComponent);Laya.ILaya.regClass(Image);Laya.ClassUtils.regClass("laya.ui.Image",Image);Laya.ClassUtils.regClass("Laya.Image",Image);var AdvImage=function(_Image){_inherits(AdvImage,_Image);function AdvImage(){var skin=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;_classCallCheck(this,AdvImage);var _this79=_possibleConstructorReturn(this,(AdvImage.__proto__||Object.getPrototypeOf(AdvImage)).call(this));_this79.advsListArr=[];_this79.resUrl="https://unioncdn.layabox.com/config/iconlist.json";_this79._http=new Laya.Browser.window.XMLHttpRequest();_this79._data=[];_this79._resquestTime=360000;_this79._playIndex=0;_this79._lunboTime=5000;_this79.skin=skin;_this79.setLoadUrl();_this79.init();_this79.size(120,120);return _this79;}_createClass(AdvImage,[{key:"setLoadUrl",value:function setLoadUrl(){}},{key:"init",value:function init(){if(this.isSupportJump()){if(Laya.Browser.onMiniGame||Laya.Browser.onBDMiniGame){Laya.ILaya.timer.loop(this._resquestTime,this,this.onGetAdvsListData);}this.onGetAdvsListData();this.initEvent();}else this.visible=false;}},{key:"initEvent",value:function initEvent(){this.on(Laya.Event.CLICK,this,this.onAdvsImgClick);}},{key:"onAdvsImgClick",value:function onAdvsImgClick(){var currentJumpUrl=this.getCurrentAppidObj();if(currentJumpUrl)this.jumptoGame();}},{key:"revertAdvsData",value:function revertAdvsData(){if(this.advsListArr[this._playIndex]){this.visible=true;this.skin=this.advsListArr[this._playIndex];}}},{key:"isSupportJump",value:function isSupportJump(){if(Laya.Browser.onMiniGame){var isSupperJump=window.wx.navigateToMiniProgram instanceof Function;return isSupperJump;}else if(Laya.Browser.onBDMiniGame)return true;return false;}},{key:"jumptoGame",value:function jumptoGame(){var advsObj=this.advsListArr[this._playIndex];var desGameId=parseInt(advsObj.gameid);var extendInfo=advsObj.extendInfo;var path=advsObj.path;if(Laya.Browser.onMiniGame){if(this.isSupportJump()){window.wx.navigateToMiniProgram({appId:this._appid,path:"",extraData:"",envVersion:"release",success:function success(){console.log("---------------------------");},fail:function fail(){console.log("---------------------------");},complete:function complete(){console.log("---------------------------");this.updateAdvsInfo();}.bind(this)});}}else if(Laya.Browser.onBDMiniGame);else{this.visible=false;}}},{key:"updateAdvsInfo",value:function updateAdvsInfo(){this.visible=false;this.onLunbo();Laya.ILaya.timer.loop(this._lunboTime,this,this.onLunbo);}},{key:"onLunbo",value:function onLunbo(){if(this._playIndex>=this.advsListArr.length-1)this._playIndex=0;else this._playIndex+=1;this.visible=true;this.revertAdvsData();}},{key:"getCurrentAppidObj",value:function getCurrentAppidObj(){return this.advsListArr[this._playIndex];}},{key:"onGetAdvsListData",value:function onGetAdvsListData(){var _this=this;var random=AdvImage.randRange(10000,1000000);var url=this.resUrl+"?"+random;this._http.open("get",url,true);this._http.setRequestHeader("Content-Type","application/x-www-form-urlencoded");this._http.responseType="text";this._http.onerror=function(e){_this._onError(e);};this._http.onload=function(e){_this._onLoad(e);};this._http.send(null);}},{key:"_onError",value:function _onError(e){this.error("Request failed Status:"+this._http.status+" text:"+this._http.statusText);}},{key:"_onLoad",value:function _onLoad(e){var http=this._http;var status=http.status!==undefined?http.status:200;if(status===200||status===204||status===0){this.complete();}else{this.error("["+http.status+"]"+http.statusText+":"+http.responseURL);}}},{key:"error",value:function error(message){this.event(Laya.Event.ERROR,message);}},{key:"complete",value:function complete(){try{this._data=this._http.response||this._http.responseText;this._data=JSON.parse(this._data);this.advsListArr=this._data.list;this._appid=this._data.appid;this.updateAdvsInfo();this.revertAdvsData();}catch(e){this.error(e.message);}}},{key:"getAdvsQArr",value:function getAdvsQArr(data){var tempArr=[];var gameAdvsObj=Laya.LocalStorage.getJSON("gameObj");for(var key in data){var tempObj=data[key];if(gameAdvsObj&&gameAdvsObj[tempObj.gameid]&&!tempObj.isQiangZhi)continue;tempArr.push(tempObj);}return tempArr;}},{key:"clear",value:function clear(){var http=this._http;http.onerror=http.onabort=http.onprogress=http.onload=null;}},{key:"destroy",value:function destroy(){var destroyChild=arguments.length>0&&arguments[0]!==undefined?arguments[0]:true;Laya.ILaya.timer.clear(this,this.onLunbo);_get(AdvImage.prototype.__proto__||Object.getPrototypeOf(AdvImage.prototype),"destroy",this).call(this,true);this.clear();Laya.ILaya.timer.clear(this,this.onGetAdvsListData);}}],[{key:"randRange",value:function randRange(minNum,maxNum){return Math.floor(Math.random()*(maxNum-minNum+1))+minNum;}}]);return AdvImage;}(Image);Laya.ClassUtils.regClass("laya.ui.AdvImage",AdvImage);Laya.ClassUtils.regClass("Laya.AdvImage",AdvImage);var Box=function(_UIComponent2){_inherits(Box,_UIComponent2);function Box(){_classCallCheck(this,Box);return _possibleConstructorReturn(this,(Box.__proto__||Object.getPrototypeOf(Box)).apply(this,arguments));}_createClass(Box,[{key:"_onResize",value:function _onResize(e){this.graphics.clear();this.graphics.drawRect(0,0,this.width,this.height,this._bgColor);}},{key:"dataSource",set:function set(value){this._dataSource=value;for(var name in value){var comp=this.getChildByName(name);if(comp)comp.dataSource=value[name];else if(name in this&&!(this[name]instanceof Function))this[name]=value[name];}},get:function get(){return _get(Box.prototype.__proto__||Object.getPrototypeOf(Box.prototype),"dataSource",this);}},{key:"bgColor",get:function get(){return this._bgColor;},set:function set(value){this._bgColor=value;if(value){this._onResize(null);this.on(Laya.Event.RESIZE,this,this._onResize);}else{this.graphics.clear();this.off(Laya.Event.RESIZE,this,this._onResize);}}}]);return Box;}(UIComponent);Laya.ILaya.regClass(Box);Laya.ClassUtils.regClass("laya.ui.Box",Box);Laya.ClassUtils.regClass("Laya.Box",Box);var Button=function(_UIComponent3){_inherits(Button,_UIComponent3);function Button(){var skin=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;var label=arguments.length>1&&arguments[1]!==undefined?arguments[1]:"";_classCallCheck(this,Button);var _this81=_possibleConstructorReturn(this,(Button.__proto__||Object.getPrototypeOf(Button)).call(this));_this81._labelColors=Styles.buttonLabelColors;_this81._state=0;_this81._autoSize=true;_this81._stateNum=Styles.buttonStateNum;_this81._stateChanged=false;_this81.skin=skin;_this81.label=label;return _this81;}_createClass(Button,[{key:"destroy",value:function destroy(){var destroyChild=arguments.length>0&&arguments[0]!==undefined?arguments[0]:true;_get(Button.prototype.__proto__||Object.getPrototypeOf(Button.prototype),"destroy",this).call(this,destroyChild);this._bitmap&&this._bitmap.destroy();this._text&&this._text.destroy(destroyChild);this._bitmap=null;this._text=null;this._clickHandler=null;this._labelColors=this._sources=this._strokeColors=null;}},{key:"createChildren",value:function createChildren(){this.graphics=this._bitmap=new AutoBitmap();}},{key:"createText",value:function createText(){if(!this._text){this._text=new Laya.Text();this._text.overflow=Laya.Text.HIDDEN;this._text.align="center";this._text.valign="middle";this._text.width=this._width;this._text.height=this._height;}}},{key:"initialize",value:function initialize(){if(this._mouseState!==1){this.mouseEnabled=true;this._setBit(Laya.Const.HAS_MOUSE,true);}this._createListener(Laya.Event.MOUSE_OVER,this,this.onMouse,null,false,false);this._createListener(Laya.Event.MOUSE_OUT,this,this.onMouse,null,false,false);this._createListener(Laya.Event.MOUSE_DOWN,this,this.onMouse,null,false,false);this._createListener(Laya.Event.MOUSE_UP,this,this.onMouse,null,false,false);this._createListener(Laya.Event.CLICK,this,this.onMouse,null,false,false);}},{key:"onMouse",value:function onMouse(e){if(this.toggle===false&&this._selected)return;if(e.type===Laya.Event.CLICK){this.toggle&&(this.selected=!this._selected);this._clickHandler&&this._clickHandler.run();return;}!this._selected&&(this.state=Button.stateMap[e.type]);}},{key:"_skinLoaded",value:function _skinLoaded(){this.callLater(this.changeClips);this._setStateChanged();this._sizeChanged();this.event(Laya.Event.LOADED);}},{key:"changeClips",value:function changeClips(){var img=Laya.Loader.getRes(this._skin);if(!img){console.log("lose skin",this._skin);return;}var width=img.sourceWidth;var height=img.sourceHeight/this._stateNum;img.$_GID||(img.$_GID=Laya.Utils.getGID());var key=img.$_GID+"-"+this._stateNum;var clips=Laya.WeakObject.I.get(key);if(!Laya.Utils.isOkTextureList(clips)){clips=null;}if(clips)this._sources=clips;else{this._sources=[];if(this._stateNum===1){this._sources.push(img);}else{for(var i=0;i<this._stateNum;i++){this._sources.push(Laya.Texture.createFromTexture(img,0,height*i,width,height));}}Laya.WeakObject.I.set(key,this._sources);}if(this._autoSize){this._bitmap.width=this._width||width;this._bitmap.height=this._height||height;if(this._text){this._text.width=this._bitmap.width;this._text.height=this._bitmap.height;}}else{this._text&&(this._text.x=width);}}},{key:"measureWidth",value:function measureWidth(){this.runCallLater(this.changeClips);if(this._autoSize)return this._bitmap.width;this.runCallLater(this.changeState);return this._bitmap.width+(this._text?this._text.width:0);}},{key:"measureHeight",value:function measureHeight(){this.runCallLater(this.changeClips);return this._text?Math.max(this._bitmap.height,this._text.height):this._bitmap.height;}},{key:"changeState",value:function changeState(){this._stateChanged=false;this.runCallLater(this.changeClips);var index=this._state<this._stateNum?this._state:this._stateNum-1;this._sources&&(this._bitmap.source=this._sources[index]);if(this.label){this._text.color=this._labelColors[index];if(this._strokeColors)this._text.strokeColor=this._strokeColors[index];}}},{key:"_setStateChanged",value:function _setStateChanged(){if(!this._stateChanged){this._stateChanged=true;this.callLater(this.changeState);}}},{key:"skin",get:function get(){return this._skin;},set:function set(value){if(this._skin!=value){this._skin=value;if(value){if(!Laya.Loader.getRes(value)){Laya.ILaya.loader.load(this._skin,Laya.Handler.create(this,this._skinLoaded),null,Laya.Loader.IMAGE,1);}else{this._skinLoaded();}}else{this._skinLoaded();}}}},{key:"stateNum",get:function get(){return this._stateNum;},set:function set(value){if(typeof value=='string'){value=parseInt(value);}if(this._stateNum!=value){this._stateNum=value<1?1:value>3?3:value;this.callLater(this.changeClips);}}},{key:"label",get:function get(){return this._text?this._text.text:null;},set:function set(value){if(!this._text&&!value)return;this.createText();if(this._text.text!=value){value&&!this._text.parent&&this.addChild(this._text);this._text.text=(value+"").replace(/\\n/g,"\n");this._setStateChanged();}}},{key:"selected",get:function get(){return this._selected;},set:function set(value){if(this._selected!=value){this._selected=value;this.state=this._selected?2:0;this.event(Laya.Event.CHANGE);}}},{key:"state",get:function get(){return this._state;},set:function set(value){if(this._state!=value){this._state=value;this._setStateChanged();}}},{key:"labelColors",get:function get(){return this._labelColors.join(",");},set:function set(value){this._labelColors=UIUtils.fillArray(Styles.buttonLabelColors,value,String);this._setStateChanged();}},{key:"strokeColors",get:function get(){return this._strokeColors?this._strokeColors.join(","):"";},set:function set(value){this._strokeColors=UIUtils.fillArray(Styles.buttonLabelColors,value,String);this._setStateChanged();}},{key:"labelPadding",get:function get(){this.createText();return this._text.padding.join(",");},set:function set(value){this.createText();this._text.padding=UIUtils.fillArray(Styles.labelPadding,value,Number);}},{key:"labelSize",get:function get(){this.createText();return this._text.fontSize;},set:function set(value){this.createText();this._text.fontSize=value;}},{key:"labelStroke",get:function get(){this.createText();return this._text.stroke;},set:function set(value){this.createText();this._text.stroke=value;}},{key:"labelStrokeColor",get:function get(){this.createText();return this._text.strokeColor;},set:function set(value){this.createText();this._text.strokeColor=value;}},{key:"labelBold",get:function get(){this.createText();return this._text.bold;},set:function set(value){this.createText();this._text.bold=value;}},{key:"labelFont",get:function get(){this.createText();return this._text.font;},set:function set(value){this.createText();this._text.font=value;}},{key:"labelAlign",get:function get(){this.createText();return this._text.align;},set:function set(value){this.createText();this._text.align=value;}},{key:"clickHandler",get:function get(){return this._clickHandler;},set:function set(value){this._clickHandler=value;}},{key:"text",get:function get(){this.createText();return this._text;}},{key:"sizeGrid",get:function get(){if(this._bitmap.sizeGrid)return this._bitmap.sizeGrid.join(",");return null;},set:function set(value){this._bitmap.sizeGrid=UIUtils.fillArray(Styles.defaultSizeGrid,value,Number);}},{key:"width",set:function set(value){_get(Button.prototype.__proto__||Object.getPrototypeOf(Button.prototype),"set_width",this).call(this,value);if(this._autoSize){this._bitmap.width=value;this._text&&(this._text.width=value);}},get:function get(){return _get(Button.prototype.__proto__||Object.getPrototypeOf(Button.prototype),"get_width",this).call(this);}},{key:"height",set:function set(value){_get(Button.prototype.__proto__||Object.getPrototypeOf(Button.prototype),"set_height",this).call(this,value);if(this._autoSize){this._bitmap.height=value;this._text&&(this._text.height=value);}},get:function get(){return _get(Button.prototype.__proto__||Object.getPrototypeOf(Button.prototype),"get_height",this).call(this);}},{key:"dataSource",set:function set(value){this._dataSource=value;if(typeof value=='number'||typeof value=='string')this.label=value+"";else _get(Button.prototype.__proto__||Object.getPrototypeOf(Button.prototype),"set_dataSource",this).call(this,value);},get:function get(){return _get(Button.prototype.__proto__||Object.getPrototypeOf(Button.prototype),"get_dataSource",this).call(this);}},{key:"iconOffset",get:function get(){return this._bitmap._offset?this._bitmap._offset.join(","):null;},set:function set(value){if(value)this._bitmap._offset=UIUtils.fillArray([1,1],value,Number);else this._bitmap._offset=[];}}]);return Button;}(UIComponent);Button.stateMap={"mouseup":0,"mouseover":1,"mousedown":2,"mouseout":0};Laya.ILaya.regClass(Button);Laya.ClassUtils.regClass("laya.ui.Button",Button);Laya.ClassUtils.regClass("Laya.Button",Button);var CheckBox=function(_Button){_inherits(CheckBox,_Button);function CheckBox(){var skin=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;var label=arguments.length>1&&arguments[1]!==undefined?arguments[1]:"";_classCallCheck(this,CheckBox);var _this82=_possibleConstructorReturn(this,(CheckBox.__proto__||Object.getPrototypeOf(CheckBox)).call(this,skin,label));_this82.toggle=true;_this82._autoSize=false;return _this82;}_createClass(CheckBox,[{key:"preinitialize",value:function preinitialize(){_get(CheckBox.prototype.__proto__||Object.getPrototypeOf(CheckBox.prototype),"preinitialize",this).call(this);this.toggle=true;this._autoSize=false;}},{key:"initialize",value:function initialize(){_get(CheckBox.prototype.__proto__||Object.getPrototypeOf(CheckBox.prototype),"initialize",this).call(this);this.createText();this._text.align="left";this._text.valign="top";this._text.width=0;}},{key:"dataSource",set:function set(value){this._dataSource=value;if(value instanceof Boolean)this.selected=value;else if(typeof value=='string')this.selected=value==="true";else _set(CheckBox.prototype.__proto__||Object.getPrototypeOf(CheckBox.prototype),"dataSource",value,this);},get:function get(){return _get(CheckBox.prototype.__proto__||Object.getPrototypeOf(CheckBox.prototype),"dataSource",this);}}]);return CheckBox;}(Button);Laya.ILaya.regClass(CheckBox);Laya.ClassUtils.regClass("laya.ui.CheckBox",CheckBox);Laya.ClassUtils.regClass("Laya.CheckBox",CheckBox);var Clip=function(_UIComponent4){_inherits(Clip,_UIComponent4);function Clip(){var url=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;var clipX=arguments.length>1&&arguments[1]!==undefined?arguments[1]:1;var clipY=arguments.length>2&&arguments[2]!==undefined?arguments[2]:1;_classCallCheck(this,Clip);var _this83=_possibleConstructorReturn(this,(Clip.__proto__||Object.getPrototypeOf(Clip)).call(this));_this83._clipX=1;_this83._clipY=1;_this83._clipWidth=0;_this83._clipHeight=0;_this83._interval=50;_this83._index=0;_this83._toIndex=-1;_this83._clipX=clipX;_this83._clipY=clipY;_this83.skin=url;return _this83;}_createClass(Clip,[{key:"destroy",value:function destroy(){var destroyChild=arguments.length>0&&arguments[0]!==undefined?arguments[0]:true;_get(Clip.prototype.__proto__||Object.getPrototypeOf(Clip.prototype),"destroy",this).call(this,true);this._bitmap&&this._bitmap.destroy();this._bitmap=null;this._sources=null;}},{key:"dispose",value:function dispose(){this.destroy(true);Laya.ILaya.loader.clearRes(this._skin);}},{key:"createChildren",value:function createChildren(){this.graphics=this._bitmap=new AutoBitmap();}},{key:"_onDisplay",value:function _onDisplay(e){if(this._isPlaying){if(this._getBit(Laya.Const.DISPLAYED_INSTAGE))this.play();else this.stop();}else if(this._autoPlay){this.play();}}},{key:"_skinLoaded",value:function _skinLoaded(){this._setClipChanged();this._sizeChanged();this.event(Laya.Event.LOADED);}},{key:"changeClip",value:function changeClip(){this._clipChanged=false;if(!this._skin)return;var img=Laya.Loader.getRes(this._skin);if(img){this.loadComplete(this._skin,img);}else{Laya.ILaya.loader.load(this._skin,Laya.Handler.create(this,this.loadComplete,[this._skin]));}}},{key:"loadComplete",value:function loadComplete(url,img){if(url===this._skin&&img){var w=this._clipWidth||Math.ceil(img.sourceWidth/this._clipX);var h=this._clipHeight||Math.ceil(img.sourceHeight/this._clipY);var key=this._skin+w+h;var clips=Laya.WeakObject.I.get(key);if(!Laya.Utils.isOkTextureList(clips)){clips=null;}if(clips)this._sources=clips;else{this._sources=[];for(var i=0;i<this._clipY;i++){for(var j=0;j<this._clipX;j++){this._sources.push(Laya.Texture.createFromTexture(img,w*j,h*i,w,h));}}Laya.WeakObject.I.set(key,this._sources);}this.index=this._index;this.event(Laya.Event.LOADED);this.onCompResize();}}},{key:"measureWidth",value:function measureWidth(){this.runCallLater(this.changeClip);return this._bitmap.width;}},{key:"measureHeight",value:function measureHeight(){this.runCallLater(this.changeClip);return this._bitmap.height;}},{key:"play",value:function play(){var from=arguments.length>0&&arguments[0]!==undefined?arguments[0]:0;var to=arguments.length>1&&arguments[1]!==undefined?arguments[1]:-1;this._isPlaying=true;this.index=from;this._toIndex=to;this._index++;Laya.ILaya.timer.loop(this.interval,this,this._loop);this.on(Laya.Event.DISPLAY,this,this._onDisplay);this.on(Laya.Event.UNDISPLAY,this,this._onDisplay);}},{key:"_loop",value:function _loop(){if(this._visible&&this._sources){this._index++;if(this._toIndex>-1&&this._index>=this._toIndex)this.stop();else if(this._index>=this._sources.length)this._index=0;this.index=this._index;}}},{key:"stop",value:function stop(){this._isPlaying=false;Laya.ILaya.timer.clear(this,this._loop);this.event(Laya.Event.COMPLETE);}},{key:"_setClipChanged",value:function _setClipChanged(){if(!this._clipChanged){this._clipChanged=true;this.callLater(this.changeClip);}}},{key:"skin",get:function get(){return this._skin;},set:function set(value){if(this._skin!=value){this._skin=value;if(value){if(!Laya.Loader.getRes(value)){Laya.ILaya.loader.load(this._skin,Laya.Handler.create(this,this._skinLoaded),null,Laya.Loader.IMAGE,1);}else{this._skinLoaded();}}else{this._bitmap.source=null;}}}},{key:"clipX",get:function get(){return this._clipX;},set:function set(value){this._clipX=value||1;this._setClipChanged();}},{key:"clipY",get:function get(){return this._clipY;},set:function set(value){this._clipY=value||1;this._setClipChanged();}},{key:"clipWidth",get:function get(){return this._clipWidth;},set:function set(value){this._clipWidth=value;this._setClipChanged();}},{key:"clipHeight",get:function get(){return this._clipHeight;},set:function set(value){this._clipHeight=value;this._setClipChanged();}},{key:"sources",get:function get(){return this._sources;},set:function set(value){this._sources=value;this.index=this._index;this.event(Laya.Event.LOADED);}},{key:"group",get:function get(){return this._group;},set:function set(value){if(value&&this._skin)Laya.Loader.setGroup(this._skin,value);this._group=value;}},{key:"width",set:function set(value){_set(Clip.prototype.__proto__||Object.getPrototypeOf(Clip.prototype),"width",value,this);this._bitmap.width=value;},get:function get(){return _get(Clip.prototype.__proto__||Object.getPrototypeOf(Clip.prototype),"width",this);}},{key:"height",set:function set(value){_set(Clip.prototype.__proto__||Object.getPrototypeOf(Clip.prototype),"height",value,this);this._bitmap.height=value;},get:function get(){return _get(Clip.prototype.__proto__||Object.getPrototypeOf(Clip.prototype),"height",this);}},{key:"sizeGrid",get:function get(){if(this._bitmap.sizeGrid)return this._bitmap.sizeGrid.join(",");return null;},set:function set(value){this._bitmap.sizeGrid=UIUtils.fillArray(Styles.defaultSizeGrid,value,Number);}},{key:"index",get:function get(){return this._index;},set:function set(value){this._index=value;this._bitmap&&this._sources&&(this._bitmap.source=this._sources[value]);this.event(Laya.Event.CHANGE);}},{key:"total",get:function get(){this.runCallLater(this.changeClip);return this._sources?this._sources.length:0;}},{key:"autoPlay",get:function get(){return this._autoPlay;},set:function set(value){if(this._autoPlay!=value){this._autoPlay=value;value?this.play():this.stop();}}},{key:"interval",get:function get(){return this._interval;},set:function set(value){if(this._interval!=value){this._interval=value;if(this._isPlaying)this.play();}}},{key:"isPlaying",get:function get(){return this._isPlaying;},set:function set(value){this._isPlaying=value;}},{key:"dataSource",set:function set(value){this._dataSource=value;if(typeof value=='number'||typeof value=='string')this.index=parseInt(value);else _set(Clip.prototype.__proto__||Object.getPrototypeOf(Clip.prototype),"dataSource",value,this);},get:function get(){return _get(Clip.prototype.__proto__||Object.getPrototypeOf(Clip.prototype),"dataSource",this);}},{key:"bitmap",get:function get(){return this._bitmap;}}]);return Clip;}(UIComponent);Laya.ILaya.regClass(Clip);Laya.ClassUtils.regClass("laya.ui.Clip",Clip);Laya.ClassUtils.regClass("Laya.Clip",Clip);var ColorPicker=function(_UIComponent5){_inherits(ColorPicker,_UIComponent5);function ColorPicker(){_classCallCheck(this,ColorPicker);var _this84=_possibleConstructorReturn(this,(ColorPicker.__proto__||Object.getPrototypeOf(ColorPicker)).apply(this,arguments));_this84._gridSize=11;_this84._bgColor="#ffffff";_this84._borderColor="#000000";_this84._inputColor="#000000";_this84._inputBgColor="#efefef";_this84._colors=[];_this84._selectedColor="#000000";return _this84;}_createClass(ColorPicker,[{key:"destroy",value:function destroy(){var destroyChild=arguments.length>0&&arguments[0]!==undefined?arguments[0]:true;_get(ColorPicker.prototype.__proto__||Object.getPrototypeOf(ColorPicker.prototype),"destroy",this).call(this,destroyChild);this._colorPanel&&this._colorPanel.destroy(destroyChild);this._colorButton&&this._colorButton.destroy(destroyChild);this._colorPanel=null;this._colorTiles=null;this._colorBlock=null;this._colorInput=null;this._colorButton=null;this._colors=null;this.changeHandler=null;}},{key:"createChildren",value:function createChildren(){this.addChild(this._colorButton=new Button());this._colorPanel=new Box();this._colorPanel.size(230,166);this._colorPanel.addChild(this._colorTiles=new Laya.Sprite());this._colorPanel.addChild(this._colorBlock=new Laya.Sprite());this._colorPanel.addChild(this._colorInput=new Laya.Input());}},{key:"initialize",value:function initialize(){this._colorButton.on(Laya.Event.CLICK,this,this.onColorButtonClick);this._colorBlock.pos(5,5);this._colorInput.pos(60,5);this._colorInput.size(60,20);this._colorInput.on(Laya.Event.CHANGE,this,this.onColorInputChange);this._colorInput.on(Laya.Event.KEY_DOWN,this,this.onColorFieldKeyDown);this._colorTiles.pos(5,30);this._colorTiles.on(Laya.Event.MOUSE_MOVE,this,this.onColorTilesMouseMove);this._colorTiles.on(Laya.Event.CLICK,this,this.onColorTilesClick);this._colorTiles.size(20*this._gridSize,12*this._gridSize);this._colorPanel.on(Laya.Event.MOUSE_DOWN,this,this.onPanelMouseDown);this.bgColor=this._bgColor;}},{key:"onPanelMouseDown",value:function onPanelMouseDown(e){e.stopPropagation();}},{key:"changePanel",value:function changePanel(){this._panelChanged=false;var g=this._colorPanel.graphics;g.clear(true);g.drawRect(0,0,230,166,this._bgColor,this._borderColor);this.drawBlock(this._selectedColor);this._colorInput.borderColor=this._borderColor;this._colorInput.bgColor=this._inputBgColor;this._colorInput.color=this._inputColor;g=this._colorTiles.graphics;g.clear(true);var mainColors=[0x000000,0x333333,0x666666,0x999999,0xCCCCCC,0xFFFFFF,0xFF0000,0x00FF00,0x0000FF,0xFFFF00,0x00FFFF,0xFF00FF];for(var i=0;i<12;i++){for(var j=0;j<20;j++){var color;if(j===0)color=mainColors[i];else if(j===1)color=0x000000;else color=(((i*3+j/6)%3<<0)+(i/6<<0)*3)*0x33<<16|j%6*0x33<<8|(i<<0)%6*0x33;var strColor=UIUtils.toColor(color);this._colors.push(strColor);var x=j*this._gridSize;var y=i*this._gridSize;g.drawRect(x,y,this._gridSize,this._gridSize,strColor,"#000000");}}}},{key:"onColorButtonClick",value:function onColorButtonClick(e){if(this._colorPanel.parent)this.close();else this.open();}},{key:"open",value:function open(){var stage=Laya.ILaya.stage;var p=this.localToGlobal(new Laya.Point());var px=p.x+this._colorPanel.width<=stage.width?p.x:stage.width-this._colorPanel.width;var py=p.y+this._colorButton.height;py=py+this._colorPanel.height<=stage.height?py:p.y-this._colorPanel.height;this._colorPanel.pos(px,py);this._colorPanel.zOrder=1001;stage.addChild(this._colorPanel);stage.on(Laya.Event.MOUSE_DOWN,this,this.removeColorBox);}},{key:"close",value:function close(){Laya.ILaya.stage.off(Laya.Event.MOUSE_DOWN,this,this.removeColorBox);this._colorPanel.removeSelf();}},{key:"removeColorBox",value:function removeColorBox(){var e=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;this.close();}},{key:"onColorFieldKeyDown",value:function onColorFieldKeyDown(e){if(e.keyCode==13){if(this._colorInput.text)this.selectedColor=this._colorInput.text;else this.selectedColor=null;this.close();e.stopPropagation();}}},{key:"onColorInputChange",value:function onColorInputChange(){var e=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;if(this._colorInput.text)this.drawBlock(this._colorInput.text);else this.drawBlock("#FFFFFF");}},{key:"onColorTilesClick",value:function onColorTilesClick(e){this.selectedColor=this.getColorByMouse();this.close();}},{key:"onColorTilesMouseMove",value:function onColorTilesMouseMove(e){this._colorInput.focus=false;var color=this.getColorByMouse();this._colorInput.text=color;this.drawBlock(color);}},{key:"getColorByMouse",value:function getColorByMouse(){var point=this._colorTiles.getMousePoint();var x=Math.floor(point.x/this._gridSize);var y=Math.floor(point.y/this._gridSize);return this._colors[y*20+x];}},{key:"drawBlock",value:function drawBlock(color){var g=this._colorBlock.graphics;g.clear(true);var showColor=color?color:"#ffffff";g.drawRect(0,0,50,20,showColor,this._borderColor);color||g.drawLine(0,0,50,20,"#ff0000");}},{key:"changeColor",value:function changeColor(){var g=this.graphics;g.clear(true);var showColor=this._selectedColor||"#000000";g.drawRect(0,0,this._colorButton.width,this._colorButton.height,showColor);}},{key:"_setPanelChanged",value:function _setPanelChanged(){if(!this._panelChanged){this._panelChanged=true;this.callLater(this.changePanel);}}},{key:"selectedColor",get:function get(){return this._selectedColor;},set:function set(value){if(this._selectedColor!=value){this._selectedColor=this._colorInput.text=value;this.drawBlock(value);this.changeColor();this.changeHandler&&this.changeHandler.runWith(this._selectedColor);this.event(Laya.Event.CHANGE,Laya.Event.EMPTY.setTo(Laya.Event.CHANGE,this,this));}}},{key:"skin",get:function get(){return this._colorButton.skin;},set:function set(value){this._colorButton.once(Laya.Event.LOADED,this,this.changeColor);this._colorButton.skin=value;}},{key:"bgColor",get:function get(){return this._bgColor;},set:function set(value){this._bgColor=value;this._setPanelChanged();}},{key:"borderColor",get:function get(){return this._borderColor;},set:function set(value){this._borderColor=value;this._setPanelChanged();}},{key:"inputColor",get:function get(){return this._inputColor;},set:function set(value){this._inputColor=value;this._setPanelChanged();}},{key:"inputBgColor",get:function get(){return this._inputBgColor;},set:function set(value){this._inputBgColor=value;this._setPanelChanged();}}]);return ColorPicker;}(UIComponent);Laya.ILaya.regClass(ColorPicker);Laya.ClassUtils.regClass("laya.ui.ColorPicker",ColorPicker);Laya.ClassUtils.regClass("Laya.ColorPicker",ColorPicker);var Label=function(_UIComponent6){_inherits(Label,_UIComponent6);function Label(){var text=arguments.length>0&&arguments[0]!==undefined?arguments[0]:"";_classCallCheck(this,Label);var _this85=_possibleConstructorReturn(this,(Label.__proto__||Object.getPrototypeOf(Label)).call(this));_this85.text=text;return _this85;}_createClass(Label,[{key:"destroy",value:function destroy(){var destroyChild=arguments.length>0&&arguments[0]!==undefined?arguments[0]:true;_get(Label.prototype.__proto__||Object.getPrototypeOf(Label.prototype),"destroy",this).call(this,destroyChild);this._tf=null;}},{key:"createChildren",value:function createChildren(){this.addChild(this._tf=new Laya.Text());}},{key:"changeText",value:function changeText(text){this._tf.changeText(text);}},{key:"measureWidth",value:function measureWidth(){return this._tf.width;}},{key:"measureHeight",value:function measureHeight(){return this._tf.height;}},{key:"text",get:function get(){return this._tf.text;},set:function set(value){if(this._tf.text!=value){if(value)value=UIUtils.adptString(value+"");this._tf.text=value;this.event(Laya.Event.CHANGE);if(!this._width||!this._height)this.onCompResize();}}},{key:"wordWrap",get:function get(){return this._tf.wordWrap;},set:function set(value){this._tf.wordWrap=value;}},{key:"color",get:function get(){return this._tf.color;},set:function set(value){this._tf.color=value;}},{key:"font",get:function get(){return this._tf.font;},set:function set(value){this._tf.font=value;}},{key:"align",get:function get(){return this._tf.align;},set:function set(value){this._tf.align=value;}},{key:"valign",get:function get(){return this._tf.valign;},set:function set(value){this._tf.valign=value;}},{key:"bold",get:function get(){return this._tf.bold;},set:function set(value){this._tf.bold=value;}},{key:"italic",get:function get(){return this._tf.italic;},set:function set(value){this._tf.italic=value;}},{key:"leading",get:function get(){return this._tf.leading;},set:function set(value){this._tf.leading=value;}},{key:"fontSize",get:function get(){return this._tf.fontSize;},set:function set(value){this._tf.fontSize=value;}},{key:"padding",get:function get(){return this._tf.padding.join(",");},set:function set(value){this._tf.padding=UIUtils.fillArray(Styles.labelPadding,value,Number);}},{key:"bgColor",get:function get(){return this._tf.bgColor;},set:function set(value){this._tf.bgColor=value;}},{key:"borderColor",get:function get(){return this._tf.borderColor;},set:function set(value){this._tf.borderColor=value;}},{key:"stroke",get:function get(){return this._tf.stroke;},set:function set(value){this._tf.stroke=value;}},{key:"strokeColor",get:function get(){return this._tf.strokeColor;},set:function set(value){this._tf.strokeColor=value;}},{key:"textField",get:function get(){return this._tf;}},{key:"width",get:function get(){if(this._width||this._tf.text)return _get(Label.prototype.__proto__||Object.getPrototypeOf(Label.prototype),"width",this);return 0;},set:function set(value){_set(Label.prototype.__proto__||Object.getPrototypeOf(Label.prototype),"width",value,this);this._tf.width=value;}},{key:"height",get:function get(){if(this._height||this._tf.text)return _get(Label.prototype.__proto__||Object.getPrototypeOf(Label.prototype),"height",this);return 0;},set:function set(value){_set(Label.prototype.__proto__||Object.getPrototypeOf(Label.prototype),"height",value,this);this._tf.height=value;}},{key:"dataSource",set:function set(value){this._dataSource=value;if(typeof value=='number'||typeof value=='string')this.text=value+"";else _set(Label.prototype.__proto__||Object.getPrototypeOf(Label.prototype),"dataSource",value,this);},get:function get(){return _get(Label.prototype.__proto__||Object.getPrototypeOf(Label.prototype),"dataSource",this);}},{key:"overflow",get:function get(){return this._tf.overflow;},set:function set(value){this._tf.overflow=value;}},{key:"underline",get:function get(){return this._tf.underline;},set:function set(value){this._tf.underline=value;}},{key:"underlineColor",get:function get(){return this._tf.underlineColor;},set:function set(value){this._tf.underlineColor=value;}}]);return Label;}(UIComponent);Laya.ILaya.regClass(Label);Laya.ClassUtils.regClass("laya.ui.Label",Label);Laya.ClassUtils.regClass("Laya.Label",Label);var Slider=function(_UIComponent7){_inherits(Slider,_UIComponent7);function Slider(){var skin=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;_classCallCheck(this,Slider);var _this86=_possibleConstructorReturn(this,(Slider.__proto__||Object.getPrototypeOf(Slider)).call(this));_this86.isVertical=true;_this86.showLabel=true;_this86._max=100;_this86._min=0;_this86._tick=1;_this86._value=0;if(!Slider.label){Slider.label=new Label();}_this86.skin=skin;return _this86;}_createClass(Slider,[{key:"destroy",value:function destroy(){var destroyChild=arguments.length>0&&arguments[0]!==undefined?arguments[0]:true;_get(Slider.prototype.__proto__||Object.getPrototypeOf(Slider.prototype),"destroy",this).call(this,destroyChild);this._bg&&this._bg.destroy(destroyChild);this._bar&&this._bar.destroy(destroyChild);this._progress&&this._progress.destroy(destroyChild);this._bg=null;this._bar=null;this._progress=null;this.changeHandler=null;}},{key:"createChildren",value:function createChildren(){this.addChild(this._bg=new Image());this.addChild(this._bar=new Button());}},{key:"initialize",value:function initialize(){this._bar.on(Laya.Event.MOUSE_DOWN,this,this.onBarMouseDown);this._bg.sizeGrid=this._bar.sizeGrid="4,4,4,4,0";if(this._progress)this._progress.sizeGrid=this._bar.sizeGrid;this.allowClickBack=true;}},{key:"onBarMouseDown",value:function onBarMouseDown(e){var Laya$1=Laya.ILaya;this._globalSacle||(this._globalSacle=new Laya.Point());this._globalSacle.setTo(this.globalScaleX||0.01,this.globalScaleY||0.01);this._maxMove=this.isVertical?this.height-this._bar.height:this.width-this._bar.width;this._tx=Laya$1.stage.mouseX;this._ty=Laya$1.stage.mouseY;Laya$1.stage.on(Laya.Event.MOUSE_MOVE,this,this.mouseMove);Laya$1.stage.once(Laya.Event.MOUSE_UP,this,this.mouseUp);Laya$1.stage.once(Laya.Event.MOUSE_OUT,this,this.mouseUp);this.showValueText();}},{key:"showValueText",value:function showValueText(){if(this.showLabel){var label=Slider.label;this.addChild(label);label.textField.changeText(this._value+"");if(this.isVertical){label.x=this._bar._x+20;label.y=(this._bar.height-label.height)*0.5+this._bar._y;}else{label.y=this._bar._y-20;label.x=(this._bar.width-label.width)*0.5+this._bar._x;}}}},{key:"hideValueText",value:function hideValueText(){Slider.label&&Slider.label.removeSelf();}},{key:"mouseUp",value:function mouseUp(e){var stage=Laya.ILaya.stage;stage.off(Laya.Event.MOUSE_MOVE,this,this.mouseMove);stage.off(Laya.Event.MOUSE_UP,this,this.mouseUp);stage.off(Laya.Event.MOUSE_OUT,this,this.mouseUp);this.sendChangeEvent(Laya.Event.CHANGED);this.hideValueText();}},{key:"mouseMove",value:function mouseMove(e){var stage=Laya.ILaya.stage;var oldValue=this._value;if(this.isVertical){this._bar.y+=(stage.mouseY-this._ty)/this._globalSacle.y;if(this._bar._y>this._maxMove)this._bar.y=this._maxMove;else if(this._bar._y<0)this._bar.y=0;this._value=this._bar._y/this._maxMove*(this._max-this._min)+this._min;if(this._progress)this._progress.height=this._bar._y+0.5*this._bar.height;}else{this._bar.x+=(stage.mouseX-this._tx)/this._globalSacle.x;if(this._bar._x>this._maxMove)this._bar.x=this._maxMove;else if(this._bar._x<0)this._bar.x=0;this._value=this._bar._x/this._maxMove*(this._max-this._min)+this._min;if(this._progress)this._progress.width=this._bar._x+0.5*this._bar.width;}this._tx=stage.mouseX;this._ty=stage.mouseY;if(this._tick!=0){var pow=Math.pow(10,(this._tick+"").length-1);this._value=Math.round(Math.round(this._value/this._tick)*this._tick*pow)/pow;}if(this._value!=oldValue){this.sendChangeEvent();}this.showValueText();}},{key:"sendChangeEvent",value:function sendChangeEvent(){var type=arguments.length>0&&arguments[0]!==undefined?arguments[0]:Laya.Event.CHANGE;this.event(type);this.changeHandler&&this.changeHandler.runWith(this._value);}},{key:"_skinLoaded",value:function _skinLoaded(){this._bg.skin=this._skin;this._bar.skin=this._skin.replace(".png","$bar.png");var progressSkin=this._skin.replace(".png","$progress.png");if(Laya.Loader.getRes(progressSkin)){if(!this._progress){this.addChild(this._progress=new Image());this._progress.sizeGrid=this._bar.sizeGrid;this.setChildIndex(this._progress,1);}this._progress.skin=progressSkin;}this.setBarPoint();this.callLater(this.changeValue);this._sizeChanged();this.event(Laya.Event.LOADED);}},{key:"setBarPoint",value:function setBarPoint(){if(this.isVertical)this._bar.x=Math.round((this._bg.width-this._bar.width)*0.5);else this._bar.y=Math.round((this._bg.height-this._bar.height)*0.5);}},{key:"measureWidth",value:function measureWidth(){return Math.max(this._bg.width,this._bar.width);}},{key:"measureHeight",value:function measureHeight(){return Math.max(this._bg.height,this._bar.height);}},{key:"_sizeChanged",value:function _sizeChanged(){_get(Slider.prototype.__proto__||Object.getPrototypeOf(Slider.prototype),"_sizeChanged",this).call(this);if(this.isVertical)this._bg.height=this.height;else this._bg.width=this.width;this.setBarPoint();this.changeValue();}},{key:"setSlider",value:function setSlider(min,max,value){this._value=-1;this._min=min;this._max=max>min?max:min;this.value=value<min?min:value>max?max:value;}},{key:"changeValue",value:function changeValue(){if(this.tick!=0){var pow=Math.pow(10,(this._tick+"").length-1);this._value=Math.round(Math.round(this._value/this._tick)*this._tick*pow)/pow;}this._value=this._value>this._max?this._max:this._value<this._min?this._min:this._value;var num=this._max-this._min;if(num===0)num=1;if(this.isVertical){this._bar.y=(this._value-this._min)/num*(this.height-this._bar.height);if(this._progress)this._progress.height=this._bar._y+0.5*this._bar.height;}else{this._bar.x=(this._value-this._min)/num*(this.width-this._bar.width);if(this._progress)this._progress.width=this._bar._x+0.5*this._bar.width;}}},{key:"onBgMouseDown",value:function onBgMouseDown(e){var point=this._bg.getMousePoint();if(this.isVertical)this.value=point.y/(this.height-this._bar.height)*(this._max-this._min)+this._min;else this.value=point.x/(this.width-this._bar.width)*(this._max-this._min)+this._min;}},{key:"skin",get:function get(){return this._skin;},set:function set(value){if(this._skin!=value){this._skin=value;if(this._skin&&!Laya.Loader.getRes(this._skin)){Laya.ILaya.loader.load([this._skin,this._skin.replace(".png","$bar.png")],Laya.Handler.create(this,this._skinLoaded));}else{this._skinLoaded();}}}},{key:"sizeGrid",get:function get(){return this._bg.sizeGrid;},set:function set(value){this._bg.sizeGrid=value;this._bar.sizeGrid=value;if(this._progress)this._progress.sizeGrid=this._bar.sizeGrid;}},{key:"tick",get:function get(){return this._tick;},set:function set(value){if(this._tick!=value){this._tick=value;this.callLater(this.changeValue);}}},{key:"max",get:function get(){return this._max;},set:function set(value){if(this._max!=value){this._max=value;this.callLater(this.changeValue);}}},{key:"min",get:function get(){return this._min;},set:function set(value){if(this._min!=value){this._min=value;this.callLater(this.changeValue);}}},{key:"value",get:function get(){return this._value;},set:function set(num){if(this._value!=num){var oldValue=this._value;this._value=num;this.changeValue();if(this._value!=oldValue){this.sendChangeEvent();}}}},{key:"allowClickBack",get:function get(){return this._allowClickBack;},set:function set(value){if(this._allowClickBack!=value){this._allowClickBack=value;if(value)this._bg.on(Laya.Event.MOUSE_DOWN,this,this.onBgMouseDown);else this._bg.off(Laya.Event.MOUSE_DOWN,this,this.onBgMouseDown);}}},{key:"dataSource",set:function set(value){this._dataSource=value;if(typeof value=='number'||typeof value=='string')this.value=Number(value);else _set(Slider.prototype.__proto__||Object.getPrototypeOf(Slider.prototype),"dataSource",value,this);},get:function get(){return _get(Slider.prototype.__proto__||Object.getPrototypeOf(Slider.prototype),"dataSource",this);}},{key:"bar",get:function get(){return this._bar;}}]);return Slider;}(UIComponent);Slider.label=null;Laya.ILaya.regClass(Slider);Laya.ClassUtils.regClass("laya.ui.Slider",Slider);Laya.ClassUtils.regClass("Laya.Slider",Slider);var ScrollBar=function(_UIComponent8){_inherits(ScrollBar,_UIComponent8);function ScrollBar(){var skin=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;_classCallCheck(this,ScrollBar);var _this87=_possibleConstructorReturn(this,(ScrollBar.__proto__||Object.getPrototypeOf(ScrollBar)).call(this));_this87.rollRatio=0.97;_this87.scaleBar=true;_this87.autoHide=false;_this87.elasticDistance=0;_this87.elasticBackTime=500;_this87._showButtons=UIConfig.showButtons;_this87._scrollSize=1;_this87._thumbPercent=1;_this87._lastOffset=0;_this87._checkElastic=false;_this87._isElastic=false;_this87._hide=false;_this87._clickOnly=true;_this87._touchScrollEnable=UIConfig.touchScrollEnable;_this87._mouseWheelEnable=UIConfig.mouseWheelEnable;_this87.skin=skin;_this87.max=1;return _this87;}_createClass(ScrollBar,[{key:"destroy",value:function destroy(){var destroyChild=arguments.length>0&&arguments[0]!==undefined?arguments[0]:true;this.stopScroll();this.target=null;_get(ScrollBar.prototype.__proto__||Object.getPrototypeOf(ScrollBar.prototype),"destroy",this).call(this,destroyChild);this.upButton&&this.upButton.destroy(destroyChild);this.downButton&&this.downButton.destroy(destroyChild);this.slider&&this.slider.destroy(destroyChild);this.upButton=this.downButton=null;this.slider=null;this.changeHandler=null;this._offsets=null;}},{key:"createChildren",value:function createChildren(){this.addChild(this.slider=new Slider());this.addChild(this.upButton=new Button());this.addChild(this.downButton=new Button());}},{key:"initialize",value:function initialize(){this.slider.showLabel=false;this.slider.tick=0;this.slider.on(Laya.Event.CHANGE,this,this.onSliderChange);this.slider.setSlider(0,0,0);this.upButton.on(Laya.Event.MOUSE_DOWN,this,this.onButtonMouseDown);this.downButton.on(Laya.Event.MOUSE_DOWN,this,this.onButtonMouseDown);}},{key:"onSliderChange",value:function onSliderChange(){if(this._value!=this.slider.value)this.value=this.slider.value;}},{key:"onButtonMouseDown",value:function onButtonMouseDown(e){var isUp=e.currentTarget===this.upButton;this.slide(isUp);Laya.ILaya.timer.once(Styles.scrollBarDelayTime,this,this.startLoop,[isUp]);Laya.ILaya.stage.once(Laya.Event.MOUSE_UP,this,this.onStageMouseUp);}},{key:"startLoop",value:function startLoop(isUp){Laya.ILaya.timer.frameLoop(1,this,this.slide,[isUp]);}},{key:"slide",value:function slide(isUp){if(isUp)this.value-=this._scrollSize;else this.value+=this._scrollSize;}},{key:"onStageMouseUp",value:function onStageMouseUp(e){Laya.ILaya.timer.clear(this,this.startLoop);Laya.ILaya.timer.clear(this,this.slide);}},{key:"_skinLoaded",value:function _skinLoaded(){this.slider.skin=this._skin;this.callLater(this.changeScrollBar);this._sizeChanged();this.event(Laya.Event.LOADED);}},{key:"changeScrollBar",value:function changeScrollBar(){this.upButton.visible=this._showButtons;this.downButton.visible=this._showButtons;if(this._showButtons){this.upButton.skin=this._skin.replace(".png","$up.png");this.downButton.skin=this._skin.replace(".png","$down.png");}if(this.slider.isVertical)this.slider.y=this._showButtons?this.upButton.height:0;else this.slider.x=this._showButtons?this.upButton.width:0;this.resetPositions();this.repaint();}},{key:"_sizeChanged",value:function _sizeChanged(){_get(ScrollBar.prototype.__proto__||Object.getPrototypeOf(ScrollBar.prototype),"_sizeChanged",this).call(this);this.repaint();this.resetPositions();this.event(Laya.Event.CHANGE);this.changeHandler&&this.changeHandler.runWith(this.value);}},{key:"resetPositions",value:function resetPositions(){if(this.slider.isVertical)this.slider.height=this.height-(this._showButtons?this.upButton.height+this.downButton.height:0);else this.slider.width=this.width-(this._showButtons?this.upButton.width+this.downButton.width:0);this.resetButtonPosition();}},{key:"resetButtonPosition",value:function resetButtonPosition(){if(this.slider.isVertical)this.downButton.y=this.slider._y+this.slider.height;else this.downButton.x=this.slider._x+this.slider.width;}},{key:"measureWidth",value:function measureWidth(){if(this.slider.isVertical)return this.slider.width;return 100;}},{key:"measureHeight",value:function measureHeight(){if(this.slider.isVertical)return 100;return this.slider.height;}},{key:"setScroll",value:function setScroll(min,max,value){this.runCallLater(this._sizeChanged);this.slider.setSlider(min,max,value);this.slider.bar.visible=max>0;if(!this._hide&&this.autoHide)this.visible=false;}},{key:"onTargetMouseWheel",value:function onTargetMouseWheel(e){this.value-=e.delta*this._scrollSize;this.target=this._target;}},{key:"onTargetMouseDown",value:function onTargetMouseDown(e){if(this.isLockedFun&&!this.isLockedFun(e))return;this.event(Laya.Event.END);this._clickOnly=true;this._lastOffset=0;this._checkElastic=false;this._lastPoint||(this._lastPoint=new Laya.Point());this._lastPoint.setTo(Laya.ILaya.stage.mouseX,Laya.ILaya.stage.mouseY);Laya.ILaya.timer.clear(this,this.tweenMove);Laya.Tween.clearTween(this);Laya.ILaya.stage.once(Laya.Event.MOUSE_UP,this,this.onStageMouseUp2);Laya.ILaya.stage.once(Laya.Event.MOUSE_OUT,this,this.onStageMouseUp2);Laya.ILaya.timer.frameLoop(1,this,this.loop);}},{key:"startDragForce",value:function startDragForce(){this._clickOnly=true;this._lastOffset=0;this._checkElastic=false;this._lastPoint||(this._lastPoint=new Laya.Point());this._lastPoint.setTo(Laya.ILaya.stage.mouseX,Laya.ILaya.stage.mouseY);Laya.ILaya.timer.clear(this,this.tweenMove);Laya.Tween.clearTween(this);Laya.ILaya.stage.once(Laya.Event.MOUSE_UP,this,this.onStageMouseUp2);Laya.ILaya.stage.once(Laya.Event.MOUSE_OUT,this,this.onStageMouseUp2);Laya.ILaya.timer.frameLoop(1,this,this.loop);}},{key:"cancelDragOp",value:function cancelDragOp(){Laya.ILaya.stage.off(Laya.Event.MOUSE_UP,this,this.onStageMouseUp2);Laya.ILaya.stage.off(Laya.Event.MOUSE_OUT,this,this.onStageMouseUp2);Laya.ILaya.timer.clear(this,this.tweenMove);Laya.ILaya.timer.clear(this,this.loop);this._target.mouseEnabled=true;}},{key:"checkTriggers",value:function checkTriggers(){var isTweenMove=arguments.length>0&&arguments[0]!==undefined?arguments[0]:false;if(this.value>=0&&this.value-this._lastOffset<=0){if(this.triggerDownDragLimit&&this.triggerDownDragLimit(isTweenMove)){this.cancelDragOp();this.value=0;return true;}}if(this.value<=this.max&&this.value-this._lastOffset>=this.max){if(this.triggerUpDragLimit&&this.triggerUpDragLimit(isTweenMove)){this.cancelDragOp();this.value=this.max;return true;}}return false;}},{key:"startTweenMoveForce",value:function startTweenMoveForce(lastOffset){this._lastOffset=lastOffset;Laya.ILaya.timer.frameLoop(1,this,this.tweenMove,[200]);}},{key:"loop",value:function loop(){var mouseY=Laya.ILaya.stage.mouseY;var mouseX=Laya.ILaya.stage.mouseX;this._lastOffset=this.isVertical?mouseY-this._lastPoint.y:mouseX-this._lastPoint.x;if(this._clickOnly){if(Math.abs(this._lastOffset*(this.isVertical?Laya.ILaya.stage._canvasTransform.getScaleY():Laya.ILaya.stage._canvasTransform.getScaleX()))>1){this._clickOnly=false;if(this.checkTriggers())return;this._offsets||(this._offsets=[]);this._offsets.length=0;this._target.mouseEnabled=false;if(!this.hide&&this.autoHide){this.alpha=1;this.visible=true;}this.event(Laya.Event.START);}else return;}else{if(this.checkTriggers())return;}this._offsets.push(this._lastOffset);this._lastPoint.x=mouseX;this._lastPoint.y=mouseY;if(this._lastOffset===0)return;if(!this._checkElastic){if(this.elasticDistance>0){if(!this._checkElastic&&this._lastOffset!=0){if(this._lastOffset>0&&this._value<=this.min||this._lastOffset<0&&this._value>=this.max){this._isElastic=true;this._checkElastic=true;}else{this._isElastic=false;}}}else{this._checkElastic=true;}}if(this._isElastic){if(this._value<=this.min){if(this._lastOffset>0){this.value-=this._lastOffset*Math.max(0,1-(this.min-this._value)/this.elasticDistance);}else{this.value-=this._lastOffset*0.5;if(this._value>=this.min)this._checkElastic=false;}}else if(this._value>=this.max){if(this._lastOffset<0){this.value-=this._lastOffset*Math.max(0,1-(this._value-this.max)/this.elasticDistance);}else{this.value-=this._lastOffset*0.5;if(this._value<=this.max)this._checkElastic=false;}}}else{this.value-=this._lastOffset;}}},{key:"onStageMouseUp2",value:function onStageMouseUp2(e){Laya.ILaya.stage.off(Laya.Event.MOUSE_UP,this,this.onStageMouseUp2);Laya.ILaya.stage.off(Laya.Event.MOUSE_OUT,this,this.onStageMouseUp2);Laya.ILaya.timer.clear(this,this.loop);if(this._clickOnly){if(this._value>=this.min&&this._value<=this.max)return;}this._target.mouseEnabled=true;if(this._isElastic){if(this._value<this.min){Laya.Tween.to(this,{value:this.min},this.elasticBackTime,Laya.Ease.sineOut,Laya.Handler.create(this,this.elasticOver));}else if(this._value>this.max){Laya.Tween.to(this,{value:this.max},this.elasticBackTime,Laya.Ease.sineOut,Laya.Handler.create(this,this.elasticOver));}}else{if(!this._offsets)return;if(this._offsets.length<1){this._offsets[0]=this.isVertical?Laya.ILaya.stage.mouseY-this._lastPoint.y:Laya.ILaya.stage.mouseX-this._lastPoint.x;}var offset=0;var n=Math.min(this._offsets.length,3);for(var i=0;i<n;i++){offset+=this._offsets[this._offsets.length-1-i];}this._lastOffset=offset/n;offset=Math.abs(this._lastOffset);if(offset<2){this.event(Laya.Event.END);return;}if(offset>250)this._lastOffset=this._lastOffset>0?250:-250;var dis=Math.round(Math.abs(this.elasticDistance*(this._lastOffset/150)));Laya.ILaya.timer.frameLoop(1,this,this.tweenMove,[dis]);}}},{key:"elasticOver",value:function elasticOver(){this._isElastic=false;if(!this.hide&&this.autoHide){Laya.Tween.to(this,{alpha:0},500);}this.event(Laya.Event.END);}},{key:"tweenMove",value:function tweenMove(maxDistance){this._lastOffset*=this.rollRatio;if(this.checkTriggers(true)){return;}var tarSpeed;if(maxDistance>0){if(this._lastOffset>0&&this.value<=this.min){this._isElastic=true;tarSpeed=-(this.min-maxDistance-this.value)*0.5;if(this._lastOffset>tarSpeed)this._lastOffset=tarSpeed;}else if(this._lastOffset<0&&this.value>=this.max){this._isElastic=true;tarSpeed=-(this.max+maxDistance-this.value)*0.5;if(this._lastOffset<tarSpeed)this._lastOffset=tarSpeed;}}this.value-=this._lastOffset;if(Math.abs(this._lastOffset)<0.1){Laya.ILaya.timer.clear(this,this.tweenMove);if(this._isElastic){if(this._value<this.min){Laya.Tween.to(this,{value:this.min},this.elasticBackTime,Laya.Ease.sineOut,Laya.Handler.create(this,this.elasticOver));}else if(this._value>this.max){Laya.Tween.to(this,{value:this.max},this.elasticBackTime,Laya.Ease.sineOut,Laya.Handler.create(this,this.elasticOver));}else{this.elasticOver();}return;}this.event(Laya.Event.END);if(!this.hide&&this.autoHide){Laya.Tween.to(this,{alpha:0},500);}}}},{key:"stopScroll",value:function stopScroll(){this.onStageMouseUp2(null);Laya.ILaya.timer.clear(this,this.tweenMove);Laya.Tween.clearTween(this);}},{key:"skin",get:function get(){return this._skin;},set:function set(value){if(value==" ")return;if(this._skin!=value){this._skin=value;if(this._skin&&!Laya.Loader.getRes(this._skin)){Laya.ILaya.loader.load([this._skin,this._skin.replace(".png","$up.png"),this._skin.replace(".png","$down.png"),this._skin.replace(".png","$bar.png")],Laya.Handler.create(this,this._skinLoaded));}else{this._skinLoaded();}}}},{key:"max",get:function get(){return this.slider.max;},set:function set(value){this.slider.max=value;}},{key:"min",get:function get(){return this.slider.min;},set:function set(value){this.slider.min=value;}},{key:"value",get:function get(){return this._value;},set:function set(v){if(v!==this._value){this._value=v;if(!this._isElastic){if(this.slider["_value"]!=v){this.slider["_value"]=v;this.slider.changeValue();}this._value=this.slider["_value"];}this.event(Laya.Event.CHANGE);this.changeHandler&&this.changeHandler.runWith(this._value);}}},{key:"isVertical",get:function get(){return this.slider.isVertical;},set:function set(value){this.slider.isVertical=value;}},{key:"sizeGrid",get:function get(){return this.slider.sizeGrid;},set:function set(value){this.slider.sizeGrid=value;}},{key:"scrollSize",get:function get(){return this._scrollSize;},set:function set(value){this._scrollSize=value;}},{key:"dataSource",set:function set(value){this._dataSource=value;if(typeof value=='number'||typeof value=='string')this.value=Number(value);else _set(ScrollBar.prototype.__proto__||Object.getPrototypeOf(ScrollBar.prototype),"dataSource",value,this);},get:function get(){return _get(ScrollBar.prototype.__proto__||Object.getPrototypeOf(ScrollBar.prototype),"dataSource",this);}},{key:"thumbPercent",get:function get(){return this._thumbPercent;},set:function set(value){this.runCallLater(this.changeScrollBar);this.runCallLater(this._sizeChanged);value=value>=1?0.99:value;this._thumbPercent=value;if(this.scaleBar){if(this.slider.isVertical)this.slider.bar.height=Math.max(this.slider.height*value,Styles.scrollBarMinNum);else this.slider.bar.width=Math.max(this.slider.width*value,Styles.scrollBarMinNum);}}},{key:"target",get:function get(){return this._target;},set:function set(value){if(this._target){this._target.off(Laya.Event.MOUSE_WHEEL,this,this.onTargetMouseWheel);this._target.off(Laya.Event.MOUSE_DOWN,this,this.onTargetMouseDown);}this._target=value;if(value){this._mouseWheelEnable&&this._target.on(Laya.Event.MOUSE_WHEEL,this,this.onTargetMouseWheel);this._touchScrollEnable&&this._target.on(Laya.Event.MOUSE_DOWN,this,this.onTargetMouseDown);}}},{key:"hide",get:function get(){return this._hide;},set:function set(value){this._hide=value;this.visible=!value;}},{key:"showButtons",get:function get(){return this._showButtons;},set:function set(value){this._showButtons=value;this.callLater(this.changeScrollBar);}},{key:"touchScrollEnable",get:function get(){return this._touchScrollEnable;},set:function set(value){this._touchScrollEnable=value;this.target=this._target;}},{key:"mouseWheelEnable",get:function get(){return this._mouseWheelEnable;},set:function set(value){this._mouseWheelEnable=value;this.target=this._target;}},{key:"lastOffset",get:function get(){return this._lastOffset;}},{key:"tick",get:function get(){return this.slider.tick;},set:function set(value){this.slider.tick=value;}}]);return ScrollBar;}(UIComponent);Laya.ILaya.regClass(ScrollBar);Laya.ClassUtils.regClass("laya.ui.ScrollBar",ScrollBar);Laya.ClassUtils.regClass("Laya.ScrollBar",ScrollBar);var VScrollBar=function(_ScrollBar){_inherits(VScrollBar,_ScrollBar);function VScrollBar(){_classCallCheck(this,VScrollBar);return _possibleConstructorReturn(this,(VScrollBar.__proto__||Object.getPrototypeOf(VScrollBar)).apply(this,arguments));}return VScrollBar;}(ScrollBar);Laya.ILaya.regClass(VScrollBar);Laya.ClassUtils.regClass("laya.ui.VScrollBar",VScrollBar);Laya.ClassUtils.regClass("Laya.VScrollBar",VScrollBar);var HScrollBar=function(_ScrollBar2){_inherits(HScrollBar,_ScrollBar2);function HScrollBar(){_classCallCheck(this,HScrollBar);return _possibleConstructorReturn(this,(HScrollBar.__proto__||Object.getPrototypeOf(HScrollBar)).apply(this,arguments));}_createClass(HScrollBar,[{key:"initialize",value:function initialize(){_get(HScrollBar.prototype.__proto__||Object.getPrototypeOf(HScrollBar.prototype),"initialize",this).call(this);this.slider.isVertical=false;}}]);return HScrollBar;}(ScrollBar);Laya.ILaya.regClass(HScrollBar);Laya.ClassUtils.regClass("laya.ui.HScrollBar",HScrollBar);Laya.ClassUtils.regClass("Laya.HScrollBar",HScrollBar);var List=function(_Box){_inherits(List,_Box);function List(){_classCallCheck(this,List);var _this90=_possibleConstructorReturn(this,(List.__proto__||Object.getPrototypeOf(List)).apply(this,arguments));_this90.selectEnable=false;_this90.totalPage=0;_this90._$componentType="List";_this90._repeatX=0;_this90._repeatY=0;_this90._repeatX2=0;_this90._repeatY2=0;_this90._spaceX=0;_this90._spaceY=0;_this90._cells=[];_this90._startIndex=0;_this90._selectedIndex=-1;_this90._page=0;_this90._isVertical=true;_this90._cellSize=20;_this90._cellOffset=0;_this90._createdLine=0;_this90._offset=new Laya.Point();_this90._usedCache=null;_this90._elasticEnabled=false;_this90._preLen=0;return _this90;}_createClass(List,[{key:"destroy",value:function destroy(){var destroyChild=arguments.length>0&&arguments[0]!==undefined?arguments[0]:true;this._content&&this._content.destroy(destroyChild);this._scrollBar&&this._scrollBar.destroy(destroyChild);_get(List.prototype.__proto__||Object.getPrototypeOf(List.prototype),"destroy",this).call(this,destroyChild);this._content=null;this._scrollBar=null;this._itemRender=null;this._cells=null;this._array=null;this.selectHandler=this.renderHandler=this.mouseHandler=null;}},{key:"createChildren",value:function createChildren(){this.addChild(this._content=new Box());}},{key:"onScrollStart",value:function onScrollStart(){this._usedCache||(this._usedCache=_get(List.prototype.__proto__||Object.getPrototypeOf(List.prototype),"cacheAs",this));_set(List.prototype.__proto__||Object.getPrototypeOf(List.prototype),"cacheAs","none",this);this._scrollBar.once(Laya.Event.END,this,this.onScrollEnd);}},{key:"onScrollEnd",value:function onScrollEnd(){_set(List.prototype.__proto__||Object.getPrototypeOf(List.prototype),"cacheAs",this._usedCache,this);}},{key:"_removePreScrollBar",value:function _removePreScrollBar(){var preNode=this.removeChildByName("scrollBar");if(preNode)preNode.destroy(true);}},{key:"changeCells",value:function changeCells(){this._cellChanged=false;if(this._itemRender){this.scrollBar=this.getChildByName("scrollBar");var cell=this._getOneCell();var cellWidth=cell.width+this._spaceX||1;var cellHeight=cell.height+this._spaceY||1;if(this._width>0)this._repeatX2=this._isVertical?Math.round(this._width/cellWidth):Math.ceil(this._width/cellWidth);if(this._height>0)this._repeatY2=this._isVertical?Math.ceil(this._height/cellHeight):Math.round(this._height/cellHeight);var listWidth=this._width?this._width:cellWidth*this.repeatX-this._spaceX;var listHeight=this._height?this._height:cellHeight*this.repeatY-this._spaceY;this._cellSize=this._isVertical?cellHeight:cellWidth;this._cellOffset=this._isVertical?cellHeight*Math.max(this._repeatY2,this._repeatY)-listHeight-this._spaceY:cellWidth*Math.max(this._repeatX2,this._repeatX)-listWidth-this._spaceX;if(this._isVertical&&this.vScrollBarSkin)this._scrollBar.height=listHeight;else if(!this._isVertical&&this.hScrollBarSkin)this._scrollBar.width=listWidth;this.setContentSize(listWidth,listHeight);var numX=this._isVertical?this.repeatX:this.repeatY;var numY=(this._isVertical?this.repeatY:this.repeatX)+(this._scrollBar?1:0);this._createItems(0,numX,numY);this._createdLine=numY;if(this._array){this.array=this._array;this.runCallLater(this.renderItems);}}}},{key:"_getOneCell",value:function _getOneCell(){if(this._cells.length===0){var item=this.createItem();this._offset.setTo(item._x,item._y);if(this.cacheContent)return item;this._cells.push(item);}return this._cells[0];}},{key:"_createItems",value:function _createItems(startY,numX,numY){var box=this._content;var cell=this._getOneCell();var cellWidth=cell.width+this._spaceX;var cellHeight=cell.height+this._spaceY;if(this.cacheContent){var cacheBox=new Box();cacheBox.cacheAs="normal";cacheBox.pos((this._isVertical?0:startY)*cellWidth,(this._isVertical?startY:0)*cellHeight);this._content.addChild(cacheBox);box=cacheBox;}else{var arr=[];for(var i=this._cells.length-1;i>-1;i--){var item=this._cells[i];item.removeSelf();arr.push(item);}this._cells.length=0;}for(var k=startY;k<numY;k++){for(var l=0;l<numX;l++){if(arr&&arr.length){cell=arr.pop();}else{cell=this.createItem();}cell.x=(this._isVertical?l:k)*cellWidth-box._x;cell.y=(this._isVertical?k:l)*cellHeight-box._y;cell.name="item"+(k*numX+l);box.addChild(cell);this.addCell(cell);}}}},{key:"createItem",value:function createItem(){var arr=[];if(typeof this._itemRender=="function"){var box=new this._itemRender();}else{box=Laya.SceneUtils.createComp(this._itemRender,null,null,arr);}if(this.__onCreateItem)this.__onCreateItem(box);if(arr.length==0&&box["_watchMap"]){var watchMap=box["_watchMap"];for(var name in watchMap){var a=watchMap[name];for(var i=0;i<a.length;i++){var watcher=a[i];arr.push(watcher.comp,watcher.prop,watcher.value);}}}if(arr.length)box["_$bindData"]=arr;return box;}},{key:"addCell",value:function addCell(cell){cell.on(Laya.Event.CLICK,this,this.onCellMouse);cell.on(Laya.Event.RIGHT_CLICK,this,this.onCellMouse);cell.on(Laya.Event.MOUSE_OVER,this,this.onCellMouse);cell.on(Laya.Event.MOUSE_OUT,this,this.onCellMouse);cell.on(Laya.Event.MOUSE_DOWN,this,this.onCellMouse);cell.on(Laya.Event.MOUSE_UP,this,this.onCellMouse);this._cells.push(cell);}},{key:"_afterInited",value:function _afterInited(){this.initItems();}},{key:"initItems",value:function initItems(){if(!this._itemRender&&this.getChildByName("item0")!=null){this.repeatX=1;var count;count=0;for(var i=0;i<10000;i++){var cell=this.getChildByName("item"+i);if(cell){this.addCell(cell);count++;continue;}break;}this.repeatY=count;}}},{key:"setContentSize",value:function setContentSize(width,height){this._content.width=width;this._content.height=height;if(this._scrollBar||this._offset.x!=0||this._offset.y!=0){this._content._style.scrollRect||(this._content.scrollRect=Laya.Rectangle.create());this._content._style.scrollRect.setTo(-this._offset.x,-this._offset.y,width,height);this._content.scrollRect=this._content.scrollRect;}this.event(Laya.Event.RESIZE);}},{key:"onCellMouse",value:function onCellMouse(e){if(e.type===Laya.Event.MOUSE_DOWN)this._isMoved=false;var cell=e.currentTarget;var index=this._startIndex+this._cells.indexOf(cell);if(index<0)return;if(e.type===Laya.Event.CLICK||e.type===Laya.Event.RIGHT_CLICK){if(this.selectEnable&&!this._isMoved)this.selectedIndex=index;else this.changeCellState(cell,true,0);}else if((e.type===Laya.Event.MOUSE_OVER||e.type===Laya.Event.MOUSE_OUT)&&this._selectedIndex!==index){this.changeCellState(cell,e.type===Laya.Event.MOUSE_OVER,0);}this.mouseHandler&&this.mouseHandler.runWith([e,index]);}},{key:"changeCellState",value:function changeCellState(cell,visible,index){var selectBox=cell.getChildByName("selectBox");if(selectBox){this.selectEnable=true;selectBox.visible=visible;selectBox.index=index;}}},{key:"_sizeChanged",value:function _sizeChanged(){_get(List.prototype.__proto__||Object.getPrototypeOf(List.prototype),"_sizeChanged",this).call(this);this.setContentSize(this.width,this.height);if(this._scrollBar)this.callLater(this.onScrollBarChange);}},{key:"onScrollBarChange",value:function onScrollBarChange(){var e=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;this.runCallLater(this.changeCells);var scrollValue=this._scrollBar.value;var lineX=this._isVertical?this.repeatX:this.repeatY;var lineY=this._isVertical?this.repeatY:this.repeatX;var scrollLine=Math.floor(scrollValue/this._cellSize);if(!this.cacheContent){var index=scrollLine*lineX;var num=0;if(index>this._startIndex){num=index-this._startIndex;var down=true;var toIndex=this._startIndex+lineX*(lineY+1);this._isMoved=true;}else if(index<this._startIndex){num=this._startIndex-index;down=false;toIndex=this._startIndex-1;this._isMoved=true;}for(var i=0;i<num;i++){if(down){var cell=this._cells.shift();this._cells[this._cells.length]=cell;var cellIndex=toIndex+i;}else{cell=this._cells.pop();this._cells.unshift(cell);cellIndex=toIndex-i;}var pos=Math.floor(cellIndex/lineX)*this._cellSize;this._isVertical?cell.y=pos:cell.x=pos;this.renderItem(cell,cellIndex);}this._startIndex=index;this.changeSelectStatus();}else{num=lineY+1;if(this._createdLine-scrollLine<num){this._createItems(this._createdLine,lineX,this._createdLine+num);this.renderItems(this._createdLine*lineX,0);this._createdLine+=num;}}var r=this._content._style.scrollRect;if(this._isVertical){r.y=scrollValue-this._offset.y;r.x=-this._offset.x;}else{r.y=-this._offset.y;r.x=scrollValue-this._offset.x;}this._content.scrollRect=r;}},{key:"posCell",value:function posCell(cell,cellIndex){if(!this._scrollBar)return;var lineX=this._isVertical?this.repeatX:this.repeatY;var lineY=this._isVertical?this.repeatY:this.repeatX;var pos=Math.floor(cellIndex/lineX)*this._cellSize;this._isVertical?cell._y=pos:cell.x=pos;}},{key:"changeSelectStatus",value:function changeSelectStatus(){for(var i=0,n=this._cells.length;i<n;i++){this.changeCellState(this._cells[i],this._selectedIndex===this._startIndex+i,1);}}},{key:"renderItems",value:function renderItems(){var from=arguments.length>0&&arguments[0]!==undefined?arguments[0]:0;var to=arguments.length>1&&arguments[1]!==undefined?arguments[1]:0;for(var i=from,n=to||this._cells.length;i<n;i++){this.renderItem(this._cells[i],this._startIndex+i);}this.changeSelectStatus();}},{key:"renderItem",value:function renderItem(cell,index){if(this._array&&index>=0&&index<this._array.length){cell.visible=true;if(cell["_$bindData"]){cell["_dataSource"]=this._array[index];this._bindData(cell,this._array[index]);}else cell.dataSource=this._array[index];if(!this.cacheContent){this.posCell(cell,index);}if(this.hasListener(Laya.Event.RENDER))this.event(Laya.Event.RENDER,[cell,index]);if(this.renderHandler)this.renderHandler.runWith([cell,index]);}else{cell.visible=false;cell.dataSource=null;}}},{key:"_bindData",value:function _bindData(cell,data){var arr=cell._$bindData;for(var i=0,n=arr.length;i<n;i++){var ele=arr[i++];var prop=arr[i++];var value=arr[i];var fun=UIUtils.getBindFun(value);ele[prop]=fun.call(this,data);}}},{key:"updateArray",value:function updateArray(array){this._array=array;var freshStart;if(this._array){freshStart=this._preLen-this._startIndex;if(freshStart>=0)this.renderItems(freshStart);this._preLen=this._array.length;}if(this._scrollBar){var length=array.length;var numX=this._isVertical?this.repeatX:this.repeatY;var numY=this._isVertical?this.repeatY:this.repeatX;var lineCount=Math.ceil(length/numX);if(lineCount>=numY){this._scrollBar.thumbPercent=numY/lineCount;this._scrollBar.slider["_max"]=(lineCount-numY)*this._cellSize+this._cellOffset;}}}},{key:"refresh",value:function refresh(){this.array=this._array;}},{key:"getItem",value:function getItem(index){if(index>-1&&index<this._array.length){return this._array[index];}return null;}},{key:"changeItem",value:function changeItem(index,source){if(index>-1&&index<this._array.length){this._array[index]=source;if(index>=this._startIndex&&index<this._startIndex+this._cells.length){this.renderItem(this.getCell(index),index);}}}},{key:"setItem",value:function setItem(index,source){this.changeItem(index,source);}},{key:"addItem",value:function addItem(souce){this._array.push(souce);this.array=this._array;}},{key:"addItemAt",value:function addItemAt(souce,index){this._array.splice(index,0,souce);this.array=this._array;}},{key:"deleteItem",value:function deleteItem(index){this._array.splice(index,1);this.array=this._array;}},{key:"getCell",value:function getCell(index){this.runCallLater(this.changeCells);if(index>-1&&this._cells){return this._cells[(index-this._startIndex)%this._cells.length];}return null;}},{key:"scrollTo",value:function scrollTo(index){if(this._scrollBar){var numX=this._isVertical?this.repeatX:this.repeatY;this._scrollBar.value=Math.floor(index/numX)*this._cellSize;}else{this.startIndex=index;}}},{key:"tweenTo",value:function tweenTo(index){var time=arguments.length>1&&arguments[1]!==undefined?arguments[1]:200;var complete=arguments.length>2&&arguments[2]!==undefined?arguments[2]:null;if(this._scrollBar){this._scrollBar.stopScroll();var numX=this._isVertical?this.repeatX:this.repeatY;Laya.Tween.to(this._scrollBar,{value:Math.floor(index/numX)*this._cellSize},time,null,complete,0,true);}else{this.startIndex=index;if(complete)complete.run();}}},{key:"_setCellChanged",value:function _setCellChanged(){if(!this._cellChanged){this._cellChanged=true;this.callLater(this.changeCells);}}},{key:"commitMeasure",value:function commitMeasure(){this.runCallLater(this.changeCells);}},{key:"cacheAs",set:function set(value){_set(List.prototype.__proto__||Object.getPrototypeOf(List.prototype),"cacheAs",value,this);if(this._scrollBar){this._usedCache=null;if(value!=="none")this._scrollBar.on(Laya.Event.START,this,this.onScrollStart);else this._scrollBar.off(Laya.Event.START,this,this.onScrollStart);}},get:function get(){return _get(List.prototype.__proto__||Object.getPrototypeOf(List.prototype),"cacheAs",this);}},{key:"content",get:function get(){return this._content;}},{key:"vScrollBarSkin",get:function get(){return this._scrollBar?this._scrollBar.skin:null;},set:function set(value){this._removePreScrollBar();var scrollBar=new VScrollBar();scrollBar.name="scrollBar";scrollBar.right=0;scrollBar.skin=value;scrollBar.elasticDistance=this._elasticEnabled?200:0;this.scrollBar=scrollBar;this.addChild(scrollBar);this._setCellChanged();}},{key:"hScrollBarSkin",get:function get(){return this._scrollBar?this._scrollBar.skin:null;},set:function set(value){this._removePreScrollBar();var scrollBar=new HScrollBar();scrollBar.name="scrollBar";scrollBar.bottom=0;scrollBar.skin=value;scrollBar.elasticDistance=this._elasticEnabled?200:0;this.scrollBar=scrollBar;this.addChild(scrollBar);this._setCellChanged();}},{key:"scrollBar",get:function get(){return this._scrollBar;},set:function set(value){if(this._scrollBar!=value){this._scrollBar=value;if(value){this._isVertical=this._scrollBar.isVertical;this.addChild(this._scrollBar);this._scrollBar.on(Laya.Event.CHANGE,this,this.onScrollBarChange);}}}},{key:"itemRender",get:function get(){return this._itemRender;},set:function set(value){if(this._itemRender!=value){this._itemRender=value;for(var i=this._cells.length-1;i>-1;i--){this._cells[i].destroy();}this._cells.length=0;this._setCellChanged();}}},{key:"width",set:function set(value){if(value!=this._width){_set(List.prototype.__proto__||Object.getPrototypeOf(List.prototype),"width",value,this);this._setCellChanged();}},get:function get(){return _get(List.prototype.__proto__||Object.getPrototypeOf(List.prototype),"width",this);}},{key:"height",set:function set(value){if(value!=this._height){_set(List.prototype.__proto__||Object.getPrototypeOf(List.prototype),"height",value,this);this._setCellChanged();}},get:function get(){return _get(List.prototype.__proto__||Object.getPrototypeOf(List.prototype),"height",this);}},{key:"repeatX",get:function get(){return this._repeatX>0?this._repeatX:this._repeatX2>0?this._repeatX2:1;},set:function set(value){this._repeatX=value;this._setCellChanged();}},{key:"repeatY",get:function get(){return this._repeatY>0?this._repeatY:this._repeatY2>0?this._repeatY2:1;},set:function set(value){this._repeatY=value;this._setCellChanged();}},{key:"spaceX",get:function get(){return this._spaceX;},set:function set(value){this._spaceX=value;this._setCellChanged();}},{key:"spaceY",get:function get(){return this._spaceY;},set:function set(value){this._spaceY=value;this._setCellChanged();}},{key:"selectedIndex",get:function get(){return this._selectedIndex;},set:function set(value){if(this._selectedIndex!=value){this._selectedIndex=value;this.changeSelectStatus();this.event(Laya.Event.CHANGE);this.selectHandler&&this.selectHandler.runWith(value);this.startIndex=this._startIndex;}}},{key:"selectedItem",get:function get(){return this._selectedIndex!=-1?this._array[this._selectedIndex]:null;},set:function set(value){this.selectedIndex=this._array.indexOf(value);}},{key:"selection",get:function get(){return this.getCell(this._selectedIndex);},set:function set(value){this.selectedIndex=this._startIndex+this._cells.indexOf(value);}},{key:"startIndex",get:function get(){return this._startIndex;},set:function set(value){this._startIndex=value>0?value:0;this.callLater(this.renderItems);}},{key:"array",get:function get(){return this._array;},set:function set(value){this.runCallLater(this.changeCells);this._array=value||[];this._preLen=this._array.length;var length=this._array.length;this.totalPage=Math.ceil(length/(this.repeatX*this.repeatY));this._selectedIndex=this._selectedIndex<length?this._selectedIndex:length-1;this.startIndex=this._startIndex;if(this._scrollBar){this._scrollBar.stopScroll();var numX=this._isVertical?this.repeatX:this.repeatY;var numY=this._isVertical?this.repeatY:this.repeatX;var lineCount=Math.ceil(length/numX);var total=this._cellOffset>0?this.totalPage+1:this.totalPage;if(total>1&&lineCount>=numY){this._scrollBar.scrollSize=this._cellSize;this._scrollBar.thumbPercent=numY/lineCount;this._scrollBar.setScroll(0,(lineCount-numY)*this._cellSize+this._cellOffset,this._scrollBar.value);this._scrollBar.target=this._content;}else{this._scrollBar.setScroll(0,0,0);this._scrollBar.target=this._content;}}}},{key:"page",get:function get(){return this._page;},set:function set(value){this._page=value;if(this._array){this._page=value>0?value:0;this._page=this._page<this.totalPage?this._page:this.totalPage-1;this.startIndex=this._page*this.repeatX*this.repeatY;}}},{key:"length",get:function get(){return this._array?this._array.length:0;}},{key:"dataSource",set:function set(value){this._dataSource=value;if(typeof value=='number'||typeof value=='string')this.selectedIndex=parseInt(value);else if(value instanceof Array)this.array=value;else _set(List.prototype.__proto__||Object.getPrototypeOf(List.prototype),"dataSource",value,this);},get:function get(){return _get(List.prototype.__proto__||Object.getPrototypeOf(List.prototype),"dataSource",this);}},{key:"cells",get:function get(){this.runCallLater(this.changeCells);return this._cells;}},{key:"elasticEnabled",get:function get(){return this._elasticEnabled;},set:function set(value){this._elasticEnabled=value;if(this._scrollBar){this._scrollBar.elasticDistance=value?200:0;}}}]);return List;}(Box);Laya.ILaya.regClass(List);Laya.ClassUtils.regClass("laya.ui.List",List);Laya.ClassUtils.regClass("Laya.List",List);var ComboBox=function(_UIComponent9){_inherits(ComboBox,_UIComponent9);function ComboBox(){var skin=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;var labels=arguments.length>1&&arguments[1]!==undefined?arguments[1]:null;_classCallCheck(this,ComboBox);var _this91=_possibleConstructorReturn(this,(ComboBox.__proto__||Object.getPrototypeOf(ComboBox)).call(this));_this91._visibleNum=6;_this91._itemColors=Styles.comboBoxItemColors;_this91._itemSize=12;_this91._labels=[];_this91._selectedIndex=-1;_this91.itemRender=null;_this91.skin=skin;_this91.labels=labels;return _this91;}_createClass(ComboBox,[{key:"destroy",value:function destroy(){var destroyChild=arguments.length>0&&arguments[0]!==undefined?arguments[0]:true;_get(ComboBox.prototype.__proto__||Object.getPrototypeOf(ComboBox.prototype),"destroy",this).call(this,destroyChild);this._button&&this._button.destroy(destroyChild);this._list&&this._list.destroy(destroyChild);this._button=null;this._list=null;this._itemColors=null;this._labels=null;this._selectHandler=null;}},{key:"createChildren",value:function createChildren(){this.addChild(this._button=new Button());this._button.text.align="left";this._button.labelPadding="0,0,0,5";this._button.on(Laya.Event.MOUSE_DOWN,this,this.onButtonMouseDown);}},{key:"_createList",value:function _createList(){this._list=new List();if(this._scrollBarSkin)this._list.vScrollBarSkin=this._scrollBarSkin;this._setListEvent(this._list);}},{key:"_setListEvent",value:function _setListEvent(list){this._list.selectEnable=true;this._list.on(Laya.Event.MOUSE_DOWN,this,this.onListDown);this._list.mouseHandler=Laya.Handler.create(this,this.onlistItemMouse,null,false);if(this._list.scrollBar)this._list.scrollBar.on(Laya.Event.MOUSE_DOWN,this,this.onScrollBarDown);}},{key:"onListDown",value:function onListDown(e){e.stopPropagation();}},{key:"onScrollBarDown",value:function onScrollBarDown(e){e.stopPropagation();}},{key:"onButtonMouseDown",value:function onButtonMouseDown(e){this.callLater(this.switchTo,[!this._isOpen]);}},{key:"measureWidth",value:function measureWidth(){return this._button.width;}},{key:"measureHeight",value:function measureHeight(){return this._button.height;}},{key:"changeList",value:function changeList(){this._listChanged=false;var labelWidth=this.width-2;var labelColor=this._itemColors[2];this._itemHeight=this._itemSize+6;this._list.itemRender=this.itemRender||{type:"Box",child:[{type:"Label",props:{name:"label",x:1,padding:"3,3,3,3",width:labelWidth,height:this._itemHeight,fontSize:this._itemSize,color:labelColor}}]};this._list.repeatY=this._visibleNum;this._list.refresh();}},{key:"onlistItemMouse",value:function onlistItemMouse(e,index){var type=e.type;if(type===Laya.Event.MOUSE_OVER||type===Laya.Event.MOUSE_OUT){if(this._isCustomList)return;var box=this._list.getCell(index);if(!box)return;var label=box.getChildByName("label");if(label){if(type===Laya.Event.ROLL_OVER){label.bgColor=this._itemColors[0];label.color=this._itemColors[1];}else{label.bgColor=null;label.color=this._itemColors[2];}}}else if(type===Laya.Event.CLICK){this.selectedIndex=index;this.isOpen=false;}}},{key:"switchTo",value:function switchTo(value){this.isOpen=value;}},{key:"changeOpen",value:function changeOpen(){this.isOpen=!this._isOpen;}},{key:"changeItem",value:function changeItem(){this._itemChanged=false;this._listHeight=this._labels.length>0?Math.min(this._visibleNum,this._labels.length)*this._itemHeight:this._itemHeight;if(!this._isCustomList){var g=this._list.graphics;g.clear(true);g.drawRect(0,0,this.width-1,this._listHeight,this._itemColors[4],this._itemColors[3]);}var a=this._list.array||[];a.length=0;for(var i=0,n=this._labels.length;i<n;i++){a.push({label:this._labels[i]});}this._list.height=this._listHeight;this._list.array=a;}},{key:"changeSelected",value:function changeSelected(){this._button.label=this.selectedLabel;}},{key:"_onStageMouseWheel",value:function _onStageMouseWheel(e){if(!this._list||this._list.contains(e.target))return;this.removeList(null);}},{key:"removeList",value:function removeList(e){Laya.ILaya.stage.off(Laya.Event.MOUSE_DOWN,this,this.removeList);Laya.ILaya.stage.off(Laya.Event.MOUSE_WHEEL,this,this._onStageMouseWheel);this.isOpen=false;}},{key:"skin",get:function get(){return this._button.skin;},set:function set(value){if(this._button.skin!=value){this._button.skin=value;this._listChanged=true;}}},{key:"width",set:function set(value){_set(ComboBox.prototype.__proto__||Object.getPrototypeOf(ComboBox.prototype),"width",value,this);this._button.width=this._width;this._itemChanged=true;this._listChanged=true;},get:function get(){return _get(ComboBox.prototype.__proto__||Object.getPrototypeOf(ComboBox.prototype),"width",this);}},{key:"height",set:function set(value){_set(ComboBox.prototype.__proto__||Object.getPrototypeOf(ComboBox.prototype),"height",value,this);this._button.height=this._height;},get:function get(){return _get(ComboBox.prototype.__proto__||Object.getPrototypeOf(ComboBox.prototype),"height",this);}},{key:"labels",get:function get(){return this._labels.join(",");},set:function set(value){if(this._labels.length>0)this.selectedIndex=-1;if(value)this._labels=value.split(",");else this._labels.length=0;this._itemChanged=true;}},{key:"selectedIndex",get:function get(){return this._selectedIndex;},set:function set(value){if(this._selectedIndex!=value){this._selectedIndex=value;if(this._labels.length>0)this.changeSelected();else this.callLater(this.changeSelected);this.event(Laya.Event.CHANGE,[Laya.Event.EMPTY.setTo(Laya.Event.CHANGE,this,this)]);this._selectHandler&&this._selectHandler.runWith(this._selectedIndex);}}},{key:"selectHandler",get:function get(){return this._selectHandler;},set:function set(value){this._selectHandler=value;}},{key:"selectedLabel",get:function get(){return this._selectedIndex>-1&&this._selectedIndex<this._labels.length?this._labels[this._selectedIndex]:null;},set:function set(value){this.selectedIndex=this._labels.indexOf(value);}},{key:"visibleNum",get:function get(){return this._visibleNum;},set:function set(value){this._visibleNum=value;this._listChanged=true;}},{key:"itemColors",get:function get(){return String(this._itemColors);},set:function set(value){this._itemColors=UIUtils.fillArray(this._itemColors,value,String);this._listChanged=true;}},{key:"itemSize",get:function get(){return this._itemSize;},set:function set(value){this._itemSize=value;this._listChanged=true;}},{key:"isOpen",get:function get(){return this._isOpen;},set:function set(value){if(this._isOpen!=value){this._isOpen=value;this._button.selected=this._isOpen;if(this._isOpen){this._list||this._createList();this._listChanged&&!this._isCustomList&&this.changeList();this._itemChanged&&this.changeItem();var p=this.localToGlobal(Laya.Point.TEMP.setTo(0,0));var py=p.y+this._button.height;py=py+this._listHeight<=Laya.ILaya.stage.height?py:p.y-this._listHeight;this._list.pos(p.x,py);this._list.zOrder=1001;Laya.ILaya.stage.addChild(this._list);Laya.ILaya.stage.once(Laya.Event.MOUSE_DOWN,this,this.removeList);Laya.ILaya.stage.on(Laya.Event.MOUSE_WHEEL,this,this._onStageMouseWheel);this._list.selectedIndex=this._selectedIndex;}else{this._list&&this._list.removeSelf();}}}},{key:"scrollBarSkin",get:function get(){return this._scrollBarSkin;},set:function set(value){this._scrollBarSkin=value;}},{key:"sizeGrid",get:function get(){return this._button.sizeGrid;},set:function set(value){this._button.sizeGrid=value;}},{key:"scrollBar",get:function get(){return this.list.scrollBar;}},{key:"button",get:function get(){return this._button;}},{key:"list",get:function get(){this._list||this._createList();return this._list;},set:function set(value){if(value){value.removeSelf();this._isCustomList=true;this._list=value;this._setListEvent(value);this._itemHeight=value.getCell(0).height+value.spaceY;}}},{key:"dataSource",set:function set(value){this._dataSource=value;if(typeof value=='number'||typeof value=='string')this.selectedIndex=parseInt(value);else if(value instanceof Array)this.labels=value.join(",");else _set(ComboBox.prototype.__proto__||Object.getPrototypeOf(ComboBox.prototype),"dataSource",value,this);},get:function get(){return _get(ComboBox.prototype.__proto__||Object.getPrototypeOf(ComboBox.prototype),"dataSource",this);}},{key:"labelColors",get:function get(){return this._button.labelColors;},set:function set(value){if(this._button.labelColors!=value){this._button.labelColors=value;}}},{key:"labelPadding",get:function get(){return this._button.text.padding.join(",");},set:function set(value){this._button.text.padding=UIUtils.fillArray(Styles.labelPadding,value,Number);}},{key:"labelSize",get:function get(){return this._button.text.fontSize;},set:function set(value){this._button.text.fontSize=value;}},{key:"labelBold",get:function get(){return this._button.text.bold;},set:function set(value){this._button.text.bold=value;}},{key:"labelFont",get:function get(){return this._button.text.font;},set:function set(value){this._button.text.font=value;}},{key:"stateNum",get:function get(){return this._button.stateNum;},set:function set(value){this._button.stateNum=value;}}]);return ComboBox;}(UIComponent);Laya.ILaya.regClass(ComboBox);Laya.ClassUtils.regClass("laya.ui.ComboBox",ComboBox);Laya.ClassUtils.regClass("Laya.ComboBox",ComboBox);var ProgressBar=function(_UIComponent10){_inherits(ProgressBar,_UIComponent10);function ProgressBar(){var skin=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;_classCallCheck(this,ProgressBar);var _this92=_possibleConstructorReturn(this,(ProgressBar.__proto__||Object.getPrototypeOf(ProgressBar)).call(this));_this92._value=0.5;_this92.skin=skin;return _this92;}_createClass(ProgressBar,[{key:"destroy",value:function destroy(){var destroyChild=arguments.length>0&&arguments[0]!==undefined?arguments[0]:true;_get(ProgressBar.prototype.__proto__||Object.getPrototypeOf(ProgressBar.prototype),"destroy",this).call(this,destroyChild);this._bg&&this._bg.destroy(destroyChild);this._bar&&this._bar.destroy(destroyChild);this._bg=this._bar=null;this.changeHandler=null;}},{key:"createChildren",value:function createChildren(){this.addChild(this._bg=new Image());this.addChild(this._bar=new Image());this._bar._bitmap.autoCacheCmd=false;}},{key:"_skinLoaded",value:function _skinLoaded(){this._bg.skin=this._skin;this._bar.skin=this._skin.replace(".png","$bar.png");this.callLater(this.changeValue);this._sizeChanged();this.event(Laya.Event.LOADED);}},{key:"measureWidth",value:function measureWidth(){return this._bg.width;}},{key:"measureHeight",value:function measureHeight(){return this._bg.height;}},{key:"changeValue",value:function changeValue(){if(this.sizeGrid){var grid=this.sizeGrid.split(",");var left=Number(grid[3]);var right=Number(grid[1]);var max=this.width-left-right;var sw=max*this._value;this._bar.width=left+right+sw;this._bar.visible=this._bar.width>left+right;}else{this._bar.width=this.width*this._value;}}},{key:"skin",get:function get(){return this._skin;},set:function set(value){if(this._skin!=value){this._skin=value;if(this._skin&&!Laya.Loader.getRes(this._skin)){Laya.ILaya.loader.load(this._skin,Laya.Handler.create(this,this._skinLoaded),null,Laya.Loader.IMAGE,1);}else{this._skinLoaded();}}}},{key:"value",get:function get(){return this._value;},set:function set(num){if(this._value!=num){num=num>1?1:num<0?0:num;this._value=num;this.callLater(this.changeValue);this.event(Laya.Event.CHANGE);this.changeHandler&&this.changeHandler.runWith(num);}}},{key:"bar",get:function get(){return this._bar;}},{key:"bg",get:function get(){return this._bg;}},{key:"sizeGrid",get:function get(){return this._bg.sizeGrid;},set:function set(value){this._bg.sizeGrid=this._bar.sizeGrid=value;}},{key:"width",set:function set(value){_set(ProgressBar.prototype.__proto__||Object.getPrototypeOf(ProgressBar.prototype),"width",value,this);this._bg.width=this._width;this.callLater(this.changeValue);},get:function get(){return _get(ProgressBar.prototype.__proto__||Object.getPrototypeOf(ProgressBar.prototype),"width",this);}},{key:"height",set:function set(value){_set(ProgressBar.prototype.__proto__||Object.getPrototypeOf(ProgressBar.prototype),"height",value,this);this._bg.height=this._height;this._bar.height=this._height;},get:function get(){return _get(ProgressBar.prototype.__proto__||Object.getPrototypeOf(ProgressBar.prototype),"height",this);}},{key:"dataSource",set:function set(value){this._dataSource=value;if(typeof value=='number'||typeof value=='string')this.value=Number(value);else _set(ProgressBar.prototype.__proto__||Object.getPrototypeOf(ProgressBar.prototype),"dataSource",value,this);},get:function get(){return _get(ProgressBar.prototype.__proto__||Object.getPrototypeOf(ProgressBar.prototype),"dataSource",this);}}]);return ProgressBar;}(UIComponent);Laya.ILaya.regClass(ProgressBar);Laya.ClassUtils.regClass("laya.ui.ProgressBar",ProgressBar);Laya.ClassUtils.regClass("Laya.ProgressBar",ProgressBar);var Radio=function(_Button2){_inherits(Radio,_Button2);function Radio(){var skin=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;var label=arguments.length>1&&arguments[1]!==undefined?arguments[1]:"";_classCallCheck(this,Radio);var _this93=_possibleConstructorReturn(this,(Radio.__proto__||Object.getPrototypeOf(Radio)).call(this,skin,label));_this93.toggle=false;_this93._autoSize=false;return _this93;}_createClass(Radio,[{key:"destroy",value:function destroy(){var destroyChild=arguments.length>0&&arguments[0]!==undefined?arguments[0]:true;_get(Radio.prototype.__proto__||Object.getPrototypeOf(Radio.prototype),"destroy",this).call(this,destroyChild);this._value=null;}},{key:"preinitialize",value:function preinitialize(){_get(Radio.prototype.__proto__||Object.getPrototypeOf(Radio.prototype),"preinitialize",this).call(this);this.toggle=false;this._autoSize=false;}},{key:"initialize",value:function initialize(){_get(Radio.prototype.__proto__||Object.getPrototypeOf(Radio.prototype),"initialize",this).call(this);this.createText();this._text.align="left";this._text.valign="top";this._text.width=0;this.on(Laya.Event.CLICK,this,this.onClick);}},{key:"onClick",value:function onClick(e){this.selected=true;}},{key:"value",get:function get(){return this._value!=null?this._value:this.label;},set:function set(obj){this._value=obj;}}]);return Radio;}(Button);Laya.ILaya.regClass(Radio);Laya.ClassUtils.regClass("laya.ui.Radio",Radio);Laya.ClassUtils.regClass("Laya.Radio",Radio);var UIGroup=function(_Box2){_inherits(UIGroup,_Box2);function UIGroup(){var labels=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;var skin=arguments.length>1&&arguments[1]!==undefined?arguments[1]:null;_classCallCheck(this,UIGroup);var _this94=_possibleConstructorReturn(this,(UIGroup.__proto__||Object.getPrototypeOf(UIGroup)).call(this));_this94._selectedIndex=-1;_this94._direction="horizontal";_this94._space=0;_this94.skin=skin;_this94.labels=labels;return _this94;}_createClass(UIGroup,[{key:"preinitialize",value:function preinitialize(){this.mouseEnabled=true;}},{key:"destroy",value:function destroy(){var destroyChild=arguments.length>0&&arguments[0]!==undefined?arguments[0]:true;_get(UIGroup.prototype.__proto__||Object.getPrototypeOf(UIGroup.prototype),"destroy",this).call(this,destroyChild);this._items&&(this._items.length=0);this._items=null;this.selectHandler=null;}},{key:"addItem",value:function addItem(item){var autoLayOut=arguments.length>1&&arguments[1]!==undefined?arguments[1]:true;var display=item;var index=this._items.length;display.name="item"+index;this.addChild(display);this.initItems();if(autoLayOut&&index>0){var preItem=this._items[index-1];if(this._direction=="horizontal"){display.x=preItem._x+preItem.width+this._space;}else{display.y=preItem._y+preItem.height+this._space;}}else{if(autoLayOut){display.x=0;display.y=0;}}return index;}},{key:"delItem",value:function delItem(item){var autoLayOut=arguments.length>1&&arguments[1]!==undefined?arguments[1]:true;var index=this._items.indexOf(item);if(index!=-1){var display=item;this.removeChild(display);for(var i=index+1,n=this._items.length;i<n;i++){var child=this._items[i];child.name="item"+(i-1);if(autoLayOut){if(this._direction=="horizontal"){child.x-=display.width+this._space;}else{child.y-=display.height+this._space;}}}this.initItems();if(this._selectedIndex>-1){var newIndex;newIndex=this._selectedIndex<this._items.length?this._selectedIndex:this._selectedIndex-1;this._selectedIndex=-1;this.selectedIndex=newIndex;}}}},{key:"_afterInited",value:function _afterInited(){this.initItems();}},{key:"initItems",value:function initItems(){this._items||(this._items=[]);this._items.length=0;for(var i=0;i<10000;i++){var item=this.getChildByName("item"+i);if(item==null)break;this._items.push(item);item.selected=i===this._selectedIndex;item.clickHandler=Laya.Handler.create(this,this.itemClick,[i],false);}}},{key:"itemClick",value:function itemClick(index){this.selectedIndex=index;}},{key:"setSelect",value:function setSelect(index,selected){if(this._items&&index>-1&&index<this._items.length)this._items[index].selected=selected;}},{key:"_skinLoaded",value:function _skinLoaded(){this._setLabelChanged();this.event(Laya.Event.LOADED);}},{key:"createItem",value:function createItem(skin,label){return null;}},{key:"changeLabels",value:function changeLabels(){this._labelChanged=false;if(this._items){var left=0;for(var i=0,n=this._items.length;i<n;i++){var btn=this._items[i];this._skin&&(btn.skin=this._skin);this._labelColors&&(btn.labelColors=this._labelColors);this._labelSize&&(btn.labelSize=this._labelSize);this._labelStroke&&(btn.labelStroke=this._labelStroke);this._labelStrokeColor&&(btn.labelStrokeColor=this._labelStrokeColor);this._strokeColors&&(btn.strokeColors=this._strokeColors);this._labelBold&&(btn.labelBold=this._labelBold);this._labelPadding&&(btn.labelPadding=this._labelPadding);this._labelAlign&&(btn.labelAlign=this._labelAlign);this._stateNum&&(btn.stateNum=this._stateNum);this._labelFont&&(btn.labelFont=this._labelFont);if(this._direction==="horizontal"){btn.y=0;btn.x=left;left+=btn.width+this._space;}else{btn.x=0;btn.y=left;left+=btn.height+this._space;}}}this._sizeChanged();}},{key:"commitMeasure",value:function commitMeasure(){this.runCallLater(this.changeLabels);}},{key:"_setLabelChanged",value:function _setLabelChanged(){if(!this._labelChanged){this._labelChanged=true;this.callLater(this.changeLabels);}}},{key:"selectedIndex",get:function get(){return this._selectedIndex;},set:function set(value){if(this._selectedIndex!=value){this.setSelect(this._selectedIndex,false);this._selectedIndex=value;this.setSelect(value,true);this.event(Laya.Event.CHANGE);this.selectHandler&&this.selectHandler.runWith(this._selectedIndex);}}},{key:"skin",get:function get(){return this._skin;},set:function set(value){if(this._skin!=value){this._skin=value;if(this._skin&&!Laya.Loader.getRes(this._skin)){Laya.ILaya.loader.load(this._skin,Laya.Handler.create(this,this._skinLoaded),null,Laya.Loader.IMAGE,1);}else{this._skinLoaded();}}}},{key:"labels",get:function get(){return this._labels;},set:function set(value){if(this._labels!=value){this._labels=value;this.removeChildren();this._setLabelChanged();if(this._labels){var a=this._labels.split(",");for(var i=0,n=a.length;i<n;i++){var item=this.createItem(this._skin,a[i]);item.name="item"+i;this.addChild(item);}}this.initItems();}}},{key:"labelColors",get:function get(){return this._labelColors;},set:function set(value){if(this._labelColors!=value){this._labelColors=value;this._setLabelChanged();}}},{key:"labelStroke",get:function get(){return this._labelStroke;},set:function set(value){if(this._labelStroke!=value){this._labelStroke=value;this._setLabelChanged();}}},{key:"labelStrokeColor",get:function get(){return this._labelStrokeColor;},set:function set(value){if(this._labelStrokeColor!=value){this._labelStrokeColor=value;this._setLabelChanged();}}},{key:"strokeColors",get:function get(){return this._strokeColors;},set:function set(value){if(this._strokeColors!=value){this._strokeColors=value;this._setLabelChanged();}}},{key:"labelSize",get:function get(){return this._labelSize;},set:function set(value){if(this._labelSize!=value){this._labelSize=value;this._setLabelChanged();}}},{key:"stateNum",get:function get(){return this._stateNum;},set:function set(value){if(this._stateNum!=value){this._stateNum=value;this._setLabelChanged();}}},{key:"labelBold",get:function get(){return this._labelBold;},set:function set(value){if(this._labelBold!=value){this._labelBold=value;this._setLabelChanged();}}},{key:"labelFont",get:function get(){return this._labelFont;},set:function set(value){if(this._labelFont!=value){this._labelFont=value;this._setLabelChanged();}}},{key:"labelPadding",get:function get(){return this._labelPadding;},set:function set(value){if(this._labelPadding!=value){this._labelPadding=value;this._setLabelChanged();}}},{key:"direction",get:function get(){return this._direction;},set:function set(value){this._direction=value;this._setLabelChanged();}},{key:"space",get:function get(){return this._space;},set:function set(value){this._space=value;this._setLabelChanged();}},{key:"items",get:function get(){return this._items;}},{key:"selection",get:function get(){return this._selectedIndex>-1&&this._selectedIndex<this._items.length?this._items[this._selectedIndex]:null;},set:function set(value){this.selectedIndex=this._items.indexOf(value);}},{key:"dataSource",set:function set(value){this._dataSource=value;if(typeof value=='number'||typeof value=='string')this.selectedIndex=parseInt(value);else if(value instanceof Array)this.labels=value.join(",");else _set(UIGroup.prototype.__proto__||Object.getPrototypeOf(UIGroup.prototype),"dataSource",value,this);},get:function get(){return _get(UIGroup.prototype.__proto__||Object.getPrototypeOf(UIGroup.prototype),"dataSource",this);}}]);return UIGroup;}(Box);Laya.ILaya.regClass(UIGroup);Laya.ClassUtils.regClass("laya.ui.UIGroup",UIGroup);Laya.ClassUtils.regClass("Laya.UIGroup",UIGroup);var RadioGroup=function(_UIGroup){_inherits(RadioGroup,_UIGroup);function RadioGroup(){_classCallCheck(this,RadioGroup);return _possibleConstructorReturn(this,(RadioGroup.__proto__||Object.getPrototypeOf(RadioGroup)).apply(this,arguments));}_createClass(RadioGroup,[{key:"createItem",value:function createItem(skin,label){return new Radio(skin,label);}}]);return RadioGroup;}(UIGroup);Laya.ILaya.regClass(RadioGroup);Laya.ClassUtils.regClass("laya.ui.RadioGroup",RadioGroup);Laya.ClassUtils.regClass("Laya.RadioGroup",RadioGroup);var Tab=function(_UIGroup2){_inherits(Tab,_UIGroup2);function Tab(){_classCallCheck(this,Tab);return _possibleConstructorReturn(this,(Tab.__proto__||Object.getPrototypeOf(Tab)).apply(this,arguments));}_createClass(Tab,[{key:"createItem",value:function createItem(skin,label){return new Button(skin,label);}}]);return Tab;}(UIGroup);Laya.ILaya.regClass(Tab);Laya.ClassUtils.regClass("laya.ui.Tab",Tab);Laya.ClassUtils.regClass("Laya.Tab",Tab);var ViewStack=function(_Box3){_inherits(ViewStack,_Box3);function ViewStack(){_classCallCheck(this,ViewStack);var _this97=_possibleConstructorReturn(this,(ViewStack.__proto__||Object.getPrototypeOf(ViewStack)).apply(this,arguments));_this97._setIndexHandler=Laya.Handler.create(_this97,_this97.setIndex,null,false);return _this97;}_createClass(ViewStack,[{key:"setItems",value:function setItems(views){this.removeChildren();var index=0;for(var i=0,n=views.length;i<n;i++){var item=views[i];if(item){item.name="item"+index;this.addChild(item);index++;}}this.initItems();}},{key:"addItem",value:function addItem(view){view.name="item"+this._items.length;this.addChild(view);this.initItems();}},{key:"_afterInited",value:function _afterInited(){this.initItems();}},{key:"initItems",value:function initItems(){this._items=[];for(var i=0;i<10000;i++){var item=this.getChildByName("item"+i);if(item==null){break;}this._items.push(item);item.visible=i==this._selectedIndex;}}},{key:"setSelect",value:function setSelect(index,selected){if(this._items&&index>-1&&index<this._items.length){this._items[index].visible=selected;}}},{key:"setIndex",value:function setIndex(index){this.selectedIndex=index;}},{key:"selectedIndex",get:function get(){return this._selectedIndex;},set:function set(value){if(this._selectedIndex!=value){this.setSelect(this._selectedIndex,false);this._selectedIndex=value;this.setSelect(this._selectedIndex,true);}}},{key:"selection",get:function get(){return this._selectedIndex>-1&&this._selectedIndex<this._items.length?this._items[this._selectedIndex]:null;},set:function set(value){this.selectedIndex=this._items.indexOf(value);}},{key:"setIndexHandler",get:function get(){return this._setIndexHandler;},set:function set(value){this._setIndexHandler=value;}},{key:"items",get:function get(){return this._items;}},{key:"dataSource",set:function set(value){this._dataSource=value;if(typeof value=='number'||typeof value=='string'){this.selectedIndex=parseInt(value);}else{for(var prop in this._dataSource){if(prop in this){this[prop]=this._dataSource[prop];}}}},get:function get(){return _get(ViewStack.prototype.__proto__||Object.getPrototypeOf(ViewStack.prototype),"dataSource",this);}}]);return ViewStack;}(Box);Laya.ILaya.regClass(ViewStack);Laya.ClassUtils.regClass("laya.ui.ViewStack",ViewStack);Laya.ClassUtils.regClass("Laya.ViewStack",ViewStack);var TextInput=function(_Label){_inherits(TextInput,_Label);function TextInput(){var text=arguments.length>0&&arguments[0]!==undefined?arguments[0]:"";_classCallCheck(this,TextInput);var _this98=_possibleConstructorReturn(this,(TextInput.__proto__||Object.getPrototypeOf(TextInput)).call(this));_this98.text=text;_this98.skin=_this98.skin;return _this98;}_createClass(TextInput,[{key:"preinitialize",value:function preinitialize(){this.mouseEnabled=true;}},{key:"destroy",value:function destroy(){var destroyChild=arguments.length>0&&arguments[0]!==undefined?arguments[0]:true;_get(TextInput.prototype.__proto__||Object.getPrototypeOf(TextInput.prototype),"destroy",this).call(this,destroyChild);this._bg&&this._bg.destroy();this._bg=null;}},{key:"createChildren",value:function createChildren(){this.addChild(this._tf=new Laya.Input());this._tf.padding=Styles.inputLabelPadding;this._tf.on(Laya.Event.INPUT,this,this._onInput);this._tf.on(Laya.Event.ENTER,this,this._onEnter);this._tf.on(Laya.Event.BLUR,this,this._onBlur);this._tf.on(Laya.Event.FOCUS,this,this._onFocus);}},{key:"_onFocus",value:function _onFocus(){this.event(Laya.Event.FOCUS,this);}},{key:"_onBlur",value:function _onBlur(){this.event(Laya.Event.BLUR,this);}},{key:"_onInput",value:function _onInput(){this.event(Laya.Event.INPUT,this);}},{key:"_onEnter",value:function _onEnter(){this.event(Laya.Event.ENTER,this);}},{key:"initialize",value:function initialize(){this.width=128;this.height=22;}},{key:"_skinLoaded",value:function _skinLoaded(){this._bg||(this.graphics=this._bg=new AutoBitmap());this._bg.source=Laya.Loader.getRes(this._skin);this._width&&(this._bg.width=this._width);this._height&&(this._bg.height=this._height);this._sizeChanged();this.event(Laya.Event.LOADED);}},{key:"select",value:function select(){this._tf.select();}},{key:"setSelection",value:function setSelection(startIndex,endIndex){this._tf.setSelection(startIndex,endIndex);}},{key:"bg",get:function get(){return this._bg;},set:function set(value){this.graphics=this._bg=value;}},{key:"skin",get:function get(){return this._skin;},set:function set(value){if(this._skin!=value){this._skin=value;if(this._skin&&!Laya.Loader.getRes(this._skin)){Laya.ILaya.loader.load(this._skin,Laya.Handler.create(this,this._skinLoaded),null,Laya.Loader.IMAGE,1);}else{this._skinLoaded();}}}},{key:"sizeGrid",get:function get(){return this._bg&&this._bg.sizeGrid?this._bg.sizeGrid.join(","):null;},set:function set(value){this._bg||(this.graphics=this._bg=new AutoBitmap());this._bg.sizeGrid=UIUtils.fillArray(Styles.defaultSizeGrid,value,Number);}},{key:"text",set:function set(value){if(this._tf.text!=value){value=value+"";this._tf.text=value;this.event(Laya.Event.CHANGE);}},get:function get(){return _get(TextInput.prototype.__proto__||Object.getPrototypeOf(TextInput.prototype),"text",this);}},{key:"width",set:function set(value){_set(TextInput.prototype.__proto__||Object.getPrototypeOf(TextInput.prototype),"width",value,this);this._bg&&(this._bg.width=value);},get:function get(){return _get(TextInput.prototype.__proto__||Object.getPrototypeOf(TextInput.prototype),"width",this);}},{key:"height",set:function set(value){_set(TextInput.prototype.__proto__||Object.getPrototypeOf(TextInput.prototype),"height",value,this);this._bg&&(this._bg.height=value);},get:function get(){return _get(TextInput.prototype.__proto__||Object.getPrototypeOf(TextInput.prototype),"height",this);}},{key:"multiline",get:function get(){return this._tf.multiline;},set:function set(value){this._tf.multiline=value;}},{key:"editable",set:function set(value){this._tf.editable=value;},get:function get(){return this._tf.editable;}},{key:"restrict",get:function get(){return this._tf.restrict;},set:function set(pattern){this._tf.restrict=pattern;}},{key:"prompt",get:function get(){return this._tf.prompt;},set:function set(value){this._tf.prompt=value;}},{key:"promptColor",get:function get(){return this._tf.promptColor;},set:function set(value){this._tf.promptColor=value;}},{key:"maxChars",get:function get(){return this._tf.maxChars;},set:function set(value){this._tf.maxChars=value;}},{key:"focus",get:function get(){return this._tf.focus;},set:function set(value){this._tf.focus=value;}},{key:"type",get:function get(){return this._tf.type;},set:function set(value){this._tf.type=value;}}]);return TextInput;}(Label);Laya.ILaya.regClass(TextInput);Laya.ClassUtils.regClass("laya.ui.TextInput",TextInput);Laya.ClassUtils.regClass("Laya.TextInput",TextInput);var TextArea=function(_TextInput){_inherits(TextArea,_TextInput);function TextArea(){var text=arguments.length>0&&arguments[0]!==undefined?arguments[0]:"";_classCallCheck(this,TextArea);var _this99=_possibleConstructorReturn(this,(TextArea.__proto__||Object.getPrototypeOf(TextArea)).call(this,text));_this99.on(Laya.Event.CHANGE,_this99,_this99._onTextChange);return _this99;}_createClass(TextArea,[{key:"_onTextChange",value:function _onTextChange(){this.callLater(this.changeScroll);}},{key:"destroy",value:function destroy(){var destroyChild=arguments.length>0&&arguments[0]!==undefined?arguments[0]:true;this._vScrollBar&&this._vScrollBar.destroy();this._hScrollBar&&this._hScrollBar.destroy();this._vScrollBar=null;this._hScrollBar=null;_get(TextArea.prototype.__proto__||Object.getPrototypeOf(TextArea.prototype),"destroy",this).call(this,destroyChild);}},{key:"initialize",value:function initialize(){this.width=180;this.height=150;this._tf.wordWrap=true;this.multiline=true;}},{key:"onVBarChanged",value:function onVBarChanged(e){if(this._tf.scrollY!=this._vScrollBar.value){this._tf.scrollY=this._vScrollBar.value;}}},{key:"onHBarChanged",value:function onHBarChanged(e){if(this._tf.scrollX!=this._hScrollBar.value){this._tf.scrollX=this._hScrollBar.value;}}},{key:"changeScroll",value:function changeScroll(){var vShow=this._vScrollBar&&this._tf.maxScrollY>0;var hShow=this._hScrollBar&&this._tf.maxScrollX>0;var showWidth=vShow?this._width-this._vScrollBar.width:this._width;var showHeight=hShow?this._height-this._hScrollBar.height:this._height;var padding=this._tf.padding||Styles.labelPadding;this._tf.width=showWidth;this._tf.height=showHeight;if(this._vScrollBar){this._vScrollBar.x=this._width-this._vScrollBar.width-padding[2];this._vScrollBar.y=padding[1];this._vScrollBar.height=this._height-(hShow?this._hScrollBar.height:0)-padding[1]-padding[3];this._vScrollBar.scrollSize=1;this._vScrollBar.thumbPercent=showHeight/Math.max(this._tf.textHeight,showHeight);this._vScrollBar.setScroll(1,this._tf.maxScrollY,this._tf.scrollY);this._vScrollBar.visible=vShow;}if(this._hScrollBar){this._hScrollBar.x=padding[0];this._hScrollBar.y=this._height-this._hScrollBar.height-padding[3];this._hScrollBar.width=this._width-(vShow?this._vScrollBar.width:0)-padding[0]-padding[2];this._hScrollBar.scrollSize=Math.max(showWidth*0.033,1);this._hScrollBar.thumbPercent=showWidth/Math.max(this._tf.textWidth,showWidth);this._hScrollBar.setScroll(0,this.maxScrollX,this.scrollX);this._hScrollBar.visible=hShow;}}},{key:"scrollTo",value:function scrollTo(y){this.commitMeasure();this._tf.scrollY=y;}},{key:"width",set:function set(value){_set(TextArea.prototype.__proto__||Object.getPrototypeOf(TextArea.prototype),"width",value,this);this.callLater(this.changeScroll);},get:function get(){return _get(TextArea.prototype.__proto__||Object.getPrototypeOf(TextArea.prototype),"width",this);}},{key:"height",set:function set(value){_set(TextArea.prototype.__proto__||Object.getPrototypeOf(TextArea.prototype),"height",value,this);this.callLater(this.changeScroll);},get:function get(){return _get(TextArea.prototype.__proto__||Object.getPrototypeOf(TextArea.prototype),"height",this);}},{key:"vScrollBarSkin",get:function get(){return this._vScrollBar?this._vScrollBar.skin:null;},set:function set(value){if(this._vScrollBar==null){this.addChild(this._vScrollBar=new VScrollBar());this._vScrollBar.on(Laya.Event.CHANGE,this,this.onVBarChanged);this._vScrollBar.target=this._tf;this.callLater(this.changeScroll);}this._vScrollBar.skin=value;}},{key:"hScrollBarSkin",get:function get(){return this._hScrollBar?this._hScrollBar.skin:null;},set:function set(value){if(this._hScrollBar==null){this.addChild(this._hScrollBar=new HScrollBar());this._hScrollBar.on(Laya.Event.CHANGE,this,this.onHBarChanged);this._hScrollBar.mouseWheelEnable=false;this._hScrollBar.target=this._tf;this.callLater(this.changeScroll);}this._hScrollBar.skin=value;}},{key:"vScrollBar",get:function get(){return this._vScrollBar;}},{key:"hScrollBar",get:function get(){return this._hScrollBar;}},{key:"maxScrollY",get:function get(){return this._tf.maxScrollY;}},{key:"scrollY",get:function get(){return this._tf.scrollY;}},{key:"maxScrollX",get:function get(){return this._tf.maxScrollX;}},{key:"scrollX",get:function get(){return this._tf.scrollX;}}]);return TextArea;}(TextInput);Laya.ILaya.regClass(TextArea);Laya.ClassUtils.regClass("laya.ui.TextArea",TextArea);Laya.ClassUtils.regClass("Laya.TextArea",TextArea);var ScaleBox=function(_Box4){_inherits(ScaleBox,_Box4);function ScaleBox(){_classCallCheck(this,ScaleBox);var _this100=_possibleConstructorReturn(this,(ScaleBox.__proto__||Object.getPrototypeOf(ScaleBox)).apply(this,arguments));_this100._oldW=0;_this100._oldH=0;return _this100;}_createClass(ScaleBox,[{key:"onEnable",value:function onEnable(){Laya.ILaya.stage.on("resize",this,this.onResize);this.onResize();}},{key:"onDisable",value:function onDisable(){Laya.ILaya.stage.off("resize",this,this.onResize);}},{key:"onResize",value:function onResize(){var stage=Laya.ILaya.stage;if(this.width>0&&this.height>0){var scale=Math.min(stage.width/this._oldW,stage.height/this._oldH);_set(ScaleBox.prototype.__proto__||Object.getPrototypeOf(ScaleBox.prototype),"width",stage.width,this);_set(ScaleBox.prototype.__proto__||Object.getPrototypeOf(ScaleBox.prototype),"height",stage.height,this);this.scale(scale,scale);}}},{key:"width",set:function set(value){_set(ScaleBox.prototype.__proto__||Object.getPrototypeOf(ScaleBox.prototype),"width",value,this);this._oldW=value;},get:function get(){return _get(ScaleBox.prototype.__proto__||Object.getPrototypeOf(ScaleBox.prototype),"width",this);}},{key:"height",set:function set(value){_set(ScaleBox.prototype.__proto__||Object.getPrototypeOf(ScaleBox.prototype),"height",value,this);this._oldH=value;},get:function get(){return _get(ScaleBox.prototype.__proto__||Object.getPrototypeOf(ScaleBox.prototype),"height",this);}}]);return ScaleBox;}(Box);Laya.ILaya.regClass(ScaleBox);Laya.ClassUtils.regClass("laya.ui.ScaleBox",ScaleBox);Laya.ClassUtils.regClass("Laya.ScaleBox",ScaleBox);var HSlider=function(_Slider){_inherits(HSlider,_Slider);function HSlider(){var skin=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;_classCallCheck(this,HSlider);var _this101=_possibleConstructorReturn(this,(HSlider.__proto__||Object.getPrototypeOf(HSlider)).call(this,skin));_this101.isVertical=false;return _this101;}return HSlider;}(Slider);Laya.ILaya.regClass(HSlider);Laya.ClassUtils.regClass("laya.ui.HSlider",HSlider);Laya.ClassUtils.regClass("Laya.HSlider",HSlider);var Panel=function(_Box5){_inherits(Panel,_Box5);function Panel(){_classCallCheck(this,Panel);var _this102=_possibleConstructorReturn(this,(Panel.__proto__||Object.getPrototypeOf(Panel)).call(this));_this102._usedCache=null;_this102._elasticEnabled=false;_this102.width=_this102.height=100;return _this102;}_createClass(Panel,[{key:"destroy",value:function destroy(){var destroyChild=arguments.length>0&&arguments[0]!==undefined?arguments[0]:true;_get(Panel.prototype.__proto__||Object.getPrototypeOf(Panel.prototype),"destroy",this).call(this,destroyChild);this._content&&this._content.destroy(destroyChild);this._vScrollBar&&this._vScrollBar.destroy(destroyChild);this._hScrollBar&&this._hScrollBar.destroy(destroyChild);this._vScrollBar=null;this._hScrollBar=null;this._content=null;}},{key:"destroyChildren",value:function destroyChildren(){this._content.destroyChildren();}},{key:"createChildren",value:function createChildren(){_get(Panel.prototype.__proto__||Object.getPrototypeOf(Panel.prototype),"addChild",this).call(this,this._content=new Box());}},{key:"addChild",value:function addChild(child){child.on(Laya.Event.RESIZE,this,this.onResize);this._setScrollChanged();return this._content.addChild(child);}},{key:"onResize",value:function onResize(){this._setScrollChanged();}},{key:"addChildAt",value:function addChildAt(child,index){child.on(Laya.Event.RESIZE,this,this.onResize);this._setScrollChanged();return this._content.addChildAt(child,index);}},{key:"removeChild",value:function removeChild(child){child.off(Laya.Event.RESIZE,this,this.onResize);this._setScrollChanged();return this._content.removeChild(child);}},{key:"removeChildAt",value:function removeChildAt(index){this.getChildAt(index).off(Laya.Event.RESIZE,this,this.onResize);this._setScrollChanged();return this._content.removeChildAt(index);}},{key:"removeChildren",value:function removeChildren(){var beginIndex=arguments.length>0&&arguments[0]!==undefined?arguments[0]:0;var endIndex=arguments.length>1&&arguments[1]!==undefined?arguments[1]:0x7fffffff;this._content.removeChildren(beginIndex,endIndex);this._setScrollChanged();return this;}},{key:"getChildAt",value:function getChildAt(index){return this._content.getChildAt(index);}},{key:"getChildByName",value:function getChildByName(name){return this._content.getChildByName(name);}},{key:"getChildIndex",value:function getChildIndex(child){return this._content.getChildIndex(child);}},{key:"changeScroll",value:function changeScroll(){this._scrollChanged=false;var contentW=this.contentWidth||1;var contentH=this.contentHeight||1;var vscroll=this._vScrollBar;var hscroll=this._hScrollBar;var vShow=vscroll&&contentH>this._height;var hShow=hscroll&&contentW>this._width;var showWidth=vShow?this._width-vscroll.width:this._width;var showHeight=hShow?this._height-hscroll.height:this._height;if(vscroll){vscroll.x=this._width-vscroll.width;vscroll.y=0;vscroll.height=this._height-(hShow?hscroll.height:0);vscroll.scrollSize=Math.max(this._height*0.033,1);vscroll.thumbPercent=showHeight/contentH;vscroll.setScroll(0,contentH-showHeight,vscroll.value);}if(hscroll){hscroll.x=0;hscroll.y=this._height-hscroll.height;hscroll.width=this._width-(vShow?vscroll.width:0);hscroll.scrollSize=Math.max(this._width*0.033,1);hscroll.thumbPercent=showWidth/contentW;hscroll.setScroll(0,contentW-showWidth,hscroll.value);}}},{key:"_sizeChanged",value:function _sizeChanged(){_get(Panel.prototype.__proto__||Object.getPrototypeOf(Panel.prototype),"_sizeChanged",this).call(this);this.setContentSize(this._width,this._height);}},{key:"setContentSize",value:function setContentSize(width,height){var content=this._content;content.width=width;content.height=height;content._style.scrollRect||(content.scrollRect=Laya.Rectangle.create());content._style.scrollRect.setTo(0,0,width,height);content.scrollRect=content.scrollRect;}},{key:"onScrollBarChange",value:function onScrollBarChange(scrollBar){var rect=this._content._style.scrollRect;if(rect){var start=Math.round(scrollBar.value);scrollBar.isVertical?rect.y=start:rect.x=start;this._content.scrollRect=rect;}}},{key:"scrollTo",value:function scrollTo(){var x=arguments.length>0&&arguments[0]!==undefined?arguments[0]:0;var y=arguments.length>1&&arguments[1]!==undefined?arguments[1]:0;if(this.vScrollBar)this.vScrollBar.value=y;if(this.hScrollBar)this.hScrollBar.value=x;}},{key:"refresh",value:function refresh(){this.changeScroll();}},{key:"onScrollStart",value:function onScrollStart(){this._usedCache||(this._usedCache=_get(Panel.prototype.__proto__||Object.getPrototypeOf(Panel.prototype),"cacheAs",this));_set(Panel.prototype.__proto__||Object.getPrototypeOf(Panel.prototype),"cacheAs","none",this);this._hScrollBar&&this._hScrollBar.once(Laya.Event.END,this,this.onScrollEnd);this._vScrollBar&&this._vScrollBar.once(Laya.Event.END,this,this.onScrollEnd);}},{key:"onScrollEnd",value:function onScrollEnd(){_set(Panel.prototype.__proto__||Object.getPrototypeOf(Panel.prototype),"cacheAs",this._usedCache,this);}},{key:"_setScrollChanged",value:function _setScrollChanged(){if(!this._scrollChanged){this._scrollChanged=true;this.callLater(this.changeScroll);}}},{key:"numChildren",get:function get(){return this._content.numChildren;}},{key:"contentWidth",get:function get(){var max=0;for(var i=this._content.numChildren-1;i>-1;i--){var comp=this._content.getChildAt(i);max=Math.max(comp._x+comp.width*comp.scaleX-comp.pivotX,max);}return max;}},{key:"contentHeight",get:function get(){var max=0;for(var i=this._content.numChildren-1;i>-1;i--){var comp=this._content.getChildAt(i);max=Math.max(comp._y+comp.height*comp.scaleY-comp.pivotY,max);}return max;}},{key:"width",set:function set(value){_set(Panel.prototype.__proto__||Object.getPrototypeOf(Panel.prototype),"width",value,this);this._setScrollChanged();},get:function get(){return _get(Panel.prototype.__proto__||Object.getPrototypeOf(Panel.prototype),"width",this);}},{key:"height",set:function set(value){_set(Panel.prototype.__proto__||Object.getPrototypeOf(Panel.prototype),"height",value,this);this._setScrollChanged();},get:function get(){return _get(Panel.prototype.__proto__||Object.getPrototypeOf(Panel.prototype),"height",this);}},{key:"vScrollBarSkin",get:function get(){return this._vScrollBar?this._vScrollBar.skin:null;},set:function set(value){if(this._vScrollBar==null){_get(Panel.prototype.__proto__||Object.getPrototypeOf(Panel.prototype),"addChild",this).call(this,this._vScrollBar=new VScrollBar());this._vScrollBar.on(Laya.Event.CHANGE,this,this.onScrollBarChange,[this._vScrollBar]);this._vScrollBar.target=this._content;this._vScrollBar.elasticDistance=this._elasticEnabled?200:0;this._setScrollChanged();}this._vScrollBar.skin=value;}},{key:"hScrollBarSkin",get:function get(){return this._hScrollBar?this._hScrollBar.skin:null;},set:function set(value){if(this._hScrollBar==null){_get(Panel.prototype.__proto__||Object.getPrototypeOf(Panel.prototype),"addChild",this).call(this,this._hScrollBar=new HScrollBar());this._hScrollBar.on(Laya.Event.CHANGE,this,this.onScrollBarChange,[this._hScrollBar]);this._hScrollBar.target=this._content;this._hScrollBar.elasticDistance=this._elasticEnabled?200:0;this._setScrollChanged();}this._hScrollBar.skin=value;}},{key:"vScrollBar",get:function get(){return this._vScrollBar;}},{key:"hScrollBar",get:function get(){return this._hScrollBar;}},{key:"content",get:function get(){return this._content;}},{key:"cacheAs",set:function set(value){_set(Panel.prototype.__proto__||Object.getPrototypeOf(Panel.prototype),"cacheAs",value,this);this._usedCache=null;if(value!=="none"){this._hScrollBar&&this._hScrollBar.on(Laya.Event.START,this,this.onScrollStart);this._vScrollBar&&this._vScrollBar.on(Laya.Event.START,this,this.onScrollStart);}else{this._hScrollBar&&this._hScrollBar.off(Laya.Event.START,this,this.onScrollStart);this._vScrollBar&&this._vScrollBar.off(Laya.Event.START,this,this.onScrollStart);}},get:function get(){return _get(Panel.prototype.__proto__||Object.getPrototypeOf(Panel.prototype),"cacheAs",this);}},{key:"elasticEnabled",get:function get(){return this._elasticEnabled;},set:function set(value){this._elasticEnabled=value;if(this._vScrollBar){this._vScrollBar.elasticDistance=value?200:0;}if(this._hScrollBar){this._hScrollBar.elasticDistance=value?200:0;}}}]);return Panel;}(Box);Laya.ILaya.regClass(Panel);Laya.ClassUtils.regClass("laya.ui.Panel",Panel);Laya.ClassUtils.regClass("Laya.Panel",Panel);var VSlider=function(_Slider2){_inherits(VSlider,_Slider2);function VSlider(){_classCallCheck(this,VSlider);return _possibleConstructorReturn(this,(VSlider.__proto__||Object.getPrototypeOf(VSlider)).apply(this,arguments));}return VSlider;}(Slider);Laya.ILaya.regClass(VSlider);Laya.ClassUtils.regClass("laya.ui.VSlider",VSlider);Laya.ClassUtils.regClass("Laya.VSlider",VSlider);var Tree=function(_Box6){_inherits(Tree,_Box6);function Tree(){_classCallCheck(this,Tree);var _this104=_possibleConstructorReturn(this,(Tree.__proto__||Object.getPrototypeOf(Tree)).call(this));_this104._spaceLeft=10;_this104._spaceBottom=0;_this104._keepStatus=true;_this104.width=_this104.height=200;return _this104;}_createClass(Tree,[{key:"destroy",value:function destroy(){var destroyChild=arguments.length>0&&arguments[0]!==undefined?arguments[0]:true;_get(Tree.prototype.__proto__||Object.getPrototypeOf(Tree.prototype),"destroy",this).call(this,destroyChild);this._list&&this._list.destroy(destroyChild);this._list=null;this._source=null;this._renderHandler=null;}},{key:"createChildren",value:function createChildren(){this.addChild(this._list=new List());this._list.renderHandler=Laya.Handler.create(this,this.renderItem,null,false);this._list.repeatX=1;this._list.on(Laya.Event.CHANGE,this,this.onListChange);}},{key:"onListChange",value:function onListChange(){var e=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;this.event(Laya.Event.CHANGE);}},{key:"getArray",value:function getArray(){var arr=[];for(var key in this._source){var item=this._source[key];if(this.getParentOpenStatus(item)){item.x=this._spaceLeft*this.getDepth(item);arr.push(item);}}return arr;}},{key:"getDepth",value:function getDepth(item){var num=arguments.length>1&&arguments[1]!==undefined?arguments[1]:0;if(item.nodeParent==null)return num;else return this.getDepth(item.nodeParent,num+1);}},{key:"getParentOpenStatus",value:function getParentOpenStatus(item){var parent=item.nodeParent;if(parent==null){return true;}else{if(parent.isOpen){if(parent.nodeParent!=null)return this.getParentOpenStatus(parent);else return true;}else{return false;}}}},{key:"renderItem",value:function renderItem(cell,index){var item=cell.dataSource;if(item){cell.left=item.x;var arrow=cell.getChildByName("arrow");if(arrow){if(item.hasChild){arrow.visible=true;arrow.index=item.isOpen?1:0;arrow.tag=index;arrow.off(Laya.Event.CLICK,this,this.onArrowClick);arrow.on(Laya.Event.CLICK,this,this.onArrowClick);}else{arrow.visible=false;}}var folder=cell.getChildByName("folder");if(folder){if(folder.clipY==2){folder.index=item.isDirectory?0:1;}else{folder.index=item.isDirectory?item.isOpen?1:0:2;}}this._renderHandler&&this._renderHandler.runWith([cell,index]);}}},{key:"onArrowClick",value:function onArrowClick(e){var arrow=e.currentTarget;var index=arrow.tag;this._list.array[index].isOpen=!this._list.array[index].isOpen;this.event(Laya.Event.OPEN);this._list.array=this.getArray();}},{key:"setItemState",value:function setItemState(index,isOpen){if(!this._list.array[index])return;this._list.array[index].isOpen=isOpen;this._list.array=this.getArray();}},{key:"fresh",value:function fresh(){this._list.array=this.getArray();this.repaint();}},{key:"parseXml",value:function parseXml(xml,source,nodeParent,isRoot){var obj;var list=xml.childNodes;var childCount=list.length;if(!isRoot){obj={};var list2=xml.attributes;for(var key in list2){var attrs=list2[key];var prop=attrs.nodeName;var value=attrs.nodeValue;obj[prop]=value=="true"?true:value=="false"?false:value;}obj.nodeParent=nodeParent;if(childCount>0)obj.isDirectory=true;obj.hasChild=childCount>0;source.push(obj);}for(var i=0;i<childCount;i++){var node=list[i];this.parseXml(node,source,obj,false);}}},{key:"parseOpenStatus",value:function parseOpenStatus(oldSource,newSource){for(var i=0,n=newSource.length;i<n;i++){var newItem=newSource[i];if(newItem.isDirectory){for(var j=0,m=oldSource.length;j<m;j++){var oldItem=oldSource[j];if(oldItem.isDirectory&&this.isSameParent(oldItem,newItem)&&newItem.label==oldItem.label){newItem.isOpen=oldItem.isOpen;break;}}}}}},{key:"isSameParent",value:function isSameParent(item1,item2){if(item1.nodeParent==null&&item2.nodeParent==null)return true;else if(item1.nodeParent==null||item2.nodeParent==null)return false;else{if(item1.nodeParent.label==item2.nodeParent.label)return this.isSameParent(item1.nodeParent,item2.nodeParent);else return false;}}},{key:"filter",value:function filter(key){if(Boolean(key)){var result=[];this.getFilterSource(this._source,result,key);this._list.array=result;}else{this._list.array=this.getArray();}}},{key:"getFilterSource",value:function getFilterSource(array,result,key){key=key.toLocaleLowerCase();var _iteratorNormalCompletion=true;var _didIteratorError=false;var _iteratorError=undefined;try{for(var _iterator=array[Symbol.iterator](),_step;!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=true){var item=_step.value;if(!item.isDirectory&&String(item.label).toLowerCase().indexOf(key)>-1){item.x=0;result.push(item);}if(item.child&&item.child.length>0){this.getFilterSource(item.child,result,key);}}}catch(err){_didIteratorError=true;_iteratorError=err;}finally{try{if(!_iteratorNormalCompletion&&_iterator.return){_iterator.return();}}finally{if(_didIteratorError){throw _iteratorError;}}}}},{key:"keepStatus",get:function get(){return this._keepStatus;},set:function set(value){this._keepStatus=value;}},{key:"array",get:function get(){return this._list.array;},set:function set(value){if(this._keepStatus&&this._list.array&&value){this.parseOpenStatus(this._list.array,value);}this._source=value;this._list.array=this.getArray();}},{key:"source",get:function get(){return this._source;}},{key:"list",get:function get(){return this._list;}},{key:"itemRender",get:function get(){return this._list.itemRender;},set:function set(value){this._list.itemRender=value;}},{key:"scrollBarSkin",get:function get(){return this._list.vScrollBarSkin;},set:function set(value){this._list.vScrollBarSkin=value;}},{key:"scrollBar",get:function get(){return this._list.scrollBar;}},{key:"mouseHandler",get:function get(){return this._list.mouseHandler;},set:function set(value){this._list.mouseHandler=value;}},{key:"renderHandler",get:function get(){return this._renderHandler;},set:function set(value){this._renderHandler=value;}},{key:"spaceLeft",get:function get(){return this._spaceLeft;},set:function set(value){this._spaceLeft=value;}},{key:"spaceBottom",get:function get(){return this._list.spaceY;},set:function set(value){this._list.spaceY=value;}},{key:"selectedIndex",get:function get(){return this._list.selectedIndex;},set:function set(value){this._list.selectedIndex=value;}},{key:"selectedItem",get:function get(){return this._list.selectedItem;},set:function set(value){this._list.selectedItem=value;}},{key:"width",set:function set(value){_set(Tree.prototype.__proto__||Object.getPrototypeOf(Tree.prototype),"width",value,this);this._list.width=value;},get:function get(){return _get(Tree.prototype.__proto__||Object.getPrototypeOf(Tree.prototype),"width",this);}},{key:"height",set:function set(value){_set(Tree.prototype.__proto__||Object.getPrototypeOf(Tree.prototype),"height",value,this);this._list.height=value;},get:function get(){return _get(Tree.prototype.__proto__||Object.getPrototypeOf(Tree.prototype),"height",this);}},{key:"dataSource",set:function set(value){this._dataSource=value;_set(Tree.prototype.__proto__||Object.getPrototypeOf(Tree.prototype),"dataSource",value,this);},get:function get(){return _get(Tree.prototype.__proto__||Object.getPrototypeOf(Tree.prototype),"dataSource",this);}},{key:"xml",set:function set(value){var arr=[];this.parseXml(value.childNodes[0],arr,null,true);this.array=arr;}},{key:"selectedPath",get:function get(){if(this._list.selectedItem){return this._list.selectedItem.path;}return null;}}]);return Tree;}(Box);Laya.ILaya.regClass(Tree);Laya.ClassUtils.regClass("laya.ui.Tree",Tree);Laya.ClassUtils.regClass("Laya.Tree",Tree);var LayoutBox=function(_Box7){_inherits(LayoutBox,_Box7);function LayoutBox(){_classCallCheck(this,LayoutBox);var _this105=_possibleConstructorReturn(this,(LayoutBox.__proto__||Object.getPrototypeOf(LayoutBox)).apply(this,arguments));_this105._space=0;_this105._align="none";_this105._itemChanged=false;return _this105;}_createClass(LayoutBox,[{key:"addChild",value:function addChild(child){child.on(Laya.Event.RESIZE,this,this.onResize);this._setItemChanged();return _get(LayoutBox.prototype.__proto__||Object.getPrototypeOf(LayoutBox.prototype),"addChild",this).call(this,child);}},{key:"onResize",value:function onResize(e){this._setItemChanged();}},{key:"addChildAt",value:function addChildAt(child,index){child.on(Laya.Event.RESIZE,this,this.onResize);this._setItemChanged();return _get(LayoutBox.prototype.__proto__||Object.getPrototypeOf(LayoutBox.prototype),"addChildAt",this).call(this,child,index);}},{key:"removeChildAt",value:function removeChildAt(index){this.getChildAt(index).off(Laya.Event.RESIZE,this,this.onResize);this._setItemChanged();return _get(LayoutBox.prototype.__proto__||Object.getPrototypeOf(LayoutBox.prototype),"removeChildAt",this).call(this,index);}},{key:"refresh",value:function refresh(){this._setItemChanged();}},{key:"changeItems",value:function changeItems(){this._itemChanged=false;}},{key:"sortItem",value:function sortItem(items){if(items)items.sort(function(a,b){return a.y-b.y;});}},{key:"_setItemChanged",value:function _setItemChanged(){if(!this._itemChanged){this._itemChanged=true;this.callLater(this.changeItems);}}},{key:"space",get:function get(){return this._space;},set:function set(value){this._space=value;this._setItemChanged();}},{key:"align",get:function get(){return this._align;},set:function set(value){this._align=value;this._setItemChanged();}}]);return LayoutBox;}(Box);Laya.ILaya.regClass(LayoutBox);Laya.ClassUtils.regClass("laya.ui.LayoutBox",LayoutBox);Laya.ClassUtils.regClass("Laya.LayoutBox",LayoutBox);var HBox=function(_LayoutBox){_inherits(HBox,_LayoutBox);function HBox(){_classCallCheck(this,HBox);return _possibleConstructorReturn(this,(HBox.__proto__||Object.getPrototypeOf(HBox)).apply(this,arguments));}_createClass(HBox,[{key:"sortItem",value:function sortItem(items){if(items)items.sort(function(a,b){return a.x-b.x;});}},{key:"changeItems",value:function changeItems(){this._itemChanged=false;var items=[];var maxHeight=0;for(var i=0,n=this.numChildren;i<n;i++){var item=this.getChildAt(i);if(item){items.push(item);maxHeight=this._height?this._height:Math.max(maxHeight,item.height*item.scaleY);}}this.sortItem(items);var left=0;for(i=0,n=items.length;i<n;i++){item=items[i];item.x=left;left+=item.width*item.scaleX+this._space;if(this._align==HBox.TOP){item.y=0;}else if(this._align==HBox.MIDDLE){item.y=(maxHeight-item.height*item.scaleY)*0.5;}else if(this._align==HBox.BOTTOM){item.y=maxHeight-item.height*item.scaleY;}}this._sizeChanged();}},{key:"height",set:function set(value){if(this._height!=value){_set(HBox.prototype.__proto__||Object.getPrototypeOf(HBox.prototype),"height",value,this);this.callLater(this.changeItems);}},get:function get(){return _get(HBox.prototype.__proto__||Object.getPrototypeOf(HBox.prototype),"height",this);}}]);return HBox;}(LayoutBox);HBox.NONE="none";HBox.TOP="top";HBox.MIDDLE="middle";HBox.BOTTOM="bottom";Laya.ILaya.regClass(HBox);Laya.ClassUtils.regClass("laya.ui.HBox",HBox);Laya.ClassUtils.regClass("Laya.HBox",HBox);var VBox=function(_LayoutBox2){_inherits(VBox,_LayoutBox2);function VBox(){_classCallCheck(this,VBox);return _possibleConstructorReturn(this,(VBox.__proto__||Object.getPrototypeOf(VBox)).apply(this,arguments));}_createClass(VBox,[{key:"changeItems",value:function changeItems(){this._itemChanged=false;var items=[];var maxWidth=0;for(var i=0,n=this.numChildren;i<n;i++){var item=this.getChildAt(i);if(item){items.push(item);maxWidth=this._width?this._width:Math.max(maxWidth,item.width*item.scaleX);}}this.sortItem(items);var top=0;for(i=0,n=items.length;i<n;i++){item=items[i];item.y=top;top+=item.height*item.scaleY+this._space;if(this._align==VBox.LEFT){item.x=0;}else if(this._align==VBox.CENTER){item.x=(maxWidth-item.width*item.scaleX)*0.5;}else if(this._align==VBox.RIGHT){item.x=maxWidth-item.width*item.scaleX;}}this._sizeChanged();}},{key:"width",set:function set(value){if(this._width!=value){_set(VBox.prototype.__proto__||Object.getPrototypeOf(VBox.prototype),"width",value,this);this.callLater(this.changeItems);}},get:function get(){return _get(VBox.prototype.__proto__||Object.getPrototypeOf(VBox.prototype),"width",this);}}]);return VBox;}(LayoutBox);VBox.NONE="none";VBox.LEFT="left";VBox.CENTER="center";VBox.RIGHT="right";Laya.ILaya.regClass(VBox);Laya.ClassUtils.regClass("laya.ui.VBox",VBox);Laya.ClassUtils.regClass("Laya.VBox",VBox);var FontClip=function(_Clip){_inherits(FontClip,_Clip);function FontClip(){var skin=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;var sheet=arguments.length>1&&arguments[1]!==undefined?arguments[1]:null;_classCallCheck(this,FontClip);var _this108=_possibleConstructorReturn(this,(FontClip.__proto__||Object.getPrototypeOf(FontClip)).call(this));_this108._valueArr='';_this108._indexMap=null;_this108._sheet=null;_this108._direction="horizontal";_this108._spaceX=0;_this108._spaceY=0;_this108._align="left";_this108._wordsW=0;_this108._wordsH=0;if(skin)_this108.skin=skin;if(sheet)_this108.sheet=sheet;return _this108;}_createClass(FontClip,[{key:"createChildren",value:function createChildren(){this._bitmap=new AutoBitmap();this.on(Laya.Event.LOADED,this,this._onClipLoaded);}},{key:"_onClipLoaded",value:function _onClipLoaded(){this.callLater(this.changeValue);}},{key:"changeValue",value:function changeValue(){if(!this._sources)return;if(!this._valueArr)return;this.graphics.clear(true);var texture;texture=this._sources[0];if(!texture)return;var isHorizontal=this._direction==="horizontal";if(isHorizontal){this._wordsW=this._valueArr.length*(texture.sourceWidth+this.spaceX);this._wordsH=texture.sourceHeight;}else{this._wordsW=texture.sourceWidth;this._wordsH=(texture.sourceHeight+this.spaceY)*this._valueArr.length;}var dX=0;if(this._width){switch(this._align){case"center":dX=0.5*(this._width-this._wordsW);break;case"right":dX=this._width-this._wordsW;break;default:dX=0;}}for(var i=0,sz=this._valueArr.length;i<sz;i++){var index=this._indexMap[this._valueArr.charAt(i)];if(!this.sources[index])continue;texture=this.sources[index];if(isHorizontal)this.graphics.drawImage(texture,dX+i*(texture.sourceWidth+this.spaceX),0,texture.sourceWidth,texture.sourceHeight);else this.graphics.drawImage(texture,0+dX,i*(texture.sourceHeight+this.spaceY),texture.sourceWidth,texture.sourceHeight);}if(!this._width){this._widget.resetLayoutX();this.callLater(this._sizeChanged);}if(!this._height){this._widget.resetLayoutY();this.callLater(this._sizeChanged);}}},{key:"measureWidth",value:function measureWidth(){return this._wordsW;}},{key:"measureHeight",value:function measureHeight(){return this._wordsH;}},{key:"destroy",value:function destroy(){var destroyChild=arguments.length>0&&arguments[0]!==undefined?arguments[0]:true;this._valueArr=null;this._indexMap=null;this.graphics.clear(true);this.removeSelf();this.off(Laya.Event.LOADED,this,this._onClipLoaded);_get(FontClip.prototype.__proto__||Object.getPrototypeOf(FontClip.prototype),"destroy",this).call(this,destroyChild);}},{key:"sheet",get:function get(){return this._sheet;},set:function set(value){value+="";this._sheet=value;var arr=value.split(" ");this._clipX=String(arr[0]).length;this.clipY=arr.length;this._indexMap={};for(var i=0;i<this._clipY;i++){var line=arr[i].split("");for(var j=0,n=line.length;j<n;j++){this._indexMap[line[j]]=i*this._clipX+j;}}}},{key:"value",get:function get(){if(!this._valueArr)return"";return this._valueArr;},set:function set(value){value+="";this._valueArr=value;this.callLater(this.changeValue);}},{key:"direction",get:function get(){return this._direction;},set:function set(value){this._direction=value;this.callLater(this.changeValue);}},{key:"spaceX",get:function get(){return this._spaceX;},set:function set(value){this._spaceX=value;if(this._direction==="horizontal")this.callLater(this.changeValue);}},{key:"spaceY",get:function get(){return this._spaceY;},set:function set(value){this._spaceY=value;if(!(this._direction==="horizontal"))this.callLater(this.changeValue);}},{key:"align",set:function set(v){this._align=v;this.callLater(this.changeValue);},get:function get(){return this._align;}},{key:"width",set:function set(value){_set(FontClip.prototype.__proto__||Object.getPrototypeOf(FontClip.prototype),"width",value,this);this.callLater(this.changeValue);},get:function get(){return _get(FontClip.prototype.__proto__||Object.getPrototypeOf(FontClip.prototype),"width",this);}},{key:"height",set:function set(value){_set(FontClip.prototype.__proto__||Object.getPrototypeOf(FontClip.prototype),"height",value,this);this.callLater(this.changeValue);},get:function get(){return _get(FontClip.prototype.__proto__||Object.getPrototypeOf(FontClip.prototype),"height",this);}}]);return FontClip;}(Clip);Laya.ILaya.regClass(FontClip);Laya.ClassUtils.regClass("laya.ui.FontClip",FontClip);Laya.ClassUtils.regClass("Laya.FontClip",FontClip);var View=function(_Laya$Scene){_inherits(View,_Laya$Scene);function View(){_classCallCheck(this,View);var _this109=_possibleConstructorReturn(this,(View.__proto__||Object.getPrototypeOf(View)).call(this,false));_this109._watchMap={};_this109._anchorX=NaN;_this109._anchorY=NaN;_this109._widget=Widget.EMPTY;_this109.createChildren();return _this109;}_createClass(View,[{key:"destroy",value:function destroy(){var destroyChild=arguments.length>0&&arguments[0]!==undefined?arguments[0]:true;this._watchMap=null;_get(View.prototype.__proto__||Object.getPrototypeOf(View.prototype),"destroy",this).call(this,destroyChild);}},{key:"changeData",value:function changeData(key){var arr=this._watchMap[key];if(!arr)return;for(var i=0,n=arr.length;i<n;i++){var watcher=arr[i];watcher.exe(this);}}},{key:"_sizeChanged",value:function _sizeChanged(){if(!isNaN(this._anchorX))this.pivotX=this.anchorX*this.width;if(!isNaN(this._anchorY))this.pivotY=this.anchorY*this.height;this.event(Laya.Event.RESIZE);}},{key:"_getWidget",value:function _getWidget(){this._widget===Widget.EMPTY&&(this._widget=this.addComponent(Widget));return this._widget;}},{key:"loadUI",value:function loadUI(path){var uiView=View.uiMap[path];View.uiMap&&this.createView(uiView);}},{key:"top",get:function get(){return this._widget.top;},set:function set(value){if(value!=this._widget.top){this._getWidget().top=value;}}},{key:"bottom",get:function get(){return this._widget.bottom;},set:function set(value){if(value!=this._widget.bottom){this._getWidget().bottom=value;}}},{key:"left",get:function get(){return this._widget.left;},set:function set(value){if(value!=this._widget.left){this._getWidget().left=value;}}},{key:"right",get:function get(){return this._widget.right;},set:function set(value){if(value!=this._widget.right){this._getWidget().right=value;}}},{key:"centerX",get:function get(){return this._widget.centerX;},set:function set(value){if(value!=this._widget.centerX){this._getWidget().centerX=value;}}},{key:"centerY",get:function get(){return this._widget.centerY;},set:function set(value){if(value!=this._widget.centerY){this._getWidget().centerY=value;}}},{key:"anchorX",get:function get(){return this._anchorX;},set:function set(value){if(this._anchorX!=value){this._anchorX=value;this.callLater(this._sizeChanged);}}},{key:"anchorY",get:function get(){return this._anchorY;},set:function set(value){if(this._anchorY!=value){this._anchorY=value;this.callLater(this._sizeChanged);}}},{key:"dataSource",get:function get(){return this._dataSource;},set:function set(value){this._dataSource=value;for(var name in value){var comp=this.getChildByName(name);if(comp instanceof UIComponent)comp.dataSource=value[name];else if(name in this&&!(this[name]instanceof Function))this[name]=value[name];}}}],[{key:"__init__",value:function __init__(){Laya.ILaya.ClassUtils.regShortClassName([ViewStack,Button,TextArea,ColorPicker,Box,ScaleBox,CheckBox,Clip,ComboBox,UIComponent,HScrollBar,HSlider,Image,Label,List,Panel,ProgressBar,Radio,RadioGroup,ScrollBar,Slider,Tab,TextInput,View,VScrollBar,VSlider,Tree,HBox,VBox,Laya.Animation,Laya.Text,FontClip]);}},{key:"regComponent",value:function regComponent(key,compClass){Laya.ILaya.ClassUtils.regClass(key,compClass);}},{key:"regViewRuntime",value:function regViewRuntime(key,compClass){Laya.ILaya.ClassUtils.regClass(key,compClass);}},{key:"regUI",value:function regUI(url,json){Laya.ILaya.loader.cacheRes(url,json);}}]);return View;}(Laya.Scene);View.uiMap={};Laya.ILaya.regClass(View);Laya.ClassUtils.regClass("laya.ui.View",View);Laya.ClassUtils.regClass("Laya.View",View);var IUI=function IUI(){_classCallCheck(this,IUI);};IUI.Dialog=null;var DialogManager=function(_Laya$Sprite2){_inherits(DialogManager,_Laya$Sprite2);function DialogManager(){_classCallCheck(this,DialogManager);var _this110=_possibleConstructorReturn(this,(DialogManager.__proto__||Object.getPrototypeOf(DialogManager)).call(this));_this110.maskLayer=new Laya.Sprite();_this110.popupEffect=function(dialog){dialog.scale(1,1);dialog._effectTween=Laya.Tween.from(dialog,{x:Laya.ILaya.stage.width/2,y:Laya.ILaya.stage.height/2,scaleX:0,scaleY:0},300,Laya.Ease.backOut,Laya.Handler.create(_this110,_this110.doOpen,[dialog]),0,false,false);};_this110.closeEffect=function(dialog){dialog._effectTween=Laya.Tween.to(dialog,{x:Laya.ILaya.stage.width/2,y:Laya.ILaya.stage.height/2,scaleX:0,scaleY:0},300,Laya.Ease.strongOut,Laya.Handler.create(_this110,_this110.doClose,[dialog]),0,false,false);};_this110.popupEffectHandler=new Laya.Handler(_this110,_this110.popupEffect);_this110.closeEffectHandler=new Laya.Handler(_this110,_this110.closeEffect);_this110.mouseEnabled=_this110.maskLayer.mouseEnabled=true;_this110.zOrder=1000;Laya.ILaya.stage.addChild(_this110);Laya.ILaya.stage.on(Laya.Event.RESIZE,_this110,_this110._onResize);if(UIConfig.closeDialogOnSide)_this110.maskLayer.on("click",_this110,_this110._closeOnSide);_this110._onResize(null);return _this110;}_createClass(DialogManager,[{key:"_closeOnSide",value:function _closeOnSide(){var dialog=this.getChildAt(this.numChildren-1);if(dialog instanceof IUI.Dialog)dialog.close();}},{key:"setLockView",value:function setLockView(value){if(!this.lockLayer){this.lockLayer=new Box();this.lockLayer.mouseEnabled=true;this.lockLayer.size(Laya.ILaya.stage.width,Laya.ILaya.stage.height);}this.lockLayer.removeChildren();if(value){value.centerX=value.centerY=0;this.lockLayer.addChild(value);}}},{key:"_onResize",value:function _onResize(){var e=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;var width=this.maskLayer.width=Laya.ILaya.stage.width;var height=this.maskLayer.height=Laya.ILaya.stage.height;if(this.lockLayer)this.lockLayer.size(width,height);this.maskLayer.graphics.clear(true);this.maskLayer.graphics.drawRect(0,0,width,height,UIConfig.popupBgColor);this.maskLayer.alpha=UIConfig.popupBgAlpha;for(var i=this.numChildren-1;i>-1;i--){var item=this.getChildAt(i);if(item.isPopupCenter)this._centerDialog(item);}}},{key:"_centerDialog",value:function _centerDialog(dialog){dialog.x=Math.round((Laya.ILaya.stage.width-dialog.width>>1)+dialog.pivotX);dialog.y=Math.round((Laya.ILaya.stage.height-dialog.height>>1)+dialog.pivotY);}},{key:"open",value:function open(dialog){var closeOther=arguments.length>1&&arguments[1]!==undefined?arguments[1]:false;var showEffect=arguments.length>2&&arguments[2]!==undefined?arguments[2]:false;if(closeOther)this._closeAll();this._clearDialogEffect(dialog);if(dialog.isPopupCenter)this._centerDialog(dialog);this.addChild(dialog);if(dialog.isModal||this._getBit(Laya.Const.HAS_ZORDER))Laya.ILaya.timer.callLater(this,this._checkMask);if(showEffect&&dialog.popupEffect!=null)dialog.popupEffect.runWith(dialog);else this.doOpen(dialog);this.event(Laya.Event.OPEN);}},{key:"_clearDialogEffect",value:function _clearDialogEffect(dialog){if(dialog._effectTween){Laya.Tween.clear(dialog._effectTween);dialog._effectTween=null;}}},{key:"doOpen",value:function doOpen(dialog){dialog.onOpened(dialog._param);}},{key:"lock",value:function lock(value){if(this.lockLayer){if(value)this.addChild(this.lockLayer);else this.lockLayer.removeSelf();}}},{key:"close",value:function close(dialog){this._clearDialogEffect(dialog);if(dialog.isShowEffect&&dialog.closeEffect!=null)dialog.closeEffect.runWith([dialog]);else this.doClose(dialog);this.event(Laya.Event.CLOSE);}},{key:"doClose",value:function doClose(dialog){dialog.removeSelf();dialog.isModal&&this._checkMask();dialog.closeHandler&&dialog.closeHandler.runWith(dialog.closeType);dialog.onClosed(dialog.closeType);if(dialog.autoDestroyAtClosed)dialog.destroy();}},{key:"closeAll",value:function closeAll(){this._closeAll();this.event(Laya.Event.CLOSE);}},{key:"_closeAll",value:function _closeAll(){for(var i=this.numChildren-1;i>-1;i--){var item=this.getChildAt(i);if(item&&item.close!=null){this.doClose(item);}}}},{key:"getDialogsByGroup",value:function getDialogsByGroup(group){var arr=[];for(var i=this.numChildren-1;i>-1;i--){var item=this.getChildAt(i);if(item&&item.group===group){arr.push(item);}}return arr;}},{key:"closeByGroup",value:function closeByGroup(group){var arr=[];for(var i=this.numChildren-1;i>-1;i--){var item=this.getChildAt(i);if(item&&item.group===group){item.close();arr.push(item);}}return arr;}},{key:"_checkMask",value:function _checkMask(){this.maskLayer.removeSelf();for(var i=this.numChildren-1;i>-1;i--){var dialog=this.getChildAt(i);if(dialog&&dialog.isModal){this.addChildAt(this.maskLayer,i);return;}}}}]);return DialogManager;}(Laya.Sprite);Laya.ClassUtils.regClass("laya.ui.DialogManager",DialogManager);Laya.ClassUtils.regClass("Laya.DialogManager",DialogManager);var Dialog=function(_View){_inherits(Dialog,_View);function Dialog(){_classCallCheck(this,Dialog);var _this111=_possibleConstructorReturn(this,(Dialog.__proto__||Object.getPrototypeOf(Dialog)).call(this));_this111.isShowEffect=true;_this111.isPopupCenter=true;_this111.popupEffect=Dialog.manager.popupEffectHandler;_this111.closeEffect=Dialog.manager.closeEffectHandler;_this111._dealDragArea();_this111.on(Laya.Event.CLICK,_this111,_this111._onClick);return _this111;}_createClass(Dialog,[{key:"_dealDragArea",value:function _dealDragArea(){var dragTarget=this.getChildByName("drag");if(dragTarget){this.dragArea=dragTarget._x+","+dragTarget._y+","+dragTarget.width+","+dragTarget.height;dragTarget.removeSelf();}}},{key:"_onMouseDown",value:function _onMouseDown(e){var point=this.getMousePoint();if(this._dragArea.contains(point.x,point.y))this.startDrag();else this.stopDrag();}},{key:"_onClick",value:function _onClick(e){var btn=e.target;if(btn){switch(btn.name){case Dialog.CLOSE:case Dialog.CANCEL:case Dialog.SURE:case Dialog.NO:case Dialog.OK:case Dialog.YES:this.close(btn.name);return;}}}},{key:"open",value:function open(){var closeOther=arguments.length>0&&arguments[0]!==undefined?arguments[0]:true;var param=arguments.length>1&&arguments[1]!==undefined?arguments[1]:null;this._dealDragArea();this._param=param;Dialog.manager.open(this,closeOther,this.isShowEffect);Dialog.manager.lock(false);}},{key:"close",value:function close(){var type=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;this.closeType=type;Dialog.manager.close(this);}},{key:"destroy",value:function destroy(){var destroyChild=arguments.length>0&&arguments[0]!==undefined?arguments[0]:true;this.closeHandler=null;this.popupEffect=null;this.closeEffect=null;this._dragArea=null;_get(Dialog.prototype.__proto__||Object.getPrototypeOf(Dialog.prototype),"destroy",this).call(this,destroyChild);}},{key:"show",value:function show(){var closeOther=arguments.length>0&&arguments[0]!==undefined?arguments[0]:false;var showEffect=arguments.length>1&&arguments[1]!==undefined?arguments[1]:true;this._open(false,closeOther,showEffect);}},{key:"popup",value:function popup(){var closeOther=arguments.length>0&&arguments[0]!==undefined?arguments[0]:false;var showEffect=arguments.length>1&&arguments[1]!==undefined?arguments[1]:true;this._open(true,closeOther,showEffect);}},{key:"_open",value:function _open(modal,closeOther,showEffect){this.isModal=modal;this.isShowEffect=showEffect;Dialog.manager.lock(true);this.open(closeOther);}},{key:"dragArea",get:function get(){if(this._dragArea)return this._dragArea.toString();return null;},set:function set(value){if(value){var a=UIUtils.fillArray([0,0,0,0],value,Number);this._dragArea=new Laya.Rectangle(a[0],a[1],a[2],a[3]);this.on(Laya.Event.MOUSE_DOWN,this,this._onMouseDown);}else{this._dragArea=null;this.off(Laya.Event.MOUSE_DOWN,this,this._onMouseDown);}}},{key:"isPopup",get:function get(){return this.parent!=null;}},{key:"zOrder",set:function set(value){_set(Dialog.prototype.__proto__||Object.getPrototypeOf(Dialog.prototype),"zOrder",value,this);Dialog.manager._checkMask();},get:function get(){return _get(Dialog.prototype.__proto__||Object.getPrototypeOf(Dialog.prototype),"zOrder",this);}}],[{key:"setLockView",value:function setLockView(view){Dialog.manager.setLockView(view);}},{key:"lock",value:function lock(value){Dialog.manager.lock(value);}},{key:"closeAll",value:function closeAll(){Dialog.manager.closeAll();}},{key:"getDialogsByGroup",value:function getDialogsByGroup(group){return Dialog.manager.getDialogsByGroup(group);}},{key:"closeByGroup",value:function closeByGroup(group){return Dialog.manager.closeByGroup(group);}},{key:"manager",get:function get(){return Dialog._manager=Dialog._manager||new DialogManager();},set:function set(value){Dialog._manager=value;}}]);return Dialog;}(View);Dialog.CLOSE="close";Dialog.CANCEL="cancel";Dialog.SURE="sure";Dialog.NO="no";Dialog.YES="yes";Dialog.OK="ok";IUI.Dialog=Dialog;Laya.ILaya.regClass(Dialog);Laya.ClassUtils.regClass("laya.ui.Dialog",Dialog);Laya.ClassUtils.regClass("Laya.Dialog",Dialog);var TipManager=function(_UIComponent11){_inherits(TipManager,_UIComponent11);function TipManager(){_classCallCheck(this,TipManager);var _this112=_possibleConstructorReturn(this,(TipManager.__proto__||Object.getPrototypeOf(TipManager)).call(this));_this112._tipBox=new UIComponent();_this112._tipBox.addChild(_this112._tipText=new Laya.Text());_this112._tipText.x=_this112._tipText.y=5;_this112._tipText.color=TipManager.tipTextColor;_this112._defaultTipHandler=_this112._showDefaultTip;Laya.ILaya.stage.on(UIEvent.SHOW_TIP,_this112,_this112._onStageShowTip);Laya.ILaya.stage.on(UIEvent.HIDE_TIP,_this112,_this112._onStageHideTip);_this112.zOrder=1100;return _this112;}_createClass(TipManager,[{key:"_onStageHideTip",value:function _onStageHideTip(e){Laya.ILaya.timer.clear(this,this._showTip);this.closeAll();this.removeSelf();}},{key:"_onStageShowTip",value:function _onStageShowTip(data){Laya.ILaya.timer.once(TipManager.tipDelay,this,this._showTip,[data],true);}},{key:"_showTip",value:function _showTip(tip){if(typeof tip=='string'){var text=String(tip);if(Boolean(text)){this._defaultTipHandler(text);}}else if(tip instanceof Laya.Handler){tip.run();}else if(tip instanceof Function){tip.apply();}{Laya.ILaya.stage.on(Laya.Event.MOUSE_MOVE,this,this._onStageMouseMove);Laya.ILaya.stage.on(Laya.Event.MOUSE_DOWN,this,this._onStageMouseDown);}this._onStageMouseMove(null);}},{key:"_onStageMouseDown",value:function _onStageMouseDown(e){this.closeAll();}},{key:"_onStageMouseMove",value:function _onStageMouseMove(e){this._showToStage(this,TipManager.offsetX,TipManager.offsetY);}},{key:"_showToStage",value:function _showToStage(dis){var offX=arguments.length>1&&arguments[1]!==undefined?arguments[1]:0;var offY=arguments.length>2&&arguments[2]!==undefined?arguments[2]:0;var rec=dis.getBounds();dis.x=Laya.ILaya.stage.mouseX+offX;dis.y=Laya.ILaya.stage.mouseY+offY;if(dis._x+rec.width>Laya.ILaya.stage.width){dis.x-=rec.width+offX;}if(dis._y+rec.height>Laya.ILaya.stage.height){dis.y-=rec.height+offY;}}},{key:"closeAll",value:function closeAll(){Laya.ILaya.timer.clear(this,this._showTip);Laya.ILaya.stage.off(Laya.Event.MOUSE_MOVE,this,this._onStageMouseMove);Laya.ILaya.stage.off(Laya.Event.MOUSE_DOWN,this,this._onStageMouseDown);this.removeChildren();}},{key:"showDislayTip",value:function showDislayTip(tip){this.addChild(tip);this._showToStage(this);Laya.ILaya.stage.addChild(this);}},{key:"_showDefaultTip",value:function _showDefaultTip(text){this._tipText.text=text;var g=this._tipBox.graphics;g.clear(true);g.drawRect(0,0,this._tipText.width+10,this._tipText.height+10,TipManager.tipBackColor);this.addChild(this._tipBox);this._showToStage(this);Laya.ILaya.stage.addChild(this);}},{key:"defaultTipHandler",get:function get(){return this._defaultTipHandler;},set:function set(value){this._defaultTipHandler=value;}}]);return TipManager;}(UIComponent);TipManager.offsetX=10;TipManager.offsetY=15;TipManager.tipTextColor="#ffffff";TipManager.tipBackColor="#111111";TipManager.tipDelay=200;Laya.ILaya.regClass(TipManager);Laya.ClassUtils.regClass("laya.ui.TipManager",TipManager);Laya.ClassUtils.regClass("Laya.TipManager",TipManager);var UILib=function(){function UILib(){_classCallCheck(this,UILib);}_createClass(UILib,null,[{key:"__init__",value:function __init__(){}}]);return UILib;}();var WXOpenDataViewer=function(_UIComponent12){_inherits(WXOpenDataViewer,_UIComponent12);function WXOpenDataViewer(){_classCallCheck(this,WXOpenDataViewer);var _this113=_possibleConstructorReturn(this,(WXOpenDataViewer.__proto__||Object.getPrototypeOf(WXOpenDataViewer)).call(this));_this113._width=_this113._height=200;var tex=new Laya.Texture();tex.bitmap=new Laya.Texture2D();_this113.texture=tex;return _this113;}_createClass(WXOpenDataViewer,[{key:"onEnable",value:function onEnable(){this.postMsg({type:"display",rate:Laya.Laya.stage.frameRate});if(window.wx&&window.sharedCanvas)Laya.Laya.timer.frameLoop(1,this,this._onLoop);}},{key:"onDisable",value:function onDisable(){this.postMsg({type:"undisplay"});Laya.Laya.timer.clear(this,this._onLoop);}},{key:"_onLoop",value:function _onLoop(){this.texture.bitmap.loadImageSource(window.sharedCanvas);}},{key:"_postMsg",value:function _postMsg(){var mat=new Laya.Matrix();mat.translate(this.x,this.y);var stage=Laya.Laya.stage;mat.scale(stage._canvasTransform.getScaleX()*this.globalScaleX*stage.transform.getScaleX(),stage._canvasTransform.getScaleY()*this.globalScaleY*stage.transform.getScaleY());this.postMsg({type:"changeMatrix",a:mat.a,b:mat.b,c:mat.c,d:mat.d,tx:mat.tx,ty:mat.ty,w:this.width,h:this.height});}},{key:"postMsg",value:function postMsg(msg){if(window.wx&&window.wx.getOpenDataContext){var openDataContext=window.wx.getOpenDataContext();openDataContext.postMessage(msg);}}},{key:"width",set:function set(value){_set(WXOpenDataViewer.prototype.__proto__||Object.getPrototypeOf(WXOpenDataViewer.prototype),"width",value,this);if(window.sharedCanvas)window.sharedCanvas.width=value;this.callLater(this._postMsg);},get:function get(){return _get(WXOpenDataViewer.prototype.__proto__||Object.getPrototypeOf(WXOpenDataViewer.prototype),"width",this);}},{key:"height",set:function set(value){_set(WXOpenDataViewer.prototype.__proto__||Object.getPrototypeOf(WXOpenDataViewer.prototype),"height",value,this);if(window.sharedCanvas)window.sharedCanvas.height=value;this.callLater(this._postMsg);},get:function get(){return _get(WXOpenDataViewer.prototype.__proto__||Object.getPrototypeOf(WXOpenDataViewer.prototype),"height",this);}},{key:"x",set:function set(value){_set(WXOpenDataViewer.prototype.__proto__||Object.getPrototypeOf(WXOpenDataViewer.prototype),"x",value,this);this.callLater(this._postMsg);},get:function get(){return _get(WXOpenDataViewer.prototype.__proto__||Object.getPrototypeOf(WXOpenDataViewer.prototype),"x",this);}},{key:"y",set:function set(value){_set(WXOpenDataViewer.prototype.__proto__||Object.getPrototypeOf(WXOpenDataViewer.prototype),"y",value,this);this.callLater(this._postMsg);},get:function get(){return _get(WXOpenDataViewer.prototype.__proto__||Object.getPrototypeOf(WXOpenDataViewer.prototype),"y",this);}}]);return WXOpenDataViewer;}(UIComponent);Laya.ILaya.regClass(WXOpenDataViewer);Laya.ClassUtils.regClass("laya.ui.WXOpenDataViewer",WXOpenDataViewer);Laya.ClassUtils.regClass("Laya.WXOpenDataViewer",WXOpenDataViewer);exports.AdvImage=AdvImage;exports.AutoBitmap=AutoBitmap;exports.Box=Box;exports.Button=Button;exports.CheckBox=CheckBox;exports.Clip=Clip;exports.ColorPicker=ColorPicker;exports.ComboBox=ComboBox;exports.Dialog=Dialog;exports.DialogManager=DialogManager;exports.FontClip=FontClip;exports.HBox=HBox;exports.HScrollBar=HScrollBar;exports.HSlider=HSlider;exports.IUI=IUI;exports.Image=Image;exports.Label=Label;exports.LayoutBox=LayoutBox;exports.List=List;exports.Panel=Panel;exports.ProgressBar=ProgressBar;exports.Radio=Radio;exports.RadioGroup=RadioGroup;exports.ScaleBox=ScaleBox;exports.ScrollBar=ScrollBar;exports.Slider=Slider;exports.Styles=Styles;exports.Tab=Tab;exports.TextArea=TextArea;exports.TextInput=TextInput;exports.TipManager=TipManager;exports.Tree=Tree;exports.UIComponent=UIComponent;exports.UIConfig=UIConfig;exports.UIEvent=UIEvent;exports.UIGroup=UIGroup;exports.UILib=UILib;exports.UIUtils=UIUtils;exports.VBox=VBox;exports.VScrollBar=VScrollBar;exports.VSlider=VSlider;exports.View=View;exports.ViewStack=ViewStack;exports.WXOpenDataViewer=WXOpenDataViewer;exports.Widget=Widget;})(window.Laya=window.Laya||{},Laya);(function(exports,Laya){'use strict';var HTMLExtendStyle=function(){function HTMLExtendStyle(){_classCallCheck(this,HTMLExtendStyle);this.reset();}_createClass(HTMLExtendStyle,[{key:"reset",value:function reset(){this.stroke=0;this.strokeColor="#000000";this.leading=0;this.lineHeight=0;this.letterSpacing=0;this.href=null;return this;}},{key:"recover",value:function recover(){if(this==HTMLExtendStyle.EMPTY)return;Laya.Pool.recover("HTMLExtendStyle",this.reset());}}],[{key:"create",value:function create(){return Laya.Pool.getItemByClass("HTMLExtendStyle",HTMLExtendStyle);}}]);return HTMLExtendStyle;}();HTMLExtendStyle.EMPTY=new HTMLExtendStyle();Laya.ClassUtils.regClass("laya.html.utils.HTMLExtendStyle",HTMLExtendStyle);Laya.ClassUtils.regClass("Laya.HTMLExtendStyle",HTMLExtendStyle);var HTMLStyle=function(){function HTMLStyle(){_classCallCheck(this,HTMLStyle);this.padding=HTMLStyle._PADDING;this.reset();}_createClass(HTMLStyle,[{key:"_getExtendStyle",value:function _getExtendStyle(){if(this._extendStyle===HTMLExtendStyle.EMPTY)this._extendStyle=HTMLExtendStyle.create();return this._extendStyle;}},{key:"reset",value:function reset(){this.ower=null;this._type=0;this.wordWrap=true;this.fontSize=Laya.ILaya.Text.defaultFontSize;this.family=Laya.ILaya.Text.defaultFont;this.color="#000000";this.valign=HTMLStyle.VALIGN_TOP;this.padding=HTMLStyle._PADDING;this.bold=false;this.italic=false;this.align=HTMLStyle.ALIGN_LEFT;this.textDecoration=null;this.bgColor=null;this.borderColor=null;if(this._extendStyle)this._extendStyle.recover();this._extendStyle=HTMLExtendStyle.EMPTY;return this;}},{key:"recover",value:function recover(){Laya.Pool.recover("HTMLStyle",this.reset());}},{key:"inherit",value:function inherit(src){var i,len;var props;props=HTMLStyle._inheritProps;len=props.length;var key;for(i=0;i<len;i++){key=props[i];this[key]=src[key];}}},{key:"_widthAuto",value:function _widthAuto(){return(this._type&HTMLStyle._WIDTHAUTO)!==0;}},{key:"widthed",value:function widthed(sprite){return(this._type&HTMLStyle._WIDTH_SET)!=0;}},{key:"_calculation",value:function _calculation(type,value){return false;}},{key:"heighted",value:function heighted(sprite){return(this._type&HTMLStyle._HEIGHT_SET)!=0;}},{key:"size",value:function size(w,h){var ower=this.ower;var resize=false;if(w!==-1&&w!=ower.width){this._type|=HTMLStyle._WIDTH_SET;ower.width=w;resize=true;}if(h!==-1&&h!=ower.height){this._type|=HTMLStyle._HEIGHT_SET;ower.height=h;resize=true;}if(resize){ower._layoutLater();}}},{key:"getLineElement",value:function getLineElement(){return(this._type&HTMLStyle._LINE_ELEMENT)!=0;}},{key:"setLineElement",value:function setLineElement(value){value?this._type|=HTMLStyle._LINE_ELEMENT:this._type&=~HTMLStyle._LINE_ELEMENT;}},{key:"_enableLayout",value:function _enableLayout(){return(this._type&HTMLStyle._DISPLAY_NONE)===0&&(this._type&HTMLStyle._ABSOLUTE)===0;}},{key:"cssText",value:function cssText(text){this.attrs(HTMLStyle.parseOneCSS(text,';'));}},{key:"attrs",value:function attrs(_attrs){if(_attrs){for(var i=0,n=_attrs.length;i<n;i++){var attr=_attrs[i];this[attr[0]]=attr[1];}}}},{key:"href",get:function get(){return this._extendStyle.href;},set:function set(value){if(value===this._extendStyle.href)return;this._getExtendStyle().href=value;}},{key:"stroke",get:function get(){return this._extendStyle.stroke;},set:function set(value){if(this._extendStyle.stroke===value)return;this._getExtendStyle().stroke=value;}},{key:"strokeColor",get:function get(){return this._extendStyle.strokeColor;},set:function set(value){if(this._extendStyle.strokeColor===value)return;this._getExtendStyle().strokeColor=value;}},{key:"leading",get:function get(){return this._extendStyle.leading;},set:function set(value){if(this._extendStyle.leading===value)return;this._getExtendStyle().leading=value;}},{key:"lineHeight",get:function get(){return this._extendStyle.lineHeight;},set:function set(value){if(this._extendStyle.lineHeight===value)return;this._getExtendStyle().lineHeight=value;}},{key:"align",set:function set(v){if(!(v in HTMLStyle.alignVDic))return;this._type&=~HTMLStyle._ALIGN;this._type|=HTMLStyle.alignVDic[v];},get:function get(){var v=this._type&HTMLStyle._ALIGN;return HTMLStyle.align_Value[v];}},{key:"valign",set:function set(v){if(!(v in HTMLStyle.alignVDic))return;this._type&=~HTMLStyle._VALIGN;this._type|=HTMLStyle.alignVDic[v];},get:function get(){var v=this._type&HTMLStyle._VALIGN;return HTMLStyle.vAlign_Value[v];}},{key:"font",set:function set(value){var strs=value.split(' ');for(var i=0,n=strs.length;i<n;i++){var str=strs[i];switch(str){case'italic':this.italic=true;continue;case'bold':this.bold=true;continue;}if(str.indexOf('px')>0){this.fontSize=parseInt(str);this.family=strs[i+1];i++;continue;}}},get:function get(){return(this.italic?"italic ":"")+(this.bold?"bold ":"")+this.fontSize+"px "+(Laya.ILaya.Browser.onIPhone?Laya.ILaya.Text.fontFamilyMap[this.family]||this.family:this.family);}},{key:"block",set:function set(value){value?this._type|=HTMLStyle._CSS_BLOCK:this._type&=~HTMLStyle._CSS_BLOCK;},get:function get(){return(this._type&HTMLStyle._CSS_BLOCK)!=0;}},{key:"wordWrap",get:function get(){return(this._type&HTMLStyle._NOWARP)===0;},set:function set(value){value?this._type&=~HTMLStyle._NOWARP:this._type|=HTMLStyle._NOWARP;}},{key:"bold",get:function get(){return(this._type&HTMLStyle._BOLD)!=0;},set:function set(value){value?this._type|=HTMLStyle._BOLD:this._type&=~HTMLStyle._BOLD;}},{key:"italic",get:function get(){return(this._type&HTMLStyle._ITALIC)!=0;},set:function set(value){value?this._type|=HTMLStyle._ITALIC:this._type&=~HTMLStyle._ITALIC;}},{key:"whiteSpace",set:function set(type){type==="nowrap"&&(this._type|=HTMLStyle._NOWARP);type==="none"&&(this._type&=~HTMLStyle._NOWARP);},get:function get(){return this._type&HTMLStyle._NOWARP?"nowrap":"";}},{key:"width",set:function set(w){this._type|=HTMLStyle._WIDTH_SET;if(typeof w=='string'){var offset=w.indexOf('auto');if(offset>=0){this._type|=HTMLStyle._WIDTHAUTO;w=w.substr(0,offset);}if(this._calculation("width",w))return;w=parseInt(w);}this.size(w,-1);}},{key:"height",set:function set(h){this._type|=HTMLStyle._HEIGHT_SET;if(typeof h=='string'){if(this._calculation("height",h))return;h=parseInt(h);}this.size(-1,h);}},{key:"letterSpacing",get:function get(){return this._extendStyle.letterSpacing;},set:function set(d){typeof d=='string'&&(d=parseInt(d+""));if(d==this._extendStyle.letterSpacing)return;this._getExtendStyle().letterSpacing=d;}},{key:"position",set:function set(value){value==="absolute"?this._type|=HTMLStyle._ABSOLUTE:this._type&=~HTMLStyle._ABSOLUTE;},get:function get(){return this._type&HTMLStyle._ABSOLUTE?"absolute":"";}},{key:"absolute",get:function get(){return(this._type&HTMLStyle._ABSOLUTE)!==0;}},{key:"paddingLeft",get:function get(){return this.padding[3];}},{key:"paddingTop",get:function get(){return this.padding[0];}}],[{key:"create",value:function create(){return Laya.Pool.getItemByClass("HTMLStyle",HTMLStyle);}},{key:"parseOneCSS",value:function parseOneCSS(text,clipWord){var out=[];var attrs=text.split(clipWord);var valueArray;for(var i=0,n=attrs.length;i<n;i++){var attr=attrs[i];var ofs=attr.indexOf(':');var name=attr.substr(0,ofs).replace(/^\s+|\s+$/g,'');if(name.length===0)continue;var value=attr.substr(ofs+1).replace(/^\s+|\s+$/g,'');var one=[name,value];switch(name){case'italic':case'bold':one[1]=value=="true";break;case"font-weight":if(value=="bold"){one[1]=true;one[0]="bold";}break;case'line-height':one[0]='lineHeight';one[1]=parseInt(value);break;case'font-size':one[0]='fontSize';one[1]=parseInt(value);break;case'stroke':one[0]='stroke';one[1]=parseInt(value);break;case'padding':valueArray=value.split(' ');valueArray.length>1||(valueArray[1]=valueArray[2]=valueArray[3]=valueArray[0]);one[1]=[parseInt(valueArray[0]),parseInt(valueArray[1]),parseInt(valueArray[2]),parseInt(valueArray[3])];break;default:(one[0]=HTMLStyle._CSSTOVALUE[name])||(one[0]=name);}out.push(one);}return out;}},{key:"parseCSS",value:function parseCSS(text,uri){var one;while((one=HTMLStyle._parseCSSRegExp.exec(text))!=null){HTMLStyle.styleSheets[one[1]]=HTMLStyle.parseOneCSS(one[2],';');}}}]);return HTMLStyle;}();HTMLStyle._CSSTOVALUE={'letter-spacing':'letterSpacing','white-space':'whiteSpace','line-height':'lineHeight','font-family':'family','vertical-align':'valign','text-decoration':'textDecoration','background-color':'bgColor','border-color':'borderColor'};HTMLStyle._parseCSSRegExp=new RegExp("([\.\#]\\w+)\\s*{([\\s\\S]*?)}","g");HTMLStyle._inheritProps=["italic","align","valign","leading","stroke","strokeColor","bold","fontSize","lineHeight","wordWrap","color"];HTMLStyle.ALIGN_LEFT="left";HTMLStyle.ALIGN_CENTER="center";HTMLStyle.ALIGN_RIGHT="right";HTMLStyle.VALIGN_TOP="top";HTMLStyle.VALIGN_MIDDLE="middle";HTMLStyle.VALIGN_BOTTOM="bottom";HTMLStyle.styleSheets={};HTMLStyle.ADDLAYOUTED=0x200;HTMLStyle._PADDING=[0,0,0,0];HTMLStyle._HEIGHT_SET=0x2000;HTMLStyle._LINE_ELEMENT=0x10000;HTMLStyle._NOWARP=0x20000;HTMLStyle._WIDTHAUTO=0x40000;HTMLStyle._BOLD=0x400;HTMLStyle._ITALIC=0x800;HTMLStyle._CSS_BLOCK=0x1;HTMLStyle._DISPLAY_NONE=0x2;HTMLStyle._ABSOLUTE=0x4;HTMLStyle._WIDTH_SET=0x8;HTMLStyle.alignVDic={"left":0,"center":0x10,"right":0x20,"top":0,"middle":0x40,"bottom":0x80};HTMLStyle.align_Value={0:"left",0x10:"center",0x20:"right"};HTMLStyle.vAlign_Value={0:"top",0x40:"middle",0x80:"bottom"};HTMLStyle._ALIGN=0x30;HTMLStyle._VALIGN=0xc0;Laya.ClassUtils.regClass("laya.html.utils.HTMLStyle",HTMLStyle);Laya.ClassUtils.regClass("Laya.HTMLStyle",HTMLStyle);var HTMLDocument=function(){function HTMLDocument(){_classCallCheck(this,HTMLDocument);this.all=[];this.styleSheets=HTMLStyle.styleSheets;}_createClass(HTMLDocument,[{key:"getElementById",value:function getElementById(id){return this.all[id];}},{key:"setElementById",value:function setElementById(id,e){this.all[id]=e;}}]);return HTMLDocument;}();HTMLDocument.document=new HTMLDocument();Laya.ClassUtils.regClass("laya.html.dom.HTMLDocument",HTMLDocument);Laya.ClassUtils.regClass("Laya.HTMLDocument",HTMLDocument);var HTMLHitRect=function(){function HTMLHitRect(){_classCallCheck(this,HTMLHitRect);this.rec=new Laya.Rectangle();this.reset();}_createClass(HTMLHitRect,[{key:"reset",value:function reset(){this.rec.reset();this.href=null;return this;}},{key:"recover",value:function recover(){Laya.Pool.recover("HTMLHitRect",this.reset());}}],[{key:"create",value:function create(){return Laya.Pool.getItemByClass("HTMLHitRect",HTMLHitRect);}}]);return HTMLHitRect;}();Laya.ClassUtils.regClass("laya.html.dom.HTMLHitRect",HTMLHitRect);Laya.ClassUtils.regClass("Laya.HTMLHitRect",HTMLHitRect);var IHtml=function IHtml(){_classCallCheck(this,IHtml);};IHtml.HTMLDivElement=null;IHtml.HTMLImageElement=null;IHtml.HTMLBrElement=null;IHtml.HTMLDivParser=null;IHtml.HTMLParse=null;IHtml.HTMLElementType=null;var LayoutLine=function(){function LayoutLine(){_classCallCheck(this,LayoutLine);this.elements=[];this.x=0;this.y=0;this.w=0;this.h=0;this.wordStartIndex=0;this.minTextHeight=99999;this.mWidth=0;}_createClass(LayoutLine,[{key:"updatePos",value:function updatePos(left,width,lineNum,dy,align,valign,lineHeight){var w=0;var one;if(this.elements.length>0){one=this.elements[this.elements.length-1];w=one.x+one.width-this.elements[0].x;}lineHeight=lineHeight||this.h;var dx=0,ddy;if(align===HTMLStyle.ALIGN_CENTER)dx=(width-w)/2;if(align===HTMLStyle.ALIGN_RIGHT)dx=width-w;for(var i=0,n=this.elements.length;i<n;i++){one=this.elements[i];var tCSSStyle=one._getCSSStyle();dx!==0&&(one.x+=dx);switch(tCSSStyle.valign){case"top":one.y=dy;break;case"middle":var tMinTextHeight=0;if(this.minTextHeight!=99999)tMinTextHeight=this.minTextHeight;var tBottomLineY=(tMinTextHeight+lineHeight)/2;tBottomLineY=Math.max(tBottomLineY,this.h);if(one.eletype==IHtml.HTMLElementType.IMAGE)ddy=dy+tBottomLineY-one.height;else ddy=dy+tBottomLineY-one.height;one.y=ddy;break;case"bottom":one.y=dy+(lineHeight-one.height);break;}}}}]);return LayoutLine;}();Laya.ClassUtils.regClass("laya.html.utils.LayoutLine",LayoutLine);Laya.ClassUtils.regClass("Laya.LayoutLine",LayoutLine);var Layout=function(){function Layout(){_classCallCheck(this,Layout);}_createClass(Layout,null,[{key:"later",value:function later(element){if(Layout._will==null){Layout._will=[];Laya.ILaya.stage.frameLoop(1,null,function(){if(Layout._will.length<1)return;for(var i=0;i<Layout._will.length;i++){Layout.layout(Layout._will[i]);}Layout._will.length=0;});}Layout._will.push(element);}},{key:"layout",value:function layout(element){if(!element||!element._style)return null;var style=element._style;if((style._type&HTMLStyle.ADDLAYOUTED)===0)return null;element.style._type&=~HTMLStyle.ADDLAYOUTED;var arr=Layout._multiLineLayout(element);return arr;}},{key:"_multiLineLayout",value:function _multiLineLayout(element){var elements=[];element._addChildsToLayout(elements);var i,n=elements.length;var style=element._getCSSStyle();var letterSpacing=style.letterSpacing;var leading=style.leading;var lineHeight=style.lineHeight;var widthAuto=style._widthAuto()||!style.wordWrap;var width=widthAuto?999999:element.width;var height=element.height;var maxWidth=0;var exWidth=style.italic?style.fontSize/3:0;var align=style.align;var valign=style.valign;var endAdjust=valign!==HTMLStyle.VALIGN_TOP||align!==HTMLStyle.ALIGN_LEFT||lineHeight!=0;var oneLayout;var x=0;var y=0;var w=0;var h=0;var lines=[];var curStyle;var curPadding;var curLine=lines[0]=new LayoutLine();var newLine,nextNewline=false;var htmlWord;var sprite;curLine.h=0;if(style.italic)width-=style.fontSize/3;var tWordWidth=0;var tLineFirstKey=true;function addLine(){curLine.y=y;y+=curLine.h+leading;curLine.mWidth=tWordWidth;tWordWidth=0;curLine=new LayoutLine();lines.push(curLine);curLine.h=0;x=0;tLineFirstKey=true;newLine=false;}for(i=0;i<n;i++){oneLayout=elements[i];if(oneLayout==null){if(!tLineFirstKey){x+=Layout.DIV_ELEMENT_PADDING;}curLine.wordStartIndex=curLine.elements.length;continue;}tLineFirstKey=false;if(oneLayout instanceof IHtml.HTMLBrElement){addLine();curLine.y=y;curLine.h=lineHeight;continue;}else if(oneLayout._isChar()){htmlWord=oneLayout;if(!htmlWord.isWord){if(lines.length>0&&x+w>width&&curLine.wordStartIndex>0){var tLineWord=0;tLineWord=curLine.elements.length-curLine.wordStartIndex+1;curLine.elements.length=curLine.wordStartIndex;i-=tLineWord;addLine();continue;}newLine=false;tWordWidth+=htmlWord.width;}else{newLine=nextNewline||htmlWord.char==='\n';curLine.wordStartIndex=curLine.elements.length;}w=htmlWord.width+htmlWord.style.letterSpacing;h=htmlWord.height;nextNewline=false;newLine=newLine||x+w>width;newLine&&addLine();curLine.minTextHeight=Math.min(curLine.minTextHeight,oneLayout.height);}else{curStyle=oneLayout._getCSSStyle();sprite=oneLayout;curPadding=curStyle.padding;newLine=nextNewline||curStyle.getLineElement();w=sprite.width+curPadding[1]+curPadding[3]+curStyle.letterSpacing;h=sprite.height+curPadding[0]+curPadding[2];nextNewline=curStyle.getLineElement();newLine=newLine||x+w>width&&curStyle.wordWrap;newLine&&addLine();}curLine.elements.push(oneLayout);curLine.h=Math.max(curLine.h,h);oneLayout.x=x;oneLayout.y=y;x+=w;curLine.w=x-letterSpacing;curLine.y=y;maxWidth=Math.max(x+exWidth,maxWidth);}y=curLine.y+curLine.h;if(endAdjust){var tY=0;var tWidth=width;if(widthAuto&&element.width>0){tWidth=element.width;}for(i=0,n=lines.length;i<n;i++){lines[i].updatePos(0,tWidth,i,tY,align,valign,lineHeight);tY+=Math.max(lineHeight,lines[i].h+leading);}y=tY;}widthAuto&&(element.width=maxWidth);y>element.height&&(element.height=y);return[maxWidth,y];}}]);return Layout;}();Layout.DIV_ELEMENT_PADDING=0;Laya.ClassUtils.regClass("laya.html.utils.Layout",Layout);Laya.ClassUtils.regClass("Laya.Layout",Layout);(function(HTMLElementType){HTMLElementType[HTMLElementType["BASE"]=0]="BASE";HTMLElementType[HTMLElementType["IMAGE"]=1]="IMAGE";})(exports.HTMLElementType||(exports.HTMLElementType={}));var HTMLElement=function(){function HTMLElement(){_classCallCheck(this,HTMLElement);this.eletype=exports.HTMLElementType.BASE;this._creates();this.reset();}_createClass(HTMLElement,[{key:"_creates",value:function _creates(){this._style=HTMLStyle.create();}},{key:"reset",value:function reset(){this.URI=null;this.parent=null;this._style.reset();this._style.ower=this;this._style.valign="middle";if(this._text&&this._text.words){var words=this._text.words;var i,len;len=words.length;var tChar;for(i=0;i<len;i++){tChar=words[i];if(tChar)tChar.recover();}}this._text=HTMLElement._EMPTYTEXT;if(this._children)this._children.length=0;this._x=this._y=this._width=this._height=0;return this;}},{key:"_getCSSStyle",value:function _getCSSStyle(){return this._style;}},{key:"_addChildsToLayout",value:function _addChildsToLayout(out){var words=this._getWords();if(words==null&&(!this._children||this._children.length==0))return false;if(words){for(var i=0,n=words.length;i<n;i++){out.push(words[i]);}}if(this._children)this._children.forEach(function(o,index,array){var _style=o._style;_style._enableLayout&&_style._enableLayout()&&o._addToLayout(out);});return true;}},{key:"_addToLayout",value:function _addToLayout(out){if(!this._style)return;var style=this._style;if(style.absolute)return;style.block?out.push(this):this._addChildsToLayout(out)&&(this.x=this.y=0);}},{key:"repaint",value:function repaint(){var recreate=arguments.length>0&&arguments[0]!==undefined?arguments[0]:false;this.parentRepaint(recreate);}},{key:"parentRepaint",value:function parentRepaint(){var recreate=arguments.length>0&&arguments[0]!==undefined?arguments[0]:false;if(this.parent)this.parent.repaint(recreate);}},{key:"_setParent",value:function _setParent(value){if(value instanceof HTMLElement){var p=value;this.URI||(this.URI=p.URI);if(this.style)this.style.inherit(p.style);}}},{key:"appendChild",value:function appendChild(c){return this.addChild(c);}},{key:"addChild",value:function addChild(c){if(c.parent)c.parent.removeChild(c);if(!this._children)this._children=[];this._children.push(c);c.parent=this;c._setParent(this);this.repaint();return c;}},{key:"removeChild",value:function removeChild(c){if(!this._children)return null;var i,len;len=this._children.length;for(i=0;i<len;i++){if(this._children[i]==c){this._children.splice(i,1);return c;}}return null;}},{key:"destroy",value:function destroy(){if(this._children){this.destroyChildren();this._children.length=0;}Laya.Pool.recover(HTMLElement.getClassName(this),this.reset());}},{key:"destroyChildren",value:function destroyChildren(){if(this._children){for(var i=this._children.length-1;i>-1;i--){this._children[i].destroy();}this._children.length=0;}}},{key:"_getWords",value:function _getWords(){if(!this._text)return null;var txt=this._text.text;if(!txt||txt.length===0)return null;var words=this._text.words;if(words&&words.length===txt.length)return words;words===null&&(this._text.words=words=[]);words.length=txt.length;var size;var style=this.style;var fontStr=style.font;for(var i=0,n=txt.length;i<n;i++){size=Laya.ILaya.Browser.measureText(txt.charAt(i),fontStr);words[i]=Laya.HTMLChar.create().setData(txt.charAt(i),size.width,size.height||style.fontSize,style);}return words;}},{key:"_isChar",value:function _isChar(){return false;}},{key:"_layoutLater",value:function _layoutLater(){var style=this.style;if(style._type&HTMLStyle.ADDLAYOUTED)return;if(style.widthed(this)&&(this._children&&this._children.length>0||this._getWords()!=null)&&style.block){Layout.later(this);style._type|=HTMLStyle.ADDLAYOUTED;}else{this.parent&&this.parent._layoutLater();}}},{key:"_setAttributes",value:function _setAttributes(name,value){switch(name){case'style':this.style.cssText(value);break;case'class':this.className=value;break;case'x':this.x=parseFloat(value);break;case'y':this.y=parseFloat(value);break;case'width':this.width=parseFloat(value);break;case'height':this.height=parseFloat(value);break;default:this[name]=value;}}},{key:"formatURL",value:function formatURL(url){if(!this.URI)return url;return HTMLElement.formatURL1(url,this.URI?this.URI.path:null);}},{key:"drawToGraphic",value:function drawToGraphic(graphic,gX,gY,recList){gX+=this.x;gY+=this.y;var cssStyle=this.style;if(cssStyle.paddingLeft){gX+=cssStyle.paddingLeft;}if(cssStyle.paddingTop){gY+=cssStyle.paddingTop;}if(cssStyle.bgColor!=null||cssStyle.borderColor){graphic.drawRect(gX,gY,this.width,this.height,cssStyle.bgColor,cssStyle.borderColor,1);}this.renderSelfToGraphic(graphic,gX,gY,recList);var i,len;var tChild;if(this._children&&this._children.length>0){len=this._children.length;for(i=0;i<len;i++){tChild=this._children[i];if(tChild.drawToGraphic!=null)tChild.drawToGraphic(graphic,gX,gY,recList);}}}},{key:"renderSelfToGraphic",value:function renderSelfToGraphic(graphic,gX,gY,recList){var cssStyle=this.style;var words=this._getWords();var len;if(words){len=words.length;if(cssStyle){var font=cssStyle.font;var color=cssStyle.color;if(cssStyle.stroke){var stroke=cssStyle.stroke;stroke=parseInt(stroke);var strokeColor=cssStyle.strokeColor;graphic.fillBorderWords(words,gX,gY,font,color,strokeColor,stroke);}else{graphic.fillWords(words,gX,gY,font,color);}if(this.href){var lastIndex=words.length-1;var lastWords=words[lastIndex];var lineY=lastWords.y+lastWords.height;if(lastWords.y==words[0].y){if(cssStyle.textDecoration!="none")graphic.drawLine(words[0].x,lineY,lastWords.x+lastWords.width,lineY,color,1);var hitRec=HTMLHitRect.create();hitRec.rec.setTo(words[0].x,lastWords.y,lastWords.x+lastWords.width-words[0].x,lastWords.height);hitRec.href=this.href;recList.push(hitRec);}else{this.workLines(words,graphic,recList);}}}}}},{key:"workLines",value:function workLines(wordList,g,recList){var cssStyle=this.style;var hasLine;hasLine=cssStyle.textDecoration!="none";var i,len;len=wordList.length;var tStartWord;tStartWord=wordList[i];var tEndWord;tEndWord=tStartWord;if(!tStartWord)return;var tword;for(i=1;i<len;i++){tword=wordList[i];if(tword.y!=tStartWord.y){this.createOneLine(tStartWord,tEndWord,hasLine,g,recList);tStartWord=tword;tEndWord=tword;}else{tEndWord=tword;}}this.createOneLine(tStartWord,tEndWord,hasLine,g,recList);}},{key:"createOneLine",value:function createOneLine(startWord,lastWords,hasLine,graphic,recList){var lineY=lastWords.y+lastWords.height;if(hasLine)graphic.drawLine(startWord.x,lineY,lastWords.x+lastWords.width,lineY,this.style.color,1);var hitRec=HTMLHitRect.create();hitRec.rec.setTo(startWord.x,lastWords.y,lastWords.x+lastWords.width-startWord.x,lastWords.height);hitRec.href=this.href;recList.push(hitRec);}},{key:"id",set:function set(value){HTMLDocument.document.setElementById(value,this);}},{key:"innerTEXT",set:function set(value){if(this._text===HTMLElement._EMPTYTEXT){this._text={text:value,words:null};}else{this._text.text=value;this._text.words&&(this._text.words.length=0);}this.repaint();},get:function get(){return this._text.text;}},{key:"style",get:function get(){return this._style;}},{key:"x",set:function set(v){if(this._x!=v){this._x=v;this.parentRepaint();}},get:function get(){return this._x;}},{key:"y",set:function set(v){if(this._y!=v){this._y=v;this.parentRepaint();}},get:function get(){return this._y;}},{key:"width",get:function get(){return this._width;},set:function set(value){if(this._width!==value){this._width=value;this.repaint();}}},{key:"height",get:function get(){return this._height;},set:function set(value){if(this._height!==value){this._height=value;this.repaint();}}},{key:"href",set:function set(url){if(!this._style)return;if(url!=this._style.href){this._style.href=url;this.repaint();}},get:function get(){if(!this._style)return null;return this._style.href;}},{key:"color",set:function set(value){this.style.color=value;}},{key:"className",set:function set(value){this.style.attrs(HTMLDocument.document.styleSheets['.'+value]);}}],[{key:"formatURL1",value:function formatURL1(url){var basePath=arguments.length>1&&arguments[1]!==undefined?arguments[1]:null;if(!url)return"null path";if(!basePath)basePath=Laya.URL.basePath;if(url.indexOf(":")>0)return url;if(Laya.URL.customFormat!=null)url=Laya.URL.customFormat(url);if(url.indexOf(":")>0)return url;var char1=url.charAt(0);if(char1==="."){return Laya.URL._formatRelativePath(basePath+url);}else if(char1==='~'){return Laya.URL.rootPath+url.substring(1);}else if(char1==="d"){if(url.indexOf("data:image")===0)return url;}else if(char1==="/"){return url;}return basePath+url;}},{key:"getClassName",value:function getClassName(tar){if(tar instanceof Function)return tar.name;return tar["constructor"].name;}}]);return HTMLElement;}();HTMLElement._EMPTYTEXT={text:null,words:null};Laya.ILaya.regClass(HTMLElement);IHtml.HTMLElementType=exports.HTMLElementType;Laya.ClassUtils.regClass("laya.html.dom.HTMLElement",HTMLElement);Laya.ClassUtils.regClass("Laya.HTMLElement",HTMLElement);var HTMLBrElement=function(){function HTMLBrElement(){_classCallCheck(this,HTMLBrElement);}_createClass(HTMLBrElement,[{key:"_addToLayout",value:function _addToLayout(out){out.push(this);}},{key:"reset",value:function reset(){return this;}},{key:"destroy",value:function destroy(){Laya.Pool.recover(HTMLElement.getClassName(this),this.reset());}},{key:"_setParent",value:function _setParent(value){}},{key:"_getCSSStyle",value:function _getCSSStyle(){if(!HTMLBrElement.brStyle){HTMLBrElement.brStyle=new HTMLStyle();HTMLBrElement.brStyle.setLineElement(true);HTMLBrElement.brStyle.block=true;}return HTMLBrElement.brStyle;}},{key:"renderSelfToGraphic",value:function renderSelfToGraphic(graphic,gX,gY,recList){}},{key:"parent",set:function set(value){}},{key:"URI",set:function set(value){}},{key:"href",set:function set(value){}}]);return HTMLBrElement;}();IHtml.HTMLBrElement=HTMLBrElement;Laya.ILaya.regClass(HTMLBrElement);Laya.ClassUtils.regClass("laya.html.dom.HTMLBrElement",HTMLBrElement);Laya.ClassUtils.regClass("Laya.HTMLBrElement",HTMLBrElement);var HTMLStyleElement=function(_HTMLElement){_inherits(HTMLStyleElement,_HTMLElement);function HTMLStyleElement(){_classCallCheck(this,HTMLStyleElement);return _possibleConstructorReturn(this,(HTMLStyleElement.__proto__||Object.getPrototypeOf(HTMLStyleElement)).apply(this,arguments));}_createClass(HTMLStyleElement,[{key:"_creates",value:function _creates(){}},{key:"drawToGraphic",value:function drawToGraphic(graphic,gX,gY,recList){}},{key:"reset",value:function reset(){return this;}},{key:"innerTEXT",set:function set(value){HTMLStyle.parseCSS(value,null);},get:function get(){return _get(HTMLStyleElement.prototype.__proto__||Object.getPrototypeOf(HTMLStyleElement.prototype),"innerTEXT",this);}}]);return HTMLStyleElement;}(HTMLElement);Laya.ILaya.regClass(HTMLStyleElement);Laya.ClassUtils.regClass("laya.html.dom.HTMLStyleElement",HTMLStyleElement);Laya.ClassUtils.regClass("Laya.HTMLStyleElement",HTMLStyleElement);var HTMLLinkElement=function(_HTMLElement2){_inherits(HTMLLinkElement,_HTMLElement2);function HTMLLinkElement(){_classCallCheck(this,HTMLLinkElement);return _possibleConstructorReturn(this,(HTMLLinkElement.__proto__||Object.getPrototypeOf(HTMLLinkElement)).apply(this,arguments));}_createClass(HTMLLinkElement,[{key:"_creates",value:function _creates(){}},{key:"drawToGraphic",value:function drawToGraphic(graphic,gX,gY,recList){}},{key:"reset",value:function reset(){if(this._loader)this._loader.off(Laya.Event.COMPLETE,this,this._onload);this._loader=null;return this;}},{key:"_onload",value:function _onload(data){if(this._loader)this._loader=null;switch(this.type){case'text/css':HTMLStyle.parseCSS(data,this.URI);break;}this.repaint(true);}},{key:"href",set:function set(url){if(!url)return;url=this.formatURL(url);this.URI=new Laya.URL(url);if(this._loader)this._loader.off(Laya.Event.COMPLETE,this,this._onload);if(Laya.Loader.getRes(url)){if(this.type=="text/css"){HTMLStyle.parseCSS(Laya.Loader.getRes(url),this.URI);}return;}this._loader=new Laya.Loader();this._loader.once(Laya.Event.COMPLETE,this,this._onload);this._loader.load(url,Laya.Loader.TEXT);},get:function get(){return _get(HTMLLinkElement.prototype.__proto__||Object.getPrototypeOf(HTMLLinkElement.prototype),"href",this);}}]);return HTMLLinkElement;}(HTMLElement);HTMLLinkElement._cuttingStyle=new RegExp("((@keyframes[\\s\\t]+|)(.+))[\\t\\n\\r\\\s]*{","g");Laya.ILaya.regClass(HTMLLinkElement);Laya.ClassUtils.regClass("laya.html.dom.HTMLLinkElement",HTMLLinkElement);Laya.ClassUtils.regClass("Laya.HTMLLinkElement",HTMLLinkElement);var HTMLDivParser=function(_HTMLElement3){_inherits(HTMLDivParser,_HTMLElement3);function HTMLDivParser(){_classCallCheck(this,HTMLDivParser);var _this116=_possibleConstructorReturn(this,(HTMLDivParser.__proto__||Object.getPrototypeOf(HTMLDivParser)).apply(this,arguments));_this116.repaintHandler=null;return _this116;}_createClass(HTMLDivParser,[{key:"reset",value:function reset(){_get(HTMLDivParser.prototype.__proto__||Object.getPrototypeOf(HTMLDivParser.prototype),"reset",this).call(this);this._style.block=true;this._style.setLineElement(true);this._style.width=200;this._style.height=200;this.repaintHandler=null;this.contextHeight=0;this.contextWidth=0;return this;}},{key:"appendHTML",value:function appendHTML(text){IHtml.HTMLParse.parse(this,text,this.URI);this.layout();}},{key:"_addChildsToLayout",value:function _addChildsToLayout(out){var words=this._getWords();if(words==null&&(!this._children||this._children.length==0))return false;words&&words.forEach(function(o){out.push(o);});var tFirstKey=true;for(var i=0,len=this._children.length;i<len;i++){var o=this._children[i];if(tFirstKey){tFirstKey=false;}else{out.push(null);}o._addToLayout(out);}return true;}},{key:"_addToLayout",value:function _addToLayout(out){this.layout();!this.style.absolute&&out.push(this);}},{key:"getBounds",value:function getBounds(){if(!this._htmlBounds)return null;if(!this._boundsRec)this._boundsRec=Laya.Rectangle.create();return this._boundsRec.copyFrom(this._htmlBounds);}},{key:"parentRepaint",value:function parentRepaint(){var recreate=arguments.length>0&&arguments[0]!==undefined?arguments[0]:false;_get(HTMLDivParser.prototype.__proto__||Object.getPrototypeOf(HTMLDivParser.prototype),"parentRepaint",this).call(this);if(this.repaintHandler)this.repaintHandler.runWith(recreate);}},{key:"layout",value:function layout(){this.style._type|=HTMLStyle.ADDLAYOUTED;var tArray=Layout.layout(this);if(tArray){if(!this._htmlBounds)this._htmlBounds=Laya.Rectangle.create();var tRectangle=this._htmlBounds;tRectangle.x=tRectangle.y=0;tRectangle.width=this.contextWidth=tArray[0];tRectangle.height=this.contextHeight=tArray[1];}}},{key:"innerHTML",set:function set(text){this.destroyChildren();this.appendHTML(text);}},{key:"width",set:function set(value){var changed;if(value===0){changed=value!=this._width;}else{changed=value!=this.width;}_set(HTMLDivParser.prototype.__proto__||Object.getPrototypeOf(HTMLDivParser.prototype),"width",value,this);if(changed)this.layout();},get:function get(){if(this._width)return this._width;return this.contextWidth;}},{key:"height",get:function get(){if(this._height)return this._height;return this.contextHeight;},set:function set(value){_set(HTMLDivParser.prototype.__proto__||Object.getPrototypeOf(HTMLDivParser.prototype),"height",value,this);}}]);return HTMLDivParser;}(HTMLElement);IHtml.HTMLDivParser=HTMLDivParser;Laya.ILaya.regClass(HTMLDivParser);Laya.ClassUtils.regClass("laya.html.dom.HTMLDivParser",HTMLDivParser);Laya.ClassUtils.regClass("Laya.HTMLDivParser",HTMLDivParser);var HTMLImageElement=function(_HTMLElement4){_inherits(HTMLImageElement,_HTMLElement4);function HTMLImageElement(){_classCallCheck(this,HTMLImageElement);var _this117=_possibleConstructorReturn(this,(HTMLImageElement.__proto__||Object.getPrototypeOf(HTMLImageElement)).call(this));_this117.eletype=exports.HTMLElementType.IMAGE;return _this117;}_createClass(HTMLImageElement,[{key:"reset",value:function reset(){_get(HTMLImageElement.prototype.__proto__||Object.getPrototypeOf(HTMLImageElement.prototype),"reset",this).call(this);if(this._tex){this._tex.off(Laya.Event.LOADED,this,this.onloaded);}this._tex=null;this._url=null;return this;}},{key:"onloaded",value:function onloaded(){if(!this._style)return;var style=this._style;var w=style.widthed(this)?-1:this._tex.width;var h=style.heighted(this)?-1:this._tex.height;if(!style.widthed(this)&&this._width!=this._tex.width){this.width=this._tex.width;this.parent&&this.parent._layoutLater();}if(!style.heighted(this)&&this._height!=this._tex.height){this.height=this._tex.height;this.parent&&this.parent._layoutLater();}this.repaint();}},{key:"_addToLayout",value:function _addToLayout(out){var style=this._style;!style.absolute&&out.push(this);}},{key:"renderSelfToGraphic",value:function renderSelfToGraphic(graphic,gX,gY,recList){if(!this._tex)return;graphic.drawImage(this._tex,gX,gY,this.width||this._tex.width,this.height||this._tex.height);}},{key:"src",set:function set(url){url=this.formatURL(url);if(this._url===url)return;this._url=url;var tex=this._tex=Laya.Loader.getRes(url);if(!tex){this._tex=tex=new Laya.Texture();tex.load(url);Laya.Loader.cacheTexture(url,tex);}tex.getIsReady()?this.onloaded():tex.once(Laya.Event.READY,this,this.onloaded);}}]);return HTMLImageElement;}(HTMLElement);IHtml.HTMLImageElement=HTMLImageElement;Laya.ILaya.regClass(HTMLImageElement);Laya.ClassUtils.regClass("laya.html.dom.HTMLImageElement",HTMLImageElement);Laya.ClassUtils.regClass("Laya.HTMLImageElement",HTMLImageElement);var HTMLParse=function(){function HTMLParse(){_classCallCheck(this,HTMLParse);}_createClass(HTMLParse,null,[{key:"getInstance",value:function getInstance(type){var rst=Laya.Pool.getItem(HTMLParse._htmlClassMapShort[type]);if(!rst){rst=Laya.ClassUtils.getInstance(type);}return rst;}},{key:"parse",value:function parse(ower,xmlString,url){xmlString=xmlString.replace(/<br>/g,"<br/>");xmlString="<root>"+xmlString+"</root>";xmlString=xmlString.replace(HTMLParse.spacePattern,HTMLParse.char255);var xml=Laya.Utils.parseXMLFromString(xmlString);HTMLParse._parseXML(ower,xml.childNodes[0].childNodes,url);}},{key:"_parseXML",value:function _parseXML(parent,xml,url){var href=arguments.length>3&&arguments[3]!==undefined?arguments[3]:null;var i,n;if(xml.join||xml.item){for(i=0,n=xml.length;i<n;++i){HTMLParse._parseXML(parent,xml[i],url,href);}}else{var node;var nodeName;if(xml.nodeType==3){var txt;if(parent instanceof IHtml.HTMLDivParser){if(xml.nodeName==null){xml.nodeName="#text";}nodeName=xml.nodeName.toLowerCase();txt=xml.textContent.replace(/^\s+|\s+$/g,'');if(txt.length>0){node=HTMLParse.getInstance(nodeName);if(node){parent.addChild(node);node.innerTEXT=txt.replace(HTMLParse.char255AndOneSpacePattern," ");}}}else{txt=xml.textContent.replace(/^\s+|\s+$/g,'');if(txt.length>0){var containNode=parent;if(parent instanceof HTMLElement&&parent.innerTEXT&&parent.innerTEXT.length>0){var cnode=HTMLParse.getInstance('p');if(cnode){parent.addChild(cnode);containNode=cnode;}}containNode.innerTEXT=txt.replace(HTMLParse.char255AndOneSpacePattern," ");}}return;}else{nodeName=xml.nodeName.toLowerCase();if(nodeName=="#comment")return;node=HTMLParse.getInstance(nodeName);if(node){if(nodeName=="p"){parent.addChild(HTMLParse.getInstance("br"));node=parent.addChild(node);parent.addChild(HTMLParse.getInstance("br"));}else{node=parent.addChild(node);}node.URI=url;node.href=href;var attributes=xml.attributes;if(attributes&&attributes.length>0){for(i=0,n=attributes.length;i<n;++i){var attribute=attributes[i];var attrName=attribute.nodeName;var value=attribute.value;node._setAttributes(attrName,value);}}HTMLParse._parseXML(node,xml.childNodes,url,node.href);}else{HTMLParse._parseXML(parent,xml.childNodes,url,href);}}}}}]);return HTMLParse;}();HTMLParse.char255=String.fromCharCode(255);HTMLParse.spacePattern=/&nbsp;|&#160;/g;HTMLParse.char255AndOneSpacePattern=new RegExp(String.fromCharCode(255)+"|(\\s+)","g");HTMLParse._htmlClassMapShort={'div':HTMLDivParser,'p':HTMLElement,'img':HTMLImageElement,'span':HTMLElement,'br':HTMLBrElement,'style':HTMLStyleElement,'font':HTMLElement,'a':HTMLElement,'#text':HTMLElement,'link':HTMLLinkElement};IHtml.HTMLParse=HTMLParse;Laya.ClassUtils.regClass('div',HTMLDivParser);Laya.ClassUtils.regClass('p',HTMLElement);Laya.ClassUtils.regClass('img',HTMLImageElement);Laya.ClassUtils.regClass('span',HTMLElement);Laya.ClassUtils.regClass('br',HTMLBrElement);Laya.ClassUtils.regClass('style',HTMLStyleElement);Laya.ClassUtils.regClass('font',HTMLElement);Laya.ClassUtils.regClass('a',HTMLElement);Laya.ClassUtils.regClass('#text',HTMLElement);Laya.ClassUtils.regClass('link',HTMLLinkElement);Laya.ClassUtils.regClass("laya.html.utils.HTMLParse",HTMLParse);Laya.ClassUtils.regClass("Laya.HTMLParse",HTMLParse);var HTMLDivElement=function(_Laya$Sprite3){_inherits(HTMLDivElement,_Laya$Sprite3);function HTMLDivElement(){_classCallCheck(this,HTMLDivElement);var _this118=_possibleConstructorReturn(this,(HTMLDivElement.__proto__||Object.getPrototypeOf(HTMLDivElement)).call(this));_this118._recList=[];_this118._repaintState=0;_this118._element=new HTMLDivParser();_this118._element.repaintHandler=new Laya.Handler(_this118,_this118._htmlDivRepaint);_this118.mouseEnabled=true;_this118.on(Laya.Event.CLICK,_this118,_this118._onMouseClick);return _this118;}_createClass(HTMLDivElement,[{key:"destroy",value:function destroy(){var destroyChild=arguments.length>0&&arguments[0]!==undefined?arguments[0]:true;if(this._element)this._element.reset();this._element=null;this._doClears();_get(HTMLDivElement.prototype.__proto__||Object.getPrototypeOf(HTMLDivElement.prototype),"destroy",this).call(this,destroyChild);}},{key:"_htmlDivRepaint",value:function _htmlDivRepaint(){var recreate=arguments.length>0&&arguments[0]!==undefined?arguments[0]:false;if(recreate){if(this._repaintState<2)this._repaintState=2;}else{if(this._repaintState<1)this._repaintState=1;}if(this._repaintState>0)this._setGraphicDirty();}},{key:"_updateGraphicWork",value:function _updateGraphicWork(){switch(this._repaintState){case 1:this._updateGraphic();break;case 2:this._refresh();break;}}},{key:"_setGraphicDirty",value:function _setGraphicDirty(){this.callLater(this._updateGraphicWork);}},{key:"_doClears",value:function _doClears(){if(!this._recList)return;var i,len=this._recList.length;var tRec;for(i=0;i<len;i++){tRec=this._recList[i];tRec.recover();}this._recList.length=0;}},{key:"_updateGraphic",value:function _updateGraphic(){this._doClears();this.graphics.clear(true);this._repaintState=0;this._element.drawToGraphic(this.graphics,-this._element.x,-this._element.y,this._recList);var bounds=this._element.getBounds();if(bounds)this.setSelfBounds(bounds);this.size(bounds.width,bounds.height);}},{key:"_refresh",value:function _refresh(){this._repaintState=1;if(this._innerHTML)this._element.innerHTML=this._innerHTML;this._setGraphicDirty();}},{key:"_onMouseClick",value:function _onMouseClick(){var tX=this.mouseX;var tY=this.mouseY;var i,len;var tHit;len=this._recList.length;for(i=0;i<len;i++){tHit=this._recList[i];if(tHit.rec.contains(tX,tY)){this._eventLink(tHit.href);}}}},{key:"_eventLink",value:function _eventLink(href){this.event(Laya.Event.LINK,[href]);}},{key:"style",get:function get(){return this._element.style;}},{key:"innerHTML",set:function set(text){if(this._innerHTML==text)return;this._repaintState=1;this._innerHTML=text;this._element.innerHTML=text;this._setGraphicDirty();//todo fck
this.event(/*laya.events.Event.CHANGE*/"change");}},{key:"contextWidth",get:function get(){return this._element.contextWidth;}},{key:"contextHeight",get:function get(){return this._element.contextHeight;}}]);return HTMLDivElement;}(Laya.Sprite);IHtml.HTMLDivElement=HTMLDivElement;IHtml.HTMLParse=HTMLParse;Laya.ClassUtils.regClass("laya.html.dom.HTMLDivElement",HTMLDivElement);Laya.ClassUtils.regClass("Laya.HTMLDivElement",HTMLDivElement);var HTMLIframeElement=function(_HTMLDivElement){_inherits(HTMLIframeElement,_HTMLDivElement);function HTMLIframeElement(){_classCallCheck(this,HTMLIframeElement);var _this119=_possibleConstructorReturn(this,(HTMLIframeElement.__proto__||Object.getPrototypeOf(HTMLIframeElement)).call(this));_this119._element._getCSSStyle().valign="middle";return _this119;}_createClass(HTMLIframeElement,[{key:"href",set:function set(url){var _this120=this;url=this._element.formatURL(url);var l=new Laya.Loader();l.once(Laya.Event.COMPLETE,null,function(data){var pre=_this120._element.URI;_this120._element.URI=new Laya.URL(url);_this120.innerHTML=data;!pre||(_this120._element.URI=pre);});l.load(url,Laya.Loader.TEXT);}}]);return HTMLIframeElement;}(HTMLDivElement);Laya.ClassUtils.regClass("laya.html.dom.HTMLIframeElement",HTMLIframeElement);Laya.ClassUtils.regClass("Laya.HTMLIframeElement",HTMLIframeElement);exports.HTMLBrElement=HTMLBrElement;exports.HTMLDivElement=HTMLDivElement;exports.HTMLDivParser=HTMLDivParser;exports.HTMLDocument=HTMLDocument;exports.HTMLElement=HTMLElement;exports.HTMLExtendStyle=HTMLExtendStyle;exports.HTMLHitRect=HTMLHitRect;exports.HTMLIframeElement=HTMLIframeElement;exports.HTMLImageElement=HTMLImageElement;exports.HTMLLinkElement=HTMLLinkElement;exports.HTMLParse=HTMLParse;exports.HTMLStyle=HTMLStyle;exports.HTMLStyleElement=HTMLStyleElement;exports.IHtml=IHtml;exports.Layout=Layout;exports.LayoutLine=LayoutLine;})(window.Laya=window.Laya||{},Laya);(function(exports,Laya){'use strict';var IAniLib=function IAniLib(){_classCallCheck(this,IAniLib);};IAniLib.Skeleton=null;IAniLib.AnimationTemplet=null;IAniLib.Templet=null;var AnimationContent=function AnimationContent(){_classCallCheck(this,AnimationContent);};var AnimationNodeContent=function AnimationNodeContent(){_classCallCheck(this,AnimationNodeContent);};var KeyFramesContent=function KeyFramesContent(){_classCallCheck(this,KeyFramesContent);};var AnimationParser01=function(){function AnimationParser01(){_classCallCheck(this,AnimationParser01);}_createClass(AnimationParser01,null,[{key:"parse",value:function parse(templet,reader){var data=reader.__getBuffer();var i,j,k,n,l,m,o;var aniClassName=reader.readUTFString();templet._aniClassName=aniClassName;var strList=reader.readUTFString().split("\n");var aniCount=reader.getUint8();var publicDataPos=reader.getUint32();var publicExtDataPos=reader.getUint32();var publicData;if(publicDataPos>0)publicData=data.slice(publicDataPos,publicExtDataPos);var publicRead=new Laya.Byte(publicData);if(publicExtDataPos>0)templet._publicExtData=data.slice(publicExtDataPos,data.byteLength);templet._useParent=!!reader.getUint8();templet._anis.length=aniCount;for(i=0;i<aniCount;i++){var ani=templet._anis[i]=new AnimationContent();ani.nodes=[];var name=ani.name=strList[reader.getUint16()];templet._aniMap[name]=i;ani.bone3DMap={};ani.playTime=reader.getFloat32();var boneCount=ani.nodes.length=reader.getUint8();ani.totalKeyframeDatasLength=0;for(j=0;j<boneCount;j++){var node=ani.nodes[j]=new AnimationNodeContent();node.childs=[];var nameIndex=reader.getInt16();if(nameIndex>=0){node.name=strList[nameIndex];ani.bone3DMap[node.name]=j;}node.keyFrame=[];node.parentIndex=reader.getInt16();node.parentIndex==-1?node.parent=null:node.parent=ani.nodes[node.parentIndex];node.lerpType=reader.getUint8();var keyframeParamsOffset=reader.getUint32();publicRead.pos=keyframeParamsOffset;var keyframeDataCount=node.keyframeWidth=publicRead.getUint16();ani.totalKeyframeDatasLength+=keyframeDataCount;if(node.lerpType===0||node.lerpType===1){node.interpolationMethod=[];node.interpolationMethod.length=keyframeDataCount;for(k=0;k<keyframeDataCount;k++){node.interpolationMethod[k]=IAniLib.AnimationTemplet.interpolation[publicRead.getUint8()];}}if(node.parent!=null)node.parent.childs.push(node);var privateDataLen=reader.getUint16();if(privateDataLen>0){node.extenData=data.slice(reader.pos,reader.pos+privateDataLen);reader.pos+=privateDataLen;}var keyframeCount=reader.getUint16();node.keyFrame.length=keyframeCount;var startTime=0;var keyFrame;for(k=0,n=keyframeCount;k<n;k++){keyFrame=node.keyFrame[k]=new KeyFramesContent();keyFrame.duration=reader.getFloat32();keyFrame.startTime=startTime;if(node.lerpType===2){keyFrame.interpolationData=[];var interDataLength=reader.getUint8();var lerpType;lerpType=reader.getFloat32();switch(lerpType){case 254:keyFrame.interpolationData.length=keyframeDataCount;for(o=0;o<keyframeDataCount;o++){keyFrame.interpolationData[o]=0;}break;case 255:keyFrame.interpolationData.length=keyframeDataCount;for(o=0;o<keyframeDataCount;o++){keyFrame.interpolationData[o]=5;}break;default:keyFrame.interpolationData.push(lerpType);for(m=1;m<interDataLength;m++){keyFrame.interpolationData.push(reader.getFloat32());}}}/** lc **/keyFrame.data=reader.readFloat32Array(reader._pos_,keyframeDataCount*4);/*
            keyFrame.data = new Float32Array(keyframeDataCount);
            keyFrame.dData = new Float32Array(keyframeDataCount);
            keyFrame.nextData = new Float32Array(keyframeDataCount);
            for (l = 0; l < keyframeDataCount; l++) {
                keyFrame.data[l] = reader.getFloat32();
                if (keyFrame.data[l] > -0.00000001 && keyFrame.data[l] < 0.00000001)
                    keyFrame.data[l] = 0;
            }
            */startTime+=keyFrame.duration;}keyFrame.startTime=ani.playTime;node.playTime=ani.playTime;templet._calculateKeyFrame(node,keyframeCount,keyframeDataCount);}}}}]);return AnimationParser01;}();var AnimationParser02=function(){function AnimationParser02(){_classCallCheck(this,AnimationParser02);}_createClass(AnimationParser02,null,[{key:"READ_DATA",value:function READ_DATA(){AnimationParser02._DATA.offset=AnimationParser02._reader.getUint32();AnimationParser02._DATA.size=AnimationParser02._reader.getUint32();}},{key:"READ_BLOCK",value:function READ_BLOCK(){var count=AnimationParser02._BLOCK.count=AnimationParser02._reader.getUint16();var blockStarts=AnimationParser02._BLOCK.blockStarts=[];var blockLengths=AnimationParser02._BLOCK.blockLengths=[];for(var i=0;i<count;i++){blockStarts.push(AnimationParser02._reader.getUint32());blockLengths.push(AnimationParser02._reader.getUint32());}}},{key:"READ_STRINGS",value:function READ_STRINGS(){var offset=AnimationParser02._reader.getUint32();var count=AnimationParser02._reader.getUint16();var prePos=AnimationParser02._reader.pos;AnimationParser02._reader.pos=offset+AnimationParser02._DATA.offset;for(var i=0;i<count;i++){AnimationParser02._strings[i]=AnimationParser02._reader.readUTFString();}AnimationParser02._reader.pos=prePos;}},{key:"parse",value:function parse(templet,reader){AnimationParser02._templet=templet;AnimationParser02._reader=reader;var arrayBuffer=reader.__getBuffer();AnimationParser02.READ_DATA();AnimationParser02.READ_BLOCK();AnimationParser02.READ_STRINGS();for(var i=0,n=AnimationParser02._BLOCK.count;i<n;i++){var index=reader.getUint16();var blockName=AnimationParser02._strings[index];var fn=AnimationParser02["READ_"+blockName];if(fn==null)throw new Error("model file err,no this function:"+index+" "+blockName);else fn.call(null);}}},{key:"READ_ANIMATIONS",value:function READ_ANIMATIONS(){var reader=AnimationParser02._reader;var arrayBuffer=reader.__getBuffer();var i,j,k,n;var keyframeWidth=reader.getUint16();var interpolationMethod=[];interpolationMethod.length=keyframeWidth;for(i=0;i<keyframeWidth;i++){interpolationMethod[i]=IAniLib.AnimationTemplet.interpolation[reader.getByte()];}var aniCount=reader.getUint8();AnimationParser02._templet._anis.length=aniCount;for(i=0;i<aniCount;i++){var ani=AnimationParser02._templet._anis[i]=new AnimationContent();ani.nodes=[];var aniName=ani.name=AnimationParser02._strings[reader.getUint16()];AnimationParser02._templet._aniMap[aniName]=i;ani.bone3DMap={};ani.playTime=reader.getFloat32();var boneCount=ani.nodes.length=reader.getInt16();ani.totalKeyframeDatasLength=0;for(j=0;j<boneCount;j++){var node=ani.nodes[j]=new AnimationNodeContent();node.keyframeWidth=keyframeWidth;node.childs=[];var nameIndex=reader.getUint16();if(nameIndex>=0){node.name=AnimationParser02._strings[nameIndex];ani.bone3DMap[node.name]=j;}node.keyFrame=[];node.parentIndex=reader.getInt16();node.parentIndex==-1?node.parent=null:node.parent=ani.nodes[node.parentIndex];ani.totalKeyframeDatasLength+=keyframeWidth;node.interpolationMethod=interpolationMethod;if(node.parent!=null)node.parent.childs.push(node);var keyframeCount=reader.getUint16();node.keyFrame.length=keyframeCount;var keyFrame=null,lastKeyFrame=null;for(k=0,n=keyframeCount;k<n;k++){keyFrame=node.keyFrame[k]=new KeyFramesContent();keyFrame.startTime=reader.getFloat32();lastKeyFrame&&(lastKeyFrame.duration=keyFrame.startTime-lastKeyFrame.startTime);keyFrame.dData=new Float32Array(keyframeWidth);keyFrame.nextData=new Float32Array(keyframeWidth);var offset=AnimationParser02._DATA.offset;var keyframeDataOffset=reader.getUint32();var keyframeDataLength=keyframeWidth*4;var keyframeArrayBuffer=arrayBuffer.slice(offset+keyframeDataOffset,offset+keyframeDataOffset+keyframeDataLength);keyFrame.data=new Float32Array(keyframeArrayBuffer);lastKeyFrame=keyFrame;}keyFrame.duration=0;node.playTime=ani.playTime;AnimationParser02._templet._calculateKeyFrame(node,keyframeCount,keyframeWidth);}}}}]);return AnimationParser02;}();AnimationParser02._strings=[];AnimationParser02._BLOCK={count:0};AnimationParser02._DATA={offset:0,size:0};var AnimationState=function AnimationState(){_classCallCheck(this,AnimationState);};AnimationState.stopped=0;AnimationState.paused=1;AnimationState.playing=2;var AnimationPlayer=function(_Laya$EventDispatcher){_inherits(AnimationPlayer,_Laya$EventDispatcher);function AnimationPlayer(){_classCallCheck(this,AnimationPlayer);var _this121=_possibleConstructorReturn(this,(AnimationPlayer.__proto__||Object.getPrototypeOf(AnimationPlayer)).call(this));_this121.isCache=true;_this121.playbackRate=1.0;_this121._destroyed=false;_this121._currentAnimationClipIndex=-1;_this121._currentKeyframeIndex=-1;_this121._currentTime=0.0;_this121._overallDuration=Number.MAX_VALUE;_this121._stopWhenCircleFinish=false;_this121._elapsedPlaybackTime=0;_this121._startUpdateLoopCount=-1;_this121._cachePlayRate=1.0;_this121.cacheFrameRate=60;_this121.returnToZeroStopped=false;return _this121;}_createClass(AnimationPlayer,[{key:"_onTempletLoadedComputeFullKeyframeIndices",value:function _onTempletLoadedComputeFullKeyframeIndices(cachePlayRate,cacheFrameRate,templet){if(this._templet===templet&&this._cachePlayRate===cachePlayRate&&this._cacheFrameRate===cacheFrameRate)this._computeFullKeyframeIndices();}},{key:"_computeFullKeyframeIndices",value:function _computeFullKeyframeIndices(){return;var templet=this._templet;if(templet._fullFrames)return;var anifullFrames=this._templet._fullFrames=[];var cacheFrameInterval=this._cacheFrameRateInterval*this._cachePlayRate;for(var i=0,iNum=templet.getAnimationCount();i<iNum;i++){var aniFullFrame=[];if(!templet.getAnimation(i).nodes){anifullFrames.push(aniFullFrame);continue;}for(var j=0,jNum=templet.getAnimation(i).nodes.length;j<jNum;j++){var node=templet.getAnimation(i).nodes[j];var frameCount=Math.round(node.playTime/cacheFrameInterval);var nodeFullFrames=new Uint16Array(frameCount+1);var stidx=-1;var nodeframes=node.keyFrame;for(var n=0,nNum=nodeframes.length;n<nNum;n++){var keyFrame=nodeframes[n];var pos=Math.round(keyFrame.startTime/cacheFrameInterval);if(stidx<0&&pos>0){stidx=pos;}if(pos<=frameCount){nodeFullFrames[pos]=n;}}var cf=0;for(n=stidx;n<frameCount;n++){if(nodeFullFrames[n]==0){nodeFullFrames[n]=cf;}else{cf=nodeFullFrames[n];}}aniFullFrame.push(nodeFullFrames);}anifullFrames.push(aniFullFrame);}}},{key:"_onAnimationTempletLoaded",value:function _onAnimationTempletLoaded(){this.destroyed||this._calculatePlayDuration();}},{key:"_calculatePlayDuration",value:function _calculatePlayDuration(){if(this.state!==AnimationState.stopped){var oriDuration=this._templet.getAniDuration(this._currentAnimationClipIndex);this._playEnd===0&&(this._playEnd=oriDuration);if(this._playEnd>oriDuration)this._playEnd=oriDuration;this._playDuration=this._playEnd-this._playStart;}}},{key:"_setPlayParams",value:function _setPlayParams(time,cacheFrameInterval){this._currentTime=time;this._currentKeyframeIndex=Math.floor(this.currentPlayTime/cacheFrameInterval+0.01);this._currentFrameTime=this._currentKeyframeIndex*cacheFrameInterval;}},{key:"_setPlayParamsWhenStop",value:function _setPlayParamsWhenStop(currentAniClipPlayDuration,cacheFrameInterval){var playEnd=arguments.length>2&&arguments[2]!==undefined?arguments[2]:-1;this._currentTime=currentAniClipPlayDuration;var endTime=playEnd>0?playEnd:currentAniClipPlayDuration;this._currentKeyframeIndex=Math.floor(endTime/cacheFrameInterval+0.01);this._currentKeyframeIndex=Math.floor(currentAniClipPlayDuration/cacheFrameInterval+0.01);this._currentFrameTime=this._currentKeyframeIndex*cacheFrameInterval;this._currentAnimationClipIndex=-1;}},{key:"_update",value:function _update(elapsedTime){if(this._currentAnimationClipIndex===-1||this._paused||!this._templet)return;var cacheFrameInterval=this._cacheFrameRateInterval*this._cachePlayRate;var time=0;this._startUpdateLoopCount!==Laya.Stat.loopCount&&(time=elapsedTime*this.playbackRate,this._elapsedPlaybackTime+=time);var currentAniClipPlayDuration=this.playDuration;time+=this._currentTime;if(this._overallDuration!==0&&this._elapsedPlaybackTime>=this._overallDuration||this._overallDuration===0&&this._elapsedPlaybackTime>=currentAniClipPlayDuration||this._overallDuration===0&&time>=this.playEnd){this._setPlayParamsWhenStop(currentAniClipPlayDuration,cacheFrameInterval,this.playEnd);this.event(Laya.Event.STOPPED);return;}if(currentAniClipPlayDuration>0){if(time>=currentAniClipPlayDuration){if(this._stopWhenCircleFinish){this._setPlayParamsWhenStop(currentAniClipPlayDuration,cacheFrameInterval);this._stopWhenCircleFinish=false;this.event(Laya.Event.STOPPED);return;}else{time=time%currentAniClipPlayDuration;this._setPlayParams(time,cacheFrameInterval);this.event(Laya.Event.COMPLETE);return;}}else{this._setPlayParams(time,cacheFrameInterval);}}else{if(this._stopWhenCircleFinish){this._setPlayParamsWhenStop(currentAniClipPlayDuration,cacheFrameInterval);this._stopWhenCircleFinish=false;this.event(Laya.Event.STOPPED);return;}this._currentTime=this._currentFrameTime=this._currentKeyframeIndex=0;this.event(Laya.Event.COMPLETE);}}},{key:"_destroy",value:function _destroy(){this.offAll();this._templet=null;this._destroyed=true;}},{key:"play",value:function play(){var index=arguments.length>0&&arguments[0]!==undefined?arguments[0]:0;var playbackRate=arguments.length>1&&arguments[1]!==undefined?arguments[1]:1.0;var overallDuration=arguments.length>2&&arguments[2]!==undefined?arguments[2]:2147483647;var playStart=arguments.length>3&&arguments[3]!==undefined?arguments[3]:0;var playEnd=arguments.length>4&&arguments[4]!==undefined?arguments[4]:0;if(!this._templet)throw new Error("AnimationPlayer:templet must not be null,maybe you need to set url.");if(overallDuration<0||playStart<0||playEnd<0)throw new Error("AnimationPlayer:overallDuration,playStart and playEnd must large than zero.");if(playEnd!==0&&playStart>playEnd)throw new Error("AnimationPlayer:start must less than end.");this._currentTime=0;this._currentFrameTime=0;this._elapsedPlaybackTime=0;this.playbackRate=playbackRate;this._overallDuration=overallDuration;this._playStart=playStart;this._playEnd=playEnd;this._paused=false;this._currentAnimationClipIndex=index;this._currentKeyframeIndex=0;this._startUpdateLoopCount=Laya.Stat.loopCount;this.event(Laya.Event.PLAYED);this._calculatePlayDuration();this._update(0);}},{key:"playByFrame",value:function playByFrame(){var index=arguments.length>0&&arguments[0]!==undefined?arguments[0]:0;var playbackRate=arguments.length>1&&arguments[1]!==undefined?arguments[1]:1.0;var overallDuration=arguments.length>2&&arguments[2]!==undefined?arguments[2]:2147483647;var playStartFrame=arguments.length>3&&arguments[3]!==undefined?arguments[3]:0;var playEndFrame=arguments.length>4&&arguments[4]!==undefined?arguments[4]:0;var fpsIn3DBuilder=arguments.length>5&&arguments[5]!==undefined?arguments[5]:30;var interval=1000.0/fpsIn3DBuilder;this.play(index,playbackRate,overallDuration,playStartFrame*interval,playEndFrame*interval);}},{key:"stop",value:function stop(){var immediate=arguments.length>0&&arguments[0]!==undefined?arguments[0]:true;if(immediate){this._currentTime=this._currentFrameTime=this._currentKeyframeIndex=0;this._currentAnimationClipIndex=-1;this.event(Laya.Event.STOPPED);}else{this._stopWhenCircleFinish=true;}}},{key:"destroy",value:function destroy(){}},{key:"templet",get:function get(){return this._templet;},set:function set(value){if(!(this.state===AnimationState.stopped))this.stop(true);if(this._templet!==value){this._templet=value;this._computeFullKeyframeIndices();}}},{key:"playStart",get:function get(){return this._playStart;}},{key:"playEnd",get:function get(){return this._playEnd;}},{key:"playDuration",get:function get(){return this._playDuration;}},{key:"overallDuration",get:function get(){return this._overallDuration;}},{key:"currentAnimationClipIndex",get:function get(){return this._currentAnimationClipIndex;}},{key:"currentKeyframeIndex",get:function get(){return this._currentKeyframeIndex;}},{key:"currentPlayTime",get:function get(){return this._currentTime+this._playStart;}},{key:"currentFrameTime",get:function get(){return this._currentFrameTime;}},{key:"cachePlayRate",get:function get(){return this._cachePlayRate;},set:function set(value){if(this._cachePlayRate!==value){this._cachePlayRate=value;if(this._templet)this._computeFullKeyframeIndices();}}},{key:"cacheFrameRate",get:function get(){return this._cacheFrameRate;},set:function set(value){if(this._cacheFrameRate!==value){this._cacheFrameRate=value;this._cacheFrameRateInterval=1000.0/this._cacheFrameRate;if(this._templet)this._computeFullKeyframeIndices();}}},{key:"currentTime",set:function set(value){if(this._currentAnimationClipIndex===-1||!this._templet)return;if(value<this._playStart||value>this._playEnd)throw new Error("AnimationPlayer:value must large than playStartTime,small than playEndTime.");this._startUpdateLoopCount=Laya.Stat.loopCount;var cacheFrameInterval=this._cacheFrameRateInterval*this._cachePlayRate;this._currentTime=value;this._currentKeyframeIndex=Math.floor(this.currentPlayTime/cacheFrameInterval);this._currentFrameTime=this._currentKeyframeIndex*cacheFrameInterval;}},{key:"paused",get:function get(){return this._paused;},set:function set(value){this._paused=value;value&&this.event(Laya.Event.PAUSED);}},{key:"cacheFrameRateInterval",get:function get(){return this._cacheFrameRateInterval;}},{key:"state",get:function get(){if(this._currentAnimationClipIndex===-1)return AnimationState.stopped;if(this._paused)return AnimationState.paused;return AnimationState.playing;}},{key:"destroyed",get:function get(){return this._destroyed;}}]);return AnimationPlayer;}(Laya.EventDispatcher);var BezierLerp=function(){function BezierLerp(){_classCallCheck(this,BezierLerp);}_createClass(BezierLerp,null,[{key:"getBezierRate",value:function getBezierRate(t,px0,py0,px1,py1){var key=BezierLerp._getBezierParamKey(px0,py0,px1,py1);var vKey=key*100+t;if(BezierLerp._bezierResultCache[vKey])return BezierLerp._bezierResultCache[vKey];var points=BezierLerp._getBezierPoints(px0,py0,px1,py1,key);var i,len;len=points.length;for(i=0;i<len;i+=2){if(t<=points[i]){BezierLerp._bezierResultCache[vKey]=points[i+1];return points[i+1];}}BezierLerp._bezierResultCache[vKey]=1;return 1;}},{key:"_getBezierParamKey",value:function _getBezierParamKey(px0,py0,px1,py1){return(((px0*100+py0)*100+px1)*100+py1)*100;}},{key:"_getBezierPoints",value:function _getBezierPoints(px0,py0,px1,py1,key){if(BezierLerp._bezierPointsCache[key])return BezierLerp._bezierPointsCache[key];var controlPoints;controlPoints=[0,0,px0,py0,px1,py1,1,1];var bz;bz=new Laya.Bezier();var points;points=bz.getBezierPoints(controlPoints,100,3);BezierLerp._bezierPointsCache[key]=points;return points;}}]);return BezierLerp;}();BezierLerp._bezierResultCache={};BezierLerp._bezierPointsCache={};var AnimationTemplet=function(_Laya$Resource){_inherits(AnimationTemplet,_Laya$Resource);function AnimationTemplet(){_classCallCheck(this,AnimationTemplet);var _this122=_possibleConstructorReturn(this,(AnimationTemplet.__proto__||Object.getPrototypeOf(AnimationTemplet)).call(this));_this122._anis=[];_this122._aniMap={};_this122.unfixedLastAniIndex=-1;_this122._fullFrames=null;_this122._boneCurKeyFrm=[];return _this122;}/** lc **/_createClass(AnimationTemplet,[{key:"parse",value:function parse(data){var reader=new Laya.Byte(data);this._aniVersion=reader.readUTFString();AnimationParser01.parse(this,reader);}/** lc **/},{key:"_calculateKeyFrame",value:function _calculateKeyFrame(node,keyframeCount,keyframeDataCount){var keyFrames=node.keyFrame;var len=keyframeCount-1;for(var i=0;i<len;i++){keyFrames[i].nextData=keyFrames[i+1].data;}keyFrames[len].nextData=keyFrames[0].data;}},{key:"_onAsynLoaded",value:function _onAsynLoaded(data){var propertyParams=arguments.length>1&&arguments[1]!==undefined?arguments[1]:null;var reader=new Laya.Byte(data);this._aniVersion=reader.readUTFString();switch(this._aniVersion){case"LAYAANIMATION:02":AnimationParser02.parse(this,reader);break;default:AnimationParser01.parse(this,reader);}}},{key:"getAnimationCount",value:function getAnimationCount(){return this._anis.length;}},{key:"getAnimation",value:function getAnimation(aniIndex){return this._anis[aniIndex];}},{key:"getAniDuration",value:function getAniDuration(aniIndex){return this._anis[aniIndex].playTime;}},{key:"getNodes",value:function getNodes(aniIndex){return this._anis[aniIndex].nodes;}},{key:"getNodeIndexWithName",value:function getNodeIndexWithName(aniIndex,name){return this._anis[aniIndex].bone3DMap[name];}},{key:"getNodeCount",value:function getNodeCount(aniIndex){return this._anis[aniIndex].nodes.length;}},{key:"getTotalkeyframesLength",value:function getTotalkeyframesLength(aniIndex){return this._anis[aniIndex].totalKeyframeDatasLength;}},{key:"getPublicExtData",value:function getPublicExtData(){return this._publicExtData;}},{key:"getAnimationDataWithCache",value:function getAnimationDataWithCache(key,cacheDatas,aniIndex,frameIndex){var aniDatas=cacheDatas[aniIndex];if(!aniDatas){return null;}else{var keyDatas=aniDatas[key];if(!keyDatas)return null;else{return keyDatas[frameIndex];}}}},{key:"setAnimationDataWithCache",value:function setAnimationDataWithCache(key,cacheDatas,aniIndex,frameIndex,data){var aniDatas=cacheDatas[aniIndex]||(cacheDatas[aniIndex]={});var aniDatasCache=aniDatas[key]||(aniDatas[key]=[]);aniDatasCache[frameIndex]=data;}},{key:"getNodeKeyFrame",value:function getNodeKeyFrame(nodeframes,nodeid,tm){var cid=this._boneCurKeyFrm[nodeid];var frmNum=nodeframes.length;if(cid==void 0||cid>=frmNum){cid=this._boneCurKeyFrm[nodeid]=0;}var kinfo=nodeframes[cid];var curFrmTm=kinfo.startTime;var dt=tm-curFrmTm;if(dt==0||dt>0&&kinfo.duration>dt){return cid;}var i=0;if(dt>0){tm=tm+0.01;for(i=cid+1;i<frmNum;i++){kinfo=nodeframes[i];if(kinfo.startTime<=tm&&kinfo.startTime+kinfo.duration>tm){this._boneCurKeyFrm[nodeid]=i;return i;}}return frmNum-1;}else{for(i=0;i<cid;i++){kinfo=nodeframes[i];if(kinfo.startTime<=tm&&kinfo.startTime+kinfo.duration>tm){this._boneCurKeyFrm[nodeid]=i;return i;}}return cid;}return 0;}},{key:"getOriginalData",value:function getOriginalData(aniIndex,originalData,nodesFrameIndices,frameIndex,playCurTime){var oneAni=this._anis[aniIndex];var nodes=oneAni.nodes;var curKFrm=this._boneCurKeyFrm;if(curKFrm.length<nodes.length){curKFrm.length=nodes.length;}var j=0;for(var i=0,n=nodes.length,outOfs=0;i<n;i++){var node=nodes[i];var key;var kfrm=node.keyFrame;key=kfrm[this.getNodeKeyFrame(kfrm,i,playCurTime)];node.dataOffset=outOfs;var dt=playCurTime-key.startTime;var lerpType=node.lerpType;if(lerpType){/** lc **/switch(lerpType){case 0:case 1:for(j=0;j<node.keyframeWidth;){j+=node.interpolationMethod[j](node,j,originalData,outOfs+j,key.data,dt,key.duration,key.nextData);}break;case 2:var interpolationData=key.interpolationData;var interDataLen=interpolationData.length;var dataIndex=0;for(j=0;j<interDataLen;){var type=interpolationData[j];switch(type){case 6:j+=AnimationTemplet.interpolation[type](node,dataIndex,originalData,outOfs+dataIndex,key.data,dt,key.duration,key.nextData,interpolationData,j+1);break;case 7:j+=AnimationTemplet.interpolation[type](node,dataIndex,originalData,outOfs+dataIndex,key.data,dt,key.duration,key.nextData,interpolationData,j+1);break;default:j+=AnimationTemplet.interpolation[type](node,dataIndex,originalData,outOfs+dataIndex,key.data,dt,key.duration,key.nextData);}dataIndex++;}break;}}else{for(j=0;j<node.keyframeWidth;){j+=node.interpolationMethod[j](node,j,originalData,outOfs+j,key.data,dt,key.duration,key.nextData);}}outOfs+=node.keyframeWidth;}}},{key:"getNodesCurrentFrameIndex",value:function getNodesCurrentFrameIndex(aniIndex,playCurTime){var ani=this._anis[aniIndex];var nodes=ani.nodes;if(aniIndex!==this.unfixedLastAniIndex){this.unfixedCurrentFrameIndexes=new Uint32Array(nodes.length);this.unfixedCurrentTimes=new Float32Array(nodes.length);this.unfixedLastAniIndex=aniIndex;}for(var i=0,n=nodes.length;i<n;i++){var node=nodes[i];if(playCurTime<this.unfixedCurrentTimes[i])this.unfixedCurrentFrameIndexes[i]=0;this.unfixedCurrentTimes[i]=playCurTime;while(this.unfixedCurrentFrameIndexes[i]<node.keyFrame.length){if(node.keyFrame[this.unfixedCurrentFrameIndexes[i]].startTime>this.unfixedCurrentTimes[i])break;this.unfixedCurrentFrameIndexes[i]++;}this.unfixedCurrentFrameIndexes[i]--;}return this.unfixedCurrentFrameIndexes;}},{key:"getOriginalDataUnfixedRate",value:function getOriginalDataUnfixedRate(aniIndex,originalData,playCurTime){var oneAni=this._anis[aniIndex];var nodes=oneAni.nodes;if(aniIndex!==this.unfixedLastAniIndex){this.unfixedCurrentFrameIndexes=new Uint32Array(nodes.length);this.unfixedCurrentTimes=new Float32Array(nodes.length);this.unfixedKeyframes=[];this.unfixedLastAniIndex=aniIndex;}var j=0;for(var i=0,n=nodes.length,outOfs=0;i<n;i++){var node=nodes[i];if(playCurTime<this.unfixedCurrentTimes[i])this.unfixedCurrentFrameIndexes[i]=0;this.unfixedCurrentTimes[i]=playCurTime;while(this.unfixedCurrentFrameIndexes[i]<node.keyFrame.length){if(node.keyFrame[this.unfixedCurrentFrameIndexes[i]].startTime>this.unfixedCurrentTimes[i])break;this.unfixedKeyframes[i]=node.keyFrame[this.unfixedCurrentFrameIndexes[i]];this.unfixedCurrentFrameIndexes[i]++;}var key=this.unfixedKeyframes[i];node.dataOffset=outOfs;var dt=playCurTime-key.startTime;var lerpType=node.lerpType;if(lerpType){/** lc **/switch(node.lerpType){case 0:case 1:for(j=0;j<node.keyframeWidth;){j+=node.interpolationMethod[j](node,j,originalData,outOfs+j,key.data,dt,key.duration,key.nextData);}break;case 2:var interpolationData=key.interpolationData;var interDataLen=interpolationData.length;var dataIndex=0;for(j=0;j<interDataLen;){var type=interpolationData[j];switch(type){case 6:j+=AnimationTemplet.interpolation[type](node,dataIndex,originalData,outOfs+dataIndex,key.data,dt,key.duration,key.nextData,interpolationData,j+1);break;case 7:j+=AnimationTemplet.interpolation[type](node,dataIndex,originalData,outOfs+dataIndex,key.data,dt,key.duration,key.nextData,interpolationData,j+1);break;default:j+=AnimationTemplet.interpolation[type](node,dataIndex,originalData,outOfs+dataIndex,key.data,dt,key.duration,key.nextData);}dataIndex++;}break;}}else{for(j=0;j<node.keyframeWidth;){j+=node.interpolationMethod[j](node,j,originalData,outOfs+j,key.data,dt,key.duration,key.nextData);}}outOfs+=node.keyframeWidth;}}}],[{key:"_LinearInterpolation_0",value:function _LinearInterpolation_0(bone,index,out,outOfs,data,dt,duration,nextData){var interData=arguments.length>8&&arguments[8]!==undefined?arguments[8]:null;var rate=duration===0?0:dt/duration;out[outOfs]=data[index]*(1-rate)+nextData[index]*rate;return 1;}},{key:"_QuaternionInterpolation_1",value:function _QuaternionInterpolation_1(bone,index,out,outOfs,data,dt,duration,nextData){var interData=arguments.length>8&&arguments[8]!==undefined?arguments[8]:null;var amount=duration===0?0:dt/duration;Laya.MathUtil.slerpQuaternionArray(data,index,nextData,index,amount,out,outOfs);return 4;}},{key:"_AngleInterpolation_2",value:function _AngleInterpolation_2(bone,index,out,outOfs,data,dt,duration,nextData){var interData=arguments.length>8&&arguments[8]!==undefined?arguments[8]:null;return 0;}},{key:"_RadiansInterpolation_3",value:function _RadiansInterpolation_3(bone,index,out,outOfs,data,dt,duration,nextData){var interData=arguments.length>8&&arguments[8]!==undefined?arguments[8]:null;return 0;}},{key:"_Matrix4x4Interpolation_4",value:function _Matrix4x4Interpolation_4(bone,index,out,outOfs,data,dt,duration,nextData){var interData=arguments.length>8&&arguments[8]!==undefined?arguments[8]:null;var r=duration===0?0:dt/duration;var f=1-r;for(var i=0;i<16;i++,index++){out[outOfs+i]=data[index]*f+nextData[index]*r;}return 16;}},{key:"_NoInterpolation_5",value:function _NoInterpolation_5(bone,index,out,outOfs,data,dt,duration,nextData){var interData=arguments.length>8&&arguments[8]!==undefined?arguments[8]:null;out[outOfs]=data[index];return 1;}},{key:"_BezierInterpolation_6",value:function _BezierInterpolation_6(bone,index,out,outOfs,data,dt,duration,nextData){var interData=arguments.length>8&&arguments[8]!==undefined?arguments[8]:null;var offset=arguments.length>9&&arguments[9]!==undefined?arguments[9]:0;out[outOfs]=data[index]+(nextData[index]-data[index])*BezierLerp.getBezierRate(dt/duration,interData[offset],interData[offset+1],interData[offset+2],interData[offset+3]);return 5;}},{key:"_BezierInterpolation_7",value:function _BezierInterpolation_7(bone,index,out,outOfs,data,dt,duration,nextData){var interData=arguments.length>8&&arguments[8]!==undefined?arguments[8]:null;var offset=arguments.length>9&&arguments[9]!==undefined?arguments[9]:0;out[outOfs]=interData[offset+4]+interData[offset+5]*BezierLerp.getBezierRate((dt*0.001+interData[offset+6])/interData[offset+7],interData[offset],interData[offset+1],interData[offset+2],interData[offset+3]);return 9;}}]);return AnimationTemplet;}(Laya.Resource);AnimationTemplet.interpolation=[AnimationTemplet._LinearInterpolation_0,AnimationTemplet._QuaternionInterpolation_1,AnimationTemplet._AngleInterpolation_2,AnimationTemplet._RadiansInterpolation_3,AnimationTemplet._Matrix4x4Interpolation_4,AnimationTemplet._NoInterpolation_5,AnimationTemplet._BezierInterpolation_6,AnimationTemplet._BezierInterpolation_7];IAniLib.AnimationTemplet=AnimationTemplet;var GraphicsAni=function(_Laya$Graphics2){_inherits(GraphicsAni,_Laya$Graphics2);function GraphicsAni(){_classCallCheck(this,GraphicsAni);return _possibleConstructorReturn(this,(GraphicsAni.__proto__||Object.getPrototypeOf(GraphicsAni)).apply(this,arguments));}_createClass(GraphicsAni,[{key:"drawSkin",//todo blendMode
value:function drawSkin(skinA,alpha,blendMode){this.drawTriangles(skinA.texture,0,0,skinA.vertices,skinA.uvs,skinA.indexes,skinA.transform||Laya.Matrix.EMPTY,alpha,null,blendMode);}}],[{key:"create",value:function create(){var rs=GraphicsAni._caches.pop();return rs||new GraphicsAni();}},{key:"recycle",value:function recycle(graphics){graphics.clear();GraphicsAni._caches.push(graphics);}}]);return GraphicsAni;}(Laya.Graphics);GraphicsAni._caches=[];var Transform=function(){function Transform(){_classCallCheck(this,Transform);this.skX=0;this.skY=0;this.scX=1;this.scY=1;this.x=0;this.y=0;this.skewX=0;this.skewY=0;}_createClass(Transform,[{key:"initData",value:function initData(data){if(data.x!=undefined){this.x=data.x;}if(data.y!=undefined){this.y=data.y;}if(data.skX!=undefined){this.skX=data.skX;}if(data.skY!=undefined){this.skY=data.skY;}if(data.scX!=undefined){this.scX=data.scX;}if(data.scY!=undefined){this.scY=data.scY;}}},{key:"getMatrix",value:function getMatrix(){var tMatrix;if(this.mMatrix){tMatrix=this.mMatrix;}else{tMatrix=this.mMatrix=new Laya.Matrix();}tMatrix.identity();tMatrix.scale(this.scX,this.scY);if(this.skewX||this.skewY){this.skew(tMatrix,this.skewX*Math.PI/180,this.skewY*Math.PI/180);}tMatrix.rotate(this.skX*Math.PI/180);tMatrix.translate(this.x,this.y);return tMatrix;}},{key:"skew",value:function skew(m,x,y){var sinX=Math.sin(y);var cosX=Math.cos(y);var sinY=Math.sin(x);var cosY=Math.cos(x);m.setTo(m.a*cosY-m.b*sinX,m.a*sinY+m.b*cosX,m.c*cosY-m.d*sinX,m.c*sinY+m.d*cosX,m.tx*cosY-m.ty*sinX,m.tx*sinY+m.ty*cosX);return m;}}]);return Transform;}();var Bone=function(){function Bone(){_classCallCheck(this,Bone);this.length=10;this.resultTransform=new Transform();this.resultMatrix=new Laya.Matrix();this.inheritScale=true;this.inheritRotation=true;this.d=-1;this._children=[];}_createClass(Bone,[{key:"setTempMatrix",value:function setTempMatrix(matrix){this._tempMatrix=matrix;var i=0,n=0;var tBone;for(i=0,n=this._children.length;i<n;i++){tBone=this._children[i];tBone.setTempMatrix(this._tempMatrix);}}},{key:"update",value:function update(){var pMatrix=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;this.rotation=this.transform.skX;var tResultMatrix;if(pMatrix){tResultMatrix=this.resultTransform.getMatrix();Laya.Matrix.mul(tResultMatrix,pMatrix,this.resultMatrix);this.resultRotation=this.rotation;}else{this.resultRotation=this.rotation+this.parentBone.resultRotation;if(this.parentBone){if(this.inheritRotation&&this.inheritScale){tResultMatrix=this.resultTransform.getMatrix();Laya.Matrix.mul(tResultMatrix,this.parentBone.resultMatrix,this.resultMatrix);}else{var parent=this.parentBone;var tAngle;var cos;var sin;var tParentMatrix=this.parentBone.resultMatrix;tResultMatrix=this.resultTransform.getMatrix();var worldX=tParentMatrix.a*tResultMatrix.tx+tParentMatrix.c*tResultMatrix.ty+tParentMatrix.tx;var worldY=tParentMatrix.b*tResultMatrix.tx+tParentMatrix.d*tResultMatrix.ty+tParentMatrix.ty;var tTestMatrix=new Laya.Matrix();if(this.inheritRotation){tAngle=Math.atan2(parent.resultMatrix.b,parent.resultMatrix.a);cos=Math.cos(tAngle),sin=Math.sin(tAngle);tTestMatrix.setTo(cos,sin,-sin,cos,0,0);Laya.Matrix.mul(this._tempMatrix,tTestMatrix,Laya.Matrix.TEMP);Laya.Matrix.TEMP.copyTo(tTestMatrix);tResultMatrix=this.resultTransform.getMatrix();Laya.Matrix.mul(tResultMatrix,tTestMatrix,this.resultMatrix);if(this.resultTransform.scX*this.resultTransform.scY<0){this.resultMatrix.rotate(Math.PI*0.5);}this.resultMatrix.tx=worldX;this.resultMatrix.ty=worldY;}else if(this.inheritScale){tResultMatrix=this.resultTransform.getMatrix();Laya.Matrix.TEMP.identity();Laya.Matrix.TEMP.d=this.d;Laya.Matrix.mul(tResultMatrix,Laya.Matrix.TEMP,this.resultMatrix);this.resultMatrix.tx=worldX;this.resultMatrix.ty=worldY;}else{tResultMatrix=this.resultTransform.getMatrix();Laya.Matrix.TEMP.identity();Laya.Matrix.TEMP.d=this.d;Laya.Matrix.mul(tResultMatrix,Laya.Matrix.TEMP,this.resultMatrix);this.resultMatrix.tx=worldX;this.resultMatrix.ty=worldY;}}}else{tResultMatrix=this.resultTransform.getMatrix();tResultMatrix.copyTo(this.resultMatrix);}}var i=0,n=0;var tBone;for(i=0,n=this._children.length;i<n;i++){tBone=this._children[i];tBone.update();}}},{key:"updateChild",value:function updateChild(){var i=0,n=0;var tBone;for(i=0,n=this._children.length;i<n;i++){tBone=this._children[i];tBone.update();}}},{key:"setRotation",value:function setRotation(rd){if(this._sprite){this._sprite.rotation=rd*180/Math.PI;}}},{key:"updateDraw",value:function updateDraw(x,y){if(!Bone.ShowBones||Bone.ShowBones[this.name]){if(this._sprite){this._sprite.x=x+this.resultMatrix.tx;this._sprite.y=y+this.resultMatrix.ty;}else{this._sprite=new Laya.Sprite();this._sprite.graphics.drawCircle(0,0,5,"#ff0000");this._sprite.graphics.drawLine(0,0,this.length,0,"#00ff00");this._sprite.graphics.fillText(this.name,0,0,"20px Arial","#00ff00","center");Laya.ILaya.stage.addChild(this._sprite);this._sprite.x=x+this.resultMatrix.tx;this._sprite.y=y+this.resultMatrix.ty;}}var i=0,n=0;var tBone;for(i=0,n=this._children.length;i<n;i++){tBone=this._children[i];tBone.updateDraw(x,y);}}},{key:"addChild",value:function addChild(bone){this._children.push(bone);bone.parentBone=this;}},{key:"findBone",value:function findBone(boneName){if(this.name==boneName){return this;}else{var i,n;var tBone;var tResult;for(i=0,n=this._children.length;i<n;i++){tBone=this._children[i];tResult=tBone.findBone(boneName);if(tResult){return tResult;}}}return null;}},{key:"localToWorld",value:function localToWorld(local){var localX=local[0];var localY=local[1];local[0]=localX*this.resultMatrix.a+localY*this.resultMatrix.c+this.resultMatrix.tx;local[1]=localX*this.resultMatrix.b+localY*this.resultMatrix.d+this.resultMatrix.ty;}}]);return Bone;}();Bone.ShowBones={};var UVTools=function(){function UVTools(){_classCallCheck(this,UVTools);}_createClass(UVTools,null,[{key:"getRelativeUV",value:function getRelativeUV(bigUV,smallUV){var rst=arguments.length>2&&arguments[2]!==undefined?arguments[2]:null;var startX=bigUV[0];var width=bigUV[2]-bigUV[0];var startY=bigUV[1];var height=bigUV[5]-bigUV[1];if(!rst)rst=[];rst.length=smallUV.length;var i,len;len=rst.length;var dWidth=1/width;var dHeight=1/height;for(i=0;i<len;i+=2){rst[i]=(smallUV[i]-startX)*dWidth;rst[i+1]=(smallUV[i+1]-startY)*dHeight;}return rst;}},{key:"getAbsoluteUV",value:function getAbsoluteUV(bigUV,smallUV){var rst=arguments.length>2&&arguments[2]!==undefined?arguments[2]:null;if(bigUV[0]==0&&bigUV[1]==0&&bigUV[4]==1&&bigUV[5]==1){if(rst){Laya.Utils.copyArray(rst,smallUV);return rst;}else{return smallUV;}}var startX=bigUV[0];var width=bigUV[2]-bigUV[0];var startY=bigUV[1];var height=bigUV[5]-bigUV[1];if(!rst)rst=[];rst.length=smallUV.length;var i,len;len=rst.length;for(i=0;i<len;i+=2){rst[i]=smallUV[i]*width+startX;rst[i+1]=smallUV[i+1]*height+startY;}return rst;}}]);return UVTools;}();var MeshData=function(){function MeshData(){_classCallCheck(this,MeshData);this.uvs=new Float32Array([0,0,1,0,1,1,0,1]);this.vertices=new Float32Array([0,0,100,0,100,100,0,100]);this.indexes=new Uint16Array([0,1,3,3,1,2]);this.useUvTransform=false;this.canvasPadding=1;}_createClass(MeshData,[{key:"getBounds",value:function getBounds(){return Laya.Rectangle._getWrapRec(this.vertices);}}]);return MeshData;}();var SkinMeshForGraphic=function(_MeshData){_inherits(SkinMeshForGraphic,_MeshData);function SkinMeshForGraphic(){_classCallCheck(this,SkinMeshForGraphic);return _possibleConstructorReturn(this,(SkinMeshForGraphic.__proto__||Object.getPrototypeOf(SkinMeshForGraphic)).call(this));}_createClass(SkinMeshForGraphic,[{key:"init2",value:function init2(texture,ps,verticles,uvs){if(this.transform){this.transform=null;}var _ps=ps||[0,1,3,3,1,2];this.texture=texture;this.indexes=new Uint16Array(_ps);this.vertices=new Float32Array(verticles);this.uvs=new Float32Array(uvs);}}]);return SkinMeshForGraphic;}(MeshData);var BoneSlot=function(){function BoneSlot(){_classCallCheck(this,BoneSlot);this.srcDisplayIndex=-1;this.type="src";this.displayIndex=-1;this.originalIndex=-1;this._replaceDic={};//todo blendMode
this.blendMode='normal';}_createClass(BoneSlot,[{key:"showSlotData",value:function showSlotData(slotData){var freshIndex=arguments.length>1&&arguments[1]!==undefined?arguments[1]:true;this.currSlotData=slotData;if(freshIndex)this.displayIndex=this.srcDisplayIndex;this.currDisplayData=null;this.currTexture=null;}},{key:"showDisplayByName",value:function showDisplayByName(name){if(this.currSlotData){this.showDisplayByIndex(this.currSlotData.getDisplayByName(name));}}},{key:"replaceDisplayByName",value:function replaceDisplayByName(tarName,newName){if(!this.currSlotData)return;var preIndex;preIndex=this.currSlotData.getDisplayByName(tarName);var newIndex;newIndex=this.currSlotData.getDisplayByName(newName);this.replaceDisplayByIndex(preIndex,newIndex);}},{key:"replaceDisplayByIndex",value:function replaceDisplayByIndex(tarIndex,newIndex){if(!this.currSlotData)return;this._replaceDic[tarIndex]=newIndex;if(this.originalIndex==tarIndex){this.showDisplayByIndex(tarIndex);}}},{key:"showDisplayByIndex",value:function showDisplayByIndex(index){this.originalIndex=index;if(this._replaceDic[index]!=null)index=this._replaceDic[index];if(this.currSlotData&&index>-1&&index<this.currSlotData.displayArr.length){this.displayIndex=index;this.currDisplayData=this.currSlotData.displayArr[index];if(this.currDisplayData){var tName=this.currDisplayData.name;this.currTexture=this.templet.getTexture(tName);if(this.currTexture&&this.currDisplayData.type==0&&this.currDisplayData.uvs){this.currTexture=this.currDisplayData.createTexture(this.currTexture);}}}else{this.displayIndex=-1;this.currDisplayData=null;this.currTexture=null;}}},{key:"replaceSkin",value:function replaceSkin(_texture){this._diyTexture=_texture;if(this._curDiyUV)this._curDiyUV.length=0;if(this.currDisplayData&&this._diyTexture==this.currDisplayData.texture){this._diyTexture=null;}}},{key:"setParentMatrix",value:function setParentMatrix(parentMatrix){this._parentMatrix=parentMatrix;}},{key:"getSaveVerticle",value:function getSaveVerticle(tArr){if(BoneSlot.useSameMatrixAndVerticle&&this._preGraphicVerticle&&BoneSlot.isSameArr(tArr,this._preGraphicVerticle)){tArr=this._preGraphicVerticle;}else{tArr=Laya.ILaya.Utils.copyArray([],tArr);this._preGraphicVerticle=tArr;}return tArr;}},{key:"getSaveMatrix",value:function getSaveMatrix(tResultMatrix){if(BoneSlot.useSameMatrixAndVerticle&&this._preGraphicMatrix&&BoneSlot.isSameMatrix(tResultMatrix,this._preGraphicMatrix)){tResultMatrix=this._preGraphicMatrix;}else{var newMatrix=tResultMatrix.clone();tResultMatrix=newMatrix;this._preGraphicMatrix=tResultMatrix;}return tResultMatrix;}},{key:"draw",value:function draw(graphics,boneMatrixArray){var noUseSave=arguments.length>2&&arguments[2]!==undefined?arguments[2]:false;var alpha=arguments.length>3&&arguments[3]!==undefined?arguments[3]:1;if(this._diyTexture==null&&this.currTexture==null||this.currDisplayData==null){if(!(this.currDisplayData&&this.currDisplayData.type==3)){return;}}var tTexture=this.currTexture;if(this._diyTexture)tTexture=this._diyTexture;var tSkinSprite;switch(this.currDisplayData.type){case 0:if(graphics){var tCurrentMatrix=this.getDisplayMatrix();if(this._parentMatrix){var tRotateKey=false;if(tCurrentMatrix){Laya.Matrix.mul(tCurrentMatrix,this._parentMatrix,Laya.Matrix.TEMP);var tResultMatrix;if(noUseSave){if(this._resultMatrix==null)this._resultMatrix=new Laya.Matrix();tResultMatrix=this._resultMatrix;}else{tResultMatrix=BoneSlot._tempResultMatrix;}if(this._diyTexture&&this.currDisplayData.uvs){var tTestMatrix=BoneSlot._tempMatrix;tTestMatrix.identity();if(this.currDisplayData.uvs[1]>this.currDisplayData.uvs[5]){tTestMatrix.d=-1;}if(this.currDisplayData.uvs[0]>this.currDisplayData.uvs[4]&&this.currDisplayData.uvs[1]>this.currDisplayData.uvs[5]){tRotateKey=true;tTestMatrix.rotate(-Math.PI/2);}Laya.Matrix.mul(tTestMatrix,Laya.Matrix.TEMP,tResultMatrix);}else{Laya.Matrix.TEMP.copyTo(tResultMatrix);}if(!noUseSave){tResultMatrix=this.getSaveMatrix(tResultMatrix);}tResultMatrix._checkTransform();if(tRotateKey){//todo blendMode
graphics.drawTexture(tTexture,-this.currDisplayData.height/2,-this.currDisplayData.width/2,this.currDisplayData.height,this.currDisplayData.width,tResultMatrix,alpha,null,this.blendMode);}else{graphics.drawTexture(tTexture,-this.currDisplayData.width/2,-this.currDisplayData.height/2,this.currDisplayData.width,this.currDisplayData.height,tResultMatrix,alpha,null,this.blendMode);}}}}break;case 1:if(noUseSave){if(this._skinSprite==null){this._skinSprite=BoneSlot.createSkinMesh();}tSkinSprite=this._skinSprite;}else{tSkinSprite=BoneSlot.createSkinMesh();}if(tSkinSprite==null){return;}var tIBArray;if(this.currDisplayData.bones==null){var tVertices=this.currDisplayData.weights;if(this.deformData){tVertices=this.deformData;}var tUVs;if(this._diyTexture){if(!this._curDiyUV){this._curDiyUV=[];}if(this._curDiyUV.length==0){this._curDiyUV=UVTools.getRelativeUV(this.currTexture.uv,this.currDisplayData.uvs,this._curDiyUV);this._curDiyUV=UVTools.getAbsoluteUV(this._diyTexture.uv,this._curDiyUV,this._curDiyUV);}tUVs=this._curDiyUV;}else{tUVs=this.currDisplayData.uvs;}this._mVerticleArr=tVertices;var tTriangleNum=this.currDisplayData.triangles.length/3;tIBArray=this.currDisplayData.triangles;if(this.deformData){if(!noUseSave){this._mVerticleArr=this.getSaveVerticle(this._mVerticleArr);}}tSkinSprite.init2(tTexture,tIBArray,this._mVerticleArr,tUVs);var tCurrentMatrix2=this.getDisplayMatrix();if(this._parentMatrix){if(tCurrentMatrix2){Laya.Matrix.mul(tCurrentMatrix2,this._parentMatrix,Laya.Matrix.TEMP);var tResultMatrix2;if(noUseSave){if(this._resultMatrix==null)this._resultMatrix=new Laya.Matrix();tResultMatrix2=this._resultMatrix;}else{tResultMatrix2=BoneSlot._tempResultMatrix;}Laya.Matrix.TEMP.copyTo(tResultMatrix2);if(!noUseSave){tResultMatrix2=this.getSaveMatrix(tResultMatrix2);}tSkinSprite.transform=tResultMatrix2;}}}else{this.skinMesh(boneMatrixArray,tSkinSprite);}//todo blendMode
graphics.drawSkin(tSkinSprite,alpha,this.blendMode);break;case 2:if(noUseSave){if(this._skinSprite==null){this._skinSprite=BoneSlot.createSkinMesh();}tSkinSprite=this._skinSprite;}else{tSkinSprite=BoneSlot.createSkinMesh();}if(tSkinSprite==null){return;}this.skinMesh(boneMatrixArray,tSkinSprite);//todo blendMode
graphics.drawSkin(tSkinSprite,alpha,this.blendMode);break;case 3:break;}}},{key:"skinMesh",value:function skinMesh(boneMatrixArray,skinSprite){var tTexture=this.currTexture;var tBones=this.currDisplayData.bones;var tUvs;if(this._diyTexture){tTexture=this._diyTexture;if(!this._curDiyUV){this._curDiyUV=[];}if(this._curDiyUV.length==0){this._curDiyUV=UVTools.getRelativeUV(this.currTexture.uv,this.currDisplayData.uvs,this._curDiyUV);this._curDiyUV=UVTools.getAbsoluteUV(this._diyTexture.uv,this._curDiyUV,this._curDiyUV);}tUvs=this._curDiyUV;}else{tUvs=this.currDisplayData.uvs;}var tWeights=this.currDisplayData.weights;var tTriangles=this.currDisplayData.triangles;var tIBArray;var tRx=0;var tRy=0;var nn=0;var tMatrix;var tX;var tY;var tB=0;var tWeight=0;var tVertices;var i=0,n=0;BoneSlot._tempVerticleArr.length=0;tVertices=BoneSlot._tempVerticleArr;if(this.deformData&&this.deformData.length>0){var f=0;for(i=0,n=tBones.length;i<n;){nn=tBones[i++]+i;tRx=0,tRy=0;for(;i<nn;i++){tMatrix=boneMatrixArray[tBones[i]];tX=tWeights[tB]+this.deformData[f++];tY=tWeights[tB+1]+this.deformData[f++];tWeight=tWeights[tB+2];tRx+=(tX*tMatrix.a+tY*tMatrix.c+tMatrix.tx)*tWeight;tRy+=(tX*tMatrix.b+tY*tMatrix.d+tMatrix.ty)*tWeight;tB+=3;}tVertices.push(tRx,tRy);}}else{for(i=0,n=tBones.length;i<n;){nn=tBones[i++]+i;tRx=0,tRy=0;for(;i<nn;i++){tMatrix=boneMatrixArray[tBones[i]];tX=tWeights[tB];tY=tWeights[tB+1];tWeight=tWeights[tB+2];tRx+=(tX*tMatrix.a+tY*tMatrix.c+tMatrix.tx)*tWeight;tRy+=(tX*tMatrix.b+tY*tMatrix.d+tMatrix.ty)*tWeight;tB+=3;}tVertices.push(tRx,tRy);}}this._mVerticleArr=tVertices;tIBArray=tTriangles;this._mVerticleArr=this.getSaveVerticle(this._mVerticleArr);skinSprite.init2(tTexture,tIBArray,this._mVerticleArr,tUvs);}},{key:"drawBonePoint",value:function drawBonePoint(graphics){if(graphics&&this._parentMatrix){graphics.drawCircle(this._parentMatrix.tx,this._parentMatrix.ty,5,"#ff0000");}}},{key:"getDisplayMatrix",value:function getDisplayMatrix(){if(this.currDisplayData){return this.currDisplayData.transform.getMatrix();}return null;}},{key:"getMatrix",value:function getMatrix(){return this._resultMatrix;}},{key:"copy",value:function copy(){var tBoneSlot=new BoneSlot();tBoneSlot.type="copy";tBoneSlot.name=this.name;tBoneSlot.attachmentName=this.attachmentName;tBoneSlot.srcDisplayIndex=this.srcDisplayIndex;tBoneSlot.parent=this.parent;tBoneSlot.displayIndex=this.displayIndex;tBoneSlot.templet=this.templet;tBoneSlot.currSlotData=this.currSlotData;tBoneSlot.currTexture=this.currTexture;tBoneSlot.currDisplayData=this.currDisplayData;return tBoneSlot;}}],[{key:"createSkinMesh",value:function createSkinMesh(){return new SkinMeshForGraphic();}},{key:"isSameArr",value:function isSameArr(arrA,arrB){if(arrA.length!=arrB.length)return false;var i,len;len=arrA.length;for(i=0;i<len;i++){if(arrA[i]!=arrB[i])return false;}return true;}},{key:"isSameMatrix",value:function isSameMatrix(mtA,mtB){return mtA.a==mtB.a&&mtA.b==mtB.b&&mtA.c==mtB.c&&mtA.d==mtB.d&&Math.abs(mtA.tx-mtB.tx)<0.00001&&Math.abs(mtA.ty-mtB.ty)<0.00001;}}]);return BoneSlot;}();BoneSlot._tempMatrix=new Laya.Matrix();BoneSlot._tempResultMatrix=new Laya.Matrix();BoneSlot.useSameMatrixAndVerticle=true;BoneSlot._tempVerticleArr=[];var DeformAniData=function DeformAniData(){_classCallCheck(this,DeformAniData);this.deformSlotDataList=[];};var DeformSlotData=function DeformSlotData(){_classCallCheck(this,DeformSlotData);this.deformSlotDisplayList=[];};var DeformSlotDisplayData=function(){function DeformSlotDisplayData(){_classCallCheck(this,DeformSlotDisplayData);this.slotIndex=-1;this.timeList=[];this.vectices=[];this.tweenKeyList=[];this.frameIndex=0;}_createClass(DeformSlotDisplayData,[{key:"binarySearch1",value:function binarySearch1(values,target){var low=0;var high=values.length-2;if(high==0)return 1;var current=high>>>1;while(true){if(values[Math.floor(current+1)]<=target)low=current+1;else high=current;if(low==high)return low+1;current=low+high>>>1;}return 0;}},{key:"apply",value:function apply(time,boneSlot){var alpha=arguments.length>2&&arguments[2]!==undefined?arguments[2]:1;time+=0.05;if(this.timeList.length<=0){return;}var i=0;var tTime=this.timeList[0];if(time<tTime){return;}var tVertexCount=this.vectices[0].length;var tVertices=[];var tFrameIndex=this.binarySearch1(this.timeList,time);this.frameIndex=tFrameIndex;if(time>=this.timeList[this.timeList.length-1]){var lastVertices=this.vectices[this.vectices.length-1];if(alpha<1){for(i=0;i<tVertexCount;i++){tVertices[i]+=(lastVertices[i]-tVertices[i])*alpha;}}else{for(i=0;i<tVertexCount;i++){tVertices[i]=lastVertices[i];}}this.deformData=tVertices;return;}var tPrevVertices=this.vectices[this.frameIndex-1];var tNextVertices=this.vectices[this.frameIndex];var tPreFrameTime=this.timeList[this.frameIndex-1];var tFrameTime=this.timeList[this.frameIndex];if(this.tweenKeyList[tFrameIndex-1]){alpha=(time-tPreFrameTime)/(tFrameTime-tPreFrameTime);}else{alpha=0;}var tPrev;for(i=0;i<tVertexCount;i++){tPrev=tPrevVertices[i];tVertices[i]=tPrev+(tNextVertices[i]-tPrev)*alpha;}this.deformData=tVertices;}}]);return DeformSlotDisplayData;}();var DrawOrderData=function DrawOrderData(){_classCallCheck(this,DrawOrderData);this.drawOrder=[];};var EventData=function EventData(){_classCallCheck(this,EventData);};var IkConstraint=function(){function IkConstraint(data,bones){_classCallCheck(this,IkConstraint);this.isSpine=true;this.isDebug=false;this._targetBone=bones[data.targetBoneIndex];this.isSpine=data.isSpine;if(this._bones==null)this._bones=[];this._bones.length=0;for(var i=0,n=data.boneIndexs.length;i<n;i++){this._bones.push(bones[data.boneIndexs[i]]);}this.name=data.name;this.mix=data.mix;this.bendDirection=data.bendDirection;}_createClass(IkConstraint,[{key:"apply",value:function apply(){switch(this._bones.length){case 1:this._applyIk1(this._bones[0],this._targetBone.resultMatrix.tx,this._targetBone.resultMatrix.ty,this.mix);break;case 2:if(this.isSpine){this._applyIk2(this._bones[0],this._bones[1],this._targetBone.resultMatrix.tx,this._targetBone.resultMatrix.ty,this.bendDirection,this.mix);}else{this._applyIk3(this._bones[0],this._bones[1],this._targetBone.resultMatrix.tx,this._targetBone.resultMatrix.ty,this.bendDirection,this.mix);}break;}}},{key:"_applyIk1",value:function _applyIk1(bone,targetX,targetY,alpha){var pp=bone.parentBone;var id=1/(pp.resultMatrix.a*pp.resultMatrix.d-pp.resultMatrix.b*pp.resultMatrix.c);var x=targetX-pp.resultMatrix.tx;var y=targetY-pp.resultMatrix.ty;var tx=(x*pp.resultMatrix.d-y*pp.resultMatrix.c)*id-bone.transform.x;var ty=(y*pp.resultMatrix.a-x*pp.resultMatrix.b)*id-bone.transform.y;var rotationIK=Math.atan2(ty,tx)*IkConstraint.radDeg-0-bone.transform.skX;if(bone.transform.scX<0)rotationIK+=180;if(rotationIK>180)rotationIK-=360;else if(rotationIK<-180)rotationIK+=360;bone.transform.skX=bone.transform.skY=bone.transform.skX+rotationIK*alpha;bone.update();}},{key:"updatePos",value:function updatePos(x,y){if(this._sp){this._sp.pos(x,y);}}},{key:"_applyIk2",value:function _applyIk2(parent,child,targetX,targetY,bendDir,alpha){if(alpha==0){return;}var px=parent.resultTransform.x,py=parent.resultTransform.y;var psx=parent.transform.scX,psy=parent.transform.scY;var csx=child.transform.scX;var os1,os2,s2;if(psx<0){psx=-psx;os1=180;s2=-1;}else{os1=0;s2=1;}if(psy<0){psy=-psy;s2=-s2;}if(csx<0){csx=-csx;os2=180;}else{os2=0;}var cx=child.resultTransform.x,cy,cwx,cwy;var a=parent.resultMatrix.a,b=parent.resultMatrix.c;var c=parent.resultMatrix.b,d=parent.resultMatrix.d;var u=Math.abs(psx-psy)<=0.0001;if(!u){cy=0;cwx=a*cx+parent.resultMatrix.tx;cwy=c*cx+parent.resultMatrix.ty;}else{cy=child.resultTransform.y;cwx=a*cx+b*cy+parent.resultMatrix.tx;cwy=c*cx+d*cy+parent.resultMatrix.ty;}if(this.isDebug){if(!this._sp){this._sp=new Laya.Sprite();Laya.ILaya.stage.addChild(this._sp);}this._sp.graphics.clear();this._sp.graphics.drawCircle(targetX,targetY,15,"#ffff00");this._sp.graphics.drawCircle(cwx,cwy,15,"#ff00ff");}parent.setRotation(Math.atan2(cwy-parent.resultMatrix.ty,cwx-parent.resultMatrix.tx));var pp=parent.parentBone;a=pp.resultMatrix.a;b=pp.resultMatrix.c;c=pp.resultMatrix.b;d=pp.resultMatrix.d;var id=1/(a*d-b*c);var x=targetX-pp.resultMatrix.tx,y=targetY-pp.resultMatrix.ty;var tx=(x*d-y*b)*id-px;var ty=(y*a-x*c)*id-py;x=cwx-pp.resultMatrix.tx;y=cwy-pp.resultMatrix.ty;var dx=(x*d-y*b)*id-px;var dy=(y*a-x*c)*id-py;var l1=Math.sqrt(dx*dx+dy*dy);var l2=child.length*csx;var a1,a2;if(u){l2*=psx;var cos=(tx*tx+ty*ty-l1*l1-l2*l2)/(2*l1*l2);if(cos<-1)cos=-1;else if(cos>1)cos=1;a2=Math.acos(cos)*bendDir;a=l1+l2*cos;b=l2*Math.sin(a2);a1=Math.atan2(ty*a-tx*b,tx*a+ty*b);}else{a=psx*l2;b=psy*l2;var aa=a*a,bb=b*b,dd=tx*tx+ty*ty,ta=Math.atan2(ty,tx);c=bb*l1*l1+aa*dd-aa*bb;var c1=-2*bb*l1,c2=bb-aa;d=c1*c1-4*c2*c;if(d>0){var q=Math.sqrt(d);if(c1<0)q=-q;q=-(c1+q)/2;var r0=q/c2,r1=c/q;var r=Math.abs(r0)<Math.abs(r1)?r0:r1;if(r*r<=dd){y=Math.sqrt(dd-r*r)*bendDir;a1=ta-Math.atan2(y,r);a2=Math.atan2(y/psy,(r-l1)/psx);}}var minAngle=0,minDist=Number.MAX_VALUE,minX=0,minY=0;var maxAngle=0,maxDist=0,maxX=0,maxY=0;x=l1+a;d=x*x;if(d>maxDist){maxAngle=0;maxDist=d;maxX=x;}x=l1-a;d=x*x;if(d<minDist){minAngle=Math.PI;minDist=d;minX=x;}var angle=Math.acos(-a*l1/(aa-bb));x=a*Math.cos(angle)+l1;y=b*Math.sin(angle);d=x*x+y*y;if(d<minDist){minAngle=angle;minDist=d;minX=x;minY=y;}if(d>maxDist){maxAngle=angle;maxDist=d;maxX=x;maxY=y;}if(dd<=(minDist+maxDist)/2){a1=ta-Math.atan2(minY*bendDir,minX);a2=minAngle*bendDir;}else{a1=ta-Math.atan2(maxY*bendDir,maxX);a2=maxAngle*bendDir;}}var os=Math.atan2(cy,cx)*s2;var rotation=parent.resultTransform.skX;a1=(a1-os)*IkConstraint.radDeg+os1-rotation;if(a1>180)a1-=360;else if(a1<-180)a1+=360;parent.resultTransform.x=px;parent.resultTransform.y=py;parent.resultTransform.skX=parent.resultTransform.skY=rotation+a1*alpha;rotation=child.resultTransform.skX;rotation=rotation%360;a2=((a2+os)*IkConstraint.radDeg-0)*s2+os2-rotation;if(a2>180)a2-=360;else if(a2<-180)a2+=360;child.resultTransform.x=cx;child.resultTransform.y=cy;child.resultTransform.skX=child.resultTransform.skY=child.resultTransform.skY+a2*alpha;parent.update();}},{key:"_applyIk3",value:function _applyIk3(parent,child,targetX,targetY,bendDir,alpha){if(alpha==0){return;}var cwx,cwy;var x=child.resultMatrix.a*child.length;var y=child.resultMatrix.b*child.length;var lLL=x*x+y*y;var lL=Math.sqrt(lLL);var parentX=parent.resultMatrix.tx;var parentY=parent.resultMatrix.ty;var childX=child.resultMatrix.tx;var childY=child.resultMatrix.ty;var dX=childX-parentX;var dY=childY-parentY;var lPP=dX*dX+dY*dY;var lP=Math.sqrt(lPP);dX=targetX-parent.resultMatrix.tx;dY=targetY-parent.resultMatrix.ty;var lTT=dX*dX+dY*dY;var lT=Math.sqrt(lTT);if(lL+lP<=lT||lT+lL<=lP||lT+lP<=lL){var rate;if(lL+lP<=lT){rate=1;}else{rate=-1;}childX=parentX+rate*(targetX-parentX)*lP/lT;childY=parentY+rate*(targetY-parentY)*lP/lT;}else{var h=(lPP-lLL+lTT)/(2*lTT);var r=Math.sqrt(lPP-h*h*lTT)/lT;var hX=parentX+dX*h;var hY=parentY+dY*h;var rX=-dY*r;var rY=dX*r;if(bendDir>0){childX=hX-rX;childY=hY-rY;}else{childX=hX+rX;childY=hY+rY;}}cwx=childX;cwy=childY;if(this.isDebug){if(!this._sp){this._sp=new Laya.Sprite();Laya.ILaya.stage.addChild(this._sp);}this._sp.graphics.clear();this._sp.graphics.drawCircle(parentX,parentY,15,"#ff00ff");this._sp.graphics.drawCircle(targetX,targetY,15,"#ffff00");this._sp.graphics.drawCircle(cwx,cwy,15,"#ff00ff");}var pRotation;pRotation=Math.atan2(cwy-parent.resultMatrix.ty,cwx-parent.resultMatrix.tx);parent.setRotation(pRotation);var pTarMatrix;pTarMatrix=IkConstraint._tempMatrix;pTarMatrix.identity();pTarMatrix.rotate(pRotation);pTarMatrix.scale(parent.resultMatrix.getScaleX(),parent.resultMatrix.getScaleY());pTarMatrix.translate(parent.resultMatrix.tx,parent.resultMatrix.ty);pTarMatrix.copyTo(parent.resultMatrix);parent.updateChild();var childRotation;childRotation=Math.atan2(targetY-cwy,targetX-cwx);child.setRotation(childRotation);var childTarMatrix;childTarMatrix=IkConstraint._tempMatrix;childTarMatrix.identity();childTarMatrix.rotate(childRotation);childTarMatrix.scale(child.resultMatrix.getScaleX(),child.resultMatrix.getScaleY());childTarMatrix.translate(cwx,cwy);pTarMatrix.copyTo(child.resultMatrix);child.updateChild();}}]);return IkConstraint;}();IkConstraint.radDeg=180/Math.PI;IkConstraint.degRad=Math.PI/180;IkConstraint._tempMatrix=new Laya.Matrix();var IkConstraintData=function IkConstraintData(){_classCallCheck(this,IkConstraintData);this.boneNames=[];this.bendDirection=1;this.mix=1;this.isSpine=true;this.targetBoneIndex=-1;this.boneIndexs=[];};var PathConstraint=function(){function PathConstraint(data,bones){_classCallCheck(this,PathConstraint);this._debugKey=false;this._segments=[];this._curves=[];this.data=data;this.position=data.position;this.spacing=data.spacing;this.rotateMix=data.rotateMix;this.translateMix=data.translateMix;this.bones=[];var tBoneIds=this.data.bones;for(var i=0,n=tBoneIds.length;i<n;i++){this.bones.push(bones[tBoneIds[i]]);}}_createClass(PathConstraint,[{key:"apply",value:function apply(boneList,graphics){if(!this.target)return;var tTranslateMix=this.translateMix;var tRotateMix=this.translateMix;var tRotate=tRotateMix>0;var tSpacingMode=this.data.spacingMode;var tLengthSpacing=tSpacingMode=="length";var tRotateMode=this.data.rotateMode;var tTangents=tRotateMode=="tangent";var tScale=tRotateMode=="chainScale";var lengths=[];var boneCount=this.bones.length;var spacesCount=tTangents?boneCount:boneCount+1;var spaces=[];this._spaces=spaces;spaces[0]=this.position;var spacing=this.spacing;if(tScale||tLengthSpacing){for(var i=0,n=spacesCount-1;i<n;){var bone=this.bones[i];var length=bone.length;var x=length*bone.resultMatrix.a;var y=length*bone.resultMatrix.b;length=Math.sqrt(x*x+y*y);if(tScale)lengths[i]=length;spaces[++i]=tLengthSpacing?Math.max(0,length+spacing):spacing;}}else{for(i=1;i<spacesCount;i++){spaces[i]=spacing;}}var positions=this.computeWorldPositions(this.target,boneList,graphics,spacesCount,tTangents,this.data.positionMode=="percent",tSpacingMode=="percent");if(this._debugKey){for(i=0;i<positions.length;i++){graphics.drawCircle(positions[i++],positions[i++],5,"#00ff00");}var tLinePos=[];for(i=0;i<positions.length;i++){tLinePos.push(positions[i++],positions[i++]);}graphics.drawLines(0,0,tLinePos,"#ff0000");}var boneX=positions[0];var boneY=positions[1];var offsetRotation=this.data.offsetRotation;var tip=tRotateMode=="chain"&&offsetRotation==0;var p;for(i=0,p=3;i<boneCount;i++,p+=3){bone=this.bones[i];bone.resultMatrix.tx+=(boneX-bone.resultMatrix.tx)*tTranslateMix;bone.resultMatrix.ty+=(boneY-bone.resultMatrix.ty)*tTranslateMix;x=positions[p];y=positions[p+1];var dx=x-boneX,dy=y-boneY;if(tScale){length=lengths[i];if(length!=0){var s=(Math.sqrt(dx*dx+dy*dy)/length-1)*tRotateMix+1;bone.resultMatrix.a*=s;bone.resultMatrix.c*=s;}}boneX=x;boneY=y;if(tRotate){var a=bone.resultMatrix.a;var b=bone.resultMatrix.c;var c=bone.resultMatrix.b;var d=bone.resultMatrix.d;var r;var cos;var sin;if(tTangents){r=positions[p-1];}else if(spaces[i+1]==0){r=positions[p+2];}else{r=Math.atan2(dy,dx);}r-=Math.atan2(c,a)-offsetRotation/180*Math.PI;if(tip){cos=Math.cos(r);sin=Math.sin(r);length=bone.length;boneX+=(length*(cos*a-sin*c)-dx)*tRotateMix;boneY+=(length*(sin*a+cos*c)-dy)*tRotateMix;}if(r>Math.PI){r-=Math.PI*2;}else if(r<-Math.PI){r+=Math.PI*2;}r*=tRotateMix;cos=Math.cos(r);sin=Math.sin(r);bone.resultMatrix.a=cos*a-sin*c;bone.resultMatrix.c=cos*b-sin*d;bone.resultMatrix.b=sin*a+cos*c;bone.resultMatrix.d=sin*b+cos*d;}}}},{key:"computeWorldVertices2",value:function computeWorldVertices2(boneSlot,boneList,start,count,worldVertices,offset){var tBones=boneSlot.currDisplayData.bones;var tWeights=boneSlot.currDisplayData.weights;var tTriangles=boneSlot.currDisplayData.triangles;var tMatrix;var i=0;var v=0;var skip=0;var n=0;var w=0;var b=0;var wx=0;var wy=0;var vx=0;var vy=0;var bone;var len;if(tBones==null){if(!tTriangles)tTriangles=tWeights;if(boneSlot.deformData)tTriangles=boneSlot.deformData;var parentName;parentName=boneSlot.parent;if(boneList){len=boneList.length;for(i=0;i<len;i++){if(boneList[i].name==parentName){bone=boneList[i];break;}}}var tBoneMt;if(bone){tBoneMt=bone.resultMatrix;}if(!tBoneMt)tBoneMt=PathConstraint._tempMt;var x=tBoneMt.tx;var y=tBoneMt.ty;var a=tBoneMt.a,bb=tBoneMt.b,c=tBoneMt.c,d=tBoneMt.d;if(bone)d*=bone.d;for(v=start,w=offset;w<count;v+=2,w+=2){vx=tTriangles[v],vy=tTriangles[v+1];worldVertices[w]=vx*a+vy*bb+x;worldVertices[w+1]=-(vx*c+vy*d+y);}return;}for(i=0;i<start;i+=2){n=tBones[v];v+=n+1;skip+=n;}var skeletonBones=boneList;for(w=offset,b=skip*3;w<count;w+=2){wx=0,wy=0;n=tBones[v++];n+=v;for(;v<n;v++,b+=3){tMatrix=skeletonBones[tBones[v]].resultMatrix;vx=tWeights[b];vy=tWeights[b+1];var weight=tWeights[b+2];wx+=(vx*tMatrix.a+vy*tMatrix.c+tMatrix.tx)*weight;wy+=(vx*tMatrix.b+vy*tMatrix.d+tMatrix.ty)*weight;}worldVertices[w]=wx;worldVertices[w+1]=wy;}}},{key:"computeWorldPositions",value:function computeWorldPositions(boneSlot,boneList,graphics,spacesCount,tangents,percentPosition,percentSpacing){var tBones=boneSlot.currDisplayData.bones;var tWeights=boneSlot.currDisplayData.weights;var tTriangles=boneSlot.currDisplayData.triangles;var tVertices=[];var i=0;var verticesLength=boneSlot.currDisplayData.verLen;var position=this.position;var spaces=this._spaces;var world=[];var out=[];var curveCount=verticesLength/6;var prevCurve=-1;var pathLength;var o,curve;var p;var space;var prev;var length;{curveCount--;verticesLength-=4;this.computeWorldVertices2(boneSlot,boneList,2,verticesLength,tVertices,0);if(this._debugKey){for(i=0;i<tVertices.length;){graphics.drawCircle(tVertices[i++],tVertices[i++],10,"#ff0000");}}world=tVertices;}this._curves.length=curveCount;var curves=this._curves;pathLength=0;var x1=world[0],y1=world[1],cx1=0,cy1=0,cx2=0,cy2=0,x2=0,y2=0;var tmpx,tmpy,dddfx,dddfy,ddfx,ddfy,dfx,dfy;var w;for(i=0,w=2;i<curveCount;i++,w+=6){cx1=world[w];cy1=world[w+1];cx2=world[w+2];cy2=world[w+3];x2=world[w+4];y2=world[w+5];tmpx=(x1-cx1*2+cx2)*0.1875;tmpy=(y1-cy1*2+cy2)*0.1875;dddfx=((cx1-cx2)*3-x1+x2)*0.09375;dddfy=((cy1-cy2)*3-y1+y2)*0.09375;ddfx=tmpx*2+dddfx;ddfy=tmpy*2+dddfy;dfx=(cx1-x1)*0.75+tmpx+dddfx*0.16666667;dfy=(cy1-y1)*0.75+tmpy+dddfy*0.16666667;pathLength+=Math.sqrt(dfx*dfx+dfy*dfy);dfx+=ddfx;dfy+=ddfy;ddfx+=dddfx;ddfy+=dddfy;pathLength+=Math.sqrt(dfx*dfx+dfy*dfy);dfx+=ddfx;dfy+=ddfy;pathLength+=Math.sqrt(dfx*dfx+dfy*dfy);dfx+=ddfx+dddfx;dfy+=ddfy+dddfy;pathLength+=Math.sqrt(dfx*dfx+dfy*dfy);curves[i]=pathLength;x1=x2;y1=y2;}if(percentPosition)position*=pathLength;if(percentSpacing){for(i=0;i<spacesCount;i++){spaces[i]*=pathLength;}}var segments=this._segments;var curveLength=0;var segment;for(i=0,o=0,curve=0,segment=0;i<spacesCount;i++,o+=3){space=spaces[i];position+=space;p=position;if(p<0){this.addBeforePosition(p,world,0,out,o);continue;}else if(p>pathLength){this.addAfterPosition(p-pathLength,world,verticesLength-4,out,o);continue;}for(;;curve++){length=curves[curve];if(p>length)continue;if(curve==0)p/=length;else{prev=curves[curve-1];p=(p-prev)/(length-prev);}break;}if(curve!=prevCurve){prevCurve=curve;var ii=curve*6;x1=world[ii];y1=world[ii+1];cx1=world[ii+2];cy1=world[ii+3];cx2=world[ii+4];cy2=world[ii+5];x2=world[ii+6];y2=world[ii+7];tmpx=(x1-cx1*2+cx2)*0.03;tmpy=(y1-cy1*2+cy2)*0.03;dddfx=((cx1-cx2)*3-x1+x2)*0.006;dddfy=((cy1-cy2)*3-y1+y2)*0.006;ddfx=tmpx*2+dddfx;ddfy=tmpy*2+dddfy;dfx=(cx1-x1)*0.3+tmpx+dddfx*0.16666667;dfy=(cy1-y1)*0.3+tmpy+dddfy*0.16666667;curveLength=Math.sqrt(dfx*dfx+dfy*dfy);segments[0]=curveLength;for(ii=1;ii<8;ii++){dfx+=ddfx;dfy+=ddfy;ddfx+=dddfx;ddfy+=dddfy;curveLength+=Math.sqrt(dfx*dfx+dfy*dfy);segments[ii]=curveLength;}dfx+=ddfx;dfy+=ddfy;curveLength+=Math.sqrt(dfx*dfx+dfy*dfy);segments[8]=curveLength;dfx+=ddfx+dddfx;dfy+=ddfy+dddfy;curveLength+=Math.sqrt(dfx*dfx+dfy*dfy);segments[9]=curveLength;segment=0;}p*=curveLength;for(;;segment++){length=segments[segment];if(p>length)continue;if(segment==0)p/=length;else{prev=segments[segment-1];p=segment+(p-prev)/(length-prev);}break;}this.addCurvePosition(p*0.1,x1,y1,cx1,cy1,cx2,cy2,x2,y2,out,o,tangents||i>0&&space==0);}return out;}},{key:"addBeforePosition",value:function addBeforePosition(p,temp,i,out,o){var x1=temp[i],y1=temp[i+1],dx=temp[i+2]-x1,dy=temp[i+3]-y1,r=Math.atan2(dy,dx);out[o]=x1+p*Math.cos(r);out[o+1]=y1+p*Math.sin(r);out[o+2]=r;}},{key:"addAfterPosition",value:function addAfterPosition(p,temp,i,out,o){var x1=temp[i+2],y1=temp[i+3],dx=x1-temp[i],dy=y1-temp[i+1],r=Math.atan2(dy,dx);out[o]=x1+p*Math.cos(r);out[o+1]=y1+p*Math.sin(r);out[o+2]=r;}},{key:"addCurvePosition",value:function addCurvePosition(p,x1,y1,cx1,cy1,cx2,cy2,x2,y2,out,o,tangents){if(p==0)p=0.0001;var tt=p*p,ttt=tt*p,u=1-p,uu=u*u,uuu=uu*u;var ut=u*p,ut3=ut*3,uut3=u*ut3,utt3=ut3*p;var x=x1*uuu+cx1*uut3+cx2*utt3+x2*ttt,y=y1*uuu+cy1*uut3+cy2*utt3+y2*ttt;out[o]=x;out[o+1]=y;if(tangents){out[o+2]=Math.atan2(y-(y1*uu+cy1*ut*2+cy2*tt),x-(x1*uu+cx1*ut*2+cx2*tt));}else{out[o+2]=0;}}}]);return PathConstraint;}();PathConstraint.BEFORE=-2;PathConstraint.AFTER=-3;PathConstraint._tempMt=new Laya.Matrix();var PathConstraintData=function PathConstraintData(){_classCallCheck(this,PathConstraintData);this.bones=[];};var TfConstraint=function(){function TfConstraint(data,bones){_classCallCheck(this,TfConstraint);this._temp=[];this._data=data;if(this._bones==null){this._bones=[];}this.target=bones[data.targetIndex];var j,n;for(j=0,n=data.boneIndexs.length;j<n;j++){this._bones.push(bones[data.boneIndexs[j]]);}this.rotateMix=data.rotateMix;this.translateMix=data.translateMix;this.scaleMix=data.scaleMix;this.shearMix=data.shearMix;}_createClass(TfConstraint,[{key:"apply",value:function apply(){var tTfBone;var ta=this.target.resultMatrix.a,tb=this.target.resultMatrix.b,tc=this.target.resultMatrix.c,td=this.target.resultMatrix.d;for(var j=0,n=this._bones.length;j<n;j++){tTfBone=this._bones[j];if(this.rotateMix>0){var a=tTfBone.resultMatrix.a,b=tTfBone.resultMatrix.b,c=tTfBone.resultMatrix.c,d=tTfBone.resultMatrix.d;var r=Math.atan2(tc,ta)-Math.atan2(c,a)+this._data.offsetRotation*Math.PI/180;if(r>Math.PI)r-=Math.PI*2;else if(r<-Math.PI)r+=Math.PI*2;r*=this.rotateMix;var cos=Math.cos(r),sin=Math.sin(r);tTfBone.resultMatrix.a=cos*a-sin*c;tTfBone.resultMatrix.b=cos*b-sin*d;tTfBone.resultMatrix.c=sin*a+cos*c;tTfBone.resultMatrix.d=sin*b+cos*d;}if(this.translateMix){this._temp[0]=this._data.offsetX;this._temp[1]=this._data.offsetY;this.target.localToWorld(this._temp);tTfBone.resultMatrix.tx+=(this._temp[0]-tTfBone.resultMatrix.tx)*this.translateMix;tTfBone.resultMatrix.ty+=(this._temp[1]-tTfBone.resultMatrix.ty)*this.translateMix;tTfBone.updateChild();}if(this.scaleMix>0){var bs=Math.sqrt(tTfBone.resultMatrix.a*tTfBone.resultMatrix.a+tTfBone.resultMatrix.c*tTfBone.resultMatrix.c);var ts=Math.sqrt(ta*ta+tc*tc);var s=bs>0.00001?(bs+(ts-bs+this._data.offsetScaleX)*this.scaleMix)/bs:0;tTfBone.resultMatrix.a*=s;tTfBone.resultMatrix.c*=s;bs=Math.sqrt(tTfBone.resultMatrix.b*tTfBone.resultMatrix.b+tTfBone.resultMatrix.d*tTfBone.resultMatrix.d);ts=Math.sqrt(tb*tb+td*td);s=bs>0.00001?(bs+(ts-bs+this._data.offsetScaleY)*this.scaleMix)/bs:0;tTfBone.resultMatrix.b*=s;tTfBone.resultMatrix.d*=s;}if(this.shearMix>0){b=tTfBone.resultMatrix.b,d=tTfBone.resultMatrix.d;var by=Math.atan2(d,b);r=Math.atan2(td,tb)-Math.atan2(tc,ta)-(by-Math.atan2(tTfBone.resultMatrix.c,tTfBone.resultMatrix.a));if(r>Math.PI)r-=Math.PI*2;else if(r<-Math.PI)r+=Math.PI*2;r=by+(r+this._data.offsetShearY*Math.PI/180)*this.shearMix;s=Math.sqrt(b*b+d*d);tTfBone.resultMatrix.b=Math.cos(r)*s;tTfBone.resultMatrix.d=Math.sin(r)*s;}}}}]);return TfConstraint;}();var Skeleton=function(_Laya$Sprite4){_inherits(Skeleton,_Laya$Sprite4);function Skeleton(){var templet=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;var aniMode=arguments.length>1&&arguments[1]!==undefined?arguments[1]:0;_classCallCheck(this,Skeleton);var _this125=_possibleConstructorReturn(this,(Skeleton.__proto__||Object.getPrototypeOf(Skeleton)).call(this));_this125._boneMatrixArray=[];_this125._lastTime=0;_this125._currAniIndex=-1;_this125._pause=true;_this125._aniClipIndex=-1;_this125._clipIndex=-1;_this125._skinIndex=0;_this125._skinName="default";_this125._aniMode=0;_this125._index=-1;_this125._total=-1;_this125._indexControl=false;_this125._eventIndex=0;_this125._drawOrderIndex=0;_this125._drawOrder=null;_this125._lastAniClipIndex=-1;_this125._lastUpdateAniClipIndex=-1;_this125._playAudio=true;_this125._soundChannelArr=[];if(templet)_this125.init(templet,aniMode);return _this125;}_createClass(Skeleton,[{key:"init",value:function init(templet){var aniMode=arguments.length>1&&arguments[1]!==undefined?arguments[1]:0;var i=0,n;if(aniMode==1){this._graphicsCache=[];for(i=0,n=templet.getAnimationCount();i<n;i++){this._graphicsCache.push([]);}}this._yReverseMatrix=templet.yReverseMatrix;this._aniMode=aniMode;this._templet=templet;this._templet._addReference(1);this._player=new AnimationPlayer();this._player.cacheFrameRate=templet.rate;this._player.templet=templet;this._player.play();this._parseSrcBoneMatrix();this._boneList=templet.mBoneArr;this._rootBone=templet.mRootBone;this._aniSectionDic=templet.aniSectionDic;if(templet.ikArr.length>0){this._ikArr=[];for(i=0,n=templet.ikArr.length;i<n;i++){this._ikArr.push(new IkConstraint(templet.ikArr[i],this._boneList));}}if(templet.pathArr.length>0){var tPathData;var tPathConstraint;if(this._pathDic==null)this._pathDic={};var tBoneSlot;for(i=0,n=templet.pathArr.length;i<n;i++){tPathData=templet.pathArr[i];tPathConstraint=new PathConstraint(tPathData,this._boneList);tBoneSlot=this._boneSlotDic[tPathData.name];if(tBoneSlot){tPathConstraint=new PathConstraint(tPathData,this._boneList);tPathConstraint.target=tBoneSlot;}this._pathDic[tPathData.name]=tPathConstraint;}}if(templet.tfArr.length>0){this._tfArr=[];for(i=0,n=templet.tfArr.length;i<n;i++){this._tfArr.push(new TfConstraint(templet.tfArr[i],this._boneList));}}if(templet.skinDataArray.length>0){var tSkinData=this._templet.skinDataArray[this._skinIndex];this._skinName=tSkinData.name;}this._player.on(Laya.Event.PLAYED,this,this._onPlay);this._player.on(Laya.Event.STOPPED,this,this._onStop);this._player.on(Laya.Event.PAUSED,this,this._onPause);}},{key:"load",value:function load(path){var complete=arguments.length>1&&arguments[1]!==undefined?arguments[1]:null;var aniMode=arguments.length>2&&arguments[2]!==undefined?arguments[2]:0;this._aniPath=path;this._complete=complete;this._loadAniMode=aniMode;Laya.ILaya.loader.load([{url:path,type:Laya.ILaya.Loader.BUFFER}],Laya.Handler.create(this,this._onLoaded));}},{key:"_onLoaded",value:function _onLoaded(){var arraybuffer=Laya.ILaya.Loader.getRes(this._aniPath);if(arraybuffer==null)return;if(IAniLib.Templet.TEMPLET_DICTIONARY==null){IAniLib.Templet.TEMPLET_DICTIONARY={};}var tFactory;tFactory=IAniLib.Templet.TEMPLET_DICTIONARY[this._aniPath];if(tFactory){if(tFactory.isParseFail){this._parseFail();}else{if(tFactory.isParserComplete){this._parseComplete();}else{tFactory.on(Laya.Event.COMPLETE,this,this._parseComplete);tFactory.on(Laya.Event.ERROR,this,this._parseFail);}}}else{tFactory=new IAniLib.Templet();tFactory._setCreateURL(this._aniPath);IAniLib.Templet.TEMPLET_DICTIONARY[this._aniPath]=tFactory;tFactory.on(Laya.Event.COMPLETE,this,this._parseComplete);tFactory.on(Laya.Event.ERROR,this,this._parseFail);tFactory.isParserComplete=false;tFactory.parseData(null,arraybuffer);}}},{key:"_parseComplete",value:function _parseComplete(){var tTemple=IAniLib.Templet.TEMPLET_DICTIONARY[this._aniPath];if(tTemple){this.init(tTemple,this._loadAniMode);this.play(0,true);}this._complete&&this._complete.runWith(this);}},{key:"_parseFail",value:function _parseFail(){console.log("[Error]:"+this._aniPath+"");}},{key:"_onPlay",value:function _onPlay(){this.event(Laya.Event.PLAYED);}},{key:"_onStop",value:function _onStop(){var tEventData;var tEventAniArr=this._templet.eventAniArr;var tEventArr=tEventAniArr[this._aniClipIndex];if(tEventArr&&this._eventIndex<tEventArr.length){for(;this._eventIndex<tEventArr.length;this._eventIndex++){tEventData=tEventArr[this._eventIndex];if(tEventData.time>=this._player.playStart&&tEventData.time<=this._player.playEnd){this.event(Laya.Event.LABEL,tEventData);}}}this._drawOrder=null;this.event(Laya.Event.STOPPED);}},{key:"_onPause",value:function _onPause(){this.event(Laya.Event.PAUSED);}},{key:"_parseSrcBoneMatrix",value:function _parseSrcBoneMatrix(){var i=0,n=0;n=this._templet.srcBoneMatrixArr.length;for(i=0;i<n;i++){this._boneMatrixArray.push(new Laya.Matrix());}if(this._aniMode==0){this._boneSlotDic=this._templet.boneSlotDic;this._bindBoneBoneSlotDic=this._templet.bindBoneBoneSlotDic;this._boneSlotArray=this._templet.boneSlotArray;}else{if(this._boneSlotDic==null)this._boneSlotDic={};if(this._bindBoneBoneSlotDic==null)this._bindBoneBoneSlotDic={};if(this._boneSlotArray==null)this._boneSlotArray=[];var tArr=this._templet.boneSlotArray;var tBS;var tBSArr;for(i=0,n=tArr.length;i<n;i++){tBS=tArr[i];tBSArr=this._bindBoneBoneSlotDic[tBS.parent];if(tBSArr==null){this._bindBoneBoneSlotDic[tBS.parent]=tBSArr=[];}this._boneSlotDic[tBS.name]=tBS=tBS.copy();tBSArr.push(tBS);this._boneSlotArray.push(tBS);}}}},{key:"_emitMissedEvents",value:function _emitMissedEvents(startTime,endTime){var startIndex=arguments.length>2&&arguments[2]!==undefined?arguments[2]:0;var tEventAniArr=this._templet.eventAniArr;var tEventArr=tEventAniArr[this._player.currentAnimationClipIndex];if(tEventArr){var i=0,len;var tEventData;len=tEventArr.length;for(i=startIndex;i<len;i++){tEventData=tEventArr[i];if(tEventData.time>=this._player.playStart&&tEventData.time<=this._player.playEnd){this.event(Laya.Event.LABEL,tEventData);}}}}},{key:"_update",value:function _update(){var autoKey=arguments.length>0&&arguments[0]!==undefined?arguments[0]:true;if(this._pause)return;if(autoKey&&this._indexControl){return;}var tCurrTime=this.timer.currTimer;var preIndex=this._player.currentKeyframeIndex;var dTime=tCurrTime-this._lastTime;if(autoKey){this._player._update(dTime);}else{preIndex=-1;}this._lastTime=tCurrTime;if(!this._player)return;this._index=this._clipIndex=this._player.currentKeyframeIndex;if(this._index<0)return;if(dTime>0&&this._clipIndex==preIndex&&this._lastUpdateAniClipIndex==this._aniClipIndex){return;}this._lastUpdateAniClipIndex=this._aniClipIndex;if(preIndex>this._clipIndex&&this._eventIndex!=0){this._emitMissedEvents(this._player.playStart,this._player.playEnd,this._eventIndex);this._eventIndex=0;}var tEventArr=this._templet.eventAniArr[this._aniClipIndex];var _soundChannel;if(tEventArr&&this._eventIndex<tEventArr.length){var tEventData=tEventArr[this._eventIndex];if(tEventData.time>=this._player.playStart&&tEventData.time<=this._player.playEnd){if(this._player.currentPlayTime>=tEventData.time){this.event(Laya.Event.LABEL,tEventData);this._eventIndex++;if(this._playAudio&&tEventData.audioValue&&tEventData.audioValue!=="null"&&tEventData.audioValue!=="undefined"){_soundChannel=Laya.SoundManager.playSound(this._player.templet._path+tEventData.audioValue,1,Laya.Handler.create(this,this._onAniSoundStoped));Laya.SoundManager.playbackRate=this._player.playbackRate;_soundChannel&&this._soundChannelArr.push(_soundChannel);}}}else if(tEventData.time<this._player.playStart&&this._playAudio&&tEventData.audioValue&&tEventData.audioValue!=="null"&&tEventData.audioValue!=="undefined"){this._eventIndex++;_soundChannel=Laya.SoundManager.playSound(this._player.templet._path+tEventData.audioValue,1,Laya.Handler.create(this,this._onAniSoundStoped),null,(this._player.currentPlayTime-tEventData.time)/1000);Laya.SoundManager.playbackRate=this._player.playbackRate;_soundChannel&&this._soundChannelArr.push(_soundChannel);}else{this._eventIndex++;}}var tGraphics;if(this._aniMode==0){tGraphics=this._templet.getGrahicsDataWithCache(this._aniClipIndex,this._clipIndex)||this._createGraphics();if(tGraphics&&this.graphics!=tGraphics){this.graphics=tGraphics;}}else if(this._aniMode==1){tGraphics=this._getGrahicsDataWithCache(this._aniClipIndex,this._clipIndex)||this._createGraphics();if(tGraphics&&this.graphics!=tGraphics){this.graphics=tGraphics;}}else{this._createGraphics();}}},{key:"_onAniSoundStoped",value:function _onAniSoundStoped(force){var _channel;for(var len=this._soundChannelArr.length,i=0;i<len;i++){_channel=this._soundChannelArr[i];if(_channel.isStopped||force){!_channel.isStopped&&_channel.stop();this._soundChannelArr.splice(i,1);len--;i--;}}}},{key:"_createGraphics",value:function _createGraphics(){var _clipIndex=arguments.length>0&&arguments[0]!==undefined?arguments[0]:-1;if(_clipIndex==-1)_clipIndex=this._clipIndex;var curTime=_clipIndex*this._player.cacheFrameRateInterval;var tDrawOrderData;var tDrawOrderAniArr=this._templet.drawOrderAniArr;var tDrawOrderArr=tDrawOrderAniArr[this._aniClipIndex];if(tDrawOrderArr&&tDrawOrderArr.length>0){this._drawOrderIndex=0;tDrawOrderData=tDrawOrderArr[this._drawOrderIndex];while(curTime>=tDrawOrderData.time){this._drawOrder=tDrawOrderData.drawOrder;this._drawOrderIndex++;if(this._drawOrderIndex>=tDrawOrderArr.length){break;}tDrawOrderData=tDrawOrderArr[this._drawOrderIndex];}}if(this._aniMode==0||this._aniMode==1){this.graphics=GraphicsAni.create();}else{if(this.graphics instanceof GraphicsAni){this.graphics.clear();}else{this.graphics=GraphicsAni.create();}}var tGraphics=this.graphics;var bones=this._templet.getNodes(this._aniClipIndex);var stopped=this._player.state==0;this._templet.getOriginalData(this._aniClipIndex,this._curOriginalData,null,_clipIndex,stopped?curTime+this._player.cacheFrameRateInterval:curTime);var tSectionArr=this._aniSectionDic[this._aniClipIndex];var tStartIndex=0;var i=0,j=0,k=0,n=0;var tDBBoneSlot;var tDBBoneSlotArr;var tParentTransform;var tSrcBone;var boneCount=this._templet.srcBoneMatrixArr.length;var origDt=this._curOriginalData;for(i=0,n=tSectionArr[0];i<boneCount;i++){tSrcBone=this._boneList[i];var resultTrans=tSrcBone.resultTransform;tParentTransform=this._templet.srcBoneMatrixArr[i];resultTrans.scX=tParentTransform.scX*origDt[tStartIndex++];resultTrans.skX=tParentTransform.skX+origDt[tStartIndex++];resultTrans.skY=tParentTransform.skY+origDt[tStartIndex++];resultTrans.scY=tParentTransform.scY*origDt[tStartIndex++];resultTrans.x=tParentTransform.x+origDt[tStartIndex++];resultTrans.y=tParentTransform.y+origDt[tStartIndex++];if(this._templet.tMatrixDataLen===8){resultTrans.skewX=tParentTransform.skewX+origDt[tStartIndex++];resultTrans.skewY=tParentTransform.skewY+origDt[tStartIndex++];}}var tSlotDic={};var tSlotAlphaDic={};var tBoneData;for(n+=tSectionArr[1];i<n;i++){tBoneData=bones[i];tSlotDic[tBoneData.name]=origDt[tStartIndex++];tSlotAlphaDic[tBoneData.name]=origDt[tStartIndex++];tStartIndex+=4;}var tBendDirectionDic={};var tMixDic={};for(n+=tSectionArr[2];i<n;i++){tBoneData=bones[i];tBendDirectionDic[tBoneData.name]=origDt[tStartIndex++];tMixDic[tBoneData.name]=origDt[tStartIndex++];tStartIndex+=4;}if(this._pathDic){var tPathConstraint;for(n+=tSectionArr[3];i<n;i++){tBoneData=bones[i];tPathConstraint=this._pathDic[tBoneData.name];if(tPathConstraint){var tByte=new Laya.Byte(tBoneData.extenData);switch(tByte.getByte()){case 1:tPathConstraint.position=origDt[tStartIndex++];break;case 2:tPathConstraint.spacing=origDt[tStartIndex++];break;case 3:tPathConstraint.rotateMix=origDt[tStartIndex++];tPathConstraint.translateMix=origDt[tStartIndex++];break;}}}}this._rootBone.update(this._yReverseMatrix||Laya.Matrix.TEMP.identity());if(this._ikArr){var tIkConstraint;for(i=0,n=this._ikArr.length;i<n;i++){tIkConstraint=this._ikArr[i];if(tIkConstraint.name in tBendDirectionDic){tIkConstraint.bendDirection=tBendDirectionDic[tIkConstraint.name];}if(tIkConstraint.name in tMixDic){tIkConstraint.mix=tMixDic[tIkConstraint.name];}tIkConstraint.apply();}}if(this._pathDic){for(var tPathStr in this._pathDic){tPathConstraint=this._pathDic[tPathStr];tPathConstraint.apply(this._boneList,tGraphics);}}if(this._tfArr){var tTfConstraint;for(i=0,k=this._tfArr.length;i<k;i++){tTfConstraint=this._tfArr[i];tTfConstraint.apply();}}for(i=0,k=this._boneList.length;i<k;i++){tSrcBone=this._boneList[i];tDBBoneSlotArr=this._bindBoneBoneSlotDic[tSrcBone.name];tSrcBone.resultMatrix.copyTo(this._boneMatrixArray[i]);if(tDBBoneSlotArr){for(j=0,n=tDBBoneSlotArr.length;j<n;j++){tDBBoneSlot=tDBBoneSlotArr[j];if(tDBBoneSlot){tDBBoneSlot.setParentMatrix(tSrcBone.resultMatrix);}}}}var tDeformDic={};var tDeformAniArr=this._templet.deformAniArr;var tDeformAniData;if(tDeformAniArr&&tDeformAniArr.length>0){if(this._lastAniClipIndex!=this._aniClipIndex){this._lastAniClipIndex=this._aniClipIndex;for(i=0,n=this._boneSlotArray.length;i<n;i++){tDBBoneSlot=this._boneSlotArray[i];tDBBoneSlot.deformData=null;}}var tSkinDeformAni=tDeformAniArr[this._aniClipIndex];tDeformAniData=tSkinDeformAni["default"];this._setDeform(tDeformAniData,tDeformDic,this._boneSlotArray,curTime);var tSkin;for(tSkin in tSkinDeformAni){if(tSkin!="default"&&tSkin!=this._skinName){tDeformAniData=tSkinDeformAni[tSkin];this._setDeform(tDeformAniData,tDeformDic,this._boneSlotArray,curTime);}}tDeformAniData=tSkinDeformAni[this._skinName];this._setDeform(tDeformAniData,tDeformDic,this._boneSlotArray,curTime);}var tSlotData2;var tSlotData3;var tObject;if(this._drawOrder){for(i=0,n=this._drawOrder.length;i<n;i++){tDBBoneSlot=this._boneSlotArray[this._drawOrder[i]];tSlotData2=tSlotDic[tDBBoneSlot.name];tSlotData3=tSlotAlphaDic[tDBBoneSlot.name];if(!isNaN(tSlotData2)&&tSlotData2!=-2){if(this._templet.attachmentNames){tDBBoneSlot.showDisplayByName(this._templet.attachmentNames[tSlotData2]);}else{tDBBoneSlot.showDisplayByIndex(tSlotData2);}}if(tDeformDic[this._drawOrder[i]]){tObject=tDeformDic[this._drawOrder[i]];if(tDBBoneSlot.currDisplayData&&tObject[tDBBoneSlot.currDisplayData.attachmentName]){tDBBoneSlot.deformData=tObject[tDBBoneSlot.currDisplayData.attachmentName];}else{tDBBoneSlot.deformData=null;}}else{tDBBoneSlot.deformData=null;}if(!isNaN(tSlotData3)){tDBBoneSlot.draw(tGraphics,this._boneMatrixArray,this._aniMode==2,tSlotData3);}else{tDBBoneSlot.draw(tGraphics,this._boneMatrixArray,this._aniMode==2);}}}else{for(i=0,n=this._boneSlotArray.length;i<n;i++){tDBBoneSlot=this._boneSlotArray[i];tSlotData2=tSlotDic[tDBBoneSlot.name];tSlotData3=tSlotAlphaDic[tDBBoneSlot.name];if(!isNaN(tSlotData2)&&tSlotData2!=-2){if(this._templet.attachmentNames){tDBBoneSlot.showDisplayByName(this._templet.attachmentNames[tSlotData2]);}else{tDBBoneSlot.showDisplayByIndex(tSlotData2);}}if(tDeformDic[i]){tObject=tDeformDic[i];if(tDBBoneSlot.currDisplayData&&tObject[tDBBoneSlot.currDisplayData.attachmentName]){tDBBoneSlot.deformData=tObject[tDBBoneSlot.currDisplayData.attachmentName];}else{tDBBoneSlot.deformData=null;}}else{tDBBoneSlot.deformData=null;}if(!isNaN(tSlotData3)){tDBBoneSlot.draw(tGraphics,this._boneMatrixArray,this._aniMode==2,tSlotData3);}else{tDBBoneSlot.draw(tGraphics,this._boneMatrixArray,this._aniMode==2);}}}if(this._aniMode==0){this._templet.setGrahicsDataWithCache(this._aniClipIndex,_clipIndex,tGraphics);this._checkIsAllParsed(this._aniClipIndex);}else if(this._aniMode==1){this._setGrahicsDataWithCache(this._aniClipIndex,_clipIndex,tGraphics);}return tGraphics;}},{key:"_checkIsAllParsed",value:function _checkIsAllParsed(_aniClipIndex){var i,len;len=Math.floor(0.01+this._templet.getAniDuration(_aniClipIndex)/1000*this._player.cacheFrameRate);for(i=0;i<len;i++){if(!this._templet.getGrahicsDataWithCache(_aniClipIndex,i))return;}if(!this._templet.getGrahicsDataWithCache(_aniClipIndex,len)){this._createGraphics(len);return;}this._templet.deleteAniData(_aniClipIndex);}},{key:"_setDeform",value:function _setDeform(tDeformAniData,tDeformDic,_boneSlotArray,curTime){if(!tDeformAniData)return;var tDeformSlotData;var tDeformSlotDisplayData;var tDBBoneSlot;var i,n,j;if(tDeformAniData){for(i=0,n=tDeformAniData.deformSlotDataList.length;i<n;i++){tDeformSlotData=tDeformAniData.deformSlotDataList[i];for(j=0;j<tDeformSlotData.deformSlotDisplayList.length;j++){tDeformSlotDisplayData=tDeformSlotData.deformSlotDisplayList[j];tDBBoneSlot=_boneSlotArray[tDeformSlotDisplayData.slotIndex];tDeformSlotDisplayData.apply(curTime,tDBBoneSlot);if(!tDeformDic[tDeformSlotDisplayData.slotIndex]){tDeformDic[tDeformSlotDisplayData.slotIndex]={};}tDeformDic[tDeformSlotDisplayData.slotIndex][tDeformSlotDisplayData.attachment]=tDeformSlotDisplayData.deformData;}}}}},{key:"getAnimNum",value:function getAnimNum(){return this._templet.getAnimationCount();}},{key:"getAniNameByIndex",value:function getAniNameByIndex(index){return this._templet.getAniNameByIndex(index);}},{key:"getSlotByName",value:function getSlotByName(name){return this._boneSlotDic[name];}},{key:"showSkinByName",value:function showSkinByName(name){var freshSlotIndex=arguments.length>1&&arguments[1]!==undefined?arguments[1]:true;this.showSkinByIndex(this._templet.getSkinIndexByName(name),freshSlotIndex);}},{key:"showSkinByIndex",value:function showSkinByIndex(skinIndex){var freshSlotIndex=arguments.length>1&&arguments[1]!==undefined?arguments[1]:true;for(var i=0;i<this._boneSlotArray.length;i++){this._boneSlotArray[i].showSlotData(null,freshSlotIndex);}if(this._templet.showSkinByIndex(this._boneSlotDic,skinIndex,freshSlotIndex)){var tSkinData=this._templet.skinDataArray[skinIndex];this._skinIndex=skinIndex;this._skinName=tSkinData.name;}this._clearCache();}},{key:"showSlotSkinByIndex",value:function showSlotSkinByIndex(slotName,index){if(this._aniMode==0)return;var tBoneSlot=this.getSlotByName(slotName);if(tBoneSlot){tBoneSlot.showDisplayByIndex(index);}this._clearCache();}},{key:"showSlotSkinByName",value:function showSlotSkinByName(slotName,name){if(this._aniMode==0)return;var tBoneSlot=this.getSlotByName(slotName);if(tBoneSlot){tBoneSlot.showDisplayByName(name);}this._clearCache();}},{key:"replaceSlotSkinName",value:function replaceSlotSkinName(slotName,oldName,newName){if(this._aniMode==0)return;var tBoneSlot=this.getSlotByName(slotName);if(tBoneSlot){tBoneSlot.replaceDisplayByName(oldName,newName);}this._clearCache();}},{key:"replaceSlotSkinByIndex",value:function replaceSlotSkinByIndex(slotName,oldIndex,newIndex){if(this._aniMode==0)return;var tBoneSlot=this.getSlotByName(slotName);if(tBoneSlot){tBoneSlot.replaceDisplayByIndex(oldIndex,newIndex);}this._clearCache();}},{key:"setSlotSkin",value:function setSlotSkin(slotName,texture){if(this._aniMode==0)return;var tBoneSlot=this.getSlotByName(slotName);if(tBoneSlot){tBoneSlot.replaceSkin(texture);}this._clearCache();}},{key:"_clearCache",value:function _clearCache(){if(this._aniMode==1){for(var i=0,n=this._graphicsCache.length;i<n;i++){for(var j=0,len=this._graphicsCache[i].length;j<len;j++){var gp=this._graphicsCache[i][j];if(gp&&gp!=this.graphics){GraphicsAni.recycle(gp);}}this._graphicsCache[i].length=0;}}}},{key:"play",value:function play(nameOrIndex,loop){var force=arguments.length>2&&arguments[2]!==undefined?arguments[2]:true;var start=arguments.length>3&&arguments[3]!==undefined?arguments[3]:0;var end=arguments.length>4&&arguments[4]!==undefined?arguments[4]:0;var freshSkin=arguments.length>5&&arguments[5]!==undefined?arguments[5]:true;var playAudio=arguments.length>6&&arguments[6]!==undefined?arguments[6]:true;this._playAudio=playAudio;this._indexControl=false;var index=-1;var duration;if(loop){duration=2147483647;}else{duration=0;}if(typeof nameOrIndex=='string'){for(var i=0,n=this._templet.getAnimationCount();i<n;i++){var animation=this._templet.getAnimation(i);if(animation&&nameOrIndex==animation.name){index=i;break;}}}else{index=nameOrIndex;}if(index>-1&&index<this.getAnimNum()){this._aniClipIndex=index;if(force||this._pause||this._currAniIndex!=index){this._currAniIndex=index;this._curOriginalData=new Float32Array(this._templet.getTotalkeyframesLength(index));this._drawOrder=null;this._eventIndex=0;this._player.play(index,this._player.playbackRate,duration,start,end);if(freshSkin)this._templet.showSkinByIndex(this._boneSlotDic,this._skinIndex);if(this._pause){this._pause=false;this._lastTime=Laya.ILaya.Browser.now();this.timer.frameLoop(1,this,this._update,null,true);}this._update();}}}},{key:"stop",value:function stop(){if(!this._pause){this._pause=true;if(this._player){this._player.stop(true);}if(this._soundChannelArr.length>0){this._onAniSoundStoped(true);}this.timer.clear(this,this._update);}}},{key:"playbackRate",value:function playbackRate(value){if(this._player){this._player.playbackRate=value;}}},{key:"paused",value:function paused(){if(!this._pause){this._pause=true;if(this._player){this._player.paused=true;}if(this._soundChannelArr.length>0){var _soundChannel;for(var len=this._soundChannelArr.length,i=0;i<len;i++){_soundChannel=this._soundChannelArr[i];if(!_soundChannel.isStopped){_soundChannel.pause();}}}this.timer.clear(this,this._update);}}},{key:"resume",value:function resume(){this._indexControl=false;if(this._pause){this._pause=false;if(this._player){this._player.paused=false;}if(this._soundChannelArr.length>0){var _soundChannel;for(var len=this._soundChannelArr.length,i=0;i<len;i++){_soundChannel=this._soundChannelArr[i];if(_soundChannel.audioBuffer){_soundChannel.resume();}}}this._lastTime=Laya.ILaya.Browser.now();this.timer.frameLoop(1,this,this._update,null,true);}}},{key:"_getGrahicsDataWithCache",value:function _getGrahicsDataWithCache(aniIndex,frameIndex){return this._graphicsCache[aniIndex][frameIndex];}},{key:"_setGrahicsDataWithCache",value:function _setGrahicsDataWithCache(aniIndex,frameIndex,graphics){this._graphicsCache[aniIndex][frameIndex]=graphics;}},{key:"destroy",value:function destroy(){var destroyChild=arguments.length>0&&arguments[0]!==undefined?arguments[0]:true;_get(Skeleton.prototype.__proto__||Object.getPrototypeOf(Skeleton.prototype),"destroy",this).call(this,destroyChild);this._templet._removeReference(1);this._templet=null;if(this._player)this._player.offAll();this._player=null;this._curOriginalData=null;this._boneMatrixArray.length=0;this._lastTime=0;this.timer.clear(this,this._update);if(this._soundChannelArr.length>0){this._onAniSoundStoped(true);}}},{key:"url",get:function get(){return this._aniPath;},set:function set(path){this.load(path);}},{key:"index",get:function get(){return this._index;},set:function set(value){if(this.player){this._index=value;this._player.currentTime=this._index*1000/this._player.cacheFrameRate;this._indexControl=true;this._update(false);}}},{key:"total",get:function get(){if(this._templet&&this._player){this._total=Math.floor(this._templet.getAniDuration(this._player.currentAnimationClipIndex)/1000*this._player.cacheFrameRate);}else{this._total=-1;}return this._total;}},{key:"player",get:function get(){return this._player;}},{key:"templet",get:function get(){return this._templet;}}]);return Skeleton;}(Laya.Sprite);Skeleton.useSimpleMeshInCanvas=false;IAniLib.Skeleton=Skeleton;Laya.ILaya.regClass(Skeleton);Laya.ClassUtils.regClass("laya.ani.bone.Skeleton",Skeleton);Laya.ClassUtils.regClass("Laya.Skeleton",Skeleton);var SkinData=function SkinData(){_classCallCheck(this,SkinData);this.slotArr=[];};var SkinSlotDisplayData=function(){function SkinSlotDisplayData(){_classCallCheck(this,SkinSlotDisplayData);}_createClass(SkinSlotDisplayData,[{key:"createTexture",value:function createTexture(currTexture){if(this.texture)return this.texture;this.texture=new Laya.Texture(currTexture.bitmap,this.uvs);if(this.uvs[0]>this.uvs[4]&&this.uvs[1]>this.uvs[5]){this.texture.width=currTexture.height;this.texture.height=currTexture.width;this.texture.offsetX=-currTexture.offsetX;this.texture.offsetY=-currTexture.offsetY;this.texture.sourceWidth=currTexture.sourceHeight;this.texture.sourceHeight=currTexture.sourceWidth;}else{this.texture.width=currTexture.width;this.texture.height=currTexture.height;this.texture.offsetX=-currTexture.offsetX;this.texture.offsetY=-currTexture.offsetY;this.texture.sourceWidth=currTexture.sourceWidth;this.texture.sourceHeight=currTexture.sourceHeight;}return this.texture;}},{key:"destory",value:function destory(){if(this.texture)this.texture.destroy();}}]);return SkinSlotDisplayData;}();var SlotData=function(){function SlotData(){_classCallCheck(this,SlotData);this.displayArr=[];}_createClass(SlotData,[{key:"getDisplayByName",value:function getDisplayByName(name){var tDisplay;for(var i=0,n=this.displayArr.length;i<n;i++){tDisplay=this.displayArr[i];if(tDisplay.attachmentName==name){return i;}}return-1;}}]);return SlotData;}();var TfConstraintData=function TfConstraintData(){_classCallCheck(this,TfConstraintData);this.boneIndexs=[];};var Templet=function(_AnimationTemplet){_inherits(Templet,_AnimationTemplet);function Templet(){_classCallCheck(this,Templet);var _this126=_possibleConstructorReturn(this,(Templet.__proto__||Object.getPrototypeOf(Templet)).apply(this,arguments));_this126._graphicsCache=[];_this126.srcBoneMatrixArr=[];_this126.ikArr=[];_this126.tfArr=[];_this126.pathArr=[];_this126.boneSlotDic={};_this126.bindBoneBoneSlotDic={};_this126.boneSlotArray=[];_this126.skinDataArray=[];_this126.skinDic={};_this126.subTextureDic={};_this126.isParseFail=false;_this126.drawOrderAniArr=[];_this126.eventAniArr=[];_this126.attachmentNames=null;_this126.deformAniArr=[];_this126.skinSlotDisplayDataArr=[];_this126._isParseAudio=false;_this126._isDestroyed=false;_this126._rate=30;_this126.isParserComplete=false;_this126.aniSectionDic={};_this126._textureDic={};_this126.mBoneArr=[];return _this126;}_createClass(Templet,[{key:"loadAni",value:function loadAni(url){this._skBufferUrl=url;Laya.ILaya.loader.load(url,Laya.Handler.create(this,this.onComplete),null,Laya.ILaya.Loader.BUFFER);}},{key:"onComplete",value:function onComplete(){var content=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;if(this._isDestroyed){this.destroy();return;}var tSkBuffer=Laya.ILaya.Loader.getRes(this._skBufferUrl);if(!tSkBuffer){this.event(Laya.Event.ERROR,"load failed:"+this._skBufferUrl);return;}this._path=this._skBufferUrl.slice(0,this._skBufferUrl.lastIndexOf("/"))+"/";this.parseData(null,tSkBuffer);}},{key:"parseData",value:function parseData(texture,skeletonData){var playbackRate=arguments.length>2&&arguments[2]!==undefined?arguments[2]:30;if(!this._path){var s1=this._relativeUrl||this.url;if(s1){var p1=s1.lastIndexOf('/');if(p1>0){this._path=s1.slice(0,p1)+"/";}else{this._path='';}}}this._mainTexture=texture;this._rate=playbackRate;this.parse(skeletonData);}},{key:"buildArmature",value:function buildArmature(){var aniMode=arguments.length>0&&arguments[0]!==undefined?arguments[0]:0;return new Skeleton(this,aniMode);}},{key:"parse",value:function parse(data){//super.parse(data);
var reader=new Laya.Byte(data);var _aniVersion=this._aniVersion=reader.readUTFString();if(_aniVersion=="LAYAANIMATION:03"){this.parseSk(reader);if(this._mainTexture){this._textureComplete03();}else{Laya.loader.load(this._loadList,Laya.Handler.create(this,this._textureComplete03));}}else{AnimationParser01.parse(this,reader);this.event(Laya.Event.LOADED,this);if(_aniVersion===Templet.LAYA_ANIMATION_VISION){this._isParseAudio=true;}else if(_aniVersion!=Templet.LAYA_ANIMATION_160_VISION){console.log("[Error] IDE"+_aniVersion+"->"+Templet.LAYA_ANIMATION_VISION);}if(this._mainTexture){this._parsePublicExtData();}else{this._parseTexturePath();}}}},{key:"parseSk",value:function parseSk(reader){this.reader=reader;this._aniClassName=reader.readUTFString();this._loadList=[this._path+reader.readUTFString()];var str=this.readStr(reader);this.strList=str.split("\n");var dataView=reader._d_;var pos=reader._pos_;var arrayTotal=dataView.getUint32(pos,true);pos+=4;var arrayChunk=dataView.buffer.slice(pos,pos+arrayTotal);pos+=arrayTotal;var arrayListLen=dataView.getUint16(pos,true);pos+=2;var arrayList=new Array(arrayListLen);var offset=0;for(var i=0;i<arrayListLen;i++){var type_num=dataView.getUint16(pos,true);pos+=2;var type=type_num>>>14;var num=type_num&0x3fff;if(type==3){arrayList[i]=new Float32Array(arrayChunk,offset,num);offset+=num*4;}else if(type==2){arrayList[i]=new Int16Array(arrayChunk,offset,num);if(num%2==0){offset+=num*2;}else{offset+=(num+1)*2;}}else{if(type==1){arrayList[i]=new Int8Array(arrayChunk,offset,num);}else{arrayList[i]=new Uint8Array(arrayChunk,offset,num);}offset+=num;var remain=num%4;if(remain>0){offset+=4-remain;}}}this.arrayList=arrayList;reader._pos_=pos;this._parseAni();}},{key:"_parseAni",value:function _parseAni(){var reader=this.reader;var dataView=reader._d_;var u8=reader._u8d_;var pos=reader._pos_;var strList=this.strList;var arrayList=this.arrayList;if(Templet.slotInterpolationMethod==null){Templet.slotInterpolationMethod=[AnimationTemplet.interpolation[5],AnimationTemplet.interpolation[0],AnimationTemplet.interpolation[0],AnimationTemplet.interpolation[0],AnimationTemplet.interpolation[0],AnimationTemplet.interpolation[0]];}var aniCount=dataView.getUint8(pos++,true);var matrixDataLen=this.tMatrixDataLen=u8[pos++];var boneNum=u8[pos++];for(var i=0;i<aniCount;i++){var ani=this._anis[i]=new AnimationContent();var nameIndex=this.readVaruint(pos);var name=ani.name=strList[nameIndex];pos=reader._pos_;this._aniMap[name]=i;ani.bone3DMap={};ani.playTime=dataView.getFloat32(pos,true);pos+=4;var boneCount=u8[pos++];ani.nodes=new Array(boneCount);ani.totalKeyframeDatasLength=0;for(var j=0;j<boneCount;j++){var node=ani.nodes[j]=new AnimationNodeContent();node.childs=[];var nameIndex=this.readVaruint(pos);pos=reader._pos_;node.name=strList[nameIndex];ani.bone3DMap[node.name]=j;var parentIndex=u8[pos++];node.parent=parentIndex==255?null:ani.nodes[parentIndex];node.lerpType=j>=boneNum?1:2;var keyframeDataCount=node.keyframeWidth=node.lerpType==1?6:matrixDataLen;ani.totalKeyframeDatasLength+=keyframeDataCount;if(node.lerpType===0||node.lerpType===1){node.interpolationMethod=Templet.slotInterpolationMethod;}if(node.parent!=null)node.parent.childs.push(node);var keyframeCount=u8[pos++];node.keyFrame=new Array(keyframeCount);for(var k=0,n=keyframeCount-1;k<=n;k++){var keyFrame=node.keyFrame[k]=new KeyFramesContent();if(k==0){keyFrame.startTime=0;}else{if(k==n){keyFrame.startTime=ani.playTime;keyFrame.duration=0;}else{keyFrame.startTime=dataView.getFloat32(pos,true);pos+=4;}node.keyFrame[k-1].duration=keyFrame.startTime-node.keyFrame[k-1].startTime;}if(node.lerpType===2){keyFrame.interpolationData=arrayList[this.readVaruint(pos)];pos=reader._pos_;}var arrayIndex=this.readVaruint(pos);keyFrame.data=arrayList[arrayIndex];pos=reader._pos_;}node.playTime=ani.playTime;this._calculateKeyFrame(node,keyframeCount,keyframeDataCount);}}reader._pos_=pos;}},{key:"_parsePublicExtData03",value:function _parsePublicExtData03(){var i=0,j=0,k=0,l=0;var aniCount=this._anis.length;for(i=0;i<aniCount;i++){this._graphicsCache.push([]);};var isSpine=false;isSpine=this._aniClassName!="Dragon";var tByte=this.reader;var strList=this.strList;var arrayList=this.arrayList;var tBoneLen=tByte.readUint16();for(i=0;i<aniCount;i++){this.aniSectionDic[i]=arrayList[this.readVaruint()];};var tMatrixArray=this.srcBoneMatrixArr;var tRootBone;for(i=0;i<tBoneLen;i++){var tBone=new Bone();if(i==0){tRootBone=tBone;}else{tBone.root=tRootBone;}tBone.d=isSpine?-1:1;var tName=strList[this.readVaruint()];var tParentNameIndex=tByte.readUint8();tBone.length=tByte.readFloat32();var inherit=tByte.readUint8();if((inherit&0x1)!=0){tBone.inheritRotation=false;}if((inherit&0x2)!=0){tBone.inheritScale=false;}tBone.name=tName;if(tParentNameIndex!=0xff){this.mBoneArr[tParentNameIndex].addChild(tBone);}else{this.mRootBone=tBone;}var tResultTransform=this.readTransform(tByte);tMatrixArray[i]=tResultTransform;tBone.transform=tResultTransform;this.mBoneArr[i]=tBone;};var tIkConstraintData;var tIkLen=tByte.readUint16();for(i=0;i<tIkLen;i++){tIkConstraintData=new IkConstraintData();tIkConstraintData.boneIndexs=arrayList[this.readVaruint()];tIkConstraintData.name=strList[this.readVaruint()];tIkConstraintData.targetBoneName=strList[this.readVaruint()];tIkConstraintData.targetBoneIndex=tByte.readInt16();tIkConstraintData.bendDirection=tByte.readInt16();tIkConstraintData.mix=tByte.readFloat32();tIkConstraintData.isSpine=isSpine;this.ikArr.push(tIkConstraintData);};var tTfConstraintData;var tTfLen=tByte.readUint16();var tTfBoneLen=0;for(i=0;i<tTfLen;i++){tTfConstraintData=new TfConstraintData();tTfBoneLen=tByte.readUint16();for(j=0;j<tTfBoneLen;j++){tTfConstraintData.boneIndexs.push(tByte.readInt16());}tTfConstraintData.name=strList[this.readVaruint()];tTfConstraintData.targetIndex=tByte.readInt16();tTfConstraintData.rotateMix=tByte.readFloat32();tTfConstraintData.translateMix=tByte.readFloat32();tTfConstraintData.scaleMix=tByte.readFloat32();tTfConstraintData.shearMix=tByte.readFloat32();tTfConstraintData.offsetRotation=tByte.readFloat32();tTfConstraintData.offsetX=tByte.readFloat32();tTfConstraintData.offsetY=tByte.readFloat32();tTfConstraintData.offsetScaleX=tByte.readFloat32();tTfConstraintData.offsetScaleY=tByte.readFloat32();tTfConstraintData.offsetShearY=tByte.readFloat32();this.tfArr.push(tTfConstraintData);};var tPathConstraintData;var tPathLen=tByte.readUint16();var tPathBoneLen=0;for(i=0;i<tPathLen;i++){tPathConstraintData=new PathConstraintData();tPathConstraintData.name=strList[this.readVaruint()];tPathBoneLen=tByte.readUint16();for(j=0;j<tPathBoneLen;j++){tPathConstraintData.bones.push(tByte.readInt16());}tPathConstraintData.target=strList[this.readVaruint()];tPathConstraintData.positionMode=strList[this.readVaruint()];tPathConstraintData.spacingMode=strList[this.readVaruint()];tPathConstraintData.rotateMode=strList[this.readVaruint()];tPathConstraintData.offsetRotation=tByte.readFloat32();tPathConstraintData.position=tByte.readFloat32();tPathConstraintData.spacing=tByte.readFloat32();tPathConstraintData.rotateMix=tByte.readFloat32();tPathConstraintData.translateMix=tByte.readFloat32();this.pathArr.push(tPathConstraintData);};var tDeformSlotLen=0;var tDeformSlotDisplayLen=0;var tDeformTimeLen=0;var tDeformAniData;var tDeformSlotData;var tDeformSlotDisplayData;var tDeformAniLen=tByte.readInt16();for(i=0;i<tDeformAniLen;i++){var tDeformSkinLen=tByte.readUint8();var tSkinDic={};this.deformAniArr.push(tSkinDic);for(var f=0;f<tDeformSkinLen;f++){tDeformAniData=new DeformAniData();tDeformAniData.skinName=strList[this.readVaruint()];tSkinDic[tDeformAniData.skinName]=tDeformAniData;tDeformSlotLen=tByte.readInt16();for(j=0;j<tDeformSlotLen;j++){tDeformSlotData=new DeformSlotData();tDeformAniData.deformSlotDataList.push(tDeformSlotData);tDeformSlotDisplayLen=tByte.readInt16();for(k=0;k<tDeformSlotDisplayLen;k++){tDeformSlotDisplayData=new DeformSlotDisplayData();tDeformSlotData.deformSlotDisplayList.push(tDeformSlotDisplayData);tDeformSlotDisplayData.slotIndex=tByte.readInt16();tDeformSlotDisplayData.attachment=strList[this.readVaruint()];tDeformTimeLen=tByte.readInt16();tDeformSlotDisplayData.timeList=arrayList[this.readVaruint()];for(l=0;l<tDeformTimeLen;l++){if(tByte.readUint8()==1){tDeformSlotDisplayData.tweenKeyList.push(true);}else{tDeformSlotDisplayData.tweenKeyList.push(false);}var tDeformVectices=arrayList[this.readVaruint()];tDeformSlotDisplayData.vectices.push(tDeformVectices);}}}}};var tDrawOrderArr;var tDrawOrderAniLen=tByte.readInt16();var tDrawOrderLen=0;var tDrawOrderData;for(i=0;i<tDrawOrderAniLen;i++){tDrawOrderLen=tByte.readInt16();tDrawOrderArr=[];for(j=0;j<tDrawOrderLen;j++){tDrawOrderData=new DrawOrderData();tDrawOrderData.time=tByte.readFloat32();tDrawOrderData.drawOrder=arrayList[this.readVaruint()];tDrawOrderArr.push(tDrawOrderData);}this.drawOrderAniArr.push(tDrawOrderArr);};var tEventArr;var tEventAniLen=tByte.readInt16();var tEventLen=0;var tEventData;for(i=0;i<tEventAniLen;i++){tEventLen=tByte.readInt16();tEventArr=[];for(j=0;j<tEventLen;j++){tEventData=new EventData();tEventData.name=strList[this.readVaruint()];tEventData.intValue=tByte.readInt32();tEventData.floatValue=tByte.readFloat32();tEventData.stringValue=strList[this.readVaruint()];tEventData.time=tByte.readFloat32();tEventArr.push(tEventData);}this.eventAniArr.push(tEventArr);};var tAttachmentLen=tByte.readInt16();if(tAttachmentLen>0){this.attachmentNames=new Array(tAttachmentLen);for(i=0;i<tAttachmentLen;i++){this.attachmentNames[i]=strList[this.readVaruint()];}};var tBoneSlotLen=tByte.readInt16();var tDBBoneSlot;var tDBBoneSlotArr;for(i=0;i<tBoneSlotLen;i++){tDBBoneSlot=new BoneSlot();tDBBoneSlot.name=strList[this.readVaruint()];tDBBoneSlot.parent=strList[this.readVaruint()];var blendValue=tByte.readUint8();var indexValue;if((blendValue&0x80)==0){indexValue=tByte.readUint8();tDBBoneSlot.attachmentName=strList[this.readVaruint()];}else{indexValue=-1;blendValue=blendValue&0x7f;}tDBBoneSlot.srcDisplayIndex=tDBBoneSlot.displayIndex=indexValue;tDBBoneSlot.blendMode=blendValue==0?'normal':'add';tDBBoneSlot.templet=this;this.boneSlotDic[tDBBoneSlot.name]=tDBBoneSlot;tDBBoneSlotArr=this.bindBoneBoneSlotDic[tDBBoneSlot.parent];if(tDBBoneSlotArr==null){this.bindBoneBoneSlotDic[tDBBoneSlot.parent]=tDBBoneSlotArr=[];}tDBBoneSlotArr.push(tDBBoneSlot);this.boneSlotArray.push(tDBBoneSlot);};var tSkinDataLen=tByte.readUint8();for(i=0;i<tSkinDataLen;i++){var tSkinData=new SkinData();tSkinData.name=strList[this.readVaruint()];var tSlotDataLen=tByte.readUint8();for(j=0;j<tSlotDataLen;j++){var tSlotData=new SlotData();tSlotData.name=strList[this.readVaruint()];tDBBoneSlot=this.boneSlotDic[tSlotData.name];var tDisplayDataLen=tByte.readUint8();for(k=0;k<tDisplayDataLen;k++){var tDisplayData=new SkinSlotDisplayData();this.skinSlotDisplayDataArr.push(tDisplayData);tDisplayData.name=strList[this.readVaruint()];tDisplayData.attachmentName=strList[this.readVaruint()];tDisplayData.transform=this.readTransform(tByte);tSlotData.displayArr.push(tDisplayData);var bit=tByte.readUint8();tDisplayData.type=bit&1;if(tDisplayData.type==0){tDisplayData.width=tByte.readUint16();tDisplayData.height=tByte.readUint16();}if((bit&2)!=0){tDisplayData.bones=arrayList[this.readVaruint()];}if((bit&4)!=0){tDisplayData.uvs=arrayList[this.readVaruint()];}if((bit&8)!=0){tDisplayData.weights=arrayList[this.readVaruint()];}if((bit&16)!=0){tDisplayData.triangles=arrayList[this.readVaruint()];}if((bit&32)!=0){tDisplayData.vertices=arrayList[this.readVaruint()];}if((bit&64)!=0){tDisplayData.lengths=arrayList[this.readVaruint()];}}tSkinData.slotArr[j]=tSlotData;}this.skinDic[tSkinData.name]=tSkinData;this.skinDataArray.push(tSkinData);};var tReverse=tByte.readUint8();if(tReverse==1){this.yReverseMatrix=new Laya.Matrix(1,0,0,-1,0,0);if(tRootBone){tRootBone.setTempMatrix(this.yReverseMatrix);}}else{if(tRootBone){tRootBone.setTempMatrix(new Matrix());}}this.showSkinByIndex(this.boneSlotDic,0);}},{key:"_textureComplete03",value:function _textureComplete03(){this._parsePublicExtData03();var strList=this.strList;var tSrcTexturePath=this._loadList[0];for(var i=0,n=this._loadList.length;i<n;i++){var tTextureName=this._loadList[i];var tTexture=this._textureDic[tTextureName]=Laya.ILaya.Loader.getRes(tTextureName);}var tByte=this.reader;var dataView=tByte._d_;var tTextureLen=tByte.readInt32();var pos=tByte._pos_;for(i=0;i<tTextureLen;i++){var tTexture=this._mainTexture;var tTextureName=strList[this.readVaruint(pos)];pos=tByte._pos_;if(this._mainTexture==null){tTexture=this._textureDic[tSrcTexturePath];}if(!tTexture){this.event(/*laya.events.Event.ERROR*/"error",this);this.isParseFail=true;return;}var tX=dataView.getUint16(pos,true);var tY=dataView.getUint16(pos+2,true);var tWidth=dataView.getUint16(pos+4,true);var tHeight=dataView.getUint16(pos+6,true);var tTempleData=dataView.getUint16(pos+8,true);var tFrameX=isNaN(tTempleData)?0:tTempleData;tTempleData=dataView.getUint16(pos+10,true);var tFrameY=isNaN(tTempleData)?0:tTempleData;tTempleData=dataView.getUint16(pos+12,true);var tFrameWidth=isNaN(tTempleData)?tWidth:tTempleData;tTempleData=dataView.getUint16(pos+14,true);pos+=16;var tFrameHeight=isNaN(tTempleData)?tHeight:tTempleData;this.subTextureDic[tTextureName]=Laya.Texture.create(tTexture,tX,tY,tWidth,tHeight,-tFrameX,-tFrameY,tFrameWidth,tFrameHeight);}this._mainTexture=tTexture;this.isParserComplete=true;this.reader=null;this.strList=null;this.arrayList=null;this.event(Laya.Event.COMPLETE,this);}},{key:"readVaruint",value:function readVaruint(){var pos=arguments.length>0&&arguments[0]!==undefined?arguments[0]:-1;var byte=this.reader;if(pos==-1)pos=byte._pos_;var u8Bin=byte._u8d_;var b=u8Bin[pos++];var value=b&0x7F;if(b&0x80){b=u8Bin[pos++];value|=(b&0x7F)<<7;if(b&0x80){b=u8Bin[pos++];value|=(b&0x7F)<<14;if(b&0x80){b=u8Bin[pos++];value|=(b&0x7F)<<21;if(b&0x80){b=u8Bin[pos++];value|=(b&0x7F)<<28;}}}}byte._pos_=pos;return value;}},{key:"readTransform",value:function readTransform(tByte){var transform=new Transform();var keys=Templet.transformKey;var transformType=tByte.readUint8();var bitMask=Templet.bitMask;for(var l=0;l<7;l++){if((bitMask[l]&transformType)!=0){transform[keys[l]]=tByte.readFloat32();}}transform.skY=transform.skX;return transform;}},{key:"readStr",value:function readStr(byte){var u=byte._u8d_;var pos=byte._pos_;var len=u[pos]+u[pos+1]*256;pos+=2;var arr=new Uint8Array(u.buffer,pos,len);byte._pos_=pos+len;return String.fromCharCode.apply(null,arr);}},{key:"_parseTexturePath",value:function _parseTexturePath(){if(this._isDestroyed){this.destroy();return;}var i=0;this._loadList=[];var tByte=new Laya.Byte(this.getPublicExtData());var tX=0,tY=0,tWidth=0,tHeight=0;var tTempleData=0;var tTextureLen=tByte.getInt32();var tTextureName=tByte.readUTFString();var tTextureNameArr=tTextureName.split("\n");var tSrcTexturePath;for(i=0;i<tTextureLen;i++){tSrcTexturePath=this._path+tTextureNameArr[i*2];tTextureName=tTextureNameArr[i*2+1];tX=tByte.getFloat32();tY=tByte.getFloat32();tWidth=tByte.getFloat32();tHeight=tByte.getFloat32();tTempleData=tByte.getFloat32();tTempleData=tByte.getFloat32();tTempleData=tByte.getFloat32();tTempleData=tByte.getFloat32();if(this._loadList.indexOf(tSrcTexturePath)==-1){this._loadList.push(tSrcTexturePath);}}Laya.ILaya.loader.load(this._loadList,Laya.Handler.create(this,this._textureComplete));}},{key:"_textureComplete",value:function _textureComplete(){var tTexture;var tTextureName;for(var i=0,n=this._loadList.length;i<n;i++){tTextureName=this._loadList[i];tTexture=this._textureDic[tTextureName]=Laya.ILaya.Loader.getRes(tTextureName);}this._parsePublicExtData();}},{key:"_parsePublicExtData",value:function _parsePublicExtData(){var i=0,j=0,k=0,l=0,n=0;for(i=0,n=this.getAnimationCount();i<n;i++){this._graphicsCache.push([]);}var isSpine;isSpine=this._aniClassName!="Dragon";var tByte=new Laya.Byte(this.getPublicExtData());var tX=0,tY=0,tWidth=0,tHeight=0;var tFrameX=0,tFrameY=0,tFrameWidth=0,tFrameHeight=0;var tTempleData=0;var tTextureLen=tByte.getInt32();var tTextureName=tByte.readUTFString();var tTextureNameArr=tTextureName.split("\n");var tTexture;var tSrcTexturePath;for(i=0;i<tTextureLen;i++){tTexture=this._mainTexture;tSrcTexturePath=this._path+tTextureNameArr[i*2];tTextureName=tTextureNameArr[i*2+1];if(this._mainTexture==null){tTexture=this._textureDic[tSrcTexturePath];}if(!tTexture){this.event(Laya.Event.ERROR,this);this.isParseFail=true;return;}tX=tByte.getFloat32();tY=tByte.getFloat32();tWidth=tByte.getFloat32();tHeight=tByte.getFloat32();tTempleData=tByte.getFloat32();tFrameX=isNaN(tTempleData)?0:tTempleData;tTempleData=tByte.getFloat32();tFrameY=isNaN(tTempleData)?0:tTempleData;tTempleData=tByte.getFloat32();tFrameWidth=isNaN(tTempleData)?tWidth:tTempleData;tTempleData=tByte.getFloat32();tFrameHeight=isNaN(tTempleData)?tHeight:tTempleData;this.subTextureDic[tTextureName]=Laya.Texture.create(tTexture,tX,tY,tWidth,tHeight,-tFrameX,-tFrameY,tFrameWidth,tFrameHeight);}this._mainTexture=tTexture;var tAniCount=tByte.getUint16();var tSectionArr;for(i=0;i<tAniCount;i++){tSectionArr=[];tSectionArr.push(tByte.getUint16());tSectionArr.push(tByte.getUint16());tSectionArr.push(tByte.getUint16());tSectionArr.push(tByte.getUint16());this.aniSectionDic[i]=tSectionArr;}var tBone;var tParentBone;var tName;var tParentName;var tBoneLen=tByte.getInt16();var tBoneDic={};var tRootBone;for(i=0;i<tBoneLen;i++){tBone=new Bone();if(i==0){tRootBone=tBone;}else{tBone.root=tRootBone;}tBone.d=isSpine?-1:1;tName=tByte.readUTFString();tParentName=tByte.readUTFString();tBone.length=tByte.getFloat32();if(tByte.getByte()==1){tBone.inheritRotation=false;}if(tByte.getByte()==1){tBone.inheritScale=false;}tBone.name=tName;if(tParentName){tParentBone=tBoneDic[tParentName];if(tParentBone){tParentBone.addChild(tBone);}else{this.mRootBone=tBone;}}tBoneDic[tName]=tBone;this.mBoneArr.push(tBone);}this.tMatrixDataLen=tByte.getUint16();var tLen=tByte.getUint16();var boneLength=Math.floor(tLen/this.tMatrixDataLen);var tResultTransform;var tMatrixArray=this.srcBoneMatrixArr;for(i=0;i<boneLength;i++){tResultTransform=new Transform();tResultTransform.scX=tByte.getFloat32();tResultTransform.skX=tByte.getFloat32();tResultTransform.skY=tByte.getFloat32();tResultTransform.scY=tByte.getFloat32();tResultTransform.x=tByte.getFloat32();tResultTransform.y=tByte.getFloat32();if(this.tMatrixDataLen===8){tResultTransform.skewX=tByte.getFloat32();tResultTransform.skewY=tByte.getFloat32();}tMatrixArray.push(tResultTransform);tBone=this.mBoneArr[i];tBone.transform=tResultTransform;}var tIkConstraintData;var tIkLen=tByte.getUint16();var tIkBoneLen;for(i=0;i<tIkLen;i++){tIkConstraintData=new IkConstraintData();tIkBoneLen=tByte.getUint16();for(j=0;j<tIkBoneLen;j++){tIkConstraintData.boneNames.push(tByte.readUTFString());tIkConstraintData.boneIndexs.push(tByte.getInt16());}tIkConstraintData.name=tByte.readUTFString();tIkConstraintData.targetBoneName=tByte.readUTFString();tIkConstraintData.targetBoneIndex=tByte.getInt16();tIkConstraintData.bendDirection=tByte.getFloat32();tIkConstraintData.mix=tByte.getFloat32();tIkConstraintData.isSpine=isSpine;this.ikArr.push(tIkConstraintData);}var tTfConstraintData;var tTfLen=tByte.getUint16();var tTfBoneLen;for(i=0;i<tTfLen;i++){tTfConstraintData=new TfConstraintData();tTfBoneLen=tByte.getUint16();for(j=0;j<tTfBoneLen;j++){tTfConstraintData.boneIndexs.push(tByte.getInt16());}tTfConstraintData.name=tByte.getUTFString();tTfConstraintData.targetIndex=tByte.getInt16();tTfConstraintData.rotateMix=tByte.getFloat32();tTfConstraintData.translateMix=tByte.getFloat32();tTfConstraintData.scaleMix=tByte.getFloat32();tTfConstraintData.shearMix=tByte.getFloat32();tTfConstraintData.offsetRotation=tByte.getFloat32();tTfConstraintData.offsetX=tByte.getFloat32();tTfConstraintData.offsetY=tByte.getFloat32();tTfConstraintData.offsetScaleX=tByte.getFloat32();tTfConstraintData.offsetScaleY=tByte.getFloat32();tTfConstraintData.offsetShearY=tByte.getFloat32();this.tfArr.push(tTfConstraintData);}var tPathConstraintData;var tPathLen=tByte.getUint16();var tPathBoneLen;for(i=0;i<tPathLen;i++){tPathConstraintData=new PathConstraintData();tPathConstraintData.name=tByte.readUTFString();tPathBoneLen=tByte.getUint16();for(j=0;j<tPathBoneLen;j++){tPathConstraintData.bones.push(tByte.getInt16());}tPathConstraintData.target=tByte.readUTFString();tPathConstraintData.positionMode=tByte.readUTFString();tPathConstraintData.spacingMode=tByte.readUTFString();tPathConstraintData.rotateMode=tByte.readUTFString();tPathConstraintData.offsetRotation=tByte.getFloat32();tPathConstraintData.position=tByte.getFloat32();tPathConstraintData.spacing=tByte.getFloat32();tPathConstraintData.rotateMix=tByte.getFloat32();tPathConstraintData.translateMix=tByte.getFloat32();this.pathArr.push(tPathConstraintData);}var tDeformSlotLen;var tDeformSlotDisplayLen;var tDSlotIndex;var tDAttachment;var tDeformTimeLen;var tDTime;var tDeformVecticesLen;var tDeformAniData;var tDeformSlotData;var tDeformSlotDisplayData;var tDeformVectices;var tDeformAniLen=tByte.getInt16();for(i=0;i<tDeformAniLen;i++){var tDeformSkinLen=tByte.getUint8();var tSkinDic={};this.deformAniArr.push(tSkinDic);for(var f=0;f<tDeformSkinLen;f++){tDeformAniData=new DeformAniData();tDeformAniData.skinName=tByte.getUTFString();tSkinDic[tDeformAniData.skinName]=tDeformAniData;tDeformSlotLen=tByte.getInt16();for(j=0;j<tDeformSlotLen;j++){tDeformSlotData=new DeformSlotData();tDeformAniData.deformSlotDataList.push(tDeformSlotData);tDeformSlotDisplayLen=tByte.getInt16();for(k=0;k<tDeformSlotDisplayLen;k++){tDeformSlotDisplayData=new DeformSlotDisplayData();tDeformSlotData.deformSlotDisplayList.push(tDeformSlotDisplayData);tDeformSlotDisplayData.slotIndex=tDSlotIndex=tByte.getInt16();tDeformSlotDisplayData.attachment=tDAttachment=tByte.getUTFString();tDeformTimeLen=tByte.getInt16();for(l=0;l<tDeformTimeLen;l++){if(tByte.getByte()==1){tDeformSlotDisplayData.tweenKeyList.push(true);}else{tDeformSlotDisplayData.tweenKeyList.push(false);}tDTime=tByte.getFloat32();tDeformSlotDisplayData.timeList.push(tDTime);tDeformVectices=[];tDeformSlotDisplayData.vectices.push(tDeformVectices);tDeformVecticesLen=tByte.getInt16();for(n=0;n<tDeformVecticesLen;n++){tDeformVectices.push(tByte.getFloat32());}}}}}}var tDrawOrderArr;var tDrawOrderAniLen=tByte.getInt16();var tDrawOrderLen;var tDrawOrderData;var tDoLen;for(i=0;i<tDrawOrderAniLen;i++){tDrawOrderLen=tByte.getInt16();tDrawOrderArr=[];for(j=0;j<tDrawOrderLen;j++){tDrawOrderData=new DrawOrderData();tDrawOrderData.time=tByte.getFloat32();tDoLen=tByte.getInt16();for(k=0;k<tDoLen;k++){tDrawOrderData.drawOrder.push(tByte.getInt16());}tDrawOrderArr.push(tDrawOrderData);}this.drawOrderAniArr.push(tDrawOrderArr);}var tEventArr;var tEventAniLen=tByte.getInt16();var tEventLen;var tEventData;for(i=0;i<tEventAniLen;i++){tEventLen=tByte.getInt16();tEventArr=[];for(j=0;j<tEventLen;j++){tEventData=new EventData();tEventData.name=tByte.getUTFString();if(this._isParseAudio)tEventData.audioValue=tByte.getUTFString();tEventData.intValue=tByte.getInt32();tEventData.floatValue=tByte.getFloat32();tEventData.stringValue=tByte.getUTFString();tEventData.time=tByte.getFloat32();tEventArr.push(tEventData);}this.eventAniArr.push(tEventArr);}var tAttachmentLen=tByte.getInt16();if(tAttachmentLen>0){this.attachmentNames=[];for(i=0;i<tAttachmentLen;i++){this.attachmentNames.push(tByte.getUTFString());}}var tBoneSlotLen=tByte.getInt16();var tDBBoneSlot;var tDBBoneSlotArr;for(i=0;i<tBoneSlotLen;i++){tDBBoneSlot=new BoneSlot();tDBBoneSlot.name=tByte.readUTFString();tDBBoneSlot.parent=tByte.readUTFString();tDBBoneSlot.attachmentName=tByte.readUTFString();tDBBoneSlot.srcDisplayIndex=tDBBoneSlot.displayIndex=tByte.getInt16();tDBBoneSlot.templet=this;// //todo blendMode
// var slotName = this._skBufferUrl.slice(this._skBufferUrl.lastIndexOf("/") + 1) + "/" + tDBBoneSlot.name;
// tDBBoneSlot.blendMode = window['Utils'].getBlendMode(slotName);
this.boneSlotDic[tDBBoneSlot.name]=tDBBoneSlot;tDBBoneSlotArr=this.bindBoneBoneSlotDic[tDBBoneSlot.parent];if(tDBBoneSlotArr==null){this.bindBoneBoneSlotDic[tDBBoneSlot.parent]=tDBBoneSlotArr=[];}tDBBoneSlotArr.push(tDBBoneSlot);this.boneSlotArray.push(tDBBoneSlot);}var tNameString=tByte.readUTFString();var tNameArray=tNameString.split("\n");var tNameStartIndex=0;var tSkinDataLen=tByte.getUint8();var tSkinData,tSlotData,tDisplayData;var tSlotDataLen,tDisplayDataLen;var tUvLen,tWeightLen,tTriangleLen,tVerticeLen,tLengthLen;for(i=0;i<tSkinDataLen;i++){tSkinData=new SkinData();tSkinData.name=tNameArray[tNameStartIndex++];tSlotDataLen=tByte.getUint8();for(j=0;j<tSlotDataLen;j++){tSlotData=new SlotData();tSlotData.name=tNameArray[tNameStartIndex++];tDBBoneSlot=this.boneSlotDic[tSlotData.name];tDisplayDataLen=tByte.getUint8();for(k=0;k<tDisplayDataLen;k++){tDisplayData=new SkinSlotDisplayData();this.skinSlotDisplayDataArr.push(tDisplayData);tDisplayData.name=tNameArray[tNameStartIndex++];tDisplayData.attachmentName=tNameArray[tNameStartIndex++];tDisplayData.transform=new Transform();tDisplayData.transform.scX=tByte.getFloat32();tDisplayData.transform.skX=tByte.getFloat32();tDisplayData.transform.skY=tByte.getFloat32();tDisplayData.transform.scY=tByte.getFloat32();tDisplayData.transform.x=tByte.getFloat32();tDisplayData.transform.y=tByte.getFloat32();tSlotData.displayArr.push(tDisplayData);tDisplayData.width=tByte.getFloat32();tDisplayData.height=tByte.getFloat32();tDisplayData.type=tByte.getUint8();tDisplayData.verLen=tByte.getUint16();tBoneLen=tByte.getUint16();if(tBoneLen>0){tDisplayData.bones=[];for(l=0;l<tBoneLen;l++){var tBoneId=tByte.getUint16();tDisplayData.bones.push(tBoneId);}}tUvLen=tByte.getUint16();if(tUvLen>0){tDisplayData.uvs=[];for(l=0;l<tUvLen;l++){tDisplayData.uvs.push(tByte.getFloat32());}}tWeightLen=tByte.getUint16();if(tWeightLen>0){tDisplayData.weights=[];for(l=0;l<tWeightLen;l++){tDisplayData.weights.push(tByte.getFloat32());}}tTriangleLen=tByte.getUint16();if(tTriangleLen>0){tDisplayData.triangles=[];for(l=0;l<tTriangleLen;l++){tDisplayData.triangles.push(tByte.getUint16());}}tVerticeLen=tByte.getUint16();if(tVerticeLen>0){tDisplayData.vertices=[];for(l=0;l<tVerticeLen;l++){tDisplayData.vertices.push(tByte.getFloat32());}}tLengthLen=tByte.getUint16();if(tLengthLen>0){tDisplayData.lengths=[];for(l=0;l<tLengthLen;l++){tDisplayData.lengths.push(tByte.getFloat32());}}}tSkinData.slotArr.push(tSlotData);}this.skinDic[tSkinData.name]=tSkinData;this.skinDataArray.push(tSkinData);}var tReverse=tByte.getUint8();if(tReverse==1){this.yReverseMatrix=new Laya.Matrix(1,0,0,-1,0,0);if(tRootBone){tRootBone.setTempMatrix(this.yReverseMatrix);}}else{if(tRootBone){tRootBone.setTempMatrix(new Laya.Matrix());}}this.showSkinByIndex(this.boneSlotDic,0);this.isParserComplete=true;this.event(Laya.Event.COMPLETE,this);}},{key:"getTexture",value:function getTexture(name){var tTexture=this.subTextureDic[name];if(!tTexture){tTexture=this.subTextureDic[name.substr(0,name.length-1)];}if(tTexture==null){return this._mainTexture;}return tTexture;}},{key:"showSkinByIndex",value:function showSkinByIndex(boneSlotDic,skinIndex){var freshDisplayIndex=arguments.length>2&&arguments[2]!==undefined?arguments[2]:true;if(skinIndex<0&&skinIndex>=this.skinDataArray.length)return false;var i,n;var tBoneSlot;var tSlotData;var tSkinData=this.skinDataArray[skinIndex];if(tSkinData){for(i=0,n=tSkinData.slotArr.length;i<n;i++){tSlotData=tSkinData.slotArr[i];if(tSlotData){tBoneSlot=boneSlotDic[tSlotData.name];if(tBoneSlot){tBoneSlot.showSlotData(tSlotData,freshDisplayIndex);if(freshDisplayIndex&&tBoneSlot.attachmentName!="undefined"&&tBoneSlot.attachmentName!="null"){tBoneSlot.showDisplayByName(tBoneSlot.attachmentName);}else{tBoneSlot.showDisplayByIndex(tBoneSlot.displayIndex);}}}}return true;}return false;}},{key:"getSkinIndexByName",value:function getSkinIndexByName(skinName){var tSkinData;for(var i=0,n=this.skinDataArray.length;i<n;i++){tSkinData=this.skinDataArray[i];if(tSkinData.name==skinName){return i;}}return-1;}},{key:"getGrahicsDataWithCache",value:function getGrahicsDataWithCache(aniIndex,frameIndex){if(this._graphicsCache[aniIndex]&&this._graphicsCache[aniIndex][frameIndex]){return this._graphicsCache[aniIndex][frameIndex];}return null;}},{key:"_setCreateURL",value:function _setCreateURL(url){this._skBufferUrl=this._relativeUrl=url;_get(Templet.prototype.__proto__||Object.getPrototypeOf(Templet.prototype),"_setCreateURL",this).call(this,url);}},{key:"setGrahicsDataWithCache",value:function setGrahicsDataWithCache(aniIndex,frameIndex,graphics){this._graphicsCache[aniIndex][frameIndex]=graphics;}},{key:"deleteAniData",value:function deleteAniData(aniIndex){if(this._anis[aniIndex]){var tAniDataO=this._anis[aniIndex];tAniDataO.bone3DMap=null;tAniDataO.nodes=null;}}},{key:"destroy",value:function destroy(){this._isDestroyed=true;var tTexture;for(tTexture in this.subTextureDic){if(tTexture){this.subTextureDic[tTexture].destroy();}}for(tTexture in this._textureDic){if(tTexture){this._textureDic[tTexture].destroy();}}var tSkinSlotDisplayData;for(var i=0,n=this.skinSlotDisplayDataArr.length;i<n;i++){tSkinSlotDisplayData=this.skinSlotDisplayDataArr[i];tSkinSlotDisplayData.destory();}this.skinSlotDisplayDataArr.length=0;if(this._relativeUrl){delete Templet.TEMPLET_DICTIONARY[this._relativeUrl];}_get(Templet.prototype.__proto__||Object.getPrototypeOf(Templet.prototype),"destroy",this).call(this);Laya.ILaya.loader.clearRes(this._skBufferUrl);}},{key:"getAniNameByIndex",value:function getAniNameByIndex(index){var tAni=this.getAnimation(index);if(tAni)return tAni.name;return null;}},{key:"rate",get:function get(){return this._rate;},set:function set(v){this._rate=v;}}]);return Templet;}(AnimationTemplet);Templet.slotInterpolationMethod=null;Templet.bitMask=[1,2,4,8,16,32,64,128];Templet.transformKey=['scX','scY','skX','x','y','skewX','skewY'];Templet.LAYA_ANIMATION_160_VISION="LAYAANIMATION:1.6.0";Templet.LAYA_ANIMATION_VISION="LAYAANIMATION:1.7.0";IAniLib.Templet=Templet;var MovieClip=function(_Laya$Sprite5){_inherits(MovieClip,_Laya$Sprite5);function MovieClip(){var parentMovieClip=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;_classCallCheck(this,MovieClip);var _this127=_possibleConstructorReturn(this,(MovieClip.__proto__||Object.getPrototypeOf(MovieClip)).call(this));_this127._start=0;_this127._Pos=0;_this127._ended=true;_this127._loadedImage={};_this127._endFrame=-1;_this127.interval=30;_this127._ids={};_this127._idOfSprite=[];_this127._reset();_this127._playing=false;_this127._parentMovieClip=parentMovieClip;if(!parentMovieClip){_this127._movieClipList=[_this127];_this127._isRoot=true;_this127._setBitUp(Laya.Const.DISPLAY);}else{_this127._isRoot=false;_this127._movieClipList=parentMovieClip._movieClipList;_this127._movieClipList.push(_this127);}return _this127;}_createClass(MovieClip,[{key:"destroy",value:function destroy(){var destroyChild=arguments.length>0&&arguments[0]!==undefined?arguments[0]:true;this._clear();_get(MovieClip.prototype.__proto__||Object.getPrototypeOf(MovieClip.prototype),"destroy",this).call(this,destroyChild);}},{key:"_setDisplay",value:function _setDisplay(value){_get(MovieClip.prototype.__proto__||Object.getPrototypeOf(MovieClip.prototype),"_setDisplay",this).call(this,value);if(this._isRoot){this._onDisplay(value);}}},{key:"_onDisplay",value:function _onDisplay(value){if(value)this.timer.loop(this.interval,this,this.updates,null,true);else this.timer.clear(this,this.updates);}},{key:"updates",value:function updates(){if(this._parentMovieClip)return;var i,len;len=this._movieClipList.length;for(i=0;i<len;i++){this._movieClipList[i]&&this._movieClipList[i]._update();}}},{key:"addLabel",value:function addLabel(label,index){if(!this._labels)this._labels={};this._labels[index]=label;}},{key:"removeLabel",value:function removeLabel(label){if(!label)this._labels=null;else if(!this._labels){for(var name in this._labels){if(this._labels[name]===label){delete this._labels[name];break;}}}}},{key:"_update",value:function _update(){if(!this._data)return;if(!this._playing)return;this._playIndex++;if(this._playIndex>=this._count){if(!this.loop){this._playIndex--;this.stop();return;}this._playIndex=0;}this._parseFrame(this._playIndex);if(this._labels&&this._labels[this._playIndex])this.event(Laya.Event.LABEL,this._labels[this._playIndex]);if(this._endFrame!=-1&&this._endFrame==this._playIndex){this._endFrame=-1;if(this._completeHandler!=null){var handler=this._completeHandler;this._completeHandler=null;handler.run();}this.stop();}}},{key:"stop",value:function stop(){this._playing=false;}},{key:"gotoAndStop",value:function gotoAndStop(index){this.index=index;this.stop();}},{key:"_clear",value:function _clear(){this.stop();this._idOfSprite.length=0;if(!this._parentMovieClip){this.timer.clear(this,this.updates);var i,len;len=this._movieClipList.length;for(i=0;i<len;i++){if(this._movieClipList[i]!=this)this._movieClipList[i]._clear();}this._movieClipList.length=0;}if(this._atlasPath){Laya.ILaya.Loader.clearRes(this._atlasPath);}var key;for(key in this._loadedImage){if(this._loadedImage[key]){Laya.ILaya.Loader.clearRes(key);this._loadedImage[key]=false;}}this.removeChildren();this.graphics=null;this._parentMovieClip=null;}},{key:"play",value:function play(){var index=arguments.length>0&&arguments[0]!==undefined?arguments[0]:0;var loop=arguments.length>1&&arguments[1]!==undefined?arguments[1]:true;this.loop=loop;this._playing=true;if(this._data)this._displayFrame(index);}},{key:"_displayFrame",value:function _displayFrame(){var frameIndex=arguments.length>0&&arguments[0]!==undefined?arguments[0]:-1;if(frameIndex!=-1){if(this._curIndex>frameIndex)this._reset();this._parseFrame(frameIndex);}}},{key:"_reset",value:function _reset(){var rm=arguments.length>0&&arguments[0]!==undefined?arguments[0]:true;if(rm&&this._curIndex!=1)this.removeChildren();this._preIndex=this._curIndex=-1;this._Pos=this._start;}},{key:"_parseFrame",value:function _parseFrame(frameIndex){var mc,sp,key,type,tPos,ttype,ifAdd=false;var _idOfSprite=this._idOfSprite,_data=this._data,eStr;if(this._ended)this._reset();_data.pos=this._Pos;this._ended=false;this._playIndex=frameIndex;if(this._curIndex>frameIndex&&frameIndex<this._preIndex){this._reset(true);_data.pos=this._Pos;}while(this._curIndex<=frameIndex&&!this._ended){type=_data.getUint16();switch(type){case 12:key=_data.getUint16();tPos=this._ids[_data.getUint16()];this._Pos=_data.pos;_data.pos=tPos;if((ttype=_data.getUint8())==0){var pid=_data.getUint16();sp=_idOfSprite[key];if(!sp){sp=_idOfSprite[key]=new Laya.Sprite();var spp=new Laya.Sprite();spp.loadImage(this.basePath+pid+".png");this._loadedImage[this.basePath+pid+".png"]=true;sp.addChild(spp);spp.size(_data.getFloat32(),_data.getFloat32());var mat=_data._getMatrix();spp.transform=mat;}sp.alpha=1;}else if(ttype==1){mc=_idOfSprite[key];if(!mc){_idOfSprite[key]=mc=new MovieClip(this);mc.interval=this.interval;mc._ids=this._ids;mc.basePath=this.basePath;mc._setData(_data,tPos);mc._initState();mc.play(0);}mc.alpha=1;}_data.pos=this._Pos;break;case 3:var node=_idOfSprite[_data.getUint16()];if(node){this.addChild(node);node.zOrder=_data.getUint16();ifAdd=true;}break;case 4:node=_idOfSprite[_data.getUint16()];node&&node.removeSelf();break;case 5:_idOfSprite[_data.getUint16()][MovieClip._ValueList[_data.getUint16()]]=_data.getFloat32();break;case 6:_idOfSprite[_data.getUint16()].visible=_data.getUint8()>0;break;case 7:sp=_idOfSprite[_data.getUint16()];var mt=sp.transform||Laya.Matrix.create();mt.setTo(_data.getFloat32(),_data.getFloat32(),_data.getFloat32(),_data.getFloat32(),_data.getFloat32(),_data.getFloat32());sp.transform=mt;break;case 8:_idOfSprite[_data.getUint16()].setPos(_data.getFloat32(),_data.getFloat32());break;case 9:_idOfSprite[_data.getUint16()].setSize(_data.getFloat32(),_data.getFloat32());break;case 10:_idOfSprite[_data.getUint16()].alpha=_data.getFloat32();break;case 11:_idOfSprite[_data.getUint16()].setScale(_data.getFloat32(),_data.getFloat32());break;case 98:eStr=_data.getString();this.event(eStr);if(eStr=="stop")this.stop();break;case 99:this._curIndex=_data.getUint16();ifAdd&&this.updateZOrder();break;case 100:this._count=this._curIndex+1;this._ended=true;if(this._playing){this.event(Laya.Event.FRAME);this.event(Laya.Event.END);this.event(Laya.Event.COMPLETE);}this._reset(false);break;}}if(this._playing&&!this._ended)this.event(Laya.Event.FRAME);this._Pos=_data.pos;}},{key:"_setData",value:function _setData(data,start){this._data=data;this._start=start+3;}},{key:"load",value:function load(url){var atlas=arguments.length>1&&arguments[1]!==undefined?arguments[1]:false;var atlasPath=arguments.length>2&&arguments[2]!==undefined?arguments[2]:null;this._url=url;if(atlas)this._atlasPath=atlasPath?atlasPath:url.split(".swf")[0]+".json";this.stop();this._clear();this._movieClipList=[this];var urls;urls=[{url:url,type:Laya.ILaya.Loader.BUFFER}];if(this._atlasPath){urls.push({url:this._atlasPath,type:Laya.ILaya.Loader.ATLAS});}Laya.ILaya.loader.load(urls,Laya.Handler.create(this,this._onLoaded));}},{key:"_onLoaded",value:function _onLoaded(){var data;data=Laya.ILaya.Loader.getRes(this._url);if(!data){this.event(Laya.Event.ERROR,"file not find");return;}if(this._atlasPath&&!Laya.ILaya.Loader.getAtlas(this._atlasPath)){this.event(Laya.Event.ERROR,"Atlas not find");return;}this.basePath=this._atlasPath?Laya.ILaya.Loader.getAtlas(this._atlasPath).dir:this._url.split(".swf")[0]+"/image/";this._initData(data);}},{key:"_initState",value:function _initState(){this._reset();this._ended=false;var preState=this._playing;this._playing=false;this._curIndex=0;while(!this._ended){this._parseFrame(++this._curIndex);}this._playing=preState;}},{key:"_initData",value:function _initData(data){this._data=new Laya.Byte(data);var i,len=this._data.getUint16();for(i=0;i<len;i++){this._ids[this._data.getInt16()]=this._data.getInt32();}this.interval=1000/this._data.getUint16();this._setData(this._data,this._ids[32767]);this._initState();this.play(0);this.event(Laya.Event.LOADED);if(!this._parentMovieClip)this.timer.loop(this.interval,this,this.updates,null,true);}},{key:"playTo",value:function playTo(start,end){var complete=arguments.length>2&&arguments[2]!==undefined?arguments[2]:null;this._completeHandler=complete;this._endFrame=end;this.play(start,false);}},{key:"index",get:function get(){return this._playIndex;},set:function set(value){this._playIndex=value;if(this._data)this._displayFrame(this._playIndex);if(this._labels&&this._labels[value])this.event(Laya.Event.LABEL,this._labels[value]);}},{key:"count",get:function get(){return this._count;}},{key:"playing",get:function get(){return this._playing;}},{key:"url",set:function set(path){this.load(path);}}]);return MovieClip;}(Laya.Sprite);MovieClip._ValueList=["x","y","width","height","scaleX","scaleY","rotation","alpha"];exports.AnimationContent=AnimationContent;exports.AnimationNodeContent=AnimationNodeContent;exports.AnimationParser01=AnimationParser01;exports.AnimationParser02=AnimationParser02;exports.AnimationPlayer=AnimationPlayer;exports.AnimationState=AnimationState;exports.AnimationTemplet=AnimationTemplet;exports.BezierLerp=BezierLerp;exports.Bone=Bone;exports.BoneSlot=BoneSlot;exports.DeformAniData=DeformAniData;exports.DeformSlotData=DeformSlotData;exports.DeformSlotDisplayData=DeformSlotDisplayData;exports.DrawOrderData=DrawOrderData;exports.EventData=EventData;exports.GraphicsAni=GraphicsAni;exports.IAniLib=IAniLib;exports.IkConstraint=IkConstraint;exports.IkConstraintData=IkConstraintData;exports.KeyFramesContent=KeyFramesContent;exports.MeshData=MeshData;exports.MovieClip=MovieClip;exports.PathConstraint=PathConstraint;exports.PathConstraintData=PathConstraintData;exports.Skeleton=Skeleton;exports.SkinData=SkinData;exports.SkinMeshForGraphic=SkinMeshForGraphic;exports.SkinSlotDisplayData=SkinSlotDisplayData;exports.SlotData=SlotData;exports.Templet=Templet;exports.TfConstraint=TfConstraint;exports.TfConstraintData=TfConstraintData;exports.Transform=Transform;exports.UVTools=UVTools;})(window.Laya=window.Laya||{},Laya);
